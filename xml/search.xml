<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      
        <title>【小巧-轻便-实用】ICO图标转换工具</title>
      
      <link href="/posts/2026/01/08/920dce676ecd/"/>
      <url>/posts/2026/01/08/920dce676ecd/</url>
      
        <content type="html"><![CDATA[<p><strong>工具名称：</strong> 图形转换工具</p><p><strong>工具版本：</strong> 1.03</p><p><strong>功能介绍：</strong></p><ul><li>支持PNG、JPEG格式转为ICO图标或WMF格式图片</li><li>可以选择单个图形文件，也可以选择图形文件夹进行批量处理</li><li>可以选择常见尺寸、倍率、自定义宽和高对ICO图标和WMF图片进行缩放</li></ul><p><strong>工具截图：</strong></p><img src="/posts/2026/01/08/920dce676ecd/img1.png" class="" width="450" height="530"><p><strong>下载链接：</strong> <a href="https://github.com/JokeVallen/ToIco.git">GitHub</a>  <a href="https://pan.baidu.com/s/1GhIdpP6rztQqBpObC194gw?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> 小工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity配置SQLite以及遇到的问题</title>
      
      <link href="/posts/2026/01/08/c8d5f22e46c1/"/>
      <url>/posts/2026/01/08/c8d5f22e46c1/</url>
      
        <content type="html"><![CDATA[<h2 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h2><ul><li><p>给Unity配置SQLite通常需要三个dll文件，分别是System.Data.dll、Mono.Data.Sqlite.dll、Sqlite.dll（或者Sqlite3.dll）</p><ul><li><p>System.Data.dll和 Mono.Data.Sqlite.dll文件路径：</p><p>Unity 2020.3.26f1c1\Editor\Data\MonoBleedingEdge\lib\mono\unityjit</p></li><li><p>Sqlite.dll（或者Sqlite3.dll）下载路径（注意下载对应操作系统位数的）：</p><p><a href="https://www.sqlite.org/download.html">SQLite Download Page</a></p></li></ul></li><li><p>三个dll文件需要放置在Unity的Assets&#x2F;Plugins文件夹下</p></li><li><p>SQLite数据库文件(.db)放在Unity的Assets&#x2F;StreamingAssets文件夹下</p></li></ul><h2 id="可能出现的问题"><a href="#可能出现的问题" class="headerlink" title="可能出现的问题"></a>可能出现的问题</h2><h3 id="导入System-Data-dll出现的问题"><a href="#导入System-Data-dll出现的问题" class="headerlink" title="导入System.Data.dll出现的问题"></a>导入System.Data.dll出现的问题</h3><img src="/posts/2026/01/08/c8d5f22e46c1/img1.png" class=""><p><strong>解决办法：</strong> 删除Assets&#x2F;Plugins文件夹下的System.Data.dll文件</p><h3 id="导入Mono-Data-Sqlite-dll出现的问题"><a href="#导入Mono-Data-Sqlite-dll出现的问题" class="headerlink" title="导入Mono.Data.Sqlite.dll出现的问题"></a>导入Mono.Data.Sqlite.dll出现的问题</h3><img src="/posts/2026/01/08/c8d5f22e46c1/img2.png" class=""><p><strong>解决办法：</strong> 导入这个目录Unity 2020.3.26f1c1\Editor\Data\MonoBleedingEdge\lib\mono\unityjit下的Mono.Data.Sqlite.dll文件</p><h3 id="导入dll文件后无法在代码中引用"><a href="#导入dll文件后无法在代码中引用" class="headerlink" title="导入dll文件后无法在代码中引用"></a>导入dll文件后无法在代码中引用</h3><p><strong>解决办法：</strong> Edit—Project Settings—Player—Api Compatibility Level—.NET 4.x</p><img src="/posts/2026/01/08/c8d5f22e46c1/img3.png" class="" width="277" height="609"><img src="/posts/2026/01/08/c8d5f22e46c1/img4.png" class="" width="641" height="479"><p>如果上述第3个问题无法解决，可查看Mono.Data.Sqlite.dll插件信息：</p><img src="/posts/2026/01/08/c8d5f22e46c1/img5.png" class="" width="351" height="678">]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity预览或注释中文乱码解决办法</title>
      
      <link href="/posts/2026/01/08/8f1c257e547b/"/>
      <url>/posts/2026/01/08/8f1c257e547b/</url>
      
        <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>Unity代码预览窗口中出现中文乱码或者VSCode中的中文注释乱码</p><h3 id="Unity代码预览窗口中文乱码"><a href="#Unity代码预览窗口中文乱码" class="headerlink" title="Unity代码预览窗口中文乱码"></a>Unity代码预览窗口中文乱码</h3><img src="/posts/2026/01/08/8f1c257e547b/img1.png" class="" width="339" height="359"><h3 id="代码调用提示中文乱码"><a href="#代码调用提示中文乱码" class="headerlink" title="代码调用提示中文乱码"></a>代码调用提示中文乱码</h3><img src="/posts/2026/01/08/8f1c257e547b/img2.png" class="" width="652" height="120"><h3 id="代码注释中文乱码"><a href="#代码注释中文乱码" class="headerlink" title="代码注释中文乱码"></a>代码注释中文乱码</h3><img src="/posts/2026/01/08/8f1c257e547b/img3.png" class="" width="404" height="128"><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><ul><li>选择编码格式</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img4.png" class="" width="385" height="77"><ul><li>选择编码重新打开</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img5.png" class="" width="604" height="121"><ul><li>选择UTF-8</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img6.png" class="" width="606" height="348"><ul><li>这时代码出现了乱码（不要慌）</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img7.png" class="" width="657" height="423"><ul><li>按Ctrl+Z进行撤销就会恢复中文（但是还没完）</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img8.png" class="" width="632" height="448"><ul><li>重新选择编码格式，选择通过编码保存</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img9.png" class="" width="601" height="126"><ul><li>还是选择UTF-8</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img10.png" class="" width="600" height="345"><ul><li>打开VSCode的设置界面，搜索encoding，设置为UTF-8</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img11.png" class="" width="762" height="112"><ul><li>可以看到注释和提示已经恢复了中文</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img12.png" class="" width="446" height="134"><ul><li>Unity预览窗口也恢复了中文显示</li></ul><img src="/posts/2026/01/08/8f1c257e547b/img13.png" class="" width="350" height="358"><blockquote><p>这种解决办法可以彻底解决中文乱码问题，之前我尝试了许多办法，但是当我重新从Untiy打开脚本文件的后又会乱码，通过这个办法可以解决。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#理解回调函数</title>
      
      <link href="/posts/2026/01/08/a1958eb9f58b/"/>
      <url>/posts/2026/01/08/a1958eb9f58b/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是回调函数"><a href="#什么是回调函数" class="headerlink" title="什么是回调函数"></a>什么是回调函数</h2><p>回调函数就是允许用户把需要调用的函数的指针作为参数传递给一个函数，以便该函数在处理相似事件的时候可以灵活的使用不同的方法，简而言之就是一个被作为参数传递的函数，回调函数的作用是对特定的事件或条件进行响应。（引用自百度百科）</p><h2 id="情景模拟"><a href="#情景模拟" class="headerlink" title="情景模拟"></a>情景模拟</h2><p>一个公司的老板需要知道员工是否完成了任务，所以他要求员工如果完成了任务需要给他提交报告。（这个员工就是作者，完成了任务却得不到一个赞😭）</p><h2 id="情景分析"><a href="#情景分析" class="headerlink" title="情景分析"></a>情景分析</h2><p><strong>回调函数定义者：</strong> 老板</p><p><strong>响应函数定义者：</strong> 员工</p><p><strong>回调函数：</strong> 提交报告</p><p><strong>触发回调函数的条件：</strong> 员工完成任务</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>首先，我们得有一个Boss类和Employee类分别代表老板和员工，而员工要向老板提交报告，肯定需要知道老板办公室的地址，所以再定义一个IBossOffice接口，接口下声明提交报告这个事件Report，然后我们的老板需要实现这个接口，这样我们的员工就可以通过接口来向老板提交报告了，那么员工需要具备哪些属性和行为呢？首先员工得知道老板的办公室地址officeAddress，然后得有开始工作的行为StartTask，还得有一个完成任务的行为FinishTask。为了使得我们的代码更贴近情景模拟，我特意给员工添加了一个名字属性employeeName，以及提交报告时告知老板员工的名字和计时器。</p><img src="/posts/2026/01/08/a1958eb9f58b/img1.png" class="" width="1395" height="800"><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">CallBackTest</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] <span class="hljs-keyword">args</span></span>)</span><br>    &#123;<br>        <span class="hljs-comment">//得有一个Boss</span><br>        Boss boss = <span class="hljs-keyword">new</span> Boss();<br>        <span class="hljs-comment">//根据Boss得知Boss办公室的地址</span><br>        IBossOffice officeAddress = boss <span class="hljs-keyword">as</span> IBossOffice;<br>        <span class="hljs-comment">//还得有一个员工，这个员工需要知道Boss办公室的地址和自己的名字</span><br>        Employee employee = <span class="hljs-keyword">new</span> Employee(officeAddress, <span class="hljs-string">&quot;小王&quot;</span>);<br>        <span class="hljs-comment">//员工开始工作</span><br>        employee.StartTask();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title">Boss</span> : <span class="hljs-title">IBossOffice</span><br>&#123;<br>    <span class="hljs-comment">//回调函数</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Report</span>(<span class="hljs-params">Employee e</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;员工&quot;</span> + e.employeeName + <span class="hljs-string">&quot;完成任务来提交报告啦.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBossOffice</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Report</span>(<span class="hljs-params">Employee e</span>)</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Employee</span><br>&#123;<br>    <span class="hljs-comment">//这里的officeAddress就是Boss办公室的地址</span><br>    <span class="hljs-keyword">private</span> IBossOffice officeAddress;<br>    <span class="hljs-keyword">private</span> Timer timer;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> employeeName &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>    <span class="hljs-comment">//员工要知道Boss办公室地址才能完成提交报告的任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Employee</span>(<span class="hljs-params">IBossOffice officeAddress, <span class="hljs-built_in">string</span> employeeName</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.officeAddress = officeAddress;<br>        <span class="hljs-comment">//下面这是一个计时器，与当前要说的回调内容无关</span><br>        timer = <span class="hljs-keyword">new</span> Timer();<br>        timer.AutoReset = <span class="hljs-literal">false</span>;<br>        timer.Interval = <span class="hljs-number">5000</span>;<br>        timer.Elapsed += FinishTask;<br>        <span class="hljs-comment">//员工姓名</span><br>        <span class="hljs-keyword">this</span>.employeeName = employeeName;<br>    &#125;<br><br>    <span class="hljs-comment">//员工开始做任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartTask</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;员工&quot;</span> + employeeName + <span class="hljs-string">&quot;开始工作了.&quot;</span>);<br>        timer.Start();<br>    &#125;<br><br>    <span class="hljs-comment">//响应函数</span><br>    <span class="hljs-comment">//员工完成任务去Boss办公室提交报告</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FinishTask</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, ElapsedEventArgs e</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;员工&quot;</span> + employeeName + <span class="hljs-string">&quot;完成任务了.&quot;</span>);<br>        officeAddress.Report(<span class="hljs-keyword">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>结合回调函数的定义，我们这里的回调函数实际上就是IBossOffice下的Report函数，我们在定义员工的时候，把IBossOffice作为一个参数传递给了员工，所以这是回调函数的第一个特征作为被传递的参数，员工开始任务StartTask，当任务完成时，在FinishTask中有一段代码officeAddress.Report(this)就是我们在响应函数中调用回调函数，这就是回调函数的第二个特征它会对特定的事件或条件进行响应。为什么Report函数是回调函数呢？首先定义Report的是Boss，也就是老板要求员工完成任务要提交报告，而执行Report的是员工，也就是说什么时候提交报告是员工来决定的，员工完成了任务才提交报告。如果我们不采用回调函数，我们完全可以在Main函数中来决定什么时候Report，那么这样老板和员工之间的沟通相当于就得通过秘书，这就会导致一个问题，员工和老板的沟通可能无法及时传达给对方，因为秘书可能因为事情太多而忘记把员工的任务报告提交给老板，虽然实际生活中老板会让秘书来传达工作要求，但是代码中我们为了提高编程效率就让老板和员工直接进行沟通，而回调函数就是作为老板和员工之间进行沟通的接口，老板把IBossOffice这个接口发送给员工，员工就能够通过IBossOffice来实现与老板的沟通，即Report。</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity中EditorWindow的创建和停靠</title>
      
      <link href="/posts/2026/01/08/2c47e155b663/"/>
      <url>/posts/2026/01/08/2c47e155b663/</url>
      
        <content type="html"><![CDATA[<h2 id="API简介"><a href="#API简介" class="headerlink" title="API简介"></a>API简介</h2><p>创建EditorWindow主要使用的方法有两个：GetWindow和CreateWindow</p><h3 id="GetWindow和CreateWindow的区别"><a href="#GetWindow和CreateWindow的区别" class="headerlink" title="GetWindow和CreateWindow的区别"></a>GetWindow和CreateWindow的区别</h3><ul><li>GetWindow试图寻找指定类型的第一个窗口，如果无法找到则进行创建，CreateWindow直接创建一个指定类型的窗口  </li><li>GetWindow的参数有title，focus，utility，desiredDockNextTo，CreateWindow的参数有title，desiredDockNextTo</li></ul><h3 id="参数简介"><a href="#参数简介" class="headerlink" title="参数简介"></a>参数简介</h3><ul><li>title：窗口标题，默认为[命名空间].类名</li><li>focus：是否聚焦，默认为true</li><li>utility：是否为浮动窗口，默认为false</li><li>desiredDockNextTo：将要停靠的窗口的Type数组，默认为null</li></ul><h2 id="代码和截图展示"><a href="#代码和截图展示" class="headerlink" title="代码和截图展示"></a>代码和截图展示</h2><blockquote><p>为了方便展示所有情况我们定义了GUITest3和GUITest4两个类，二者均为继承自EditorWindow的派生类，每行代码的序号对应下面图的序号，请自行对比。</p></blockquote><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//1.1.1尝试获取一个类型为GUITest3，所有参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;();<br><br><span class="hljs-comment">//1.1.2尝试获取一个类型为GUITest3，utility为true，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">//1.1.3尝试获取一个类型为GUITest3，title为&quot;Window&quot;，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-string">&quot;Window&quot;</span>);<br><br><span class="hljs-comment">//1.1.4尝试获取一个类型为GUITest3，title为&quot;Window&quot;，focus为false，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-string">&quot;Window&quot;</span>, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">//1.1.5尝试获取一个类型为GUITest3，utility为true，title为&quot;Window&quot;，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-literal">true</span>, <span class="hljs-string">&quot;Window&quot;</span>);<br><br><span class="hljs-comment">//1.1.6尝试获取一个类型为GUITest3，utility为true，title为&quot;Window&quot;，focus为true，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-literal">true</span>, <span class="hljs-string">&quot;Window&quot;</span>, <span class="hljs-literal">true</span>);<br><br>Type[] types = &#123; <span class="hljs-keyword">typeof</span>(GUITest4) &#125;;<br><br><span class="hljs-comment">//1.1.7尝试获取一个类型为GUITest3，停靠在GUITest4窗口旁，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(types);<br><br><span class="hljs-comment">//1.1.8尝试获取一个类型为GUITest3，title为&quot;Window&quot;，停靠在GUITest4窗口旁，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-string">&quot;Window&quot;</span>, types);<br><br><span class="hljs-comment">//1.1.9尝试获取一个类型为GUITest3，title为&quot;Window&quot;，focus为true，停靠在GUITest4窗口旁，其余参数设置为默认值的窗口</span><br>window = GetWindow&lt;GUITest3&gt;(<span class="hljs-string">&quot;Window&quot;</span>, <span class="hljs-literal">true</span>, types);<br><br><span class="hljs-comment">//1.2.1尝试创建一个类型为GUITest3，其余参数设置为默认值的窗口</span><br>window = CreateWindow&lt;GUITest3&gt;();<br><br><span class="hljs-comment">//1.2.2尝试创建一个类型为GUITest3，停靠在GUITest4窗口旁，其余参数设置为默认值的窗口</span><br>window = CreateWindow&lt;GUITest3&gt;(types);<br><br><span class="hljs-comment">//1.2.3尝试创建一个类型为GUITest3，title为&quot;Window&quot;，停靠在GUITest4窗口旁，其余参数设置为默认值的窗口</span><br>window = CreateWindow&lt;GUITest3&gt;(<span class="hljs-string">&quot;Window&quot;</span>, types);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/2c47e155b663/img1.png" class="" width="300" height="321"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.1.1</div><img src="/posts/2026/01/08/2c47e155b663/img2.png" class="" width="300" height="329"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.1.2</div><img src="/posts/2026/01/08/2c47e155b663/img3.png" class="" width="300" height="321"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.1.3 && 1.1.4</div><img src="/posts/2026/01/08/2c47e155b663/img4.png" class="" width="300" height="329"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.1.5 && 1.1.6</div><img src="/posts/2026/01/08/2c47e155b663/img5.png" class="" width="339" height="316"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.1.7</div><img src="/posts/2026/01/08/2c47e155b663/img6.png" class="" width="339" height="316"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.1.8 && 1.1.9</div><img src="/posts/2026/01/08/2c47e155b663/img7.png" class="" width="372" height="358"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.2.1</div><img src="/posts/2026/01/08/2c47e155b663/img8.png" class="" width="492" height="401"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.2.2</div><img src="/posts/2026/01/08/2c47e155b663/img9.png" class="" width="492" height="401"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">1.2.3</div><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>（设置当前窗口为W1，被停靠的窗口为W2）</p><ul><li><p>如果想要通过focusedWindow来确定W2，那就需要在W2中编写GUI来创建W1，例如在W2中有一个Button，点击它创建W1，因为经过我的测试和验证，如果仅仅通过MenuItem来创建W1和W2，会出现focusedWindow优先聚焦Unity自带窗口的问题，例如Hierarchy、Console、Project等等；</p></li><li><p>请勿将创建窗口的代码放置在任何可能多次执行的方法中，否则会导致你的Unity或电脑崩溃</p></li><li><p>停靠需要满足以下三个条件：</p><ul><li><p>需要保证W2（这里就是GUITest4类型窗口）存在</p></li><li><p>需要保证W2的utility参数为false，因为浮动窗口不允许被停靠</p></li><li><p>W1不能对它的position属性进行设置，否则停靠会失效</p></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#基于内置函数的自定义控制台输出函数</title>
      
      <link href="/posts/2026/01/08/89c5ed22f6b3/"/>
      <url>/posts/2026/01/08/89c5ed22f6b3/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于C#的控制台程序，通常我们的输出是在调试控制台，但是C#会自动输出控制台程序的加载信息，这些并不是我们想要关注的信息，所以为了更直观地查看我们的程序在控制台中输出的信息，我们可以通过自定义控制台输出函数结合控制台筛选器来实现这个目的。</p><p>自定义控制台输出函数是基于System.Diagnostics.Debug中的Write和WriteLine方法进行简单的自定义，并非是完全自主实现控制台输出方法。也就是将内置的这两个方法进行封装，给我们的调试信息加上一些特殊标记，这样我们就可以通过调试控制台的筛选器结合特殊标记筛选控制台信息，从而实现控制台仅显示具有该特殊标记的信息。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyPrint</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 标记，默认为&quot;<span class="hljs-doctag">&lt;b&gt;</span>(MyPrint)<span class="hljs-doctag">&lt;/b&gt;</span>&quot;</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> mFlag<br>    &#123;<br>        <span class="hljs-keyword">get</span> &#123; <span class="hljs-keyword">return</span> flag; &#125;<br>        <span class="hljs-keyword">set</span> &#123; <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> != <span class="hljs-literal">null</span>) flag = <span class="hljs-keyword">value</span>; &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> flag;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isFirst;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">MyPrint</span>()</span><br>    &#123;<br>        flag = <span class="hljs-string">&quot;(MyPrint)&quot;</span>;<br>        isFirst = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//该特性使得调试时直接跳过该方法</span><br>    [<span class="hljs-meta">System.Diagnostics.DebuggerStepThrough</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteLine</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> str</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) System.Diagnostics.Debug.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;flag&#125;</span> Null&quot;</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str.Equals(<span class="hljs-built_in">string</span>.Empty)) System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">else</span> System.Diagnostics.Debug.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;flag&#125;</span> &quot;</span> + str.ToString());<br>    &#125;<br><br>    [<span class="hljs-meta">System.Diagnostics.DebuggerStepThrough</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteLine</span>()</span><br>    &#123;<br>        System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br><br>    [<span class="hljs-meta">System.Diagnostics.DebuggerStepThrough</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Write</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> str</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (isFirst)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) System.Diagnostics.Debug.Write(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;flag&#125;</span> Null&quot;</span>);<br>            <span class="hljs-keyword">else</span> System.Diagnostics.Debug.Write(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;flag&#125;</span> &quot;</span> + str.ToString());<br>            isFirst = <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> System.Diagnostics.Debug.Write(str);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="MyPrint测试"><a href="#MyPrint测试" class="headerlink" title="MyPrint测试"></a>MyPrint测试</h3><h4 id="WriteLine-测试"><a href="#WriteLine-测试" class="headerlink" title="WriteLine()测试"></a>WriteLine()测试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// MyPrint.WriteLine测试</span><br>MyPrint.WriteLine(<span class="hljs-string">&quot;Hello world!&quot;</span>);<br>MyPrint.WriteLine(<span class="hljs-string">&quot;My name is Jack.&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图1 测试结果</div><h4 id="Wirte-测试"><a href="#Wirte-测试" class="headerlink" title="Wirte()测试"></a>Wirte()测试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// MyPrint.Write测试</span><br><span class="hljs-built_in">string</span>[] v_strs1 = &#123; <span class="hljs-string">&quot;Hello &quot;</span>, <span class="hljs-string">&quot;world.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs1)<br>&#123;<br>    MyPrint.Write(str);<br>&#125;<br><span class="hljs-built_in">string</span>[] v_strs2 = &#123; <span class="hljs-string">&quot;My &quot;</span>, <span class="hljs-string">&quot;name &quot;</span>, <span class="hljs-string">&quot;is &quot;</span>, <span class="hljs-string">&quot;Jack.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs2)<br>&#123;<br>    MyPrint.Write(str);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图2 测试结果</div><h4 id="WriteLine-和Write-联调测试"><a href="#WriteLine-和Write-联调测试" class="headerlink" title="WriteLine()和Write()联调测试"></a>WriteLine()和Write()联调测试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp">MyPrint.WriteLine(<span class="hljs-string">&quot;Hello Jack.&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_strs1 = &#123; <span class="hljs-string">&quot;Hello &quot;</span>, <span class="hljs-string">&quot;world.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs1)<br>&#123;<br>    MyPrint.Write(str);<br>&#125;<br>MyPrint.WriteLine(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_strs2 = &#123; <span class="hljs-string">&quot;My &quot;</span>, <span class="hljs-string">&quot;name &quot;</span>, <span class="hljs-string">&quot;is &quot;</span>, <span class="hljs-string">&quot;Jack.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs2)<br>&#123;<br>    MyPrint.Write(str);<br>&#125;<br>MyPrint.WriteLine(<span class="hljs-string">&quot;My name is Mary.&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img3.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图3 测试结果</div><h3 id="对比测试"><a href="#对比测试" class="headerlink" title="对比测试"></a>对比测试</h3><blockquote><p>通过System.Diagnostics.Debug与MyPrint中的函数Write和WriteLine实现相同的逻辑并对输出结果进行对比。以下三个测试基于System.Diagnostics.Debug实现。</p></blockquote><h4 id="WriteLine-测试-1"><a href="#WriteLine-测试-1" class="headerlink" title="WriteLine()测试"></a>WriteLine()测试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// WriteLine测试</span><br>System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;Hello world!&quot;</span>);<br>System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;My name is Jack.&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img4.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图4 测试结果</div><h4 id="Write-测试"><a href="#Write-测试" class="headerlink" title="Write()测试"></a>Write()测试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// Write测试</span><br><span class="hljs-built_in">string</span>[] v_strs1 = &#123; <span class="hljs-string">&quot;Hello &quot;</span>, <span class="hljs-string">&quot;world.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs1)<br>&#123;<br>    System.Diagnostics.Debug.Write(str);<br>&#125;<br><span class="hljs-built_in">string</span>[] v_strs2 = &#123; <span class="hljs-string">&quot;My &quot;</span>, <span class="hljs-string">&quot;name &quot;</span>, <span class="hljs-string">&quot;is &quot;</span>, <span class="hljs-string">&quot;Jack.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs2)<br>&#123;<br>    System.Diagnostics.Debug.Write(str);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img5.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图5 测试结果</div><h4 id="WriteLine-和Write-联调测试-1"><a href="#WriteLine-和Write-联调测试-1" class="headerlink" title="WriteLine()和Write()联调测试"></a>WriteLine()和Write()联调测试</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp">System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;Hello Jack.&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_strs1 = &#123; <span class="hljs-string">&quot;Hello &quot;</span>, <span class="hljs-string">&quot;world.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs1)<br>&#123;<br>    System.Diagnostics.Debug.Write(str);<br>&#125;<br>System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_strs2 = &#123; <span class="hljs-string">&quot;My &quot;</span>, <span class="hljs-string">&quot;name &quot;</span>, <span class="hljs-string">&quot;is &quot;</span>, <span class="hljs-string">&quot;Jack.&quot;</span> &#125;;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> str <span class="hljs-keyword">in</span> v_strs2)<br>&#123;<br>    System.Diagnostics.Debug.Write(str);<br>&#125;<br>System.Diagnostics.Debug.WriteLine(<span class="hljs-string">&quot;My name is Mary.&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img6.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图6 测试结果</div><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>根据上述测试结果可见，在忽略输出结果中的标记”(MyPrint)”的前提下，MyPrint和内置的System.Diagnostics.Debug对于WriteLine和Write方法的控制台输出信息相同。</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>示例代码如下，输出结果如图7和图8所示：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//示例代码</span><br>MyPrint.WriteLine(<span class="hljs-string">&quot;【Example】&quot;</span>);<br>MyPrint.WriteLine(<span class="hljs-string">&quot;-----------------------------&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_fruits = &#123; <span class="hljs-string">&quot;Apple&quot;</span>, <span class="hljs-string">&quot;Orange&quot;</span>, <span class="hljs-string">&quot;Banana&quot;</span>, <span class="hljs-string">&quot;Strawberry&quot;</span>, <span class="hljs-string">&quot;Peach&quot;</span> &#125;;<br><span class="hljs-built_in">string</span>[] v_prices = &#123; <span class="hljs-string">&quot;10$&quot;</span>, <span class="hljs-string">&quot;20$&quot;</span>, <span class="hljs-string">&quot;15$&quot;</span>, <span class="hljs-string">&quot;50$&quot;</span>, <span class="hljs-string">&quot;100$&quot;</span> &#125;;<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">4</span>) MyPrint.Write(<span class="hljs-string">$&quot;[Fruit:<span class="hljs-subst">&#123;v_fruits[i]&#125;</span>,Price:<span class="hljs-subst">&#123;v_prices[i]&#125;</span>],&quot;</span>);<br>    <span class="hljs-keyword">else</span> MyPrint.Write(<span class="hljs-string">$&quot;[Fruit:<span class="hljs-subst">&#123;v_fruits[i]&#125;</span>,Price:<span class="hljs-subst">&#123;v_prices[i]&#125;</span>]&quot;</span>);<br>&#125;<br>MyPrint.WriteLine();<br>MyPrint.WriteLine(<span class="hljs-string">&quot;-----------------------------&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img7.png" class="" width="995" height="176"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图7 有标记且根据筛选器筛选标记信息</div><img src="/posts/2026/01/08/89c5ed22f6b3/img8.png" class="" width="971" height="229"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图8 有标记但没使用筛选器</div><p>图8所示并不需要每次调试控制台程序都在筛选器输入标记来筛选信息，这个筛选器会缓存当前输入的筛选标记，所以后续只需要运行调试控制台程序编辑即可自动按照图8所示的方式显示控制台输出信息，但是值得注意的是，这个方法可能会出现错误筛选掉有效信息的情况，这种情况之一的代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//示例代码</span><br>MyPrint.WriteLine(<span class="hljs-string">&quot;【Example】&quot;</span>);<br>MyPrint.WriteLine(<span class="hljs-string">&quot;-----------------------------&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_fruits = &#123; <span class="hljs-string">&quot;Apple&quot;</span>, <span class="hljs-string">&quot;Orange&quot;</span>, <span class="hljs-string">&quot;Banana&quot;</span>, <span class="hljs-string">&quot;Strawberry&quot;</span>, <span class="hljs-string">&quot;Peach&quot;</span> &#125;;<br><span class="hljs-built_in">string</span>[] v_prices = &#123; <span class="hljs-string">&quot;10$&quot;</span>, <span class="hljs-string">&quot;20$&quot;</span>, <span class="hljs-string">&quot;15$&quot;</span>, <span class="hljs-string">&quot;50$&quot;</span>, <span class="hljs-string">&quot;100$&quot;</span> &#125;;<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">4</span>) MyPrint.Write(<span class="hljs-string">$&quot;[Fruit:<span class="hljs-subst">&#123;v_fruits[i]&#125;</span>,Price:<span class="hljs-subst">&#123;v_prices[i]&#125;</span>],&quot;</span>);<br>    <span class="hljs-keyword">else</span> MyPrint.Write(<span class="hljs-string">$&quot;[Fruit:<span class="hljs-subst">&#123;v_fruits[i]&#125;</span>,Price:<span class="hljs-subst">&#123;v_prices[i]&#125;</span>]&quot;</span>);<br>    MyPrint.WriteLine();<span class="hljs-comment">//在原有示例代码基础上添加了这一段代码</span><br>&#125;<br>MyPrint.WriteLine();<br>MyPrint.WriteLine(<span class="hljs-string">&quot;-----------------------------&quot;</span>);<br></code></pre></td></tr></table></figure><p>如图9和图10所示，我们的有效信息被错误筛选掉了一部分，这是因为筛选器是按行识别的，若该行输出信息中没有指定的标记则会被过滤掉，所以这种情况建议改用WriteLine输出。</p><img src="/posts/2026/01/08/89c5ed22f6b3/img9.png" class="" width="995" height="114"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图9 有标记且根据筛选器筛选标记信息</div><img src="/posts/2026/01/08/89c5ed22f6b3/img10.png" class="" width="974" height="152"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图10 有标记但没使用筛选器</div><p>通过WriteLine实现的代码如下，输出结果如图11和图12：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//示例代码</span><br>MyPrint.WriteLine(<span class="hljs-string">&quot;【Example】&quot;</span>);<br>MyPrint.WriteLine(<span class="hljs-string">&quot;-----------------------------&quot;</span>);<br><span class="hljs-built_in">string</span>[] v_fruits = &#123; <span class="hljs-string">&quot;Apple&quot;</span>, <span class="hljs-string">&quot;Orange&quot;</span>, <span class="hljs-string">&quot;Banana&quot;</span>, <span class="hljs-string">&quot;Strawberry&quot;</span>, <span class="hljs-string">&quot;Peach&quot;</span> &#125;;<br><span class="hljs-built_in">string</span>[] v_prices = &#123; <span class="hljs-string">&quot;10$&quot;</span>, <span class="hljs-string">&quot;20$&quot;</span>, <span class="hljs-string">&quot;15$&quot;</span>, <span class="hljs-string">&quot;50$&quot;</span>, <span class="hljs-string">&quot;100$&quot;</span> &#125;;<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>&#123;<br>    <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">4</span>) MyPrint.WriteLine(<span class="hljs-string">$&quot;[Fruit:<span class="hljs-subst">&#123;v_fruits[i]&#125;</span>,Price:<span class="hljs-subst">&#123;v_prices[i]&#125;</span>]&quot;</span>);<br>    <span class="hljs-keyword">else</span> MyPrint.WriteLine(<span class="hljs-string">$&quot;[Fruit:<span class="hljs-subst">&#123;v_fruits[i]&#125;</span>,Price:<span class="hljs-subst">&#123;v_prices[i]&#125;</span>]&quot;</span>);<br>&#125;<br>MyPrint.WriteLine(<span class="hljs-string">&quot;-----------------------------&quot;</span>);<br></code></pre></td></tr></table></figure><img src="/posts/2026/01/08/89c5ed22f6b3/img11.png" class="" width="996" height="170"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图11 有标记且根据筛选器筛选标记信息</div><img src="/posts/2026/01/08/89c5ed22f6b3/img12.png" class="" width="990" height="295"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图12 有标记但没使用筛选器</div>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>浏览器插件的打包和解压</title>
      
      <link href="/posts/2026/01/08/a2bd68836c36/"/>
      <url>/posts/2026/01/08/a2bd68836c36/</url>
      
        <content type="html"><![CDATA[<h2 id="浏览器插件打包（以Chrome为例）"><a href="#浏览器插件打包（以Chrome为例）" class="headerlink" title="浏览器插件打包（以Chrome为例）"></a>浏览器插件打包（以Chrome为例）</h2><ul><li>进入扩展程序页面，打开开发者模式，点击打包扩展程序</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img1.jpeg" class="" width="1274" height="358"><ul><li>填写插件根目录，如果是更新扩展则需要填写私钥文件路径</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img2.png" class="" width="504" height="294"><ul><li>找到Chrome的插件安装路径，在浏览器地址栏输入chrome:&#x2F;&#x2F;version，个人资料路径下的Extensions则为插件目录</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img3.jpeg" class="" width="945" height="331"><ul><li>根据ID查看对应插件的文件夹，复制好插件的根路径即可</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img4.png" class="" width="256" height="56">  <img src="/posts/2026/01/08/a2bd68836c36/img5.png" class="" width="541" height="181"><ul><li>打包完成后会生成一个.crx和.pem文件，.crx文件是加载插件的文件而.pem是私钥文件</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img6.png" class="" width="687" height="57"><h2 id="浏览器插件解压（以某浏览器为例）"><a href="#浏览器插件解压（以某浏览器为例）" class="headerlink" title="浏览器插件解压（以某浏览器为例）"></a>浏览器插件解压（以某浏览器为例）</h2><ul><li>将.crx文件重命名为.rar或.zip，然后对插件进行解压</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img7.png" class="" width="695" height="85"><ul><li>加载已解压的插件</li></ul><img src="/posts/2026/01/08/a2bd68836c36/img8.png" class="" width="1025" height="71">  <img src="/posts/2026/01/08/a2bd68836c36/img9.png" class="" width="838" height="562">  <img src="/posts/2026/01/08/a2bd68836c36/img10.png" class="" width="1067" height="356">]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>VisualStudio自定义代码模板</title>
      
      <link href="/posts/2026/01/08/34e95e1e88bb/"/>
      <url>/posts/2026/01/08/34e95e1e88bb/</url>
      
        <content type="html"><![CDATA[<ul><li>任选一个文件夹下，创建一个.snippet代码模板文件</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img1.png" class=""><ul><li>对文件进行编写，以下是代码模板</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs text">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;<br>&lt;CodeSnippets xmlns=&quot;http://schemas.microsoft.com/VisualStudio/2005/CodeSnippet&quot;&gt;<br> &lt;CodeSnippet Format=&quot;1.0.0&quot;&gt;<br>  &lt;Header&gt;<br>   &lt;Title&gt;这是代码模板的名称&lt;/Title&gt;<br>   &lt;Shortcut&gt;这是调用代码模板时的快捷变量名称&lt;/Shortcut&gt;<br>   &lt;Description&gt;这是对代码模板的描述&lt;/Description&gt;<br>   &lt;Author&gt;这里是代码模板创建者&lt;/Author&gt;<br>  &lt;/Header&gt;<br>  &lt;Snippet&gt;<br>   &lt;Code Language=&quot;CPP&quot;&gt;<br>    &lt;![CDATA[这里是代码块开头#include &lt;iostream&gt;<br>    using namespace std;<br>    <br>    int main()<br>    &#123;<br>     $selected$这里是创建模板后光标所在位置$end$ <br>    &#125;这里是代码块结尾]]&gt;<br>   &lt;/Code&gt;<br>  &lt;/Snippet&gt;<br> &lt;/CodeSnippet&gt;<br>&lt;/CodeSnippets&gt;<br></code></pre></td></tr></table></figure><ul><li>选择工具—代码片段管理器</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img2.png" class="" width="287" height="363"><ul><li>选择对应的语言</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img3.png" class="" width="571" height="433"><ul><li>添加一个新的文件夹用于存放自定义模板，这里是VC++</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img4.png" class="" width="571" height="433"><ul><li>导入我们之前编写好的.snippet文件</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img5.png" class="" width="614" height="445"><ul><li>选择对应的文件夹，点击完成</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img6.png" class="" width="571" height="475"><ul><li>输入我们设定好的快捷变量名称，回车或Tab即可键入模板</li></ul><img src="/posts/2026/01/08/34e95e1e88bb/img7.png" class="" width="555" height="242">]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>VisualStudio同一项目中有多个main方法，选择执行其中一个</title>
      
      <link href="/posts/2026/01/08/0a00b27a3aae/"/>
      <url>/posts/2026/01/08/0a00b27a3aae/</url>
      
        <content type="html"><![CDATA[<p>同一项目中有多个main方法，如何禁用其它cpp文件，仅调用当前cpp文件中的main方法？</p><ul><li>每个源文件下面都有一个main方法，但是我只想执行9_字符串操作中的main方法</li></ul><img src="/posts/2026/01/08/0a00b27a3aae/img1.png" class="" width="199" height="208"><ul><li>右键想要禁用的cpp文件，选择属性</li></ul><img src="/posts/2026/01/08/0a00b27a3aae/img2.png" class="" width="419" height="379"><ul><li>从生成中排除这里选择是，即可使之不进行编译</li></ul><img src="/posts/2026/01/08/0a00b27a3aae/img3.png" class="">]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>VSCode自定义代码模板</title>
      
      <link href="/posts/2026/01/08/706a445b746a/"/>
      <url>/posts/2026/01/08/706a445b746a/</url>
      
        <content type="html"><![CDATA[<ul><li>首先选择文件-首选项-配置用户代码片段</li></ul><img src="/posts/2026/01/08/706a445b746a/img1.png" class="" width="561" height="640"><ul><li><p>可以选择默认的全局代码片段进行修改也可以创建代码片段文件</p><p>现有代码片段就是目前你的项目所使用的编程语言对应的代码模板，全局代码片段就是IDE全局使用的代码模板，Test1文件夹的代码片段就是仅针对Test1项目的代码模板</p></li></ul><img src="/posts/2026/01/08/706a445b746a/img2.jpeg" class="" width="604" height="342"><ul><li>代码模板</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">&quot;This is a code snippet&quot;: &#123;<br> &quot;scope&quot;: &quot;csharp&quot;,//作用域，也就是哪些编程语言可以使用这个代码模板<br> &quot;prefix&quot;: &quot;a_test2&quot;,//快捷输入名称<br> &quot;body&quot;: [//自定义代码模板内容区域<br>  &quot;using System;\n&quot;,<br>  &quot;namespace Test2&quot;,<br>  &quot;&#123;&quot;,<br>  &quot;\tclass $TM_FILENAME_BASE&quot;,<br>  &quot;\t&#123;&quot;,<br>  &quot;\t\t$0&quot;,<br>  &quot;\t&#125;&quot;,<br>  &quot;&#125;&quot;<br> ],<br> &quot;description&quot;: &quot;This is a code snippet&quot;//代码模板描述<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>调用模板</li></ul><img src="/posts/2026/01/08/706a445b746a/img3.png" class="" width="790" height="289"><blockquote><p>官方的文档有很详细的介绍，后面我会专门出一个系列介绍相关详细的知识</p><p>​参考资料：<a href="https://code.visualstudio.com/docs/editor/userdefinedsnippets">Snippets in Visual Studio Code​</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>VSCode创建控制台程序</title>
      
      <link href="/posts/2026/01/08/b9412edb94c2/"/>
      <url>/posts/2026/01/08/b9412edb94c2/</url>
      
        <content type="html"><![CDATA[<ul><li>首先创建一个空的文件夹</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img1.png" class="" width="472" height="138"><ul><li>快捷键Ctrl+K+O打开刚才新建的文件夹</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img2.png" class="" width="613" height="444"><ul><li>打开查看—终端</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img3.png" class="" width="288" height="602"><ul><li>在终端输入dotnet new console（假如知道.NET Framework版本为5.0则输入dotnet new console –framework net5.0，不知道则需要按照以下方式手动配置）</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img4.png" class="" width="618" height="212"><ul><li>创建成功</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img5.png" class="" width="714" height="125"><ul><li>选择运行—添加配置（手动配置）</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img6.png" class="" width="277" height="523"><ul><li>选择调试器（手动配置）</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img7.png" class="" width="601" height="115">  <img src="/posts/2026/01/08/b9412edb94c2/img8.png" class="" width="859" height="477"><ul><li>配置launch.json文件，输入你的.net版本(通常可以在.csproj文件中看到)以及项目名.dll文件全称（手动配置）</li></ul><img src="/posts/2026/01/08/b9412edb94c2/img9.png" class="" width="844" height="500">  <img src="/posts/2026/01/08/b9412edb94c2/img10.png" class="" width="272" height="447">]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Singleton Pattern（单例模式）</title>
      
      <link href="/posts/2026/01/08/cf1a64e63abd/"/>
      <url>/posts/2026/01/08/cf1a64e63abd/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>单例模式是一种简单的设计模式，当我们需要在多个不同的地方访问A类中的方法时，往往会想到使用静态方法访问的方式，也就是把A类中可访问的方法都设置为公开的静态方法，这种方式虽然也可以达到类似单例的效果，但是二者存在一定的区别。</p><p>如果我们需要访问A类的实例方法时，就需要通过创建A类的实例来进行访问，如果我们需要在多个不同的地方访问A类中的实例方法，那就需要创建多个A类的实例，这会带来不必要的资源开销，因为如果A类不是作为一个会有不同特征的实体类时，就不需要反复去new实例。如果A类只是作为一个功能集合的工具类，就只需要一个A类的实例就可以了，这就可以采用单例模式，我们将A类的构造方法进行私有化，A类的实例创建仅由A类来决定，A类向外提供一个获取该实例的方法以便调用者可以访问A类的实例方法，这样就可以避免调用者new多个A类实例了，进而避免资源的浪费。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>资源共享、配置管理器、日志记录器、线程池、缓存管理器、GUI应用程序中的窗口管理器、数据库连接池、打印机池等。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">单例模式与静态方法的比较</div><table align="center" border="1" cellpadding="1" cellspacing="1" style="width:600px">  <tbody>    <tr>      <th style="width:75px">特征</th>      <th style="width:299px">单例模式</th>      <th>静态方法</th></tr>    <tr>      <td style="width:75px">        <strong>创建方式</strong></td>      <td style="width:299px">单例模式通过类的实例化来创建对象，通常具有私有构造函数，提供一个静态方法或属性来获取唯一的实例。</td>      <td>静态方法属于类而不是实例，通过类名直接调用，不需要创建对象。</td></tr>    <tr>      <td style="width:75px">        <strong>实例控制</strong></td>      <td style="width:299px">单例模式通过实例化控制确保在整个应用程序中只有一个实例存在。</td>      <td>静态方法不涉及实例，因此没有实例控制。</td></tr>    <tr>      <td style="width:75px">        <strong>灵活性</strong></td>      <td style="width:299px">单例模式相对更灵活，可以实现接口、继承，并支持多态性。</td>      <td>静态方法缺乏灵活性，不能实现接口，不支持多态性。</td></tr>    <tr>      <td style="width:75px">        <strong>可测试性</strong></td>      <td style="width:299px">单例模式相对更易于测试，可以通过依赖注入或模拟实例来进行单元测试。</td>      <td>静态方法测试较为困难，因为它们通常难以被模拟或替换。</td></tr>    <tr>      <td style="width:75px">        <strong>依赖注入</strong></td>      <td style="width:299px">单例模式支持依赖注入，可以通过构造函数或其他方法注入依赖关系。</td>      <td>静态方法通常不支持依赖注入，因为它们无法通过实例化来传递依赖关系。</td></tr>    <tr>      <td style="width:75px">        <strong>多态性</strong></td>      <td style="width:299px">单例模式支持多态性，可以通过接口引入多态性，使得代码更具可扩展性。</td>      <td>静态方法不支持多态性，因为它们与类而不是实例关联。</td></tr>    <tr>      <td style="width:75px">        <strong>延迟加载</strong></td>      <td style="width:299px">单例模式支持延迟加载，即只有在需要的时候才创建实例。</td>      <td>静态方法在程序启动时就加载并执行，不支持延迟加载。</td></tr>    <tr>      <td style="width:75px">        <strong>全局状态管理</strong></td>      <td style="width:299px">单例模式更适合用于全局状态管理，因为它可以在需要时创建一个实例，并且实例的生命周期由应用程序控制。</td>      <td>静态方法无法维护实例级别的状态，不适合全局状态管理。</td></tr>    <tr>      <td style="width:75px">        <strong>实例级别状态</strong></td>      <td style="width:299px">单例模式可以维护实例级别的状态，每次访问都是同一个实例。</td>      <td>静态方法通常无法维护实例级别的状态。</td></tr>  </tbody></table><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>单例类（Singleton）：</strong> 定义一个私有的静态变量用于保存唯一的实例，提供一个公共的静态方法用于获取该实例。通常实现为一个私有构造函数，确保只能通过特定的方式来创建实例。</p><p><strong>客户端（Client）：</strong> 使用单例的类或模块，通过静态方法或属性获取单例实例，并调用其方法。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>私有化构造函数：</strong> 单例类通常将其构造函数私有化，以防止通过普通的构造函数直接实例化对象。</p></li><li><p><strong>私有静态变量：</strong> 单例类内部通常包含一个私有的静态变量，用于存储唯一的实例。</p></li><li><p><strong>静态方法或属性：</strong> 单例类提供一个公共的静态方法或属性，用于获取该类的唯一实例。在这个方法中，通常会检查实例是否已经存在，如果存在则返回已有的实例，否则创建一个新的实例。</p></li><li><p><strong>懒加载或饿汉式：</strong> 单例模式可以采用懒加载（延迟加载）或饿汉式（在类加载时立即创建实例）的方式来创建实例，取决于具体的需求。</p></li><li><p><strong>线程安全性：</strong> 如果在多线程环境中使用单例模式，需要考虑线程安全性。常见的做法是使用双重检查锁定（Double-Checked Locking）或者使用静态初始化块等方式来确保在并发情况下仍然能够正确创建单例。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="单例模式：SingleTonPattern-cs"><a href="#单例模式：SingleTonPattern-cs" class="headerlink" title="单例模式：SingleTonPattern.cs"></a>单例模式：SingleTonPattern.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">SingleTonPattern</span>;<br><br><span class="hljs-comment">// 单例模式</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">SingleTonPatternManager</span><br>&#123;<br>    <span class="hljs-comment">// 测试方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>    &#123;<br>        <span class="hljs-comment">// 模拟多线程访问单例</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++)<br>        &#123;<br>            Thread.Sleep(<span class="hljs-number">10</span>);<br><br>            <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                SingleTon1 singleTon1 = SingleTon1.GetInstance();<br>                Console.WriteLine(<span class="hljs-string">&quot;singleTon1:&quot;</span> + singleTon1.GetHashCode());<br>            &#125;).Start();<br><br>            <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                SingleTon2 singleTon2 = SingleTon2.GetInstance();<br>                Console.WriteLine(<span class="hljs-string">&quot;singleTon2:&quot;</span> + singleTon2.GetHashCode());<br>            &#125;).Start();<br><br>            <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                SingleTon3 singleTon3 = SingleTon3.GetInstance();<br>                Console.WriteLine(<span class="hljs-string">&quot;singleTon3:&quot;</span> + singleTon3.GetHashCode());<br>            &#125;).Start();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 单例模式：双重判空 + 锁 + 懒汉式加载</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon1</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingleTon1 instance;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> k = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon1</span>()</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingleTon1 <span class="hljs-title">GetInstance</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">lock</span> (k)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) instance = <span class="hljs-keyword">new</span> SingleTon1();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> instance;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 单例模式：内部类 + 懒汉式加载</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon2</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon2</span>()</span> &#123; &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Handler</span><br>        &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> SingleTon2 instance = <span class="hljs-keyword">new</span> SingleTon2();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingleTon2 <span class="hljs-title">GetInstance</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> Handler.instance;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 单例模式：饿汉式加载</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon3</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">static</span> SingleTon3 instance = <span class="hljs-keyword">new</span> SingleTon3();<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon3</span>()</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingleTon3 <span class="hljs-title">GetInstance</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> instance;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 1.单例模式测试 **************</span><br><span class="hljs-comment">// using SingleTonPattern;</span><br><br><span class="hljs-comment">// SingleTonPatternManager singleTonPatternManager = new SingleTonPatternManager();</span><br><span class="hljs-comment">// singleTonPatternManager.Test();</span><br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>单例模式有很多种，这里我们展示了其中比较常用的三种。</p><p>SingleTon1所示的单例模式通过一个锁k来限制对instance的访问，之所以这里在获取锁k的前后分别进行了一次instance为空判断，是因为可能存在一个线程A正在执行new实例的代码，但是这时另一个线程B已经通过了外层的空判断，如果内层不加入一个空判断，当线程A执行完毕后，线程B抢到锁，就会再次执行new实例的代码，这时就创建了两个实例，就违背了单例模式的原则，而通过两次空判断就可以解决这个问题。</p><p>SingleTon2所示的单例模式是通过一个私有的内部类来实现的，这种方式相比前一种更加简单，并且还有一个好处，只有当instance被获取时才会加载内部类的这个单例，这种方式称为懒汉式加载。</p><p>SingleTon3所示的单例模式则是在类加载时就创建单例，在C#中可以放在静态构造函数中对instance进行初始化，也可以在声明instance变量时通过赋值表达式创建单例。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Factory Pattern（工厂模式）</title>
      
      <link href="/posts/2026/01/08/89372c2c649d/"/>
      <url>/posts/2026/01/08/89372c2c649d/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>工厂模式主要是用于对实例的创建进行统一管理的设计模式，适用于需要频繁创建实例或者实例创建逻辑较为复杂的情景，所有访问者都通过工厂来统一获取实例则可以使得访问者更加专注于具体业务逻辑的开发。</p><p>工厂模式通常分为简单工厂模式（Simple Factory Pattern）、工厂方法模式（Factory Method Pattern）、抽象工厂模式（Abstract Factory Pattern）。</p><p>简单工厂模式并不是GoF设计模式的一种，而是一种工厂模式常见的实现方式。</p><p>工厂方法模式是将创建实例的方法抽象到接口，不同的工厂实现该接口并对创建实例的具体逻辑进行编写，这样可以把创建实例的逻辑交给具体的工厂来编写，而外部调用则统一通过接口方法。</p><p>抽象工厂模式是将一组相关的创建实例的方法抽象到接口，通过一个例子或许更好理解，例如有一个专门生产电脑配件的厂商A和一个专门生产手机配件的厂商B，厂商A既生产电脑主板也生产电脑屏幕，而厂商B既生产手机主板也生产手机屏幕，电脑主板和手机主板都属于主板，电脑屏幕和手机屏幕都属于屏幕，那么就可以对这两个工厂进行抽象化处理，将生产主板和屏幕的方法抽象到接口中，两个工厂只要实现了接口并完成具体的生产逻辑的编写，那就既可以生产主板，也可以生产屏幕。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>数据库连接工厂、日志记录器工厂、图形界面库的部件工厂、加密算法工厂等。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">三种工厂模式对比</div><table align="center" border="1" cellpadding="1" cellspacing="1" style="width:600px">  <tbody>    <tr>      <th style="width:65px">特性</th>      <th style="width:154px">简单工厂模式</th>      <th style="width:161px">工厂方法模式</th>      <th>抽象工厂模式</th></tr>    <tr>      <td style="width:65px">        <strong>定义</strong></td>      <td style="width:154px">一个工厂类负责创建多个产品类的实例</td>      <td style="width:161px">多个工厂类，每个负责创建一个产品类的实例</td>      <td>多个工厂类，每个负责创建一组相关的产品类的实例</td></tr>    <tr>      <td style="width:65px">        <strong>灵活性</strong></td>      <td style="width:154px">低，新增产品需要修改工厂类，不符合开闭原则</td>      <td style="width:161px">高，每个产品对应一个工厂类，易于扩展</td>      <td>高，每个产品组对应一个工厂类，易于扩展</td></tr>    <tr>      <td style="width:65px">        <strong>扩展性</strong></td>      <td style="width:154px">低，新增产品需要修改工厂类，违反开闭原则</td>      <td style="width:161px">高，每个产品对应一个工厂类，不影响其他产品</td>      <td>高，每个产品组对应一个工厂类，不影响其他产品组</td></tr>    <tr>      <td style="width:65px">        <strong>复杂性</strong></td>      <td style="width:154px">低，整个创建过程在一个工厂类中完成</td>      <td style="width:161px">适中，每个产品有独立的工厂类</td>      <td>高，每个产品组有独立的工厂类</td></tr>    <tr>      <td style="width:65px">        <strong>依赖性</strong></td>      <td style="width:154px">高，客户端依赖工厂类和产品类</td>      <td style="width:161px">中，客户端依赖工厂接口和产品接口</td>      <td>低，客户端依赖抽象工厂接口和抽象产品接口</td></tr>    <tr>      <td style="width:65px">        <strong>例子</strong></td>      <td style="width:154px">配件工厂，既生产手机主板和屏幕，又生产电脑主板和屏幕</td>      <td style="width:161px">手机主板工厂生产手机主板，手机屏幕工厂生产手机屏幕</td>      <td>电脑配件工厂生产电脑主板和电脑屏幕，手机配件工厂生产手机主板和手机屏幕</td></tr>  </tbody></table><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><ul><li><p><strong>简单工厂模式</strong></p><ul><li>工厂（Factory）： 负责创建产品的类，包含一个创建产品的方法。</li><li>产品（Product）： 具体的产品类，实现了工厂定义的产品接口或抽象类。</li><li>客户端（Client）： 使用工厂创建产品的代码。</li></ul></li><li><p><strong>工厂方法模式</strong></p><ul><li>抽象工厂（Creator）： 声明创建产品的抽象方法，可以是接口或抽象类。</li><li>具体工厂（ConcreteCreator）： 实现抽象工厂，负责创建具体的产品。</li><li>产品（Product）： 具体的产品类，实现了抽象工厂定义的产品接口或抽象类。</li><li>客户端（Client）： 使用具体工厂创建产品的代码。</li></ul></li><li><p><strong>抽象工厂模式</strong></p><ul><li>抽象工厂（AbstractFactory）： 声明创建一系列相关产品的抽象方法，可以是接口或抽象类。</li><li>具体工厂（ConcreteFactory）： 实现抽象工厂，负责创建一系列相关的具体产品。</li><li>抽象产品（AbstractProduct）： 声明一系列相关产品的抽象接口或抽象类。</li><li>具体产品（ConcreteProduct）： 实现抽象产品，具体产品属于一系列中的某个具体类别。</li><li>客户端（Client）： 使用具体工厂创建一系列相关产品的代码。</li></ul></li></ul><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>简单工厂模式</strong></p><ul><li>客户端通过调用工厂的方法来创建产品，而不直接实例化产品类。</li><li>工厂根据客户端的请求，内部决定创建哪个具体的产品类。</li><li>客户端只需与工厂接口打交道，无需关心产品的具体创建过程。</li></ul></li><li><p><strong>工厂方法模式</strong></p><ul><li>客户端通过与抽象工厂交互，调用抽象工厂中的方法来创建产品。</li><li>具体工厂继承抽象工厂，实现抽象工厂中声明的创建产品的方法。</li><li>客户端无需知道具体产品的类名，只需要使用抽象工厂创建产品即可。</li><li>不同的具体工厂可以创建不同系列的产品，使系统更具扩展性。</li></ul></li><li><p><strong>抽象工厂模式</strong></p><ul><li>客户端通过与抽象工厂交互，调用抽象工厂中的方法来创建一系列相关产品。</li><li>具体工厂继承抽象工厂，实现抽象工厂中声明的创建产品的方法。</li><li>客户端无需关心具体产品的类名，只需要使用抽象工厂创建产品即可。</li><li>抽象工厂保证了一系列相关产品的兼容性，客户端可以一次性创建一整套产品。</li></ul></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="产品接口：Product-cs"><a href="#产品接口：Product-cs" class="headerlink" title="产品接口：Product.cs"></a>产品接口：Product.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FactoryPattern</span>;<br><br><span class="hljs-comment">// 主板</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IMotherBoard</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OperationMB</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 屏幕</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IScreen</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OperationSC</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 手机配件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPhoneAccessory</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OperationPA</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 手机主板</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PhoneMotherBoard</span> : <span class="hljs-title">IPhoneAccessory</span>, <span class="hljs-title">IMotherBoard</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationMB</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationMB:This is a PhoneMotherBoard.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationPA</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationPA:This is a PhoneMotherBoard.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 手机屏幕</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PhoneScreen</span> : <span class="hljs-title">IPhoneAccessory</span>, <span class="hljs-title">IScreen</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationPA</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationPA:This is a PhoneScreen.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationSC</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationSC:This is a PhoneScreen.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 电脑配件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IComputerAccessory</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OperationCA</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 电脑主板</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ComputerMotherBoard</span> : <span class="hljs-title">IComputerAccessory</span>, <span class="hljs-title">IMotherBoard</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationCA</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationCA:This is a ComputerMotherBoard.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationMB</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationMB:This is a ComputerMotherBoard.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 电脑屏幕</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ComputerScreen</span> : <span class="hljs-title">IComputerAccessory</span>, <span class="hljs-title">IScreen</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationCA</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationCA:This is a ComputerScreen.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OperationSC</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;OperationSC:This is a ComputerScreen.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="简单工厂模式：SimpleFactoryPattern-cs"><a href="#简单工厂模式：SimpleFactoryPattern-cs" class="headerlink" title="简单工厂模式：SimpleFactoryPattern.cs"></a>简单工厂模式：SimpleFactoryPattern.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FactoryPattern</span>;<br><br><span class="hljs-comment">// 简单工厂模式</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleFactory</span><br>&#123;<br>    <span class="hljs-comment">// 配件工厂</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AccessoryFactory</span><br>    &#123;<br>        <span class="hljs-comment">// 生产手机主板</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> PhoneMotherBoard <span class="hljs-title">CreatePMB</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PhoneMotherBoard();<br>        &#125;<br><br>        <span class="hljs-comment">// 生产电脑主板</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> ComputerMotherBoard <span class="hljs-title">CreateCMB</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ComputerMotherBoard();<br>        &#125;<br><br>        <span class="hljs-comment">// 生产手机屏幕</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> PhoneScreen <span class="hljs-title">CreatePS</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PhoneScreen();<br>        &#125;<br><br>        <span class="hljs-comment">// 生产电脑屏幕</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> ComputerScreen <span class="hljs-title">CreateCS</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ComputerScreen();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="工厂方法模式：FactoryMethodPattern-cs"><a href="#工厂方法模式：FactoryMethodPattern-cs" class="headerlink" title="工厂方法模式：FactoryMethodPattern.cs"></a>工厂方法模式：FactoryMethodPattern.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FactoryPattern</span>;<br><br><span class="hljs-comment">// 工厂方法接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IFactoryMethod</span><br>&#123;<br>    <span class="hljs-function">IPhoneAccessory <span class="hljs-title">Create</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 工厂方法模式</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">FactoryMethodPattern</span><br>&#123;<br>    <span class="hljs-comment">// 手机主板工厂</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PhoneMotherBoardFactory</span> : <span class="hljs-title">IFactoryMethod</span><br>    &#123;<br>        <span class="hljs-comment">// 生产手机主板</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IPhoneAccessory <span class="hljs-title">Create</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PhoneMotherBoard();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 手机屏幕工厂</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PhoneScreenFactory</span> : <span class="hljs-title">IFactoryMethod</span><br>    &#123;<br>        <span class="hljs-comment">// 生产手机屏幕</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IPhoneAccessory <span class="hljs-title">Create</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PhoneScreen();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="抽象工厂模式：AbstractFactoryPattern-cs"><a href="#抽象工厂模式：AbstractFactoryPattern-cs" class="headerlink" title="抽象工厂模式：AbstractFactoryPattern.cs"></a>抽象工厂模式：AbstractFactoryPattern.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FactoryPattern</span>;<br><br><span class="hljs-comment">// 抽象工厂接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IFactory</span><br>&#123;<br>    <span class="hljs-function">IMotherBoard <span class="hljs-title">CreateMB</span>()</span>; <span class="hljs-comment">// 生产主板</span><br>    <span class="hljs-function">IScreen <span class="hljs-title">CreateSC</span>()</span>; <span class="hljs-comment">// 生产屏幕</span><br>&#125;<br><br><span class="hljs-comment">// 抽象工厂模式</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractFactoryPattern</span><br>&#123;<br>    <span class="hljs-comment">// 电脑配件工厂</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MotherBoardFactory</span> : <span class="hljs-title">IFactory</span><br>    &#123;<br>        <span class="hljs-comment">// 生产电脑主板</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IMotherBoard <span class="hljs-title">CreateMB</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ComputerMotherBoard();<br>        &#125;<br><br>        <span class="hljs-comment">// 生产电脑屏幕</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IScreen <span class="hljs-title">CreateSC</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ComputerScreen();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 手机配件工厂</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ScreenFactory</span> : <span class="hljs-title">IFactory</span><br>    &#123;<br>        <span class="hljs-comment">// 生产手机主板</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IMotherBoard <span class="hljs-title">CreateMB</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PhoneMotherBoard();<br>        &#125;<br><br>        <span class="hljs-comment">// 生产手机屏幕</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> IScreen <span class="hljs-title">CreateSC</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PhoneScreen();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：-Program-cs"><a href="#测试代码：-Program-cs" class="headerlink" title="测试代码： Program.cs"></a>测试代码： Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 2.简单工厂模式测试 **************</span><br><span class="hljs-comment">// using FactoryPattern;</span><br><br><span class="hljs-comment">// var accessoryFactory = new SimpleFactory.AccessoryFactory();</span><br><span class="hljs-comment">// PhoneMotherBoard phoneMotherBoard = accessoryFactory.CreatePMB(); // 手机主板</span><br><span class="hljs-comment">// PhoneScreen phoneScreen = accessoryFactory.CreatePS(); // 手机屏幕</span><br><span class="hljs-comment">// ComputerMotherBoard computerMotherBoard = accessoryFactory.CreateCMB(); // 电脑主板</span><br><span class="hljs-comment">// ComputerScreen computerScreen = accessoryFactory.CreateCS(); // 电脑屏幕</span><br><span class="hljs-comment">// phoneMotherBoard.OperationPA();</span><br><span class="hljs-comment">// phoneScreen.OperationPA();</span><br><span class="hljs-comment">// computerMotherBoard.OperationCA();</span><br><span class="hljs-comment">// computerScreen.OperationCA();</span><br><br><span class="hljs-comment">// ************* 3.工厂方法模式测试 **************</span><br><span class="hljs-comment">// using FactoryPattern;</span><br><br><span class="hljs-comment">// IFactoryMethod phoneMotherBoardFactory = new FactoryMethodPattern.PhoneMotherBoardFactory();</span><br><span class="hljs-comment">// IFactoryMethod phoneScreenFactory = new FactoryMethodPattern.PhoneScreenFactory();</span><br><span class="hljs-comment">// IPhoneAccessory phoneMotherBoard = phoneMotherBoardFactory.Create(); // 手机主板</span><br><span class="hljs-comment">// IPhoneAccessory phoneScreen = phoneScreenFactory.Create(); // 手机屏幕</span><br><span class="hljs-comment">// phoneMotherBoard.OperationPA();</span><br><span class="hljs-comment">// phoneScreen.OperationPA();</span><br><br><span class="hljs-comment">// ************* 4.抽象工厂模式测试 **************</span><br><span class="hljs-comment">// using FactoryPattern;</span><br><br><span class="hljs-comment">// IFactory computerFactory = new AbstractFactoryPattern.MotherBoardFactory();</span><br><span class="hljs-comment">// IFactory phoneFactory = new AbstractFactoryPattern.ScreenFactory();</span><br><span class="hljs-comment">// IMotherBoard computerMB = computerFactory.CreateMB(); // 电脑主板</span><br><span class="hljs-comment">// IScreen computerSC = computerFactory.CreateSC(); // 电脑屏幕</span><br><span class="hljs-comment">// IMotherBoard phoneMB = phoneFactory.CreateMB(); // 手机主板</span><br><span class="hljs-comment">// IScreen phoneSC = phoneFactory.CreateSC(); // 手机屏幕</span><br><span class="hljs-comment">// computerMB.OperationMB();</span><br><span class="hljs-comment">// computerSC.OperationSC();</span><br><span class="hljs-comment">// phoneMB.OperationMB();</span><br><span class="hljs-comment">// phoneSC.OperationSC();</span><br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>示例代码中我们对三种工厂模式的应用进行了简单的举例说明，但是这还远远没有达到实际开发中所要运用的程度，实际开发中可能需要多种设计模式结合使用，例如工厂模式与单例模式的结合，工厂模式结合对象池技术等等，结合具体需求进行具体的设计，高质量的代码应该是每一位程序员在开发生涯所不断追求的目标，学习设计模式则是编写高质量代码的入门必修课。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Strategy Pattern（策略模式）</title>
      
      <link href="/posts/2026/01/08/416daa2e373f/"/>
      <url>/posts/2026/01/08/416daa2e373f/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>策略模式是一种行为设计模式，适用于我们需要针对不同的状况采用不同的行为策略的情景，通常对于这种情景我们会优先考虑到使用条件语句来管理，但是这么做并不利于后续的扩展以及难以应对状况繁多复杂的情况，对于简单的情景可以通过条件语句来实现。</p><p>策略模式将具体使用权交给调用者，因为每个策略会被要求实现统一的接口，所以策略管理的主体可以根据调用者传递的指定的策略，而在不修改内部代码的情况下通过接口方法采用统一的方式对不同的策略进行调用。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>排序算法、图像处理、支付方式、日志记录、游戏开发、缓存策略、路由策略等。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">策略模式与条件语句的对比</div><table align="center" border="1" cellpadding="1" cellspacing="1" style="width:600px">  <tbody>    <tr>      <th style="width:79px">        <strong>特征</strong></th>      <th style="width:244px">        <strong>策略模式</strong></th>      <th>        <strong>条件语句</strong></th>    </tr>    <tr>      <td style="width:79px">        <strong>可维护性</strong></td>      <td style="width:244px">高，每个算法有独立的策略类，易于新增、修改和删除算法。</td>      <td>低，条件语句通常散布在代码中，修改可能需要多处修改。</td></tr>    <tr>      <td style="width:79px">        <strong>可扩展性</strong></td>      <td style="width:244px">高，添加新的算法只需要实现新的策略类，不影响现有代码。</td>      <td>低，添加新的条件通常需要修改包含条件语句的函数或类。</td></tr>    <tr>      <td style="width:79px">        <strong>复用性</strong></td>      <td style="width:244px">高，每个策略类都是独立的，可以在不同的上下文中被复用。</td>      <td>低，条件语句通常紧密耦合于特定的类或函数，难以单独复用。</td></tr>    <tr>      <td style="width:79px">        <strong>可读性</strong></td>      <td style="width:244px">高，通过命名清晰的策略类，代码更容易理解和维护。</td>      <td>低，复杂的条件语句可能导致代码难以理解，降低可读性。</td></tr>    <tr>      <td style="width:79px">        <strong>灵活性</strong></td>      <td style="width:244px">高，可以在运行时动态切换算法，灵活应对变化。</td>      <td>低，通常需要修改源代码，不够灵活，容易引入错误。</td></tr>    <tr>      <td style="width:79px">        <strong>依赖关系</strong></td>      <td style="width:244px">低，策略模式降低了上下文和具体策略之间的耦合。</td>      <td>高，条件语句使得代码模块之间的依赖性增加。</td></tr>    <tr>      <td style="width:79px">        <strong>性能影响</strong></td>      <td style="width:244px">通常较小，因为策略模式将算法封装在独立的对象中。</td>      <td>取决于条件语句的复杂性，可能会导致性能损失。</td></tr>  </tbody></table><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Context（上下文）：</strong> 定义了一个接口，用于维护对策略对象的引用，并负责在运行时切换不同的策略。上下文通常持有一个策略对象的引用，并通过策略对象执行具体的算法。</p><p><strong>Strategy（策略）：</strong> 定义了一组算法接口，通常通过接口或抽象类来实现。这个接口定义了具体策略类必须实现的方法。</p><p><strong>ConcreteStrategy（具体策略）：</strong> 实现了策略接口的具体算法。每个具体策略类实现了算法的一种变体。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>客户端使用Context设置策略：</strong> 客户端通过Context对象设置所需的具体策略，可以在运行时动态切换策略。</p></li><li><p><strong>Context调用策略算法：</strong> 当客户端调用Context的方法时，Context会将具体的算法委托给当前设置的策略对象来执行。</p></li><li><p><strong>具体策略类执行算法：</strong> 具体策略类实现了策略接口定义的算法，通过Context调用的方式执行特定的算法。</p></li><li><p><strong>客户端与具体算法解耦：</strong> 策略模式的关键在于将客户端与具体算法的实现解耦。客户端通过接口与Context交互，而具体策略类的变化不会影响客户端。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="动物：Animal-cs"><a href="#动物：Animal-cs" class="headerlink" title="动物：Animal.cs"></a>动物：Animal.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">StrategyPattern</span>;<br><br><span class="hljs-comment">// 动物</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Animal</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 动物名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> weight; <span class="hljs-comment">// 动物体重，单位kg</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> length; <span class="hljs-comment">// 动物从头部到尾部的长度，单位m</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Animal</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">float</span> weight, <span class="hljs-built_in">float</span> length</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.weight = weight;<br>        <span class="hljs-keyword">this</span>.length = length;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[name:<span class="hljs-subst">&#123;name&#125;</span>,weight:<span class="hljs-subst">&#123;weight&#125;</span>,length:<span class="hljs-subst">&#123;length&#125;</span>]&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 猫</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> : <span class="hljs-title">Animal</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cat</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">float</span> weight, <span class="hljs-built_in">float</span> length</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name, weight, length</span>)</span> &#123; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="策略：Strategy-cs"><a href="#策略：Strategy-cs" class="headerlink" title="策略：Strategy.cs"></a>策略：Strategy.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">StrategyPattern</span>;<br><br><span class="hljs-comment">// 策略</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IStrategy</span><br>&#123;<br>    <span class="hljs-comment">// 约定返回结果：-1表示a劣于b，0表示a与b平等，1表示a优于b</span><br>    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">Compare</span>(<span class="hljs-params">Animal a, Animal b</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 体重比较策略</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">WeightStrategy</span> : <span class="hljs-title">IStrategy</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Compare</span>(<span class="hljs-params">Animal a, Animal b</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span> &amp;&amp; b != <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-comment">// 动物a的体重低于动物b</span><br>            <span class="hljs-keyword">if</span> (a.weight &lt; b.weight) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            <span class="hljs-comment">// 动物a的体重高于动物b</span><br>            <span class="hljs-keyword">if</span> (a.weight &gt; b.weight) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 长度比较策略</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">LengthStrategy</span> : <span class="hljs-title">IStrategy</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Compare</span>(<span class="hljs-params">Animal a, Animal b</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span> &amp;&amp; b != <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-comment">// 动物a的长度小于动物b</span><br>            <span class="hljs-keyword">if</span> (a.length &lt; b.length) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>            <span class="hljs-comment">// 动物a的长度大于动物b</span><br>            <span class="hljs-keyword">if</span> (a.length &gt; b.length) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="策略模式：StrategyPattern-cs"><a href="#策略模式：StrategyPattern-cs" class="headerlink" title="策略模式：StrategyPattern.cs"></a>策略模式：StrategyPattern.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">StrategyPattern</span>;<br><br><span class="hljs-comment">// 策略模式</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">StrategyPatternManager</span><br>&#123;<br>    <span class="hljs-keyword">private</span> IStrategy strategy;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StrategyPatternManager</span>(<span class="hljs-params">IStrategy strategy</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.strategy = strategy;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Sort</span>(<span class="hljs-params">Animal[] animals, <span class="hljs-built_in">bool</span> minToMax = <span class="hljs-literal">true</span></span>)</span><br>    &#123;<br>        <span class="hljs-comment">// 符合以下判断则不进行排序</span><br>        <span class="hljs-keyword">if</span> (strategy == <span class="hljs-literal">null</span> || animals == <span class="hljs-literal">null</span> || animals.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-comment">// res用于记录比较策略的结果值，1表示从小到大排序，-1表示从大到小排序</span><br>        <span class="hljs-built_in">int</span> res = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (!minToMax) res = <span class="hljs-number">-1</span>;<br><br>        <span class="hljs-comment">// 冒泡排序</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; animals.Length; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = i + <span class="hljs-number">1</span>; j &lt; animals.Length; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (strategy.Compare(animals[i], animals[j]) == res)<br>                &#123;<br>                    Animal temp = animals[i];<br>                    animals[i] = animals[j];<br>                    animals[j] = temp;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 5.策略模式测试 **************</span><br><span class="hljs-keyword">using</span> StrategyPattern;<br><br>Animal[] cats =<br>&#123;<br>    <span class="hljs-keyword">new</span> Cat(<span class="hljs-string">&quot;橘猫&quot;</span>,<span class="hljs-number">20f</span>,<span class="hljs-number">0.78f</span>),<br>    <span class="hljs-keyword">new</span> Cat(<span class="hljs-string">&quot;狸花猫&quot;</span>,<span class="hljs-number">15f</span>,<span class="hljs-number">0.72f</span>),<br>    <span class="hljs-keyword">new</span> Cat(<span class="hljs-string">&quot;英国短尾猫&quot;</span>,<span class="hljs-number">18f</span>,<span class="hljs-number">0.65f</span>),<br>&#125;;<br><br>WeightStrategy weightStrategy = <span class="hljs-keyword">new</span> WeightStrategy();<br>LengthStrategy lengthStrategy = <span class="hljs-keyword">new</span> LengthStrategy();<br><br>Console.WriteLine(<span class="hljs-string">&quot;*************** 按照体重从小到大对所有猫进行排序并输出 *****************&quot;</span>);<br>StrategyPatternManager strategyPattern = <span class="hljs-keyword">new</span> StrategyPatternManager(weightStrategy);<br>strategyPattern.Sort(cats);<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; cats.Length; i++)<br>&#123;<br>    Console.WriteLine(cats[i]);<br>&#125;<br><br>Console.WriteLine(<span class="hljs-string">&quot;*************** 按照长度从大到小对所有猫进行排序并输出 *****************&quot;</span>);<br>strategyPattern = <span class="hljs-keyword">new</span> StrategyPatternManager(lengthStrategy);<br>strategyPattern.Sort(cats, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; cats.Length; i++)<br>&#123;<br>    Console.WriteLine(cats[i]);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述示例我们通过策略模式实现对所有猫分别按照体重和长度进行排序和输出。这里策略模式的应用则是针对猫的体重和长度的比较策略，二者都实现了策略接口，具体比较策略的逻辑由各自编写，StrategyPatternManager提供排序调用接口，根据创建实例时传递的比较策略来对Animal数组进行排序。这里之所以让Cat继承Animal是为了便于扩展，可能后续存在其他类型动物以及不同类型动物之间的比较需求。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Facade Pattern（门面模式、外观模式）</title>
      
      <link href="/posts/2026/01/08/fcf316772f53/"/>
      <url>/posts/2026/01/08/fcf316772f53/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>门面（外观）模式是一种结构型设计模式，可用于调用者与内部系统的解耦，能够对复杂业务的接口进行简化，同时也可以避免内部系统中各个子系统之间的直接依赖。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>复杂系统的接口简化、为遗留系统提供接口、库或框架接口的设计、多层架构中的隔离、子系统之间的解耦等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Facade（外观）：</strong> 外观类是外观模式的核心，它提供了一个简化的接口，隐藏了系统内部子系统的复杂性。客户端通过与外观类进行交互来使用系统。</p><p><strong>Subsystem（子系统）：</strong> 子系统是系统内部的一组类或模块，负责实际完成系统的各个功能。这些功能可能会被外观类封装起来，对客户端不可见。</p><p><strong>Client（客户端）：</strong> 客户端是使用外观模式的地方。客户端通过与外观类交互来实现其功能，而不直接与系统的子系统进行交互。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>客户端通过外观类进行操作：</strong> 客户端不直接与系统的子系统进行交互，而是通过与外观类进行交互来完成操作。外观类提供了一个简单而一致的接口，隐藏了系统的复杂性。</p></li><li><p><strong>外观类调用相关子系统：</strong> 外观类知道如何调用系统中的各个子系统，以完成客户端请求。外观类可能需要协调多个子系统的工作，但客户端不需要知道这些细节。</p></li><li><p><strong>子系统处理具体任务：</strong> 实际的工作由子系统来完成。每个子系统负责执行一个特定的任务，这些任务可能相互关联，但客户端不需要关心这些关联关系。</p></li><li><p><strong>客户端获得简化的接口：</strong> 通过外观模式，客户端获得了一个简化的、高层次的接口，使其更容易使用系统。客户端不必了解系统的内部结构，只需与外观类进行交互即可。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="系统：Systems-cs"><a href="#系统：Systems-cs" class="headerlink" title="系统：Systems.cs"></a>系统：Systems.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FacadePattern</span>;<br><br><span class="hljs-comment">// 订单系统</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">OrderSystem</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SubmitOrder</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;已发送订单给商家。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CancleOrder</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;已取消订单，并告知商家。&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 物流系统</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">LogisticsSystem</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendGood</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;商家已发送货物。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StopSendGood</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;商家已停止发送货物。&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 支付系统</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentSystem</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Pay</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;顾客已支付订单。&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReturnMoney</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;支付款已退还给顾客。&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="门面模式：FacadePattern-cs"><a href="#门面模式：FacadePattern-cs" class="headerlink" title="门面模式：FacadePattern.cs"></a>门面模式：FacadePattern.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FacadePattern</span>;<br><br><span class="hljs-comment">// 门面模式</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">FacadePatternManager</span><br>&#123;<br>    <span class="hljs-keyword">private</span> OrderSystem orderSystem;<br>    <span class="hljs-keyword">private</span> LogisticsSystem logisticsSystem;<br>    <span class="hljs-keyword">private</span> PaymentSystem paymentSystem;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FacadePatternManager</span>()</span><br>    &#123;<br>        orderSystem = <span class="hljs-keyword">new</span> OrderSystem();<br>        logisticsSystem = <span class="hljs-keyword">new</span> LogisticsSystem();<br>        paymentSystem = <span class="hljs-keyword">new</span> PaymentSystem();<br>    &#125;<br><br>    <span class="hljs-comment">// 完成商品购买</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Shopping</span>()</span><br>    &#123;<br>        paymentSystem.Pay();<br>        orderSystem.SubmitOrder();<br>        logisticsSystem.SendGood();<br>    &#125;<br><br>    <span class="hljs-comment">// 取消商品购买</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Cancle</span>()</span><br>    &#123;<br>        orderSystem.CancleOrder();<br>        logisticsSystem.StopSendGood();<br>        paymentSystem.ReturnMoney();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 6.门面模式测试 **************</span><br><span class="hljs-keyword">using</span> FacadePattern;<br><br>FacadePatternManager facadePattern = <span class="hljs-keyword">new</span> FacadePatternManager();<br>facadePattern.Shopping();<br>Console.WriteLine(<span class="hljs-string">&quot;---------------------------------------------&quot;</span>);<br>facadePattern.Cancle();<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了网上购物中购物和取消购物的业务逻辑。其中购物的逻辑是顾客在选定好指定的商品后进行支付，完成支付后订单将被发送给商家，商家按照订单信息进行发货。而取消购物的逻辑则是顾客取消订单，通知商家停止发货，退还顾客支付款项。</p><p>首先购物逻辑涉及到对订单系统、物流系统和支付系统的调用，对于顾客而言不需要自己去完成发送订单和通知商家发货，顾客只需要直接完成指定商品的支付即可，所以通过门面模式将三个系统对于购物逻辑的接口方法的调用组合在一起统一调用，调用顺序由门面负责，门面向顾客提供一个购物接口即可。取消购物的逻辑同理。</p><p>事实上，我们可以对比一下不使用和使用门面模式的区别。不使用门面模式，所有的调用由顾客自己去完成，这让顾客的购物变得更加复杂。对于顾客而言，应该更多去关注对商品的使用，而不是把精力花在如何完成购物这一行为上。一旦各个系统的接口发生变化，那么就需要在调用者的业务逻辑中去修改源代码，当业务逻辑的代码繁杂时，那么修改的成本也会比较高，如果采用门面模式，则可以更好地解决这个问题，也可以预防未来系统接口变化而引起的修改，因为门面中通常只需要编写少量的代码，所以修改也会更加快速和方便，维护成本也更低。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Mediator Pattern（中介者模式、调停者模式）</title>
      
      <link href="/posts/2026/01/08/29b3c315e617/"/>
      <url>/posts/2026/01/08/29b3c315e617/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>中介者模式是一种行为设计模式，用于对系统内各模块之间显式调用的解耦，模块之间不直接进行调用，而是通过中介者来间接调用，这避免了模块之间的直接依赖，中介者集中化管理模块之间的调用，使得模块能够专注于具体业务逻辑的开发。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>模块间复杂的交互关系、多个对象依赖于同一个对象、同类型对象的协同工作等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>中介者（Mediator）：</strong> 定义一个接口，该接口声明了各个同事对象之间的通信方法。负责协调各个同事对象的行为。</p><p><strong>具体中介者（Concrete Mediator）：</strong> 实现中介者接口。维护对各个同事对象的引用。协调各个同事对象之间的交互关系。</p><p><strong>同事对象（Colleague）：</strong> 每个同事对象都知道中介者对象。通过中介者来进行与其他同事对象的通信。</p><p><strong>具体同事对象（Concrete Colleague）：</strong> 实现同事对象接口。通过中介者进行与其他同事对象的协调和通信。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>同事对象发送消息：</strong> 当一个同事对象需要与其他同事对象进行通信时，它不直接与其他对象通信，而是通过中介者发送消息。</p></li><li><p><strong>中介者接收消息：</strong> 中介者接收到同事对象的消息，并根据需要进行处理。</p></li><li><p><strong>中介者协调处理：</strong> 中介者负责协调各个同事对象之间的交互，可以根据具体需求进行处理和转发消息。</p></li><li><p><strong>同事对象处理消息：</strong> 各个同事对象根据中介者的协调，处理接收到的消息。同事对象之间不直接通信，而是通过中介者来进行协调。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="同事：Colleague-cs"><a href="#同事：Colleague-cs" class="headerlink" title="同事：Colleague.cs"></a>同事：Colleague.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">MediatorPattern</span>;<br><br><span class="hljs-comment">// 聊天接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IChat</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 同事</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Colleague</span> : <span class="hljs-title">IChat</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 名称</span><br>    <span class="hljs-keyword">private</span> IChatroomMediator chatroom; <span class="hljs-comment">// 聊天室</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Colleague</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, IChatroomMediator chatroom</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.chatroom = chatroom;<br>        chatroom.Register(<span class="hljs-keyword">this</span>); <span class="hljs-comment">// 向聊天室进行注册</span><br>    &#125;<br><br>    <span class="hljs-comment">// 发送消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span><br>    &#123;<br>        chatroom.SendMessage(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>:&quot;</span> + message, <span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 接收消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;User &#x27;<span class="hljs-subst">&#123;name&#125;</span>&#x27; received a message with the content &#x27;<span class="hljs-subst">&#123;message&#125;</span>&#x27;.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="中介者：Mediator-cs"><a href="#中介者：Mediator-cs" class="headerlink" title="中介者：Mediator.cs"></a>中介者：Mediator.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">MediatorPattern</span>;<br><br><span class="hljs-comment">// 聊天室中介者</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IChatroomMediator</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message, IChat user</span>)</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Register</span>(<span class="hljs-params">IChat user</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 聊天室</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Chatroom</span> : <span class="hljs-title">IChatroomMediator</span><br>&#123;<br>    <span class="hljs-keyword">private</span> List&lt;IChat&gt; users; <span class="hljs-comment">// 用户集合</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Chatroom</span>()</span><br>    &#123;<br>        users = <span class="hljs-keyword">new</span> List&lt;IChat&gt;();<br>    &#125;<br><br>    <span class="hljs-comment">// 注册用户</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Register</span>(<span class="hljs-params">IChat user</span>)</span><br>    &#123;<br>        users.Add(user);<br>    &#125;<br><br>    <span class="hljs-comment">// 指定用户向其他用户发送指定信息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message, IChat user</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (users.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; users.Count; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (users[i] != user) users[i].ReceiveMessage(message);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 7.中介者模式（调停者模式）测试 **************</span><br><span class="hljs-keyword">using</span> MediatorPattern;<br><br>Chatroom chatroom = <span class="hljs-keyword">new</span> Chatroom();<br><br>Colleague wxm = <span class="hljs-keyword">new</span> Colleague(<span class="hljs-string">&quot;王小明&quot;</span>, chatroom);<br>Colleague en = <span class="hljs-keyword">new</span> Colleague(<span class="hljs-string">&quot;二妮&quot;</span>, chatroom);<br>Colleague kk = <span class="hljs-keyword">new</span> Colleague(<span class="hljs-string">&quot;康康&quot;</span>, chatroom);<br><br>Console.WriteLine(<span class="hljs-string">&quot;聊天室禁言功能已关闭...&quot;</span>);<br>wxm.SendMessage(<span class="hljs-string">&quot;管理员总算解除全体禁言了！&quot;</span>);<br>en.SendMessage(<span class="hljs-string">&quot;可不是嘛，都两周没聊天了。T^T&quot;</span>);<br>kk.SendMessage(<span class="hljs-string">&quot;无所谓，不禁言我就来，禁言我也还有其它事情可以做。&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了聊天室的功能。同事类实现了聊天的接口从而具备了发送消息和接收消息的功能，聊天室实现了聊天室中介者的接口，向外部提供发送消息和注册的接口方法。三个同事需要知道在哪个聊天室聊天，所以在他们实例化时需要传递聊天室的实例，在聊天室注册成功后即可开始发送消息。本案例中的中介者则是聊天室，其负责同事的注册和消息通信。</p><p>如果不采用中介者模式实现本案例，那同事之间的相互通信就需要获取其他同事的实例，直接的依赖关系使得同事之间的耦合度提升，增加了同事各自的维护成本。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Decorator Pattern（装饰器模式）</title>
      
      <link href="/posts/2026/01/08/0e78c6c0091f/"/>
      <url>/posts/2026/01/08/0e78c6c0091f/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>装饰器模式是一种结构型设计模式，适用于给一个现有的对象扩展新的功能，同时又不改变其原有的结构和行为。通常对于要给一个对象扩展新的功能，我们首先想到的方式是继承，而继承适合类的层次结构稳定的情况，而且是需要在编译时确定好层次结构，无法在运行时动态地添加功能。那么对于需要运行时动态添加功能、避免类爆炸或者结构不固定的需求，那么就可以考虑采用装饰器模式。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>常见的应用场景：动态功能扩展、避免过多的继承扩展、对现有对象的复用等。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">装饰器模式与继承的对比</div><table align="center" border="1" cellpadding="1" cellspacing="1" style="width:600px">  <tbody>    <tr>      <th style="width:85px">特性</th>      <th style="width:246px">Decorator 模式</th>      <th style="width:268px">继承</th></tr>    <tr>      <td style="width:85px">扩展功能</td>      <td style="width:246px">允许在运行时动态添加或移除功能，避免类爆炸问题。</td>      <td style="width:268px">静态定义，需要在编译时确定类的结构。</td></tr>    <tr>      <td style="width:85px">修改现有功能</td>      <td style="width:246px">允许通过组合而非继承的方式修改现有对象的行为。</td>      <td style="width:268px">通过覆写方法的方式修改现有类的行为。</td></tr>    <tr>      <td style="width:85px">开闭原则</td>      <td style="width:246px">符合开闭原则，可以通过添加新的装饰器来扩展功能。</td>      <td style="width:268px">在不修改现有类的情况下，很难添加新的功能。</td></tr>    <tr>      <td style="width:85px">灵活性</td>      <td style="width:246px">提供更灵活的设计，允许动态地组合不同的功能。</td>      <td style="width:268px">较为静态，类的结构在编译时已经确定，难以动态改变。</td></tr>    <tr>      <td style="width:85px">可读性</td>      <td style="width:246px">可以更清晰地组织和理解不同功能的组合。</td>      <td style="width:268px">需要谨慎设计继承结构，可能导致深层次的类层次结构不清晰。</td></tr>    <tr>      <td style="width:85px">代码重用</td>      <td style="width:246px">允许在不修改现有类的情况下复用已有的功能。</td>      <td style="width:268px">通过继承复用功能，但可能会导致父类的方法被不必要地继承。</td></tr>  </tbody></table><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Component（组件）：</strong> 定义一个抽象接口，具体组件和装饰器都实现了这个接口。它是装饰器模式的核心，是被装饰的对象的抽象表示。</p><p><strong>ConcreteComponent（具体组件）：</strong> 实现了 Component 接口的具体组件类，是被装饰的对象。</p><p><strong>Decorator（装饰器）：</strong> 继承自 Component，并持有一个 Component 对象的引用。装饰器的接口与 Component 接口一致，但通常不直接使用 ConcreteComponent 类，而是通过组合的方式，将具体组件包装在装饰器中。</p><p><strong>ConcreteDecorator（具体装饰器）：</strong> 实现了 Decorator 接口的具体装饰器类。它通过在调用父类的方法前后添加额外的行为，来扩展或修改原有组件的功能。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>客户端创建组件对象：</strong> 客户端创建一个具体组件对象，这通常是最初需要被装饰的对象。</p></li><li><p><strong>创建装饰器对象：</strong> 客户端可以选择性地创建装饰器对象，这些装饰器对象实现了装饰器接口并包含一个指向具体组件对象的引用。</p></li><li><p><strong>装饰器包装组件：</strong> 装饰器对象通过持有组件对象的引用，以组合的方式将具体组件包装在其中。</p></li><li><p><strong>客户端使用装饰器：</strong> 客户端通过使用装饰器对象来调用组件的方法。装饰器对象在调用组件的方法之前或之后，可以添加额外的行为，从而扩展或修改组件的功能。</p></li><li><p><strong>递归装饰：</strong> 如果需要多层装饰，装饰器可以递归地嵌套，每个装饰器都包装了上一层的装饰器或具体组件。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="武器：Weapon-cs"><a href="#武器：Weapon-cs" class="headerlink" title="武器：Weapon.cs"></a>武器：Weapon.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">DecoratorPattern</span>;<br><br><span class="hljs-comment">// 武器</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IWeapon</span><br>&#123;<br>    <span class="hljs-built_in">string</span> name &#123; <span class="hljs-keyword">get</span>; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Operation</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 剑</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Sword</span> : <span class="hljs-title">IWeapon</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name =&gt; <span class="hljs-string">&quot;Sword&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Operation</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;Sword:This is a sword.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 枪</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Gun</span> : <span class="hljs-title">IWeapon</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name =&gt; <span class="hljs-string">&quot;Gun&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Operation</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;Gun:This is a gun.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="装饰器：Decorator-cs"><a href="#装饰器：Decorator-cs" class="headerlink" title="装饰器：Decorator.cs"></a>装饰器：Decorator.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">DecoratorPattern</span>;<br><br><span class="hljs-comment">// 武器装饰器</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IWeaponDecorator</span> : <span class="hljs-title">IWeapon</span> &#123; &#125;<br><br><span class="hljs-comment">// 添加火焰属性</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">FireDecorator</span> : <span class="hljs-title">IWeaponDecorator</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (weapon == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>.Empty;<br>            <span class="hljs-keyword">return</span> weapon.name;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> IWeapon weapon; <span class="hljs-comment">// 武器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FireDecorator</span>(<span class="hljs-params">IWeapon weapon</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.weapon = weapon;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Operation</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Fire<span class="hljs-subst">&#123;name&#125;</span>:This is a <span class="hljs-subst">&#123;name&#125;</span> with the fire attribute.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 添加红色属性</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">RedDecorator</span> : <span class="hljs-title">IWeaponDecorator</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (weapon == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>.Empty;<br>            <span class="hljs-keyword">return</span> weapon.name;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> IWeapon weapon; <span class="hljs-comment">// 武器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RedDecorator</span>(<span class="hljs-params">IWeapon weapon</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.weapon = weapon;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Operation</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Red<span class="hljs-subst">&#123;name&#125;</span>:This is a <span class="hljs-subst">&#123;name&#125;</span>, and it&#x27;s color is red.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 8.装饰器模式测试 **************</span><br><span class="hljs-keyword">using</span> DecoratorPattern;<br><br>IWeapon sword = <span class="hljs-keyword">new</span> Sword();<br>IWeapon gun = <span class="hljs-keyword">new</span> Gun();<br><br>Console.WriteLine(<span class="hljs-string">&quot;不添加装饰器...&quot;</span>);<br>sword.Operation();<br>gun.Operation();<br><br>Console.WriteLine(<span class="hljs-string">&quot;添加装饰器...&quot;</span>);<br>IWeapon fireSword = <span class="hljs-keyword">new</span> FireDecorator(sword);<br>fireSword.Operation();<br>IWeapon redGun = <span class="hljs-keyword">new</span> RedDecorator(gun);<br>redGun.Operation();<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单演示了对武器添加属性或者添加颜色。通过火属性装饰器和红色装饰器分别为剑和枪扩展属性，而这种扩展是运行时动态添加的，并非是在编译时提前编写好的，装饰器并没有对武器原有的结构和行为进行改变。</p><p>如果不采用装饰器模式，我们可以在定义武器时直接添加两个字段用于记录武器的特殊属性和颜色，或者通过继承的方式来扩展，但是当武器的参数或者类型过多时，就可能使得武器的结构变得臃肿和复杂，涉及到武器类型过多还可能因为继承导致类爆炸的问题，从而提升维护成本。所以除非武器的结构比较固定或者简单，否则如果后续需要扩展，尤其是对于武器某种复杂属性的扩展，还是建议通过装饰器模式来完成。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>COR Pattern（责任链模式）</title>
      
      <link href="/posts/2026/01/08/8ca6d181d597/"/>
      <url>/posts/2026/01/08/8ca6d181d597/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>责任链模式是一种行为型设计模式，用于对请求的发起者与处理者进行解耦，同时也用于管理复杂的或繁多的处理流程，责任链也可以看作处理链或者流程链，当一个请求处理系统需要处理多种不同类型的请求或者对于某个请求需要按顺序分步处理时就可以采用责任链模式，并且责任链是易于管理和扩展的，可以对责任链上的处理节点进行增加和删除，也可以对多个责任链进行连接。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>事件处理系统、审批流程、日志记录、Web请求中间件、异常处理、菜单或命令的处理、工作流程管理等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Handler（处理者）:</strong> 定义一个处理请求的接口。持有一个指向下一个处理者的引用（可选）。可以实现一个默认的处理行为。提供一个方法用于处理请求，通常命名为 HandleRequest 或类似。</p><p><strong>ConcreteHandler（具体处理者）:</strong> 实现处理请求的具体逻辑。如果能够处理请求，则处理之；否则，将请求传递给下一个处理者。</p><p><strong>Client（客户端）:</strong> 创建处理者链并向链的起始对象发送请求。与处理者的抽象接口交互，无需关心具体的处理者实现。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>请求的传递：</strong> 客户端创建一个处理者链，并将请求发送给链的起始处理者（通常是具体处理者的实例）。每个处理者对象都有一个指向下一个处理者的引用。请求从链的起始点开始沿着链传递，直到有一个处理者能够处理它或者到达链的末尾。</p></li><li><p><strong>处理请求：</strong> 当一个处理者收到请求时，它首先检查自己是否能够处理请求。如果能够处理，就执行相应的处理逻辑。如果处理者无法处理请求，它将请求传递给下一个处理者，即调用下一个处理者的处理方法。</p></li><li><p><strong>终止条件：</strong> 处理者链的末尾通常是一个没有后继处理者的处理者，或者后继处理者被设置为 null。这样设计是为了确保链中的每个处理者都有机会处理请求。</p></li><li><p><strong>动态添加处理者：</strong> 责任链模式支持动态添加和移除处理者，因此客户端可以灵活地调整链的结构。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="快捷键：Shortcut-cs"><a href="#快捷键：Shortcut-cs" class="headerlink" title="快捷键：Shortcut.cs"></a>快捷键：Shortcut.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CORPattern</span>;<br><br><span class="hljs-comment">// 快捷键</span><br><span class="hljs-built_in">enum</span> Shortcut<br>&#123;<br>    None, CTRL_X, CTRL_C, CTRL_V<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="快捷键指令处理者：ShortcutHandler-cs"><a href="#快捷键指令处理者：ShortcutHandler-cs" class="headerlink" title="快捷键指令处理者：ShortcutHandler.cs"></a>快捷键指令处理者：ShortcutHandler.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CORPattern</span>;<br><br><span class="hljs-comment">// 快捷键处理基类</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ShortcutHandler</span><br>&#123;<br>    <span class="hljs-keyword">protected</span> ShortcutHandler nextHandler; <span class="hljs-comment">// 下一个处理者</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ShortcutHandler</span>(<span class="hljs-params">ShortcutHandler nextHandler</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.nextHandler = nextHandler;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Shortcut shortcut</span>)</span>; <span class="hljs-comment">// 抽象方法：快捷键指令处理</span><br>&#125;<br><br><span class="hljs-comment">// 剪切处理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Cut</span> : <span class="hljs-title">ShortcutHandler</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cut</span>(<span class="hljs-params">ShortcutHandler nextHandler</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">nextHandler</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Shortcut shortcut</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (shortcut == Shortcut.CTRL_X) Console.WriteLine(<span class="hljs-string">&quot;Cut:已剪切文本...&quot;</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nextHandler != <span class="hljs-literal">null</span>) nextHandler.Handle(shortcut);<br>        <span class="hljs-keyword">else</span> Console.WriteLine(<span class="hljs-string">&quot;Cut:责任链无法处理当前所指定的快捷键指令...&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 复制处理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Copy</span> : <span class="hljs-title">ShortcutHandler</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Copy</span>(<span class="hljs-params">ShortcutHandler nextHandler</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">nextHandler</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Shortcut shortcut</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (shortcut == Shortcut.CTRL_C) Console.WriteLine(<span class="hljs-string">&quot;Copy:已复制文本...&quot;</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nextHandler != <span class="hljs-literal">null</span>) nextHandler.Handle(shortcut);<br>        <span class="hljs-keyword">else</span> Console.WriteLine(<span class="hljs-string">&quot;Copy:责任链无法处理当前所指定的快捷键指令...&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 粘贴处理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Paste</span> : <span class="hljs-title">ShortcutHandler</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Paste</span>(<span class="hljs-params">ShortcutHandler nextHandler</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">nextHandler</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Shortcut shortcut</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (shortcut == Shortcut.CTRL_V) Console.WriteLine(<span class="hljs-string">&quot;Paste:已粘贴文本...&quot;</span>);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nextHandler != <span class="hljs-literal">null</span>) nextHandler.Handle(shortcut);<br>        <span class="hljs-keyword">else</span> Console.WriteLine(<span class="hljs-string">&quot;Paste:责任链无法处理当前所指定的快捷键指令...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 9.责任链模式测试 **************</span><br><span class="hljs-keyword">using</span> CORPattern;<br><span class="hljs-meta"># nullable disable</span><br><br><span class="hljs-comment">// 定义三种快捷键指令的处理，指令处理的传递顺序：cut =&gt; copy =&gt; paste</span><br>ShortcutHandler paste = <span class="hljs-keyword">new</span> Paste(<span class="hljs-literal">null</span>);<br>ShortcutHandler copy = <span class="hljs-keyword">new</span> Copy(paste);<br>ShortcutHandler cut = <span class="hljs-keyword">new</span> Cut(copy);<br><br><span class="hljs-comment">// 开始测试Ctrl+V指令</span><br>cut.Handle(Shortcut.CTRL_V);<br>cut.Handle(Shortcut.CTRL_X);<br>cut.Handle(Shortcut.CTRL_C);<br>cut.Handle(Shortcut.None);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了对剪切、复制和粘贴快捷键指令的处理。三个快捷键指令分别对应三个处理者，并且每个处理者会在实例化时记录下一个处理者，当该处理者无法处理指令时传递给下一个处理者，将所有的处理者组合成一个处理链，这就是对责任链模式的简单应用。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Observer Pattern（观察者模式）</title>
      
      <link href="/posts/2026/01/08/a490c83cb7b3/"/>
      <url>/posts/2026/01/08/a490c83cb7b3/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>观察者模式是一种行为型设计模式，顾名思义它通常是用于对某个或某类对象进行观察，根据所观察的对象的状态而进行处理，例如对UI控件输入事件的监听或者游戏中敌人状态变化触发数值系统的处理等。在观察者模式中，我们习惯于划分出主题和观察者，可以有一到多个观察者对主题进行观察，观察者需要向主题进行注册以便于在主题的状态发生改变时接收到通知或者完成预定的处理。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>事件处理系统、消息通知系统、发布-订阅模式、MVC架构、库和框架的事件机制、监控系统、游戏开发等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>主题（Subject）：</strong> 定义了一个接口，包含添加、删除和通知观察者的方法。维护一个观察者列表，用于存储所有注册的观察者。被具体主题实现。</p><p><strong>具体主题（ConcreteSubject）：</strong> 实现主题接口，具体主题是被观察的对象。维护自身状态，并在状态变化时通知所有观察者。当状态变化时，调用主题的通知方法，触发所有注册观察者的更新操作。</p><p><strong>观察者（Observer）：</strong> 定义了一个更新方法，用于在主题状态变化时接收通知。被具体观察者实现。</p><p><strong>具体观察者（ConcreteObserver）：</strong> 实现观察者接口，具体观察者是观察主题状态变化的对象。在接收到主题通知时执行具体的更新操作。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>主题注册观察者：</strong> 具体主题对象维护一个观察者列表。观察者通过主题提供的注册方法将自己添加到主题的观察者列表中。</p></li><li><p><strong>状态变化通知观察者：</strong> 具体主题的状态发生变化时，调用通知方法。通知方法遍历观察者列表，调用每个观察者的更新方法。</p></li><li><p><strong>观察者更新操作：</strong> 具体观察者的更新方法被调用，获取主题传递的新状态。具体观察者根据新状态执行相应的业务逻辑。</p></li><li><p><strong>解耦性增强：</strong> 主题和观察者之间松散耦合，主题不需要知道观察者的具体实现，只需要知道观察者遵循观察者接口。这样的设计使得系统更加灵活，可以方便地增加或删除观察者，而不影响主题或其他观察者。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="切换UI组件：Toggle-cs"><a href="#切换UI组件：Toggle-cs" class="headerlink" title="切换UI组件：Toggle.cs"></a>切换UI组件：Toggle.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">ObserverPattern</span>;<br><br><span class="hljs-comment">// UI控件状态（激活、禁用）</span><br><span class="hljs-built_in">enum</span> UIItemState<br>&#123;<br>    Enabled, Disabled<br>&#125;<br><br><span class="hljs-comment">// UI控件接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IUIItem</span><br>&#123;<br>    <span class="hljs-comment">// UI控件状态</span><br>    UIItemState state &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-comment">// 注册观察者</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Register</span>(<span class="hljs-params">IObserve observe</span>)</span>;<br><br>    <span class="hljs-comment">// 注销观察者</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UnRegister</span>(<span class="hljs-params">IObserve observe</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// Toggle切换控件</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Toggle</span> : <span class="hljs-title">IUIItem</span><br>&#123;<br>    <span class="hljs-keyword">public</span> UIItemState state<br>    &#123;<br>        <span class="hljs-keyword">get</span> &#123; <span class="hljs-keyword">return</span> _state; &#125;<br>        <span class="hljs-keyword">set</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_state != <span class="hljs-keyword">value</span>)<br>            &#123;<br>                _state = <span class="hljs-keyword">value</span>;<br>                NotifyObservers();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;IObserve&gt; observes; <span class="hljs-comment">// 观察者集合</span><br>    <span class="hljs-keyword">private</span> UIItemState _state; <span class="hljs-comment">// Toggle组件的状态</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Toggle</span>()</span><br>    &#123;<br>        observes = <span class="hljs-keyword">new</span> List&lt;IObserve&gt;();<br>        _state = UIItemState.Enabled;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Register</span>(<span class="hljs-params">IObserve observe</span>)</span><br>    &#123;<br>        observes.Add(observe);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnRegister</span>(<span class="hljs-params">IObserve observe</span>)</span><br>    &#123;<br>        observes.Remove(observe);<br>    &#125;<br><br>    <span class="hljs-comment">// 通知所有注册的观察者</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotifyObservers</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; observes.Count; i++)<br>        &#123;<br>            observes[i].Handle(_state);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="窗口：Window-cs"><a href="#窗口：Window-cs" class="headerlink" title="窗口：Window.cs"></a>窗口：Window.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">ObserverPattern</span>;<br><br><span class="hljs-comment">// 观察接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IObserve</span><br>&#123;<br>    <span class="hljs-comment">// 当观察的UI控件的状态发生变化时的处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">UIItemState state</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 窗口A</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">WindowA</span> : <span class="hljs-title">IObserve</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">UIItemState state</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (state == UIItemState.Enabled)<br>            Console.WriteLine(<span class="hljs-string">&quot;WindowA:The toggle&#x27;s state is enabled, you have switched to Window A.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 窗口B</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">WindowB</span> : <span class="hljs-title">IObserve</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">UIItemState state</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (state == UIItemState.Disabled)<br>            Console.WriteLine(<span class="hljs-string">&quot;WindowB:The toggle&#x27;s state is disabled, you have switched to Window B.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 10.观察者模式测试 **************</span><br><span class="hljs-keyword">using</span> ObserverPattern;<br><br>Toggle toggle = <span class="hljs-keyword">new</span> Toggle();<br>WindowA windowA = <span class="hljs-keyword">new</span> WindowA();<br>WindowB windowB = <span class="hljs-keyword">new</span> WindowB();<br><br><span class="hljs-comment">// 向Toggle组件注册两个窗口为观察者</span><br>toggle.Register(windowA);<br>toggle.Register(windowB);<br><br><span class="hljs-comment">// 设置Toggle组件的状态为Disabled</span><br>toggle.state = UIItemState.Disabled;<br><br><span class="hljs-comment">// 设置Toggle组件的状态为Enabled</span><br>toggle.state = UIItemState.Enabled;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了通过Toggle这个UI组件来实现对窗口的切换。当Toggle组件为Enabled状态时切换为窗口A，当状态为Disabled时则切换为窗口B，当窗口A或窗口B被聚焦时在控制台打印输出相关的信息。窗口A和B作为观察者，Toggle组件作为主题，Toggle组件的状态发生变化时则会自动遍历所有注册了的观察者，并调用它们所提供的接口方法，然后窗口A和B根据Toggle组件的状态完成各自预定的处理。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Composite Pattern（组合模式）</title>
      
      <link href="/posts/2026/01/08/707b54db08a7/"/>
      <url>/posts/2026/01/08/707b54db08a7/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>组合模式是一种结构型设计模式，用于将节点及节点容器看作统一的节点对象，使得调用者无需关注是单个节点还是一组节点，只需要通过接口方法直接调用即可。最直观的和最常见的例子就是文件系统，文件系统中的文件夹和文件都看作是文件系统节点，文件夹下面可以包括文件和文件夹，这种树形层次的文件结构就是对组合模式的一种应用。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>文件系统、菜单系统、GUI界面布局等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Component（组件）：</strong> 声明了组合中对象的接口，可以是一个抽象类或接口，其中定义了一些用于管理子对象的方法，如添加、删除、获取子对象等。</p><p><strong>Leaf（叶子）：</strong> 是组合中的叶子节点对象，它没有子对象。实现了组件接口，但是在叶子节点中，这些方法可能是空的实现或抛出异常。</p><p><strong>Composite（容器）：</strong> 是包含子对象的容器节点对象，它通常会实现组件接口的方法，并包含一个集合用于存储子对象。</p><p><strong>Client（客户端）：</strong> 通过组件接口与组合中的对象进行交互，不需要知道是处理叶子节点还是容器节点，从而可以统一处理整体和部分。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>统一接口：</strong> 组合模式的核心思想是将叶子节点和容器节点都视为组件，它们都实现了相同的接口，这样客户端可以一致地对待单个对象和对象的组合。</p></li><li><p><strong>递归组合：</strong> 容器节点内部包含了子对象，这些子对象可以是叶子节点，也可以是容器节点，从而形成了一个递归的结构。</p></li><li><p><strong>透明性：</strong> 在透明组合模式中，客户端不需要判断当前处理的是叶子还是容器，直接通过组件接口进行操作。在安全组合模式中，客户端需要进行类型检查来确定如何操作。</p></li><li><p><strong>简化客户端代码：</strong> 通过组合模式，客户端代码不再需要关心处理的是单个对象还是对象的组合，简化了客户端代码，提高了系统的灵活性和可维护性。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="文件系统节点：FileSystemNode-cs"><a href="#文件系统节点：FileSystemNode-cs" class="headerlink" title="文件系统节点：FileSystemNode.cs"></a>文件系统节点：FileSystemNode.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CompositePattern</span>;<br><br><span class="hljs-comment">// 文件系统节点</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FileSystemNode</span><br>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FileSystemNode</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-comment">// 显示，level代表文件系统节点所在层级，根节点为1，根节点的一级子节点则为2，依次类推</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> level</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 文件</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">File</span> : <span class="hljs-title">FileSystemNode</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">File</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> level</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;-&#x27;</span>, level) + name);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 文件夹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Directory</span> : <span class="hljs-title">FileSystemNode</span><br>&#123;<br>    <span class="hljs-keyword">private</span> List&lt;FileSystemNode&gt; fileSystemNodes; <span class="hljs-comment">// 文件系统节点集合</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Directory</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span><br>    &#123;<br>        fileSystemNodes = <span class="hljs-keyword">new</span> List&lt;FileSystemNode&gt;();<br>    &#125;<br><br>    <span class="hljs-comment">// 添加文件系统节点</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params">FileSystemNode fileSystemNode</span>)</span><br>    &#123;<br>        fileSystemNodes.Add(fileSystemNode);<br>    &#125;<br><br>    <span class="hljs-comment">// 移除文件系统节点</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Remove</span>(<span class="hljs-params">FileSystemNode fileSystemNode</span>)</span><br>    &#123;<br>        fileSystemNodes.Remove(fileSystemNode);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Show</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> level</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;-&#x27;</span>, level) + name);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; fileSystemNodes.Count; i++)<br>        &#123;<br>            fileSystemNodes[i].Show(level + <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 11.组合模式测试 **************</span><br><span class="hljs-comment">// 创建三个文件和两个文件夹</span><br>CompositePattern.File fileA = <span class="hljs-keyword">new</span> CompositePattern.File(<span class="hljs-string">&quot;文件A&quot;</span>);<br>CompositePattern.File fileB = <span class="hljs-keyword">new</span> CompositePattern.File(<span class="hljs-string">&quot;文件B&quot;</span>);<br>CompositePattern.File fileC = <span class="hljs-keyword">new</span> CompositePattern.File(<span class="hljs-string">&quot;文件C&quot;</span>);<br>CompositePattern.Directory directoryA = <span class="hljs-keyword">new</span> CompositePattern.Directory(<span class="hljs-string">&quot;文件夹A&quot;</span>);<br>CompositePattern.Directory directoryB = <span class="hljs-keyword">new</span> CompositePattern.Directory(<span class="hljs-string">&quot;文件夹B&quot;</span>);<br><br><span class="hljs-comment">// 文件夹B中包含文件A和文件C</span><br>directoryB.Add(fileA);<br>directoryB.Add(fileC);<br><br><span class="hljs-comment">// 文件夹A中包含文件B和文件夹B</span><br>directoryA.Add(fileB);<br>directoryA.Add(directoryB);<br><br><span class="hljs-comment">// 显示文件夹A及其目录下的所有子文件夹和子文件</span><br>directoryA.Show(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了文件系统中文件夹和文件的层次结构。文件夹和文件都继承自文件系统节点类，文件夹作为文件系统节点的容器。文件夹A下包含文件B和文件夹B，文件夹B下包含文件A和文件C。通过组合模式简化了调用逻辑，并提升了该文件系统的可扩展性，降低了维护成本，例如未来需要加入一种加密型文件夹，那么就可以直接让其继承文件系统节点类，而不需要去修改文件系统的源代码。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Flyweight Pattern（享元模式）</title>
      
      <link href="/posts/2026/01/08/4f84ae6db350/"/>
      <url>/posts/2026/01/08/4f84ae6db350/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>享元模式是一种结构型设计模式，用于通过共享对象来减少内存开销，适用于需要使用大量相似对象的情况。</p><p>享元模式有两个状态，分别是内部状态和外部状态，内部状态由获取指定享元的调用者共享，外部状态由调用者进行传递。例如对于字符”A”而言，无论外部有多少个调用者使用字符”A”，字符”A”的Unicode对于所有调用者而言都是固定一致的，而字符”A”的样式则由调用者来决定，那么字符”A”的Unicode就相当于其内部状态，字符”A”的样式则是外部状态，调用者通过字符”A”的Unicode获取字符”A”的对象，字符”A”提供一个可指定样式的绘制方法，在使用字符”A”时则可以传递不同的样式，通过享元模式就可以避免为每个调用者都创建一个字符”A”对象，从而减少内存开销。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>文本编辑器的字符存储、图形系统中的图元对象、数据库连接池、线程池、Web应用中的缓存管理等。</p><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">享元模式与对象池的对比</div><table align="center" border="1" cellpadding="1" cellspacing="1" style="width:600px">  <tbody>    <tr>      <th>特征</th>      <th>享元模式</th>      <th>对象池</th></tr>    <tr>      <td>        <strong>主要目标</strong></td>      <td>最小化相似对象的内存开销，通过共享内部状态。</td>      <td>减少创建和销毁对象的开销，通过对象的重复利用。</td></tr>    <tr>      <td>        <strong>对象状态</strong></td>      <td>分为内部状态和外部状态。内部状态可被共享，外部状态需要传递。</td>      <td>关注对象的整体状态，重点是对象的创建和销毁开销。</td></tr>    <tr>      <td>        <strong>内存占用</strong></td>      <td>减小对象实例数量，通过共享内部状态减小内存占用。</td>      <td>通过重复使用对象减小内存占用，不一定共享内部状态。</td></tr>    <tr>      <td>        <strong>创建和销毁开销</strong></td>      <td>重点不在创建和销毁开销，而在共享内部状态。</td>      <td>重点在于减少创建和销毁对象的开销。</td></tr>    <tr>      <td>        <strong>使用场景</strong></td>      <td>适用于大量相似对象，且内部状态占用大量内存的情况。</td>      <td>适用于对象创建和销毁开销较大的情况，例如数据库连接、线程等。</td></tr>    <tr>      <td>        <strong>实例管理</strong></td>      <td>通常通过工厂模式创建和管理享元对象。</td>      <td>通常通过池管理已创建的对象实例。</td></tr>    <tr>      <td>        <strong>操作和状态传递</strong></td>      <td>操作需要传递外部状态，确保每个对象的特定状态都能正确反映在操作中。</td>      <td>操作和状态都在对象池中管理，对象之间通常不需要传递外部状态。</td></tr>  </tbody></table><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Flyweight（享元接口）：</strong> 定义共享对象的接口，包含操作方法。</p><p><strong>ConcreteFlyweight（具体享元类）：</strong> 实现享元接口，并包含内部状态。具体享元类的实例可以被共享。</p><p><strong>UnsharedConcreteFlyweight（非共享具体享元类）：</strong> 与共享对象协作，但不能被共享的具体享元类，通常是因为它包含了不可共享的外部状态。</p><p><strong>FlyweightFactory（享元工厂）：</strong> 负责创建和管理享元对象，确保共享对象的正确使用。在请求享元对象时，工厂检查是否已经存在该对象，如果存在则返回已有的对象，否则创建一个新对象。</p><p><strong>Client（客户端）：</strong> 使用享元模式的客户端，维护或传递外部状态给享元对象。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>内部状态和外部状态：</strong> 将对象的状态分为内部状态和外部状态。内部状态是可以被共享的，而外部状态是对象在使用过程中会改变的状态，需要由客户端来维护和传递。</p></li><li><p><strong>享元工厂：</strong> 工厂负责管理享元对象，维护一个享元池（集合）。当客户端请求一个享元对象时，工厂检查池中是否已存在该对象的实例，如果存在则返回已有的对象，否则创建一个新的对象并加入池中。</p></li><li><p><strong>享元接口和具体享元类：</strong> 定义享元接口，包含操作方法。具体享元类实现了享元接口，包含内部状态。具体享元类的实例是可以被共享的对象。</p></li><li><p><strong>客户端使用享元对象：</strong> 客户端在使用享元模式时，通过工厂获取享元对象，并传递外部状态。客户端负责维护外部状态，而内部状态由享元对象共享。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="图形：Shape-cs"><a href="#图形：Shape-cs" class="headerlink" title="图形：Shape.cs"></a>图形：Shape.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FlyweightPattern</span>;<br><br><span class="hljs-comment">// 图形类型</span><br><span class="hljs-built_in">enum</span> ShapeType<br>&#123;<br>    Circle, Rectangle<br>&#125;<br><br><span class="hljs-comment">// 图形</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Shape</span><br>&#123;<br>    <span class="hljs-keyword">protected</span> ShapeType shapeType; <span class="hljs-comment">// 图形的类型</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Shape</span>(<span class="hljs-params">ShapeType shapeType</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.shapeType = shapeType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Draw</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> color</span>)</span>; <span class="hljs-comment">// 根据指定颜色进行绘制</span><br>&#125;<br><br><span class="hljs-comment">// 圆</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Circle</span> : <span class="hljs-title">Shape</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Circle</span>(<span class="hljs-params">ShapeType shapeType</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">shapeType</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Draw</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> color</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(color)) Console.WriteLine(<span class="hljs-string">$&quot;Circle:Drawing a circle.(HashCode:<span class="hljs-subst">&#123;GetHashCode()&#125;</span>)&quot;</span>);<br>        <span class="hljs-keyword">else</span> Console.WriteLine(<span class="hljs-string">$&quot;Circle:Drawing a circle with <span class="hljs-subst">&#123;color&#125;</span> color.(HashCode:<span class="hljs-subst">&#123;GetHashCode()&#125;</span>)&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 矩形</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Rectangle</span> : <span class="hljs-title">Shape</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Rectangle</span>(<span class="hljs-params">ShapeType shapeType</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">shapeType</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Draw</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> color</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(color)) Console.WriteLine(<span class="hljs-string">$&quot;Rectangle:Drawing a rectangle.(HashCode:<span class="hljs-subst">&#123;GetHashCode()&#125;</span>)&quot;</span>);<br>        <span class="hljs-keyword">else</span> Console.WriteLine(<span class="hljs-string">$&quot;Rectangle:Drawing a rectangle with <span class="hljs-subst">&#123;color&#125;</span> color.(HashCode:<span class="hljs-subst">&#123;GetHashCode()&#125;</span>)&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="图形管理器：ShapeManager-cs"><a href="#图形管理器：ShapeManager-cs" class="headerlink" title="图形管理器：ShapeManager.cs"></a>图形管理器：ShapeManager.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">FlyweightPattern</span>;<br><br><span class="hljs-comment">// 图形管理器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">ShapeManager</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Dictionary&lt;ShapeType, Shape&gt; shapes; <span class="hljs-comment">// 图形集合</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ShapeManager</span>()</span><br>    &#123;<br>        shapes = <span class="hljs-keyword">new</span> Dictionary&lt;ShapeType, Shape&gt;();<br>    &#125;<br><br>    <span class="hljs-comment">// 获取指定类型的图形</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Shape <span class="hljs-title">GetShape</span>(<span class="hljs-params">ShapeType shapeType</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!shapes.ContainsKey(shapeType))<br>        &#123;<br>            <span class="hljs-keyword">switch</span> (shapeType)<br>            &#123;<br>                <span class="hljs-keyword">case</span> ShapeType.Circle:<br>                    shapes[shapeType] = <span class="hljs-keyword">new</span> Circle(shapeType);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> ShapeType.Rectangle:<br>                    shapes[shapeType] = <span class="hljs-keyword">new</span> Rectangle(shapeType);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-literal">default</span>:<br>                    Console.WriteLine(<span class="hljs-string">&quot;Warning:The type of shape doesn&#x27;t exist.&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> shapes[shapeType];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 12.享元模式测试 **************</span><br><span class="hljs-keyword">using</span> FlyweightPattern;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> disable</span><br><br><span class="hljs-comment">// 创建图形管理器实例并获取圆形和矩形</span><br>ShapeManager shapeManager = <span class="hljs-keyword">new</span> ShapeManager();<br>Circle circle = shapeManager.GetShape(ShapeType.Circle) <span class="hljs-keyword">as</span> Circle;<br>Rectangle rectangle = shapeManager.GetShape(ShapeType.Rectangle) <span class="hljs-keyword">as</span> Rectangle;<br><br><span class="hljs-comment">// 绘制红色的圆形和蓝色的矩形</span><br>circle.Draw(<span class="hljs-string">&quot;red&quot;</span>);<br>rectangle.Draw(<span class="hljs-string">&quot;blue&quot;</span>);<br><br><span class="hljs-comment">// 再次获取一个圆形并绘制成蓝色的圆形</span><br>Circle otherCircle = shapeManager.GetShape(ShapeType.Circle) <span class="hljs-keyword">as</span> Circle;<br>otherCircle.Draw(<span class="hljs-string">&quot;blue&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码模拟了对不同颜色的圆形和矩形的绘制。圆形和矩形都继承自图形类，图形类中的图形类型为享元模式中的内部状态，图形类中Draw方法的颜色参数则为外部状态。调用者通过图形管理器的GetShape方法和图形类型参数来获取图形，然后通过调用图形的Draw方法和传递颜色参数来决定绘制什么颜色的图形。测试代码中的circle和otherCircle实际上为同一个实例，通过它们输出的HashCode即可知道。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Proxy Pattern（代理模式）</title>
      
      <link href="/posts/2026/01/08/1fc79201d884/"/>
      <url>/posts/2026/01/08/1fc79201d884/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>代理模式是一种结构型设计模式，它通常用于控制对对象的访问，可以为对象的访问添加一些额外的操作。例如当我们需要测试对象执行某个方法所耗费的时间时，那么就可以通过代理模式在该方法的执行前后记录一次时间并计算时间间隔。通过代理模式可以对原有对象进行访问控制、延迟加载和简化接口。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>远程代理、虚拟代理、保护代理、缓存代理、日志记录、图片加载优化、数据库连接池、权限管理和动态代理等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>抽象主题（Subject）：</strong> 定义了真实主题和代理主题的共同接口，客户端通过这个接口访问真实主题或代理主题。</p><p><strong>真实主题（Real Subject）：</strong> 实现了抽象主题接口，是代理模式中的实际对象，客户端最终要使用的对象。</p><p><strong>代理主题（Proxy）：</strong> 包含一个引用（指针或引用对象）指向真实主题。实现了抽象主题接口，与真实主题实现相同的接口，使得客户端无需关心真实主题和代理主题的区别。在代理主题中可以控制对真实主题的访问，可以在访问前或访问后执行一些额外的操作，如权限控制、延迟加载、日志记录等。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>客户端通过代理访问真实主题：</strong> 客户端通常通过抽象主题的接口来访问真实主题，不直接操作真实主题。</p></li><li><p><strong>代理对象控制访问：</strong> 当客户端通过代理访问真实主题时，代理对象可以在访问前后执行一些操作，例如权限验证、日志记录等。</p></li><li><p><strong>延迟加载（虚拟代理）：</strong> 如果使用了虚拟代理，代理对象在需要时才创建和初始化真实对象，以减少资源消耗。</p></li><li><p><strong>其他附加操作：</strong> 代理对象还可以实现一些额外的功能，比如缓存、计算结果的缓存、异常处理等。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="调试：Debug-cs"><a href="#调试：Debug-cs" class="headerlink" title="调试：Debug.cs"></a>调试：Debug.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">ProxyPattern</span>;<br><br><span class="hljs-comment">// 调试接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IDebug</span><br>&#123;<br>    <span class="hljs-comment">// 控制台输出</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> content</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 调试</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Debug</span> : <span class="hljs-title">IDebug</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> content</span>)</span><br>    &#123;<br>        Console.WriteLine(content);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 调试代理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">DebugProxy</span> : <span class="hljs-title">IDebug</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Debug debug;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DebugProxy</span>()</span><br>    &#123;<br>        debug = <span class="hljs-keyword">new</span> Debug();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> content</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;---------------- Begin ----------------&quot;</span>);<br>        debug.Log(content);<br>        Console.WriteLine(<span class="hljs-string">&quot;----------------  End  ----------------&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 13.代理模式测试 **************</span><br><span class="hljs-keyword">using</span> ProxyPattern;<br><br>DebugProxy debug = <span class="hljs-keyword">new</span> DebugProxy();<br>debug.Log(<span class="hljs-string">&quot;This is a paragraph.&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码实现了为每次控制台输出的内容添加前后分隔线的功能。通过代理模式可以避免修改代理对象的源码，从而实现对对象访问的控制。该示例我们完全可以直接在Debug类的Log方法中添加前后分隔线，但是如果现在Debug类的业务逻辑繁多，结构复杂，直接修改源代码会增加风险从而增加维护成本，通过代理模式则可以在不修改源码的基础上来对Log方法进行控制和扩展。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Iterator Pattern（迭代器模式）</title>
      
      <link href="/posts/2026/01/08/1f20cdb9428f/"/>
      <url>/posts/2026/01/08/1f20cdb9428f/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>迭代器模式是一种行为型设计模式，它为集合对象提供了简便的遍历接口，隐藏了具体的遍历逻辑，除此之外它能够为任何可以获取统一迭代器的集合提供一致的遍历方法，增加了代码的复用性，这对于调用者而言，可以采用同样的方式遍历不同类型的集合，简化了调用逻辑。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>遍历集合对象、封装不同数据结构的遍历、数据库查询结果集、文件系统遍历、菜单导航、文档解析、线程池管理。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>迭代器接口（Iterator）：</strong> 定义了遍历元素的接口，包括 next() 方法用于获取下一个元素，以及 hasNext() 方法用于检查是否还有更多元素。</p><p><strong>具体迭代器（Concrete Iterator）：</strong> 实现迭代器接口，负责实际遍历集合并跟踪当前位置。</p><p><strong>聚合接口（Aggregate）：</strong> 定义了创建迭代器的接口，通常包括一个或多个方法返回相应的迭代器。</p><p><strong>具体聚合对象（Concrete Aggregate）：</strong> 实现聚合接口，返回适当的具体迭代器。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>客户端（Client）：</strong> 客户端通过聚合接口获取迭代器对象，然后使用迭代器对象遍历集合中的元素。</p></li><li><p><strong>聚合对象（Aggregate）：</strong> 聚合对象负责创建迭代器，并通过其接口返回具体的迭代器对象。</p></li><li><p><strong>迭代器接口和具体迭代器（Iterator和Concrete Iterator）：</strong> 迭代器接口定义了遍历元素的方法，具体迭代器实现了这些方法，负责实际的遍历逻辑和状态管理。迭代器通过追踪当前位置来确保逐个访问集合元素。</p></li><li><p><strong>具体聚合对象（Concrete Aggregate）：</strong> 具体聚合对象实现聚合接口，其中的方法返回相应的具体迭代器对象。这个具体聚合对象可以是实际的集合，如列表或数组。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="迭代器：Iterator-cs"><a href="#迭代器：Iterator-cs" class="headerlink" title="迭代器：Iterator.cs"></a>迭代器：Iterator.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">IteratorPattern</span>;<br><br><span class="hljs-comment">// 迭代器接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IIterator</span><br>&#123;<br>    <span class="hljs-comment">// 是否存在下一个元素</span><br>    <span class="hljs-function"><span class="hljs-built_in">bool</span> <span class="hljs-title">HasNext</span>()</span>;<br>    <span class="hljs-comment">// 下一个元素</span><br>    <span class="hljs-built_in">object</span> next &#123; <span class="hljs-keyword">get</span>; &#125;<br>&#125;<br><br><span class="hljs-comment">// 可迭代接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">Iterable</span><br>&#123;<br>    <span class="hljs-comment">// 获取迭代器</span><br>    <span class="hljs-function">IIterator <span class="hljs-title">GetIterator</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="集合：Collection-cs"><a href="#集合：Collection-cs" class="headerlink" title="集合：Collection.cs"></a>集合：Collection.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">IteratorPattern</span>;<br><br><span class="hljs-comment">// 集合元素</span><br><span class="hljs-keyword">struct</span> CollectionItem<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>; <span class="hljs-comment">// 集合元素的值</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CollectionItem</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">value</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;value:&quot;</span> + <span class="hljs-keyword">value</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 集合迭代器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">CollectionIterator</span> : <span class="hljs-title">IIterator</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span> next<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> collectionItems[index++];<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (IndexOutOfRangeException)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> CollectionItem[] collectionItems; <span class="hljs-comment">// 集合元素合集</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> index; <span class="hljs-comment">// 当前所访问元素的索引</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CollectionIterator</span>(<span class="hljs-params">CollectionItem[] collectionItems</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.collectionItems = collectionItems;<br>        index = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">HasNext</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> index &lt; collectionItems.Length;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 集合</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Collection</span> : <span class="hljs-title">Iterable</span><br>&#123;<br>    <span class="hljs-keyword">private</span> CollectionItem[] collectionItems; <span class="hljs-comment">// 集合元素合集</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Collection</span>(<span class="hljs-params">CollectionItem[] collectionItems</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (collectionItems == <span class="hljs-literal">null</span> || collectionItems.Length == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">this</span>.collectionItems = Array.Empty&lt;CollectionItem&gt;();<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">this</span>.collectionItems = <span class="hljs-keyword">new</span> CollectionItem[collectionItems.Length];<br>            Array.Copy(collectionItems, <span class="hljs-keyword">this</span>.collectionItems, collectionItems.Length);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IIterator <span class="hljs-title">GetIterator</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CollectionIterator(collectionItems);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 14.迭代器模式测试 **************</span><br><span class="hljs-keyword">using</span> IteratorPattern;<br><br><span class="hljs-comment">// 定义集合元素合集并传递给集合实例，通过集合实例获取迭代器</span><br>CollectionItem[] collectionItems = &#123; <span class="hljs-keyword">new</span> CollectionItem(<span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> CollectionItem(<span class="hljs-number">2</span>), <span class="hljs-keyword">new</span> CollectionItem(<span class="hljs-number">3</span>) &#125;;<br>Collection collection = <span class="hljs-keyword">new</span> Collection(collectionItems);<br>IIterator iterator = collection.GetIterator();<br><br><span class="hljs-comment">// 通过迭代器遍历集合</span><br><span class="hljs-keyword">while</span> (iterator.HasNext())<br>&#123;<br>    Console.WriteLine(iterator.next);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码演示了对实现了Iterable接口的集合通过迭代器进行遍历。集合实现Iterable接口，提供获取迭代器的方法，集合迭代器实现了IIterator接口，提供了统一的遍历方法。调用者通过集合获取集合迭代器，再通过集合迭代器遍历集合中的元素。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Visitor Pattern（访问者模式、访客模式）</title>
      
      <link href="/posts/2026/01/08/97d5092edb37/"/>
      <url>/posts/2026/01/08/97d5092edb37/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>访问者模式是一种行为型设计模式，用于对结构稳定的对象进行功能扩展，通常对象通过向外提供固定逻辑的接口方法来完成内外交互，但是这种固定逻辑可能无法适应多变的需求，尤其是对于不同的调用者需要不同的交互逻辑的情况时，我们不可能为每个访问对象都编写一个单独的方法来交互，那么这种情况就可以考虑采用访问者模式。访问者模式将具体的交互逻辑交给访客，访客们实现统一的接口，被访问者则通过该接口方法进行统一的调用。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>结构稳定的对象的扩展、不同对象的不同交互逻辑、避免类膨胀和对象结构的复杂处理等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>访问者（Visitor）：</strong> 定义了对每个元素访问的操作，这样可以通过访问者在不改变元素类的前提下定义新的操作。</p><p><strong>具体访问者（ConcreteVisitor）：</strong> 实现了访问者接口，提供了对元素的具体操作。</p><p><strong>元素（Element）：</strong> 定义了一个接受访问者的接口，通常包含一个 accept 方法，该方法接受访问者作为参数。</p><p><strong>具体元素（ConcreteElement）：</strong> 实现了元素接口，实现了 accept 方法，通常还包含自己的业务逻辑。</p><p><strong>对象结构（Object Structure）：</strong> 包含了一组元素，通常提供一个接受访问者的方法，允许访问者访问其中的元素。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p>定义访问者接口，包含对每个具体元素的访问方法。</p></li><li><p>创建具体访问者类，实现访问者接口，定义具体的操作逻辑。</p></li><li><p>定义元素接口，包含 accept 方法。</p></li><li><p>创建具体元素类，实现元素接口，实现 accept 方法，并将具体访问者传递给访问者的访问方法。</p></li><li><p>创建对象结构类，用于存储和管理元素。</p></li><li><p>客户端使用访问者模式，创建具体元素和具体访问者对象，并将具体访问者对象传递给对象结构进行遍历。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="房屋：House-cs"><a href="#房屋：House-cs" class="headerlink" title="房屋：House.cs"></a>房屋：House.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">VisitorPattern</span>;<br><br><span class="hljs-comment">// 房屋结构</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HousePart</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 房屋结构名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HousePart</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Introduce</span>()</span>; <span class="hljs-comment">// 介绍房屋结构</span><br>&#125;<br><br><span class="hljs-comment">// 房屋</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">House</span><br>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 房屋名称</span><br>    <span class="hljs-keyword">protected</span> HousePart kitchen; <span class="hljs-comment">// 厨房</span><br>    <span class="hljs-keyword">protected</span> HousePart toilet; <span class="hljs-comment">// 厕所</span><br>    <span class="hljs-keyword">protected</span> HousePart bedroom; <span class="hljs-comment">// 卧室</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">House</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, HousePart kitchen, HousePart toilet, HousePart bedroom</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.kitchen = kitchen;<br>        <span class="hljs-keyword">this</span>.toilet = toilet;<br>        <span class="hljs-keyword">this</span>.bedroom = bedroom;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WelcomeAndIntroduce</span>(<span class="hljs-params">IVisitor visitor</span>)</span>; <span class="hljs-comment">// 欢迎访客并介绍房屋结构</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> IVisitor <span class="hljs-title">Accept</span>(<span class="hljs-params">IVisitor visitor</span>)</span>; <span class="hljs-comment">// 接收访客的访问</span><br>&#125;<br><br><span class="hljs-comment">// 公寓 </span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Apartment</span> : <span class="hljs-title">House</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Apartment</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, HousePart kitchen, HousePart toilet, HousePart bedroom</span>) :</span><br><span class="hljs-function">    <span class="hljs-title">base</span>(<span class="hljs-params">name, kitchen, toilet, bedroom</span>)</span><br>    &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> IVisitor <span class="hljs-title">Accept</span>(<span class="hljs-params">IVisitor visitor</span>)</span><br>    &#123;<br>        WelcomeAndIntroduce(visitor);<br>        visitor.Visit();<br>        <span class="hljs-keyword">return</span> visitor;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WelcomeAndIntroduce</span>(<span class="hljs-params">IVisitor visitor</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Hello <span class="hljs-subst">&#123;visitor.name&#125;</span>, welcome to my <span class="hljs-subst">&#123;name&#125;</span>.&quot;</span>);<br>        kitchen.Introduce();<br>        bedroom.Introduce();<br>        toilet.Introduce();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 别墅</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Villa</span> : <span class="hljs-title">House</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Villa</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, HousePart kitchen, HousePart toilet, HousePart bedroom</span>) :</span><br><span class="hljs-function">    <span class="hljs-title">base</span>(<span class="hljs-params">name, kitchen, toilet, bedroom</span>)</span><br>    &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> IVisitor <span class="hljs-title">Accept</span>(<span class="hljs-params">IVisitor visitor</span>)</span><br>    &#123;<br>        WelcomeAndIntroduce(visitor);<br>        visitor.Visit();<br>        <span class="hljs-keyword">return</span> visitor;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WelcomeAndIntroduce</span>(<span class="hljs-params">IVisitor visitor</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Hello <span class="hljs-subst">&#123;visitor.name&#125;</span>, welcome to my <span class="hljs-subst">&#123;name&#125;</span>.&quot;</span>);<br>        kitchen.Introduce();<br>        bedroom.Introduce();<br>        toilet.Introduce();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 厨房</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Kitchen</span> : <span class="hljs-title">HousePart</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Kitchen</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span> &#123; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Introduce</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Welcome to <span class="hljs-subst">&#123;name&#125;</span>. This is a place for cooking.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 厕所</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Toilet</span> : <span class="hljs-title">HousePart</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Toilet</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span> &#123; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Introduce</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Welcome to <span class="hljs-subst">&#123;name&#125;</span>. This is a place to return to nature.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 卧室</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Bedroom</span> : <span class="hljs-title">HousePart</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Bedroom</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span> &#123; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Introduce</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Welcome to <span class="hljs-subst">&#123;name&#125;</span>. This is a place to sleep.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="访客：Visitor-cs"><a href="#访客：Visitor-cs" class="headerlink" title="访客：Visitor.cs"></a>访客：Visitor.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">VisitorPattern</span>;<br><br><span class="hljs-comment">// 访客</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IVisitor</span><br>&#123;<br>    <span class="hljs-comment">// 访客名称</span><br>    <span class="hljs-built_in">string</span> name &#123; <span class="hljs-keyword">get</span>; &#125;<br>    <span class="hljs-comment">// 看看厨房</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">VisitKitchen</span>()</span>;<br>    <span class="hljs-comment">// 看看厕所</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">VisitToilet</span>()</span>;<br>    <span class="hljs-comment">// 看看卧室</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">VisitBedroom</span>()</span>;<br>    <span class="hljs-comment">// 到处看看</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Visit</span>()</span>;<br>    <span class="hljs-comment">// 看完了，该走了</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">VisitEnd</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 儿童</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> : <span class="hljs-title">IVisitor</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name =&gt; _name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Child</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span><br>    &#123;<br>        _name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Visit</span>()</span><br>    &#123;<br>        VisitBedroom();<br>        VisitKitchen();<br>        VisitToilet();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitBedroom</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;The child <span class="hljs-subst">&#123;_name&#125;</span> plays in the bedroom.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitEnd</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;-----------------------------------&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitKitchen</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;The child <span class="hljs-subst">&#123;_name&#125;</span> feels hungry, so he wants to find some foods to eat in the kitchen.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitToilet</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;Beacuse of drinking much juice, the child <span class="hljs-subst">&#123;_name&#125;</span> wants to return to nature.&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// 女士</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Woman</span> : <span class="hljs-title">IVisitor</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name =&gt; _name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Woman</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span><br>    &#123;<br>        _name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Visit</span>()</span><br>    &#123;<br>        VisitToilet();<br>        VisitBedroom();<br>        VisitKitchen();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitEnd</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;-----------------------------------&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitBedroom</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;The woman <span class="hljs-subst">&#123;_name&#125;</span> feels sleepy so that she is fast asleep in the bedroom.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitKitchen</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;The woman <span class="hljs-subst">&#123;_name&#125;</span> feels a little hungry after a sleep and she find some cookies in the refrigerator of kitchen luckily.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VisitToilet</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;The woman <span class="hljs-subst">&#123;_name&#125;</span> wants to return to nature beacuse of drinking much wine last night.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 15.访问者模式测试 **************</span><br><span class="hljs-keyword">using</span> VisitorPattern;<br><br>Kitchen kitchen = <span class="hljs-keyword">new</span> Kitchen(<span class="hljs-string">&quot;kitchen&quot;</span>);<br>Toilet toilet = <span class="hljs-keyword">new</span> Toilet(<span class="hljs-string">&quot;toilet&quot;</span>);<br>Bedroom bedroom = <span class="hljs-keyword">new</span> Bedroom(<span class="hljs-string">&quot;bedroom&quot;</span>);<br>Apartment apartment = <span class="hljs-keyword">new</span> Apartment(<span class="hljs-string">&quot;apartment&quot;</span>, kitchen, toilet, bedroom);<br>Villa villa = <span class="hljs-keyword">new</span> Villa(<span class="hljs-string">&quot;villa&quot;</span>, kitchen, toilet, bedroom);<br><br>Child child = <span class="hljs-keyword">new</span> Child(<span class="hljs-string">&quot;Bob&quot;</span>);<br>Woman woman = <span class="hljs-keyword">new</span> Woman(<span class="hljs-string">&quot;Amy&quot;</span>);<br><br><span class="hljs-comment">// 孩子和女士访问公寓</span><br>apartment.Accept(child).VisitEnd();<br>apartment.Accept(woman).VisitEnd();<br><br><span class="hljs-comment">// 孩子和女士访问别墅</span><br>villa.Accept(child).VisitEnd();<br>villa.Accept(woman).VisitEnd();<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码模拟了不同类型的访客来游览不同类型的房屋。</p><p>每个房屋都需要继承House基类，其中WelcomeAndIntroduce方法用于介绍这是什么类型的房屋以及房屋中的各个房间用来做什么，Accept方法用于接待访客。</p><p>房屋的结构一旦确定就不会再进行改变了，如果我们不采用访问者模式，那么接待不同的访客我们需要通过修改或添加房屋中的接待方法，这就违背了开闭原则。我们把接待方法改为访问方法，我们规定每个访客都需要一个Visit方法，以及与房屋结构相适应的VisitKitchen、VisitToilet、VisitBedroom等方法。</p><p>对房屋而言只需要直接调用参观的访客的Visit方法即可，毕竟访客要怎么参观是访客要做的事情，我们交给访客自己去定义就行了，房屋只需要知道访客是否要参观即可。有一个问题就是，为什么我这里需要添加一个Visit方法，原则上只需要VisitKitchen、VisitToilet、VisitBedroom这三个方法就能够达到我们的目的了，这是因为我考虑到访客他自己的参观顺序，这个参观顺序也是访客自己决定的，作为房屋是不能够去限定访客的参观顺序的，所以添加了Visit方法。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Builder Pattern（建造者模式、构建器模式）</title>
      
      <link href="/posts/2026/01/08/f257e42b7fd6/"/>
      <url>/posts/2026/01/08/f257e42b7fd6/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>建造者模式是一种创建型设计模式，用于将对象的构建和其它行为逻辑进行分离，尤其是对于构建过程复杂的对象而言，建造者模式能帮助降低代码的复杂性。建造者模式还用于简化多参数对象的构建，可以人为对参数进行分组从而实现分步构建，根据实际需求构建具备不同初始状态的对象。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>复杂对象或配置对象的构建、表示与构建独立的对象、多参数对象以及不同初始状态的对象等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>产品（Product）：</strong> 表示被构建的复杂对象。在构建器模式中，产品是由多个部分组成的对象。</p><p><strong>抽象构建器（Builder）：</strong> 定义了构建产品的抽象接口，包括构建各个部分的方法。它通常是一个接口或者抽象类。</p><p><strong>具体构建器（Concrete Builder）：</strong> 实现了抽象构建器接口，负责构建产品的具体部分。每个具体构建器都有自己的实现方式，根据需求构建不同的表示。</p><p><strong>指导者（Director）：</strong> 负责调用具体构建器，按照一定的构建顺序来构造产品。指导者并不知道具体构建的细节，只知道调用构建器的接口。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p>**<strong>客户端创建指导者对象：</strong> 客户端创建一个指导者对象，并传入一个具体构建器对象。</p></li><li><p>**<strong>指导者调用构建器的方法：</strong> 指导者按照一定的构建顺序调用具体构建器的方法，每个方法负责构建产品的一个部分。</p></li><li><p>**<strong>构建器构建产品的各个部分：</strong> 具体构建器实现了构建产品的各个部分的方法，根据需求进行构建。</p></li><li><p>**<strong>指导者获取最终产品：</strong> 完成构建过程后，指导者通过具体构建器的方法获取构建好的产品。</p></li><li><p>**<strong>客户端获取最终产品：</strong> 客户端通过指导者获取构建好的产品，而不需要了解构建的具体细节。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="角色：Player-cs"><a href="#角色：Player-cs" class="headerlink" title="角色：Player.cs"></a>角色：Player.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BuilderPattern</span>;<br><br><span class="hljs-comment">// 角色</span><br><span class="hljs-keyword">struct</span> Player<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> hair; <span class="hljs-comment">// 头发</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> eyes; <span class="hljs-comment">// 眼睛</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> nose; <span class="hljs-comment">// 鼻子</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> ears; <span class="hljs-comment">// 耳朵</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mouth; <span class="hljs-comment">// 嘴巴</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> cloth; <span class="hljs-comment">// 衣服</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> pants; <span class="hljs-comment">// 裤子</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> shoes; <span class="hljs-comment">// 鞋子</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[Hair:<span class="hljs-subst">&#123;hair&#125;</span>,Eyes:<span class="hljs-subst">&#123;eyes&#125;</span>,Nose:<span class="hljs-subst">&#123;nose&#125;</span>,Ears:<span class="hljs-subst">&#123;ears&#125;</span>,Mouth:<span class="hljs-subst">&#123;mouth&#125;</span>,Cloth:<span class="hljs-subst">&#123;cloth&#125;</span>,Pants:<span class="hljs-subst">&#123;pants&#125;</span>,Shoes:<span class="hljs-subst">&#123;shoes&#125;</span>]&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="角色构建器：PlayerBuilder-cs"><a href="#角色构建器：PlayerBuilder-cs" class="headerlink" title="角色构建器：PlayerBuilder.cs"></a>角色构建器：PlayerBuilder.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BuilderPattern</span>;<br><br><span class="hljs-comment">// 角色构建器</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IPlayerBuilder</span><br>&#123;<br>    <span class="hljs-comment">// 五官设置</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetFacialFeatures</span>()</span>;<br>    <span class="hljs-comment">// 穿着设置</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetClothing</span>()</span>;<br>    <span class="hljs-comment">// 构建</span><br>    <span class="hljs-function">Player <span class="hljs-title">Build</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 男性角色构建器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">MalePlayerBuilder</span> : <span class="hljs-title">IPlayerBuilder</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Player player;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MalePlayerBuilder</span>()</span><br>    &#123;<br>        player = <span class="hljs-keyword">new</span> Player();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetFacialFeatures</span>()</span><br>    &#123;<br>        player.hair = <span class="hljs-string">&quot;male hair&quot;</span>;<br>        player.eyes = <span class="hljs-string">&quot;male eyes&quot;</span>;<br>        player.nose = <span class="hljs-string">&quot;male nose&quot;</span>;<br>        player.ears = <span class="hljs-string">&quot;male ears&quot;</span>;<br>        player.mouth = <span class="hljs-string">&quot;male mouth&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetClothing</span>()</span><br>    &#123;<br>        player.cloth = <span class="hljs-string">&quot;male cloth&quot;</span>;<br>        player.pants = <span class="hljs-string">&quot;male pants&quot;</span>;<br>        player.shoes = <span class="hljs-string">&quot;male shoes&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Player <span class="hljs-title">Build</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> player;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 女性角色构建器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">FemalePlayerBuilder</span> : <span class="hljs-title">IPlayerBuilder</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Player player;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FemalePlayerBuilder</span>()</span><br>    &#123;<br>        player = <span class="hljs-keyword">new</span> Player();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetFacialFeatures</span>()</span><br>    &#123;<br>        player.hair = <span class="hljs-string">&quot;female hair&quot;</span>;<br>        player.eyes = <span class="hljs-string">&quot;female eyes&quot;</span>;<br>        player.nose = <span class="hljs-string">&quot;female nose&quot;</span>;<br>        player.ears = <span class="hljs-string">&quot;female ears&quot;</span>;<br>        player.mouth = <span class="hljs-string">&quot;female mouth&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetClothing</span>()</span><br>    &#123;<br>        player.cloth = <span class="hljs-string">&quot;female cloth&quot;</span>;<br>        player.pants = <span class="hljs-string">&quot;female pants&quot;</span>;<br>        player.shoes = <span class="hljs-string">&quot;female shoes&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Player <span class="hljs-title">Build</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> player;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="角色构建器引导者：Director-cs"><a href="#角色构建器引导者：Director-cs" class="headerlink" title="角色构建器引导者：Director.cs"></a>角色构建器引导者：Director.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BuilderPattern</span>;<br><br><span class="hljs-comment">// 角色构建器指导者</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerBuilderDirector</span><br>&#123;<br>    <span class="hljs-keyword">private</span> IPlayerBuilder playerBuilder; <span class="hljs-comment">// 角色构建器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PlayerBuilderDirector</span>(<span class="hljs-params">IPlayerBuilder playerBuilder</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.playerBuilder = playerBuilder;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取角色</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Player <span class="hljs-title">GetPlayer</span>()</span><br>    &#123;<br>        playerBuilder.SetFacialFeatures();<br>        playerBuilder.SetClothing();<br>        <span class="hljs-keyword">return</span> playerBuilder.Build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 16.建造者模式测试 **************</span><br><span class="hljs-keyword">using</span> BuilderPattern;<br><br>MalePlayerBuilder maleBuilder = <span class="hljs-keyword">new</span> MalePlayerBuilder();<br>FemalePlayerBuilder femaleBuilder = <span class="hljs-keyword">new</span> FemalePlayerBuilder();<br><br><span class="hljs-comment">// 分别构建一个男性角色和女性角色</span><br>PlayerBuilderDirector maleDirector = <span class="hljs-keyword">new</span> PlayerBuilderDirector(maleBuilder);<br>Player male = maleDirector.GetPlayer();<br>PlayerBuilderDirector femaleDirector = <span class="hljs-keyword">new</span> PlayerBuilderDirector(femaleBuilder);<br>Player female = femaleDirector.GetPlayer();<br><br><span class="hljs-comment">// 输出两个角色的信息</span><br>Console.WriteLine(male);<br>Console.WriteLine(female);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了在游戏中创建不同性别的默认外观的角色。涉及不同性别的角色的五官和穿着不同，而五官和穿着涉及的字段又比较多，所以可以采用建造者模式来管理角色的构建。男性和女性角色构建器分别实现角色构建器接口，并对与五官和穿着相关的字段进行初始化。再由角色构建器引导者控制构建器的调用，保证顺利构建出角色。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Adapter Pattern（适配器模式）</title>
      
      <link href="/posts/2026/01/08/9e8d6ce0bb83/"/>
      <url>/posts/2026/01/08/9e8d6ce0bb83/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>适配器模式是一种结构型设计模式，用于将不兼容调用者的接口适配为兼容的接口，通过适配器则可以实现调用者与不兼容系统的间接调用。举一个生活中常见的例子，用充电器给手机充电，而不是直接连一根电线直接充，家用电源220V，能带动冰箱和空调这些大功率电器，而手机明显不需要那么大的功率，而且不可能在手机上装个插头直接连接家用电源，所以通过电源适配器，既能保证稳定和安全的供电，也更加人性化。</p><p>抽象到代码中，调用者为了简化调用逻辑可能要求统一的接口，那么如果系统中需要被调用的功能模块恰好没有实现调用者要求的这种接口，同时系统复杂难以直接修改源码，那么这个时候就可以通过适配器模式来完成调用者与系统的适配。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>新旧系统集成、类库适配、接口转换、框架使用、多态性适配和数据库适配等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>目标接口（Target Interface）：</strong> 定义客户端使用的接口，是客户端代码期望的接口。</p><p><strong>被适配者（Adaptee）：</strong> 需要被适配的类，其接口不符合客户端的需求。</p><p><strong>适配器（Adapter）：</strong> 实现目标接口，并包装了被适配者，将被适配者的接口转换成目标接口。</p><p><strong>客户端（Client）：</strong> 使用目标接口与适配器进行交互，不直接与被适配者交互。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p>客户端代码通过目标接口调用适配器的方法。</p></li><li><p>适配器内部持有一个被适配者的实例。</p></li><li><p>适配器的方法内部调用被适配者的相应方法，实现了适配。</p></li><li><p>客户端无需知道被适配者的存在，只与适配器通过目标接口进行交互。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="翻译器：Translator-cs"><a href="#翻译器：Translator-cs" class="headerlink" title="翻译器：Translator.cs"></a>翻译器：Translator.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AdapterPattern</span>;<br><br><span class="hljs-comment">// 翻译器</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">ITranslator</span><br>&#123;<br>    <span class="hljs-comment">// 翻译</span><br>    <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">Translate</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 中文翻译器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">ChineseTranslator</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">TranslateToChinese</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;中文:请通过第三方翻译SDK将文本翻译成中文.(Text:<span class="hljs-subst">&#123;text&#125;</span>)&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="适配器：Adapter-cs"><a href="#适配器：Adapter-cs" class="headerlink" title="适配器：Adapter.cs"></a>适配器：Adapter.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AdapterPattern</span>;<br><br><span class="hljs-comment">// 中文翻译器适配器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">ChineseTranslatorAdapter</span> : <span class="hljs-title">ITranslator</span><br>&#123;<br>    <span class="hljs-keyword">private</span> ChineseTranslator chineseTranslator; <span class="hljs-comment">// 中文翻译器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChineseTranslatorAdapter</span>()</span><br>    &#123;<br>        chineseTranslator = <span class="hljs-keyword">new</span> ChineseTranslator();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Translate</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> chineseTranslator.TranslateToChinese(text);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="客户端：Client-cs"><a href="#客户端：Client-cs" class="headerlink" title="客户端：Client.cs"></a>客户端：Client.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AdapterPattern</span>;<br><br><span class="hljs-comment">// 客户端</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span><br>&#123;<br>    <span class="hljs-comment">// 翻译请求</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Request</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text, ITranslator translator</span>)</span><br>    &#123;<br>        Console.WriteLine(translator.Translate(text));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 17.适配器模式测试 **************</span><br><span class="hljs-keyword">using</span> AdapterPattern;<br><br><span class="hljs-comment">// 创建中文翻译器适配器以兼容客户端的接口</span><br>ChineseTranslatorAdapter chineseTranslator = <span class="hljs-keyword">new</span> ChineseTranslatorAdapter();<br><br><span class="hljs-comment">// 模拟客户端的翻译请求</span><br>Client client = <span class="hljs-keyword">new</span> Client();<br>client.Request(<span class="hljs-string">&quot;Hello world!&quot;</span>, chineseTranslator);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码模拟了客户端发起将指定文本翻译成中文的请求。客户端要求统一实现了翻译器接口的对象，那么对于原有的中文翻译器并没有实现该接口，直接修改源码又不符合开闭原则，那么就需要采用适配器模式，为原有的中文翻译器定制一个中文翻译器适配器，并且该适配器实现了翻译器接口，如此客户端便可以间接完成对原有中文翻译器的调用了。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity中通过Gizmos绘制OverlapBox</title>
      
      <link href="/posts/2026/01/08/974b12b30af4/"/>
      <url>/posts/2026/01/08/974b12b30af4/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们发现Gizmos没有直接绘制OverlapBox的API，所以只能借助DrawLine来间接绘制OverlapBox，所以首先我们需要计算出Box四个顶点的坐标公式。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>转换为如下问题：</p><p>已知有一个矩形ABCD，A为矩形的左上顶点，C为矩形的右下顶点，宽为w，高为h，矩形中心点O坐标为(a,b)，∠α是OA与X轴负方向的夹角，矩形有一个外接圆，现使得矩形按中心进行顺时针或逆时针旋转θ角度，规定-π &lt;&#x3D; θ &lt;&#x3D; π，求旋转过后矩形四个顶点A1,B1,C1,D1的坐标分别是多少？</p><p>求解过程如下：</p><img src="/posts/2026/01/08/974b12b30af4/img1.png" class="" width="576" height="255">  <img src="/posts/2026/01/08/974b12b30af4/img2.jpeg" class="" width="388" height="388">  <img src="/posts/2026/01/08/974b12b30af4/img3.png" class="" width="423" height="290">  <img src="/posts/2026/01/08/974b12b30af4/img4.png" class="" width="446" height="499">  <img src="/posts/2026/01/08/974b12b30af4/img5.png" class="" width="559" height="401">  <img src="/posts/2026/01/08/974b12b30af4/img6.jpeg" class="" width="389" height="392">  <img src="/posts/2026/01/08/974b12b30af4/img7.png" class="" width="571" height="512"><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Collections;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BoxTrigger</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要组件&quot;</span>)</span>]<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;触发器检测层&quot;</span>)</span>]<br>    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> LayerMask cTriggerLayer;<br>    <span class="hljs-keyword">public</span> LayerMask triggerLayer &#123; <span class="hljs-keyword">get</span> =&gt; cTriggerLayer; <span class="hljs-keyword">set</span> =&gt; cTriggerLayer = <span class="hljs-keyword">value</span>; &#125;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;触发器检测区域的中心坐标组件&quot;</span>)</span>]<br>    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> Transform cTriggerArea;<br>    <span class="hljs-keyword">public</span> Transform triggerArea &#123; <span class="hljs-keyword">get</span> =&gt; cTriggerArea; <span class="hljs-keyword">set</span> =&gt; cTriggerArea = <span class="hljs-keyword">value</span>; &#125;<br><br>    [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要属性&quot;</span>)</span>]<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;触发器的宽度和高度&quot;</span>)</span>]<br>    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> Vector2 mSize;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;触发器的角度&quot;</span>)</span>]<br>    [<span class="hljs-meta">Range(-180f, 180f)</span>]<br>    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> mAngle;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;触发器绘制颜色&quot;</span>)</span>]<br>    [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> DrawColor mColor;<br><br>    <span class="hljs-keyword">public</span> Vector2 center &#123; <span class="hljs-keyword">get</span> =&gt; cTriggerArea.position; &#125;<br>    <span class="hljs-keyword">public</span> Vector2 size &#123; <span class="hljs-keyword">get</span> =&gt; mSize; <span class="hljs-keyword">set</span> =&gt; mSize = <span class="hljs-keyword">value</span>; &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> angle &#123; <span class="hljs-keyword">get</span> =&gt; mAngle; <span class="hljs-keyword">set</span> &#123; <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> &gt;= <span class="hljs-number">-180f</span> &amp;&amp; <span class="hljs-keyword">value</span> &lt;= <span class="hljs-number">180f</span>) mAngle = <span class="hljs-keyword">value</span>; &#125; &#125;<br><br>    <span class="hljs-comment">//Trigger_check用于检测主角是否进入触发区域</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> trigger_check &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>    <span class="hljs-keyword">private</span> Vector2 mLU;<br>    <span class="hljs-keyword">private</span> Vector2 mRU;<br>    <span class="hljs-keyword">private</span> Vector2 mRD;<br>    <span class="hljs-keyword">private</span> Vector2 mLD;<br>    <span class="hljs-keyword">private</span> Color currentColor;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> mSin;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> mCos;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> mWidth;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> mHeight;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">float</span> mC = <span class="hljs-number">1f</span> / <span class="hljs-number">2</span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!cTriggerArea) cTriggerArea = transform;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>    &#123;<br><br>    &#125;<br><br>    <span class="hljs-comment">//触发检测</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TriggerCheck</span>()</span><br>    &#123;<br>        <span class="hljs-comment">//检测是否进入了触发区域</span><br>        <span class="hljs-keyword">if</span> (!Physics2D.OverlapBox(center, mSize, mAngle, cTriggerLayer))<br>            trigger_check = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">else</span><br>            trigger_check = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> trigger_check;<br>    &#125;<br><br>    <span class="hljs-comment">//角度转换为弧度</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AngleConversion</span>()</span><br>    &#123;<br>        <span class="hljs-built_in">float</span> v_angle = mAngle * Mathf.PI / <span class="hljs-number">180</span>;<br>        mSin = Mathf.Sin(v_angle);<br>        mCos = Mathf.Cos(v_angle);<br>    &#125;<br><br>    <span class="hljs-comment">//坐标更新</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdatePosition</span>()</span><br>    &#123;<br>        mWidth = mSize.x;<br>        mHeight = mSize.y;<br>        <span class="hljs-built_in">float</span> x_Lu = (-mC * (mWidth * mCos + mHeight * mSin)) + center.x;<br>        <span class="hljs-built_in">float</span> y_Lu = (mC * (mHeight * mCos - mWidth * mSin)) + center.y;<br>        <span class="hljs-built_in">float</span> x_Ru = (mC * (mWidth * mCos - mHeight * mSin)) + center.x;<br>        <span class="hljs-built_in">float</span> y_Ru = (mC * (mWidth * mSin + mHeight * mCos)) + center.y;<br>        <span class="hljs-built_in">float</span> x_Rd = (mC * (mWidth * mCos + mHeight * mSin)) + center.x;<br>        <span class="hljs-built_in">float</span> y_Rd = (mC * (mWidth * mSin - mHeight * mCos)) + center.y;<br>        <span class="hljs-built_in">float</span> x_Ld = (mC * (mHeight * mSin - mWidth * mCos)) + center.x;<br>        <span class="hljs-built_in">float</span> y_Ld = (-mC * (mHeight * mCos + mWidth * mSin)) + center.y;<br>        mLU = <span class="hljs-keyword">new</span> Vector2(x_Lu, y_Lu);<br>        mRU = <span class="hljs-keyword">new</span> Vector2(x_Ru, y_Ru);<br>        mRD = <span class="hljs-keyword">new</span> Vector2(x_Rd, y_Rd);<br>        mLD = <span class="hljs-keyword">new</span> Vector2(x_Ld, y_Ld);<br>    &#125;<br><br>    <span class="hljs-comment">//颜色替换</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateColor</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">switch</span> (mColor)<br>        &#123;<br>            <span class="hljs-keyword">case</span> DrawColor.Red:<br>                currentColor = Color.red;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Blue:<br>                currentColor = Color.blue;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Green:<br>                currentColor = Color.green;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.White:<br>                currentColor = Color.white;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Yellow:<br>                currentColor = Color.yellow;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Cyan:<br>                currentColor = Color.cyan;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Gray:<br>                currentColor = Color.gray;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Grey:<br>                currentColor = Color.grey;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DrawColor.Magenta:<br>                currentColor = Color.magenta;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-literal">default</span>:<br>                currentColor = Color.red;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//Gizmos绘制</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDrawGizmos</span>()</span><br>    &#123;<br>        AngleConversion();<br>        UpdatePosition();<br>        UpdateColor();<br>        Gizmos.color = currentColor;<br>        Gizmos.DrawLine(mLU, mRU);<br>        Gizmos.DrawLine(mRU, mRD);<br>        Gizmos.DrawLine(mRD, mLD);<br>        Gizmos.DrawLine(mLD, mLU);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Bridge Pattern（桥接模式）</title>
      
      <link href="/posts/2026/01/07/9b2ff9dd6c81/"/>
      <url>/posts/2026/01/07/9b2ff9dd6c81/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>桥接模式是一种结构型设计模式，用于对抽象部分与实现部分的解耦，使得二者的变化可以相互独立，同时在抽象部分中存储一个对实现部分的引用，建立调用关联。当抽象部分的某个属性或者方法复杂多变时，就可以把它的具体实现部分与该抽象分离，仅保留对实现的引用，从而避免类膨胀的问题，也降低了代码的维护成本。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>跨平台界面系统、数据库驱动程序、多层存储系统、多媒体应用和电子设备控制等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>抽象部分（Abstraction）：</strong> 定义了抽象类的接口，维护了一个指向实现部分的引用。它的结构可以包括抽象方法、成员变量等。</p><p><strong>扩充抽象部分（Refined Abstraction）：</strong> 继承自抽象部分，对抽象部分的接口进行扩展，可以实现一些额外的功能。</p><p><strong>实现部分（Implementor）：</strong> 定义了实现部分的接口，通常包含了一些基本的操作。这个接口不一定要与抽象部分的接口完全一致，但必须能够被抽象部分调用。</p><p><strong>具体实现部分（Concrete Implementor）：</strong> 实现实现部分的接口，提供具体的实现。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>定义抽象部分（Abstraction）和实现部分（Implementor）：</strong> 首先，你需要定义两个独立的层次结构，一个是抽象部分（Abstraction），一个是实现部分（Implementor）。抽象部分定义了高层次的接口，而实现部分定义了低层次的接口。</p></li><li><p><strong>建立桥梁连接：</strong> 在抽象部分中维护一个指向实现部分的引用。这个引用可以是实现部分的接口，使得抽象部分可以调用实现部分的方法。</p></li><li><p><strong>创建具体实现部分：</strong> 实现具体的实现部分，即创建实现部分接口的具体实现类。</p></li><li><p><strong>创建抽象部分的具体子类：</strong> 创建扩充抽象部分的具体子类，这些子类可以实现抽象部分中定义的抽象方法，并可以扩展一些额外的功能。</p></li><li><p><strong>客户端使用：</strong> 在客户端中，可以使用抽象部分的接口来调用相关操作。客户端可以通过抽象部分的具体子类来实例化对象，这些对象可以在运行时选择与特定的实现部分连接。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="衣服：Clothes-cs"><a href="#衣服：Clothes-cs" class="headerlink" title="衣服：Clothes.cs"></a>衣服：Clothes.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BridgePattern</span>;<br><br><span class="hljs-comment">// 衣服</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Clothes</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 衣服名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> material; <span class="hljs-comment">// 衣服材质</span><br>    <span class="hljs-keyword">public</span> Season applicableSeason; <span class="hljs-comment">// 适用季节</span><br>    <span class="hljs-keyword">protected</span> ColorDyer colorDyer; <span class="hljs-comment">// 染色器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Clothes</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">string</span> material, Season applicableSeason, ColorDyer colorDyer</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.material = material;<br>        <span class="hljs-keyword">this</span>.applicableSeason = applicableSeason;<br>        <span class="hljs-keyword">this</span>.colorDyer = colorDyer;<br>    &#125;<br><br>    <span class="hljs-comment">// 给模特穿上</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dressed</span>(<span class="hljs-params">Man man</span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 衬衫</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Shirt</span> : <span class="hljs-title">Clothes</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Shirt</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">string</span> material, Season applicableSeason, ColorDyer colorDyer</span>) :</span><br><span class="hljs-function">    <span class="hljs-title">base</span>(<span class="hljs-params">name, material, applicableSeason, colorDyer</span>)</span><br>    &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dressed</span>(<span class="hljs-params">Man man</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;------------------------------------&quot;</span>);<br>        colorDyer.Dye();<br>        Console.WriteLine(man.name + <span class="hljs-string">&quot; is wearing a &quot;</span> + colorDyer.color + <span class="hljs-string">&quot; &quot;</span> + name + <span class="hljs-string">&quot; made of &quot;</span> + material + <span class="hljs-string">&quot; which is suitable for &quot;</span> + applicableSeason + <span class="hljs-string">&quot; wear.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 毛衣</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Sweater</span> : <span class="hljs-title">Clothes</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Sweater</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">string</span> material, Season applicableSeason, ColorDyer colorDyer</span>) :</span><br><span class="hljs-function">    <span class="hljs-title">base</span>(<span class="hljs-params">name, material, applicableSeason, colorDyer</span>)</span><br>    &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dressed</span>(<span class="hljs-params">Man man</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;------------------------------------&quot;</span>);<br>        colorDyer.Dye();<br>        Console.WriteLine(man.name + <span class="hljs-string">&quot; is wearing a &quot;</span> + colorDyer.color + <span class="hljs-string">&quot; &quot;</span> + name + <span class="hljs-string">&quot; made of &quot;</span> + material + <span class="hljs-string">&quot; which is suitable for &quot;</span> + applicableSeason + <span class="hljs-string">&quot; wear.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 短袖</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">ShortSleeve</span> : <span class="hljs-title">Clothes</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ShortSleeve</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">string</span> material, Season applicableSeason, ColorDyer colorDyer</span>) :</span><br><span class="hljs-function">    <span class="hljs-title">base</span>(<span class="hljs-params">name, material, applicableSeason, colorDyer</span>)</span><br>    &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dressed</span>(<span class="hljs-params">Man man</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;------------------------------------&quot;</span>);<br>        colorDyer.Dye();<br>        Console.WriteLine(man.name + <span class="hljs-string">&quot; is wearing a &quot;</span> + colorDyer.color + <span class="hljs-string">&quot; &quot;</span> + name + <span class="hljs-string">&quot; made of &quot;</span> + material + <span class="hljs-string">&quot; which is suitable for &quot;</span> + applicableSeason + <span class="hljs-string">&quot; wear.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 夹克</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Jacket</span> : <span class="hljs-title">Clothes</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Jacket</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">string</span> material, Season applicableSeason, ColorDyer colorDyer</span>) :</span><br><span class="hljs-function">    <span class="hljs-title">base</span>(<span class="hljs-params">name, material, applicableSeason, colorDyer</span>)</span><br>    &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dressed</span>(<span class="hljs-params">Man man</span>)</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;------------------------------------&quot;</span>);<br>        colorDyer.Dye();<br>        Console.WriteLine(man.name + <span class="hljs-string">&quot; is wearing a &quot;</span> + colorDyer.color + <span class="hljs-string">&quot; &quot;</span> + name + <span class="hljs-string">&quot; made of &quot;</span> + material + <span class="hljs-string">&quot; which is suitable for &quot;</span> + applicableSeason + <span class="hljs-string">&quot; wear.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="染色器：Dyers-cs"><a href="#染色器：Dyers-cs" class="headerlink" title="染色器：Dyers.cs"></a>染色器：Dyers.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BridgePattern</span>;<br><br><span class="hljs-comment">// 染色器</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ColorDyer</span><br>&#123;<br>    <span class="hljs-keyword">public</span> Color color; <span class="hljs-comment">// 颜色</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ColorDyer</span>(<span class="hljs-params">Color color</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.color = color;<br>    &#125;<br><br>    <span class="hljs-comment">// 染色</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dye</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 红色染色器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">RedDyer</span> : <span class="hljs-title">ColorDyer</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RedDyer</span>(<span class="hljs-params">Color color</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">color</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dye</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;The dress is dyed red.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 橙色染色器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">OrangeDyer</span> : <span class="hljs-title">ColorDyer</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OrangeDyer</span>(<span class="hljs-params">Color color</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">color</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dye</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;The dress is dyed orange.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 紫色染色器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">PurpleDyer</span> : <span class="hljs-title">ColorDyer</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PurpleDyer</span>(<span class="hljs-params">Color color</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">color</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dye</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;The dress is dyed purple.&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 白色染色器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">WhiteDyer</span> : <span class="hljs-title">ColorDyer</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WhiteDyer</span>(<span class="hljs-params">Color color</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">color</span>)</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dye</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;The dress is dyed white.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="枚举：Enum-cs"><a href="#枚举：Enum-cs" class="headerlink" title="枚举：Enum.cs"></a>枚举：Enum.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BridgePattern</span>;<br><br><span class="hljs-comment">//季节</span><br><span class="hljs-built_in">enum</span> Season<br>&#123;<br>    Spring, Summer, Autumn, Winter<br>&#125;<br><br><span class="hljs-comment">//颜色</span><br><span class="hljs-built_in">enum</span> Color<br>&#123;<br>    Red, Blue, Orange, White, Black, Yellow, Green, Purple<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="模特：Man-cs"><a href="#模特：Man-cs" class="headerlink" title="模特：Man.cs"></a>模特：Man.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">BridgePattern</span>;<br><br><span class="hljs-comment">// 男士模特</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Man</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 名字</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Man</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-comment">// 行走</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Walk</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;The man named &quot;</span> + name + <span class="hljs-string">&quot; is walking.&quot;</span>);<br>        Thread.Sleep(<span class="hljs-keyword">new</span> Random().Next(<span class="hljs-number">3000</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 18.桥接模式测试 **************</span><br><span class="hljs-keyword">using</span> BridgePattern;<br><br><span class="hljs-comment">// 找两个模特</span><br>Man jojo = <span class="hljs-keyword">new</span> Man(<span class="hljs-string">&quot;JoJo&quot;</span>);<br>Man kaka = <span class="hljs-keyword">new</span> Man(<span class="hljs-string">&quot;KaKa&quot;</span>);<br><br><span class="hljs-comment">// 做四种染色器</span><br>RedDyer redDyer = <span class="hljs-keyword">new</span> RedDyer(Color.Red);<br>OrangeDyer orangeDyer = <span class="hljs-keyword">new</span> OrangeDyer(Color.Orange);<br>PurpleDyer purpleDyer = <span class="hljs-keyword">new</span> PurpleDyer(Color.Purple);<br>WhiteDyer whiteDyer = <span class="hljs-keyword">new</span> WhiteDyer(Color.White);<br><br><span class="hljs-comment">// 给四种衣服分别配置一种染色器</span><br>Shirt whiteShirt = <span class="hljs-keyword">new</span> Shirt(<span class="hljs-string">&quot;Shirt&quot;</span>, <span class="hljs-string">&quot;cotton&quot;</span>, Season.Spring, whiteDyer);<br>Sweater orangeSweater = <span class="hljs-keyword">new</span> Sweater(<span class="hljs-string">&quot;Sweater&quot;</span>, <span class="hljs-string">&quot;polyester-fiber&quot;</span>, Season.Autumn, orangeDyer);<br>ShortSleeve purpleShortSleeve = <span class="hljs-keyword">new</span> ShortSleeve(<span class="hljs-string">&quot;ShortSleeve&quot;</span>, <span class="hljs-string">&quot;cotton&quot;</span>, Season.Summer, purpleDyer);<br>Jacket redJacket = <span class="hljs-keyword">new</span> Jacket(<span class="hljs-string">&quot;Jacket&quot;</span>, <span class="hljs-string">&quot;polyester-fiber and cotton&quot;</span>, Season.Winter, redDyer);<br><br><span class="hljs-comment">// 模特试穿衣服</span><br>whiteShirt.Dressed(jojo);<br>redJacket.Dressed(jojo);<br>purpleShortSleeve.Dressed(kaka);<br>orangeSweater.Dressed(kaka);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了衣服的染色过程。有Shirt、Sweater、ShortSleeve、Jacket四种类型的衣服，并且每种衣服都可以染Red、Orange、Purple、White四种不同的颜色，这样就会有16种组合，如果每种组合我们都去定义一个类就会出现类爆炸问题。</p><p>所以我们就可以采用桥接模式，将衣服与染色器分开，二者分别创建一个基类Clothes和ColorDyer，四种衣服分别继承Clothes基类，四种染色器分别继承ColorDyer。然后我们在Clothes基类中存储一个对ColorDyer的引用，这里就实现了Clothes与ColorDyer的桥接模式，当我们制作一件衣服时需要通过一个染色器进行染色，当我们下次有一种新的衣服或新的染色器时只需要添加一个类即可，就不需要再定义四个类，这就是桥接模式的好处。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Command Pattern（命令模式）</title>
      
      <link href="/posts/2026/01/07/f9aed930c9a7/"/>
      <url>/posts/2026/01/07/f9aed930c9a7/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>命令模式是一种行为型设计模式，用于将对一个对象的操作或请求封装成单独的命令对象，使得命令可以用来存储、传递和管理，从而对调用者和被调用者进行解耦。为了方便管理，这些被封装的命令对象会实现统一的接口或者继承统一的基类，这样不仅使得调用者的调用逻辑更简洁，也可以实现对命令的组合使用。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>GUI操作、文件操作、数据库事务、遥控器、日程调度系统、多级撤销、游戏开发和日志系统等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Command（命令接口）：</strong> 定义执行操作的接口，通常包含 execute 方法。</p><p><strong>ConcreteCommand（具体命令）：</strong> 实现命令接口，负责具体的操作。它通常会持有一个接收者对象，并调用接收者的方法来执行操作。</p><p><strong>Client（客户端）：</strong> 创建一个具体命令对象，并将其关联到一个调用者对象上。</p><p><strong>Invoker（调用者）：</strong> 负责调用命令对象执行请求。</p><p><strong>Receiver（接收者）：</strong> 知道如何执行实际的操作，是具体命令所要操作的对象。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><strong>客户端创建命令对象：</strong> 客户端创建一个具体命令对象，并设置其接收者，将操作封装成命令对象。</p><p><strong>客户端设置命令对象：</strong> 将命令对象设置到调用者（Invoker）上，这样调用者就知道要执行哪个命令。</p><p><strong>调用者执行命令：</strong> 当调用者需要执行某个操作时，它会调用命令对象的 execute 方法。</p><p><strong>命令对象调用接收者：</strong> 具体命令对象收到调用后，会调用接收者的方法，执行实际的操作。</p><p><strong>接收者执行操作：</strong> 接收者是实际执行操作的对象，它知道如何执行具体的操作。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：请在本栏目的资源篇“设计模式代码示例合集”中下载所有完整代码资源。</p></blockquote><h3 id="命令：Command-cs"><a href="#命令：Command-cs" class="headerlink" title="命令：Command.cs"></a>命令：Command.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CommandPattern</span>;<br><br><span class="hljs-comment">// 命令</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">ICommand</span><br>&#123;<br>    <span class="hljs-comment">// 执行</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Excute</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 开灯</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">TurnOnLight</span> : <span class="hljs-title">ICommand</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Light light; <span class="hljs-comment">// 灯</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TurnOnLight</span>(<span class="hljs-params">Light light</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.light = light;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Excute</span>()</span><br>    &#123;<br>        light.TurnOn();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 关灯</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">TurnOffLight</span> : <span class="hljs-title">ICommand</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Light light; <span class="hljs-comment">// 灯</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TurnOffLight</span>(<span class="hljs-params">Light light</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.light = light;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Excute</span>()</span><br>    &#123;<br>        light.TurnOff();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="灯：Light-cs"><a href="#灯：Light-cs" class="headerlink" title="灯：Light.cs"></a>灯：Light.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CommandPattern</span>;<br><br><span class="hljs-comment">// 灯</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Light</span><br>&#123;<br>    <span class="hljs-comment">// 是否处于打开状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isOn &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-comment">// 打开</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TurnOn</span>()</span><br>    &#123;<br>        isOn = <span class="hljs-literal">true</span>;<br>        Console.WriteLine(<span class="hljs-string">&quot;开灯...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 关闭</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TurnOff</span>()</span><br>    &#123;<br>        isOn = <span class="hljs-literal">false</span>;<br>        Console.WriteLine(<span class="hljs-string">&quot;关灯...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="控制器：Controller-cs"><a href="#控制器：Controller-cs" class="headerlink" title="控制器：Controller.cs"></a>控制器：Controller.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">CommandPattern</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> disable</span><br><br><span class="hljs-comment">// 灯的开关控制按钮</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">LightController</span><br>&#123;<br>    <span class="hljs-keyword">private</span> ICommand command;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LightController</span>()</span><br>    &#123;<br>        command = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 设置按下按钮时执行的命令</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCommand</span>(<span class="hljs-params">ICommand command</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.command = command;<br>    &#125;<br><br>    <span class="hljs-comment">// 按下按钮</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">PressButton</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>) command.Excute();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 19.命令模式测试 **************</span><br><span class="hljs-keyword">using</span> CommandPattern;<br><br><span class="hljs-comment">// 创建实例</span><br>Light light = <span class="hljs-keyword">new</span> Light();<br>TurnOnLight turnOn = <span class="hljs-keyword">new</span> TurnOnLight(light);<br>TurnOffLight turnOff = <span class="hljs-keyword">new</span> TurnOffLight(light);<br>LightController controller = <span class="hljs-keyword">new</span> LightController();<br><br><span class="hljs-comment">// 开灯</span><br>controller.SetCommand(turnOn);<br>controller.PressButton();<br>Console.WriteLine(<span class="hljs-string">&quot;Light is On:&quot;</span> + light.isOn);<br><br><span class="hljs-comment">// 关灯</span><br>controller.SetCommand(turnOff);<br>controller.PressButton();<br>Console.WriteLine(<span class="hljs-string">&quot;Light is On:&quot;</span> + light.isOn);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码模拟了用开关按钮控制灯。对于灯而言有开和关两个状态，对应着开关按钮的开灯命令和关灯命令，开关按钮作为命令发起者，灯则作为命令接收者，两种命令将灯的状态改变逻辑封装起来并作为参数传递给开关按钮，使得开关按钮具备了开灯和关灯的功能。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Prototype Pattern（原型模式）</title>
      
      <link href="/posts/2026/01/07/c35991d0e754/"/>
      <url>/posts/2026/01/07/c35991d0e754/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>原型模式是一种创建型设计模式，用于通过克隆原型对象来创建对象，克隆对象作为原型对象的副本，并以原型对象的状态作为初始状态，可以考虑对创建过程复杂或初始化的字段属性繁多的对象应用原型模式，用以简化创建过程。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>创建成本较高的对象、动态配置的对象、数据库连接池、图形化编辑器和框架中的Bean对象管理等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>抽象原型（Prototype）：</strong> 定义了一个克隆自身的接口，声明了一个clone方法。</p><p><strong>具体原型（ConcretePrototype）：</strong> 实现抽象原型接口的具体类，负责实现clone方法来复制自身。</p><p><strong>客户端（Client）：</strong> 使用原型对象的客户端代码，在需要创建新对象时，通过克隆原型对象而不是直接实例化来得到新对象。</p><p><strong>原型管理器（Prototype Manager）：</strong> 用于注册和管理原型对象的类，提供根据键值获取原型对象的方法。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p>客户端通过原型管理器获取原型对象的克隆，而不是通过直接实例化新对象。</p></li><li><p>原型管理器负责注册和存储原型对象，并提供获取原型对象的方法。</p></li><li><p>具体原型类实现了抽象原型接口，包含一个clone方法，该方法通过复制自身来创建新对象。</p></li><li><p>客户端代码调用原型对象的clone方法来获取新对象，从而避免了直接使用new关键字创建对象。</p></li><li><p>在需要创建新对象时，客户端可以向原型管理器请求原型对象的克隆，从而实现动态创建对象的目的。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="3D对象：3DObject-cs"><a href="#3D对象：3DObject-cs" class="headerlink" title="3D对象：3DObject.cs"></a>3D对象：3DObject.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">PrototypePattern</span>;<br><br><span class="hljs-comment">// 原型</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">IPrototype</span><br>&#123;<br>    <span class="hljs-comment">// 克隆</span><br>    <span class="hljs-function">IPrototype <span class="hljs-title">Clone</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 3D物体类型</span><br><span class="hljs-built_in">enum</span> _3DObjectType<br>&#123;<br>    None, Cube, Sphere<br>&#125;<br><br><span class="hljs-comment">// 3D物体</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> _3<span class="hljs-title">DObject</span> : <span class="hljs-title">IPrototype</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name;<br>    <span class="hljs-keyword">public</span> _3DObjectType type &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">protected</span> <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">public</span> _3DObject(<span class="hljs-built_in">string</span> name)<br>    &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> IPrototype <span class="hljs-title">Clone</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 立方体</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Cube</span> : _3<span class="hljs-title">DObject</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cube</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span><br>    &#123;<br>        type = _3DObjectType.Cube;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> IPrototype <span class="hljs-title">Clone</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Cube(name);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[Name:<span class="hljs-subst">&#123;name&#125;</span>,Type:<span class="hljs-subst">&#123;type&#125;</span>,HashCode:<span class="hljs-subst">&#123;GetHashCode()&#125;</span>]&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 球体</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Sphere</span> : _3<span class="hljs-title">DObject</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Sphere</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">name</span>)</span><br>    &#123;<br>        type = _3DObjectType.Sphere;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> IPrototype <span class="hljs-title">Clone</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Sphere(name);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[Name:<span class="hljs-subst">&#123;name&#125;</span>,Type:<span class="hljs-subst">&#123;type&#125;</span>,HashCode:<span class="hljs-subst">&#123;GetHashCode()&#125;</span>]&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3D对象管理器：3DObjectManager-cs"><a href="#3D对象管理器：3DObjectManager-cs" class="headerlink" title="3D对象管理器：3DObjectManager.cs"></a>3D对象管理器：3DObjectManager.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">PrototypePattern</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> disable</span><br><br><span class="hljs-comment">// 3D原型对象管理器</span><br><span class="hljs-keyword">class</span> _3<span class="hljs-title">DObjectManager</span><br>&#123;<br>    <span class="hljs-keyword">private</span> Dictionary&lt;_3DObjectType, IPrototype&gt; objects; <span class="hljs-comment">// 3D原型对象集合</span><br><br>    <span class="hljs-keyword">public</span> _3DObjectManager()<br>    &#123;<br>        objects = <span class="hljs-keyword">new</span> Dictionary&lt;_3DObjectType, IPrototype&gt;();<br>    &#125;<br><br>    <span class="hljs-comment">// 注册指定类型的3D原型对象</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Register</span>(<span class="hljs-params">IPrototype _3dObject, _3DObjectType type</span>)</span><br>    &#123;<br>        objects[type] = _3dObject;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取指定类型的3D原型对象的克隆对象</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IPrototype <span class="hljs-title">Get3DObject</span>(<span class="hljs-params">_3DObjectType type</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (objects.ContainsKey(type)) <span class="hljs-keyword">return</span> objects[type].Clone();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 20.原型模式测试 **************</span><br><span class="hljs-keyword">using</span> PrototypePattern;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> disable</span><br><br><span class="hljs-comment">// 创建实例</span><br>Cube cube = <span class="hljs-keyword">new</span> Cube(<span class="hljs-string">&quot;Default Cube&quot;</span>);<br>Sphere sphere = <span class="hljs-keyword">new</span> Sphere(<span class="hljs-string">&quot;Default Sphere&quot;</span>);<br>_3DObjectManager manager = <span class="hljs-keyword">new</span> _3DObjectManager();<br><br><span class="hljs-comment">// 向3D原型对象管理器注册立方体和球体的原型对象</span><br>manager.Register(cube, _3DObjectType.Cube);<br>manager.Register(sphere, _3DObjectType.Sphere);<br><br><span class="hljs-comment">// 从3D原型对象管理器获取立方体和球体的克隆对象</span><br>Cube cube1 = manager.Get3DObject(_3DObjectType.Cube) <span class="hljs-keyword">as</span> Cube;<br>Sphere sphere1 = manager.Get3DObject(_3DObjectType.Sphere) <span class="hljs-keyword">as</span> Sphere;<br><br><span class="hljs-comment">// 输出立方体以及球体的原型和克隆对象的信息</span><br>Console.WriteLine(cube);<br>Console.WriteLine(cube1);<br>Console.WriteLine(sphere);<br>Console.WriteLine(sphere1);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码演示了创建立方体和球体两个3D对象的过程。两个3D对象都实现了原型接口的克隆方法。通过向3D对象管理器注册立方体和球体的原型对象，实现通过传递3D对象类型的方式获取原型对象的克隆对象。值得一提的是编写克隆方法时要注意浅拷贝和深拷贝的问题，对于值类型和引用类型的拷贝可能会有所不同。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>泛型工厂应用改进尝试（一）</title>
      
      <link href="/posts/2026/01/07/b4c212814a45/"/>
      <url>/posts/2026/01/07/b4c212814a45/</url>
      
        <content type="html"><![CDATA[<h2 id="实验声明"><a href="#实验声明" class="headerlink" title="实验声明"></a>实验声明</h2><p>调用者的产品只要满足以下两个条件即可通过该工厂生产食物:</p><p>1.要求食物都继承自Food抽象类</p><p>2.无参构造方法公开(如果没有单独声明构造方法，默认为公开的无参构造)</p><h3 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h3><ul><li><p>分步制作流程：将一个方法的逻辑拆分为多个方法，并且给每一个方法都加上唯一的访问锁。</p></li><li><p>静态存储：利用静态的存储结构来对数据进行存储。</p></li><li><p>中间处理逻辑：对静态存储结构的处理，判断当前类型是否存在于静态存储结构中，不存在则创建，使用静态存储就必须使用中间处理逻辑，不使用静态存储则不需要使用中间处理逻辑。</p></li></ul><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>通过DateTime.Now获取方法执行的开始时间和结束时间，然后两个时间差值单位精确到毫秒。单线程数值保留4位小数，要求每执行一个线程休眠100毫秒，获取11个单线程执行的总计耗时算作一组数据，共获取20组数据，测试2次；多线程数值不保留小数，多线程共计12线程，要求多线程并发执行，不存在线程休眠，获取11个线程全部执行完成的总计耗时算作一组数据，共获取20组数据，测试2次，其它多线程并发测试类似。（之所以不统计12个线程是因为第一个执行的线程包含了C#文件的编译耗时，所以只统计第二个到最后一个，共计11个线程）</p><h3 id="计算方式"><a href="#计算方式" class="headerlink" title="计算方式"></a>计算方式</h3><p>（设20组数据分别为a1,a2,a3,…,a20，线程数11）：</p><p>线程平均耗时&#x3D;(a1&#x2F;11+a2&#x2F;11+a3&#x2F;11+…+a20&#x2F;11)&#x2F;20（保留4位小数）</p><h2 id="实验过程、分析及结果"><a href="#实验过程、分析及结果" class="headerlink" title="实验过程、分析及结果"></a>实验过程、分析及结果</h2><p>这种泛型工厂存在两个问题，第一它是通过反射来调用构造方法，所以速度非常慢，第二由于存在对公共资源的读取，所以要考虑资源冲突。</p><p>第一个问题如果想要改进，可以创建两个静态存储结构用于存储已经调用过至少一次的对应类型的构造方法信息以及这种食物类型，当再生产同一类型食物时就不需要再去通过反射查找构造信息了，而是直接从静态存储结构中查找，这种方法也算是牺牲存储来换取速度吧，类似于一种缓存思想吧。</p><p>第二个问题，我们需要访问的公共资源就是为了解决第一个问题的静态存储结构，当多个线程中都调用工厂生产食品时，都会使用到这个静态存储结构，就会存在资源冲突，所以必须对资源加锁访问，但是这么做又会导致我们生产食品时每一个产品都需要等前面的产品完全生产完成后才能进入生产过程，而不能够多线程并发生产，这就违背工厂的本质了。</p><p>为了解决第二个问题，我认为可以将制作流程中的逻辑进行进一步划分，划分为几个有序的方法，而我们需要保证每一个方法都有对应的锁，例如食物的制作流程有获取原材料、生产食物、包装食物，那么我们可以把整个流程分为三个流程，然后分别加上唯一的访问锁。</p><p>现在有线程A，B，C，D，E，F六个线程分别制作奶黄面包、夹层饼干、青柠薯片、吐司面包、草莓饼干、香辣薯片，制作流程按顺序分别是M1（获取原材料），M2（生产食物），M3（包装食物）。</p><p>三种食物采用一条生产线明显不太理想，我们可以给每种食物制订一条生产线，面包为L1，饼干为L2，薯片为L3（三个生产线的工作都可以概括为M1+M2+M3）。A和D都生产面包所以使用L1生产线，B和E都生产饼干所以使用L2生产线，C和F都生产薯片所以使用L3生产线。</p><h3 id="思路1"><a href="#思路1" class="headerlink" title="思路1"></a>思路1</h3><p>首先假设A进入L1生产线，获取M1的锁执行M1时,D需要等待A执行完M1+M2+M3才能开始生产；</p><p>B进入了L2生产线，获取了M1的锁执行M1，E需要等待B执行完M1+M2+M3才能开始生产；</p><p>C进入L3生产线，获取了M1的锁执行M1，F需要等待C执行完M1+M2+M3才能开始生产。</p><p>根据思路1，我进行了对比测试和简单测试，接下来我们一起看看实验结果吧。</p><p>（请查看测试表中的对比测试，对比测试比较单线程下反射和直接new对象的耗时）</p><p>要求启动12个线程，不使用分步制作流程，不使用静态存储，无中间处理逻辑，通过对比测试可知：</p><p>发现单线程执行耗时：约0.02236ms</p><p>多线程并发执行耗时：约36.2273ms</p><p>单线程直接new对象耗时:约0.0019ms</p><p><strong>结论1：</strong> 从上述结果我们可以发现单线程下反射的速率相比直接new对象慢了约10.77倍。</p><p>虽然通过反射让我们的工厂更加多态也更加接近面向对象，但是单纯使用反射在面对多线程时会带来巨大的性能开销。我们发现反射的效率比较低，参考了网上的资料发现，可以采用静态存储的方式来将类型信和构造器信息存储下来，下一次创建对象时就不需要通过反射查找而是直接根据静态存储中的生产资料创建对象即可，所以来验证一下这个方法是否有效？如果有效，它相对直接反射能提高多少速率呢？</p><p>（请查看测试表中的简单测试，简单测试比较单线程下直接使用反射和使用静态存储的耗时）</p><p>要求启动5个线程，不使用分步制作流程，使用静态存储，有中间处理逻辑，通过简单测试可知：</p><p><strong>结论2：</strong> 单线程下，使用静态存储比直接使用反射（无中间处理逻辑）的速率慢约7.3%，使用静态存储比直接使用反射（有中间处理逻辑）的速率快约26.4%。</p><p>这个结果出乎了我的意料，我的预测是使用静态存储会更快一些，但是实验结果却大相径庭。出现这个结果的原因是因为中间处理逻辑导致的，那我们应该怎么弥补中间处理逻辑所带来的时间消耗呢？我们可以尝试从对象的生产过程考虑，思路1要求我们必须按照顺序（M1-M2-M3）生产出一个食物后才能开始生产下一个食物，这就使得所有线程必须有序地一个一个进行生产，但是我们知道，一个食物大致可以分为M1-M2-M3三个生产过程，当一个食物进入M2或M3时，为了提高速率我们可以让下一个待制作的食物进入M1这个生产流程，这样可以使得资源的利用率提升，那应该怎么做呢？我们可以尝试将M1-M2-M3放在一个方法中，然后给每一个制作流程加上一个访问锁，这样多线程访问时，既能保证制作流程顺序又能够并发执行提高效率，这就是分步制作流程，所以实验思路就变成了思路2。</p><h3 id="思路2"><a href="#思路2" class="headerlink" title="思路2"></a>思路2</h3><p>首先假设A进入L1生产线，获取M1的锁执行M1，当A执行完M1获取M2的锁执行M2时,D进入L1生产线获取M1的锁执行M1；</p><p>B进入了L2生产线，获取M1的锁执行M1，当B执行完M1获取M2的锁执行M2时,E进入L2生产线获取M1的锁执行M1；</p><p>C进入L3生产线，获取M1的锁执行M1，当C执行完M1获取M2的锁执行M2时,F进入L3生产线获取M1的锁执行M1。</p><p>那么思路2是否有效？如果有效能提高多少速率？</p><p>（请查看测试表中的对比测试2，对比测试2对比是否使用分步制作流程和是否使用静态存储）</p><p>①启动12线程，使用分步制作流程，使用静态存储，有中间处理逻辑</p><p>②启动12线程，使用分步制作流程，不使用静态存储，有中间处理逻辑</p><p>③启动12线程，不使用分步制作流程，使用静态存储，有中间处理逻辑</p><p>④启动12线程，使用分步制作流程，不使用静态存储，无中间处理逻辑</p><p>⑤启动12线程，不使用分步制作流程，不使用静态存储，无中间处理逻辑</p><p>⑥启动12线程，不使用分步制作流程，不使用静态存储，有中间处理逻辑</p><p>原则上我们应该是有8组方案，但是有两组不符合专设术语中的要求，所以进行了舍弃，通过对比测试2，得出以下结果：</p><p>发现单线程执行耗时：⑤&lt;④&lt;①&lt;②&lt;③≈⑥</p><p>多线程并发执行耗时：④&lt;①&lt;⑤≈②&lt;⑥≈③</p><p>说明一下，②⑥可以不使用中间处理逻辑，但是为了遵循控制变量唯一的原则加入了中间处理逻辑。</p><p><strong>结论3：</strong> 通过比较①②可以发现，单线程中使用静态存储比不使用静态存储提升约44.7%的速率，而多线程并发执行中使用静态存储相比不使用静态存储提升约6.6%。</p><p><strong>结论4：</strong> 通过比较①③可以发现，单线程中使用分步制作流程比不使用分步制作流程提升约75.1%的速率，而多线程并发执行时我们发现使用分步制作流程相比不使用分步制作流程提升约34.4%的速率。</p><p><strong>结论5：</strong> ⑤才是真正意义上的直接调用反射，因为反射并不需要中间处理逻辑，而④对⑤进行了优化，加入了分步制作流程，在多线程并发执行中使用分步制作流程使得④在⑤的基础上提升约29.3%的速率，但是在单线程中⑤比④更快速，结合结论4可以说明分步制作流程适用于有静态存储或者无静态存储多线程并发执行的情况。</p><p><strong>结论6：</strong> 对比⑤⑥可以发现中间处理逻辑对执行速率的影响，中间处理逻辑必然会使得执行速率降低，但是我们还是有必要知道它的影响程度，⑥在⑤的基础上加入了中间处理逻辑导致单线程下速率降低98.7%，多线程并发执行速率降低约26.4%，这说明中间处理逻辑非常影响速率，但是对于静态存储而言，中间处理逻辑是必不可少的，所以我们只能尝试优化而不可能禁用。</p><p><strong>结论7：</strong> 对比③⑥可以发现，当单独使用静态存储而不使用分步制作流程时，无论是单线程还是多线程并发执行的情况，都无法提升速率，结合结论1说明静态存储需要结合分步制作流程才能提升速率。</p><p>结合结论5和结论7可知在能够提升速率的情况下，分步制作流程是静态存储的必要不充分条件。再根据前几次测试的结果可以看出，12个线程抢一把锁完成A方法比12个线程抢三把锁分步完成A方法的三个部分速率更慢，也就是说分步制作流程的想法还是能够提升一定速率的，而静态存储在处理多线程时并不能够有效提升速率，因为静态存储是涉及对存储结构的遍历查找的，随着存储结构存储的数据越多，就会变得越慢，最后总会低于直接使用反射的速率，唯一能够优化的或许只能从存储结构和相关的查找算法两个角度去考虑了。我猜测分步制作流程对速率的提升程度会随着锁的数量增多或中间处理逻辑变得复杂而降低，不过这需要我进一步测试验证，接下来我们尝试对存储结构进行优化。</p><p>（请查看测试表中的对比测试3，对比测试3对比是否使用分步制作流程）</p><p>①启动12线程，使用分步制作流程，使用静态存储，有中间处理逻辑</p><p>②启动12线程，不使用分步制作流程，使用静态存储，有中间处理逻辑</p><p>在对比测试3中，我对静态存储结构进行了自定义，进而简化了中间的一些判断过程，幸运的是这确实得到了进一步优化，测试结果如下：</p><p><strong>结论8：</strong> 同在对比测试3中，单线程使用分步制作流程相比不使用提升约57.1%的速率，多线程并发执行中使用分步制作流程相比不使用提升约9.9%的速率。</p><p><strong>结论9：</strong> 与对比测试2中的①相比较，单线程中对比测试3中①的速率提升约36.2%，多线程并发执行中对比测试3中①的速率提升约27.0%。</p><p><strong>结论10：</strong> 与对比测试2中的⑤相比较，单线程中对比测试3中①的速率提升约18.3%，多线程并发执行中对比测试3中①的速率提升约31.5%。</p><p>结论9说明自定义的静态存储结构比双列表更适合我们的工厂，结论10说明我们成功通过分步制作流程和自定义静态存储结构的方式弥补了中间处理逻辑所带来的时间消耗，并且在此基础上还提升了一定速率，使得当前的模式比直接调用反射更快。字典作为静态存储结构也是一个不错的选择，那我们一起看看字典和我们自定义的结构相比哪一个更适合我们的工厂吧。</p><p>（请查看测试表中的对比测试4，对比测试4对比使用字典和自定义存储结构）</p><p>①启动3线程，使用分步制作流程，使用静态存储，有中间处理逻辑，静态存储结构为Dictionary</p><p>②启动3线程，使用分步制作流程，使用静态存储，有中间处理逻辑，静态存储结构为自定义存储结构</p><p>③启动6线程，使用分步制作流程，使用静态存储，有中间处理逻辑，静态存储结构为Dictionary</p><p>④启动6线程，使用分步制作流程，使用静态存储，有中间处理逻辑，静态存储结构为自定义存储结构</p><p>⑤启动12线程，使用分步制作流程，使用静态存储，有中间处理逻辑，静态存储结构为Dictionary</p><p>⑥启动12线程，使用分步制作流程，使用静态存储，有中间处理逻辑，静态存储结构为自定义存储结构</p><p>在对比测试4中，我们除了对比静态存储结构，也对启动的线程数进行了改变，通过对比测试4我们可以得出以下结果：</p><p>发现单线程执行耗时：⑥&lt;⑤&lt;④&lt;③&lt;②&lt;①</p><p>多线程并发执行耗时：②&lt;④&lt;①&lt;③&lt;⑥&lt;⑤</p><p><strong>结论11：</strong> 我们发现单线程执行耗时呈现出一个规律，线程数越多，单线程执行耗时越少。</p><p>这是因为静态存储在每次加入一个新的元素时都会耗费一定时间，所以平均耗时&#x3D;（新元素存储时间+旧元素读取时间）&#x2F; 线程数，旧元素读取时间是很短的，相对新元素存储时间可以忽略不计，新元素存储时间与静态存储结构有关，可以对比①③⑤或②④⑥，所以才会呈现出结论11所述的规律。</p><p><strong>结论12：</strong> 通过对比①②或③④或⑤⑥可知，自定义存储结构相比字典更适合我们的工厂。</p><p>根据对比测试3和对比测试4我们发现自定义的静态存储结构相比双列表和字典更适合我们的工厂，再结合前几次测试说明通过结合分步制作流程、静态存储和自定义存储结构，我们当前的模式已经比直接调用反射更快了，虽然我们的优化方法对速率的提升不是极大幅度的，但是这可以看作是一个小小的进步。所以我们获得了目前最优的版本，具体代码请查看对应文件“泛型工厂应用改进尝试代码”。</p><h2 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h2><p>这个实验并不是去改进工厂模式，而应该是看作一种对工厂模式应用的优化，实验中我们通过分步制作流程、静态存储、自定义静态存储结构三种方式尝试对泛型工厂的应用进行优化，其中我们从单线程、多线程等方面对改进后的泛型工厂进行了测试，根据测试数据得出相关结论，实验中将优化思路和测试数据结合，一步一步地将实验的逻辑贯通起来，使得实验的操作井然有序，实验过程中对测试数据进行了筛选，并且将求取的平均值作为最终值，遵循控制变量单一的原则对比测试数据，计算各优化方式所提升的速率百分比。</p><h3 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h3><p>①本次实验采用的测试方式是手动测试，所以效率比较低，建议编写一套自动化测试工具。</p><p>②本次实验中对于测试数据的筛选规则比较粗略，建议借鉴一些科学的实验数据筛选规则。</p><p>③本次实验中各个测试的代码文件命名以及代码编写不规范，建议每一个测试都创建一个新的代码文件并制定代码编写规范。</p><h3 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h3><img src="/posts/2026/01/07/b4c212814a45/img1.jpeg" class="" width="825" height="722"><h2 id="实验数据"><a href="#实验数据" class="headerlink" title="实验数据"></a>实验数据</h2><h3 id="对比测试"><a href="#对比测试" class="headerlink" title="对比测试"></a>对比测试</h3><div class="custom-table-container">    <table class="custom-table">        <thead>            <tr>                <th>分类</th>                <th>线程数</th>                <th>分步制作流程</th>                <th>静态存储</th>                <th>中间处理逻辑</th>                <th>静态存储结构</th>            </tr>        </thead>        <tbody>            <tr>                <td rowspan="3" class="custom-table-category">测试1</td>                <td>12</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.2473/11+0.2514/11+0.2251/11+0.2452/11+0.2544/11+0.1931/11+0.248/11+0.2527/11+0.2284/11+0.2871/11+0.2323/11+0.2368/11+0.2104/11+0.1991/11+0.2969/11+0.2088/11+0.2958/11+0.2857/11+0.2179/11+0.3030/11)/20 ≈ 0.02236ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (356/11+353/11+369/11+473/11+382/11+474/11+443/11+405/11+376/11+383/11+402/11+367/11+402/11+385/11+382/11+395/11+424/11+402/11+409/11+388/11)/20 ≈ 36.2273ms                </td>            </tr>            <tr>                <td rowspan="2" class="custom-table-category">测试2</td>                <td>12</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.5067/11+0.4547/11+0.4635/11+0.4335/11+0.4951/11+0.4383/11+0.5566/11+0.5493/11+0.4451/11+0.4577/11+0.4205/11+0.4856/11+0.5487/11+0.4462/11+0.4429/11+0.4718/11+0.5608/11+0.4172/11+0.4573/11+0.546/11)/20 ≈ 0.04362ms                </td>            </tr>            <tr>                <td rowspan="2" class="custom-table-category">直接new对象</td>                <td>1</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td>无</td>            </tr>            <tr>                <td colspan="4" class="custom-table-formula">                    (0.0017+0.002+0.0015+0.0018+0.0026+0.0018+0.0018+0.002+0.0022+0.0018+0.0019+0.0021+0.0017+0.0017+0.0018+0.002+0.0026+0.002+0.0017+0.0021)/20 ≈ 0.0019ms                </td>            </tr>        </tbody>    </table></div><h3 id="对比测试2"><a href="#对比测试2" class="headerlink" title="对比测试2"></a>对比测试2</h3><div class="custom-table-container">    <table class="custom-table">        <thead>            <tr>                <th>分类</th>                <th>线程数</th>                <th>分步制作流程</th>                <th>静态存储</th>                <th>中间处理逻辑</th>                <th>静态存储结构</th>            </tr>        </thead>        <tbody>            <tr>                <td rowspan="3" class="custom-table-category">测试1</td>                <td>12</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>List&ltType&gt<br>List&ltConstructorInfo&gt</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.2630/11+0.2468/11+0.2430/11+0.2587/11+0.2437/11+0.2682/11+0.2648/11+0.3433/11+0.3038/11+0.3020/11+0.2680/11+0.2681/11+0.2528/11+0.2510/11+0.2504/11+0.3048/11+0.2898/11+0.2856/11+0.2640/11+0.2785/11)/20 ≈ 0.02477ms                    (0.2693/11+0.2842/11+0.2505/11+0.2595/11+0.2602/11+0.2629/11+0.2703/11+0.2734/11+0.2709/11+0.2729/11+0.3121/11+0.2894/11+0.2496/11+0.2532/11+0.3189/11+0.2733/11+0.2537/11+0.2820/11+0.2614/11+0.2532/11)/20 ≈ 0.02464ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (194/11+166/11+180/11+211/11+192/11+188/11+189/11+195/11+200/11+209/11+178/11+167/11+207/11+214/11+188/11+193/11+214/11+166/11+213/11+201/11)/20 ≈ 17.5682ms                    (197/11+215/11+208/11+186/11+204/11+209/11+212/11+188/11+206/11+181/11+188/11+194/11+186/11+189/11+212/11+194/11+192/11+188/11+191/11+167/11)/20 ≈ 17.7591ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试2</td>                <td>12</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.3962/11+0.4001/11+0.4079/11+0.3890/11+0.4202/11+0.3827/11+0.4235/11+0.4130/11+0.3975/11+0.3919/11+0.4119/11+0.3824/11+0.3859/11+0.3770/11+0.3767/11+0.3933/11+0.3854/11+0.3875/11+0.3833/11+0.3847/11)/20 ≈ 0.03586ms                    (0.4340/11+0.3873/11+0.3839/11+0.3800/11+0.4076/11+0.3882/11+0.3836/11+0.3853/11+0.4005/11+0.3831/11+0.3870/11+0.3805/11+0.3851/11+0.3887/11+0.3875/11+0.3986/11+0.4298/11+0.3871/11+0.3718/11+0.3918/11)/20 ≈ 0.03564ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (181/11+171/11+212/11+173/11+210/11+229/11+239/11+195/11+238/11+213/11+258/11+155/11+239/11+181/11+215/11+226/11+184/11+199/11+179/11+224/11)/20 ≈ 18.7318ms                    (179/11+195/11+216/11+237/11+200/11+222/11+199/11+209/11+241/11+240/11+236/11+173/11+243/11+198/11+210/11+218/11+153/11+212/11+184/11+200/11)/20 ≈ 18.9318ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试3</td>                <td>12</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>List&ltType&gt<br>List&ltConstructorInfo&gt</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.4438/11+0.4097/11+0.4702/11+0.5337/11+0.5064/11+0.4992/11+0.5202/11+0.4406/11+0.5306/11+0.4278/11+0.4877/11+0.4401/11+0.4657/11+0.4190/11+0.4321/11+0.4535/11+0.5456/11+0.4587/11+0.4653/11+0.5339/11)/20 ≈ 0.04310ms                    (0.4450/11+0.4828/11+0.4320/11+0.5183/11+0.4642/11+0.4664/11+0.5300/11+0.4376/11+0.5262/11+0.4368/11+0.4956/11+0.4988/11+0.4617/11+0.4656/11+0.4638/11+0.5258/11+0.4161/11+0.4754/11+0.5085/11+0.5026/11)/20 ≈ 0.04342ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (234/11+256/11+267/11+250/11+233/11+228/11+248/11+255/11+259/11+221/11+243/11+261/11+245/11+263/11+259/11+300/11+265/11+277/11+240/11+326/11)/20 ≈ 23.3182ms                    (276/11+260/11+334/11+281/11+259/11+262/11+328/11+279/11+247/11+248/11+264/11+284/11+251/11+260/11+267/11+235/11+243/11+238/11+253/11+245/11)/20 ≈ 24.1545ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试4</td>                <td>12</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.2384/11+0.2295/11+0.2178/11+0.2000/11+0.2438/11+0.2175/11+0.2378/11+0.2339/11+0.2340/11+0.2694/11+0.2605/11+0.2767/11+0.2464/11+0.2113/11+0.2838/11+0.2668/11+0.2412/11+0.2335/11+0.2805/11+0.3166/11)/20 ≈ 0.02245ms                    (0.2524/11+0.2246/11+0.2139/11+0.2437/11+0.2667/11+0.3445/11+0.2296/11+0.2475/11+0.2808/11+0.2380/11+0.2095/11+0.2219/11+0.2885/11+0.2187/11+0.2372/11+0.2984/11+0.2734/11+0.2104/11+0.3401/11+0.2183/11)/20 ≈ 0.02299ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (141/11+143/11+160/11+143/11+164/11+170/11+177/11+166/11+179/11+159/11+159/11+178/11+163/11+148/11+131/11+156/11+160/11+145/11+149/11+167/11)/20 ≈ 14.3545ms                    (159/11+136/11+146/11+139/11+144/11+121/11+154/11+145/11+178/11+164/11+147/11+137/11+133/11+175/11+150/11+170/11+159/11+166/11+173/11+166/11)/20 ≈ 13.9182ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试5</td>                <td>12</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.2051/11+0.2230/11+0.2466/11+0.2221/11+0.2142/11+0.2485/11+0.2797/11+0.2225/11+0.2487/11+0.2746/11+0.2476/11+0.2384/11+0.2052/11+0.2497/11+0.2496/11+0.2066/11+0.1999/11+0.2692/11+0.1951/11+0.2110/11)/20 ≈ 0.02116ms                    (0.2636/11+0.2345/11+0.2293/11+0.2750/11+0.2286/11+0.2743/11+0.2408/11+0.2233/11+0.2744/11+0.2332/11+0.2374/11+0.2537/11+0.2271/11+0.2208/11+0.2023/11+0.2841/11+0.2675/11+0.1943/11+0.2031/11+0.2189/11)/20 ≈ 0.02176ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (183/11+189/11+200/11+201/11+165/11+212/11+212/11+214/11+192/11+200/11+209/11+213/11+188/11+230/11+226/11+213/11+233/11+193/11+175/11+225/11)/20 ≈ 18.5136ms                    (208/11+195/11+189/11+211/11+204/11+172/11+205/11+203/11+185/11+201/11+194/11+195/11+183/11+190/11+206/11+221/11+198/11+219/11+173/11+220/11)/20 ≈ 18.0545ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试6</td>                <td>12</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.4733/11+0.5501/11+0.4496/11+0.4663/11+0.4831/11+0.5367/11+0.5336/11+0.4518/11+0.4509/11+0.5200/11+0.4885/11+0.4548/11+0.4147/11+0.4541/11+0.5479/11+0.4550/11+0.4590/11+0.4903/11+0.4512/11+0.4614/11)/20 ≈ 0.04360ms                    (0.4116/11+0.4936/11+0.4380/11+0.4129/11+0.4700/11+0.4814/11+0.4380/11+0.4606/11+0.3962/11+0.5373/11+0.4038/11+0.4558/11+0.4678/11+0.4151/11+0.4474/11+0.4822/11+0.5452/11+0.4627/11+0.4175/11+0.5360/11)/20 ≈ 0.04170ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (257/11+271/11+245/11+234/11+257/11+288/11+253/11+269/11+246/11+249/11+301/11+250/11+196/11+247/11+264/11+251/11+227/11+258/11+265/11+251/11)/20 ≈ 23.0864ms                    (254/11+243/11+288/11+270/11+262/11+248/11+253/11+272/11+229/11+254/11+237/11+265/11+263/11+229/11+258/11+261/11+230/11+279/11+259/11+234/11)/20 ≈ 23.1273ms                </td>            </tr>        </tbody>    </table></div><h3 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h3><div class="custom-table-container">    <table class="custom-table">        <thead>            <tr>                <th>分类</th>                <th>线程数</th>                <th>分步制作流程</th>                <th>静态存储</th>                <th>中间处理逻辑</th>                <th>静态存储结构</th>            </tr>        </thead>        <tbody>            <tr>                <td rowspan="2" class="custom-table-category">测试1</td>                <td>5</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.007200/1+0.007300/1+0.009700/1+0.007300/1+0.006400/1+0.007100/1+0.007900/1+0.007100/1+0.008100/1+0.007600/1+0.009900/1+0.007000/1+0.007200/1+0.008900/1+0.008300/1+0.007500/1+0.008300/1+0.007700/1+0.007800/1+0.008800/1)/20 ≈ 0.007855ms                    (0.007200/1+0.007400/1+0.007100/1+0.006900/1+0.006400/1+0.007100/1+0.006700/1+0.008500/1+0.008200/1+0.007400/1+0.009300/1+0.007300/1+0.007400/1+0.006500/1+0.007400/1+0.007000/1+0.009000/1+0.008700/1+0.006100/1+0.006600/1)/20 ≈ 0.007410ms                </td>            </tr>            <tr>                <td rowspan="2" class="custom-table-category">测试2</td>                <td>5</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td>无</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.009700/1+0.009400/1+0.009400/1+0.010100/1+0.010000/1+0.010000/1+0.013100/1+0.013700/1+0.010200/1+0.010100/1+0.010500/1+0.009900/1+0.010700/1+0.009900/1+0.009900/1+0.009600/1+0.010400/1+0.010000/1+0.015600/1+0.010600/1)/20 ≈ 0.010640ms                    (0.010000/1+0.009500/1+0.010800/1+0.011600/1+0.009700/1+0.010100/1+0.009700/1+0.009500/1+0.010300/1+0.013100/1+0.011300/1+0.009300/1+0.008900/1+0.008800/1+0.010900/1+0.009900/1+0.009200/1+0.009400/1+0.009300/1+0.009900/1)/20 ≈ 0.010060ms                </td>            </tr>            <tr>                <td rowspan="2" class="custom-table-category">测试3</td>                <td>5</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>List&ltType&gt<br>List&ltConstructorInfo&gt</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.007700/1+0.008400/1+0.008300/1+0.007400/1+0.007500/1+0.009500/1+0.008400/1+0.007400/1+0.008300/1+0.007700/1+0.007300/1+0.008000/1+0.008400/1+0.008200/1+0.008200/1+0.008300/1+0.009400/1+0.008000/1+0.008200/1+0.008200/1)/20 ≈ 0.008140ms                    (0.007900/1+0.007400/1+0.009600/1+0.008400/1+0.009000/1+0.007800/1+0.007100/1+0.008100/1+0.007800/1+0.009600/1+0.009000/1+0.007700/1+0.008900/1+0.008100/1+0.008300/1+0.007400/1+0.008100/1+0.008200/1+0.008400/1+0.008000/1)/20 ≈ 0.008240ms                </td>            </tr>        </tbody>    </table></div><h3 id="对比测试3"><a href="#对比测试3" class="headerlink" title="对比测试3"></a>对比测试3</h3><div class="custom-table-container">    <table class="custom-table">        <thead>            <tr>                <th>分类</th>                <th>线程数</th>                <th>分步制作流程</th>                <th>静态存储</th>                <th>中间处理逻辑</th>                <th>静态存储结构</th>            </tr>        </thead>        <tbody>            <tr>                <td rowspan="3" class="custom-table-category">测试1</td>                <td>12</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>CustomStructs</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.1810/11+0.2175/11+0.2126/11+0.2066/11+0.2100/11+0.2342/11+0.1962/11+0.1825/11+0.1835/11+0.1835/11+0.1828/11+0.2141/11+0.1865/11+0.2178/11+0.1873/11+0.1740/11+0.1936/11+0.1996/11+0.2277/11+0.2215/11)/20 ≈ 0.01824ms (0.1822/11+0.2286/11+0.1970/11+0.1848/11+0.2127/11+0.2282/11+0.1951/11+0.2149/11+0.1884/11+0.1911/11+0.1861/11+0.1829/11+0.1990/11+0.2022/11+0.1862/11+0.2175/11+0.1809/11+0.1792/11+0.2209/11+0.1909/11)/20 ≈ 0.01804ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (170/11+151/11+152/11+113/11+169/11+149/11+114/11+140/11+136/11+174/11+147/11+160/11+178/11+160/11+155/11+101/11+178/11+165/11+174/11+153/11)/20 ≈ 13.8136ms (149/11+169/11+145/11+156/11+118/11+138/11+168/11+165/11+175/11+150/11+136/11+138/11+157/11+175/11+158/11+122/11+162/11+142/11+197/11+160/11)/20 ≈ 14.0000ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试2</td>                <td>12</td>                <td class="custom-table-cross">×</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>CustomStructs</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.3074/11+0.3424/11+0.3201/11+0.2986/11+0.2934/11+0.3014/11+0.3034/11+0.3018/11+0.3322/11+0.3200/11+0.2926/11+0.3323/11+0.3094/11+0.3185/11+0.3168/11+0.3261/11+0.2923/11+0.2849/11+0.3107/11+0.3043/11)/20 ≈ 0.02822ms                    (0.3742/11+0.3191/11+0.2873/11+0.2962/11+0.3410/11+0.2911/11+0.3319/11+0.2845/11+0.3574/11+0.3578/11+0.3241/11+0.3097/11+0.3087/11+0.3098/11+0.2826/11+0.3018/11+0.3322/11+0.3013/11+0.2931/11+0.3529/11)/20 ≈ 0.02889ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (188/11+173/11+177/11+170/11+184/11+143/11+156/11+179/11+186/11+175/11+189/11+174/11+177/11+145/11+164/11+165/11+168/11+180/11+182/11+163/11)/20 ≈ 15.6273ms                    (169/11+172/11+155/11+152/11+159/11+156/11+156/11+162/11+154/11+158/11+178/11+151/11+190/11+184/11+188/11+159/11+141/11+182/11+157/11+168/11)/20 ≈ 14.9591ms                </td>            </tr>        </tbody>    </table></div><h3 id="对比测试4"><a href="#对比测试4" class="headerlink" title="对比测试4"></a>对比测试4</h3><div class="custom-table-container">    <table class="custom-table">        <thead>            <tr>                <th>分类</th>                <th>线程数</th>                <th>分步制作流程</th>                <th>静态存储</th>                <th>中间处理逻辑</th>                <th>静态存储结构</th>            </tr>        </thead>        <tbody>            <tr>                <td rowspan="3" class="custom-table-category">测试1</td>                <td>3</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>Dictionary&ltType,ConstructorInfo&gt</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.1215/3+0.1344/3+0.1269/3+0.1191/3+0.1397/3+0.1207/3+0.1321/3+0.1596/3+0.1268/3+0.1240/3+0.1192/3+0.1367/3+0.1434/3+0.1453/3+0.1234/3+0.1206/3+0.1297/3+0.1248/3+0.1258/3+0.1314/3)/20 ≈ 0.04342ms                    (0.1167/3+0.1567/3+0.1168/3+0.1229/3+0.1276/3+0.1203/3+0.1504/3+0.1361/3+0.1232/3+0.1164/3+0.1346/3+0.1202/3+0.1226/3+0.1187/3+0.1164/3+0.1174/3+0.1163/3+0.1665/3+0.1142/3+0.1581/3)/20 ≈ 0.04287ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (11/1+12/1+11/1+13/1+11/1+12/1+13/1+12/1+12/1+12/1+12/1+12/1+12/1+13/1+14/1+12/1+12/1+11/1+13/1+12/1)/20 ≈ 12.1ms                    (11/1+13/1+12/1+13/1+12/1+11/1+14/1+12/1+13/1+13/1+12/1+12/1+13/1+12/1+11/1+12/1+12/1+12/1+12/1+12/1)/20 ≈ 12.2ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试2</td>                <td>3</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>CustomStructs</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.1171/3+0.1120/3+0.1177/3+0.1102/3+0.1340/3+0.1139/3+0.1075/3+0.1267/3+0.1090/3+0.1290/3+0.1139/3+0.1130/3+0.1081/3+0.1237/3+0.1136/3+0.1240/3+0.1078/3+0.1137/3+0.1110/3+0.1166/3)/20 ≈ 0.03871ms                    (0.1133/3+0.1141/3+0.1197/3+0.1327/3+0.1143/3+0.1141/3+0.1109/3+0.1117/3+0.1085/3+0.1291/3+0.1203/3+0.1100/3+0.1157/3+0.1129/3+0.1165/3+0.1108/3+0.1321/3+0.1212/3+0.1133/3+0.1364/3)/20 ≈ 0.03929ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (9/1+10/1+8/1+8/1+8/1+8/1+9/1+8/1+8/1+8/1+10/1+8/1+8/1+8/1+8/1+9/1+8/1+8/1+8/1+10/1)/20 ≈ 8.45ms                    (9/1+8/1+8/1+8/1+8/1+9/1+9/1+8/1+9/1+8/1+9/1+8/1+8/1+8/1+8/1+8/1+8/1+8/1+10/1+8/1)/20 ≈ 8.35ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试3</td>                <td>6</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>Dictionary&ltType,ConstructorInfo&gt</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.1408/5+0.1424/5+0.1392/5+0.1536/5+0.1501/5+0.1513/5+0.1902/5+0.1561/5+0.1571/5+0.1512/5+0.1577/5+0.1521/5+0.1933/5+0.1562/5+0.1545/5+0.2309/5+0.1452/5+0.1729/5+0.1595/5+0.1806/5)/20 ≈ 0.03235ms                    (0.1523/5+0.2164/5+0.1717/5+0.1557/5+0.1463/5+0.1508/5+0.2573/5+0.1511/5+0.1788/5+0.1499/5+0.1659/5+0.1429/5+0.1838/5+0.1626/5+0.1680/5+0.1509/5+0.1619/5+0.2484/5+0.1864/5+0.1531/5)/20 ≈ 0.03454ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (86/5+67/5+65/5+69/5+69/5+65/5+65/5+73/5+80/5+71/5+76/5+64/5+78/5+79/5+65/5+66/5+71/5+66/5+54/5+64/5)/20 ≈ 13.9300ms                    (69/5+61/5+52/5+93/5+68/5+84/5+74/5+52/5+58/5+48/5+67/5+79/5+84/5+65/5+74/5+64/5+71/5+61/5+71/5+53/5)/20 ≈ 13.4800ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试4</td>                <td>6</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>CustomStructs</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.1691/5+0.1360/5+0.1559/5+0.1489/5+0.1477/5+0.1709/5+0.1923/5+0.1363/5+0.1661/5+0.1486/5+0.1630/5+0.1409/5+0.1532/5+0.1470/5+0.1795/5+0.1560/5+0.1339/5+0.1381/5+0.1430/5+0.2145/5)/20 ≈ 0.03141ms                    (0.1588/5+0.1674/5+0.1497/5+0.1568/5+0.1681/5+0.1862/5+0.2099/5+0.1593/5+0.1454/5+0.1556/5+0.1401/5+0.1533/5+0.1433/5+0.1544/5+0.1479/5+0.1357/5+0.1419/5+0.1729/5+0.1588/5+0.1924/5)/20 ≈ 0.03198ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (50/5+40/5+33/5+45/5+44/5+46/5+42/5+52/5+46/5+59/5+50/5+52/5+54/5+46/5+64/5+43/5+67/5+39/5+46/5+32/5)/20 ≈ 9.5000ms                    (54/5+46/5+38/5+50/5+47/5+48/5+43/5+34/5+45/5+53/5+48/5+55/5+54/5+42/5+44/5+46/5+45/5+49/5+41/5+40/5)/20 ≈ 9.2200ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试5</td>                <td>12</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>Dictionary&ltType,ConstructorInfo&gt</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.2390/11+0.2359/11+0.2520/11+0.2482/11+0.2405/11+0.2176/11+0.2601/11+0.2245/11+0.2787/11+0.2277/11+0.2312/11+0.2577/11+0.3282/11+0.2152/11+0.2254/11+0.2216/11+0.2292/11+0.2399/11+0.2948/11+0.2497/11)/20 ≈ 0.02235ms                    (0.2633/11+0.2718/11+0.2210/11+0.2463/11+0.2688/11+0.2250/11+0.3660/11+0.2305/11+0.2052/11+0.2100/11+0.2185/11+0.2774/11+0.2096/11+0.2819/11+0.2111/11+0.2004/11+0.2871/11+0.3690/11+0.2612/11+0.2124/11)/20 ≈ 0.02289ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (199/11+219/11+183/11+211/11+203/11+199/11+197/11+219/11+207/11+203/11+215/11+188/11+215/11+227/11+223/11+227/11+221/11+192/11+194/11+197/11)/20 ≈ 18.8136ms                    (215/11+222/11+191/11+189/11+207/11+195/11+220/11+194/11+186/11+196/11+193/11+196/11+193/11+196/11+190/11+208/11+214/11+208/11+194/11+208/11)/20 ≈ 18.2500ms                </td>            </tr>            <tr>                <td rowspan="3" class="custom-table-category">测试6</td>                <td>12</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td class="custom-table-cross">√</td>                <td>CustomStructs</td>            </tr>            <tr>                <td class="custom-table-subheader">单线程</td>                <td colspan="4" class="custom-table-formula">                    (0.2403/11+0.2195/11+0.1903/11+0.2078/11+0.1840/11+0.1850/11+0.1917/11+0.1984/11+0.1956/11+0.2035/11+0.2081/11+0.2137/11+0.2075/11+0.1892/11+0.2015/11+0.1949/11+0.2776/11+0.2533/11+0.2090/11+0.2211/11)/20 ≈ 0.01905ms                    (0.1960/11+0.2208/11+0.2386/11+0.2135/11+0.2000/11+0.1977/11+0.2291/11+0.2151/11+0.1998/11+0.1880/11+0.1861/11+0.2405/11+0.2101/11+0.1898/11+0.1945/11+0.2161/11+0.2081/11+0.2079/11+0.2975/11+0.2431/11)/20 ≈ 0.01951ms                </td>            </tr>            <tr>                <td class="custom-table-subheader">多线程并发</td>                <td colspan="4" class="custom-table-formula">                    (178/11+152/11+159/11+126/11+176/11+126/11+150/11+159/11+160/11+149/11+157/11+152/11+164/11+151/11+171/11+163/11+156/11+178/11+131/11+144/11)/20 ≈ 14.1000ms                    (142/11+162/11+156/11+157/11+160/11+169/11+144/11+133/11+150/11+120/11+122/11+149/11+120/11+158/11+136/11+125/11+171/11+156/11+135/11+137/11)/20 ≈ 13.1909ms                </td>            </tr>        </tbody>    </table></div><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Threading;<br><span class="hljs-keyword">using</span> System.Reflection;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Test2</span><br>&#123;<br>    <span class="hljs-comment">//食物工厂，这是一个泛型工厂，可以生产所有继承了Food类的食物</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">TestFactory3</span> : <span class="hljs-title">IFactory</span>&lt;<span class="hljs-title">Food</span>&gt;<br>    &#123;<br>        <span class="hljs-comment">//记录该工厂所生产的产品有多少种，如果涉及多个生产线，就需要采用数组</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> typesCount = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">//单例模式，用于获取工厂实例</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">TestFactory3</span>()</span> &#123; &#125;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestFactoryHandler</span><br>        &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> TestFactory3 instance = <span class="hljs-keyword">new</span> TestFactory3();<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> TestLine3 testLine = <span class="hljs-keyword">new</span> TestLine3(typesCount);<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TestFactory3 <span class="hljs-title">GetInstance</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> p_typesCount</span>)</span><br>        &#123;<br>            typesCount = p_typesCount;<br>            <span class="hljs-keyword">return</span> TestFactoryHandler.instance;<br>        &#125;<br><br>        <span class="hljs-comment">//生产产品的公开方法，需要告诉生产线所要生产的产品类型</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Food <span class="hljs-title">Create</span>(<span class="hljs-params">Type p_type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> TestFactoryHandler.testLine.StartLine(p_type);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//食物生产线，这是一个食物生产线，对于生产过程相同的食物可以用同一个生产线，但是对于生产过程不同的食物应该定义不同的生产线</span><br>    <span class="hljs-comment">//假设我们所要生产的Bread和Biscuit的生产过程相同</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">TestLine3</span> : <span class="hljs-title">ILine</span>&lt;<span class="hljs-title">Food</span>&gt;<br>    &#123;<br>        <span class="hljs-comment">//记录该生产线所生产的产品有多少种</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> typesCount = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//自定义静态存储结构CustomStructs</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CustomStructs cis;<br>        <span class="hljs-comment">//访问锁</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> k_getmakeinfo = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> k_createfood = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br><br>        <span class="hljs-comment">//用构造函数进行初始化</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestLine3</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> p_typesCount</span>)</span><br>        &#123;<br>            typesCount = p_typesCount;<br>            cis = <span class="hljs-keyword">new</span> CustomStructs(typesCount);<br>        &#125;<br><br>        <span class="hljs-comment">//启动生产过程的方法，其中包括了所有生产过程的调用以及调用条件</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> Food <span class="hljs-title">StartLine</span>(<span class="hljs-params">Type p_type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">lock</span> (k_getmakeinfo)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!GetMakeInfo(p_type)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-keyword">lock</span> (k_createfood)<br>            &#123;<br>                <span class="hljs-keyword">return</span> MakeFood(p_type);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//具体的生产过程之一，获取生产资料和食物原料（中间处理逻辑）</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">GetMakeInfo</span>(<span class="hljs-params">Type p_type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (!cis.Contains(p_type))<br>            &#123;<br>                ConstructorInfo ci = p_type.GetConstructor(<span class="hljs-keyword">new</span> Type[<span class="hljs-number">0</span>]);<br>                <span class="hljs-keyword">if</span> (ci == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    cis.Add(p_type, ci);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//具体的生产过程之一，制作食物</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> Food <span class="hljs-title">MakeFood</span>(<span class="hljs-params">Type p_type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> (Food)cis[p_type].Invoke(<span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//食物之一，Bread</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">TestBread</span> : <span class="hljs-title">Food</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Eat</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;The bread tastes delicious.&quot;</span>);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">//食物之一，Biscuit</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">TestBiscuit</span> : <span class="hljs-title">Food</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Eat</span>()</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;The biscuit tastes delicious.&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//工厂接口，所有工厂都需要实现这个接口</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IFactory</span>&lt;<span class="hljs-title">T</span>&gt;<br>    &#123;<br>       <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">Create</span>(<span class="hljs-params">Type p_type</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//生产线接口，所有生产线都需要实现这个接口</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ILine</span>&lt;<span class="hljs-title">T</span>&gt;<br>    &#123;<br>       <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">StartLine</span>(<span class="hljs-params">Type p_type</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//食物抽象类，所有食物需要继承该类</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Food</span><br>    &#123;<br>       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Eat</span>()</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//自定义静态存储结构</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomStruct</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> Type type;<br>        <span class="hljs-keyword">public</span> ConstructorInfo ci;<br>    &#125;<br>    <br>    <span class="hljs-comment">//自定义静态存储结构</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomStructs</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> CustomStruct[] cis;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> capacity &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> count &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomStructs</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> p_capacity</span>)</span><br>        &#123;<br>            capacity = p_capacity;<br>            cis = <span class="hljs-keyword">new</span> CustomStruct[p_capacity];<br>            count = <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//重写索引器，可以直接通过Type下标访问</span><br>        <span class="hljs-keyword">public</span> ConstructorInfo <span class="hljs-keyword">this</span>[Type type]<br>        &#123;<br>            <span class="hljs-keyword">get</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (capacity == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">foreach</span> (CustomStruct item <span class="hljs-keyword">in</span> cis)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (item.type.Equals(type)) <span class="hljs-keyword">return</span> item.ci;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-keyword">set</span><br>            &#123;<br>                <span class="hljs-keyword">foreach</span> (CustomStruct item <span class="hljs-keyword">in</span> cis)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (item.type.Equals(type))<br>                    &#123;<br>                        item.ci = <span class="hljs-keyword">value</span>;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//添加元素</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params">Type p_type, ConstructorInfo p_ci</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (capacity != <span class="hljs-number">0</span> &amp;&amp; count &lt; capacity)<br>            &#123;<br>                cis[count] = <span class="hljs-keyword">new</span> CustomStruct();<br>                cis[count].type = p_type;<br>                cis[count].ci = p_ci;<br>                count++;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//检测是否包含对应Type类型元素</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Contains</span>(<span class="hljs-params">Type p_type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">foreach</span> (CustomStruct item <span class="hljs-keyword">in</span> cis)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">if</span> (item.type.Equals(p_type)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//测试代码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Test</span><br>    &#123;<br>        <span class="hljs-comment">//所生产的产品类型，我们这里有Bread和Biscuit</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Type[] types = &#123; <span class="hljs-keyword">typeof</span>(TestBread), <span class="hljs-keyword">typeof</span>(TestBiscuit) &#125;;<br><br>        <span class="hljs-comment">//单例模式结合工厂模式，获取工厂，并且需要告诉工厂当前需要生产多少种产品</span><br>        <span class="hljs-keyword">private</span> IFactory&lt;Food&gt; factory = TestFactory3.GetInstance(types.Length);<br><br>        <span class="hljs-comment">//用于记录运行至当前线程总耗时的变量</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> sum = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Thread t1 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">0</span>]);<br>                DateTime endTime = DateTime.Now;<br>            &#125;);<br>            t1.Name = <span class="hljs-string">&quot;t1&quot;</span>;<br>            Thread t2 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">1</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t2.Name = <span class="hljs-string">&quot;t2&quot;</span>;<br>            Thread t3 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">0</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t3.Name = <span class="hljs-string">&quot;t3&quot;</span>;<br>            Thread t4 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">1</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t4.Name = <span class="hljs-string">&quot;t4&quot;</span>;<br>            Thread t5 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">0</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t5.Name = <span class="hljs-string">&quot;t5&quot;</span>;<br>            Thread t6 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">1</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t6.Name = <span class="hljs-string">&quot;t6&quot;</span>;<br>            Thread t7 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">0</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t7.Name = <span class="hljs-string">&quot;t7&quot;</span>;<br>            Thread t8 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">1</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t8.Name = <span class="hljs-string">&quot;t8&quot;</span>;<br>            Thread t9 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">0</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t9.Name = <span class="hljs-string">&quot;t9&quot;</span>;<br>            Thread t10 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">1</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t10.Name = <span class="hljs-string">&quot;t10&quot;</span>;<br>            Thread t11 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">0</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t11.Name = <span class="hljs-string">&quot;t11&quot;</span>;<br>            Thread t12 = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>            &#123;<br>                DateTime beginTime = DateTime.Now;<br>                <span class="hljs-keyword">var</span> food = factory.Create(types[<span class="hljs-number">1</span>]);<br>                DateTime endTime = DateTime.Now;<br>                sum += endTime.Subtract(beginTime).TotalMilliseconds;<br>                Console.WriteLine(<span class="hljs-string">&quot;sum:&quot;</span> + sum);<br>            &#125;);<br>            t12.Name = <span class="hljs-string">&quot;t12&quot;</span>;<br>            t1.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t2.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t3.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t4.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t5.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t6.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t7.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t8.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t9.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t10.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t11.Start();<br>            <span class="hljs-comment">// Thread.Sleep(100);</span><br>            t12.Start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>TestFactory3是我们的食物工厂，创建工厂时需要告诉工厂我们需要生产几种食物，我们要生产TestBread和TestBiscuit两种食物，按照实际情况Bread和Biscuit的生产过程是存在差异的，正常生产中通常也是两条生产线分别进行生产，这里为了简单我们就只建立一条生产线TestLine3，我们假设这个生产线能够生产这两种食物。我们直接调用Factory的Create的方法，并且传递一个Type类型参数，告诉工厂我们要生产什么类型的食物，而我们的工厂通过StartLine方法告诉生产线要生产什么类型的食物。我们这里对食物生产过程进行了简化，分为GetMakeInfo和MakeFood两个过程，并且我们要求二者按照顺序有序分步执行，这就是分步制作流程的体现。GetMakeInfo也就是获取泛型信息的过程，因为我们使用了静态存储，并且我们使用了自定义的静态存储结构CustomStructs，我们先检查静态存储结构中是否存在我们要生产的食物的信息，如果不存在则添加，然后进行下一步MakeFood操作，实际上这个操作我们依旧是调用反射创建对象。本次实验主要做出的改进就是将调用反射创建对象前反复获取反射信息的过程进行了静态化存储，同时针对多线程采用了分步制作流程来提升效率。结合我们的示例来说就是，我们这次生产了Bread和Biscuit两种食物并且对这两种食物的信息进行静态化存储，下一次如果需要再次生产这两种食物之一，则只需要从静态存储结构中获取即可，这就避免了重复通过反射获取反射信息的问题，其次，我们可能存在多个线程访问工厂生产食物，首先我们这里把食物的生产流程分为获取生产资料和制作两个过程，每个线程生产食物都需要经过这两个过程，多线程访问就必然存在资源访问冲突的问题，所以我们对食物生产的这两个过程分别加上了不同的访问锁。这里就有一个疑问了，我们完全可以只使用一个访问锁，让每个线程一次性完成所有生产流程把食物生产出来后再释放访问锁，为什么要给每个生产过程都加上不同的访问锁呢？如果我们这么做就会导致一个资源浪费的问题，第一个线程获取了生产资料，接下来要制作食物，那么这个时候获取生产资料这个过程就空闲了，我们完全可以让其它线程进入这个过程同样来获取生产资料，而不是所有线程都等着第一个线程完全把食物生产出来，所以我们可以让每个生产过程都可以被独立访问，而不是让所有生产过程捆绑在一起，这样就可以进一步缓解资源浪费的问题。当然本次实验中由于我们仅仅把生产过程分为了两个过程，所以没有很好体现出分步制作流程的优势，在后续实验中，我会做出进一步改进，本次实验存在诸多不足，希望有大佬能够不吝赐教和作出指正，谢谢。</p>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Memento Pattern（备忘录模式、存档点模式）</title>
      
      <link href="/posts/2026/01/07/f5b715c04de7/"/>
      <url>/posts/2026/01/07/f5b715c04de7/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>备忘录模式是一种行为型设计模式，它允许对象在不暴露其内部状态的情况下捕获和恢复其状态。该模式通常用于实现撤销机制。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>文本编辑器的撤销功能、图形设计工具的历史记录、数据库事务管理、游戏状态管理、配置管理、日历应用的日程记录和命令模式的辅助等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>发起人（Originator）：</strong> 负责创建一个包含当前状态的备忘录对象，并可以使用备忘录对象恢复其状态。</p><p><strong>备忘录（Memento）：</strong> 用于存储发起人对象的内部状态。备忘录对象提供一种机制，允许发起人将其状态恢复到先前的状态。</p><p><strong>管理者（Caretaker）：</strong> 负责保存备忘录对象。管理者可以保存多个备忘录对象，但通常仅在需要的情况下保存最新的状态。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>创建备忘录：</strong> 发起人创建一个备忘录对象，并将其状态设置为当前状态。</p></li><li><p><strong>存储备忘录：</strong> 管理者将备忘录对象保存起来。通常，管理者保存一个备忘录对象，但也可以保存多个以实现多次撤销的功能。</p></li><li><p><strong>恢复状态：</strong> 当需要恢复到先前的状态时，发起人从管理者那里获取相应的备忘录对象，并将其状态恢复。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="文本备忘录对象：TextMemento-cs"><a href="#文本备忘录对象：TextMemento-cs" class="headerlink" title="文本备忘录对象：TextMemento.cs"></a>文本备忘录对象：TextMemento.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Text;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">MementoPattern</span>;<br><br><span class="hljs-comment">// 文本备忘录对象</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">TextMemento</span><br>&#123;<br>    <span class="hljs-comment">// 文本内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> text &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TextMemento</span>(<span class="hljs-params">StringBuilder text</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.text = text.ToString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="备忘录对象管理器：MementoManager-cs"><a href="#备忘录对象管理器：MementoManager-cs" class="headerlink" title="备忘录对象管理器：MementoManager.cs"></a>备忘录对象管理器：MementoManager.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Text;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">MementoPattern</span>;<br><br><span class="hljs-comment">// 文本备忘录对象管理器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">MementoManager</span><br>&#123;<br>    <span class="hljs-comment">// 文本备忘录对象集合</span><br>    <span class="hljs-keyword">private</span> Stack&lt;TextMemento&gt; mementos;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MementoManager</span>()</span><br>    &#123;<br>        mementos = <span class="hljs-keyword">new</span> Stack&lt;TextMemento&gt;();<br>    &#125;<br><br>    <span class="hljs-comment">// 保存当前文本状态</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SaveState</span>(<span class="hljs-params">StringBuilder text</span>)</span><br>    &#123;<br>        mementos.Push(<span class="hljs-keyword">new</span> TextMemento(text));<br>    &#125;<br><br>    <span class="hljs-comment">// 回溯到上一个文本状态</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BackToPreState</span>(<span class="hljs-params">StringBuilder text</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (mementos.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            text.Clear();<br>            text.Append(mementos.Pop().text);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="文本编辑器：TextEditor-cs"><a href="#文本编辑器：TextEditor-cs" class="headerlink" title="文本编辑器：TextEditor.cs"></a>文本编辑器：TextEditor.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Text;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">MementoPattern</span>;<br><br><span class="hljs-comment">// 文本编辑器</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">TextEditor</span><br>&#123;<br>    <span class="hljs-keyword">private</span> MementoManager manager; <span class="hljs-comment">// 文本备忘录对象管理器</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TextEditor</span>()</span><br>    &#123;<br>        manager = <span class="hljs-keyword">new</span> MementoManager();<br>    &#125;<br><br>    <span class="hljs-comment">// 保存</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params">StringBuilder text</span>)</span><br>    &#123;<br>        manager.SaveState(text);<br>    &#125;<br><br>    <span class="hljs-comment">// 撤销</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Undo</span>(<span class="hljs-params">StringBuilder text</span>)</span><br>    &#123;<br>        manager.BackToPreState(text);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 21.备忘录模式测试 **************</span><br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> MementoPattern;<br><br><span class="hljs-comment">// 创建实例</span><br>TextEditor textEditor = <span class="hljs-keyword">new</span> TextEditor();<br>StringBuilder text = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">&quot;Hello world!&quot;</span>);<br><br><span class="hljs-comment">// 保存文本并输出文本</span><br>textEditor.Save(text);<br>Console.WriteLine(text);<br><br><span class="hljs-comment">// 向文本添加内容并输出文本</span><br>text.Append(<span class="hljs-string">&quot; I am Jack.&quot;</span>);<br>Console.WriteLine(text);<br><br><span class="hljs-comment">// 撤销文本操作并输出文本</span><br>textEditor.Undo(text);<br>Console.WriteLine(text);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码简单模拟了文本编辑器保存和撤销的功能。文本编辑器提供保存和撤销功能接口，保存功能会将当前文本的内容封装为一个文本备忘录对象，然后在备忘录对象管理器中入栈管理，撤销功能则是让备忘录对象管理器完成一次文本备忘录对象的出栈，并解析读取文本备忘录对象的文本内容，赋值给可变的文本对象。</p><p>细心的小伙伴应该注意到了上面的StringBuilder，这个类是官方提供的用于实现可变字符串需求的，虽然string类型从外部看来也可变，但是它实际上是通过字符串拼接然后返回新的字符串对象来完成“可变”的，而StringBuilder则是在原有字符串基础上直接修改，感兴趣的话可以在网上查阅一下二者更具体的区别，这里就不赘述了。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>设计模式代码示例合集</title>
      
      <link href="/posts/2026/01/07/54cbe1268a9d/"/>
      <url>/posts/2026/01/07/54cbe1268a9d/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本篇包括了本栏目所有设计模式的完整代码示例，所使用的编程语言是C#，可以使用VSCode或VisualStudio工具打开代码示例合集，这里提供了两个下载链接。</p></blockquote><p><a href="https://github.com/JokeVallen/CSDN_Resources.git">GitHub</a><br><a href="https://pan.baidu.com/s/1WmpR0E5EOqOG3ukogDOwXA?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>TemplateMethod Pattern（模板方法模式）</title>
      
      <link href="/posts/2026/01/07/ac30b3133bac/"/>
      <url>/posts/2026/01/07/ac30b3133bac/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>模板方法模式是一种行为型设计模式。父类规定业务逻辑的框架，将框架中的步骤抽象为模板方法，将具体的步骤交给子类实现或重写，每个步骤的调用由父类决定。对于业务逻辑的架构相似而具体实现不同的需求则可以考虑采用模板方法模式。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>框架设计、算法实现、文档生成、游戏开发和生命周期管理等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>抽象类（Abstract Class）：</strong> 定义了算法的骨架，包括一个模板方法和若干个抽象方法。抽象方法由子类实现，而模板方法在抽象类中定义了算法的结构，包括一系列步骤。</p><p><strong>具体类（Concrete Class）：</strong> 实现了抽象类中定义的抽象方法，完成算法中具体的细节。每个具体类可以提供不同的实现，以满足特定的需求。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>模板方法定义算法骨架：</strong> 抽象类中的模板方法定义了算法的结构，包括一系列步骤。这些步骤可以包括具体的方法和抽象方法。</p></li><li><p><strong>抽象方法由子类实现：</strong> 抽象类中的抽象方法由具体的子类实现，这样不同的子类可以提供不同的实现细节。</p></li><li><p><strong>模板方法负责调用步骤：</strong> 模板方法按照算法的结构调用定义的各个步骤，包括具体方法和抽象方法。这确保了算法的基本流程在不同的子类中保持一致。</p></li><li><p><strong>子类定制具体步骤：</strong> 具体的子类通过实现抽象方法来定制算法的具体步骤，以满足特定的需求。子类可以选择性地覆盖某些步骤，而保留其他步骤不变。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="饮品模板：BeverageTemplate-cs"><a href="#饮品模板：BeverageTemplate-cs" class="headerlink" title="饮品模板：BeverageTemplate.cs"></a>饮品模板：BeverageTemplate.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">TemplateMethodPattern</span>;<br><br><span class="hljs-comment">// 制作饮品的模板</span><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BeverageTemplate</span><br>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">string</span> name; <span class="hljs-comment">// 饮品名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BeverageTemplate</span>()</span><br>    &#123;<br>        name = <span class="hljs-string">&quot;饮品&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 制作饮品</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MakeBeverage</span>()</span><br>    &#123;<br>        BoilWater();<br>        Prepare();<br>        AddCondiments();<br>        PutIntoCup();<br>        Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>制作完成了!&quot;</span>);<br>        Console.WriteLine(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-number">20</span>));<br>    &#125;<br><br>    <span class="hljs-comment">// 烧水</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BoilWater</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;正在烧水...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 装杯</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">PutIntoCup</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>正在装入杯中...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 冲调</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Prepare</span>()</span>;<br><br>    <span class="hljs-comment">// 加入调味品</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddCondiments</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="饮品：Beverage-cs"><a href="#饮品：Beverage-cs" class="headerlink" title="饮品：Beverage.cs"></a>饮品：Beverage.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">TemplateMethodPattern</span>;<br><br><span class="hljs-comment">// 果汁</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Juice</span> : <span class="hljs-title">BeverageTemplate</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Juice</span>()</span><br>    &#123;<br>        name = <span class="hljs-string">&quot;果汁&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Prepare</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>正在冲调...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddCondiments</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>正在加入调味品...&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 茶</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Tea</span> : <span class="hljs-title">BeverageTemplate</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Tea</span>()</span><br>    &#123;<br>        name = <span class="hljs-string">&quot;茶&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Prepare</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>正在冲调...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddCondiments</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;name&#125;</span>正在加入调味品...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 22.模板方法模式测试 **************</span><br><span class="hljs-keyword">using</span> TemplateMethodPattern;<br><br><span class="hljs-comment">// 创建实例</span><br>Juice juice = <span class="hljs-keyword">new</span> Juice();<br>Tea tea = <span class="hljs-keyword">new</span> Tea();<br><br><span class="hljs-comment">// 制作果汁</span><br>juice.MakeBeverage();<br><br><span class="hljs-comment">// 制作茶</span><br>tea.MakeBeverage();<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码模拟了制作果汁和茶的过程。饮品模板定义了制作饮品的四个步骤，烧水、冲调、加调味品和装杯，通常烧水和装杯步骤不会因为饮品不同而有所改变，但是冲调和加调味品步骤可能会各有不同。由于制作饮品的步骤顺序一致，所以饮品模板仅向外提供一个制作饮品的方法作为接口，从而简化调用。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>State Pattern（状态模式）</title>
      
      <link href="/posts/2026/01/07/4e276f9bde77/"/>
      <url>/posts/2026/01/07/4e276f9bde77/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>状态模式是一种行为型设计模式，适用于对象内部状态发生改变时需要表现出不同的行为，使得行为与状态相对应，并对二者进行解耦。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>有限状态机、订单处理、文档编辑器、电梯控制系统、线程管理和游戏开发等。</p><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><strong>Context（上下文）：</strong> 定义客户端感兴趣的接口，并维护一个具体状态类的实例，即当前状态对象。</p><p><strong>State（状态）：</strong> 定义一个接口或抽象类，封装与Context的一个特定状态相关的行为。</p><p><strong>ConcreteState（具体状态）：</strong> 实现State接口或继承State抽象类，每一个具体状态类对应Context的一个具体状态，负责实现与该状态相关的行为。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul><li><p><strong>Context委托行为：</strong> Context对象内部维护一个对当前状态对象的引用，而客户端与Context进行交互。Context将客户端的请求委托给当前状态对象来处理。</p></li><li><p><strong>状态切换：</strong> 当Context对象的状态发生变化时，它会切换到新的具体状态对象。这个切换过程可能是由Context自身管理，也可能由具体状态类来管理，具体取决于实现。</p></li><li><p><strong>状态间的解耦：</strong> 状态模式的关键在于将不同状态的行为封装在不同的状态类中，从而使得Context的行为与其状态无关，实现了状态与行为的解耦。</p></li><li><p><strong>灵活性和可扩展性：</strong> 状态模式使得增加新的状态变得相对容易，因为可以添加新的具体状态类而不需要修改Context的代码。这也使得状态模式对于扩展系统的状态和行为变得非常灵活。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><blockquote><p>​提示：可在本栏目的资源篇“设计模式代码示例合集”下载所有完整代码资源。</p></blockquote><h3 id="灯的状态：LightState-cs"><a href="#灯的状态：LightState-cs" class="headerlink" title="灯的状态：LightState.cs"></a>灯的状态：LightState.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">StatePattern</span>;<br><br><span class="hljs-comment">// 灯的状态</span><br><span class="hljs-built_in">enum</span> LightState<br>&#123;<br>    TurnOn, TurnOff<br>&#125;<br><br><span class="hljs-comment">// 灯的状态接口</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title">ILightState</span><br>&#123;<br>    <span class="hljs-comment">// 处理逻辑</span><br>    <span class="hljs-function">LightState <span class="hljs-title">Handle</span>()</span>;<br>&#125;<br><br><span class="hljs-comment">// 开灯状态</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">TurnOn</span> : <span class="hljs-title">ILightState</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> LightState <span class="hljs-title">Handle</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;正在开灯...&quot;</span>);<br>        <span class="hljs-keyword">return</span> LightState.TurnOn;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 关灯状态</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">TurnOff</span> : <span class="hljs-title">ILightState</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> LightState <span class="hljs-title">Handle</span>()</span><br>    &#123;<br>        Console.WriteLine(<span class="hljs-string">&quot;正在关灯...&quot;</span>);<br>        <span class="hljs-keyword">return</span> LightState.TurnOff;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="灯：Light-cs"><a href="#灯：Light-cs" class="headerlink" title="灯：Light.cs"></a>灯：Light.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">StatePattern</span>;<br><br><span class="hljs-comment">// 灯</span><br><span class="hljs-keyword">class</span> <span class="hljs-title">Light</span><br>&#123;<br>    <span class="hljs-comment">// 灯的状态</span><br>    <span class="hljs-keyword">public</span> LightState state &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-keyword">private</span> ILightState turnOn; <span class="hljs-comment">// 开灯状态</span><br>    <span class="hljs-keyword">private</span> ILightState turnOff; <span class="hljs-comment">//关灯状态</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Light</span>()</span><br>    &#123;<br>        state = LightState.TurnOff;<br>        turnOn = <span class="hljs-keyword">new</span> TurnOn();<br>        turnOff = <span class="hljs-keyword">new</span> TurnOff();<br>    &#125;<br><br>    <span class="hljs-comment">// 改变灯的状态</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ChangeState</span>(<span class="hljs-params">LightState lightState</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (lightState == LightState.TurnOn) state = turnOn.Handle();<br>        <span class="hljs-keyword">else</span> state = turnOff.Handle();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码：Program-cs"><a href="#测试代码：Program-cs" class="headerlink" title="测试代码：Program.cs"></a>测试代码：Program.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ************* 23.状态模式测试 **************</span><br><span class="hljs-keyword">using</span> StatePattern;<br><br><span class="hljs-comment">// 创建实例</span><br>Light light = <span class="hljs-keyword">new</span> Light();<br><br><span class="hljs-comment">// 输出灯当前的状态</span><br>Console.WriteLine(<span class="hljs-string">&quot;Light state:&quot;</span> + light.state);<br><br><span class="hljs-comment">// 开灯并输出灯当前的状态</span><br>light.ChangeState(LightState.TurnOn);<br>Console.WriteLine(<span class="hljs-string">&quot;Light state:&quot;</span> + light.state);<br><br><span class="hljs-comment">// 关灯并输出灯当前的状态</span><br>light.ChangeState(LightState.TurnOff);<br>Console.WriteLine(<span class="hljs-string">&quot;Light state:&quot;</span> + light.state);<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述代码模拟了灯的开关状态。开灯和关灯状态实现统一的接口方法，灯保留两种状态的实例，当灯的状态改变时，会在控制台打印输出不同的信息。状态改变会表现出不同的行为。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>Python打包窗口图标丢失修复工具</title>
      
      <link href="/posts/2026/01/07/b03f2a4afbfc/"/>
      <url>/posts/2026/01/07/b03f2a4afbfc/</url>
      
        <content type="html"><![CDATA[<p><strong>工具名称：</strong> Python打包窗口图标丢失修复工具（PackTool）</p><p><strong>工具版本：</strong> 1.01</p><p><strong>功能介绍：</strong></p><ol><li><p>能够将ico文件转换为二进制内容，然后将二进制内容保存在py文件中</p></li><li><p>能够将py文件中对应的二进制内容转换为ico文件</p></li><li><p>能够作为API进行直接调用</p></li></ol><p><strong>工具截图：</strong></p><img src="/posts/2026/01/07/b03f2a4afbfc/img1.png" class="" width="450" height="530"><p><strong>资源下载：</strong></p><p><a href="https://github.com/JokeVallen/UsefulTools.git">GitHub</a><br><a href="https://pan.baidu.com/s/1vRUROjQ3KXrhWvoAhkXwXw?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> 小工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity摄像机对象锁定旋转运镜模拟</title>
      
      <link href="/posts/2026/01/07/474dfb17857f/"/>
      <url>/posts/2026/01/07/474dfb17857f/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在3D模式下如何模拟实现Unity摄像机对象锁定旋转运镜，可以分为两个部分，第一是实现对象锁定，第二是实现旋转运镜。对象锁定就是无论摄像机如何运动，始终保持对象位于摄像机成像区域的固定位置，旋转运镜就是使得摄像机围绕对象进行旋转运动。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><img src="/posts/2026/01/07/474dfb17857f/img1.jpeg" class="" width="250" height="250"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图1</div><p>从图1我们可以把摄像机的运动定格到两个状态，status2可以看作status1一帧后摄像机的运动位置和状态，摄像机始终存在一个速度v并且要求这个速度始终沿着圆的切线方向，这样我们才能实现摄像机的旋转运镜，实际上我们只是给摄像机一个status1所示方向上的速度，之所以出现图1中status2的情景，是因为我们对摄像机进行了旋转，否则摄像机就会始终按照图2所示的方式运动。</p><img src="/posts/2026/01/07/474dfb17857f/img2.jpeg" class="" width="250" height="250"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图2</div><img src="/posts/2026/01/07/474dfb17857f/img3.jpeg" class="" width="250" height="250"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图3</div><p>图3所示是模拟了摄像机的坐标系，这个正方体就代表摄像机，图中的坐标系是摄像机的Local坐标系，z轴指向的是摄影区域的中点，我们结合图1和图3，假设给摄像机施加了一个x轴方向的速度v，那么我们就需要以y轴为轴线对摄像机进行旋转，使得z轴始终指向我们要锁定的游戏对象。</p><p>对于对象锁定，我们知道摄像机有一个摄像区域，位于这个区域内的物体才会显示到成像区域中，在Unity中这个区域可以是一个长方体也可以是一个四棱锥，我们将之投影到摄像机Local坐标系的x和y轴构成的二维平面上，在默认参数下则二者的成像区域都是一个长方形A（如图4），蓝色的圆就代表锁定的游戏对象。</p><img src="/posts/2026/01/07/474dfb17857f/img4.jpeg" class="" width="250" height="250"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">图4</div><p>对于摄像机的Local坐标系，无论我们怎么旋转摄像机，z轴都始终指向长方形A的中点，所以说到这里我想你应该想到了对象锁定的实现思路了，假设我们就让对象锁定在成像区域（即长方形A）的中点，那么我们就需要让摄像机进行旋转使得摄像机的Local坐标系的z轴指向我们要锁定的游戏对象。</p><p>对于旋转运镜，具体我们要让摄像机旋转多少角度，这里进行了一个近似处理，因为我们是每一帧进行一次更新，图2展示的是在没有进行旋转的情况下摄像机的运动，此时status2是status1的下一帧摄像机的位置和状态，在一帧的情况下图2中的status2和status1非常接近，就好比“微分思想”一样，如此我们可以将图2转换为一个直角三角形。假设锁定的游戏对象的世界坐标为(x1,y1,z1)，status1时摄像机的世界坐标为(x2,y2,z2)，status2时摄像机的世界坐标为(x3,y3,z3)，就有以下结论：</p><img src="/posts/2026/01/07/474dfb17857f/img5.jpeg" class=""><p>如果摄像机是按照图1所示逆时针运动，那么摄像机从status1到status2针对Local坐标系所需要旋转的角度就是-θ，我们已知cosθ的值，就可以计算出θ。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CameraLookAt</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要组件&quot;</span>)</span>]<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;相机注视对象&quot;</span>)</span>] <span class="hljs-keyword">public</span> Transform LookAtObject;<br>    [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要属性&quot;</span>)</span>]<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;相机移动速度&quot;</span>), Range(1, 10), SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> MoveSpeed;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> d1;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> d2;<br>    <span class="hljs-keyword">private</span> Vector3 lookAtPos;<br>    <span class="hljs-keyword">private</span> Vector3 mPos;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> mAngle;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        lookAtPos = LookAtObject.position;<br>        mPos = transform.position;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FixedUpdate</span>()</span><br>    &#123;<br>        Move();<br>        AngleUpdate();<br>        Rotation();<br>    &#125;<br><br>    <span class="hljs-comment">//摄像机移动</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Move</span>()</span><br>    &#123;<br>        transform.Translate(MoveSpeed * Time.fixedDeltaTime, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//角度更新</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AngleUpdate</span>()</span><br>    &#123;<br>        d1 = Mathf.Pow(mPos.x - lookAtPos.x, <span class="hljs-number">2</span>) + Mathf.Pow(mPos.y - lookAtPos.y, <span class="hljs-number">2</span>) + Mathf.Pow(mPos.z - lookAtPos.z, <span class="hljs-number">2</span>);<br>        mPos = transform.position;<br>        d2 = Mathf.Pow(mPos.x - lookAtPos.x, <span class="hljs-number">2</span>) + Mathf.Pow(mPos.y - lookAtPos.y, <span class="hljs-number">2</span>) + Mathf.Pow(mPos.z - lookAtPos.z, <span class="hljs-number">2</span>);<br>        mAngle += Mathf.Acos(Mathf.Sqrt(d1 / d2)) * <span class="hljs-number">180</span> / Mathf.PI;<br>    &#125;<br><br>    <span class="hljs-comment">//摄像机旋转</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Rotation</span>()</span><br>    &#123;<br>        transform.localRotation = Quaternion.Euler(<span class="hljs-number">0</span>, -mAngle, <span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115840989135888&bvid=BV1BCisBoEax&cid=35199779544&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们发现要实现Unity摄像机对象锁定旋转运镜模拟的代码很简单，主要就是摄像机的移动Move、角度更新AngleUpdate、摄像机的旋转Rotation，针对我这里为什么没有把三个方法的调用放在Update中而是放在了FixedUpdate中，起初我确实是放在Update中执行的，但是出现了Unity编辑器出现了错误提示，我们这里涉及到cosθ的计算，但是经过我的检测发现期间cosθ的值居然出现了大于1的情况，这显然是不正确的，Update是按照固定的帧率执行的，这并不符合我们运行的物理设备的实际帧率，所以就需要执行FixedUpdate对我们的执行频率进行修正。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>A-Star算法探索和实现（一）</title>
      
      <link href="/posts/2026/01/07/ee2b157ff0c4/"/>
      <url>/posts/2026/01/07/ee2b157ff0c4/</url>
      
        <content type="html"><![CDATA[<blockquote><p>提醒：A-Star算法探索和实现系列博文不具备参考价值，仅仅作为个人探索和尝试的记录！</p></blockquote><h2 id="什么是A-Star算法？"><a href="#什么是A-Star算法？" class="headerlink" title="什么是A-Star算法？"></a>什么是A-Star算法？</h2><p>A*搜寻算法俗称A星算法，又叫A-Star算法。A*算法是比较流行的启发式搜索算法之一，被广泛应用于路径优化领域（引用自百度百科）。在游戏开发中，我们可以将A*算法作为一种敌人的寻路算法，在伊庭齐志所著的《AI游戏开发和深度学习进阶》中有关于A*算法在各种游戏中的运用。如果对A-Star算法不是很了解，推荐浏览这两篇博文，一篇是英文原著，一篇是针对该英文原著的汉译版本。</p><p><a href="https://www.gamedev.net/reference/articles/article2003.asp">英文原著</a> <a href="http://www.cppblog.com/mythit/archive/2009/04/19/80492.aspx">英文原著汉译版本</a></p><h2 id="A-Star算法的思路"><a href="#A-Star算法的思路" class="headerlink" title="A-Star算法的思路"></a>A-Star算法的思路</h2><p>A*算法要求寻找到从起始点到终点的最佳路径，从起始点开始，首先以起始点作为当前点，开始收集当前点下一步可前往的点，保存为一个点集并对这些点的权值进行计算，然后以权值最小的点作为下一步要前往的点，将该点设为当前点再重复上述过程，直至到达终点。</p><h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><img src="/posts/2026/01/07/ee2b157ff0c4/img1.jpeg" class="" width="618" height="514"><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><img src="/posts/2026/01/07/ee2b157ff0c4/img2.jpeg" class="" width="642" height="542">  <img src="/posts/2026/01/07/ee2b157ff0c4/img3.jpeg" class="" width="642" height="542"><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Grid-py"><a href="#Grid-py" class="headerlink" title="Grid.py"></a>Grid.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> pp<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> matplotlib.pyplot <span class="hljs-keyword">import</span> MultipleLocator<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 视图的构建和绘制</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Grid</span>:<br>    <span class="hljs-comment"># 横纵坐标轴的刻度标记</span><br>    __xLabels = []<br>    __yLabels = []<br>    <span class="hljs-comment"># 网格单元格的信息</span><br>    __data = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 是否完成初始化</span><br>    __isInit = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_rowsCount, p_colsCount</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-comment"># 网格的行列数</span><br>            <span class="hljs-variable language_">self</span>.__rowsCount = p_rowsCount<br>            <span class="hljs-variable language_">self</span>.__colsCount = p_colsCount<br>            <span class="hljs-comment"># Node工厂</span><br>            <span class="hljs-variable language_">self</span>.__nodeFactory = node.NodeFactory()<br>            <span class="hljs-comment"># 将网格的行列数设置为共享信息</span><br>            sd.SharedData.rowsCount = <span class="hljs-variable language_">self</span>.__rowsCount<br>            sd.SharedData.colsCount = <span class="hljs-variable language_">self</span>.__colsCount<br>            <span class="hljs-comment"># 将终点Node设置为共享信息</span><br>            v_endNode = <span class="hljs-variable language_">self</span>.__nodeFactory.GetEndNode(<span class="hljs-variable language_">self</span>.__rowsCount, <span class="hljs-variable language_">self</span>.__colsCount)<br>            sd.SharedData.endNode = v_endNode<br>            <span class="hljs-variable language_">self</span>.__isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 绘制图形</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 获取坐标轴实例</span><br>        v_fig, v_ax = pp.subplots()<br>        <span class="hljs-variable language_">self</span>._AxisSet(v_ax)<br>        <span class="hljs-variable language_">self</span>._GridValueSet(v_ax)<br>        <span class="hljs-comment"># 将数据以二维图片的形式进行显示</span><br>        v_ax.imshow(<span class="hljs-variable language_">self</span>.__data, cmap=<span class="hljs-string">&#x27;Accent&#x27;</span>, vmin=<span class="hljs-number">0</span>, vmax=<span class="hljs-number">255</span>)<br>        <span class="hljs-comment"># 将网格和刻度线显示在多数artists上方</span><br>        v_ax.set_axisbelow(<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 标记起始点和终点</span><br>        <span class="hljs-variable language_">self</span>._StartPointSet(<span class="hljs-variable language_">self</span>.__nodeFactory.GetStartNode())<br>        <span class="hljs-variable language_">self</span>._PathNodeSet()<br>        <span class="hljs-variable language_">self</span>._EndPointSet(sd.SharedData.endNode)<br>        <span class="hljs-comment"># 布置网格线</span><br>        pp.grid(visible=<span class="hljs-literal">True</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br>        <span class="hljs-comment"># 采用紧凑型布局</span><br>        v_fig.tight_layout()<br>        pp.show()<br><br>    <span class="hljs-comment"># 标记起始点</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_StartPointSet</span>(<span class="hljs-params">self, p_node: node.Node</span>):<br>        <span class="hljs-variable language_">self</span>._Mark(p_node, <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;yo&#x27;</span>)<br><br>    <span class="hljs-comment"># 标记终点</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_EndPointSet</span>(<span class="hljs-params">self, p_node: node.Node</span>):<br>        <span class="hljs-variable language_">self</span>._Mark(p_node, <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;ro&#x27;</span>)<br><br>    <span class="hljs-comment"># 标记所查找到的路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PathNodeSet</span>(<span class="hljs-params">self</span>):<br>        v_pathNodes = sd.SharedData.pathNodes<br>        v_length = <span class="hljs-built_in">len</span>(v_pathNodes)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; i &lt; v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>._Mark(v_pathNodes[i], <span class="hljs-number">10</span>, <span class="hljs-string">&#x27;bo&#x27;</span>)<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br>            <span class="hljs-keyword">elif</span> i == v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br><br>    <span class="hljs-comment"># 标记方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Mark</span>(<span class="hljs-params">self, p_node: node.Node, p_marksize: <span class="hljs-built_in">int</span>, p_fmt: <span class="hljs-built_in">str</span></span>):<br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        pp.plot(v_x, v_y, p_fmt, markersize=p_marksize, zorder=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 箭头指向方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Arrow</span>(<span class="hljs-params">self, p_firstNode, p_secondNode</span>):<br>        v_dx = p_secondNode.nodePos.x - p_firstNode.nodePos.x<br>        v_dy = p_secondNode.nodePos.y - p_firstNode.nodePos.y<br>        pp.arrow(p_firstNode.nodePos.x, p_firstNode.nodePos.y, v_dx, v_dy, color=<span class="hljs-string">&#x27;orange&#x27;</span>, width=<span class="hljs-number">0.01</span>, head_width=<span class="hljs-number">0.08</span>,<br>                 zorder=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-comment"># 坐标轴设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AxisSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>.__xLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>.__yLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-comment"># 设置横坐标轴为bottom，纵坐标轴为left</span><br>        v_ax.xaxis.set_ticks_position(<span class="hljs-string">&#x27;bottom&#x27;</span>)<br>        v_ax.yaxis.set_ticks_position(<span class="hljs-string">&#x27;left&#x27;</span>)<br>        <span class="hljs-comment"># 隐藏边框</span><br>        v_ax.spines[<span class="hljs-string">&#x27;bottom&#x27;</span>].<span class="hljs-built_in">set</span>(visible=<span class="hljs-literal">False</span>)<br>        v_ax.spines[<span class="hljs-string">&#x27;right&#x27;</span>].<span class="hljs-built_in">set</span>(visible=<span class="hljs-literal">False</span>)<br>        v_ax.spines[<span class="hljs-string">&#x27;top&#x27;</span>].<span class="hljs-built_in">set</span>(visible=<span class="hljs-literal">False</span>)<br>        v_ax.spines[<span class="hljs-string">&#x27;left&#x27;</span>].<span class="hljs-built_in">set</span>(visible=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 隐藏刻度线</span><br>        v_ax.tick_params(left=<span class="hljs-literal">False</span>, bottom=<span class="hljs-literal">False</span>, top=<span class="hljs-literal">False</span>, right=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 坐标轴的刻度间隔实例</span><br>        v_xMinorLocator = MultipleLocator(<span class="hljs-number">1</span>)<br>        v_yMinorLocator = MultipleLocator(<span class="hljs-number">1</span>)<br>        v_low = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__rowsCount &gt; <span class="hljs-variable language_">self</span>.__colsCount:<br>            v_high = <span class="hljs-variable language_">self</span>.__rowsCount<br>        <span class="hljs-keyword">else</span>:<br>            v_high = <span class="hljs-variable language_">self</span>.__colsCount<br>        <span class="hljs-variable language_">self</span>.__data = np.random.randint(v_low, v_high, size=(<span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>))<br>        <span class="hljs-comment"># 设置横纵坐标轴的范围</span><br>        pp.xlim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__rowsCount)<br>        pp.ylim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount)<br>        <span class="hljs-comment"># 设置坐标轴的刻度标记</span><br>        v_ax.set_xticks(np.arange(<span class="hljs-variable language_">self</span>.__rowsCount), labels=<span class="hljs-variable language_">self</span>.__xLabels, visible=<span class="hljs-literal">False</span>)<br>        v_ax.set_yticks(np.arange(<span class="hljs-variable language_">self</span>.__colsCount), labels=<span class="hljs-variable language_">self</span>.__yLabels, visible=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 设置坐标轴的次要刻度间隔</span><br>        v_ax.xaxis.set_minor_locator(v_xMinorLocator)<br>        v_ax.yaxis.set_minor_locator(v_yMinorLocator)<br>        <span class="hljs-comment"># 设置坐标轴的横纵轴比例相等</span><br>        v_ax.set_aspect(<span class="hljs-string">&#x27;equal&#x27;</span>)<br><br>    <span class="hljs-comment"># 网格内容设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GridValueSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>):<br>                v_str = <span class="hljs-string">&#x27;(&#x27;</span> + <span class="hljs-built_in">str</span>(i + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(j + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;)&#x27;</span><br>                v_ax.text(i + <span class="hljs-number">0.5</span>, j + <span class="hljs-number">0.5</span>, v_str, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="Node-py"><a href="#Node-py" class="headerlink" title="Node.py"></a>Node.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><br><br><span class="hljs-comment"># Node坐标类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePosition</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_x: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span>, p_y: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span></span>):<br>        <span class="hljs-variable language_">self</span>.x = p_x<br>        <span class="hljs-variable language_">self</span>.y = p_y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;[&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.x) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.y) + <span class="hljs-string">&#x27;]&#x27;</span><br><br><br><span class="hljs-comment"># Node类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_nodeName: <span class="hljs-built_in">str</span>, p_nodePos: NodePosition</span>):<br>        <span class="hljs-variable language_">self</span>.nodeName = p_nodeName<br>        <span class="hljs-variable language_">self</span>.nodePos = p_nodePos<br>        <span class="hljs-comment"># f=g+h，g代表从上一个点到该点的代价和，h代表从该点到终点的代价和，f代表总权值weight</span><br>        <span class="hljs-variable language_">self</span>.f: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.g: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.h: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># 设置Node的权值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeight</span>(<span class="hljs-params">self, p_f: <span class="hljs-built_in">int</span>, p_g: <span class="hljs-built_in">int</span>, p_h: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-variable language_">self</span>.f = p_f<br>        <span class="hljs-variable language_">self</span>.g = p_g<br>        <span class="hljs-variable language_">self</span>.h = p_h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#123;nodeName:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeName + <span class="hljs-string">&#x27;,nodePos:&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.nodePos) + <span class="hljs-string">&#x27;,f=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.f) + <span class="hljs-string">&#x27;,g=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.g) + <span class="hljs-string">&#x27;,h=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.h) + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><br><br><span class="hljs-comment"># Node工厂，用来创建和获取起始点Node和终点Node</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeFactory</span>:<br>    __isCreateEndNode = <span class="hljs-literal">False</span><br>    __isCreateStartNode = <span class="hljs-literal">False</span><br>    __startNode: Node<br>    __endNode: Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-comment"># 获取起始点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetStartNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isCreateStartNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateStartNode()<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.__startNode<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateStartNode</span>(<span class="hljs-params">self</span>):<br>        v_nodePos = NodePosition(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)<br>        <span class="hljs-variable language_">self</span>.__startNode = Node(<span class="hljs-string">&#x27;StartNode&#x27;</span>, v_nodePos)<br>        <span class="hljs-variable language_">self</span>.__isCreateStartNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 获取终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetEndNode</span>(<span class="hljs-params">self, p_rowsCount: <span class="hljs-built_in">int</span>, p_colsCount: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isCreateEndNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateEndNode(p_rowsCount, p_colsCount)<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.__endNode<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateEndNode</span>(<span class="hljs-params">self, p_rowsCount, p_colsCount</span>):<br>        v_x = <span class="hljs-number">0.5</span><br>        v_y = <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">while</span> v_x == <span class="hljs-number">0.5</span> <span class="hljs-keyword">and</span> v_y == <span class="hljs-number">0.5</span>:<br>            v_i = random.randint(<span class="hljs-number">0</span>, p_rowsCount - <span class="hljs-number">1</span>)<br>            v_x = v_i + <span class="hljs-number">0.5</span><br>            v_i = random.randint(<span class="hljs-number">0</span>, p_colsCount - <span class="hljs-number">1</span>)<br>            v_y = v_i + <span class="hljs-number">0.5</span><br>        v_nodePos = NodePosition(v_x, v_y)<br>        <span class="hljs-variable language_">self</span>.__endNode = Node(<span class="hljs-string">&#x27;EndNode&#x27;</span>, v_nodePos)<br>        <span class="hljs-variable language_">self</span>.__isCreateEndNode = <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><h3 id="SearchPath-py"><a href="#SearchPath-py" class="headerlink" title="SearchPath.py"></a>SearchPath.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 查找最佳路径</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPath</span>:<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    __diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    __nonDiagonalCost = <span class="hljs-number">10</span><br>    __nodeFactory: node.NodeFactory<br>    __currentNode: node.Node<br>    <span class="hljs-comment"># 是否完成了初始化</span><br>    __isInit = <span class="hljs-literal">False</span><br>    __openList = []<br>    __closeList = []<br>    <span class="hljs-comment"># 网格行列数</span><br>    __rowsCount = <span class="hljs-number">0</span><br>    __colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># Node名称索引</span><br>    __nameIndex = <span class="hljs-number">1</span><br>    <span class="hljs-comment"># x和y的最小值</span><br>    __minX = <span class="hljs-number">0.5</span><br>    __minY = <span class="hljs-number">0.5</span><br>    <span class="hljs-comment"># x和y的最大值</span><br>    __maxX = <span class="hljs-number">0</span><br>    __maxY = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 终点Node</span><br>    __endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>.__nodeFactory = node.NodeFactory()<br>            <span class="hljs-variable language_">self</span>.__currentNode = <span class="hljs-variable language_">self</span>.__nodeFactory.GetStartNode()<br>            <span class="hljs-variable language_">self</span>.__openList.append(<span class="hljs-variable language_">self</span>.__currentNode)<br>            <span class="hljs-variable language_">self</span>.__rowsCount = sd.SharedData.rowsCount<br>            <span class="hljs-variable language_">self</span>.__colsCount = sd.SharedData.colsCount<br>            <span class="hljs-variable language_">self</span>.__maxX = <span class="hljs-variable language_">self</span>.__rowsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>.__maxY = <span class="hljs-variable language_">self</span>.__colsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>.__endNode = sd.SharedData.endNode<br>            <span class="hljs-variable language_">self</span>.__isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 查找最佳路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._UpdateCurrentNode():<br>            v_list = <span class="hljs-variable language_">self</span>._GetNextNodes()<br>            v_list = <span class="hljs-variable language_">self</span>._NodeCheck(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._CalculateWeight(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._SortNode(v_list)<br>            <span class="hljs-variable language_">self</span>._AddNode(v_list)<br>        sd.SharedData.pathNodes = <span class="hljs-variable language_">self</span>.__closeList<br>        <span class="hljs-variable language_">self</span>._PrintPath()<br><br>    <span class="hljs-comment"># 获取currentNode下一步可以前往的Node，并将它们保存在一个临时列表v_list中</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNextNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__currentNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_p = <span class="hljs-variable language_">self</span>.__currentNode.nodePos<br>            v_posList = [(v_p.x - <span class="hljs-number">1</span>, v_p.y), (v_p.x - <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>), (v_p.x, v_p.y + <span class="hljs-number">1</span>), (v_p.x + <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>),<br>                         (v_p.x + <span class="hljs-number">1</span>, v_p.y), (v_p.x + <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>), (v_p.x, v_p.y - <span class="hljs-number">1</span>), (v_p.x - <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>)]<br>            v_nameList = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-string">&#x27;H&#x27;</span>]<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_posList)):<br>                v_nodeName = v_nameList[i] + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__nameIndex)<br>                v_nodePos = node.NodePosition(v_posList[i][<span class="hljs-number">0</span>], v_posList[i][<span class="hljs-number">1</span>])<br>                v_node = node.Node(v_nodeName, v_nodePos)<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInOpenList(v_node) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>._isInCloseList(v_node) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(v_node)<br>            <span class="hljs-variable language_">self</span>.__nameIndex += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 检查临时列表p_list中哪些Node不符合要求，保留符合要求的节点，删除不符合要求的节点</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p_list)):<br>                v_x = p_list[i].nodePos.x<br>                v_y = p_list[i].nodePos.y<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__minX &lt;= v_x &lt;= <span class="hljs-variable language_">self</span>.__maxX <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.__minY &lt;= v_y &lt;= <span class="hljs-variable language_">self</span>.__maxY:<br>                    v_list.append(p_list[i])<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 计算临时列表p_list中每个Node的权值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CalculateWeight</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = p_list<br>            v_startNodeX = <span class="hljs-variable language_">self</span>.__currentNode.nodePos.x<br>            v_startNodeY = <span class="hljs-variable language_">self</span>.__currentNode.nodePos.y<br>            v_endNodeX = <span class="hljs-variable language_">self</span>.__endNode.nodePos.x<br>            v_endNodeY = <span class="hljs-variable language_">self</span>.__endNode.nodePos.y<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                v_x = n.nodePos.x<br>                v_y = n.nodePos.y<br>                <span class="hljs-keyword">if</span> v_x == v_y:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * <span class="hljs-variable language_">self</span>.__diagonalCost<br>                    <span class="hljs-keyword">if</span> v_endNodeX == v_endNodeY:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * <span class="hljs-variable language_">self</span>.__diagonalCost<br>                    <span class="hljs-keyword">else</span>:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                            (v_endNodeY - v_y)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost<br>                <span class="hljs-keyword">else</span>:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_y - v_startNodeY)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost<br>                    v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_endNodeY - v_y)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost<br>                v_f = v_g + v_h<br>                n.SetWeight(v_f, v_g, v_h)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 根据临时列表p_list中每个Node的权值进行排序，权值越小越接近列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SortNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">if</span> v_list[i].f &gt; v_list[j].f:<br>                        v_node = v_list[i]<br>                        v_list[i] = v_list[j]<br>                        v_list[j] = v_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 将临时列表p_list拼接在openList的列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p_list)):<br>                v_n = p_list[i]<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInOpenList(v_n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>._isInCloseList(v_n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(v_n)<br>            <span class="hljs-variable language_">self</span>.__openList.append(v_list[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 判断p_node是否为终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_ReachEndNodeCheck</span>(<span class="hljs-params">self, p_node: node.Node</span>):<br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">if</span> v_x == <span class="hljs-variable language_">self</span>.__endNode.nodePos.x <span class="hljs-keyword">and</span> v_y == <span class="hljs-variable language_">self</span>.__endNode.nodePos.y:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 判断p_node是否在openList中</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_isInOpenList</span>(<span class="hljs-params">self, p_node: node.Node</span>):<br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.__openList:<br>            <span class="hljs-keyword">if</span> v_x == n.nodePos.x <span class="hljs-keyword">and</span> v_y == n.nodePos.y:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 判断p_node是否在closeList中</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_isInCloseList</span>(<span class="hljs-params">self, p_node: node.Node</span>):<br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.__closeList:<br>            <span class="hljs-keyword">if</span> v_x == n.nodePos.x <span class="hljs-keyword">and</span> v_y == n.nodePos.y:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 打印最佳路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PrintPath</span>(<span class="hljs-params">self</span>):<br>        v_str = <span class="hljs-string">&#x27;&#x27;</span><br>        v_length = <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.__closeList)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> i &lt; v_length - <span class="hljs-number">1</span>:<br>                v_str += <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__closeList[i]) + <span class="hljs-string">&#x27;--&gt;&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                v_str += <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__closeList[i])<br>        <span class="hljs-built_in">print</span>(v_str)<br><br>    <span class="hljs-comment"># 从openList中获取列表尾的元素，将之作为currentNode并加入closeList中，然后将其从openList中移除</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateCurrentNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.__openList) &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-variable language_">self</span>.__currentNode = <span class="hljs-variable language_">self</span>.__openList[<span class="hljs-number">0</span>]<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInCloseList(<span class="hljs-variable language_">self</span>.__currentNode) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-variable language_">self</span>.__closeList.append(<span class="hljs-variable language_">self</span>.__currentNode)<br>                <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>.__openList[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._ReachEndNodeCheck(<span class="hljs-variable language_">self</span>.__currentNode):<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="SharedData-py"><a href="#SharedData-py" class="headerlink" title="SharedData.py"></a>SharedData.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 共享信息类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedData</span>:<br>    <span class="hljs-comment"># 网格行列数</span><br>    rowsCount = <span class="hljs-number">0</span><br>    colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 终点Node</span><br>    endNode: node.Node<br>    <span class="hljs-comment"># 所查找的路径Node集</span><br>    pathNodes = []<br></code></pre></td></tr></table></figure><h3 id="Main-py"><a href="#Main-py" class="headerlink" title="Main.py"></a>Main.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><br>g = grid.Grid(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)<br>sp.SearchPath().Search()<br>g.Draw()<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在这个示例中，我们分为两个层，一个是视图层，一个是数据层，视图层包括Grid类，数据层包括Node类、NodePosition类、NodeFactory类、SharedData类、SearchPath类。Grid类负责对A_Star算法进行可视化展现，包括基础的网格、文本和标记的构建和显示；Node类作为节点类，对应着视图层的每一个网格单元；NodePosition类用于记录节点的坐标信息；NodeFactory类用于创建和获取起始点Node和终点Node；SharedData类用于全局信息的共享；SearchPath类是路径查找类，该类中主要编写了A_Star算法实现的逻辑，包括获取下一步可前往的Node集、对Node集中的Node进行筛选、计算Node的权值、对Node集进行排序、将Node集添加至OpenList中以及从OpenList中读取Node等。</p><p>主要的调用顺序：</p><ol><li>在Main方法中创建Grid的实例，并且传递网格的行列数；</li><li>执行SearchPath中的Search方法查找最佳路径；</li><li>调用Grid中的Draw方法对最佳路径进行显示。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 寻路算法 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>A-Star算法探索和实现（二）</title>
      
      <link href="/posts/2026/01/07/abd3bef516ac/"/>
      <url>/posts/2026/01/07/abd3bef516ac/</url>
      
        <content type="html"><![CDATA[<blockquote><p>A-Star算法探索和实现系列博文不具备参考价值，仅仅作为个人探索和尝试的记录！</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇我们完成了A-Star算法的基本实现，在无障碍的情况下去寻找最佳路径，而在本篇我们将在此基础上增加障碍物，让算法能够在有障碍物的条件下去寻找到最佳路径。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>我们需要考虑以下几个问题：</p><p>第一，我们知道Node类对应的是网格单元，而每个障碍物需要对应一个网格单元，那么如何选择生成障碍物的Node？</p><p>第二，在视图层的Grid类中，如何呈现生成的障碍物？</p><p>第三，生成障碍物后，SearchPath类中寻找路径的方法需要作出哪些改变？</p><p>根据问题，我们提出以下解决思路：</p><p>（一）第一个问题的解决思路</p><p>我们可以给Node类添加一个nodeTag属性，并且设置将该属性设定为枚举类型，分为可通过的Node为PATHNODE，障碍物的Node为BLOCKNODE。首先我们进行障碍物Node的生成，我们需要告诉生成方法需要生成的障碍物的数量p_count，在生成方法中需要对Node作一个简单的判断，如果Node不为起始点Node和终点Node才存入Node集，然后返回生成好的Node集，依次遍历Node集，并将每个Node的nodeTag设置为BLOCKNODE。</p><p>（二）第二个问题的解决思路</p><p>我们可以通过Grid中的Mark方法来对障碍物Node进行标记，以此表示当前Node为不可通过的障碍物。</p><p>（三）第三个问题的解决思路</p><p>在SearchPath查找路径的方法中，我们需要对当前Node可前往的下一步Node集添加一个筛选条件，该条件以Node的nodeTag为判断条件，以此排除障碍物Node。</p><h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><img src="/posts/2026/01/07/abd3bef516ac/img1.jpeg" class="" width="690" height="578"><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><blockquote><p>绿色圆点是起始点，黑色方块是障碍物，蓝色小圆点是路径，红色圆点是终点</p></blockquote><img src="/posts/2026/01/07/abd3bef516ac/img2.jpeg" class="" width="642" height="542">  <img src="/posts/2026/01/07/abd3bef516ac/img3.jpeg" class="" width="642" height="542">  <img src="/posts/2026/01/07/abd3bef516ac/img4.jpeg" class="" width="642" height="542"><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Grid-py"><a href="#Grid-py" class="headerlink" title="Grid.py"></a>Grid.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> pp<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 视图的构建和绘制</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Grid</span>:<br>    <span class="hljs-comment"># 横纵坐标轴的刻度标记</span><br>    __xLabels = []<br>    __yLabels = []<br>    <span class="hljs-comment"># 网格单元格的信息</span><br>    __data = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 是否完成初始化</span><br>    __isInit = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_rowsCount=<span class="hljs-number">6</span>, p_colsCount=<span class="hljs-number">6</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-comment"># 网格的行列数</span><br>            <span class="hljs-variable language_">self</span>.__rowsCount = p_rowsCount<br>            <span class="hljs-variable language_">self</span>.__colsCount = p_colsCount<br>            <span class="hljs-comment"># 将网格的行列数设置为共享信息</span><br>            sd.SharedData.rowsCount = <span class="hljs-variable language_">self</span>.__rowsCount<br>            sd.SharedData.colsCount = <span class="hljs-variable language_">self</span>.__colsCount<br>            <span class="hljs-comment"># Node工厂</span><br>            <span class="hljs-variable language_">self</span>.__nodeFactory = node.NodeFactory()<br>            <span class="hljs-comment"># 将起始点Node和终点Node设置为共享信息</span><br>            v_startNode = <span class="hljs-variable language_">self</span>.__nodeFactory.GetStartNode()<br>            sd.SharedData.startNode = v_startNode<br>            v_endNode = <span class="hljs-variable language_">self</span>.__nodeFactory.GetEndNode()<br>            sd.SharedData.endNode = v_endNode<br>            <span class="hljs-variable language_">self</span>.__isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 绘制图形</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制图形&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 获取坐标轴实例</span><br>        v_ax = pp.gca()<br>        <span class="hljs-variable language_">self</span>._AxisSet(v_ax)<br>        <span class="hljs-variable language_">self</span>._GridValueSet(v_ax)<br>        <span class="hljs-comment"># 将数据以二维图片的形式进行显示</span><br>        v_ax.imshow(<span class="hljs-variable language_">self</span>.__data, cmap=<span class="hljs-string">&#x27;Accent&#x27;</span>, aspect=<span class="hljs-string">&#x27;equal&#x27;</span>, vmin=<span class="hljs-number">0</span>, vmax=<span class="hljs-number">255</span>)<br>        <span class="hljs-comment"># 标记起始点和终点</span><br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedData.startNode, <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;go&#x27;</span>)<br>        <span class="hljs-variable language_">self</span>._PathNodeSet()<br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedData.endNode, <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;ro&#x27;</span>)<br>        <span class="hljs-comment"># 布置网格线</span><br>        pp.grid(visible=<span class="hljs-literal">True</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br>        pp.tight_layout()<br>        pp.show()<br><br>    <span class="hljs-comment"># 标记所查找到的路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PathNodeSet</span>(<span class="hljs-params">self</span>):<br>        v_pathNodes = sd.SharedData.pathNodes<br>        v_length = <span class="hljs-built_in">len</span>(v_pathNodes)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; i &lt; v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>.Mark(v_pathNodes[i], <span class="hljs-number">10</span>, <span class="hljs-string">&#x27;bo&#x27;</span>)<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br>            <span class="hljs-keyword">elif</span> i == v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br><br>    <span class="hljs-comment"># 标记方法</span><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Mark</span>(<span class="hljs-params">cls, p_node: node.Node, p_marksize: <span class="hljs-built_in">int</span>, p_fmt: <span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        标记Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_node**:表示待标记的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_marksize**：表示标记的尺寸大小</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_fmt**：表示颜色和图形的样式描述</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        pp.plot(v_x, v_y, p_fmt, markersize=p_marksize, zorder=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 箭头指向方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Arrow</span>(<span class="hljs-params">self, p_firstNode, p_secondNode</span>):<br>        v_dx = p_secondNode.nodePos.x - p_firstNode.nodePos.x<br>        v_dy = p_secondNode.nodePos.y - p_firstNode.nodePos.y<br>        pp.arrow(p_firstNode.nodePos.x, p_firstNode.nodePos.y, v_dx, v_dy, color=<span class="hljs-string">&#x27;orange&#x27;</span>, width=<span class="hljs-number">0.01</span>, head_width=<span class="hljs-number">0.08</span>,<br>                 zorder=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-comment"># 坐标轴设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AxisSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>.__xLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>.__yLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-comment"># 隐藏刻度线</span><br>        v_ax.tick_params(left=<span class="hljs-literal">False</span>, bottom=<span class="hljs-literal">False</span>, top=<span class="hljs-literal">False</span>, right=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 生成Image Data</span><br>        v_low = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__rowsCount &gt; <span class="hljs-variable language_">self</span>.__colsCount:<br>            v_high = <span class="hljs-variable language_">self</span>.__rowsCount<br>        <span class="hljs-keyword">else</span>:<br>            v_high = <span class="hljs-variable language_">self</span>.__colsCount<br>        <span class="hljs-variable language_">self</span>.__data = np.random.randint(v_low, v_high, size=(<span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>))<br>        <span class="hljs-comment"># 设置横纵坐标轴的范围</span><br>        pp.xlim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount)<br>        pp.ylim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__rowsCount)<br>        <span class="hljs-comment"># 设置坐标轴的刻度标记</span><br>        v_ax.set_xticks(np.arange(<span class="hljs-variable language_">self</span>.__colsCount), labels=<span class="hljs-variable language_">self</span>.__xLabels, visible=<span class="hljs-literal">False</span>)<br>        v_ax.set_yticks(np.arange(<span class="hljs-variable language_">self</span>.__rowsCount), labels=<span class="hljs-variable language_">self</span>.__yLabels, visible=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 设置坐标轴的横纵轴比例相等</span><br>        v_ax.set_aspect(<span class="hljs-string">&#x27;equal&#x27;</span>)<br><br>    <span class="hljs-comment"># 网格内容设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GridValueSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>):<br>                v_str = <span class="hljs-string">&#x27;(&#x27;</span> + <span class="hljs-built_in">str</span>(i + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(j + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;)&#x27;</span><br>                v_ax.text(i + <span class="hljs-number">0.5</span>, j + <span class="hljs-number">0.5</span>, v_str, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="Node-py"><a href="#Node-py" class="headerlink" title="Node.py"></a>Node.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><br><br><span class="hljs-comment"># Node坐标类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePosition</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_x: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span>, p_y: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span></span>):<br>        <span class="hljs-variable language_">self</span>.x = p_x<br>        <span class="hljs-variable language_">self</span>.y = p_y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;[&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.x) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.y) + <span class="hljs-string">&#x27;]&#x27;</span><br><br><br><span class="hljs-comment"># Node标签</span><br><span class="hljs-meta">@unique</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeTag</span>(<span class="hljs-title class_ inherited__">Enum</span>):<br>    PATHNODE = <span class="hljs-number">1</span><br>    BLOCKNODE = <span class="hljs-number">2</span><br><br><br><span class="hljs-comment"># Node类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_nodeName: <span class="hljs-built_in">str</span>, p_nodePos: NodePosition</span>):<br>        <span class="hljs-variable language_">self</span>.nodeName = p_nodeName<br>        <span class="hljs-variable language_">self</span>.nodePos = p_nodePos<br>        <span class="hljs-comment"># f=g+h，g代表从上一个点到该点的代价和，h代表从该点到终点的代价和，f代表总权值weight</span><br>        <span class="hljs-variable language_">self</span>.f: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.g: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.h: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># Node的标签，用于判断是否为不可到达的Node，</span><br>        <span class="hljs-variable language_">self</span>.tag = NodeTag.PATHNODE<br><br>    <span class="hljs-comment"># 设置Node的权值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeight</span>(<span class="hljs-params">self, p_f: <span class="hljs-built_in">int</span>, p_g: <span class="hljs-built_in">int</span>, p_h: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-variable language_">self</span>.f = p_f<br>        <span class="hljs-variable language_">self</span>.g = p_g<br>        <span class="hljs-variable language_">self</span>.h = p_h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#123;nodeName:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeName + <span class="hljs-string">&#x27;,nodePos:&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.nodePos) + <span class="hljs-string">&#x27;,f=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.f) + <span class="hljs-string">&#x27;,g=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.g) + <span class="hljs-string">&#x27;,h=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.h) + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">if</span> other <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.x == other.nodePos.x <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.y == other.nodePos.y:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node工厂，用来创建和获取起始点Node和终点Node</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeFactory</span>:<br>    __isCreateEndNode = <span class="hljs-literal">False</span><br>    __isCreateStartNode = <span class="hljs-literal">False</span><br>    __startNode: Node<br>    __endNode: Node<br>    <span class="hljs-comment"># Node名称索引</span><br>    __nameIndex = <span class="hljs-number">1</span><br>    <span class="hljs-comment"># GenerateOneNode的Node索引</span><br>    __rowIndex = <span class="hljs-number">1</span><br>    __colIndex = <span class="hljs-number">1</span><br>    __generateCount = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-comment"># 获取起始点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetStartNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;获取起始点Node&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isCreateStartNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateStartNode()<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.__startNode<br><br>    <span class="hljs-comment"># 创建起始点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateStartNode</span>(<span class="hljs-params">self</span>):<br>        v_nodePos = NodePosition(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)<br>        <span class="hljs-variable language_">self</span>.__startNode = Node(<span class="hljs-string">&#x27;StartNode&#x27;</span>, v_nodePos)<br>        <span class="hljs-variable language_">self</span>.__isCreateStartNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 获取终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetEndNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;获取终点Node&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isCreateEndNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateEndNode()<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.__endNode<br><br>    <span class="hljs-comment"># 创建终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateEndNode</span>(<span class="hljs-params">self</span>):<br>        v_startNode = sd.SharedData.startNode<br>        v_node = v_startNode<br>        <span class="hljs-keyword">while</span> v_node == v_startNode:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;EndNode&#x27;</span>, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-variable language_">self</span>.__endNode = v_node<br>        <span class="hljs-variable language_">self</span>.__isCreateEndNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 生成指定数量的非重复Node集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNodes</span>(<span class="hljs-params">self, p_count, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成指定数量的非重复Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_count**:生成的Node的数量</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_isRandom**:是否随机生成，默认为False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        v_index = <span class="hljs-number">1</span><br>        v_startNode = sd.SharedData.startNode<br>        v_endNode = sd.SharedData.endNode<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(v_list) &lt; p_count:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index), p_isRandom=p_isRandom)<br>            <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                v_isRepeat = NodeCheck.RepeatCheck(v_list, v_node)<br>                <span class="hljs-keyword">if</span> v_isRepeat <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode:<br>                    v_list.append(v_node)<br>                    v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 生成一个指定名称的Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateOneNode</span>(<span class="hljs-params">self, p_name: <span class="hljs-built_in">str</span>, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        随机生成一个指定名称的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_name**:生成的Node的名称</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_isRandom**:是否随机生成，默认为False，若为True则将按照起始点从左至右&amp;从下至上的顺序生成</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **注意**:当该方法生成完当前网格的所有Node后会进行重置并返回None，请保持对该方法的返回值是否为None的判断，避免陷入死循环</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_rowsCount = sd.SharedData.rowsCount<br>        v_colsCount = sd.SharedData.colsCount<br>        v_x = <span class="hljs-number">0.5</span><br>        v_y = <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">if</span> p_isRandom:<br>            v_i = random.randint(<span class="hljs-number">0</span>, v_rowsCount - <span class="hljs-number">1</span>)<br>            v_x = v_i + <span class="hljs-number">0.5</span><br>            v_i = random.randint(<span class="hljs-number">0</span>, v_colsCount - <span class="hljs-number">1</span>)<br>            v_y = v_i + <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__colIndex &lt; v_colsCount:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__rowIndex &gt; v_rowsCount:<br>                    <span class="hljs-variable language_">self</span>.__rowIndex -= v_rowsCount<br>                    <span class="hljs-variable language_">self</span>.__colIndex += <span class="hljs-number">1</span><br>                v_x = (<span class="hljs-variable language_">self</span>.__rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                v_y = (<span class="hljs-variable language_">self</span>.__colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                <span class="hljs-variable language_">self</span>.__rowIndex += <span class="hljs-number">1</span><br>                <span class="hljs-variable language_">self</span>.__generateCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__rowIndex &lt;= v_rowsCount:<br>                    v_x = (<span class="hljs-variable language_">self</span>.__rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    v_y = (<span class="hljs-variable language_">self</span>.__colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    <span class="hljs-variable language_">self</span>.__rowIndex += <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>.__generateCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-variable language_">self</span>.__rowIndex = <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>.__colIndex = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__generateCount &gt; v_rowsCount * v_colsCount:<br>                <span class="hljs-variable language_">self</span>.__generateCount = <span class="hljs-number">0</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        v_nodePos = NodePosition(v_x, v_y)<br>        v_node = Node(p_name, v_nodePos)<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-comment"># 获取当前Node下一步可以前往的Node集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNextNodes</span>(<span class="hljs-params">self, p_node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取当前Node下一步可以前往的Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_node**:当前Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_p = p_node.nodePos<br>            v_posList = [(v_p.x - <span class="hljs-number">1</span>, v_p.y), (v_p.x - <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>), (v_p.x, v_p.y + <span class="hljs-number">1</span>), (v_p.x + <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>),<br>                         (v_p.x + <span class="hljs-number">1</span>, v_p.y), (v_p.x + <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>), (v_p.x, v_p.y - <span class="hljs-number">1</span>), (v_p.x - <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>)]<br>            v_nameList = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-string">&#x27;H&#x27;</span>]<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_posList)):<br>                v_nodeName = v_nameList[i] + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__nameIndex)<br>                v_nodePos = NodePosition(v_posList[i][<span class="hljs-number">0</span>], v_posList[i][<span class="hljs-number">1</span>])<br>                v_node = Node(v_nodeName, v_nodePos)<br>                v_list.append(v_node)<br>            <span class="hljs-variable language_">self</span>.__nameIndex += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeCheck</span>:<br>    <span class="hljs-comment"># 判断列表中是否存在当前Node</span><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RepeatCheck</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;判断列表中是否存在当前Node&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n == p_node:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 判断当前Node是否超出了网格限定</span><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">OutOfRange</span>(<span class="hljs-params">cls, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;判断当前Node是否超出了网格限定&quot;&quot;&quot;</span><br>        v_minX = <span class="hljs-number">0.5</span><br>        v_minY = <span class="hljs-number">0.5</span><br>        v_maxX = (sd.SharedData.rowsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_maxY = (sd.SharedData.colsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">if</span> v_minX &lt;= v_x &lt;= v_maxX <span class="hljs-keyword">and</span> v_minY &lt;= v_y &lt;= v_maxY:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><h3 id="Block-py"><a href="#Block-py" class="headerlink" title="Block.py"></a>Block.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><br><br><span class="hljs-comment"># 用于生成阻碍物</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Block</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_blcokCount: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param p_blcokCount: 生成的障碍物的数量</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.__blockCount = p_blcokCount<br>        <span class="hljs-variable language_">self</span>.__nodeFactory = node.NodeFactory()<br><br>    <span class="hljs-comment"># 用于生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Create</span>(<span class="hljs-params">self</span>):<br>        v_list = <span class="hljs-variable language_">self</span>._SelectNode()<br>        v_list = <span class="hljs-variable language_">self</span>._GenerateBlock(v_list)<br>        sd.SharedData.blockNodes = v_list<br>        <span class="hljs-variable language_">self</span>._MarkBlockNode(v_list)<br><br>    <span class="hljs-comment"># 获取生成Block的Node或Node集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SelectNode</span>(<span class="hljs-params">self</span>):<br>        v_list = <span class="hljs-variable language_">self</span>.__nodeFactory.GenerateNodes(<span class="hljs-variable language_">self</span>.__blockCount, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GenerateBlock</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                n.nodeTag = node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 标记生成Block的Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_MarkBlockNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                grid.Grid.Mark(n, <span class="hljs-number">49</span>, <span class="hljs-string">&#x27;ks&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="SearchPath-py"><a href="#SearchPath-py" class="headerlink" title="SearchPath.py"></a>SearchPath.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 查找最佳路径</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPath</span>:<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    __diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    __nonDiagonalCost = <span class="hljs-number">10</span><br>    __nodeFactory: node.NodeFactory<br>    __currentNode: node.Node<br>    <span class="hljs-comment"># 是否完成了初始化</span><br>    __isInit = <span class="hljs-literal">False</span><br>    __openList = []<br>    __closeList = []<br>    <span class="hljs-comment"># 网格行列数</span><br>    __rowsCount = <span class="hljs-number">0</span><br>    __colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># x和y的最小值</span><br>    __minX = <span class="hljs-number">0.5</span><br>    __minY = <span class="hljs-number">0.5</span><br>    <span class="hljs-comment"># x和y的最大值</span><br>    __maxX = <span class="hljs-number">0</span><br>    __maxY = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 终点Node</span><br>    __endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>.__nodeFactory = node.NodeFactory()<br>            <span class="hljs-variable language_">self</span>.__currentNode = sd.SharedData.startNode<br>            <span class="hljs-variable language_">self</span>.__openList.append(<span class="hljs-variable language_">self</span>.__currentNode)<br>            <span class="hljs-variable language_">self</span>.__rowsCount = sd.SharedData.rowsCount<br>            <span class="hljs-variable language_">self</span>.__colsCount = sd.SharedData.colsCount<br>            <span class="hljs-variable language_">self</span>.__maxX = <span class="hljs-variable language_">self</span>.__rowsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>.__maxY = <span class="hljs-variable language_">self</span>.__colsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>.__endNode = sd.SharedData.endNode<br>            <span class="hljs-variable language_">self</span>.__isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 查找最佳路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params">self, p_isPrint=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        查找最佳路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">        p_isPrint：是否在控制台打印路径Node集信息,默认为False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._UpdateCurrentNode():<br>            <span class="hljs-comment"># 获取currentNode下一步可以前往的Node，并将它们保存在一个临时列表v_list中</span><br>            v_list = <span class="hljs-variable language_">self</span>.__nodeFactory.GenerateNextNodes(<span class="hljs-variable language_">self</span>.__currentNode)<br>            v_list = <span class="hljs-variable language_">self</span>._NodeCheck(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._CalculateWeight(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._SortNode(v_list)<br>            <span class="hljs-variable language_">self</span>._AddNode(v_list)<br>        sd.SharedData.pathNodes = <span class="hljs-variable language_">self</span>.__closeList<br>        <span class="hljs-keyword">if</span> p_isPrint:<br>            <span class="hljs-variable language_">self</span>._PrintPath()<br><br>    <span class="hljs-comment"># 检查临时列表p_list中哪些Node不符合要求，保留符合要求的节点</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list1 = []<br>            v_list2 = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> node.NodeCheck.OutOfRange(n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list1.append(n)<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list1:<br>                v_isInOpenList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__openList, n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__closeList, n)<br>                v_isInBlockList = node.NodeCheck.RepeatCheck(sd.SharedData.blockNodes, n)<br>                <span class="hljs-keyword">if</span> v_isInOpenList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInBlockList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list2.append(n)<br>            <span class="hljs-keyword">return</span> v_list2<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 计算临时列表p_list中每个Node的权值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CalculateWeight</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = p_list<br>            v_startNodeX = <span class="hljs-variable language_">self</span>.__currentNode.nodePos.x<br>            v_startNodeY = <span class="hljs-variable language_">self</span>.__currentNode.nodePos.y<br>            v_endNodeX = <span class="hljs-variable language_">self</span>.__endNode.nodePos.x<br>            v_endNodeY = <span class="hljs-variable language_">self</span>.__endNode.nodePos.y<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                v_x = n.nodePos.x<br>                v_y = n.nodePos.y<br>                <span class="hljs-keyword">if</span> v_x == v_y:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * <span class="hljs-variable language_">self</span>.__diagonalCost<br>                    <span class="hljs-keyword">if</span> v_endNodeX == v_endNodeY:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * <span class="hljs-variable language_">self</span>.__diagonalCost<br>                    <span class="hljs-keyword">else</span>:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                            (v_endNodeY - v_y)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost<br>                <span class="hljs-keyword">else</span>:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_y - v_startNodeY)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost<br>                    v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_endNodeY - v_y)) * <span class="hljs-variable language_">self</span>.__nonDiagonalCost<br>                v_f = v_g + v_h<br>                n.SetWeight(v_f, v_g, v_h)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 根据临时列表p_list中每个Node的权值进行排序，权值越小越接近列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SortNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">if</span> v_list[i].f &gt; v_list[j].f:<br>                        v_node = v_list[i]<br>                        v_list[i] = v_list[j]<br>                        v_list[j] = v_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 将临时列表p_list拼接在openList的列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p_list)):<br>                v_n = p_list[i]<br>                v_isInOpenList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__openList, v_n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__closeList, v_n)<br>                <span class="hljs-keyword">if</span> v_isInOpenList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(v_n)<br>            <span class="hljs-variable language_">self</span>.__openList.append(v_list[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 打印最佳路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PrintPath</span>(<span class="hljs-params">self</span>):<br>        v_str = <span class="hljs-string">&#x27;&#x27;</span><br>        v_length = <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.__closeList)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> i &lt; v_length - <span class="hljs-number">1</span>:<br>                v_str += <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__closeList[i]) + <span class="hljs-string">&#x27;--&gt;&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                v_str += <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__closeList[i])<br>        <span class="hljs-built_in">print</span>(v_str)<br><br>    <span class="hljs-comment"># 从openList中获取列表尾的元素，将之作为currentNode并加入closeList中，然后将其从openList中移除</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateCurrentNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.__openList) &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-variable language_">self</span>.__currentNode = <span class="hljs-variable language_">self</span>.__openList[<span class="hljs-number">0</span>]<br>            v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__closeList, <span class="hljs-variable language_">self</span>.__currentNode)<br>            <span class="hljs-keyword">if</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-variable language_">self</span>.__closeList.append(<span class="hljs-variable language_">self</span>.__currentNode)<br>                <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>.__openList[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__currentNode == <span class="hljs-variable language_">self</span>.__endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="SharedData-py"><a href="#SharedData-py" class="headerlink" title="SharedData.py"></a>SharedData.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 共享信息类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedData</span>:<br>    <span class="hljs-comment"># 网格行列数</span><br>    rowsCount = <span class="hljs-number">0</span><br>    colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 起始点Node</span><br>    startNode: node.Node<br>    <span class="hljs-comment"># 终点Node</span><br>    endNode: node.Node<br>    <span class="hljs-comment"># 所查找的路径Node集</span><br>    pathNodes = []<br>    <span class="hljs-comment"># 障碍物Node集</span><br>    blockNodes = []<br></code></pre></td></tr></table></figure><h3 id="Main-py"><a href="#Main-py" class="headerlink" title="Main.py"></a>Main.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Block <span class="hljs-keyword">as</span> block<br><br>g = grid.Grid()<br>block.Block(<span class="hljs-number">5</span>).Create()<br>sp.SearchPath().Search()<br>g.Draw()<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在上一篇中，我们将代码分为了视图层和数据层两个层级，并且对视图层的Grid类，以及数据层的Node类、NodePosition类、NodeFactory类、SharedData类、SearchPath类分别进行了解说。在本篇我们又添加了两个新的成员——Block类、NodeCheck类，Block类将作为数据层家族的一员，而它将负责障碍物的生成和标记，NodeCheck类也将加入数据层，它的任务是对Node和Node集进行各种检测。除此之外我们对上一篇中的代码进行了简化，当我们编写的代码越来越多时，我们不得不考虑到代码的优化，否则当你面对一篇结构混乱、可读性低的代码时，你可能就没有心情继续编写了，这对程序员来说无疑就像是失恋一般难受，在后续我们将采用设计模式进行进一步的优化。</p><p>不过在此之前，如果你足够细心地进行了观察的话，一定会发现本篇中所存在的诸多问题。例如障碍物的生成可能出现“死胡同”的情况，这可能导致要么从起始点无法出去，要么无法进入终点；障碍物生成在对角的顶点处似乎并没有意义，这并不能阻止或影响我们到达终点；对于在周围存在障碍物时按照对角线移动是否合理，这涉及到障碍物的四个角是否能够阻止我们前行，因为在游戏场景中这可能就表现为我们半边身体从一个突出的墙体中穿了过去；有时候我们所选择的路径似乎并不是最佳路径，这说明我们获取最佳路径的方式存在漏洞，这并不是A<em>算法的问题，而是我们自己的问题，或者说我们获取最佳路径的方式严格上来说并算不上是标准的A</em>算法，这些问题我们将会在下一篇进行探讨。</p>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 寻路算法 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>A-Star算法探索和实现（三）</title>
      
      <link href="/posts/2026/01/07/f57c2a1d821b/"/>
      <url>/posts/2026/01/07/f57c2a1d821b/</url>
      
        <content type="html"><![CDATA[<blockquote><p>A-Star算法探索和实现系列博文不具备参考价值，仅仅作为个人探索和尝试的记录！</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在上一篇中我们提出了四个问题，分别是：</p><ol><li><p>障碍物生成出现“死胡同”问题，如何解决？</p></li><li><p>障碍物生成在网格的对角顶点处，是否具有意义？</p></li><li><p>路径周围存在障碍物时，按照对角线移动是否合理？</p></li><li><p>查找最佳路径的方式，除了权值这个判断条件，还需要附加什么条件来辅助寻找最佳路径或者如何改进寻找最佳路径的方式？</p></li></ol><p>第一个问题针对的是随机生成的障碍物集合，是否存在使得起始点到终点的路径无解的情况，如果存在这种情况，我们就称其为“死胡同”问题，本篇我们将针对第一个问题进行探讨和解决。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这个问题本质上是要检测当前生成的BlockNode集是否合理，如果合理，我们就可以执行A*算法查找最佳路径，否则重新生成一组BlockNode集再次进行检测，直到生成合理的BlockNode集为止。我们可以通过预寻路的方式去检测当前BlockNode集是否合理，具体步骤如下：</p><p>（1）</p><p>传入CurNode（初始为起始点Node），生成CurNode的NextNode集，生成BlockNode集。设CurNode坐标为（a，b），从NextNode集中获取x &#x3D; a + 1的Node集为xNodes，获取y &#x3D; b + 1的Node集为yNodes，设isContainX &#x3D; False，isContainY &#x3D; False。</p><p>（2）</p><ul><li><p>若xNodes包含于BlockNode集，则isContainX &#x3D; True。</p></li><li><p>若yNodes包含于BlockNode集，则isContainY &#x3D; True。</p></li></ul><p>（3）</p><ul><li><p>若isContainX &#x3D; True 并且 isContainY &#x3D; True，则为“死胡同”。</p></li><li><p>若isContainX &#x3D; False 并且 isContainY &#x3D; False，从NextNode集中获取CurNode下一步最佳Node为neNode，且CurNode&#x3D;neNode。</p></li><li><p>若isContainX &#x3D; True 并且 isContainY &#x3D; False，则可从NextNode集中剔除xNodes，从NextNode集中获取CurNode下一步最佳Node为neNode，且CurNode&#x3D;neNode。</p></li><li><p>若isContainX &#x3D; False 并且 isContainY &#x3D; True，则可从NextNode集中剔除yNodes，从NextNode集中获取CurNode下一步最佳Node为neNode，且CurNode&#x3D;neNode。</p></li></ul><p>（4）</p><ul><li><p>若CurNode等于终点Node，则可到达终点。</p></li><li><p>若CurNode不等于终点Node，重复执行（1）（2）（3）（4）步骤，直至出现“死胡同“或可到达终点。</p></li></ul><p>（5）</p><ul><li>若检测结果为可到达终点，则指向A*算法寻找最佳路径，否则重新生成BlockNode集再次重复上述过程。</li></ul><h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><img src="/posts/2026/01/07/f57c2a1d821b/img1.jpeg" class="" width="698" height="570"><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><img src="/posts/2026/01/07/f57c2a1d821b/img2.jpeg" class="" width="642" height="542">  <img src="/posts/2026/01/07/f57c2a1d821b/img3.jpeg" class="" width="642" height="542">  <h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Grid-py"><a href="#Grid-py" class="headerlink" title="Grid.py"></a>Grid.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> pp<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 视图的构建和绘制</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Grid</span>:<br>    <span class="hljs-comment"># 横纵坐标轴的刻度标记</span><br>    __xLabels = []<br>    __yLabels = []<br>    <span class="hljs-comment"># 网格单元格的信息</span><br>    __data = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 是否完成初始化</span><br>    __isInit = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_rowsCount=<span class="hljs-number">6</span>, p_colsCount=<span class="hljs-number">6</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-comment"># 网格的行列数</span><br>            <span class="hljs-variable language_">self</span>.__rowsCount = p_rowsCount<br>            <span class="hljs-variable language_">self</span>.__colsCount = p_colsCount<br>            <span class="hljs-comment"># 将网格的行列数设置为共享信息</span><br>            sd.SharedData.rowsCount = <span class="hljs-variable language_">self</span>.__rowsCount<br>            sd.SharedData.colsCount = <span class="hljs-variable language_">self</span>.__colsCount<br>            <span class="hljs-variable language_">self</span>.__isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 绘制图形</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制图形&quot;&quot;&quot;</span><br>        pp.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]<br>        pp.title(sd.SharedData.blockInfo)<br>        <span class="hljs-comment"># 获取坐标轴实例</span><br>        v_ax = pp.gca()<br>        <span class="hljs-variable language_">self</span>._AxisSet(v_ax)<br>        <span class="hljs-variable language_">self</span>._GridValueSet(v_ax)<br>        <span class="hljs-comment"># 将数据以二维图片的形式进行显示</span><br>        v_ax.imshow(<span class="hljs-variable language_">self</span>.__data, cmap=<span class="hljs-string">&#x27;Accent&#x27;</span>, aspect=<span class="hljs-string">&#x27;equal&#x27;</span>, vmin=<span class="hljs-number">0</span>, vmax=<span class="hljs-number">255</span>)<br>        <span class="hljs-comment"># 标记起始点和终点</span><br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedNodes().GetStartNode(), <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;go&#x27;</span>)<br>        <span class="hljs-variable language_">self</span>._PathNodeSet()<br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedNodes().GetEndNode(), <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;ro&#x27;</span>)<br>        <span class="hljs-comment"># 布置网格线</span><br>        pp.grid(visible=<span class="hljs-literal">True</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br>        pp.tight_layout()<br>        pp.show()<br><br>    <span class="hljs-comment"># 标记所查找到的路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PathNodeSet</span>(<span class="hljs-params">self</span>):<br>        v_pathNodes = sd.SharedNodes().GetPathNodes()<br>        v_length = <span class="hljs-built_in">len</span>(v_pathNodes)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; i &lt; v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>.Mark(v_pathNodes[i], <span class="hljs-number">10</span>, <span class="hljs-string">&#x27;bo&#x27;</span>)<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br>            <span class="hljs-keyword">elif</span> i == v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br><br>    <span class="hljs-comment"># 标记方法</span><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Mark</span>(<span class="hljs-params">cls, p_node: node.Node, p_marksize: <span class="hljs-built_in">int</span>, p_fmt: <span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        标记Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_node**:表示待标记的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_marksize**：表示标记的尺寸大小</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_fmt**：表示颜色和图形的样式描述</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        pp.plot(v_x, v_y, p_fmt, markersize=p_marksize, zorder=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 箭头指向方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Arrow</span>(<span class="hljs-params">self, p_firstNode, p_secondNode</span>):<br>        v_dx = p_secondNode.nodePos.x - p_firstNode.nodePos.x<br>        v_dy = p_secondNode.nodePos.y - p_firstNode.nodePos.y<br>        pp.arrow(p_firstNode.nodePos.x, p_firstNode.nodePos.y, v_dx, v_dy, color=<span class="hljs-string">&#x27;orange&#x27;</span>, width=<span class="hljs-number">0.01</span>, head_width=<span class="hljs-number">0.08</span>,<br>                 zorder=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-comment"># 坐标轴设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AxisSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>.__xLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>.__yLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-comment"># 隐藏刻度线</span><br>        v_ax.tick_params(left=<span class="hljs-literal">False</span>, bottom=<span class="hljs-literal">False</span>, top=<span class="hljs-literal">False</span>, right=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 生成Image Data</span><br>        v_low = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__rowsCount &gt; <span class="hljs-variable language_">self</span>.__colsCount:<br>            v_high = <span class="hljs-variable language_">self</span>.__rowsCount<br>        <span class="hljs-keyword">else</span>:<br>            v_high = <span class="hljs-variable language_">self</span>.__colsCount<br>        <span class="hljs-variable language_">self</span>.__data = np.random.randint(v_low, v_high, size=(<span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>))<br>        <span class="hljs-comment"># 设置横纵坐标轴的范围</span><br>        pp.xlim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__colsCount)<br>        pp.ylim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.__rowsCount)<br>        <span class="hljs-comment"># 设置坐标轴的刻度标记</span><br>        v_ax.set_xticks(np.arange(<span class="hljs-variable language_">self</span>.__colsCount), labels=<span class="hljs-variable language_">self</span>.__xLabels, visible=<span class="hljs-literal">False</span>)<br>        v_ax.set_yticks(np.arange(<span class="hljs-variable language_">self</span>.__rowsCount), labels=<span class="hljs-variable language_">self</span>.__yLabels, visible=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 设置坐标轴的横纵轴比例相等</span><br>        v_ax.set_aspect(<span class="hljs-string">&#x27;equal&#x27;</span>)<br><br>    <span class="hljs-comment"># 网格内容设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GridValueSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.__rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>.__colsCount + <span class="hljs-number">1</span>):<br>                v_str = <span class="hljs-string">&#x27;(&#x27;</span> + <span class="hljs-built_in">str</span>(i + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(j + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;)&#x27;</span><br>                v_ax.text(i + <span class="hljs-number">0.5</span>, j + <span class="hljs-number">0.5</span>, v_str, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="Node-py"><a href="#Node-py" class="headerlink" title="Node.py"></a>Node.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># Node坐标类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePosition</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_x: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span>, p_y: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Node坐标信息初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_x: 横坐标值</span><br><span class="hljs-string">        :param p_y: 纵坐标值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.x = p_x<br>        <span class="hljs-variable language_">self</span>.y = p_y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;[&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.x) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.y) + <span class="hljs-string">&#x27;]&#x27;</span><br><br><br><span class="hljs-comment"># Node标签</span><br><span class="hljs-meta">@unique</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeTag</span>(<span class="hljs-title class_ inherited__">Enum</span>):<br>    PATHNODE = <span class="hljs-number">1</span><br>    BLOCKNODE = <span class="hljs-number">2</span><br><br><br><span class="hljs-comment"># Node类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_nodeName: <span class="hljs-built_in">str</span>, p_nodePos: NodePosition</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Node初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_nodeName: Node名称</span><br><span class="hljs-string">        :param p_nodePos: Node的坐标信息</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.nodeName = p_nodeName<br>        <span class="hljs-variable language_">self</span>.nodePos = p_nodePos<br>        <span class="hljs-comment"># f=g+h，g代表从上一个点到该点的代价和，h代表从该点到终点的代价和，f代表总权值weight</span><br>        <span class="hljs-variable language_">self</span>.f: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.g: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.h: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># Node的标签，用于判断是否为不可到达的Node，</span><br>        <span class="hljs-variable language_">self</span>.nodeTag = NodeTag.PATHNODE<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeight</span>(<span class="hljs-params">self, p_f: <span class="hljs-built_in">int</span>, p_g: <span class="hljs-built_in">int</span>, p_h: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置Node的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_f: 代表总权值weight, f = g + h</span><br><span class="hljs-string">        :param p_g: 代表从上一个点到该点的代价和</span><br><span class="hljs-string">        :param p_h: 代表从该点到终点的代价和</span><br><span class="hljs-string">        :return: 无返回值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.f = p_f<br>        <span class="hljs-variable language_">self</span>.g = p_g<br>        <span class="hljs-variable language_">self</span>.h = p_h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#123;nodeName:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeName + <span class="hljs-string">&#x27;,nodeTag:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeTag.name + <span class="hljs-string">&#x27;,nodePos:&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.nodePos) + <span class="hljs-string">&#x27;,f=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.f) + <span class="hljs-string">&#x27;,g=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.g) + <span class="hljs-string">&#x27;,h=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.h) + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">if</span> other <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.x == other.nodePos.x <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.y == other.nodePos.y:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node工厂，用来创建和获取起始点Node和终点Node</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeFactory</span>:<br>    __lock = th.Lock()<br>    __isCreateEndNode = <span class="hljs-literal">False</span><br>    __isCreateStartNode = <span class="hljs-literal">False</span><br>    __startNode: Node<br>    __endNode: Node<br>    <span class="hljs-comment"># Node名称索引</span><br>    __nameIndex = <span class="hljs-number">1</span><br>    <span class="hljs-comment"># GenerateOneNode的Node索引</span><br>    __rowIndex = <span class="hljs-number">1</span><br>    __colIndex = <span class="hljs-number">1</span><br>    __generateCount = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__isCreateStartNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateStartNode()<br>            sd.SharedNodes().SetStartNode(<span class="hljs-variable language_">self</span>.__class__.__startNode, <span class="hljs-string">&#x27;SNSET&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__isCreateEndNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateEndNode()<br>            sd.SharedNodes().SetEndNode(<span class="hljs-variable language_">self</span>.__class__.__endNode, <span class="hljs-string">&#x27;ENSET&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeFactory, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls.__lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeFactory, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    NodeFactory.__instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> NodeFactory.__instance<br><br>    <span class="hljs-comment"># 创建起始点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateStartNode</span>(<span class="hljs-params">self</span>):<br>        v_nodePos = NodePosition(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)<br>        <span class="hljs-variable language_">self</span>.__class__.__startNode = Node(<span class="hljs-string">&#x27;StartNode&#x27;</span>, v_nodePos)<br>        <span class="hljs-variable language_">self</span>.__class__.__isCreateStartNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 创建终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateEndNode</span>(<span class="hljs-params">self</span>):<br>        v_startNode = <span class="hljs-variable language_">self</span>.__class__.__startNode<br>        v_node = v_startNode<br>        <span class="hljs-keyword">while</span> v_node == v_startNode:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;EndNode&#x27;</span>, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-variable language_">self</span>.__class__.__endNode = v_node<br>        <span class="hljs-variable language_">self</span>.__class__.__isCreateEndNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNodes</span>(<span class="hljs-params">self, p_count, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成指定数量的非重复Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_count: 生成的Node的数量</span><br><span class="hljs-string">        :param p_isRandom: 是否随机生成，默认为False</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        v_index = <span class="hljs-number">1</span><br>        v_startNode = <span class="hljs-variable language_">self</span>.__class__.__startNode<br>        v_endNode = <span class="hljs-variable language_">self</span>.__class__.__endNode<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(v_list) &lt; p_count:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index), p_isRandom=p_isRandom)<br>            <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                v_isRepeat = NodeCheck.RepeatCheck(v_list, v_node)<br>                <span class="hljs-keyword">if</span> v_isRepeat <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode:<br>                    v_list.append(v_node)<br>                    v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateOneNode</span>(<span class="hljs-params">self, p_name: <span class="hljs-built_in">str</span>, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成一个指定名称的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_name: 生成的Node的名称</span><br><span class="hljs-string">        :param p_isRandom: 是否随机生成，默认为False，若为True则为非随机模式生成，将按照起始点从左至右&amp;从下至上的顺序生成</span><br><span class="hljs-string">        :return: 默认会返回Node，在非随机生成模式下，当该方法生成完当前网格的所有Node后会进行重置并返回None，请保持对该方法的返回值是否为None的判断，避免陷入死循环</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_rowsCount = sd.SharedData.rowsCount<br>        v_colsCount = sd.SharedData.colsCount<br>        v_x = <span class="hljs-number">0.5</span><br>        v_y = <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">if</span> p_isRandom:<br>            v_i = random.randint(<span class="hljs-number">0</span>, v_rowsCount - <span class="hljs-number">1</span>)<br>            v_x = v_i + <span class="hljs-number">0.5</span><br>            v_i = random.randint(<span class="hljs-number">0</span>, v_colsCount - <span class="hljs-number">1</span>)<br>            v_y = v_i + <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__colIndex &lt; v_colsCount:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__rowIndex &gt; v_rowsCount:<br>                    <span class="hljs-variable language_">self</span>.__class__.__rowIndex -= v_rowsCount<br>                    <span class="hljs-variable language_">self</span>.__class__.__colIndex += <span class="hljs-number">1</span><br>                v_x = (<span class="hljs-variable language_">self</span>.__class__.__rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                v_y = (<span class="hljs-variable language_">self</span>.__class__.__colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                <span class="hljs-variable language_">self</span>.__class__.__rowIndex += <span class="hljs-number">1</span><br>                <span class="hljs-variable language_">self</span>.__class__.__generateCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__rowIndex &lt;= v_rowsCount:<br>                    v_x = (<span class="hljs-variable language_">self</span>.__class__.__rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    v_y = (<span class="hljs-variable language_">self</span>.__class__.__colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    <span class="hljs-variable language_">self</span>.__class__.__rowIndex += <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>.__class__.__generateCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-variable language_">self</span>.__class__.__rowIndex = <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>.__class__.__colIndex = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__generateCount &gt; v_rowsCount * v_colsCount:<br>                <span class="hljs-variable language_">self</span>.__class__.__generateCount = <span class="hljs-number">0</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        v_nodePos = NodePosition(v_x, v_y)<br>        v_node = Node(p_name, v_nodePos)<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNextNodes</span>(<span class="hljs-params">self, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取某个Node下一步可以前往的Node集(NextNode集)</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 待生成NextNode集的Node</span><br><span class="hljs-string">        :return: 若p_node为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_p = p_node.nodePos<br>            v_posList = [(v_p.x - <span class="hljs-number">1</span>, v_p.y), (v_p.x - <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>), (v_p.x, v_p.y + <span class="hljs-number">1</span>), (v_p.x + <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>),<br>                         (v_p.x + <span class="hljs-number">1</span>, v_p.y), (v_p.x + <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>), (v_p.x, v_p.y - <span class="hljs-number">1</span>), (v_p.x - <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>)]<br>            v_nameList = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-string">&#x27;H&#x27;</span>]<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_posList)):<br>                v_nodeName = v_nameList[i] + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__class__.__nameIndex)<br>                v_nodePos = NodePosition(v_posList[i][<span class="hljs-number">0</span>], v_posList[i][<span class="hljs-number">1</span>])<br>                v_node = Node(v_nodeName, v_nodePos)<br>                v_list.append(v_node)<br>            <span class="hljs-variable language_">self</span>.__class__.__nameIndex += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> v_list<br><br><br><span class="hljs-comment"># Node或Node集的检测</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeCheck</span>:<br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RepeatCheck</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断Node集中是否存在某个Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :param p_node: 待检测的Node</span><br><span class="hljs-string">        :return: 存在返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n == p_node:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">OutOfRange</span>(<span class="hljs-params">cls, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断Node是否超出了网格限定范围</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 待检测的Node</span><br><span class="hljs-string">        :return:若超出了范围则返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_minX = <span class="hljs-number">0.5</span><br>        v_minY = <span class="hljs-number">0.5</span><br>        v_maxX = (sd.SharedData.rowsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_maxY = (sd.SharedData.colsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">if</span> v_minX &lt;= v_x &lt;= v_maxX <span class="hljs-keyword">and</span> v_minY &lt;= v_y &lt;= v_maxY:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">IsContainNodes</span>(<span class="hljs-params">cls, p_listA: <span class="hljs-built_in">list</span>[Node], p_listB: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断某个Node集（p_listA）是否包含另一个Node集（p_listB）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_listA: 待检测的Node集</span><br><span class="hljs-string">        :param p_listB: 被包含的Node集</span><br><span class="hljs-string">        :return: 若p_listA包含p_listB则返回True，否则返回False，若p_listA为None也会返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_listA <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_listA) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> p_listB <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(p_listB) == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_listB:<br>                    <span class="hljs-keyword">if</span> cls.RepeatCheck(p_listA, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node或Node集的处理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeDeal</span>:<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    __diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    __nonDiagonalCost = <span class="hljs-number">10</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveRepeateNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集中的重复Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :return: 若p_list为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            v_length = <span class="hljs-built_in">len</span>(p_list)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>                v_isRepeate = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, v_length):<br>                    <span class="hljs-keyword">if</span> p_list[i] == p_list[j]:<br>                        v_isRepeate = <span class="hljs-literal">True</span><br>                        <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> v_isRepeate <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(p_list[i])<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveNode</span>(<span class="hljs-params">cls, p_sourceList: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集（p_sourceList）中的某个Node（p_node）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_sourceList: 待处理的Node集</span><br><span class="hljs-string">        :param p_node: 参考Node</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_sourceList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_sourceList) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_sourceList:<br>                <span class="hljs-keyword">if</span> n != p_node:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_sourceList<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveNodes</span>(<span class="hljs-params">cls, p_sourceList: <span class="hljs-built_in">list</span>[Node], p_refList: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将一个Node集（p_sourceList）中另一个Node集（p_refList）的元素去除</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_sourceList: 待处理的原Node集</span><br><span class="hljs-string">        :param p_refList: 参考Node集</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_sourceList或p_refList为None则返回原Node集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_sourceList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_refList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_sourceList) != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_refList) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_sourceList:<br>                <span class="hljs-keyword">if</span> NodeCheck.RepeatCheck(p_refList, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_sourceList<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveOutOfRangeNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集中超出网格范围的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待处理的Node集</span><br><span class="hljs-string">        :return: 默认返回一个列表，如果p_list为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> NodeCheck.OutOfRange(n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ReplaceNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        替换Node集中与某个Node相同的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :param p_node: 用于替换的Node</span><br><span class="hljs-string">        :return: 若p_list和p_node为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">if</span> NodeCheck.RepeatCheck(v_list, p_node):<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">if</span> v_list[i] == p_node:<br>                        v_list[i] = p_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeightValue</span>(<span class="hljs-params">cls, p_diagonalCost: <span class="hljs-built_in">int</span> = <span class="hljs-number">14</span>, p_nonDiagonalCost: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置diagonalCost（对角线移动权值）和nonDiagonalCost（非对角线移动权值）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_diagonalCost: 对角线移动权值，默认为14</span><br><span class="hljs-string">        :param p_nonDiagonalCost: 非对角线移动权值，默认为10</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_diagonalCost &gt;= <span class="hljs-number">0</span>:<br>            cls.__diagonalCost = p_diagonalCost<br>        <span class="hljs-keyword">if</span> p_nonDiagonalCost &gt;= <span class="hljs-number">0</span>:<br>            cls.__nonDiagonalCost = p_nonDiagonalCost<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">CalculateWeight</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_startNode: Node, p_endNode: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        计算某个Node集相对起始点和终点的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待计算权值的Node集</span><br><span class="hljs-string">        :param p_startNode: 起始点</span><br><span class="hljs-string">        :param p_endNode: 终点</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_list或p_startNode或p_endNode有一个为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_startNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_endNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            v_startNodeX = p_startNode.nodePos.x<br>            v_startNodeY = p_startNode.nodePos.y<br>            v_endNodeX = p_endNode.nodePos.x<br>            v_endNodeY = p_endNode.nodePos.y<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                v_x = n.nodePos.x<br>                v_y = n.nodePos.y<br>                <span class="hljs-keyword">if</span> v_x == v_y:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * cls.__diagonalCost<br>                    <span class="hljs-keyword">if</span> v_endNodeX == v_endNodeY:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * cls.__diagonalCost<br>                    <span class="hljs-keyword">else</span>:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * cls.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                            (v_endNodeY - v_y)) * cls.__nonDiagonalCost<br>                <span class="hljs-keyword">else</span>:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * cls.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_y - v_startNodeY)) * cls.__nonDiagonalCost<br>                    v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * cls.__nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_endNodeY - v_y)) * cls.__nonDiagonalCost<br>                v_f = v_g + v_h<br>                n.SetWeight(<span class="hljs-built_in">int</span>(v_f), <span class="hljs-built_in">int</span>(v_g), <span class="hljs-built_in">int</span>(v_h))<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SortNodes</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_endMax=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        对Node集按照总权值（f）进行排序</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待排序的Node集</span><br><span class="hljs-string">        :param p_endMax: 是否按照总权值从小到大排序，默认为True</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_list为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">if</span> p_endMax:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                        <span class="hljs-keyword">if</span> v_list[i].f &gt; v_list[j].f:<br>                            v_node = v_list[i]<br>                            v_list[i] = v_list[j]<br>                            v_list[j] = v_node<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                        <span class="hljs-keyword">if</span> v_list[i].f &lt; v_list[j].f:<br>                            v_node = v_list[i]<br>                            v_list[i] = v_list[j]<br>                            v_list[j] = v_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br></code></pre></td></tr></table></figure><h3 id="Block-py"><a href="#Block-py" class="headerlink" title="Block.py"></a>Block.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># 用于生成阻碍物</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Block</span>:<br>    __lock = th.Lock()<br>    __blockCount = <span class="hljs-number">0</span><br>    __unCheckedNodes = []<br>    __checkedNodes = []<br>    __isImpassable = <span class="hljs-literal">False</span><br>    __generateNum = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_blcokCount: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param p_blcokCount: 生成的障碍物的数量</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.__class__.__blockCount = p_blcokCount<br>        <span class="hljs-variable language_">self</span>.__endNode = sd.SharedNodes().GetEndNode()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(Block, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls.__lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(Block, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    Block.__instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> Block.__instance<br><br>    <span class="hljs-comment"># 用于生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Create</span>(<span class="hljs-params">self</span>):<br>        v_list = []<br>        v_curNode = sd.SharedNodes().GetStartNode()<br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._BlockNodeCheck(v_list, v_curNode) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            v_list = <span class="hljs-variable language_">self</span>._SelectNode()<br>            <span class="hljs-variable language_">self</span>._Reset()<br>        sd.SharedData.blockInfo = <span class="hljs-string">&#x27;生成BlockNode集次数:&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__class__.__generateNum)<br>        v_list = <span class="hljs-variable language_">self</span>._GenerateBlock(v_list)<br>        sd.SharedNodes().Submit(v_list)<br>        <span class="hljs-variable language_">self</span>._MarkBlockNode(v_list)<br><br>    <span class="hljs-comment"># 生成BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SelectNode</span>(<span class="hljs-params">self</span>):<br>        v_list = node.NodeFactory().GenerateNodes(<span class="hljs-variable language_">self</span>.__class__.__blockCount, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 对所生成的BlockNode集进行检测，若出现死胡同则重新生成BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_BlockNodeCheck</span>(<span class="hljs-params">self, p_list, p_curNode</span>):<br>        <span class="hljs-comment"># 若返回值为False：p_list为None，死胡同</span><br>        <span class="hljs-comment"># 若返回值为True：无死胡同</span><br>        <span class="hljs-comment"># p_list在这里代表的是生成的BlockNode集</span><br>        v_isImpassable = <span class="hljs-variable language_">self</span>.__class__.__isImpassable<br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_isImpassable <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_nextNodes = <span class="hljs-variable language_">self</span>._GetNextNodes(p_curNode, p_list)<br>            v_XNodes = <span class="hljs-variable language_">self</span>._GetXNodes(p_curNode.nodePos.x + <span class="hljs-number">1</span>, v_nextNodes)<br>            v_YNodes = <span class="hljs-variable language_">self</span>._GetYNodes(p_curNode.nodePos.y + <span class="hljs-number">1</span>, v_nextNodes)<br>            v_isContainX = node.NodeCheck.IsContainNodes(p_list, v_XNodes)<br>            v_isContainY = node.NodeCheck.IsContainNodes(p_list, v_YNodes)<br>            <span class="hljs-keyword">if</span> v_isContainX <span class="hljs-keyword">and</span> v_isContainY:<br>                <span class="hljs-variable language_">self</span>.__class__.__isImpassable = <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">elif</span> v_isContainX <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isContainY <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">if</span> v_nextNodes[<span class="hljs-number">0</span>] == <span class="hljs-variable language_">self</span>.__endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._BlockNodeCheck(p_list, v_nextNodes[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> v_isContainX:<br>                    v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, v_XNodes)<br>                <span class="hljs-keyword">else</span>:<br>                    v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, v_YNodes)<br>                <span class="hljs-keyword">if</span> v_nextNodes[<span class="hljs-number">0</span>] == <span class="hljs-variable language_">self</span>.__endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._BlockNodeCheck(p_list, v_nextNodes[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 打印Node集的方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Print</span>(<span class="hljs-params">self, p_list, p_str=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>        v_str = p_str<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_str += <span class="hljs-built_in">str</span>(n) + <span class="hljs-string">&#x27;---&#x27;</span><br>        <span class="hljs-built_in">print</span>(v_str)<br><br>    <span class="hljs-comment"># BlockNode集检测重置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Reset</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.__class__.__isImpassable = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>.__class__.__unCheckedNodes = []<br>        <span class="hljs-variable language_">self</span>.__class__.__checkedNodes = []<br>        <span class="hljs-variable language_">self</span>.__class__.__generateNum += <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># 获取处理后的NextNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNextNodes</span>(<span class="hljs-params">self, p_curNode, p_list</span>):<br>        v_uclist = <span class="hljs-variable language_">self</span>.__class__.__unCheckedNodes<br>        <span class="hljs-variable language_">self</span>.__class__.__unCheckedNodes = node.NodeDeal.RemoveNode(v_uclist, p_curNode)<br>        <span class="hljs-variable language_">self</span>.__class__.__checkedNodes.append(p_curNode)<br>        v_nextNodes = node.NodeFactory().GenerateNextNodes(p_curNode)<br>        v_nextNodes = node.NodeDeal.RemoveOutOfRangeNode(v_nextNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, <span class="hljs-variable language_">self</span>.__class__.__unCheckedNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, <span class="hljs-variable language_">self</span>.__class__.__checkedNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, p_list)<br>        v_nextNodes = node.NodeDeal.CalculateWeight(v_nextNodes, p_curNode, sd.SharedNodes().GetEndNode())<br>        v_nextNodes = node.NodeDeal.SortNodes(v_nextNodes)<br>        <span class="hljs-keyword">return</span> v_nextNodes<br><br>    <span class="hljs-comment"># 获取xNodes</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetXNodes</span>(<span class="hljs-params">self, p_x, p_list</span>):<br>        v_list = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_x = n.nodePos.x<br>            <span class="hljs-keyword">if</span> v_x == p_x:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 获取yNodes</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetYNodes</span>(<span class="hljs-params">self, p_y, p_list</span>):<br>        v_list = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_y = n.nodePos.y<br>            <span class="hljs-keyword">if</span> v_y == p_y:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GenerateBlock</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                n.nodeTag = node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 标记生成Block的Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_MarkBlockNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                grid.Grid.Mark(n, <span class="hljs-number">49</span>, <span class="hljs-string">&#x27;ks&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="SearchPath-py"><a href="#SearchPath-py" class="headerlink" title="SearchPath.py"></a>SearchPath.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># 查找最佳路径</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPath</span>:<br>    __lock = th.Lock()<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    __diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    __nonDiagonalCost = <span class="hljs-number">10</span><br>    __nodeFactory: node.NodeFactory<br>    __currentNode: node.Node<br>    <span class="hljs-comment"># 是否完成了初始化</span><br>    __isInit = <span class="hljs-literal">False</span><br>    __openList = []<br>    __closeList = []<br>    <span class="hljs-comment"># 网格行列数</span><br>    __rowsCount = <span class="hljs-number">0</span><br>    __colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># x和y的最小值</span><br>    __minX = <span class="hljs-number">0.5</span><br>    __minY = <span class="hljs-number">0.5</span><br>    <span class="hljs-comment"># x和y的最大值</span><br>    __maxX = <span class="hljs-number">0</span><br>    __maxY = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 终点Node</span><br>    __endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>.__class__.__nodeFactory = node.NodeFactory()<br>            <span class="hljs-variable language_">self</span>.__class__.__currentNode = sd.SharedNodes().GetStartNode()<br>            <span class="hljs-variable language_">self</span>.__class__.__openList.append(<span class="hljs-variable language_">self</span>.__class__.__currentNode)<br>            <span class="hljs-variable language_">self</span>.__class__.__rowsCount = sd.SharedData.rowsCount<br>            <span class="hljs-variable language_">self</span>.__class__.__colsCount = sd.SharedData.colsCount<br>            <span class="hljs-variable language_">self</span>.__class__.__maxX = <span class="hljs-variable language_">self</span>.__class__.__rowsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>.__class__.__maxY = <span class="hljs-variable language_">self</span>.__class__.__colsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>.__class__.__endNode = sd.SharedNodes().GetEndNode()<br>            <span class="hljs-variable language_">self</span>.__class__.__isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SearchPath, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls.__lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SearchPath, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    SearchPath.__instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> SearchPath.__instance<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params">self, p_isPrint=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        查找最佳路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_isPrint: 是否在控制台打印最佳路径的Node集信息,默认为False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._UpdateCurrentNode():<br>            <span class="hljs-comment"># 获取currentNode下一步可以前往的Node，并将它们保存在一个临时列表v_list中</span><br>            v_list = <span class="hljs-variable language_">self</span>.__class__.__nodeFactory.GenerateNextNodes(<span class="hljs-variable language_">self</span>.__class__.__currentNode)<br>            v_list = <span class="hljs-variable language_">self</span>._NodeCheck(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._CalculateWeight(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._SortNodes(v_list)<br>            <span class="hljs-variable language_">self</span>._AddNode(v_list)<br>        sd.SharedNodes().Submit(<span class="hljs-variable language_">self</span>.__class__.__closeList)<br>        <span class="hljs-keyword">if</span> p_isPrint:<br>            <span class="hljs-variable language_">self</span>._PrintPath()<br><br>    <span class="hljs-comment"># 检查临时列表p_list中哪些Node不符合要求，保留符合要求的节点</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list1 = []<br>            v_list2 = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> node.NodeCheck.OutOfRange(n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list1.append(n)<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list1:<br>                v_isInOpenList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__class__.__openList, n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__class__.__closeList, n)<br>                v_isInBlockList = node.NodeCheck.RepeatCheck(sd.SharedNodes().GetBlockNodes(), n)<br>                <span class="hljs-keyword">if</span> v_isInOpenList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInBlockList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list2.append(n)<br>            <span class="hljs-keyword">return</span> v_list2<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 计算临时列表p_list中每个Node的权值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CalculateWeight</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = node.NodeDeal.CalculateWeight(p_list, <span class="hljs-variable language_">self</span>.__class__.__currentNode, <span class="hljs-variable language_">self</span>.__class__.__endNode)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 根据临时列表p_list中每个Node的权值进行排序，权值越大越接近列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SortNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = node.NodeDeal.SortNodes(p_list)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 将临时列表p_list拼接在openList的列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p_list)):<br>                v_n = p_list[i]<br>                v_isInOpenList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__class__.__openList, v_n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__class__.__closeList, v_n)<br>                <span class="hljs-keyword">if</span> v_isInOpenList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(v_n)<br>            <span class="hljs-variable language_">self</span>.__class__.__openList.append(v_list[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 打印最佳路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PrintPath</span>(<span class="hljs-params">self</span>):<br>        v_str = <span class="hljs-string">&#x27;&#x27;</span><br>        v_length = <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.__class__.__closeList)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> i &lt; v_length - <span class="hljs-number">1</span>:<br>                v_str += <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__class__.__closeList[i]) + <span class="hljs-string">&#x27;--&gt;&#x27;</span><br>            <span class="hljs-keyword">else</span>:<br>                v_str += <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.__class__.__closeList[i])<br>        <span class="hljs-built_in">print</span>(v_str)<br><br>    <span class="hljs-comment"># 从openList中获取列表尾的元素，将之作为currentNode并加入closeList中，然后将其从openList中移除</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateCurrentNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.__class__.__openList) &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-variable language_">self</span>.__class__.__currentNode = <span class="hljs-variable language_">self</span>.__class__.__openList[<span class="hljs-number">0</span>]<br>            v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__class__.__closeList, <span class="hljs-variable language_">self</span>.__class__.__currentNode)<br>            <span class="hljs-keyword">if</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-variable language_">self</span>.__class__.__closeList.append(<span class="hljs-variable language_">self</span>.__class__.__currentNode)<br>                <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>.__class__.__openList[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__currentNode == <span class="hljs-variable language_">self</span>.__class__.__endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="SharedData-py"><a href="#SharedData-py" class="headerlink" title="SharedData.py"></a>SharedData.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># 共享信息类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedData</span>:<br>    <span class="hljs-comment"># 网格行列数</span><br>    rowsCount = <span class="hljs-number">0</span><br>    colsCount = <span class="hljs-number">0</span><br>    blockInfo = <span class="hljs-string">&#x27;&#x27;</span><br><br><br><span class="hljs-comment"># 共享Node和Node集</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedNodes</span>:<br>    __instanceLock = th.Lock()<br>    __lock = th.Lock()<br>    __sharedNodes = []<br>    __pathNodes = []<br>    __blockNodes = []<br>    __isUpdatePathNodes = <span class="hljs-literal">False</span><br>    __isUpdateBlockNodes = <span class="hljs-literal">False</span><br>    __startNode: node.Node<br>    __endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        node.NodeFactory()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SharedNodes, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls.__instanceLock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SharedNodes, <span class="hljs-string">&#x27;__instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    SharedNodes.__instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> SharedNodes.__instance<br><br>    <span class="hljs-comment"># 起始点Node的设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetStartNode</span>(<span class="hljs-params">self, p_node: node.Node, p_password: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_password == <span class="hljs-string">&#x27;SNSET&#x27;</span>:<br>            <span class="hljs-variable language_">self</span>.__class__.__startNode = p_node<br><br>    <span class="hljs-comment"># 终点Node的设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetEndNode</span>(<span class="hljs-params">self, p_node: node.Node, p_password: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_password == <span class="hljs-string">&#x27;ENSET&#x27;</span>:<br>            <span class="hljs-variable language_">self</span>.__class__.__endNode = p_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetStartNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取起始点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_node = node.Node(<span class="hljs-variable language_">self</span>.__class__.__startNode.nodeName, <span class="hljs-variable language_">self</span>.__class__.__startNode.nodePos)<br>        v_node.f = <span class="hljs-variable language_">self</span>.__class__.__startNode.f<br>        v_node.g = <span class="hljs-variable language_">self</span>.__class__.__startNode.g<br>        v_node.h = <span class="hljs-variable language_">self</span>.__class__.__startNode.h<br>        v_node.nodeTag = <span class="hljs-variable language_">self</span>.__class__.__startNode.nodeTag<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetEndNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取终点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_node = node.Node(<span class="hljs-variable language_">self</span>.__class__.__endNode.nodeName, <span class="hljs-variable language_">self</span>.__class__.__endNode.nodePos)<br>        v_node.f = <span class="hljs-variable language_">self</span>.__class__.__endNode.f<br>        v_node.g = <span class="hljs-variable language_">self</span>.__class__.__endNode.g<br>        v_node.h = <span class="hljs-variable language_">self</span>.__class__.__endNode.h<br>        v_node.nodeTag = <span class="hljs-variable language_">self</span>.__class__.__endNode.nodeTag<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetPathNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 起初该方法是直接返回cls.__pathNodes，这就导致了数据安全性的问题，使得在外部可以直接修改这里pathNodes的数据，所以正确的做法应该像现在这样</span><br>        <span class="hljs-comment"># 声明一个新的列表，然后将cls.__pathNodes中的值添加进去，再将新的列表作为返回值传递出去，这说明在Python中直接传递内部的静态变量会传递其引用</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取PathNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(node.NodeTag.PATHNODE)<br>        v_pathNodes = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.__class__.__pathNodes:<br>            v_pathNodes.append(n)<br>        <span class="hljs-keyword">return</span> v_pathNodes<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetBlockNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取BlockNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(node.NodeTag.BLOCKNODE)<br>        v_blockNodes = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.__class__.__blockNodes:<br>            v_blockNodes.append(n)<br>        <span class="hljs-keyword">return</span> v_blockNodes<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Submit</span>(<span class="hljs-params">self, p_list: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        通过该方法可以实现Node集的添加、删除、修改，建议与GetPathNodes或GetBlockNodes方法配套使用</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 修改后的Node集</span><br><span class="hljs-string">        :return: 无返回值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = node.NodeDeal.RemoveRepeateNode(p_list)<br>        v_list = <span class="hljs-variable language_">self</span>._PollutionNodeCheck(v_list)<br>        <span class="hljs-variable language_">self</span>._ReplaceSharedNodes(v_list)<br>        <span class="hljs-variable language_">self</span>._AddToSharedNodes(v_list)<br>        v_tag = <span class="hljs-variable language_">self</span>._GetNodesType(v_list)<br>        <span class="hljs-variable language_">self</span>._DeleteSharedNodes(v_list, v_tag)<br>        <span class="hljs-keyword">if</span> v_tag == node.NodeTag.PATHNODE:<br>            <span class="hljs-variable language_">self</span>.__class__.__isUpdatePathNodes = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.__class__.__isUpdateBlockNodes = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(v_tag)<br><br>    <span class="hljs-comment"># 更新PathNode集和BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateNodes</span>(<span class="hljs-params">self, p_tag</span>):<br>        <span class="hljs-keyword">if</span> p_tag == node.NodeTag.PATHNODE:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__isUpdatePathNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.__class__.__lock:<br>                    v_list = []<br>                    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.__class__.__sharedNodes:<br>                        <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.PATHNODE:<br>                            v_list.append(n)<br>                    <span class="hljs-variable language_">self</span>.__class__.__pathNodes = v_list<br>                <span class="hljs-variable language_">self</span>.__class__.__isUpdatePathNodes = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.__class__.__isUpdateBlockNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.__class__.__lock:<br>                    v_list = []<br>                    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.__class__.__sharedNodes:<br>                        <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.BLOCKNODE:<br>                            v_list.append(n)<br>                    <span class="hljs-variable language_">self</span>.__class__.__blockNodes = v_list<br>                <span class="hljs-variable language_">self</span>.__class__.__isUpdateBlockNodes = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 脏数据清理</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PollutionNodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_tag = <span class="hljs-variable language_">self</span>._GetNodesType(p_list)<br>            <span class="hljs-keyword">if</span> v_tag <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> p_list<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n.nodeTag == v_tag:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 获取当前Node集的种类：PathNode集或BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNodesType</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_pathNodeCount = <span class="hljs-number">0</span><br>            v_blockNodeCount = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.PATHNODE:<br>                    v_pathNodeCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_blockNodeCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> v_pathNodeCount &gt; v_blockNodeCount:<br>                <span class="hljs-keyword">return</span> node.NodeTag.PATHNODE<br>            <span class="hljs-keyword">elif</span> v_pathNodeCount &lt; v_blockNodeCount:<br>                <span class="hljs-keyword">return</span> node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># Node集的修改功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_ReplaceSharedNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.__class__.__lock:<br>                v_list = <span class="hljs-variable language_">self</span>.__class__.__sharedNodes<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                    v_list = node.NodeDeal.ReplaceNode(v_list, n)<br>                <span class="hljs-variable language_">self</span>.__class__.__sharedNodes = v_list<br><br>    <span class="hljs-comment"># Node集的添加功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddToSharedNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.__class__.__lock:<br>                v_list = []<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                    <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>.__class__.__sharedNodes, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        v_list.append(n)<br>                <span class="hljs-variable language_">self</span>.__class__.__sharedNodes.extend(v_list)<br><br>    <span class="hljs-comment"># Node集的删除功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_DeleteSharedNodes</span>(<span class="hljs-params">self, p_list: <span class="hljs-built_in">list</span>, p_tag: node.NodeTag</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>.__class__.__lock:<br>                <span class="hljs-keyword">if</span> p_tag == node.NodeTag.PATHNODE:<br>                    v_nodes = <span class="hljs-variable language_">self</span>.__class__.__pathNodes<br>                <span class="hljs-keyword">else</span>:<br>                    v_nodes = <span class="hljs-variable language_">self</span>.__class__.__blockNodes<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_nodes:<br>                    <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(p_list, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        v_index = <span class="hljs-variable language_">self</span>.__class__.__sharedNodes.index(n)<br>                        <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>.__class__.__sharedNodes[v_index]<br></code></pre></td></tr></table></figure><h3 id="Main-py"><a href="#Main-py" class="headerlink" title="Main.py"></a>Main.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Block <span class="hljs-keyword">as</span> block<br><br>g = grid.Grid()<br>block.Block(<span class="hljs-number">28</span>).Create()<br>sp.SearchPath().Search()<br>g.Draw()<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次主要针对“死胡同“问题进行了探索，我们采用了预寻路的方式检测当前生成的BlockNode集是否合理，这种方式的平均时间复杂度与障碍物Node与网格总Node的比值成正比，也就是说当我们的网格总Node数不变时，若生成的障碍物Node数量越多，往往重新生成BlockNode集的次数也会增多。除此之外我们优化了对Node类的管理，将之前杂乱的代码进行了重新分块，提炼出了数据层家族的新成员——NodeCheck类、NodeDeal类和SharedNodes类，NodeCheck类用于对Node或Node集进行检测，NodeDeal类用于对Node或Node集进行处理，SharedNodes类用于管理Node或Node集的获取，相当于一个Node仓库，目前我们将PathNode集和BlockNode集存放在其中，而且起始点Node和终点Node的获取也放在了这个仓库中，关于这个仓库的实现，我想在”A-Star算法探索和实现特别篇（一）“中进行记录。</p>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 寻路算法 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>A-Star算法探索和实现（四）</title>
      
      <link href="/posts/2026/01/07/db8255b6143e/"/>
      <url>/posts/2026/01/07/db8255b6143e/</url>
      
        <content type="html"><![CDATA[<blockquote><p>A-Star算法探索和实现系列博文不具备参考价值，仅仅作为个人探索和尝试的记录！</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇我们针对障碍物的“死胡同”问题进行了探索，本篇则针对障碍物生成在网格对角顶点处是否有意义以及路径周围存在障碍物时按照对角线移动是否合理两个问题进行探讨，这两个问题主要在于移动规则的限定，主要分为以下两种情况：</p><ol><li><p>如果我们允许这种类似“穿墙”的行为。</p></li><li><p>障碍物之间并非完全连接而是留有一定的距离，并且这个距离允许我们通过。</p></li></ol><p>当我们的移动规则包括上述其中一种情况时，我们在网格对角顶点处生成障碍物则没有意义，因为这么做并不能阻碍我们的移动，并且路径周围存在障碍物时按照对角线移动是被允许的，反之如果我们的移动规则中并不包括上述两种情况，那么我们就不允许周围存在障碍物时去沿着对角线移动，因为这么做就好比我们的半边身体从障碍物中穿过，如果我们允许这么做，那么就是对应着上述的第一种情况，此时在网格对角顶点处生成障碍物则有意义。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>既然我们明确了这两个问题是由移动规则所定，且两个问题可以作为一个问题进行讨论，那么我们就有两个不同的答案，显然我们默认是第一个答案，而接下来我们就针对第二个答案进行讨论，也就是我们的移动规则中不包括“本篇摘要”中所述的两种情况。此时我们只需要在上一篇的预寻路中加入一个移动规则的判断，分为以下几种情况：</p><ul><li><p>从当前Node移动至下一个Node时，如果是向左上方移动，则需要判断当前Node的上方和左侧是否存在障碍物Node，若不存在则允许斜向移动，否则不允许；</p></li><li><p>从当前Node移动至下一个Node时，如果是向右上方移动，则需要判断当前Node的上方和右侧是否存在障碍物Node，若不存在则允许斜向移动，否则不允许；</p></li><li><p>从当前Node移动至下一个Node时，如果是向左下方移动，则需要判断当前Node的下方和左侧是否存在障碍物Node，若不存在则允许斜向移动，否则不允许；</p></li><li><p>从当前Node移动至下一个Node时，如果是向右下方移动，则需要判断当前Node的下方和右侧是否存在障碍物Node，若不存在则允许斜向移动，否则不允许；</p></li><li><p>从当前Node移动至下一个Node时，如果是向左或向上或向右或向下，并且无特殊的移动规则限定，那么无需经过检测，默认为允许移动；</p></li></ul><p>当然，这种处理方式，应该与我们进行实际移动的规则保持一致，因为预寻路是对实际寻路的一种预测，我们拿它来判断BlockNode集的布置是否合理，那么相对的实际寻路时会有可能采用预寻路所合成的路线，为什么不肯定说二者路线一致呢？因为预寻路只要求从起始点到终点至少存在一条可行的路线即可，但是实际寻路时可能会有多条可行的路线，而我们目前的查找最佳路径的方式还需要改进，所以实际寻路也可能不是采用预寻路所合成的路线。</p><h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><img src="/posts/2026/01/07/db8255b6143e/img1.jpeg" class="" width="722" height="594"><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><img src="/posts/2026/01/07/db8255b6143e/img2.jpeg" class="" width="642" height="542">  <img src="/posts/2026/01/07/db8255b6143e/img3.jpeg" class="" width="642" height="542">  <img src="/posts/2026/01/07/db8255b6143e/img4.jpeg" class="" width="642" height="542">  <h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Grid-py"><a href="#Grid-py" class="headerlink" title="Grid.py"></a>Grid.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> pp<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 视图的构建和绘制</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Grid</span>:<br>    <span class="hljs-comment"># 横纵坐标轴的刻度标记</span><br>    _xLabels = []<br>    _yLabels = []<br>    <span class="hljs-comment"># 网格单元格的信息</span><br>    _data = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 是否完成初始化</span><br>    _isInit = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_rowsCount=<span class="hljs-number">6</span>, p_colsCount=<span class="hljs-number">6</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-comment"># 网格的行列数</span><br>            <span class="hljs-variable language_">self</span>._rowsCount = p_rowsCount<br>            <span class="hljs-variable language_">self</span>._colsCount = p_colsCount<br>            <span class="hljs-comment"># 将网格的行列数设置为共享信息</span><br>            sd.SharedData.rowsCount = <span class="hljs-variable language_">self</span>._rowsCount<br>            sd.SharedData.colsCount = <span class="hljs-variable language_">self</span>._colsCount<br>            <span class="hljs-variable language_">self</span>._isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 绘制图形</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;绘制图形&quot;&quot;&quot;</span><br>        pp.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]<br>        pp.title(sd.SharedData.blockInfo)<br>        <span class="hljs-comment"># 获取坐标轴实例</span><br>        v_ax = pp.gca()<br>        <span class="hljs-variable language_">self</span>._AxisSet(v_ax)<br>        <span class="hljs-variable language_">self</span>._GridValueSet(v_ax)<br>        <span class="hljs-comment"># 将数据以二维图片的形式进行显示</span><br>        v_ax.imshow(<span class="hljs-variable language_">self</span>._data, cmap=<span class="hljs-string">&#x27;Accent&#x27;</span>, aspect=<span class="hljs-string">&#x27;equal&#x27;</span>, vmin=<span class="hljs-number">0</span>, vmax=<span class="hljs-number">255</span>)<br>        <span class="hljs-comment"># 标记起始点和终点</span><br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedNodes().GetStartNode(), <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;go&#x27;</span>)<br>        <span class="hljs-variable language_">self</span>._PathNodeSet()<br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedNodes().GetEndNode(), <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;ro&#x27;</span>)<br>        <span class="hljs-comment"># 布置网格线</span><br>        pp.grid(visible=<span class="hljs-literal">True</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br>        pp.tight_layout()<br>        pp.show()<br><br>    <span class="hljs-comment"># 标记所查找到的路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PathNodeSet</span>(<span class="hljs-params">self</span>):<br>        v_pathNodes = sd.SharedNodes().GetPathNodes()<br>        v_length = <span class="hljs-built_in">len</span>(v_pathNodes)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; i &lt; v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>.Mark(v_pathNodes[i], <span class="hljs-number">10</span>, <span class="hljs-string">&#x27;bo&#x27;</span>)<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br>            <span class="hljs-keyword">elif</span> i == v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br><br>    <span class="hljs-comment"># 标记方法</span><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Mark</span>(<span class="hljs-params">cls, p_node: node.Node, p_marksize: <span class="hljs-built_in">int</span>, p_fmt: <span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        标记Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_node**:表示待标记的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_marksize**：表示标记的尺寸大小</span><br><span class="hljs-string"></span><br><span class="hljs-string">        **p_fmt**：表示颜色和图形的样式描述</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        pp.plot(v_x, v_y, p_fmt, markersize=p_marksize, zorder=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 箭头指向方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Arrow</span>(<span class="hljs-params">self, p_firstNode, p_secondNode</span>):<br>        v_dx = p_secondNode.nodePos.x - p_firstNode.nodePos.x<br>        v_dy = p_secondNode.nodePos.y - p_firstNode.nodePos.y<br>        pp.arrow(p_firstNode.nodePos.x, p_firstNode.nodePos.y, v_dx, v_dy, color=<span class="hljs-string">&#x27;orange&#x27;</span>, width=<span class="hljs-number">0.01</span>, head_width=<span class="hljs-number">0.08</span>,<br>                 zorder=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-comment"># 坐标轴设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AxisSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>._colsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>._xLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>._rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>._yLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-comment"># 隐藏刻度线</span><br>        v_ax.tick_params(left=<span class="hljs-literal">False</span>, bottom=<span class="hljs-literal">False</span>, top=<span class="hljs-literal">False</span>, right=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 生成Image Data</span><br>        v_low = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._rowsCount &gt; <span class="hljs-variable language_">self</span>._colsCount:<br>            v_high = <span class="hljs-variable language_">self</span>._rowsCount<br>        <span class="hljs-keyword">else</span>:<br>            v_high = <span class="hljs-variable language_">self</span>._colsCount<br>        <span class="hljs-variable language_">self</span>._data = np.random.randint(v_low, v_high, size=(<span class="hljs-variable language_">self</span>._rowsCount + <span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>._colsCount + <span class="hljs-number">1</span>))<br>        <span class="hljs-comment"># 设置横纵坐标轴的范围</span><br>        pp.xlim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>._colsCount)<br>        pp.ylim(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>._rowsCount)<br>        <span class="hljs-comment"># 设置坐标轴的刻度标记</span><br>        v_ax.set_xticks(np.arange(<span class="hljs-variable language_">self</span>._colsCount), labels=<span class="hljs-variable language_">self</span>._xLabels, visible=<span class="hljs-literal">False</span>)<br>        v_ax.set_yticks(np.arange(<span class="hljs-variable language_">self</span>._rowsCount), labels=<span class="hljs-variable language_">self</span>._yLabels, visible=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 设置坐标轴的横纵轴比例相等</span><br>        v_ax.set_aspect(<span class="hljs-string">&#x27;equal&#x27;</span>)<br><br>    <span class="hljs-comment"># 网格内容设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GridValueSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>._rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>._colsCount + <span class="hljs-number">1</span>):<br>                v_str = <span class="hljs-string">&#x27;(&#x27;</span> + <span class="hljs-built_in">str</span>(i + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(j + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;)&#x27;</span><br>                v_ax.text(i + <span class="hljs-number">0.5</span>, j + <span class="hljs-number">0.5</span>, v_str, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="Node-py"><a href="#Node-py" class="headerlink" title="Node.py"></a>Node.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># Node坐标类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePosition</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_x: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span>, p_y: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Node坐标信息初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_x: 横坐标值</span><br><span class="hljs-string">        :param p_y: 纵坐标值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.x = p_x<br>        <span class="hljs-variable language_">self</span>.y = p_y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;[&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.x) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.y) + <span class="hljs-string">&#x27;]&#x27;</span><br><br><br><span class="hljs-comment"># Node标签</span><br><span class="hljs-meta">@unique</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeTag</span>(<span class="hljs-title class_ inherited__">Enum</span>):<br>    PATHNODE = <span class="hljs-number">1</span><br>    BLOCKNODE = <span class="hljs-number">2</span><br><br><br><span class="hljs-comment"># Node类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_nodeName: <span class="hljs-built_in">str</span>, p_nodePos: NodePosition</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Node初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_nodeName: Node名称</span><br><span class="hljs-string">        :param p_nodePos: Node的坐标信息</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.nodeName = p_nodeName<br>        <span class="hljs-variable language_">self</span>.nodePos = p_nodePos<br>        <span class="hljs-comment"># f=g+h，g代表从上一个点到该点的代价和，h代表从该点到终点的代价和，f代表总权值weight</span><br>        <span class="hljs-variable language_">self</span>.f: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.g: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.h: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># Node的标签，用于判断是否为不可到达的Node，</span><br>        <span class="hljs-variable language_">self</span>.nodeTag = NodeTag.PATHNODE<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeight</span>(<span class="hljs-params">self, p_f: <span class="hljs-built_in">int</span>, p_g: <span class="hljs-built_in">int</span>, p_h: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置Node的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_f: 代表总权值weight, f = g + h</span><br><span class="hljs-string">        :param p_g: 代表从上一个点到该点的代价和</span><br><span class="hljs-string">        :param p_h: 代表从该点到终点的代价和</span><br><span class="hljs-string">        :return: 无返回值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.f = p_f<br>        <span class="hljs-variable language_">self</span>.g = p_g<br>        <span class="hljs-variable language_">self</span>.h = p_h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#123;nodeName:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeName + <span class="hljs-string">&#x27;,nodeTag:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeTag.name + <span class="hljs-string">&#x27;,nodePos:&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.nodePos) + <span class="hljs-string">&#x27;,f=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.f) + <span class="hljs-string">&#x27;,g=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.g) + <span class="hljs-string">&#x27;,h=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.h) + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">if</span> other <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.x == other.nodePos.x <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.y == other.nodePos.y:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node工厂，用来创建和获取起始点Node和终点Node</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeFactory</span>:<br>    _lock = th.Lock()<br>    _isCreateEndNode = <span class="hljs-literal">False</span><br>    _isCreateStartNode = <span class="hljs-literal">False</span><br>    _startNode: Node<br>    _endNode: Node<br>    <span class="hljs-comment"># Node名称索引</span><br>    _nameIndex = <span class="hljs-number">1</span><br>    <span class="hljs-comment"># GenerateOneNode的Node索引</span><br>    _rowIndex = <span class="hljs-number">1</span><br>    _colIndex = <span class="hljs-number">1</span><br>    _generateCount = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isCreateStartNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateStartNode()<br>            sd.SharedNodes().SetStartNode(<span class="hljs-variable language_">self</span>._startNode, <span class="hljs-string">&#x27;SNSET&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isCreateEndNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateEndNode()<br>            sd.SharedNodes().SetEndNode(<span class="hljs-variable language_">self</span>._endNode, <span class="hljs-string">&#x27;ENSET&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeFactory, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeFactory, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    NodeFactory._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> NodeFactory._instance<br><br>    <span class="hljs-comment"># 创建起始点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateStartNode</span>(<span class="hljs-params">self</span>):<br>        v_nodePos = NodePosition(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)<br>        <span class="hljs-variable language_">self</span>._startNode = Node(<span class="hljs-string">&#x27;StartNode&#x27;</span>, v_nodePos)<br>        <span class="hljs-variable language_">self</span>._isCreateStartNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 创建终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateEndNode</span>(<span class="hljs-params">self</span>):<br>        v_startNode = <span class="hljs-variable language_">self</span>._startNode<br>        v_node = v_startNode<br>        <span class="hljs-keyword">while</span> v_node == v_startNode:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;EndNode&#x27;</span>, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-variable language_">self</span>._endNode = v_node<br>        <span class="hljs-variable language_">self</span>._isCreateEndNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateXYNodes</span>(<span class="hljs-params">self, p_x=<span class="hljs-number">0</span>, p_y=<span class="hljs-number">0</span>, p_isRefX=<span class="hljs-literal">True</span>, p_isDefCheck=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成横坐标或纵坐标为指定参考值的Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_x: 横坐标参考值</span><br><span class="hljs-string">        :param p_y: 纵坐标参考值</span><br><span class="hljs-string">        :param p_isRefX: 是否以横坐标为参考坐标，默认为True，若为False则以纵坐标为参考坐标</span><br><span class="hljs-string">        :param p_isDefCheck: 是否开启默认检测，默认为True，会自动排除起始点Node和终点Node</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        v_index = <span class="hljs-number">1</span><br>        v_startNode = <span class="hljs-variable language_">self</span>._startNode<br>        v_endNode = <span class="hljs-variable language_">self</span>._endNode<br>        <span class="hljs-keyword">if</span> p_isRefX:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index))<br>                <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_j1 = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">if</span> p_isDefCheck:<br>                        v_j1 = v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode<br>                    <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> v_node.nodePos.x == p_x:<br>                        v_list.append(v_node)<br>                        v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index))<br>                <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_j1 = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">if</span> p_isDefCheck:<br>                        v_j1 = v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode<br>                    <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> v_node.nodePos.y == p_y:<br>                        v_list.append(v_node)<br>                        v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNodes</span>(<span class="hljs-params">self, p_count, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成指定数量的非重复Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_count: 生成的Node的数量</span><br><span class="hljs-string">        :param p_isRandom: 是否随机生成，默认为False</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        v_index = <span class="hljs-number">1</span><br>        v_startNode = <span class="hljs-variable language_">self</span>._startNode<br>        v_endNode = <span class="hljs-variable language_">self</span>._endNode<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(v_list) &lt; p_count:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index), p_isRandom=p_isRandom)<br>            <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                v_isRepeat = NodeCheck.RepeatCheck(v_list, v_node)<br>                <span class="hljs-keyword">if</span> v_isRepeat <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode:<br>                    v_list.append(v_node)<br>                    v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateOneNode</span>(<span class="hljs-params">self, p_name: <span class="hljs-built_in">str</span>, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成一个指定名称的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_name: 生成的Node的名称</span><br><span class="hljs-string">        :param p_isRandom: 是否随机生成，默认为False，若为True则为非随机模式生成，将按照起始点从左至右&amp;从下至上的顺序生成</span><br><span class="hljs-string">        :return: 默认会返回Node，在非随机生成模式下，当该方法生成完当前网格的所有Node后会进行重置并返回None，请保持对该方法的返回值是否为None的判断，避免陷入死循环</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_rowsCount = sd.SharedData.rowsCount<br>        v_colsCount = sd.SharedData.colsCount<br>        v_x = <span class="hljs-number">0.5</span><br>        v_y = <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">if</span> p_isRandom:<br>            v_i = random.randint(<span class="hljs-number">0</span>, v_rowsCount - <span class="hljs-number">1</span>)<br>            v_x = v_i + <span class="hljs-number">0.5</span><br>            v_i = random.randint(<span class="hljs-number">0</span>, v_colsCount - <span class="hljs-number">1</span>)<br>            v_y = v_i + <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._colIndex &lt; v_colsCount:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._rowIndex &gt; v_rowsCount:<br>                    <span class="hljs-variable language_">self</span>._rowIndex -= v_rowsCount<br>                    <span class="hljs-variable language_">self</span>._colIndex += <span class="hljs-number">1</span><br>                v_x = (<span class="hljs-variable language_">self</span>._rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                v_y = (<span class="hljs-variable language_">self</span>._colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                <span class="hljs-variable language_">self</span>._rowIndex += <span class="hljs-number">1</span><br>                <span class="hljs-variable language_">self</span>._generateCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._rowIndex &lt;= v_rowsCount:<br>                    v_x = (<span class="hljs-variable language_">self</span>._rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    v_y = (<span class="hljs-variable language_">self</span>._colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    <span class="hljs-variable language_">self</span>._rowIndex += <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>._generateCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-variable language_">self</span>._rowIndex = <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>._colIndex = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._generateCount &gt; v_rowsCount * v_colsCount:<br>                <span class="hljs-variable language_">self</span>._generateCount = <span class="hljs-number">0</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        v_nodePos = NodePosition(v_x, v_y)<br>        v_node = Node(p_name, v_nodePos)<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNextNodes</span>(<span class="hljs-params">self, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取某个Node下一步可以前往的Node集(NextNode集)</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 待生成NextNode集的Node</span><br><span class="hljs-string">        :return: 若p_node为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_p = p_node.nodePos<br>            v_posList = [(v_p.x - <span class="hljs-number">1</span>, v_p.y), (v_p.x - <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>), (v_p.x, v_p.y + <span class="hljs-number">1</span>), (v_p.x + <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>),<br>                         (v_p.x + <span class="hljs-number">1</span>, v_p.y), (v_p.x + <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>), (v_p.x, v_p.y - <span class="hljs-number">1</span>), (v_p.x - <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>)]<br>            v_nameList = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-string">&#x27;H&#x27;</span>]<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_posList)):<br>                v_nodeName = v_nameList[i] + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>._nameIndex)<br>                v_nodePos = NodePosition(v_posList[i][<span class="hljs-number">0</span>], v_posList[i][<span class="hljs-number">1</span>])<br>                v_node = Node(v_nodeName, v_nodePos)<br>                v_list.append(v_node)<br>            <span class="hljs-variable language_">self</span>._nameIndex += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> v_list<br><br><br><span class="hljs-comment"># Node或Node集的检测</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeCheck</span>:<br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RepeatCheck</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断Node集中是否存在某个Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :param p_node: 待检测的Node</span><br><span class="hljs-string">        :return: 存在返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n == p_node:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">OutOfRange</span>(<span class="hljs-params">cls, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断Node是否超出了网格限定范围</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 待检测的Node</span><br><span class="hljs-string">        :return:若超出了范围则返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_minX = <span class="hljs-number">0.5</span><br>        v_minY = <span class="hljs-number">0.5</span><br>        v_maxX = (sd.SharedData.rowsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_maxY = (sd.SharedData.colsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">if</span> v_minX &lt;= v_x &lt;= v_maxX <span class="hljs-keyword">and</span> v_minY &lt;= v_y &lt;= v_maxY:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">IsContainNodes</span>(<span class="hljs-params">cls, p_listA: <span class="hljs-built_in">list</span>[Node], p_listB: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断某个Node集（p_listA）是否包含另一个Node集（p_listB）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_listA: 待检测的Node集</span><br><span class="hljs-string">        :param p_listB: 被包含的Node集</span><br><span class="hljs-string">        :return: 若p_listA包含p_listB则返回True，否则返回False，若p_listA为None也会返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_listA <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_listA) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> p_listB <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(p_listB) == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_listB:<br>                    <span class="hljs-keyword">if</span> cls.RepeatCheck(p_listA, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node或Node集的处理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeDeal</span>:<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    _diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    _nonDiagonalCost = <span class="hljs-number">10</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveRepeateNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集中的重复Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :return: 若p_list为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            v_length = <span class="hljs-built_in">len</span>(p_list)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>                v_isRepeate = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, v_length):<br>                    <span class="hljs-keyword">if</span> p_list[i] == p_list[j]:<br>                        v_isRepeate = <span class="hljs-literal">True</span><br>                        <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> v_isRepeate <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(p_list[i])<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveNode</span>(<span class="hljs-params">cls, p_sourceList: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集（p_sourceList）中的某个Node（p_node）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_sourceList: 待处理的Node集</span><br><span class="hljs-string">        :param p_node: 参考Node</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_sourceList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_sourceList) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_sourceList:<br>                <span class="hljs-keyword">if</span> n != p_node:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_sourceList<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveNodes</span>(<span class="hljs-params">cls, p_sourceList: <span class="hljs-built_in">list</span>[Node], p_refList: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将一个Node集（p_sourceList）中另一个Node集（p_refList）的元素去除</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_sourceList: 待处理的原Node集</span><br><span class="hljs-string">        :param p_refList: 参考Node集</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_sourceList或p_refList为None则返回原Node集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_sourceList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_refList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_sourceList) != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_refList) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_sourceList:<br>                <span class="hljs-keyword">if</span> NodeCheck.RepeatCheck(p_refList, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_sourceList<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveOutOfRangeNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集中超出网格范围的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待处理的Node集</span><br><span class="hljs-string">        :return: 默认返回一个列表，如果p_list为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> NodeCheck.OutOfRange(n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ReplaceNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        替换Node集中与某个Node相同的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :param p_node: 用于替换的Node</span><br><span class="hljs-string">        :return: 若p_list和p_node为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">if</span> NodeCheck.RepeatCheck(v_list, p_node):<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">if</span> v_list[i] == p_node:<br>                        v_list[i] = p_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeightValue</span>(<span class="hljs-params">cls, p_diagonalCost: <span class="hljs-built_in">int</span> = <span class="hljs-number">14</span>, p_nonDiagonalCost: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置diagonalCost（对角线移动权值）和nonDiagonalCost（非对角线移动权值）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_diagonalCost: 对角线移动权值，默认为14</span><br><span class="hljs-string">        :param p_nonDiagonalCost: 非对角线移动权值，默认为10</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_diagonalCost &gt;= <span class="hljs-number">0</span>:<br>            cls.__diagonalCost = p_diagonalCost<br>        <span class="hljs-keyword">if</span> p_nonDiagonalCost &gt;= <span class="hljs-number">0</span>:<br>            cls.__nonDiagonalCost = p_nonDiagonalCost<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">CalculateWeight</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_startNode: Node, p_endNode: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        计算某个Node集相对起始点和终点的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待计算权值的Node集</span><br><span class="hljs-string">        :param p_startNode: 起始点</span><br><span class="hljs-string">        :param p_endNode: 终点</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_list或p_startNode或p_endNode有一个为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_startNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_endNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            v_startNodeX = p_startNode.nodePos.x<br>            v_startNodeY = p_startNode.nodePos.y<br>            v_endNodeX = p_endNode.nodePos.x<br>            v_endNodeY = p_endNode.nodePos.y<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                v_x = n.nodePos.x<br>                v_y = n.nodePos.y<br>                <span class="hljs-keyword">if</span> v_x == v_y:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * cls._diagonalCost<br>                    <span class="hljs-keyword">if</span> v_endNodeX == v_endNodeY:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * cls._diagonalCost<br>                    <span class="hljs-keyword">else</span>:<br>                        v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * cls._nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                            (v_endNodeY - v_y)) * cls._nonDiagonalCost<br>                <span class="hljs-keyword">else</span>:<br>                    v_g = <span class="hljs-built_in">abs</span>((v_x - v_startNodeX)) * cls._nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_y - v_startNodeY)) * cls._nonDiagonalCost<br>                    v_h = <span class="hljs-built_in">abs</span>((v_endNodeX - v_x)) * cls._nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                        (v_endNodeY - v_y)) * cls._nonDiagonalCost<br>                v_f = v_g + v_h<br>                n.SetWeight(<span class="hljs-built_in">int</span>(v_f), <span class="hljs-built_in">int</span>(v_g), <span class="hljs-built_in">int</span>(v_h))<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SortNodes</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_endMax=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        对Node集按照总权值（f）进行排序</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待排序的Node集</span><br><span class="hljs-string">        :param p_endMax: 是否按照总权值从小到大排序，默认为True</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_list为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">if</span> p_endMax:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                        <span class="hljs-keyword">if</span> v_list[i].f &gt; v_list[j].f:<br>                            v_node = v_list[i]<br>                            v_list[i] = v_list[j]<br>                            v_list[j] = v_node<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                        <span class="hljs-keyword">if</span> v_list[i].f &lt; v_list[j].f:<br>                            v_node = v_list[i]<br>                            v_list[i] = v_list[j]<br>                            v_list[j] = v_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">PrintNodes</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_sep=<span class="hljs-string">&#x27;--&#x27;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        控制台打印Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待打印的Node集</span><br><span class="hljs-string">        :param p_sep: 每个Node之间的间隔符号，默认为&quot;--&quot;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_len = <span class="hljs-built_in">len</span>(p_list)<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_len != <span class="hljs-number">0</span>:<br>            v_str = <span class="hljs-string">&#x27;&#x27;</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_len):<br>                <span class="hljs-keyword">if</span> i &lt; v_len - <span class="hljs-number">1</span>:<br>                    v_str += <span class="hljs-built_in">str</span>(p_list[i]) + p_sep<br>                <span class="hljs-keyword">else</span>:<br>                    v_str += <span class="hljs-built_in">str</span>(p_list[i])<br>            <span class="hljs-built_in">print</span>(v_str)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;List is None or it&#x27;s length equals zero.&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="Block-py"><a href="#Block-py" class="headerlink" title="Block.py"></a>Block.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><br><br><span class="hljs-comment"># 用于生成阻碍物</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Block</span>:<br>    _lock = th.Lock()<br>    _blockCount = <span class="hljs-number">0</span><br>    _unCheckedNodes = []<br>    _checkedNodes = []<br>    _isImpassable = <span class="hljs-literal">False</span><br>    _generateNum = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_blcokCount: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param p_blcokCount: 生成的障碍物的数量</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._blockCount = p_blcokCount<br>        <span class="hljs-variable language_">self</span>._endNode = sd.SharedNodes().GetEndNode()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(Block, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(Block, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    Block._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> Block._instance<br><br>    <span class="hljs-comment"># 用于生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Create</span>(<span class="hljs-params">self</span>):<br>        v_list = []<br>        v_curNode = sd.SharedNodes().GetStartNode()<br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._StartImpasseCheck(v_list, v_curNode) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            v_list = <span class="hljs-variable language_">self</span>._SelectNode()<br>            <span class="hljs-variable language_">self</span>._Reset()<br>        sd.SharedData.blockInfo = <span class="hljs-string">&#x27;生成BlockNode集次数:&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>._generateNum)<br>        v_list = <span class="hljs-variable language_">self</span>._GenerateBlock(v_list)<br>        sd.SharedNodes().Submit(v_list)<br>        <span class="hljs-variable language_">self</span>._MarkBlockNode(v_list)<br><br>    <span class="hljs-comment"># 生成BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SelectNode</span>(<span class="hljs-params">self</span>):<br>        v_list = node.NodeFactory().GenerateNodes(<span class="hljs-variable language_">self</span>._blockCount, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 对所生成的BlockNode集进行检测，若出现死胡同则重新生成BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_StartImpasseCheck</span>(<span class="hljs-params">self, p_list, p_curNode</span>):<br>        <span class="hljs-comment"># 若返回值为False：p_list为None或死胡同</span><br>        <span class="hljs-comment"># 若返回值为True：无死胡同</span><br>        <span class="hljs-comment"># p_list在这里代表的是生成的BlockNode集</span><br>        v_isImpassable = <span class="hljs-variable language_">self</span>._isImpassable<br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_isImpassable <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span><br>        v_nextNodes = <span class="hljs-variable language_">self</span>._GetNextNodes(p_curNode, p_list)<br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_nextNodes) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> sp.NodeMove().MoveCheck(p_list, v_nextNodes, p_curNode) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            v_nextNodes = sp.NodeMove().GetNextNodes(p_list, v_nextNodes, p_curNode, p_isDefCheck=<span class="hljs-literal">False</span>)<br>            v_XNodes = <span class="hljs-variable language_">self</span>._GetXNodes(p_curNode.nodePos.x + <span class="hljs-number">1</span>, v_nextNodes)<br>            v_YNodes = <span class="hljs-variable language_">self</span>._GetYNodes(p_curNode.nodePos.y + <span class="hljs-number">1</span>, v_nextNodes)<br>            v_isContainX = node.NodeCheck.IsContainNodes(p_list, v_XNodes)<br>            v_isContainY = node.NodeCheck.IsContainNodes(p_list, v_YNodes)<br>            <span class="hljs-keyword">if</span> v_isContainX <span class="hljs-keyword">and</span> v_isContainY:<br>                <span class="hljs-variable language_">self</span>._isImpassable = <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">elif</span> v_isContainX <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isContainY <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">if</span> v_nextNodes[<span class="hljs-number">0</span>] == <span class="hljs-variable language_">self</span>._endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._StartImpasseCheck(p_list, v_nextNodes[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> v_isContainX:<br>                    v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, v_XNodes)<br>                <span class="hljs-keyword">else</span>:<br>                    v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, v_YNodes)<br>                <span class="hljs-keyword">if</span> v_nextNodes[<span class="hljs-number">0</span>] == <span class="hljs-variable language_">self</span>._endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._StartImpasseCheck(p_list, v_nextNodes[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># BlockNode集检测重置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Reset</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>._isImpassable = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._unCheckedNodes = []<br>        <span class="hljs-variable language_">self</span>._checkedNodes = []<br>        <span class="hljs-variable language_">self</span>._generateNum += <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># 获取处理后的NextNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNextNodes</span>(<span class="hljs-params">self, p_curNode, p_list</span>):<br>        v_uclist = <span class="hljs-variable language_">self</span>._unCheckedNodes<br>        <span class="hljs-variable language_">self</span>._unCheckedNodes = node.NodeDeal.RemoveNode(v_uclist, p_curNode)<br>        <span class="hljs-variable language_">self</span>._checkedNodes.append(p_curNode)<br>        v_nextNodes = node.NodeFactory().GenerateNextNodes(p_curNode)<br>        v_nextNodes = node.NodeDeal.RemoveOutOfRangeNode(v_nextNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, <span class="hljs-variable language_">self</span>._unCheckedNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, <span class="hljs-variable language_">self</span>._checkedNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, p_list)<br>        v_nextNodes = node.NodeDeal.CalculateWeight(v_nextNodes, p_curNode, sd.SharedNodes().GetEndNode())<br>        v_nextNodes = node.NodeDeal.SortNodes(v_nextNodes)<br>        <span class="hljs-keyword">return</span> v_nextNodes<br><br>    <span class="hljs-comment"># 获取xNodes</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetXNodes</span>(<span class="hljs-params">self, p_x, p_list</span>):<br>        v_list = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_x = n.nodePos.x<br>            <span class="hljs-keyword">if</span> v_x == p_x:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 获取yNodes</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetYNodes</span>(<span class="hljs-params">self, p_y, p_list</span>):<br>        v_list = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_y = n.nodePos.y<br>            <span class="hljs-keyword">if</span> v_y == p_y:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GenerateBlock</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                n.nodeTag = node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 标记生成Block的Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_MarkBlockNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                grid.Grid.Mark(n, <span class="hljs-number">49</span>, <span class="hljs-string">&#x27;ks&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="SearchPath-py"><a href="#SearchPath-py" class="headerlink" title="SearchPath.py"></a>SearchPath.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><br><br><span class="hljs-meta">@unique</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Direction</span>(<span class="hljs-title class_ inherited__">Enum</span>):<br>    LeftUp = <span class="hljs-number">1</span><br>    RightUp = <span class="hljs-number">2</span><br>    LeftDown = <span class="hljs-number">3</span><br>    RightDown = <span class="hljs-number">4</span><br>    Left = <span class="hljs-number">5</span><br>    Right = <span class="hljs-number">6</span><br>    Up = <span class="hljs-number">7</span><br>    Down = <span class="hljs-number">8</span><br><br><br><span class="hljs-comment"># Node移动规则类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeMove</span>:<br>    _lock = th.Lock()<br>    _init = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._init <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._nextNodes = []<br>            <span class="hljs-variable language_">self</span>._init = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeMove, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeMove, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    NodeMove._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> NodeMove._instance<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetNextNodes</span>(<span class="hljs-params">self, p_blockNodes: <span class="hljs-built_in">list</span>[node.Node], p_nextNodes: <span class="hljs-built_in">list</span>[node.Node], p_curNode: node.Node,</span><br><span class="hljs-params">                     p_isDefCheck=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取经过移动检测的NextNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_blockNodes: 障碍物Node集</span><br><span class="hljs-string">        :param p_nextNodes: 当前Node的下一步Node集</span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :param p_isDefCheck: 是否开启移动检测，默认为True，若开启移动检测则自动调用MoveCheck方法</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        <span class="hljs-keyword">if</span> p_isDefCheck:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.MoveCheck(p_blockNodes, p_nextNodes, p_curNode):<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._nextNodes:<br>                    v_list.append(n)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._nextNodes:<br>                v_list.append(n)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._nextNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>._nextNodes) == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> p_nextNodes<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetMoveDirection</span>(<span class="hljs-params">self, p_curNode: node.Node, p_nextNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取当前Node至下一个Node的移动方向</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :param p_nextNode: 下一个Node</span><br><span class="hljs-string">        :return: 返回一个Direction枚举值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_curX = p_curNode.nodePos.x<br>        v_curY = p_curNode.nodePos.y<br>        v_neX = p_nextNode.nodePos.x<br>        v_neY = p_nextNode.nodePos.y<br>        v_X = v_neX - v_curX<br>        v_Y = v_neY - v_curY<br>        <span class="hljs-keyword">if</span> v_X == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> Direction.Left<br>        <span class="hljs-keyword">elif</span> v_X == -<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> Direction.LeftUp<br>        <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> Direction.Up<br>        <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> Direction.RightUp<br>        <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> Direction.Right<br>        <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> v_Y == -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> Direction.RightDown<br>        <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y == -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> Direction.Down<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> Direction.LeftDown<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">MoveCheck</span>(<span class="hljs-params">self, p_blockNodes: <span class="hljs-built_in">list</span>[node.Node], p_nextNodes: <span class="hljs-built_in">list</span>[node.Node], p_curNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移动规则检测</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_blockNodes: 障碍物Node集</span><br><span class="hljs-string">        :param p_nextNodes: 当前Node的下一步Node集</span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :return: 若下一步可前行，则返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_blockNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_nextNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        v_j2 = <span class="hljs-built_in">len</span>(p_blockNodes) != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_nextNodes) != <span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">or</span> v_j2 <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._nextNodes = []<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        v_nextNode = p_nextNodes[<span class="hljs-number">0</span>]<br>        v_curX = p_curNode.nodePos.x<br>        v_curY = p_curNode.nodePos.y<br>        v_direction = <span class="hljs-variable language_">self</span>.GetMoveDirection(p_curNode, v_nextNode)<br>        <span class="hljs-keyword">if</span> v_direction == Direction.LeftUp:<br>            v_x = v_curX - <span class="hljs-number">1</span><br>            v_y = v_curY + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> v_direction == Direction.RightUp:<br>            v_x = v_curX + <span class="hljs-number">1</span><br>            v_y = v_curY + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> v_direction == Direction.RightDown:<br>            v_x = v_curX + <span class="hljs-number">1</span><br>            v_y = v_curY - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> v_direction == Direction.LeftDown:<br>            v_x = v_curX - <span class="hljs-number">1</span><br>            v_y = v_curY - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._nextNodes = p_nextNodes<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        v_xNode = node.Node(<span class="hljs-string">&#x27;xNode&#x27;</span>, node.NodePosition(v_x, v_curY))<br>        v_yNode = node.Node(<span class="hljs-string">&#x27;yNode&#x27;</span>, node.NodePosition(v_curX, v_y))<br>        v_isContainX = node.NodeCheck.RepeatCheck(p_blockNodes, v_xNode)<br>        v_isContainY = node.NodeCheck.RepeatCheck(p_blockNodes, v_yNode)<br>        <span class="hljs-keyword">if</span> v_isContainX <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isContainY <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._nextNodes = p_nextNodes<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            v_nextNodes = node.NodeDeal.RemoveNode(p_nextNodes, v_nextNode)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(v_nextNodes) != <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.MoveCheck(p_blockNodes, v_nextNodes, p_curNode)<br>            <span class="hljs-variable language_">self</span>._nextNodes = []<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># 查找最佳路径</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPath</span>:<br>    _lock = th.Lock()<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    _diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    _nonDiagonalCost = <span class="hljs-number">10</span><br>    _nodeFactory: node.NodeFactory<br>    _currentNode: node.Node<br>    <span class="hljs-comment"># 是否完成了初始化</span><br>    _isInit = <span class="hljs-literal">False</span><br>    _openList = []<br>    _closeList = []<br>    <span class="hljs-comment"># 网格行列数</span><br>    _rowsCount = <span class="hljs-number">0</span><br>    _colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># x和y的最小值</span><br>    _minX = <span class="hljs-number">0.5</span><br>    _minY = <span class="hljs-number">0.5</span><br>    <span class="hljs-comment"># x和y的最大值</span><br>    _maxX = <span class="hljs-number">0</span><br>    _maxY = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 终点Node</span><br>    _endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._nodeFactory = node.NodeFactory()<br>            <span class="hljs-variable language_">self</span>._currentNode = sd.SharedNodes().GetStartNode()<br>            <span class="hljs-variable language_">self</span>._openList.append(<span class="hljs-variable language_">self</span>._currentNode)<br>            <span class="hljs-variable language_">self</span>._rowsCount = sd.SharedData.rowsCount<br>            <span class="hljs-variable language_">self</span>._colsCount = sd.SharedData.colsCount<br>            <span class="hljs-variable language_">self</span>._maxX = <span class="hljs-variable language_">self</span>._rowsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>._maxY = <span class="hljs-variable language_">self</span>._colsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>._endNode = sd.SharedNodes().GetEndNode()<br>            <span class="hljs-variable language_">self</span>._isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SearchPath, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SearchPath, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    SearchPath._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> SearchPath._instance<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params">self, p_isPrint=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        查找最佳路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_isPrint: 是否在控制台打印最佳路径的Node集信息,默认为False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._UpdateCurrentNode():<br>            <span class="hljs-comment"># 获取currentNode下一步可以前往的Node，并将它们保存在一个临时列表v_list中</span><br>            v_list = <span class="hljs-variable language_">self</span>._nodeFactory.GenerateNextNodes(<span class="hljs-variable language_">self</span>._currentNode)<br>            v_list = <span class="hljs-variable language_">self</span>._NodeCheck(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._CalculateWeight(v_list)<br>            v_list = <span class="hljs-variable language_">self</span>._SortNodes(v_list)<br>            v_list = NodeMove().GetNextNodes(sd.SharedNodes().GetBlockNodes(), v_list, <span class="hljs-variable language_">self</span>._currentNode)<br>            <span class="hljs-variable language_">self</span>._AddNode(v_list)<br>        sd.SharedNodes().Submit(<span class="hljs-variable language_">self</span>._closeList)<br>        <span class="hljs-keyword">if</span> p_isPrint:<br>            node.NodeDeal.PrintNodes(<span class="hljs-variable language_">self</span>._closeList, <span class="hljs-string">&#x27;--&gt;&#x27;</span>)<br><br>    <span class="hljs-comment"># 检查临时列表p_list中哪些Node不符合要求，保留符合要求的节点</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list1 = []<br>            v_list2 = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> node.NodeCheck.OutOfRange(n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list1.append(n)<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list1:<br>                v_isInOpenList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._openList, n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._closeList, n)<br>                v_isInBlockList = node.NodeCheck.RepeatCheck(sd.SharedNodes().GetBlockNodes(), n)<br>                <span class="hljs-keyword">if</span> v_isInOpenList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInBlockList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list2.append(n)<br>            <span class="hljs-keyword">return</span> v_list2<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 计算临时列表p_list中每个Node的权值</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CalculateWeight</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = node.NodeDeal.CalculateWeight(p_list, <span class="hljs-variable language_">self</span>._currentNode, <span class="hljs-variable language_">self</span>._endNode)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 根据临时列表p_list中每个Node的权值进行排序，权值越大越接近列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SortNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = node.NodeDeal.SortNodes(p_list)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 将临时列表p_list拼接在openList的列表尾</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p_list)):<br>                v_n = p_list[i]<br>                v_isInOpenList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._openList, v_n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._closeList, v_n)<br>                <span class="hljs-keyword">if</span> v_isInOpenList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(v_n)<br>            <span class="hljs-variable language_">self</span>._openList.append(v_list[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># 从openList中获取列表尾的元素，将之作为currentNode并加入closeList中，然后将其从openList中移除</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateCurrentNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>._openList) &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-variable language_">self</span>._currentNode = <span class="hljs-variable language_">self</span>._openList[<span class="hljs-number">0</span>]<br>            v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._closeList, <span class="hljs-variable language_">self</span>._currentNode)<br>            <span class="hljs-keyword">if</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-variable language_">self</span>._closeList.append(<span class="hljs-variable language_">self</span>._currentNode)<br>                <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>._openList[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._currentNode == <span class="hljs-variable language_">self</span>._endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="SharedData-py"><a href="#SharedData-py" class="headerlink" title="SharedData.py"></a>SharedData.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># 共享信息类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedData</span>:<br>    <span class="hljs-comment"># 网格行列数</span><br>    rowsCount = <span class="hljs-number">0</span><br>    colsCount = <span class="hljs-number">0</span><br>    blockInfo = <span class="hljs-string">&#x27;&#x27;</span><br><br><br><span class="hljs-comment"># 共享Node和Node集</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedNodes</span>:<br>    _instanceLock = th.Lock()<br>    _lock = th.Lock()<br>    _sharedNodes = []<br>    _pathNodes = []<br>    _blockNodes = []<br>    _isUpdatePathNodes = <span class="hljs-literal">False</span><br>    _isUpdateBlockNodes = <span class="hljs-literal">False</span><br>    _startNode: node.Node<br>    _endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        node.NodeFactory()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SharedNodes, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._instanceLock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SharedNodes, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    SharedNodes._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> SharedNodes._instance<br><br>    <span class="hljs-comment"># 起始点Node的设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetStartNode</span>(<span class="hljs-params">self, p_node: node.Node, p_password: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_password == <span class="hljs-string">&#x27;SNSET&#x27;</span>:<br>            <span class="hljs-variable language_">self</span>._startNode = p_node<br><br>    <span class="hljs-comment"># 终点Node的设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetEndNode</span>(<span class="hljs-params">self, p_node: node.Node, p_password: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_password == <span class="hljs-string">&#x27;ENSET&#x27;</span>:<br>            <span class="hljs-variable language_">self</span>._endNode = p_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetStartNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取起始点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_node = node.Node(<span class="hljs-variable language_">self</span>._startNode.nodeName, <span class="hljs-variable language_">self</span>._startNode.nodePos)<br>        v_node.f = <span class="hljs-variable language_">self</span>._startNode.f<br>        v_node.g = <span class="hljs-variable language_">self</span>._startNode.g<br>        v_node.h = <span class="hljs-variable language_">self</span>._startNode.h<br>        v_node.nodeTag = <span class="hljs-variable language_">self</span>._startNode.nodeTag<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetEndNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取终点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_node = node.Node(<span class="hljs-variable language_">self</span>._endNode.nodeName, <span class="hljs-variable language_">self</span>._endNode.nodePos)<br>        v_node.f = <span class="hljs-variable language_">self</span>._endNode.f<br>        v_node.g = <span class="hljs-variable language_">self</span>._endNode.g<br>        v_node.h = <span class="hljs-variable language_">self</span>._endNode.h<br>        v_node.nodeTag = <span class="hljs-variable language_">self</span>._endNode.nodeTag<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetPathNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 起初该方法是直接返回cls.__pathNodes，这就导致了数据安全性的问题，使得在外部可以直接修改这里pathNodes的数据，所以正确的做法应该像现在这样</span><br>        <span class="hljs-comment"># 声明一个新的列表，然后将cls.__pathNodes中的值添加进去，再将新的列表作为返回值传递出去，这说明在Python中直接传递内部的静态变量会传递其引用</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取PathNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(node.NodeTag.PATHNODE)<br>        v_pathNodes = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._pathNodes:<br>            v_pathNodes.append(n)<br>        <span class="hljs-keyword">return</span> v_pathNodes<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetBlockNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取BlockNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(node.NodeTag.BLOCKNODE)<br>        v_blockNodes = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._blockNodes:<br>            v_blockNodes.append(n)<br>        <span class="hljs-keyword">return</span> v_blockNodes<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Submit</span>(<span class="hljs-params">self, p_list: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        通过该方法可以实现Node集的添加、删除、修改，建议与GetPathNodes或GetBlockNodes方法配套使用</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 修改后的Node集</span><br><span class="hljs-string">        :return: 无返回值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = node.NodeDeal.RemoveRepeateNode(p_list)<br>        v_list = <span class="hljs-variable language_">self</span>._PollutionNodeCheck(v_list)<br>        <span class="hljs-variable language_">self</span>._ReplaceSharedNodes(v_list)<br>        <span class="hljs-variable language_">self</span>._AddToSharedNodes(v_list)<br>        v_tag = <span class="hljs-variable language_">self</span>._GetNodesType(v_list)<br>        <span class="hljs-variable language_">self</span>._DeleteSharedNodes(v_list, v_tag)<br>        <span class="hljs-keyword">if</span> v_tag == node.NodeTag.PATHNODE:<br>            <span class="hljs-variable language_">self</span>._isUpdatePathNodes = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._isUpdateBlockNodes = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(v_tag)<br><br>    <span class="hljs-comment"># 更新PathNode集和BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateNodes</span>(<span class="hljs-params">self, p_tag</span>):<br>        <span class="hljs-keyword">if</span> p_tag == node.NodeTag.PATHNODE:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isUpdatePathNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                    v_list = []<br>                    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._sharedNodes:<br>                        <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.PATHNODE:<br>                            v_list.append(n)<br>                    <span class="hljs-variable language_">self</span>._pathNodes = v_list<br>                <span class="hljs-variable language_">self</span>._isUpdatePathNodes = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isUpdateBlockNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                    v_list = []<br>                    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._sharedNodes:<br>                        <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.BLOCKNODE:<br>                            v_list.append(n)<br>                    <span class="hljs-variable language_">self</span>._blockNodes = v_list<br>                <span class="hljs-variable language_">self</span>._isUpdateBlockNodes = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 脏数据清理</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PollutionNodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_tag = <span class="hljs-variable language_">self</span>._GetNodesType(p_list)<br>            <span class="hljs-keyword">if</span> v_tag <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> p_list<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n.nodeTag == v_tag:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 获取当前Node集的种类：PathNode集或BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNodesType</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_pathNodeCount = <span class="hljs-number">0</span><br>            v_blockNodeCount = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.PATHNODE:<br>                    v_pathNodeCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_blockNodeCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> v_pathNodeCount &gt; v_blockNodeCount:<br>                <span class="hljs-keyword">return</span> node.NodeTag.PATHNODE<br>            <span class="hljs-keyword">elif</span> v_pathNodeCount &lt; v_blockNodeCount:<br>                <span class="hljs-keyword">return</span> node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># Node集的修改功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_ReplaceSharedNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                v_list = <span class="hljs-variable language_">self</span>._sharedNodes<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                    v_list = node.NodeDeal.ReplaceNode(v_list, n)<br>                <span class="hljs-variable language_">self</span>._sharedNodes = v_list<br><br>    <span class="hljs-comment"># Node集的添加功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddToSharedNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                v_list = []<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                    <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._sharedNodes, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        v_list.append(n)<br>                <span class="hljs-variable language_">self</span>._sharedNodes.extend(v_list)<br><br>    <span class="hljs-comment"># Node集的删除功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_DeleteSharedNodes</span>(<span class="hljs-params">self, p_list: <span class="hljs-built_in">list</span>, p_tag: node.NodeTag</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                <span class="hljs-keyword">if</span> p_tag == node.NodeTag.PATHNODE:<br>                    v_nodes = <span class="hljs-variable language_">self</span>._pathNodes<br>                <span class="hljs-keyword">else</span>:<br>                    v_nodes = <span class="hljs-variable language_">self</span>._blockNodes<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_nodes:<br>                    <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(p_list, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        v_index = <span class="hljs-variable language_">self</span>._sharedNodes.index(n)<br>                        <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>._sharedNodes[v_index]<br></code></pre></td></tr></table></figure><h3 id="Main-py"><a href="#Main-py" class="headerlink" title="Main.py"></a>Main.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Block <span class="hljs-keyword">as</span> block<br><br><br>g = grid.Grid()<br>block.Block(<span class="hljs-number">15</span>).Create()<br>sp.SearchPath().Search()<br>g.Draw()<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在本篇中我们实现了对移动规则的改变，当我们下一步是斜向移动时，会进行移动检测，如果下一步斜向移动符合移动规则，则允许移动，否则不允许，而负责移动规则检测的类是数据层家族的新成员——NodeMove类，通过这个类，我们可以在生成BlockNode集以及查找最佳路径时进行检测，以此来达到我们在“方案探讨”中所说的“预寻路和实际寻路的移动规则保持一致”的目的。</p>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 寻路算法 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>A-Star算法探索和实现（五）</title>
      
      <link href="/posts/2026/01/07/d521a2c9cac7/"/>
      <url>/posts/2026/01/07/d521a2c9cac7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>A-Star算法探索和实现系列博文不具备参考价值，仅仅作为个人探索和尝试的记录！</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在上一篇中我们对寻路的移动规则进行了制定，而在本篇我们将对最佳路径的查找方式进行优化，而这就会涉及到移动规则的检测改进、权值计算的改进、NextNode集的处理改进、寻路逻辑的改进，我们将从上述四个方面进行详细讲解。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="移动规则的检测改进：可移动检测、可替换斜向移动检测、可替换二次非斜向移动检测、方向Node集检测"><a href="#移动规则的检测改进：可移动检测、可替换斜向移动检测、可替换二次非斜向移动检测、方向Node集检测" class="headerlink" title="移动规则的检测改进：可移动检测、可替换斜向移动检测、可替换二次非斜向移动检测、方向Node集检测"></a>移动规则的检测改进：可移动检测、可替换斜向移动检测、可替换二次非斜向移动检测、方向Node集检测</h3><p>（1）可移动检测：检测当前Node的NextNode集中是否存在可以移动的下一步Node，这个基本的检测用于判断下一步是否可行。</p><p>（2）可替换斜向移动检测：检测是否存在一次斜向移动可替换两次非斜向移动的情况，如果存在，则进行替换，两次非斜向移动的权值高于一次斜向移动的权值，所以通过这个方式来优化最佳路径查找方式。</p><p>（3）可替换二次非斜向移动检测：检测是否存在二次斜向移动可替换为二次非斜向移动，如果存在，则进行替换，一次斜向移动的权值高于一次非斜向移动的权值，所以通过这个方式来优化最佳路径查找方式。</p><p>（4）方向Node集检测：检测当前Node的NextNode集中是否存在上一步Node至当前Node的方向Node集元素，如果存在则进行剔除，如下四图，CurNode（橙色圆）当前当前Node，NextNode（绿色圆）代表下一步Node，方向Node集为图中黄色方块，这就相似于A星算法中的OpenList，但是不同的是，OpenList是将上一步Node的NextNode集中所有元素进行添加，而方向Node集仅添加与前进方向相反方向的三个Node。</p><img src="/posts/2026/01/07/d521a2c9cac7/img1.jpeg" class="" width="300" height="300"><img src="/posts/2026/01/07/d521a2c9cac7/img2.jpeg" class="" width="300" height="300"><img src="/posts/2026/01/07/d521a2c9cac7/img3.jpeg" class="" width="300" height="300"><img src="/posts/2026/01/07/d521a2c9cac7/img4.jpeg" class="" width="300" height="300"><h3 id="权值计算的改进：G和H值的计算改进"><a href="#权值计算的改进：G和H值的计算改进" class="headerlink" title="权值计算的改进：G和H值的计算改进"></a>权值计算的改进：G和H值的计算改进</h3><h4 id="G值计算改进"><a href="#G值计算改进" class="headerlink" title="G值计算改进"></a>G值计算改进</h4><ul><li><p>设 StartNode（v_staX, v_staY）, CurNode（v_curX, v_curY）</p></li><li><p>计算：</p><ul><li><p>满足 abs(v_curX - v_staX) !&#x3D; abs(v_curY - v_staY)</p><p>v_g &#x3D; abs(v_curX - v_staX) * nonDiagonalCost+abs(v_curY - v_staY) * nonDiagonalCost</p></li><li><p>满足 abs(v_curX - v_staX) &#x3D;&#x3D; abs(v_curY - v_staY)</p><p>v_g &#x3D; abs(v_curX - v_staX) * diagonalCost</p></li></ul></li></ul><h4 id="H值计算改进"><a href="#H值计算改进" class="headerlink" title="H值计算改进"></a>H值计算改进</h4><ul><li><p>设 EndNode（v_endX, v_endY）, CurNode（v_curX, v_curY）,行数为 rowsCount，列数为 colsCount，则横坐标范围为 [0.5, (colsCount - 1) + 0.5]，纵坐标范围为 [0.5, (rowsCount - 1) + 0.5]，nonDiagonalCost为一次非斜向移动权值，diagonalCost为一次斜向移动权值，v_minCount代表rowsCount和colsCount二者之间最小的一个，若rowsCount &lt; colsCount则v_minCount &#x3D; rowsCount，否则v_minCount &#x3D; colsCount。</p></li><li><p>计算：</p><ul><li><p>满足v_curX &#x3D;&#x3D; v_endX</p><p>v_h &#x3D; abs(v_endX - v_curX) * nonDiagonalCost</p></li><li><p>满足v_curY &#x3D;&#x3D; v_endY</p><p>v_h&#x3D;abs(v_endY - v_curY) * nonDiagonalCost</p></li><li><p>满足 abs(v_curX - v_endX) &#x3D;&#x3D; abs(v_curY - v_endY)</p><p>v_h &#x3D; abs(v_curX - v_endX) * diagonalCost</p></li><li><p>满足 v_curY &gt; v_endY</p><ul><li><p>令v_x &#x3D; v_endX - i，v_y &#x3D; v_endY + i，i为区间[1, rowsCount - 0.5 - v_endY]内的整数</p><ul><li><p>满足 i &lt;&#x3D; v_endX - 0.5</p><ul><li><p>满足abs(v_curX - v_x) &#x3D;&#x3D; abs(v_curY - v_y)</p><ul><li><p>令v_xA &#x3D; v_x - j，v_yA &#x3D; v_y – j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xA &gt;&#x3D; 0.5 and v_yA &gt; v_endY</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li><li><p>令v_xB &#x3D; v_x + j，v_yB &#x3D; v_y + j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xB &lt; v_endX and v_yB &lt;&#x3D; v_rowsCount - 0.5</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li></ul></li><li><p>满足v_curY &#x3D;&#x3D; v_y</p><ul><li><p>满足v_curX &lt;&#x3D; v_x</p><p>v_h &#x3D; abs(v_x - v_curX) * nonDiagonalCost + i * diagonalCost</p></li><li><p>满足v_curX &gt; v_x</p><p>v_h &#x3D; (abs(v_endX - v_curX) + abs(v_curY - v_endY)) * nonDiagonalCost</p></li></ul></li><li><p>满足v_curX &#x3D;&#x3D; v_x</p><p>v_h &#x3D; abs(v_y - v_curY) * nonDiagonalCost + i * diagonalCost</p></li></ul></li></ul></li><li><p>令v_x &#x3D; v_endX + i，v_y &#x3D; v_endY + i，i为区间[1, rowsCount-0.5 - v_endY]内的整数</p><ul><li><p>满足i &lt;&#x3D; v_colsCount - 0.5 - v_endX</p><ul><li><p>满足abs(v_curX - v_x) &#x3D;&#x3D; abs(v_curY - v_y)</p><ul><li><p>令v_xA &#x3D; v_x + j，v_yA &#x3D; v_y – j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xA &lt;&#x3D; v_colsCount - 0.5 and v_yA &gt; v_endY</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li><li><p>令v_xB &#x3D; v_x - j，v_yB &#x3D; v_y + j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xB &gt; v_endX and v_yB &lt;&#x3D; v_rowsCount - 0.5</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li></ul></li><li><p>满足v_curY &#x3D;&#x3D; v_y</p><ul><li><p>满足v_curX &gt;&#x3D; v_x</p><p>v_h&#x3D;abs(v_curX - v_x) * nonDiagonalCost + i * diagonalCost</p></li><li><p>满足v_curX &lt; v_x</p><p>v_h&#x3D;(abs(v_curX - v_endX) + abs(v_curY - v_endY)) * nonDiagonalCost</p></li></ul></li><li><p>满足v_curX &#x3D;&#x3D; v_x</p><p>v_h&#x3D;abs(v_y - v_curY) * nonDiagonalCost + i * diagonalCost</p></li></ul></li></ul></li></ul></li><li><p>满足v_curY &lt; v_endY</p><ul><li><p>令v_x &#x3D; v_endX - i，v_y &#x3D; v_endY – i，i为区间[1, v_endY - 0.5]内的整数</p><ul><li><p>满足i &lt;&#x3D; v_endX - 0.5</p><ul><li><p>满足abs(v_curX - v_x) &#x3D;&#x3D; abs(v_curY - v_y)</p><ul><li><p>令v_xA &#x3D; v_x + j，v_yA &#x3D; v_y – j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xA &lt; v_endX and v_yA &gt;&#x3D; 0.5</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li><li><p>令v_xB &#x3D; v_x - j，v_yB &#x3D; v_y + j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xB &gt;&#x3D; 0.5 and v_yB &lt; v_endY</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li></ul></li><li><p>满足v_curY &#x3D;&#x3D; v_y</p><ul><li><p>满足v_curX &lt;&#x3D; v_x</p><p>v_h &#x3D; abs(v_x-v_curX) * nonDiagonalCost + i * diagonalCost</p></li><li><p>满足v_curX &gt; v_x</p><p>v_h &#x3D; (abs(v_endX - v_curX) + abs(v_endY - v_curY)) * nonDiagonalCost</p></li></ul></li><li><p>满足v_curX &#x3D;&#x3D; v_x</p><p>v_h &#x3D; abs(v_y - v_curY) * nonDiagonalCost + i * diagonalCost</p></li></ul></li></ul></li><li><p>令v_x &#x3D; v_endX + i，v_y &#x3D; v_endY – i，i为区间[1, v_endY - 0.5]内的整数</p><ul><li><p>满足i &lt;&#x3D; v_colsCount - 0.5 - v_endX</p><ul><li><p>满足abs(v_curX - v_x) &#x3D;&#x3D; abs(v_curY - v_y)</p><ul><li><p>令v_xA &#x3D; v_x - j，v_yA &#x3D; v_y – j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xA &gt; v_endX and v_yA &gt;&#x3D; 0.5</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li><li><p>令v_xB &#x3D; v_x + j，v_yB &#x3D; v_y + j，j为区间[1, v_minCount - 1]内的整数</p><ul><li><p>满足v_xB &lt;&#x3D; v_colsCount - 0.5 and v_yB &lt; v_endY</p><p>v_h &#x3D; (j + i) * diagonalCost</p></li></ul></li></ul></li><li><p>满足v_curY &#x3D;&#x3D; v_y</p><ul><li><p>满足v_curX &gt;&#x3D; v_x</p><p>v_h &#x3D; abs(v_curX - v_x) * nonDiagonalCost + i * diagonalCost</p></li><li><p>满足v_curX &lt; v_x</p><p>v_h &#x3D; (abs(v_curX - v_endX) + abs(v_endY - v_curY)) * nonDiagonalCost</p></li></ul></li><li><p>满足v_curX &#x3D;&#x3D; v_x</p><p>v_h &#x3D; abs(v_y - v_curY) * nonDiagonalCost + i * diagonalCost</p></li></ul></li></ul></li></ul></li><li><p>开始之前记得检测v_x和v_y是否超出有效范围，例如当终点Node位于网格最左边时，那么对于v_x &#x3D; v_endX - i的情况均超出网格有效范围，则直接进行排除，需要检测的情况通常是终点Node处于网格边界上，反之则不需要有效范围检测。</p></li></ul></li></ul><h3 id="NextNode集的处理改进：NextNode集生成、超出网格范围检测、特殊Node集元素包含检测、NextNode集权值计算、NextNode集排序"><a href="#NextNode集的处理改进：NextNode集生成、超出网格范围检测、特殊Node集元素包含检测、NextNode集权值计算、NextNode集排序" class="headerlink" title="NextNode集的处理改进：NextNode集生成、超出网格范围检测、特殊Node集元素包含检测、NextNode集权值计算、NextNode集排序"></a>NextNode集的处理改进：NextNode集生成、超出网格范围检测、特殊Node集元素包含检测、NextNode集权值计算、NextNode集排序</h3><ul><li><p>NextNode集生成：生成当前Node的下一步Node集</p></li><li><p>超出网格范围检测：将生成的NextNode集中超出网格范围的Node进行剔除</p></li><li><p>特殊Node集元素包含检测：将NextNode集中属于CloseList、BlockNode集、CheckedList的元素进行剔除</p></li><li><p>NextNode集权值计算：对NextNode集中的Node进行权值计算</p></li><li><p>NextNode集排序：对NextNode集中的Node按照权值小的在表头，从小到大进行排序</p></li></ul><h3 id="寻路逻辑的改进"><a href="#寻路逻辑的改进" class="headerlink" title="寻路逻辑的改进"></a>寻路逻辑的改进</h3><ul><li><p>更新当前Node</p></li><li><p>获取当前Node的NextNode集</p></li><li><p>对NextNode集进行移动检测</p></li><li><p>使用NextNode集</p></li><li><p>重复上述过程，直至到达终点，若出现无法到达终点的情况，则对最后一步Node进行上锁，上锁即代表到达终点前将无法使用该Node，然后重置相关参数，重新查找路径，直至找到一条可到达终点的路径。</p></li></ul><h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><img src="/posts/2026/01/07/d521a2c9cac7/img5.jpeg" class="" width="722" height="594"><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><img src="/posts/2026/01/07/d521a2c9cac7/img6.jpeg" class="" width="642" height="542"><img src="/posts/2026/01/07/d521a2c9cac7/img7.jpeg" class="" width="642" height="542"><img src="/posts/2026/01/07/d521a2c9cac7/img8.jpeg" class="" width="642" height="542"><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Grid-py"><a href="#Grid-py" class="headerlink" title="Grid.py"></a>Grid.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> pp<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><br><br><span class="hljs-comment"># 视图的构建和绘制</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Grid</span>:<br>    <span class="hljs-comment"># 横纵坐标轴的刻度标记</span><br>    _xLabels = []<br>    _yLabels = []<br>    <span class="hljs-comment"># 网格单元格的信息</span><br>    _data = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 是否完成初始化</span><br>    _isInit = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_rowsCount, p_colsCount, p_sizes: <span class="hljs-built_in">tuple</span> = (<span class="hljs-params"></span>)</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-comment"># 网格的行列数</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-number">3</span> &lt;= p_rowsCount &lt;= <span class="hljs-number">7</span>:<br>                <span class="hljs-variable language_">self</span>._rowsCount = p_rowsCount<br>            <span class="hljs-keyword">elif</span> p_rowsCount &lt; <span class="hljs-number">3</span>:<br>                <span class="hljs-variable language_">self</span>._rowsCount = <span class="hljs-number">3</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-variable language_">self</span>._rowsCount = <span class="hljs-number">7</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-number">3</span> &lt;= p_colsCount &lt;= <span class="hljs-number">7</span>:<br>                <span class="hljs-variable language_">self</span>._colsCount = p_colsCount<br>            <span class="hljs-keyword">elif</span> p_colsCount &lt; <span class="hljs-number">3</span>:<br>                <span class="hljs-variable language_">self</span>._colsCount = <span class="hljs-number">3</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-variable language_">self</span>._colsCount = <span class="hljs-number">7</span><br>            <span class="hljs-comment"># 将网格的行列数设置为共享信息</span><br>            sd.SharedData.rowsCount = <span class="hljs-variable language_">self</span>._rowsCount<br>            sd.SharedData.colsCount = <span class="hljs-variable language_">self</span>._colsCount<br>            <span class="hljs-comment"># 将各类尺寸大小设置为共享信息</span><br>            v_sizes = p_sizes<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p_sizes) == <span class="hljs-number">0</span>:<br>                v_sizes = sd.SharedData.GetSizes(<span class="hljs-variable language_">self</span>._rowsCount, <span class="hljs-variable language_">self</span>._colsCount)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_sizes)):<br>                <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:<br>                    sd.SharedData.startNodeSize = v_sizes[<span class="hljs-number">0</span>]<br>                <span class="hljs-keyword">elif</span> i == <span class="hljs-number">1</span>:<br>                    sd.SharedData.endNodeSize = v_sizes[<span class="hljs-number">1</span>]<br>                <span class="hljs-keyword">elif</span> i == <span class="hljs-number">2</span>:<br>                    sd.SharedData.blockNodeSize = v_sizes[<span class="hljs-number">2</span>]<br>                <span class="hljs-keyword">elif</span> i == <span class="hljs-number">3</span>:<br>                    sd.SharedData.pathNodeSize = v_sizes[<span class="hljs-number">3</span>]<br>                <span class="hljs-keyword">elif</span> i == <span class="hljs-number">4</span>:<br>                    sd.SharedData.arrowWidth = v_sizes[<span class="hljs-number">4</span>]<br>                <span class="hljs-keyword">elif</span> i == <span class="hljs-number">5</span>:<br>                    sd.SharedData.fontSize = v_sizes[<span class="hljs-number">5</span>]<br>            <span class="hljs-variable language_">self</span>._isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Draw</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        绘制图形</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        pp.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]<br>        pp.title(sd.SharedData.blockInfo)<br>        <span class="hljs-comment"># 获取坐标轴实例</span><br>        v_ax = pp.gca()<br>        <span class="hljs-variable language_">self</span>._AxisSet(v_ax)<br>        <span class="hljs-variable language_">self</span>._GridValueSet(v_ax)<br>        <span class="hljs-comment"># 将数据以二维图片的形式进行显示</span><br>        v_ax.imshow(<span class="hljs-variable language_">self</span>._data, cmap=<span class="hljs-string">&#x27;Accent&#x27;</span>, aspect=<span class="hljs-string">&#x27;equal&#x27;</span>, vmin=<span class="hljs-number">0</span>, vmax=<span class="hljs-number">255</span>)<br>        <span class="hljs-comment"># 标记起始点和终点</span><br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedNodes().GetStartNode(), sd.SharedData.startNodeSize, <span class="hljs-string">&#x27;go&#x27;</span>)<br>        <span class="hljs-variable language_">self</span>._PathNodeSet()<br>        <span class="hljs-variable language_">self</span>.Mark(sd.SharedNodes().GetEndNode(), sd.SharedData.endNodeSize, <span class="hljs-string">&#x27;ro&#x27;</span>)<br>        <span class="hljs-comment"># 布置网格线</span><br>        pp.grid(visible=<span class="hljs-literal">True</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>)<br>        pp.tight_layout(pad=<span class="hljs-number">1</span>)<br>        pp.show()<br><br>    <span class="hljs-comment"># 标记所查找到的路径</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PathNodeSet</span>(<span class="hljs-params">self</span>):<br>        v_pathNodes = sd.SharedNodes().GetPathNodes()<br>        v_length = <span class="hljs-built_in">len</span>(v_pathNodes)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; i &lt; v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>.Mark(v_pathNodes[i], sd.SharedData.pathNodeSize, <span class="hljs-string">&#x27;bo&#x27;</span>)<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br>            <span class="hljs-keyword">elif</span> i == v_length - <span class="hljs-number">1</span>:<br>                <span class="hljs-variable language_">self</span>._Arrow(v_pathNodes[i - <span class="hljs-number">1</span>], v_pathNodes[i])<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Mark</span>(<span class="hljs-params">cls, p_node: node.Node, p_marksize: <span class="hljs-built_in">int</span>, p_fmt: <span class="hljs-built_in">str</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        用于在图象上标记Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 表示待标记的Node</span><br><span class="hljs-string">        :param p_marksize: 表示标记的尺寸大小</span><br><span class="hljs-string">        :param p_fmt: 表示标记颜色和图形的样式描述</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        pp.plot(v_x, v_y, p_fmt, markersize=p_marksize, zorder=<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment"># 箭头指向方法</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Arrow</span>(<span class="hljs-params">self, p_firstNode, p_secondNode</span>):<br>        v_dx = p_secondNode.nodePos.x - p_firstNode.nodePos.x<br>        v_dy = p_secondNode.nodePos.y - p_firstNode.nodePos.y<br>        pp.arrow(p_firstNode.nodePos.x, p_firstNode.nodePos.y, v_dx, v_dy, color=<span class="hljs-string">&#x27;orange&#x27;</span>,<br>                 width=sd.SharedData.arrowWidth, head_width=<span class="hljs-number">0.08</span>,<br>                 zorder=<span class="hljs-number">3</span>)<br><br>    <span class="hljs-comment"># 坐标轴设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AxisSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">self</span>._colsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>._xLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">self</span>._rowsCount + <span class="hljs-number">1</span>):<br>            <span class="hljs-variable language_">self</span>._yLabels.append(<span class="hljs-built_in">str</span>(i))<br>        <span class="hljs-comment"># 隐藏刻度线</span><br>        v_ax.tick_params(left=<span class="hljs-literal">False</span>, bottom=<span class="hljs-literal">False</span>, top=<span class="hljs-literal">False</span>, right=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 生成Image Data</span><br>        v_low = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._rowsCount &gt; <span class="hljs-variable language_">self</span>._colsCount:<br>            v_high = <span class="hljs-variable language_">self</span>._rowsCount<br>        <span class="hljs-keyword">else</span>:<br>            v_high = <span class="hljs-variable language_">self</span>._colsCount<br>        <span class="hljs-variable language_">self</span>._data = np.random.randint(v_low, v_high, size=(<span class="hljs-variable language_">self</span>._rowsCount + <span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>._colsCount + <span class="hljs-number">1</span>))<br>        <span class="hljs-comment"># # 设置横纵坐标轴的范围</span><br>        pp.xlim(<span class="hljs-number">0</span>, <span class="hljs-variable language_">self</span>._colsCount)<br>        pp.ylim(<span class="hljs-number">0</span>, <span class="hljs-variable language_">self</span>._rowsCount)<br>        <span class="hljs-comment"># 设置坐标轴的刻度标记</span><br>        v_ax.set_xticks(np.arange(<span class="hljs-variable language_">self</span>._colsCount + <span class="hljs-number">1</span>), labels=<span class="hljs-variable language_">self</span>._xLabels, visible=<span class="hljs-literal">False</span>)<br>        v_ax.set_yticks(np.arange(<span class="hljs-variable language_">self</span>._rowsCount + <span class="hljs-number">1</span>), labels=<span class="hljs-variable language_">self</span>._yLabels, visible=<span class="hljs-literal">False</span>)<br>        <span class="hljs-comment"># 设置坐标轴的横纵轴比例相等</span><br>        v_ax.set_aspect(<span class="hljs-string">&#x27;equal&#x27;</span>)<br><br>    <span class="hljs-comment"># 网格内容设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GridValueSet</span>(<span class="hljs-params">self, p_ax</span>):<br>        v_ax = p_ax<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>._colsCount):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-variable language_">self</span>._rowsCount):<br>                v_str = <span class="hljs-string">&#x27;(&#x27;</span> + <span class="hljs-built_in">str</span>(i + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(j + <span class="hljs-number">0.5</span>) + <span class="hljs-string">&#x27;)&#x27;</span><br>                v_ax.text(i + <span class="hljs-number">0.5</span>, j + <span class="hljs-number">0.5</span>, v_str, ha=<span class="hljs-string">&#x27;center&#x27;</span>, va=<span class="hljs-string">&#x27;center&#x27;</span>, color=<span class="hljs-string">&#x27;w&#x27;</span>, fontsize=sd.SharedData.fontSize,<br>                          zorder=<span class="hljs-number">4</span>)<br></code></pre></td></tr></table></figure><h3 id="Node-py"><a href="#Node-py" class="headerlink" title="Node.py"></a>Node.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># Node坐标类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePosition</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_x: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span>, p_y: <span class="hljs-built_in">float</span> = <span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Node坐标信息初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_x: 横坐标值</span><br><span class="hljs-string">        :param p_y: 纵坐标值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.x = p_x<br>        <span class="hljs-variable language_">self</span>.y = p_y<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;[&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.x) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.y) + <span class="hljs-string">&#x27;]&#x27;</span><br><br><br><span class="hljs-comment"># Node标签</span><br><span class="hljs-meta">@unique</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeTag</span>(<span class="hljs-title class_ inherited__">Enum</span>):<br>    PATHNODE = <span class="hljs-number">1</span><br>    BLOCKNODE = <span class="hljs-number">2</span><br><br><br><span class="hljs-comment"># Node类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_nodeName: <span class="hljs-built_in">str</span>, p_nodePos: NodePosition</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Node初始化</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_nodeName: Node名称</span><br><span class="hljs-string">        :param p_nodePos: Node的坐标信息</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.nodeName = p_nodeName<br>        <span class="hljs-variable language_">self</span>.nodePos = p_nodePos<br>        <span class="hljs-comment"># f=g+h，g代表从上一个点到该点的代价和，h代表从该点到终点的代价和，f代表总权值weight</span><br>        <span class="hljs-variable language_">self</span>.f: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.g: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.h: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># Node的标签，用于判断是否为不可到达的Node，</span><br>        <span class="hljs-variable language_">self</span>.nodeTag = NodeTag.PATHNODE<br>        <span class="hljs-comment"># 前驱Node</span><br>        <span class="hljs-variable language_">self</span>.preNode = <span class="hljs-literal">None</span><br>        <span class="hljs-comment"># 后继Node</span><br>        <span class="hljs-variable language_">self</span>.nextNode = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeight</span>(<span class="hljs-params">self, p_f: <span class="hljs-built_in">int</span>, p_g: <span class="hljs-built_in">int</span>, p_h: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置Node的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_f: 代表总权值weight, f = g + h</span><br><span class="hljs-string">        :param p_g: 代表从上一个点到该点的代价和</span><br><span class="hljs-string">        :param p_h: 代表从该点到终点的代价和</span><br><span class="hljs-string">        :return: 无返回值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.f = p_f<br>        <span class="hljs-variable language_">self</span>.g = p_g<br>        <span class="hljs-variable language_">self</span>.h = p_h<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#123;nodeName:&#x27;</span> + <span class="hljs-variable language_">self</span>.nodeName + <span class="hljs-string">&#x27;,nodePos:&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.nodePos) + <span class="hljs-string">&#x27;,f=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.f) + <span class="hljs-string">&#x27;,g=&#x27;</span> + <span class="hljs-built_in">str</span>(<br>            <span class="hljs-variable language_">self</span>.g) + <span class="hljs-string">&#x27;,h=&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>.h) + <span class="hljs-string">&#x27;&#125;&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):<br>        <span class="hljs-keyword">if</span> other <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.x == other.nodePos.x <span class="hljs-keyword">and</span> <span class="hljs-variable language_">self</span>.nodePos.y == other.nodePos.y:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node工厂，用来创建和获取起始点Node和终点Node</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeFactory</span>:<br>    _lock = th.Lock()<br>    _isCreateEndNode = <span class="hljs-literal">False</span><br>    _isCreateStartNode = <span class="hljs-literal">False</span><br>    _startNode: Node<br>    _endNode: Node<br>    <span class="hljs-comment"># Node名称索引</span><br>    _nameIndex = <span class="hljs-number">1</span><br>    <span class="hljs-comment"># GenerateOneNode的Node索引</span><br>    _rowIndex = <span class="hljs-number">1</span><br>    _colIndex = <span class="hljs-number">1</span><br>    _generateCount = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isCreateStartNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateStartNode()<br>            sd.SharedNodes().SetStartNode(<span class="hljs-variable language_">self</span>._startNode, <span class="hljs-string">&#x27;SNSET&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isCreateEndNode <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._CreateEndNode()<br>            sd.SharedNodes().SetEndNode(<span class="hljs-variable language_">self</span>._endNode, <span class="hljs-string">&#x27;ENSET&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeFactory, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeFactory, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    NodeFactory._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> NodeFactory._instance<br><br>    <span class="hljs-comment"># 创建起始点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateStartNode</span>(<span class="hljs-params">self</span>):<br>        v_nodePos = NodePosition(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)<br>        <span class="hljs-variable language_">self</span>._startNode = Node(<span class="hljs-string">&#x27;StartNode&#x27;</span>, v_nodePos)<br>        <span class="hljs-variable language_">self</span>._isCreateStartNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 创建终点Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_CreateEndNode</span>(<span class="hljs-params">self</span>):<br>        v_startNode = <span class="hljs-variable language_">self</span>._startNode<br>        v_node = v_startNode<br>        <span class="hljs-keyword">while</span> v_node == v_startNode:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;EndNode&#x27;</span>, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-variable language_">self</span>._endNode = v_node<br>        <span class="hljs-variable language_">self</span>._isCreateEndNode = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateXYNodes</span>(<span class="hljs-params">self, p_x=<span class="hljs-number">0</span>, p_y=<span class="hljs-number">0</span>, p_isRefX=<span class="hljs-literal">True</span>, p_isDefCheck=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成横坐标或纵坐标为指定参考值的Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_x: 横坐标参考值</span><br><span class="hljs-string">        :param p_y: 纵坐标参考值</span><br><span class="hljs-string">        :param p_isRefX: 是否以横坐标为参考坐标，默认为True，若为False则以纵坐标为参考坐标</span><br><span class="hljs-string">        :param p_isDefCheck: 是否开启默认检测，默认为True，会自动排除起始点Node和终点Node</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        v_index = <span class="hljs-number">1</span><br>        v_startNode = <span class="hljs-variable language_">self</span>._startNode<br>        v_endNode = <span class="hljs-variable language_">self</span>._endNode<br>        <span class="hljs-keyword">if</span> p_isRefX:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index))<br>                <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_j1 = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">if</span> p_isDefCheck:<br>                        v_j1 = v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode<br>                    <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> v_node.nodePos.x == p_x:<br>                        v_list.append(v_node)<br>                        v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index))<br>                <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_j1 = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">if</span> p_isDefCheck:<br>                        v_j1 = v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode<br>                    <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> v_node.nodePos.y == p_y:<br>                        v_list.append(v_node)<br>                        v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNodes</span>(<span class="hljs-params">self, p_count, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成指定数量的非重复Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_count: 生成的Node的数量</span><br><span class="hljs-string">        :param p_isRandom: 是否随机生成，默认为False</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        v_index = <span class="hljs-number">1</span><br>        v_startNode = <span class="hljs-variable language_">self</span>._startNode<br>        v_endNode = <span class="hljs-variable language_">self</span>._endNode<br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(v_list) &lt; p_count:<br>            v_node = <span class="hljs-variable language_">self</span>.GenerateOneNode(<span class="hljs-string">&#x27;Node&#x27;</span> + <span class="hljs-built_in">str</span>(v_index), p_isRandom=p_isRandom)<br>            <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                v_isRepeat = NodeCheck.RepeatCheck(v_list, v_node)<br>                <span class="hljs-keyword">if</span> v_isRepeat <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_node != v_startNode <span class="hljs-keyword">and</span> v_node != v_endNode:<br>                    v_list.append(v_node)<br>                    v_index += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateOneNode</span>(<span class="hljs-params">self, p_name: <span class="hljs-built_in">str</span>, p_isRandom=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        生成一个指定名称的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_name: 生成的Node的名称</span><br><span class="hljs-string">        :param p_isRandom: 是否随机生成，默认为False，若为True则为非随机模式生成，将按照起始点从左至右&amp;从下至上的顺序生成</span><br><span class="hljs-string">        :return: 默认会返回Node，在非随机生成模式下，当该方法生成完当前网格的所有Node后会进行重置并返回None，请保持对该方法的返回值是否为None的判断，避免陷入死循环</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_rowsCount = sd.SharedData.rowsCount<br>        v_colsCount = sd.SharedData.colsCount<br>        v_x = <span class="hljs-number">0.5</span><br>        v_y = <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">if</span> p_isRandom:<br>            v_i = random.randint(<span class="hljs-number">0</span>, v_colsCount - <span class="hljs-number">1</span>)<br>            v_x = v_i + <span class="hljs-number">0.5</span><br>            v_i = random.randint(<span class="hljs-number">0</span>, v_rowsCount - <span class="hljs-number">1</span>)<br>            v_y = v_i + <span class="hljs-number">0.5</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._colIndex &lt; v_colsCount:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._rowIndex &gt; v_rowsCount:<br>                    <span class="hljs-variable language_">self</span>._rowIndex -= v_rowsCount<br>                    <span class="hljs-variable language_">self</span>._colIndex += <span class="hljs-number">1</span><br>                v_x = (<span class="hljs-variable language_">self</span>._colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                v_y = (<span class="hljs-variable language_">self</span>._rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                <span class="hljs-variable language_">self</span>._rowIndex += <span class="hljs-number">1</span><br>                <span class="hljs-variable language_">self</span>._generateCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._rowIndex &lt;= v_rowsCount:<br>                    v_x = (<span class="hljs-variable language_">self</span>._colIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    v_y = (<span class="hljs-variable language_">self</span>._rowIndex - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>                    <span class="hljs-variable language_">self</span>._rowIndex += <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>._generateCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-variable language_">self</span>._rowIndex = <span class="hljs-number">1</span><br>                    <span class="hljs-variable language_">self</span>._colIndex = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._generateCount &gt; v_rowsCount * v_colsCount:<br>                <span class="hljs-variable language_">self</span>._generateCount = <span class="hljs-number">0</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        v_nodePos = NodePosition(v_x, v_y)<br>        v_node = Node(p_name, v_nodePos)<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GenerateNextNodes</span>(<span class="hljs-params">self, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取某个Node下一步可以前往的Node集(NextNode集)</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 待生成NextNode集的Node</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_node为None则返回空列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_p = p_node.nodePos<br>            v_posList = [(v_p.x - <span class="hljs-number">1</span>, v_p.y), (v_p.x - <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>), (v_p.x, v_p.y + <span class="hljs-number">1</span>), (v_p.x + <span class="hljs-number">1</span>, v_p.y + <span class="hljs-number">1</span>),<br>                         (v_p.x + <span class="hljs-number">1</span>, v_p.y), (v_p.x + <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>), (v_p.x, v_p.y - <span class="hljs-number">1</span>), (v_p.x - <span class="hljs-number">1</span>, v_p.y - <span class="hljs-number">1</span>)]<br>            v_nameList = [<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>, <span class="hljs-string">&#x27;F&#x27;</span>, <span class="hljs-string">&#x27;G&#x27;</span>, <span class="hljs-string">&#x27;H&#x27;</span>]<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_posList)):<br>                v_nodeName = v_nameList[i] + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>._nameIndex)<br>                v_nodePos = NodePosition(v_posList[i][<span class="hljs-number">0</span>], v_posList[i][<span class="hljs-number">1</span>])<br>                v_node = Node(v_nodeName, v_nodePos)<br>                v_list.append(v_node)<br>            <span class="hljs-variable language_">self</span>._nameIndex += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> v_list<br><br><br><span class="hljs-comment"># Node或Node集的检测</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeCheck</span>:<br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RepeatCheck</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断Node集中是否存在某个Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :param p_node: 待检测的Node</span><br><span class="hljs-string">        :return: 存在返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n == p_node:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">OutOfRange</span>(<span class="hljs-params">cls, p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断Node是否超出了网格限定范围</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 待检测的Node</span><br><span class="hljs-string">        :return:若超出了范围则返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_minX = <span class="hljs-number">0.5</span><br>        v_minY = <span class="hljs-number">0.5</span><br>        v_maxX = (sd.SharedData.colsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_maxY = (sd.SharedData.rowsCount - <span class="hljs-number">1</span>) + <span class="hljs-number">0.5</span><br>        v_x = p_node.nodePos.x<br>        v_y = p_node.nodePos.y<br>        <span class="hljs-keyword">if</span> v_minX &lt;= v_x &lt;= v_maxX <span class="hljs-keyword">and</span> v_minY &lt;= v_y &lt;= v_maxY:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">IsContainNodes</span>(<span class="hljs-params">cls, p_listA: <span class="hljs-built_in">list</span>[Node], p_listB: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        判断某个Node集（p_listA）是否包含另一个Node集（p_listB）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_listA: 待检测的Node集</span><br><span class="hljs-string">        :param p_listB: 被包含的Node集</span><br><span class="hljs-string">        :return: 若p_listA包含p_listB则返回True，否则返回False，若p_listA为None也会返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_listA <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_listA) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> p_listB <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(p_listB) == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_listB:<br>                    <span class="hljs-keyword">if</span> cls.RepeatCheck(p_listA, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">IsContainBestNodes</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        检测NextNode集是否存在权值相等的最佳Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待检测的NextNode集</span><br><span class="hljs-string">        :return: 若NextNode集存在两个及以上的最佳Node，则返回True，否则返回False，若p_list为None或长度小于2，也返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) &gt;= <span class="hljs-number">2</span>:<br>            v_list = NodeDeal.SortNodes(p_list)<br>            v_curNode = v_list[<span class="hljs-number">0</span>]<br>            v_neNode = v_list[<span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">if</span> v_curNode.f == v_neNode.f:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-comment"># Node或Node集的处理</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeDeal</span>:<br>    <span class="hljs-comment"># 对角线移动一格的代价</span><br>    _diagonalCost = <span class="hljs-number">14</span><br>    <span class="hljs-comment"># 上下或左右移动一格的代价</span><br>    _nonDiagonalCost = <span class="hljs-number">10</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveRepeatNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集中的重复Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :return: 若p_list为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            v_length = <span class="hljs-built_in">len</span>(p_list)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_length):<br>                v_isRepeate = <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, v_length):<br>                    <span class="hljs-keyword">if</span> p_list[i] == p_list[j]:<br>                        v_isRepeate = <span class="hljs-literal">True</span><br>                        <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> v_isRepeate <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(p_list[i])<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveNode</span>(<span class="hljs-params">cls, p_sourceList: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集（p_sourceList）中的某个Node（p_node）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_sourceList: 待处理的Node集</span><br><span class="hljs-string">        :param p_node: 参考Node</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_sourceList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_sourceList) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_sourceList:<br>                <span class="hljs-keyword">if</span> n != p_node:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_sourceList<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveNodes</span>(<span class="hljs-params">cls, p_sourceList: <span class="hljs-built_in">list</span>[Node], p_refList: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将一个Node集（p_sourceList）中另一个Node集（p_refList）的元素去除</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_sourceList: 待处理的原Node集</span><br><span class="hljs-string">        :param p_refList: 参考Node集</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_sourceList或p_refList为None则返回原Node集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_sourceList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_refList <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_sourceList) != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_refList) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_sourceList:<br>                <span class="hljs-keyword">if</span> NodeCheck.RepeatCheck(p_refList, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_sourceList<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">RemoveOutOfRangeNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        移除Node集中超出网格范围的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 待处理的Node集</span><br><span class="hljs-string">        :return: 默认返回一个列表，如果p_list为None则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> NodeCheck.OutOfRange(n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ReplaceNode</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_node: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        替换Node集中与某个Node相同的Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: Node集</span><br><span class="hljs-string">        :param p_node: 用于替换的Node</span><br><span class="hljs-string">        :return: 若p_list和p_node为None则返回None，否则返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">if</span> NodeCheck.RepeatCheck(v_list, p_node):<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">if</span> v_list[i] == p_node:<br>                        v_list[i] = p_node<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetWeightValue</span>(<span class="hljs-params">cls, p_diagonalCost: <span class="hljs-built_in">int</span> = <span class="hljs-number">14</span>, p_nonDiagonalCost: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置diagonalCost（对角线移动权值）和nonDiagonalCost（非对角线移动权值）</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_diagonalCost: 对角线移动权值，默认为14</span><br><span class="hljs-string">        :param p_nonDiagonalCost: 非对角线移动权值，默认为10</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_diagonalCost &gt;= <span class="hljs-number">0</span>:<br>            cls.__diagonalCost = p_diagonalCost<br>        <span class="hljs-keyword">if</span> p_nonDiagonalCost &gt;= <span class="hljs-number">0</span>:<br>            cls.__nonDiagonalCost = p_nonDiagonalCost<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">CalculateWeight</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_startNode: Node, p_endNode: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        计算Node集相对起始点和终点的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 原Node集</span><br><span class="hljs-string">        :param p_startNode: 起始点</span><br><span class="hljs-string">        :param p_endNode: 终点</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_list或p_startNode或p_endNode有一个为None则返回原Node集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_startNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_endNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                v_g = cls.CalculateG(n, p_startNode)<br>                v_h = cls.CalculateH(n, p_endNode)<br>                v_f = v_g + v_h<br>                <span class="hljs-keyword">if</span> v_f &lt; n.f <span class="hljs-keyword">or</span> n.f == <span class="hljs-number">0</span>:<br>                    n.SetWeight(<span class="hljs-built_in">int</span>(v_f), <span class="hljs-built_in">int</span>(v_g), <span class="hljs-built_in">int</span>(v_h))<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">CalculateG</span>(<span class="hljs-params">cls, p_curNode: Node, p_startNode: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        计算G值，即当前点Node至起始点Node的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前点Node</span><br><span class="hljs-string">        :param p_startNode: 起始点Node</span><br><span class="hljs-string">        :return: 返回一个整数值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_staX = p_startNode.nodePos.x<br>        v_staY = p_startNode.nodePos.y<br>        v_curX = p_curNode.nodePos.x<br>        v_curY = p_curNode.nodePos.y<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(v_curX - v_staX) != <span class="hljs-built_in">abs</span>(v_curY - v_staY):<br>            v_g = <span class="hljs-built_in">abs</span>(v_curX - v_staX) * cls._nonDiagonalCost + <span class="hljs-built_in">abs</span>(<br>                v_curY - v_staY) * cls._nonDiagonalCost<br>        <span class="hljs-keyword">else</span>:<br>            v_g = <span class="hljs-built_in">abs</span>(v_curX - v_staX) * cls._diagonalCost<br>        <span class="hljs-keyword">return</span> v_g<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">CalculateH</span>(<span class="hljs-params">cls, p_curNode: Node, p_endNode: Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        计算H值，即当前点Node至终点Node的权值</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前点Node</span><br><span class="hljs-string">        :param p_endNode: 终点Node</span><br><span class="hljs-string">        :return: 返回一个整数值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_endX = p_endNode.nodePos.x<br>        v_endY = p_endNode.nodePos.y<br>        v_colsCount = sd.SharedData.colsCount<br>        v_rowsCount = sd.SharedData.rowsCount<br>        v_curX = p_curNode.nodePos.x<br>        v_curY = p_curNode.nodePos.y<br>        v_minCount = v_colsCount <span class="hljs-keyword">if</span> v_colsCount &lt; v_rowsCount <span class="hljs-keyword">else</span> v_rowsCount<br>        v_listH = []<br>        <span class="hljs-keyword">if</span> v_curX == v_endX:<br>            v_h = <span class="hljs-built_in">abs</span>(v_endY - v_curY) * cls._nonDiagonalCost<br>            v_listH.append(v_h)<br>        <span class="hljs-keyword">elif</span> v_curY == v_endY:<br>            v_h = <span class="hljs-built_in">abs</span>(v_endX - v_curX) * cls._nonDiagonalCost<br>            v_listH.append(v_h)<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">abs</span>(v_curX - v_endX) == <span class="hljs-built_in">abs</span>(v_curY - v_endY):<br>            v_h = <span class="hljs-built_in">abs</span>(v_curX - v_endX) * cls._diagonalCost<br>            v_listH.append(v_h)<br>        <span class="hljs-keyword">elif</span> v_curY &gt; v_endY:<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">int</span>(v_rowsCount + <span class="hljs-number">0.5</span> - v_endY)):<br>                <span class="hljs-keyword">if</span> i &lt;= v_endX - <span class="hljs-number">0.5</span>:<br>                    v_x = v_endX - i<br>                    v_y = v_endY + i<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(v_curX - v_x) == <span class="hljs-built_in">abs</span>(v_curY - v_y):<br>                        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, v_minCount - <span class="hljs-number">1</span>):<br>                            v_xA = v_x - j<br>                            v_yA = v_y - j<br>                            <span class="hljs-keyword">if</span> v_xA &gt;= <span class="hljs-number">0.5</span> <span class="hljs-keyword">and</span> v_yA &gt; v_endY:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>                            v_xB = v_x + j<br>                            v_yB = v_y + j<br>                            <span class="hljs-keyword">if</span> v_xB &lt; v_endX <span class="hljs-keyword">and</span> v_yB &lt;= v_rowsCount - <span class="hljs-number">0.5</span>:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">elif</span> i &lt;= v_colsCount - <span class="hljs-number">0.5</span> - v_endX:<br>                    v_x = v_endX + i<br>                    v_y = v_endY + i<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(v_curX - v_x) == <span class="hljs-built_in">abs</span>(v_curY - v_y):<br>                        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, v_minCount - <span class="hljs-number">1</span>):<br>                            v_xA = v_x + j<br>                            v_yA = v_y - j<br>                            <span class="hljs-keyword">if</span> v_xA &lt;= v_colsCount - <span class="hljs-number">0.5</span> <span class="hljs-keyword">and</span> v_yA &gt; v_endY:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>                            v_xB = v_x - j<br>                            v_yB = v_y + j<br>                            <span class="hljs-keyword">if</span> v_xB &gt; v_endX <span class="hljs-keyword">and</span> v_yB &lt;= v_rowsCount - <span class="hljs-number">0.5</span>:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">int</span>(v_rowsCount + <span class="hljs-number">0.5</span> - v_endY)):<br>                <span class="hljs-keyword">if</span> i &lt;= v_endX - <span class="hljs-number">0.5</span>:<br>                    v_x = v_endX - i<br>                    v_y = v_endY + i<br>                    <span class="hljs-keyword">if</span> v_curY == v_y:<br>                        <span class="hljs-keyword">if</span> v_curX &lt;= v_x:<br>                            v_h = <span class="hljs-built_in">abs</span>(v_x - v_curX) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">else</span>:<br>                            v_h = (<span class="hljs-built_in">abs</span>(v_endX - v_curX) + <span class="hljs-built_in">abs</span>(v_curY - v_endY)) * cls._nonDiagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">elif</span> v_curX == v_x:<br>                        v_h = <span class="hljs-built_in">abs</span>(v_y - v_curY) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                        v_listH.append(v_h)<br>                        <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">elif</span> i &lt;= v_colsCount - <span class="hljs-number">0.5</span> - v_endX:<br>                    v_x = v_endX + i<br>                    v_y = v_endY + i<br>                    <span class="hljs-keyword">if</span> v_curY == v_y:<br>                        <span class="hljs-keyword">if</span> v_curX &gt;= v_x:<br>                            v_h = <span class="hljs-built_in">abs</span>(v_curX - v_x) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">else</span>:<br>                            v_h = (<span class="hljs-built_in">abs</span>(v_curX - v_endX) + <span class="hljs-built_in">abs</span>(v_curY - v_endY)) * cls._nonDiagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">elif</span> v_curX == v_x:<br>                        v_h = <span class="hljs-built_in">abs</span>(v_y - v_curY) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                        v_listH.append(v_h)<br>                        <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">elif</span> v_curY &lt; v_endY:<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">int</span>(v_endY + <span class="hljs-number">0.5</span>)):<br>                <span class="hljs-keyword">if</span> i &lt;= v_endX - <span class="hljs-number">0.5</span>:<br>                    v_x = v_endX - i<br>                    v_y = v_endY - i<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(v_curX - v_x) == <span class="hljs-built_in">abs</span>(v_curY - v_y):<br>                        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, v_minCount - <span class="hljs-number">1</span>):<br>                            v_xA = v_x + j<br>                            v_yA = v_y - j<br>                            <span class="hljs-keyword">if</span> v_xA &lt; v_endX <span class="hljs-keyword">and</span> v_yA &gt;= <span class="hljs-number">0.5</span>:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>                            v_xB = v_x - j<br>                            v_yB = v_y + j<br>                            <span class="hljs-keyword">if</span> v_xB &gt;= <span class="hljs-number">0.5</span> <span class="hljs-keyword">and</span> v_yB &lt; v_endY:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">elif</span> i &lt;= v_colsCount - <span class="hljs-number">0.5</span> - v_endX:<br>                    v_x = v_endX + i<br>                    v_y = v_endY - i<br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">abs</span>(v_curX - v_x) == <span class="hljs-built_in">abs</span>(v_curY - v_y):<br>                        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, v_minCount - <span class="hljs-number">1</span>):<br>                            v_xA = v_x - j<br>                            v_yA = v_y - j<br>                            <span class="hljs-keyword">if</span> v_xA &gt; v_endX <span class="hljs-keyword">and</span> v_yA &gt;= <span class="hljs-number">0.5</span>:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>                            v_xB = v_x + j<br>                            v_yB = v_y + j<br>                            <span class="hljs-keyword">if</span> v_xB &lt;= v_colsCount - <span class="hljs-number">0.5</span> <span class="hljs-keyword">and</span> v_yB &lt; v_endY:<br>                                v_h = (j + i) * cls._diagonalCost<br>                                v_listH.append(v_h)<br>                                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">int</span>(v_endY + <span class="hljs-number">0.5</span>)):<br>                <span class="hljs-keyword">if</span> i &lt;= v_endX - <span class="hljs-number">0.5</span>:<br>                    v_x = v_endX - i<br>                    v_y = v_endY - i<br>                    <span class="hljs-keyword">if</span> v_curY == v_y:<br>                        <span class="hljs-keyword">if</span> v_curX &lt;= v_x:<br>                            v_h = <span class="hljs-built_in">abs</span>(v_x - v_curX) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">else</span>:<br>                            v_h = (<span class="hljs-built_in">abs</span>(v_endX - v_curX) + <span class="hljs-built_in">abs</span>(v_endY - v_curY)) * cls._nonDiagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">elif</span> v_curX == v_x:<br>                        v_h = <span class="hljs-built_in">abs</span>(v_y - v_curY) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                        v_listH.append(v_h)<br>                        <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">elif</span> i &lt;= v_colsCount - <span class="hljs-number">0.5</span> - v_endX:<br>                    v_x = v_endX + i<br>                    v_y = v_endY - i<br>                    <span class="hljs-keyword">if</span> v_curY == v_y:<br>                        <span class="hljs-keyword">if</span> v_curX &gt;= v_x:<br>                            v_h = <span class="hljs-built_in">abs</span>(v_curX - v_x) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">else</span>:<br>                            v_h = (<span class="hljs-built_in">abs</span>(v_curX - v_endX) + <span class="hljs-built_in">abs</span>(v_endY - v_curY)) * cls._nonDiagonalCost<br>                            v_listH.append(v_h)<br>                            <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">elif</span> v_curX == v_x:<br>                        v_h = <span class="hljs-built_in">abs</span>(v_y - v_curY) * cls._nonDiagonalCost + i * cls._diagonalCost<br>                        v_listH.append(v_h)<br>                        <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(v_listH) == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(v_listH)<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SortNodes</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_endMax=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        对Node集按照总权值（f）进行排序</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 原Node集</span><br><span class="hljs-string">        :param p_endMax: 是否按照总权值从小到大排序，默认为True</span><br><span class="hljs-string">        :return: 默认返回一个列表，若p_list为None则返回原Node集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = p_list<br>        <span class="hljs-keyword">if</span> v_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> p_endMax:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                        <span class="hljs-keyword">if</span> v_list[i].f &gt; v_list[j].f:<br>                            v_node = v_list[i]<br>                            v_list[i] = v_list[j]<br>                            v_list[j] = v_node<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(v_list)):<br>                        <span class="hljs-keyword">if</span> v_list[i].f &lt; v_list[j].f:<br>                            v_node = v_list[i]<br>                            v_list[i] = v_list[j]<br>                            v_list[j] = v_node<br>        <span class="hljs-keyword">return</span> v_list<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">PrintNodes</span>(<span class="hljs-params">cls, p_list: <span class="hljs-built_in">list</span>[Node], p_headStr=<span class="hljs-string">&#x27;&#x27;</span>, p_sep=<span class="hljs-string">&#x27;--&#x27;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        控制台打印Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_headStr: 头部字符串</span><br><span class="hljs-string">        :param p_list: 待打印的Node集</span><br><span class="hljs-string">        :param p_sep: 每个Node之间的间隔符号，默认为&quot;--&quot;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_len = <span class="hljs-built_in">len</span>(p_list)<br>        v_str = p_headStr<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_len != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(v_len):<br>                <span class="hljs-keyword">if</span> i &lt; v_len - <span class="hljs-number">1</span>:<br>                    v_str += <span class="hljs-built_in">str</span>(p_list[i]) + p_sep<br>                <span class="hljs-keyword">else</span>:<br>                    v_str += <span class="hljs-built_in">str</span>(p_list[i])<br>        <span class="hljs-built_in">print</span>(v_str)<br></code></pre></td></tr></table></figure><h3 id="Block-py"><a href="#Block-py" class="headerlink" title="Block.py"></a>Block.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><br><br><span class="hljs-comment"># 用于生成阻碍物</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Block</span>:<br>    _lock = th.Lock()<br>    _blockCount = <span class="hljs-number">0</span><br>    _unCheckedNodes = []<br>    _checkedNodes = []<br>    _isImpassable = <span class="hljs-literal">False</span><br>    _generateNum = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, p_blcokCount: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :param p_blcokCount: 生成的障碍物的数量</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_count = <span class="hljs-built_in">int</span>((sd.SharedData.rowsCount * sd.SharedData.colsCount) / <span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">if</span> p_blcokCount &lt;= v_count:<br>            <span class="hljs-variable language_">self</span>._blockCount = p_blcokCount<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._blockCount = v_count<br>        <span class="hljs-variable language_">self</span>._endNode = sd.SharedNodes().GetEndNode()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(Block, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(Block, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    Block._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> Block._instance<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Create</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        用于生成障碍物</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._blockCount != <span class="hljs-number">0</span>:<br>            v_list = []<br>            v_curNode = sd.SharedNodes().GetStartNode()<br>            <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._StartImpasseCheck(v_list, v_curNode) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                v_list = <span class="hljs-variable language_">self</span>._SelectNode()<br>                <span class="hljs-variable language_">self</span>._Reset()<br>            sd.SharedData.blockInfo = <span class="hljs-string">&#x27;生成BlockNode集次数:&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-variable language_">self</span>._generateNum)<br>            v_list = <span class="hljs-variable language_">self</span>._GenerateBlock(v_list)<br>            sd.SharedNodes().Submit(v_list)<br>            <span class="hljs-variable language_">self</span>._MarkBlockNode(v_list)<br><br>    <span class="hljs-comment"># 生成BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_SelectNode</span>(<span class="hljs-params">self</span>):<br>        v_list = node.NodeFactory().GenerateNodes(<span class="hljs-variable language_">self</span>._blockCount, p_isRandom=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 对所生成的BlockNode集进行检测，若出现死胡同则重新生成BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_StartImpasseCheck</span>(<span class="hljs-params">self, p_list, p_curNode</span>):<br>        v_isImpassable = <span class="hljs-variable language_">self</span>._isImpassable<br>        v_j1 = p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_isImpassable <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span><br>        v_nextNodes = <span class="hljs-variable language_">self</span>._GetNextNodes(p_curNode, p_list)<br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_nextNodes) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> sp.NodeMove().NextNodesMoveCheck(p_list, v_nextNodes, p_curNode) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            v_nextNodes = sp.NodeMove().GetNextNodes(p_list, v_nextNodes, p_curNode)<br>            v_XNodes = <span class="hljs-variable language_">self</span>._GetXNodes(p_curNode.nodePos.x + <span class="hljs-number">1</span>, v_nextNodes)<br>            v_YNodes = <span class="hljs-variable language_">self</span>._GetYNodes(p_curNode.nodePos.y + <span class="hljs-number">1</span>, v_nextNodes)<br>            v_isContainX = node.NodeCheck.IsContainNodes(p_list, v_XNodes)<br>            v_isContainY = node.NodeCheck.IsContainNodes(p_list, v_YNodes)<br>            <span class="hljs-keyword">if</span> v_isContainX <span class="hljs-keyword">and</span> v_isContainY:<br>                <span class="hljs-variable language_">self</span>._isImpassable = <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">elif</span> v_isContainX <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isContainY <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">if</span> v_nextNodes[<span class="hljs-number">0</span>] == <span class="hljs-variable language_">self</span>._endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._StartImpasseCheck(p_list, v_nextNodes[<span class="hljs-number">0</span>])<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">if</span> v_isContainX:<br>                    v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, v_XNodes)<br>                <span class="hljs-keyword">else</span>:<br>                    v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, v_YNodes)<br>                <span class="hljs-keyword">if</span> v_nextNodes[<span class="hljs-number">0</span>] == <span class="hljs-variable language_">self</span>._endNode:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._StartImpasseCheck(p_list, v_nextNodes[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-comment"># BlockNode集检测重置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Reset</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>._isImpassable = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._unCheckedNodes = []<br>        <span class="hljs-variable language_">self</span>._checkedNodes = []<br>        <span class="hljs-variable language_">self</span>._generateNum += <span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># 获取处理后的NextNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNextNodes</span>(<span class="hljs-params">self, p_curNode, p_list</span>):<br>        v_uclist = <span class="hljs-variable language_">self</span>._unCheckedNodes<br>        <span class="hljs-variable language_">self</span>._unCheckedNodes = node.NodeDeal.RemoveNode(v_uclist, p_curNode)<br>        <span class="hljs-variable language_">self</span>._checkedNodes.append(p_curNode)<br>        v_nextNodes = node.NodeFactory().GenerateNextNodes(p_curNode)<br>        v_nextNodes = node.NodeDeal.RemoveOutOfRangeNode(v_nextNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, <span class="hljs-variable language_">self</span>._unCheckedNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, <span class="hljs-variable language_">self</span>._checkedNodes)<br>        v_nextNodes = node.NodeDeal.RemoveNodes(v_nextNodes, p_list)<br>        v_nextNodes = node.NodeDeal.CalculateWeight(v_nextNodes, p_curNode, sd.SharedNodes().GetEndNode())<br>        v_nextNodes = node.NodeDeal.SortNodes(v_nextNodes)<br>        <span class="hljs-keyword">return</span> v_nextNodes<br><br>    <span class="hljs-comment"># 获取xNodes</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetXNodes</span>(<span class="hljs-params">self, p_x, p_list</span>):<br>        v_list = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_x = n.nodePos.x<br>            <span class="hljs-keyword">if</span> v_x == p_x:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 获取yNodes</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetYNodes</span>(<span class="hljs-params">self, p_y, p_list</span>):<br>        v_list = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>            v_y = n.nodePos.y<br>            <span class="hljs-keyword">if</span> v_y == p_y:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 生成Block</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GenerateBlock</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = p_list<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list:<br>                n.nodeTag = node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 标记生成Block的Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_MarkBlockNode</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                grid.Grid.Mark(n, sd.SharedData.blockNodeSize, <span class="hljs-string">&#x27;ks&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="SearchPath-py"><a href="#SearchPath-py" class="headerlink" title="SearchPath.py"></a>SearchPath.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SharedData <span class="hljs-keyword">as</span> sd<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<br><br><br><span class="hljs-meta">@unique</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Direction</span>(<span class="hljs-title class_ inherited__">Enum</span>):<br>    LeftUp = <span class="hljs-number">1</span><br>    RightUp = <span class="hljs-number">2</span><br>    LeftDown = <span class="hljs-number">3</span><br>    RightDown = <span class="hljs-number">4</span><br>    Left = <span class="hljs-number">5</span><br>    Right = <span class="hljs-number">6</span><br>    Up = <span class="hljs-number">7</span><br>    Down = <span class="hljs-number">8</span><br>    NoDirection = <span class="hljs-number">9</span><br><br><br><span class="hljs-comment"># Node移动规则类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeMove</span>:<br>    _lock = th.Lock()<br>    _init = <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._init <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._nextNodes = []<br>            <span class="hljs-variable language_">self</span>._init = <span class="hljs-literal">True</span><br>            <span class="hljs-variable language_">self</span>._diagonalMoveNode = <span class="hljs-literal">None</span><br>            <span class="hljs-variable language_">self</span>._nonDiagonalMoveNode = <span class="hljs-literal">None</span><br>            <span class="hljs-variable language_">self</span>._doubleNonDiagonalMoveNode = <span class="hljs-literal">None</span><br>            <span class="hljs-variable language_">self</span>._endNode = sd.SharedNodes().GetEndNode()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeMove, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(NodeMove, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    NodeMove._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> NodeMove._instance<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetNextNodes</span>(<span class="hljs-params">self, p_blockNodes: <span class="hljs-built_in">list</span>[node.Node], p_nextNodes: <span class="hljs-built_in">list</span>[node.Node], p_curNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取经过移动检测的NextNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_blockNodes: 障碍物Node集</span><br><span class="hljs-string">        :param p_nextNodes: 当前Node的NextNode集</span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :return: 返回经过移动检测的NextNode集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = []<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.NextNodesMoveCheck(p_blockNodes, p_nextNodes, p_curNode):<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._nextNodes:<br>                v_list.append(n)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetMoveDirection</span>(<span class="hljs-params">self, p_curNode: node.Node, p_nextNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取当前Node至下一个Node的移动方向</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :param p_nextNode: 下一个Node</span><br><span class="hljs-string">        :return: 返回一个Direction枚举值，若p_curNode或p_nextNode为None，则返回Direction中的NoDirection</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_nextNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1:<br>            v_curX = p_curNode.nodePos.x<br>            v_curY = p_curNode.nodePos.y<br>            v_neX = p_nextNode.nodePos.x<br>            v_neY = p_nextNode.nodePos.y<br>            v_X = v_neX - v_curX<br>            v_Y = v_neY - v_curY<br>            <span class="hljs-keyword">if</span> v_X &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> Direction.Left<br>            <span class="hljs-keyword">elif</span> v_X &lt; <span class="hljs-number">0</span> &lt; v_Y:<br>                <span class="hljs-keyword">return</span> Direction.LeftUp<br>            <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y &gt; <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> Direction.Up<br>            <span class="hljs-keyword">elif</span> v_X &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y &gt; <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> Direction.RightUp<br>            <span class="hljs-keyword">elif</span> v_X &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> Direction.Right<br>            <span class="hljs-keyword">elif</span> v_X &gt; <span class="hljs-number">0</span> &gt; v_Y:<br>                <span class="hljs-keyword">return</span> Direction.RightDown<br>            <span class="hljs-keyword">elif</span> v_X == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> v_Y &lt; <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> Direction.Down<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> Direction.LeftDown<br>        <span class="hljs-keyword">return</span> Direction.NoDirection<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">NextNodeMoveCheck</span>(<span class="hljs-params">self, p_blockNodes: <span class="hljs-built_in">list</span>[node.Node], p_nextNode: node.Node, p_curNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        检测当前Node至下一步Node是否可以移动</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_blockNodes: 障碍物Node集</span><br><span class="hljs-string">        :param p_nextNode: 下一步Node</span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :return: 若可移动则返回True，否则返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_j1 = p_nextNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1:<br>            v_curX = p_curNode.nodePos.x<br>            v_curY = p_curNode.nodePos.y<br>            v_direction = <span class="hljs-variable language_">self</span>.GetMoveDirection(p_curNode, p_nextNode)<br>            <span class="hljs-keyword">if</span> v_direction == Direction.LeftUp:<br>                v_x1 = v_curX - <span class="hljs-number">1</span><br>                v_y1 = v_curY<br>                v_x2 = v_curX<br>                v_y2 = v_curY + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> v_direction == Direction.RightUp:<br>                v_x1 = v_curX + <span class="hljs-number">1</span><br>                v_y1 = v_curY<br>                v_x2 = v_curX<br>                v_y2 = v_curY + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> v_direction == Direction.RightDown:<br>                v_x1 = v_curX + <span class="hljs-number">1</span><br>                v_y1 = v_curY<br>                v_x2 = v_curX<br>                v_y2 = v_curY - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> v_direction == Direction.LeftDown:<br>                v_x1 = v_curX - <span class="hljs-number">1</span><br>                v_y1 = v_curY<br>                v_x2 = v_curX<br>                v_y2 = v_curY - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> v_direction == Direction.NoDirection:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>            v_nodeA = node.Node(<span class="hljs-string">&#x27;nodeA&#x27;</span>, node.NodePosition(v_x1, v_y1))<br>            v_nodeB = node.Node(<span class="hljs-string">&#x27;nodeB&#x27;</span>, node.NodePosition(v_x2, v_y2))<br>            v_isContainA = node.NodeCheck.RepeatCheck(p_blockNodes, v_nodeA)<br>            v_isContainB = node.NodeCheck.RepeatCheck(p_blockNodes, v_nodeB)<br>            <span class="hljs-keyword">if</span> v_isContainA <span class="hljs-keyword">or</span> v_isContainB:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">NextNodesMoveCheck</span>(<span class="hljs-params">self, p_blockNodes: <span class="hljs-built_in">list</span>[node.Node], p_nextNodes: <span class="hljs-built_in">list</span>[node.Node], p_curNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        对当前Node的NextNode集进行可移动检测</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_blockNodes: 障碍物Node集</span><br><span class="hljs-string">        :param p_nextNodes: 当前Node的NextNode集</span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :return: 默认返回True，若NextNode集中不存在下一步可移动的Node则返回False，若p_nextNodes为None或为空集也返回False，若p_curNode为None返回False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_nextNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(p_nextNodes) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_nextNodes:<br>                <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.NextNodeMoveCheck(p_blockNodes, n, p_curNode):<br>                    v_list.append(n)<br>            <span class="hljs-variable language_">self</span>._nextNodes = v_list<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(v_list) == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 对NextNode集进行可替换斜向移动检测</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_DiagonalMoveCheck</span>(<span class="hljs-params">self, p_curNode: node.Node, p_nextNodes: <span class="hljs-built_in">list</span>[node.Node], p_neNextNodes: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        v_nextNode = p_nextNodes[<span class="hljs-number">0</span>]<br>        v_neNextNode = p_neNextNodes[<span class="hljs-number">0</span>]<br>        v_blockList = sd.SharedNodes().GetBlockNodes()<br>        v_nextDirection = <span class="hljs-variable language_">self</span>.GetMoveDirection(p_curNode, v_nextNode)<br>        v_neNextDirection = <span class="hljs-variable language_">self</span>.GetMoveDirection(v_nextNode, v_neNextNode)<br>        v_curDirection = <span class="hljs-variable language_">self</span>.GetMoveDirection(p_curNode, v_neNextNode)<br>        v_j1 = v_nextDirection == Direction.Left <span class="hljs-keyword">or</span> v_nextDirection == Direction.Right<br>        v_j2 = v_nextDirection == Direction.Up <span class="hljs-keyword">or</span> v_nextDirection == Direction.Down<br>        v_j3 = v_neNextDirection == Direction.Left <span class="hljs-keyword">or</span> v_neNextDirection == Direction.Right<br>        v_j4 = v_neNextDirection == Direction.Up <span class="hljs-keyword">or</span> v_neNextDirection == Direction.Down<br>        v_j5 = v_curDirection == Direction.LeftUp <span class="hljs-keyword">or</span> v_curDirection == Direction.LeftDown<br>        v_j6 = v_curDirection == Direction.RightUp <span class="hljs-keyword">or</span> v_curDirection == Direction.RightDown<br>        v_j7 = <span class="hljs-variable language_">self</span>.NextNodeMoveCheck(v_blockList, v_neNextNode, p_curNode)<br>        v_j8 = node.NodeCheck.RepeatCheck(p_nextNodes, v_neNextNode)<br>        v_j9 = <span class="hljs-variable language_">self</span>.NextNodeMoveCheck(v_blockList, v_nextNode, p_curNode)<br>        <span class="hljs-keyword">if</span> (v_j1 <span class="hljs-keyword">or</span> v_j2) <span class="hljs-keyword">and</span> (v_j3 <span class="hljs-keyword">or</span> v_j4) <span class="hljs-keyword">and</span> (v_j5 <span class="hljs-keyword">or</span> v_j6) <span class="hljs-keyword">and</span> v_j7 <span class="hljs-keyword">and</span> v_j8 <span class="hljs-keyword">and</span> v_j9:<br>            <span class="hljs-variable language_">self</span>._diagonalMoveNode = v_neNextNode<br>            <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(p_nextNodes, <span class="hljs-variable language_">self</span>._endNode):<br>                <span class="hljs-variable language_">self</span>._diagonalMoveNode = <span class="hljs-variable language_">self</span>._endNode<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._diagonalMoveNode = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetDiagonalMoveNode</span>(<span class="hljs-params">self, p_curNode: node.Node, p_nextNodes: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取经过可替换斜向移动检测的目标Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :param p_nextNodes: 当前Node的NextNode集</span><br><span class="hljs-string">        :return: 若一次斜向移动可替换两次非斜向移动，则返回斜向移动的目标Node，否则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_nextNodes = p_nextNodes<br>        v_j1 = p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_nextNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_nextNodes) != <span class="hljs-number">0</span>:<br>            v_neNextNodes = SearchPath().GetNextNodes(v_nextNodes[<span class="hljs-number">0</span>])<br>            v_j3 = v_neNextNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">if</span> v_j3 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_neNextNodes) != <span class="hljs-number">0</span>:<br>                <span class="hljs-variable language_">self</span>._DiagonalMoveCheck(p_curNode, v_nextNodes, v_neNextNodes)<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._diagonalMoveNode<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 二次可替换非斜向移动检测</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_DoubleNonDiagonalMoveCheck</span>(<span class="hljs-params">self, p_curNode: node.Node, p_nextNodes: <span class="hljs-built_in">list</span>[node.Node],</span><br><span class="hljs-params">                                    p_neNextNodes: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        v_nextNode = p_nextNodes[<span class="hljs-number">0</span>]<br>        v_neNextNode = p_neNextNodes[<span class="hljs-number">0</span>]<br>        v_blockList = sd.SharedNodes().GetBlockNodes()<br>        v_nextDirection = <span class="hljs-variable language_">self</span>.GetMoveDirection(p_curNode, v_nextNode)<br>        v_neNextDirection = <span class="hljs-variable language_">self</span>.GetMoveDirection(v_nextNode, v_neNextNode)<br>        v_curDirection = <span class="hljs-variable language_">self</span>.GetMoveDirection(p_curNode, v_neNextNode)<br>        v_j1 = v_nextDirection == Direction.LeftUp <span class="hljs-keyword">and</span> v_neNextDirection == Direction.RightUp<br>        v_j2 = v_nextDirection == Direction.RightUp <span class="hljs-keyword">and</span> v_neNextDirection == Direction.LeftUp<br>        v_j3 = v_nextDirection == Direction.LeftDown <span class="hljs-keyword">and</span> v_neNextDirection == Direction.RightDown<br>        v_j4 = v_nextDirection == Direction.RightDown <span class="hljs-keyword">and</span> v_neNextDirection == Direction.LeftDown<br>        v_j5 = v_nextDirection == Direction.LeftUp <span class="hljs-keyword">and</span> v_neNextDirection == Direction.LeftDown<br>        v_j6 = v_nextDirection == Direction.RightUp <span class="hljs-keyword">and</span> v_neNextDirection == Direction.RightDown<br>        v_j7 = v_nextDirection == Direction.LeftDown <span class="hljs-keyword">and</span> v_neNextDirection == Direction.LeftUp<br>        v_j8 = v_nextDirection == Direction.RightDown <span class="hljs-keyword">and</span> v_neNextDirection == Direction.RightUp<br>        v_j9 = v_curDirection == Direction.Left<br>        v_j10 = v_curDirection == Direction.Up<br>        v_j11 = v_curDirection == Direction.Right<br>        v_j12 = v_curDirection == Direction.Down<br>        v_k1 = (v_j5 <span class="hljs-keyword">or</span> v_j7) <span class="hljs-keyword">and</span> v_j9<br>        v_k2 = (v_j1 <span class="hljs-keyword">or</span> v_j2) <span class="hljs-keyword">and</span> v_j10<br>        v_k3 = (v_j6 <span class="hljs-keyword">or</span> v_j8) <span class="hljs-keyword">and</span> v_j11<br>        v_k4 = (v_j3 <span class="hljs-keyword">or</span> v_j4) <span class="hljs-keyword">and</span> v_j12<br>        v_x = p_curNode.nodePos.x<br>        v_y = p_curNode.nodePos.y<br>        v_nodePos = node.NodePosition(v_nextNode.nodePos.x, v_nextNode.nodePos.y)<br>        v_node = node.Node(v_nextNode.nodeName, v_nodePos)<br>        <span class="hljs-keyword">if</span> v_k1:<br>            v_node.nodePos = node.NodePosition(v_x - <span class="hljs-number">1</span>, v_y)<br>        <span class="hljs-keyword">elif</span> v_k2:<br>            v_node.nodePos = node.NodePosition(v_x, v_y + <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">elif</span> v_k3:<br>            v_node.nodePos = node.NodePosition(v_x + <span class="hljs-number">1</span>, v_y)<br>        <span class="hljs-keyword">elif</span> v_k4:<br>            v_node.nodePos = node.NodePosition(v_x, v_y - <span class="hljs-number">1</span>)<br>        v_j13 = <span class="hljs-variable language_">self</span>.NextNodeMoveCheck(v_blockList, v_neNextNode, p_curNode)<br>        v_j14 = <span class="hljs-variable language_">self</span>.NextNodeMoveCheck(v_blockList, v_node, p_curNode)<br>        <span class="hljs-keyword">if</span> (v_k1 <span class="hljs-keyword">or</span> v_k2 <span class="hljs-keyword">or</span> v_k3 <span class="hljs-keyword">or</span> v_k4) <span class="hljs-keyword">and</span> v_j13 <span class="hljs-keyword">and</span> v_j14:<br>            <span class="hljs-variable language_">self</span>._doubleNonDiagonalMoveNode = v_node<br>            <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(p_nextNodes, <span class="hljs-variable language_">self</span>._endNode):<br>                <span class="hljs-variable language_">self</span>._doubleNonDiagonalMoveNode = <span class="hljs-variable language_">self</span>._endNode<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._doubleNonDiagonalMoveNode = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetDoubleNonDiagonalMoveNode</span>(<span class="hljs-params">self, p_curNode: node.Node, p_nextNodes: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取经过二次可替换非斜向移动检测的目标Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :param p_nextNodes: 当前Node的NextNode集</span><br><span class="hljs-string">        :return: 若二次斜向移动可替换为二次非斜向移动，则返回非斜向移动的目标Node，否则返回None</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_nextNodes = p_nextNodes<br>        v_j1 = p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> v_nextNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_nextNodes) != <span class="hljs-number">0</span>:<br>            v_neNextNodes = SearchPath().GetNextNodes(v_nextNodes[<span class="hljs-number">0</span>])<br>            v_j3 = v_neNextNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">if</span> v_j3 <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(v_neNextNodes) != <span class="hljs-number">0</span>:<br>                <span class="hljs-variable language_">self</span>._DoubleNonDiagonalMoveCheck(p_curNode, v_nextNodes, v_neNextNodes)<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>._doubleNonDiagonalMoveNode<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetDirectionNodes</span>(<span class="hljs-params">self, p_curNode: node.Node</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取上一个Node与当前Node的方向Node集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :return: 返回一个列表，即上一个Node与当前Node的方向Node集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_curNode.preNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_preNode = p_curNode.preNode<br>            v_direction = NodeMove().GetMoveDirection(p_curNode, v_preNode)<br>            v_curX = p_curNode.nodePos.x<br>            v_curY = p_curNode.nodePos.y<br>            v_list = []<br>            v_LNode = node.Node(<span class="hljs-string">&#x27;LNode&#x27;</span>, node.NodePosition(v_curX - <span class="hljs-number">1</span>, v_curY))<br>            v_LUNode = node.Node(<span class="hljs-string">&#x27;LUNode&#x27;</span>, node.NodePosition(v_curX - <span class="hljs-number">1</span>, v_curY + <span class="hljs-number">1</span>))<br>            v_UNode = node.Node(<span class="hljs-string">&#x27;UNode&#x27;</span>, node.NodePosition(v_curX, v_curY + <span class="hljs-number">1</span>))<br>            v_RUNode = node.Node(<span class="hljs-string">&#x27;RUNode&#x27;</span>, node.NodePosition(v_curX + <span class="hljs-number">1</span>, v_curY + <span class="hljs-number">1</span>))<br>            v_RNode = node.Node(<span class="hljs-string">&#x27;RNode&#x27;</span>, node.NodePosition(v_curX + <span class="hljs-number">1</span>, v_curY))<br>            v_RDNode = node.Node(<span class="hljs-string">&#x27;RDNode&#x27;</span>, node.NodePosition(v_curX + <span class="hljs-number">1</span>, v_curY - <span class="hljs-number">1</span>))<br>            v_DNode = node.Node(<span class="hljs-string">&#x27;DNode&#x27;</span>, node.NodePosition(v_curX, v_curY - <span class="hljs-number">1</span>))<br>            v_LDNode = node.Node(<span class="hljs-string">&#x27;LDNode&#x27;</span>, node.NodePosition(v_curX - <span class="hljs-number">1</span>, v_curY - <span class="hljs-number">1</span>))<br>            <span class="hljs-keyword">if</span> v_direction == Direction.Left:<br>                v_list.extend([v_LDNode, v_LNode, v_LUNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.LeftUp:<br>                v_list.extend([v_LNode, v_LUNode, v_UNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.Up:<br>                v_list.extend([v_LUNode, v_UNode, v_RUNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.RightUp:<br>                v_list.extend([v_UNode, v_RUNode, v_RNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.Right:<br>                v_list.extend([v_RUNode, v_RNode, v_RDNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.RightDown:<br>                v_list.extend([v_RNode, v_RDNode, v_DNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.Down:<br>                v_list.extend([v_RDNode, v_DNode, v_LDNode])<br>            <span class="hljs-keyword">elif</span> v_direction == Direction.LeftDown:<br>                v_list.extend([v_DNode, v_LDNode, v_LNode])<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">DirectionNodeCheck</span>(<span class="hljs-params">self, p_curNode: node.Node, p_list: [node.Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        对当前Node的NextNode集进行方向Node集检测</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :param p_list: 当前Node的NextNode集</span><br><span class="hljs-string">        :return: 返回一个列表，即检测处理后的NextNode集</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_directionNodes = <span class="hljs-variable language_">self</span>.GetDirectionNodes(p_curNode)<br>        <span class="hljs-keyword">if</span> v_directionNodes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(v_directionNodes, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br><br><span class="hljs-comment"># 查找最佳路径</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchPath</span>:<br>    _lock = th.Lock()<br>    _currentNode: node.Node<br>    <span class="hljs-comment"># 是否完成了初始化</span><br>    _isInit = <span class="hljs-literal">False</span><br>    _isSearchFinish = <span class="hljs-literal">False</span><br>    _nextNode = <span class="hljs-literal">None</span><br>    _SearchNum = <span class="hljs-number">0</span><br>    _closeList = []<br>    _checkedList = []<br>    _lockedList = []<br>    <span class="hljs-comment"># 网格行列数</span><br>    _rowsCount = <span class="hljs-number">0</span><br>    _colsCount = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># x和y的最小值</span><br>    _minX = <span class="hljs-number">0.5</span><br>    _minY = <span class="hljs-number">0.5</span><br>    <span class="hljs-comment"># x和y的最大值</span><br>    _maxX = <span class="hljs-number">0</span><br>    _maxY = <span class="hljs-number">0</span><br>    <span class="hljs-comment"># 终点Node</span><br>    _endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isInit <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._currentNode = sd.SharedNodes().GetStartNode()<br>            <span class="hljs-variable language_">self</span>._nextNode = <span class="hljs-variable language_">self</span>._currentNode<br>            <span class="hljs-variable language_">self</span>._rowsCount = sd.SharedData.rowsCount<br>            <span class="hljs-variable language_">self</span>._colsCount = sd.SharedData.colsCount<br>            <span class="hljs-variable language_">self</span>._maxX = <span class="hljs-variable language_">self</span>._colsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>._maxY = <span class="hljs-variable language_">self</span>._rowsCount - <span class="hljs-number">0.5</span><br>            <span class="hljs-variable language_">self</span>._endNode = sd.SharedNodes().GetEndNode()<br>            <span class="hljs-variable language_">self</span>._blockList = sd.SharedNodes().GetBlockNodes()<br>            <span class="hljs-variable language_">self</span>._isInit = <span class="hljs-literal">True</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SearchPath, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._lock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SearchPath, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    SearchPath._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> SearchPath._instance<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params">self, p_isPrint=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        查找最佳路径</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_isPrint: 是否在控制台打印最佳路径的Node集信息,默认为False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._isSearchFinish <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._GetPathNodes()<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._SearchNum &gt;= <span class="hljs-number">5</span>:<br>                <span class="hljs-keyword">break</span><br>        sd.SharedNodes().Submit(<span class="hljs-variable language_">self</span>._closeList)<br>        <span class="hljs-keyword">if</span> p_isPrint:<br>            node.NodeDeal.PrintNodes(<span class="hljs-variable language_">self</span>._closeList, <span class="hljs-string">&#x27;--&gt;&#x27;</span>)<br><br>    <span class="hljs-comment"># 获取路径Node集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetPathNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>._SearchNum += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-variable language_">self</span>._UpdateCurrentNode():<br>            v_nextNodes = <span class="hljs-variable language_">self</span>.GetNextNodes(<span class="hljs-variable language_">self</span>._currentNode)<br>            v_nextNodes = <span class="hljs-variable language_">self</span>._NextNodesCheck(<span class="hljs-variable language_">self</span>._currentNode, v_nextNodes)<br>            <span class="hljs-variable language_">self</span>._NodesApplication(v_nextNodes)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isSearchFinish <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._Reset()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetNextNodes</span>(<span class="hljs-params">self, p_curNode</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取经过基本处理的当前Node的NextNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_curNode: 当前Node</span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = node.NodeFactory().GenerateNextNodes(p_curNode)<br>        v_list = <span class="hljs-variable language_">self</span>._NodesFilter(v_list)<br>        v_list = node.NodeDeal.CalculateWeight(v_list, <span class="hljs-variable language_">self</span>._currentNode, <span class="hljs-variable language_">self</span>._endNode)<br>        v_list = node.NodeDeal.SortNodes(v_list)<br>        v_list = NodeMove().GetNextNodes(<span class="hljs-variable language_">self</span>._blockList, v_list, p_curNode)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 对NextNode集进行移动规则检测</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NextNodesCheck</span>(<span class="hljs-params">self, p_curNode, p_list</span>):<br>        v_list = p_list<br>        v_node = NodeMove().GetDoubleNonDiagonalMoveNode(p_curNode, v_list)<br>        <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list.insert(<span class="hljs-number">0</span>, v_node)<br>        v_node = NodeMove().GetDiagonalMoveNode(p_curNode, v_list)<br>        <span class="hljs-keyword">if</span> v_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_list.insert(<span class="hljs-number">0</span>, v_node)<br>        v_list = NodeMove().DirectionNodeCheck(p_curNode, v_list)<br>        <span class="hljs-keyword">return</span> v_list<br><br>    <span class="hljs-comment"># 重置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_Reset</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>._closeList = []<br>        <span class="hljs-variable language_">self</span>._isStart = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._nextNode = sd.SharedNodes().GetStartNode()<br>        <span class="hljs-variable language_">self</span>._checkedList = []<br><br>    <span class="hljs-comment"># 对NextNode集进行筛选</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NodesFilter</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_list2 = []<br>            v_list1 = node.NodeDeal.RemoveOutOfRangeNode(p_list)<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_list1:<br>                v_isInCheckedList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._checkedList, n)<br>                v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._closeList, n)<br>                v_isInBlockList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._blockList, n)<br>                v_isInLockedList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._lockedList, n)<br>                v_j1 = v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInBlockList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span><br>                v_j2 = v_isInCheckedList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span> <span class="hljs-keyword">and</span> v_isInLockedList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span><br>                <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> v_j2:<br>                    v_list2.append(n)<br>            <span class="hljs-keyword">return</span> v_list2<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 应用经过基本处理和移动规则检测的NextNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_NodesApplication</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_j1 = node.NodeCheck.RepeatCheck(p_list, <span class="hljs-variable language_">self</span>._endNode)<br>            v_j2 = NodeMove().NextNodeMoveCheck(<span class="hljs-variable language_">self</span>._blockList, <span class="hljs-variable language_">self</span>._endNode, <span class="hljs-variable language_">self</span>._currentNode)<br>            <span class="hljs-keyword">if</span> v_j1 <span class="hljs-keyword">and</span> v_j2:<br>                <span class="hljs-variable language_">self</span>._nextNode = <span class="hljs-variable language_">self</span>._endNode<br>                <span class="hljs-variable language_">self</span>._isSearchFinish = <span class="hljs-literal">True</span><br>            <span class="hljs-keyword">else</span>:<br>                v_list = <span class="hljs-variable language_">self</span>._GetDirectionNodes(<span class="hljs-variable language_">self</span>._currentNode)<br>                <span class="hljs-variable language_">self</span>._checkedList.extend(v_list)<br>                <span class="hljs-variable language_">self</span>._checkedList = node.NodeDeal.RemoveRepeatNode(<span class="hljs-variable language_">self</span>._checkedList)<br>                <span class="hljs-variable language_">self</span>._nextNode = p_list[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._nextNode = <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># 获取上一个Node和当前Node的方向Node集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetDirectionNodes</span>(<span class="hljs-params">self, p_curNode</span>):<br>        v_directionNodes = []<br>        <span class="hljs-keyword">if</span> p_curNode <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            v_directionNodes = NodeMove().GetDirectionNodes(p_curNode)<br>        <span class="hljs-keyword">return</span> v_directionNodes<br><br>    <span class="hljs-comment"># 更新当前Node</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateCurrentNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._nextNode <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-variable language_">self</span>._lockedList.append(<span class="hljs-variable language_">self</span>._currentNode)<br>            <span class="hljs-variable language_">self</span>._lockedList = node.NodeDeal.RemoveRepeatNode(<span class="hljs-variable language_">self</span>._lockedList)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._currentNode.nextNode = <span class="hljs-variable language_">self</span>._nextNode<br>        <span class="hljs-variable language_">self</span>._nextNode.preNode = <span class="hljs-variable language_">self</span>._currentNode<br>        <span class="hljs-variable language_">self</span>._currentNode = <span class="hljs-variable language_">self</span>._nextNode<br>        v_isInCloseList = node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._closeList, <span class="hljs-variable language_">self</span>._currentNode)<br>        <span class="hljs-keyword">if</span> v_isInCloseList <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-variable language_">self</span>._closeList.append(<span class="hljs-variable language_">self</span>._currentNode)<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._currentNode == <span class="hljs-variable language_">self</span>._endNode:<br>                <span class="hljs-variable language_">self</span>._isSearchFinish = <span class="hljs-literal">True</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="SharedData-py"><a href="#SharedData-py" class="headerlink" title="SharedData.py"></a>SharedData.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Node <span class="hljs-keyword">as</span> node<br><span class="hljs-keyword">import</span> threading <span class="hljs-keyword">as</span> th<br><br><br><span class="hljs-comment"># 共享信息类</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedData</span>:<br>    <span class="hljs-comment"># 网格行列数</span><br>    startNodeSize = <span class="hljs-number">0</span><br>    endNodeSize = <span class="hljs-number">0</span><br>    blockNodeSize = <span class="hljs-number">0</span><br>    pathNodeSize = <span class="hljs-number">0</span><br>    arrowWidth = <span class="hljs-number">0</span><br>    fontSize = <span class="hljs-number">0</span><br>    rowsCount = <span class="hljs-number">0</span><br>    colsCount = <span class="hljs-number">0</span><br>    blockInfo = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetSizes</span>(<span class="hljs-params">cls, p_rowsCount: <span class="hljs-built_in">int</span>, p_colsCount: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取默认尺寸元组</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_rowsCount: 网格行数</span><br><span class="hljs-string">        :param p_colsCount: 网格列数</span><br><span class="hljs-string">        :return: 返回一个元组</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_rowsCount == <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">if</span> p_colsCount == <span class="hljs-number">3</span>:<br>                v_sizes = (<span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">102</span>, <span class="hljs-number">40</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">15</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">4</span>:<br>                v_sizes = (<span class="hljs-number">55</span>, <span class="hljs-number">55</span>, <span class="hljs-number">102</span>, <span class="hljs-number">35</span>, <span class="hljs-number">0.04</span>, <span class="hljs-number">14</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">5</span>:<br>                v_sizes = (<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">88</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">13</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">6</span>:<br>                v_sizes = (<span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">72</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0.02</span>, <span class="hljs-number">12</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">7</span>:<br>                v_sizes = (<span class="hljs-number">40</span>, <span class="hljs-number">40</span>, <span class="hljs-number">62</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0.02</span>, <span class="hljs-number">11</span>)<br>            <span class="hljs-keyword">else</span>:<br>                v_sizes = ()<br>        <span class="hljs-keyword">elif</span> p_rowsCount == <span class="hljs-number">4</span>:<br>            <span class="hljs-keyword">if</span> p_colsCount == <span class="hljs-number">3</span> <span class="hljs-keyword">or</span> <span class="hljs-number">4</span> <span class="hljs-keyword">or</span> <span class="hljs-number">5</span>:<br>                v_sizes = (<span class="hljs-number">55</span>, <span class="hljs-number">55</span>, <span class="hljs-number">75</span>, <span class="hljs-number">35</span>, <span class="hljs-number">0.04</span>, <span class="hljs-number">14</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">6</span>:<br>                v_sizes = (<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">72</span>, <span class="hljs-number">30</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">13</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">7</span>:<br>                v_sizes = (<span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">62</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">12</span>)<br>            <span class="hljs-keyword">else</span>:<br>                v_sizes = ()<br>        <span class="hljs-keyword">elif</span> p_rowsCount == <span class="hljs-number">5</span>:<br>            <span class="hljs-keyword">if</span> p_colsCount == <span class="hljs-number">3</span> <span class="hljs-keyword">or</span> <span class="hljs-number">4</span> <span class="hljs-keyword">or</span> <span class="hljs-number">5</span> <span class="hljs-keyword">or</span> <span class="hljs-number">6</span>:<br>                v_sizes = (<span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">60</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">12</span>)<br>            <span class="hljs-keyword">elif</span> p_colsCount == <span class="hljs-number">7</span>:<br>                v_sizes = (<span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">62</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">12</span>)<br>            <span class="hljs-keyword">else</span>:<br>                v_sizes = ()<br>        <span class="hljs-keyword">elif</span> p_rowsCount == <span class="hljs-number">6</span>:<br>            <span class="hljs-keyword">if</span> p_colsCount == <span class="hljs-number">3</span> <span class="hljs-keyword">or</span> <span class="hljs-number">4</span> <span class="hljs-keyword">or</span> <span class="hljs-number">5</span> <span class="hljs-keyword">or</span> <span class="hljs-number">6</span> <span class="hljs-keyword">or</span> <span class="hljs-number">7</span>:<br>                v_sizes = (<span class="hljs-number">35</span>, <span class="hljs-number">35</span>, <span class="hljs-number">50</span>, <span class="hljs-number">15</span>, <span class="hljs-number">0.02</span>, <span class="hljs-number">10</span>)<br>            <span class="hljs-keyword">else</span>:<br>                v_sizes = ()<br>        <span class="hljs-keyword">elif</span> p_rowsCount == <span class="hljs-number">7</span>:<br>            <span class="hljs-keyword">if</span> p_colsCount == <span class="hljs-number">3</span> <span class="hljs-keyword">or</span> <span class="hljs-number">4</span> <span class="hljs-keyword">or</span> <span class="hljs-number">5</span> <span class="hljs-keyword">or</span> <span class="hljs-number">6</span> <span class="hljs-keyword">or</span> <span class="hljs-number">7</span>:<br>                v_sizes = (<span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">42</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">9</span>)<br>            <span class="hljs-keyword">else</span>:<br>                v_sizes = ()<br>        <span class="hljs-keyword">else</span>:<br>            v_sizes = ()<br>        <span class="hljs-keyword">return</span> v_sizes<br><br><br><span class="hljs-comment"># 共享Node和Node集</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedNodes</span>:<br>    _instanceLock = th.Lock()<br>    _lock = th.Lock()<br>    _sharedNodes = []<br>    _pathNodes = []<br>    _blockNodes = []<br>    _isUpdatePathNodes = <span class="hljs-literal">False</span><br>    _isUpdateBlockNodes = <span class="hljs-literal">False</span><br>    _startNode: node.Node<br>    _endNode: node.Node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        node.NodeFactory()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, *args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SharedNodes, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            <span class="hljs-keyword">with</span> cls._instanceLock:<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(SharedNodes, <span class="hljs-string">&#x27;_instance&#x27;</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                    SharedNodes._instance = <span class="hljs-built_in">object</span>.__new__(cls)<br>        <span class="hljs-keyword">return</span> SharedNodes._instance<br><br>    <span class="hljs-comment"># 起始点Node的设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetStartNode</span>(<span class="hljs-params">self, p_node: node.Node, p_password: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置起始点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 起始点Node</span><br><span class="hljs-string">        :param p_password: 调用密码</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_password == <span class="hljs-string">&#x27;SNSET&#x27;</span>:<br>            <span class="hljs-variable language_">self</span>._startNode = p_node<br><br>    <span class="hljs-comment"># 终点Node的设置</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">SetEndNode</span>(<span class="hljs-params">self, p_node: node.Node, p_password: <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        设置终点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_node: 终点Node</span><br><span class="hljs-string">        :param p_password: 调用密码</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> p_node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> p_password == <span class="hljs-string">&#x27;ENSET&#x27;</span>:<br>            <span class="hljs-variable language_">self</span>._endNode = p_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetStartNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取起始点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_node = node.Node(<span class="hljs-variable language_">self</span>._startNode.nodeName, <span class="hljs-variable language_">self</span>._startNode.nodePos)<br>        v_node.f = <span class="hljs-variable language_">self</span>._startNode.f<br>        v_node.g = <span class="hljs-variable language_">self</span>._startNode.g<br>        v_node.h = <span class="hljs-variable language_">self</span>._startNode.h<br>        v_node.nodeTag = <span class="hljs-variable language_">self</span>._startNode.nodeTag<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetEndNode</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取终点Node</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回Node</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_node = node.Node(<span class="hljs-variable language_">self</span>._endNode.nodeName, <span class="hljs-variable language_">self</span>._endNode.nodePos)<br>        v_node.f = <span class="hljs-variable language_">self</span>._endNode.f<br>        v_node.g = <span class="hljs-variable language_">self</span>._endNode.g<br>        v_node.h = <span class="hljs-variable language_">self</span>._endNode.h<br>        v_node.nodeTag = <span class="hljs-variable language_">self</span>._endNode.nodeTag<br>        <span class="hljs-keyword">return</span> v_node<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetPathNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 起初该方法是直接返回cls.__pathNodes，这就导致了数据安全性的问题，使得在外部可以直接修改这里pathNodes的数据，所以正确的做法应该像现在这样</span><br>        <span class="hljs-comment"># 声明一个新的列表，然后将cls.__pathNodes中的值添加进去，再将新的列表作为返回值传递出去，这说明在Python中直接传递内部的静态变量会传递其引用</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取PathNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(node.NodeTag.PATHNODE)<br>        v_pathNodes = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._pathNodes:<br>            v_pathNodes.append(n)<br>        <span class="hljs-keyword">return</span> v_pathNodes<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetBlockNodes</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        获取BlockNode集</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :return: 返回一个列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(node.NodeTag.BLOCKNODE)<br>        v_blockNodes = []<br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._blockNodes:<br>            v_blockNodes.append(n)<br>        <span class="hljs-keyword">return</span> v_blockNodes<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">Submit</span>(<span class="hljs-params">self, p_list: <span class="hljs-built_in">list</span>[node.Node]</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        通过该方法可以实现Node集的添加、删除、修改，建议与GetPathNodes或GetBlockNodes方法配套使用</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param p_list: 修改后的Node集</span><br><span class="hljs-string">        :return: 无返回值</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        v_list = node.NodeDeal.RemoveRepeatNode(p_list)<br>        v_list = <span class="hljs-variable language_">self</span>._PollutionNodeCheck(v_list)<br>        <span class="hljs-variable language_">self</span>._ReplaceSharedNodes(v_list)<br>        <span class="hljs-variable language_">self</span>._AddToSharedNodes(v_list)<br>        v_tag = <span class="hljs-variable language_">self</span>._GetNodesType(v_list)<br>        <span class="hljs-variable language_">self</span>._DeleteSharedNodes(v_list, v_tag)<br>        <span class="hljs-keyword">if</span> v_tag == node.NodeTag.PATHNODE:<br>            <span class="hljs-variable language_">self</span>._isUpdatePathNodes = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>._isUpdateBlockNodes = <span class="hljs-literal">False</span><br>        <span class="hljs-variable language_">self</span>._UpdateNodes(v_tag)<br><br>    <span class="hljs-comment"># 更新PathNode集和BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_UpdateNodes</span>(<span class="hljs-params">self, p_tag</span>):<br>        <span class="hljs-keyword">if</span> p_tag == node.NodeTag.PATHNODE:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isUpdatePathNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                    v_list = []<br>                    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._sharedNodes:<br>                        <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.PATHNODE:<br>                            v_list.append(n)<br>                    <span class="hljs-variable language_">self</span>._pathNodes = v_list<br>                <span class="hljs-variable language_">self</span>._isUpdatePathNodes = <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>._isUpdateBlockNodes <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                    v_list = []<br>                    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>._sharedNodes:<br>                        <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.BLOCKNODE:<br>                            v_list.append(n)<br>                    <span class="hljs-variable language_">self</span>._blockNodes = v_list<br>                <span class="hljs-variable language_">self</span>._isUpdateBlockNodes = <span class="hljs-literal">True</span><br><br>    <span class="hljs-comment"># 脏数据清理</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_PollutionNodeCheck</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_tag = <span class="hljs-variable language_">self</span>._GetNodesType(p_list)<br>            <span class="hljs-keyword">if</span> v_tag <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">return</span> p_list<br>            v_list = []<br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n.nodeTag == v_tag:<br>                    v_list.append(n)<br>            <span class="hljs-keyword">return</span> v_list<br>        <span class="hljs-keyword">return</span> p_list<br><br>    <span class="hljs-comment"># 获取当前Node集的种类：PathNode集或BlockNode集</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_GetNodesType</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            v_pathNodeCount = <span class="hljs-number">0</span><br>            v_blockNodeCount = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                <span class="hljs-keyword">if</span> n.nodeTag == node.NodeTag.PATHNODE:<br>                    v_pathNodeCount += <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    v_blockNodeCount += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> v_pathNodeCount &gt; v_blockNodeCount:<br>                <span class="hljs-keyword">return</span> node.NodeTag.PATHNODE<br>            <span class="hljs-keyword">elif</span> v_pathNodeCount &lt; v_blockNodeCount:<br>                <span class="hljs-keyword">return</span> node.NodeTag.BLOCKNODE<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># Node集的修改功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_ReplaceSharedNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                v_list = <span class="hljs-variable language_">self</span>._sharedNodes<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                    v_list = node.NodeDeal.ReplaceNode(v_list, n)<br>                <span class="hljs-variable language_">self</span>._sharedNodes = v_list<br><br>    <span class="hljs-comment"># Node集的添加功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_AddToSharedNodes</span>(<span class="hljs-params">self, p_list</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                v_list = []<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> p_list:<br>                    <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(<span class="hljs-variable language_">self</span>._sharedNodes, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        v_list.append(n)<br>                <span class="hljs-variable language_">self</span>._sharedNodes.extend(v_list)<br><br>    <span class="hljs-comment"># Node集的删除功能</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_DeleteSharedNodes</span>(<span class="hljs-params">self, p_list: <span class="hljs-built_in">list</span>, p_tag: node.NodeTag</span>):<br>        <span class="hljs-keyword">if</span> p_list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(p_list) != <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._lock:<br>                <span class="hljs-keyword">if</span> p_tag == node.NodeTag.PATHNODE:<br>                    v_nodes = <span class="hljs-variable language_">self</span>._pathNodes<br>                <span class="hljs-keyword">else</span>:<br>                    v_nodes = <span class="hljs-variable language_">self</span>._blockNodes<br>                <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> v_nodes:<br>                    <span class="hljs-keyword">if</span> node.NodeCheck.RepeatCheck(p_list, n) <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>                        v_index = <span class="hljs-variable language_">self</span>._sharedNodes.index(n)<br>                        <span class="hljs-keyword">del</span> <span class="hljs-variable language_">self</span>._sharedNodes[v_index]<br></code></pre></td></tr></table></figure><h3 id="Main-py"><a href="#Main-py" class="headerlink" title="Main.py"></a>Main.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> SearchPath <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Grid <span class="hljs-keyword">as</span> grid<br><span class="hljs-keyword">from</span> myCodes <span class="hljs-keyword">import</span> Block <span class="hljs-keyword">as</span> block<br><br><span class="hljs-comment"># 创建网格，传递行数和列数</span><br>g = grid.Grid(<span class="hljs-number">7</span>, <span class="hljs-number">7</span>)<br><span class="hljs-comment"># 生成障碍物</span><br>block.Block(<span class="hljs-number">30</span>).Create()<br><span class="hljs-comment"># 查找最佳路径</span><br>sp.SearchPath().Search()<br><span class="hljs-comment"># 绘制图象</span><br>g.Draw()<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇中我们需要重点关注的是这三个类：NodeMove、NodeDeal、SearchPath，NodeMove类主要负责移动规则的制定和检测，NodeDeal类主要负责Node以及Node集相关的处理，SearchPath类主要负责最佳路径的查找。在NodeMove类中包括这几个重要的方法，GetNextNodes用于获取经过可移动检测的NextNode集，GetMoveDirection用于获取当前Node至下一步Node的方向，NextNodeMoveCheck用于检测当前Node至下一步Node是否可移动，NextNodesMoveCheck用于检测当前Node的NextNode集中是否存在可移动的Node，GetDiagonalMoveNode用于获取经过可替换斜向移动检测的目标Node，GetDoubleNonDiagonalMoveNode用于获取经过二次可替换非斜向移动检测的目标Node，GetDirectionNodes用于获取上一个Node至当前Node的方向Node集，DirectionNodeCheck用于对当前Node的NextNode集进行方向Node集检测。在NodeDeal类中包括这几个重要的方法，SetWeightValue用于设置一次斜向移动和一次非斜向移动的权值，CalculateWeight用于对Node集进行权值计算，CalculateG用于计算Node的G值，CalculateH用于计算Node的H值，当然还包括其它的一些Node集处理方法。SearchPath类中的Search方法负责调度和组合查找最佳路径相关的方法。我们虽已完成了基本的寻路算法，但是这只是一种简单模拟的情景，也就是我们在一个网格中，生成了障碍物，然后我们需要根据移动规则来找到从起始点到终点的最佳路径，但是这只是静态的情景，在游戏中，我们把起始点比作敌人，终点比作玩家，那么玩家通常是在不断移动的，所以我们需要在终点进行移动的同时动态调整路径，以实现对终点的追踪，我们将在后续的文章中继续对这个问题进行探讨。</p>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 寻路算法 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【解决方案】关于Unity中下载的扩展插件无法导入命名空间的解决建议</title>
      
      <link href="/posts/2026/01/07/e2bec2510c9e/"/>
      <url>/posts/2026/01/07/e2bec2510c9e/</url>
      
        <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>从Unity的PackageMangaer中下载的扩展插件无法在C#代码中引入命名空间</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>Unity版本：2020.3.26.f1c1</p><p>开发IDE：VSCode</p><p>下载的扩展插件：Cinemachine</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><ul><li><p>在Unity编辑器界面：打开扩展工具设置面板（Edit&#x2F;Preferences&#x2F;External Tools）</p></li><li><p>勾选Embedded packages，点击Regenerate project files按钮即可</p></li></ul><img src="/posts/2026/01/07/e2bec2510c9e/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><h2 id="F-Q"><a href="#F-Q" class="headerlink" title="F&amp;Q"></a>F&amp;Q</h2><p><strong>Q: Generate .csproj files for各个选项分别代表什么？</strong></p><p><strong>A:</strong></p><ul><li><a href="https://docs.unity3d.com/cn/2021.3/Manual/upm-embed.html">Embedded packages（嵌入式包）</a></li><li><a href="https://docs.unity3d.com/2020.3/Documentation/Manual/upm-ui-local.html">Local packages（本地包）</a></li><li><a href="https://docs.unity3d.com/2020.3/Documentation/Manual/upm-git.html">Git packages（Git包）</a></li><li><a href="https://docs.unity3d.com/2020.3/Documentation/Manual/upm-ui-install.html">Registry packages（注册表包）</a></li><li><a href="https://docs.unity3d.com/2020.3/Documentation/Manual/pack-build.html">Built-in packages（内置包）</a></li><li><a href="https://docs.unity3d.com/2020.3/Documentation/Manual/upm-ui-tarball.html">Local tarball（本地tarball）</a></li><li>Packages from unknown sources（未知来源的包）</li></ul><p><strong>Q: 怎么知道要勾选Generate .csproj files for的哪一个选项呢？</strong></p><p><strong>A:</strong> 根据问题1的答案了解各种包的含义，而Cinemachine既属于Embedded packages也属于Registry packages，之所以优先选择Embedded packages是因为其本身就是项目中已经导入的包，Cinemachine作为新的Embedded package，只需要导入Cinemachine即可，如果选择Registry packages会导入大量未被使用但是仍然属于Registry packages的包。</p><p><strong>Q: 手动导入的.dll文件缺少命名空间怎么办？</strong></p><p><strong>A:</strong> 按照解决建议一操作即可，不用重新打开代码编辑器。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>算法题——用对角线去遍历矩阵</title>
      
      <link href="/posts/2026/01/07/43066579c297/"/>
      <url>/posts/2026/01/07/43066579c297/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该系列文章仅仅展示个人的解题思路和分析过程，并非一定是优质题解，重要的是通过分析和解决问题能让我们逐渐熟练和成长，从新手到大佬离不开一个磨练的过程，加油！原题链接：<a href="https://leetcode.cn/leetbook/read/array-and-string/cuxq3/">用对角线去遍历矩阵</a></p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><img src="/posts/2026/01/07/43066579c297/img1.png" class="" width="723" height="492"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><img src="/posts/2026/01/07/43066579c297/img2.png" class="" width="668" height="480"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><img src="/posts/2026/01/07/43066579c297/img3.png" class="" width="655" height="429"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图3</div><img src="/posts/2026/01/07/43066579c297/img4.png" class="" width="649" height="422"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图4</div><p>由上述四个图可以总结得出以下八个结论：</p><p><strong>结论1：</strong> k属于[0,a(max)+b(max)]。</p><p><strong>结论2：</strong> 每一层遍历行最多存在min(m,n)个矩阵索引对，min(m,n)表示m和n二者中小的那一个值。</p><p><strong>结论3：</strong> a属于[0,m-1]，b属于[0,n-1]。</p><p><strong>结论4：</strong> 若k为偶数则以a为比较对象，此时若k&lt;&#x3D;a(max)则当前遍历行的起始索引对为(k,0)，反之则起始索引对为(a(max),k-a(max))。</p><p><strong>结论5：</strong> 若k为奇数则以b为比较对象，此时若k&lt;&#x3D;b(max)则当前遍历行的起始索引对位(0,k)，反之则起始索引对为(k-b(max),b(max))。</p><p><strong>结论6：</strong> 从当前遍历行的起始索引对开始，若k为偶数，则下一个索引对为(a-1,b+1)，反之下一个索引对为(a+1,b-1)。</p><p><strong>结论7：</strong> 遍历行的结束条件由该矩阵的遍历行最大索引对个数和a(min)、b(min)共同决定，首先应判断当前遍历行访问的矩阵索引对个数是否达到了该矩阵的遍历行最大索引对个数，若达到了则完成该遍历行的遍历，否则判断下一个索引对(a,b)，若a或b越界则表明完成该遍历行的遍历。</p><p><strong>结论8：</strong> 整个矩阵遍历结束的条件是当前遍历的矩阵索引对的个数是m×n个。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] <span class="hljs-title">FindDiagonalOrder</span>(<span class="hljs-params"><span class="hljs-built_in">int</span>[][] mat</span>)</span><br>&#123;<br>    <span class="hljs-built_in">int</span> m = mat.Length;<span class="hljs-comment">//矩阵的行数</span><br>    <span class="hljs-built_in">int</span> n = mat[<span class="hljs-number">0</span>].Length;<span class="hljs-comment">//矩阵的列数</span><br>    <span class="hljs-built_in">int</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[m * n];<span class="hljs-comment">//结果数组</span><br>    <span class="hljs-comment">//a:索引对的a,b:索引对的b,k:a+b,count:当前已遍历的矩阵索引对个数,minA:a的最小值</span><br>    <span class="hljs-comment">//minB:b的最小值,index:结果数组中的索引指针</span><br>    <span class="hljs-built_in">int</span> a, b, k = <span class="hljs-number">0</span>, count = <span class="hljs-number">0</span>, minA = <span class="hljs-number">0</span>, minB = <span class="hljs-number">0</span>, index = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> maxA = m - <span class="hljs-number">1</span>;<span class="hljs-comment">//a的最大值</span><br>    <span class="hljs-built_in">int</span> maxB = n - <span class="hljs-number">1</span>;<span class="hljs-comment">//b的最大值</span><br>    <span class="hljs-built_in">int</span> maxIndexsCount = m &lt;= n ? m : n;<span class="hljs-comment">//该矩阵中遍历行的矩阵索引对个数的最大值</span><br>    <span class="hljs-built_in">int</span> lineIndexsCount;<span class="hljs-comment">//遍历行当前已遍历的矩阵索引对个数</span><br>    <span class="hljs-keyword">while</span> (count &lt; m * n)<br>    &#123;<br>        lineIndexsCount = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//若k%2为0则表示k为偶数，反之则为奇数</span><br>        <span class="hljs-keyword">if</span> (k % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (k &lt;= maxA)<br>            &#123;<br>                a = k;<br>                b = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                a = maxA;<br>                b = k - maxA;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (k &lt;= maxB)<br>            &#123;<br>                a = <span class="hljs-number">0</span>;<br>                b = k;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                a = k - maxB;<br>                b = maxB;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (lineIndexsCount &lt; maxIndexsCount)<br>        &#123;<br>            <span class="hljs-comment">//a或b越界则完成此次遍历行的遍历</span><br>            <span class="hljs-keyword">if</span> ((a &lt; minA || a &gt; maxA) || (b &lt; minB || b &gt; maxB)) <span class="hljs-keyword">break</span>;<br>            <span class="hljs-comment">//记录结果</span><br>            result[index++] = mat[a][b];<br>            count++;<br>            <span class="hljs-keyword">if</span> (k % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)<br>            &#123;<br>                a--;<br>                b++;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                a++;<br>                b--;<br>            &#125;<br>        &#125;<br>        k++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>按照原题的思路我们列举出了四种矩阵，严格来说只有三种，分别是矩阵行数大于列数、行数等于列数、行数小于列数，而为了保证后续结论的真实性，我们列举了两个行数等于列数的矩阵。</p><p>图中我们完成了四个矩阵的制定，然后按照题目要求去遍历了四个矩阵并且将遍历的结果记录下来，从行列定义上我们可以将矩阵构建在二维平面中，从而为每一个元素设立一个唯一的坐标值，在本题中我们把这个坐标值称为索引对。有了索引对我们可以进一步按照索引对两个数值之和对遍历结果进行分组，在本题中我们把索引对两个数值之和相同的一组索引对称为遍历行，为了简便后续将索引对两个数值之和称为索引对结果值。</p><p>将遍历行按照索引对结果值从小到大的顺序进行排列，为了能够发现更多有用的结论，我们把每一层遍历行的索引对结果值、结果值的奇偶性、索引对与k值的关系列举出来，除此之外还需要列举出矩阵行列数以及索引对两个数值的取值范围，至于为什么要去列举这些东西，实际上还是通过尝试和思考，就像上学时做数学题，浏览题目之后列举出题目中给定的条件，然后根据条件去解题。</p><p>这一步我们可以理解为进一步细化和剖析已知条件，我们的目的是从已知条件中获取可靠的结论，从而根据结论解决问题，因此我们总结出了上文的八个结论。</p><p>那么已知结论后如何去编写代码呢？本人是按照以下几个问题去解决的。</p><ol><li><p>我们需要明白输入和输出是什么？</p></li><li><p>我们需要定义哪些变量？</p></li><li><p>函数主体是什么？</p></li><li><p>某些过程的结束条件是什么？</p></li></ol><p>实际上，就是将我们的八个结论构建为代码，简单划分就是定义变量和逻辑主体，定义变量就看结论中需要记录数据的描述，逻辑主体就看结论中对于逻辑处理、结束条件的描述。</p><p>当然这样转换出来的代码比较粗糙，所以后续还可以结合自己的编程知识再去优化自己的代码，让它变得更加简洁精致。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>算法题——旋转图像（旋转矩阵）</title>
      
      <link href="/posts/2026/01/07/bcb1e9b527e5/"/>
      <url>/posts/2026/01/07/bcb1e9b527e5/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该系列文章仅仅展示个人的解题思路和分析过程，并非一定是优质题解，重要的是通过分析和解决问题能让我们逐渐熟练和成长，从新手到大佬离不开一个磨练的过程，加油！原题链接：<a href="https://leetcode.cn/problems/rotate-image/">旋转图像（旋转矩阵）</a></p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>若矩阵的行列数为N，设i表示行索引，i属于[1,N]，按照题意旋转矩阵则可以理解为我们需要将第i行的所有元素转换为第N-i+1列，如示例1所示，第1行为[1,2,3]，旋转后的第1行则变成了第3列，第2行与第3行同样如此。</p><img src="/posts/2026/01/07/bcb1e9b527e5/img1.png" class="" width="437" height="330"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><img src="/posts/2026/01/07/bcb1e9b527e5/img2.png" class="" width="427" height="334"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><blockquote><p>经现有测试该方法适用于行列数相同的矩阵，但不确定是否适用于行列数不同的矩阵。</p></blockquote><p>如图（1）索引分别为(0,0)，(0,1)，(0,2)，(0,3)，(1,3)，(2,3)，(3,3)，(3,2)，(3,1)，(3,0)，(2,0)，(1,0)的点围成了一个圈，假设我们称之为矩阵圈。那么由外向内我们依次称为第1层矩阵圈，第2层矩阵圈，……第n层矩阵圈。图（1）所示有两个矩阵圈，第1层矩阵圈的索引集合为[(0,0)，(0,1)，(0,2)，(0,3)，(1,3)，(2,3)，(3,3)，(3,2)，(3,1)，(3,0)，(2,0)，(1,0)]，第2层矩阵圈的索引集合为[(1,1)，(1,2)，(2,2)，(2,1)]。</p><p>如图（1）和图（2）我们可以发现通过对每个矩阵圈的旋转即可完成对整个矩阵的旋转，而对矩阵圈的旋转实际上就是对矩阵圈进行点交换。点交换的意思是交换矩阵圈四个边上的点，并且每个点是相互对应的。</p><p>如图（3）所示，第一次交换索引为(0,0)和索引为(0,3)的点，第二次交换索引为(0,0)和索引为(3,3)的点，第三次交换索引为(0,0)和索引为(3,0)的点，我们把这称为矩阵圈的点交换。而这仅仅是矩阵圈的第一次点交换，假设该矩阵圈的行数和列数均为m，那么旋转该矩阵圈则需要(m-1)次点交换。</p><img src="/posts/2026/01/07/bcb1e9b527e5/img3.png" class="" width="406" height="307"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图3</div><img src="/posts/2026/01/07/bcb1e9b527e5/img4.png" class="" width="408" height="322"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图4</div><img src="/posts/2026/01/07/bcb1e9b527e5/img5.png" class="" width="411" height="321"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图5</div><img src="/posts/2026/01/07/bcb1e9b527e5/img6.png" class="" width="411" height="321"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图6</div><p>图（3）（4）（5）（6）则为该矩阵圈的一次完整的90°旋转。</p><p>为了从定量角度分析这个规律。首先我们可以定义四个变量rowA,rowB,colA,colB分别表示每一个矩阵圈的首行尾行以及首列尾列，并对它们进行初始化，rowA&#x3D;0,rowB&#x3D;m-1,colA&#x3D;0,colB&#x3D;m-1，rowA指向当前矩阵圈第一行，rowB指向最后一行，colA指向当前矩阵圈第一列，colB指向最后一列。其次我们再定义一个变量count，表示当前矩阵圈需要进行点交换的次数，count属于[1,m-1]。那么该矩阵圈进行点交换的四个点的索引分别为：</p><div style="text-align:center">(rowA,colA+count-1),  (rowA+count-1,colB),<p>(rowB,colB-count+1),  (rowB-count+1,colA)</p></div>我们只需要按照(rowA+count-1,colB),(rowB,colB-count+1),(rowB-count+1,colA)的索引顺序分别与索引为(rowA,colA+count-1)的点进行交换即可，每完成一次点交换则count进行+1操作，当count等于m-1时表示该矩阵圈的90°旋转完成。所以接下来需要收缩rowA,rowB,colA,colB四个变量，从而指向下一层矩阵圈，收缩操作即对rowA和colA进行+1操作，对rowB和colB进行-1操作，重复上述过程从外向内旋转矩阵圈直至rowA、rowB、colA、colB四个变量的值相等则表明整个矩阵完成了90°的旋转。<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Rotate</span>(<span class="hljs-params"><span class="hljs-built_in">int</span>[][] matrix</span>)</span><br>&#123;<br>    <span class="hljs-comment">//定义变量</span><br>    <span class="hljs-built_in">int</span> rowA = <span class="hljs-number">0</span>, rowB = matrix.Length - <span class="hljs-number">1</span>, colA = <span class="hljs-number">0</span>, colB = matrix[<span class="hljs-number">0</span>].Length - <span class="hljs-number">1</span>, count = <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//逻辑主体</span><br>    <span class="hljs-keyword">while</span> (count &lt;= colB - colA)<br>    &#123;<br>        <span class="hljs-comment">//矩阵点交换</span><br>        (matrix[rowA][colA + count - <span class="hljs-number">1</span>], matrix[rowA + count - <span class="hljs-number">1</span>][colB]) = (matrix[rowA + count - <span class="hljs-number">1</span>][colB], matrix[rowA][colA + count - <span class="hljs-number">1</span>]);<br>        (matrix[rowA][colA + count - <span class="hljs-number">1</span>], matrix[rowB][colB - count + <span class="hljs-number">1</span>]) = (matrix[rowB][colB - count + <span class="hljs-number">1</span>], matrix[rowA][colA + count - <span class="hljs-number">1</span>]);<br>        (matrix[rowA][colA + count - <span class="hljs-number">1</span>], matrix[rowB - count + <span class="hljs-number">1</span>][colA]) = (matrix[rowB - count + <span class="hljs-number">1</span>][colA], matrix[rowA][colA + count - <span class="hljs-number">1</span>]);<br>        <span class="hljs-comment">//矩阵圈收缩</span><br>        <span class="hljs-keyword">if</span> (count == colB - colA)<br>        &#123;<br>            colA++;<br>            colB--;<br>            rowA++;<br>            rowB--;<br>            count = <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> count++;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>结合算法分析过程，我们将矩阵的旋转转换为矩阵圈的旋转，然后将矩阵圈的旋转转换为矩阵点的交换，也就是说矩阵旋转的本质就是矩阵中各个元素的交换，实际上我们从图（1）和图（2）就可以发现，转换前的矩阵的第一行变成了转换后的矩阵的最后一列，但是本文的解题思路并未采取这种方式。</p><p>由于每个矩阵圈都有四条边，所以旋转矩阵圈就是在交换四个边上指定的元素，具体的思路算法分析中已经描述得比较详尽，对于如何将分析过程转换为代码，对于多数算法题来说本质上都是明确两个重点，一个是变量，一个是逻辑主体。本题中所用到的变量包括用于明确当前矩阵圈的四个指针，还有一个用于记录当前矩阵圈进行点交换的次数。而逻辑主体则包括矩阵点交换和矩阵圈收缩，同时需要明确逻辑主体退出的条件。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>算法题——翻转二叉树</title>
      
      <link href="/posts/2026/01/06/13320c8a870d/"/>
      <url>/posts/2026/01/06/13320c8a870d/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该系列文章仅仅展示个人的解题思路和分析过程，并非一定是优质题解，重要的是通过分析和解决问题能让我们逐渐熟练和成长，从新手到大佬离不开一个磨练的过程，加油！原题链接：<a href="https://leetcode.cn/problems/invert-binary-tree/">翻转二叉树</a></p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>如下图1和图2可按照（1）、（2）、（3）、（4）的顺序依次对每个非叶子节点的左右孩子节点进行镜像反转，对于只有一个孩子节点的节点也要进行镜像反转操作。</p><img src="/posts/2026/01/06/13320c8a870d/img1.jpeg" class="" width="556" height="421"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><img src="/posts/2026/01/06/13320c8a870d/img2.jpeg" class="" width="558" height="425"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><ul><li><p><strong>如何完成镜像反转？</strong></p><p>可以通过递归遍历整棵树，遍历过程中按照以下方式进行判断和操作：</p><ul><li><p>若当前节点为空或无左孩子和右孩子节点则返回;</p></li><li><p>否则继续遍历左右孩子节点;</p></li><li><p>交换左右孩子节点;</p></li></ul></li><li><p><strong>如何交换左右孩子节点？</strong></p><ul><li><p>左右孩子节点均不为空，则交换左右孩子节点；</p></li><li><p>左孩子节点为空且右孩子节点不为空，则右孩子节点赋给左孩子节点，右孩子节点置空；</p></li><li><p>右孩子节点为空且左孩子节点不为空，则左孩子节点赋给右孩子节点，左孩子节点置空.</p></li></ul></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//翻转二叉树</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> TreeNode <span class="hljs-title">MirrorTree</span>(<span class="hljs-params">TreeNode root</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) Reverse(root);<br>    <span class="hljs-keyword">return</span> root;<br>&#125;<br><br><span class="hljs-comment">//对以指定节点为根节点的二叉树进行镜像反转操作</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reverse</span>(<span class="hljs-params">TreeNode node</span>)</span><br>&#123;<br>    <span class="hljs-comment">//检测是否满足镜像反转要求</span><br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span> || (node.left == <span class="hljs-literal">null</span> &amp;&amp; node.right == <span class="hljs-literal">null</span>)) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span>) Reverse(node.left);<span class="hljs-comment">//对当前节点的左孩子节点进行镜像反转操作</span><br>    <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span>) Reverse(node.right);<span class="hljs-comment">//对当前节点的右孩子节点进行镜像反转操作</span><br>    SwapChildren(node);<span class="hljs-comment">//交换当前节点的左右孩子节点</span><br>&#125;<br><br><span class="hljs-comment">//交换指定节点的左右孩子节点</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SwapChildren</span>(<span class="hljs-params">TreeNode node</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span> &amp;&amp; node.right != <span class="hljs-literal">null</span>)<br>        (node.left, node.right) = (node.right, node.left);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.left == <span class="hljs-literal">null</span> &amp;&amp; node.right != <span class="hljs-literal">null</span>)<br>        (node.left, node.right) = (node.right, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span> &amp;&amp; node.right == <span class="hljs-literal">null</span>)<br>        (node.right, node.left) = (node.left, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据题目要求我们需要对一个二叉树进行翻转操作，主方法的输入是该二叉树的根节点，返回值也是一个节点。实际上我们可以对问题进行细分，对二叉树的翻转实际上就是对二叉树节点的交换或者说是将每个节点的位置进行重新排序，有的节点的位置保持不变（如根节点），有的节点则需要与其它节点交换位置（如叶子节点等）。</p><p>对问题进行转换后，我们自然需要对整个二叉树进行遍历，那么我们就需要搞清楚两个问题。</p><ol><li><p>什么时候交换节点？</p></li><li><p>怎么交换节点？</p></li></ol><p>如图1和图2我们列举出了本题目将会出现的两种二叉树，根据这两种二叉树我们去找到上面两个问题的答案，具体思路请参考算法分析。</p><p>如何将算法分析转换为代码，依旧是确定两个点，一是变量，二是逻辑主体，本题目的算法分析中并没有要求需要单独定义变量去记录数据，所以我们只看逻辑主体即可，代码示范中，我们将节点交换方法独立出来，以方便维护以及增加可读性，由于我们采用的是递归方式遍历二叉树，所以进行二叉树反转的逻辑我们也将其单独定义为一个函数。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>算法题——机器人的运动范围</title>
      
      <link href="/posts/2026/01/06/9bc20f9428e7/"/>
      <url>/posts/2026/01/06/9bc20f9428e7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该系列文章仅仅展示个人的解题思路和分析过程，并非一定是优质题解，重要的是通过分析和解决问题能让我们逐渐熟练和成长，从新手到大佬离不开一个磨练的过程，加油！原题链接：<a href="https://leetcode.cn/leetbook/read/illustration-of-algorithm/9h6vo2/">机器人的运动范围</a></p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><img src="/posts/2026/01/06/9bc20f9428e7/img1.jpeg" class="" width="521" height="398"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><p>图1是机器人移动范围的网格，结合题目的描述，我们来确定变量和逻辑主体。</p><ul><li><p><strong>变量：</strong> 设网格的行数为m，列数为n，移动限定值为k，设单元格坐标为(x,y)，[x]表示x的数位之和，[y]同理，可达坐标个数sum，已探索坐标列表list。</p></li><li><p><strong>特殊描述：</strong></p><ul><li><p>k是用于判断移动是否合理的值，要求[x]+[y] &lt;&#x3D; k；</p></li><li><p>数位之和：如数字45，[45]&#x3D;4+5&#x3D;9；</p></li><li><p>移动方向分为上下左右，不可越界；</p></li><li><p>起点为(0,0)，1 &lt;&#x3D; m &lt;&#x3D; 100，1 &lt;&#x3D; n &lt;&#x3D; 100，0 &lt;&#x3D; k &lt;&#x3D; 20；</p></li></ul></li><li><p><strong>求取[x]：</strong></p><ul><li><p>x &lt; 10，[x] &#x3D; x；</p></li><li><p>x &gt;&#x3D; 10，[x] &#x3D; x - (x &#x2F; 10) * 9；</p></li></ul></li><li><p><strong>越界判断：</strong></p></li></ul><p>单元格坐标为(x,y)，x属于[0,M-1]，y属于[0,N-1]，若x或y均满足指定取值范围则表明未越界，反之则越界。</p><ul><li><strong>机器人移动：</strong></li></ul><p>传入行数、列数、当前坐标、移动限定值、可达解个数、已访问的坐标值列表。检测当前坐标是否越界，若越界则return；检测当前坐标数位和是否满足条件，若不满足则return；检测当前坐标是否重复访问，若重复访问则return；三种情况均不满足则将当前坐标添加至已访问列表中，然后继续尝试往上下左右四个方向进行移动，重复上述过程。</p><ul><li><strong>定义一个坐标值数据结构：</strong></li></ul><p>用于记录横纵坐标、比较坐标以及生成基于当前坐标指定方向的坐标值。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//主方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">MovingCount</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> m, <span class="hljs-built_in">int</span> n, <span class="hljs-built_in">int</span> k</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (m &lt;= <span class="hljs-number">0</span> || n &lt;= <span class="hljs-number">0</span> || k &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> sum = <span class="hljs-number">0</span>;<br>    List&lt;Vector2&gt; list = <span class="hljs-keyword">new</span>();<br>    Search(m, n, <span class="hljs-keyword">new</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), k, <span class="hljs-keyword">ref</span> sum, <span class="hljs-keyword">ref</span> list);<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br><br><span class="hljs-comment">//移动方向的枚举值</span><br><span class="hljs-keyword">private</span> <span class="hljs-built_in">enum</span> Direction<br>&#123;<br>    unknown, left, right, up, down<br>&#125;<br><br><span class="hljs-comment">//坐标值数据结构</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">struct</span> Vector2<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> x;<span class="hljs-comment">//横坐标</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> y;<span class="hljs-comment">//纵坐标</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Vector2</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> x, <span class="hljs-built_in">int</span> y</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.x = x;<br>        <span class="hljs-keyword">this</span>.y = y;<br>    &#125;<br><br>    <span class="hljs-comment">//比较方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">CompareTo</span>(<span class="hljs-params">Vector2 vector</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> x == vector.x &amp;&amp; y == vector.y;<br>    &#125;<br><br>    <span class="hljs-comment">//生成基于当前坐标指定方向的坐标值</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Vector2 <span class="hljs-title">Generate</span>(<span class="hljs-params">Direction direction</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> direction <span class="hljs-keyword">switch</span><br>        &#123;<br>            Direction.left =&gt; <span class="hljs-keyword">new</span> Vector2(x - <span class="hljs-number">1</span>, y),<br>            Direction.right =&gt; <span class="hljs-keyword">new</span> Vector2(x + <span class="hljs-number">1</span>, y),<br>            Direction.up =&gt; <span class="hljs-keyword">new</span> Vector2(x, y + <span class="hljs-number">1</span>),<br>            Direction.down =&gt; <span class="hljs-keyword">new</span> Vector2(x, y - <span class="hljs-number">1</span>),<br>            _ =&gt; <span class="hljs-keyword">new</span> Vector2(x, y),<br>        &#125;;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//坐标搜索方法</span><br><span class="hljs-comment">//参数:行数、列数、坐标值、移动限定值、可达解个数、已访问的坐标值列表</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Search</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> m, <span class="hljs-built_in">int</span> n, Vector2 vector, <span class="hljs-built_in">int</span> k, <span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> sum, <span class="hljs-keyword">ref</span> List&lt;Vector2&gt; list</span>)</span><br>&#123;<br>    <span class="hljs-comment">//越界检测</span><br>    <span class="hljs-keyword">if</span> (vector.x &lt; <span class="hljs-number">0</span> || vector.x &gt;= m || vector.y &lt; <span class="hljs-number">0</span> || vector.y &gt;= n) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-comment">//当前坐标的数位和检测</span><br>    <span class="hljs-keyword">if</span> (DigitalSum(vector.x) + DigitalSum(vector.y) &gt; k) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-comment">//重复访问检测</span><br>    <span class="hljs-keyword">if</span> (list.Exists(vec =&gt; vec.CompareTo(vector))) <span class="hljs-keyword">return</span>;<br>    list.Add(vector);<br>    sum++;<br>    <span class="hljs-comment">//生成当前坐标的四个方向的坐标值</span><br>    Vector2[] vectors =<br>    &#123;<br>        vector.Generate(Direction.left),<br>        vector.Generate(Direction.right),<br>        vector.Generate(Direction.up),<br>        vector.Generate(Direction.down)<br>    &#125;;<br>    <span class="hljs-comment">//搜索四个方向的坐标</span><br>    Search(m, n, vectors[<span class="hljs-number">0</span>], k, <span class="hljs-keyword">ref</span> sum, <span class="hljs-keyword">ref</span> list);<br>    Search(m, n, vectors[<span class="hljs-number">1</span>], k, <span class="hljs-keyword">ref</span> sum, <span class="hljs-keyword">ref</span> list);<br>    Search(m, n, vectors[<span class="hljs-number">2</span>], k, <span class="hljs-keyword">ref</span> sum, <span class="hljs-keyword">ref</span> list);<br>    Search(m, n, vectors[<span class="hljs-number">3</span>], k, <span class="hljs-keyword">ref</span> sum, <span class="hljs-keyword">ref</span> list);<br>&#125;<br><br><span class="hljs-comment">//计算指定值的数位和</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> <span class="hljs-title">DigitalSum</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> val</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (val &lt; <span class="hljs-number">10</span>) <span class="hljs-keyword">return</span> val;<br>    <span class="hljs-keyword">return</span> val - (val / <span class="hljs-number">10</span>) * <span class="hljs-number">9</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据题目要求我们需要通过一个网格来模拟机器人的移动范围，并且我们对机器人可移动的单元格进行了限定，我们从左至右和从上至下分别从小到大对坐标进行划分，如此我们便可以唯一确定每一个单元格，如图1所示。坐标除了用于记录位置信息外我们还需要它提供一些特殊的方法，例如CompareTo和Generate，这两个方法分别用于比较坐标和生成基于当前坐标指定方向的坐标，因此我们应该把它单独为一个类。</p><p>其次就是我们搜索机器人移动路径的主要方法了，可以先尝试模拟一下，我们从起始点出发，拥有四个可移动的方向，但是这就存在三个特殊情况，，所以我们需要对每个坐标进行判断，第一需要考虑这个坐标是否越界，第二需要考虑这个坐标是否受到移动限定值的影响，第三需要考虑这个坐标是否已经探索过，只有当以上三个情况均不满足的时候，才应该记录为允许移动的坐标。</p><p>如何将算法分析转换为代码，依旧是确定两个点，一是变量，二是逻辑主体，结合算法分析中的描述即可确定我们需要定义哪些变量以及逻辑主体是什么。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>算法题——树的子结构</title>
      
      <link href="/posts/2026/01/06/09e53829884e/"/>
      <url>/posts/2026/01/06/09e53829884e/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该系列文章仅仅展示个人的解题思路和分析过程，并非一定是优质题解，重要的是通过分析和解决问题能让我们逐渐熟练和成长，从新手到大佬离不开一个磨练的过程，加油！原题链接：<a href="https://leetcode.cn/leetbook/read/illustration-of-algorithm/5dshwe/">树的子结构</a></p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>根据题目可以获得以下三个信息：</p><ul><li><p>树的子结构：如图1中的(2)是不属于(1)，而属于(3)的子结构，(4)是属于(1)，而不属于(3)的子结构。</p></li><li><p>空树不是任意一个树的子结构。</p></li><li><p>题目中的树均为二叉树。</p></li></ul><img src="/posts/2026/01/06/09e53829884e/img1.jpeg" class="" width="501" height="427"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><p>然后明确两个问题：</p><p><strong>Q:</strong> 空树怎么判断？</p><p><strong>A:</strong> 空树即为节点为空的树。</p><p><strong>Q:</strong> 如何判断树B是否为树A的子结构？</p><p><strong>A:</strong> 在树A中找到与树B的root节点值相同的节点，保存在一个列表中，然后依次以列表中的节点作为起始节点在树A中进行遍历，遍历过程中记录树B中剩余待遍历节点的数量count。</p><ul><li><p>若count为0，则表示树B遍历完毕则return True；</p></li><li><p>若当前树B的节点为空则return True；</p></li><li><p>若当前树A与树B的节点值相同则遍历二者的左右节点，重复①②③④；</p></li><li><p>其它情况return False；</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//二叉树节点</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TreeNode</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> val;<br>    <span class="hljs-keyword">public</span> TreeNode? left;<br>    <span class="hljs-keyword">public</span> TreeNode? right;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TreeNode</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> x</span>)</span><br>    &#123; val = x; &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsSubStructure</span>(<span class="hljs-params">TreeNode A, TreeNode B</span>)</span><br>&#123;<br>    <span class="hljs-comment">//检测是否为空树</span><br>    <span class="hljs-keyword">if</span> (A == <span class="hljs-literal">null</span> || B == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">//查询树A中与树B的root节点值相同的节点，并将它们保存在列表中</span><br>    List&lt;TreeNode&gt; rootNodes = <span class="hljs-keyword">new</span> List&lt;TreeNode&gt;();<br>    FindRootNode(A, B, <span class="hljs-keyword">ref</span> rootNodes);<br>    <span class="hljs-comment">//如果树A中不存在与树B的root节点值相同的节点则返回false</span><br>    <span class="hljs-keyword">if</span> (rootNodes.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">int</span> count = <span class="hljs-number">1</span>;<span class="hljs-comment">//记录子树中剩余待查询的节点数</span><br>    <span class="hljs-keyword">foreach</span> (TreeNode node <span class="hljs-keyword">in</span> rootNodes)<br>    &#123;<br>        <span class="hljs-comment">//每个节点都将作为一次搜索的起始点</span><br>        <span class="hljs-keyword">if</span> (Search(node, B, <span class="hljs-keyword">ref</span> count)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        count = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">//搜索方法</span><br><span class="hljs-comment">//参数:树A的节点，树B的节点，树B中剩余待查询的节点数</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Search</span>(<span class="hljs-params">TreeNode? A, TreeNode? B, <span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> count</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<span class="hljs-comment">//树B搜索完毕</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (B == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<span class="hljs-comment">//树B的节点为空</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (A != <span class="hljs-literal">null</span> &amp;&amp; B != <span class="hljs-literal">null</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (A.val == B.val)<br>        &#123;<br>            count--;<br>            <span class="hljs-keyword">if</span> (B.left != <span class="hljs-literal">null</span>) count++;<br>            <span class="hljs-keyword">if</span> (B.right != <span class="hljs-literal">null</span>) count++;<br>            <span class="hljs-keyword">return</span> Search(A.left, B.left, <span class="hljs-keyword">ref</span> count) &amp;&amp; Search(A.right, B.right, <span class="hljs-keyword">ref</span> count);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">//寻找树A中与树B的root节点相同的节点的方法</span><br><span class="hljs-comment">//参数:树A的节点，树B的节点，root节点列表</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FindRootNode</span>(<span class="hljs-params">TreeNode? A, TreeNode B, <span class="hljs-keyword">ref</span> List&lt;TreeNode&gt; rootNodes</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (A == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span> (A.val == B.val) rootNodes.Add(A);<br>    <span class="hljs-keyword">if</span> (A.left != <span class="hljs-literal">null</span>) FindRootNode(A.left, B, <span class="hljs-keyword">ref</span> rootNodes);<br>    <span class="hljs-keyword">if</span> (A.right != <span class="hljs-literal">null</span>) FindRootNode(A.right, B, <span class="hljs-keyword">ref</span> rootNodes);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>结合题目描述，我们可以明确什么是一棵树的子结构以及空树不作为任何树的子结构，在这个基础上我们去挖掘题目的变量和逻辑主体，因为二者是我们将分析思路转换为代码的关键点。粗略一看本题似乎并不需要单独定义什么变量，而逻辑主体则包括怎么判断空树以及如何确定一棵树是否为另一棵树的子结构，这两个问题我们在算法分析中进行了解答。</p><p>但是在逻辑主体中我们很容易忽略一个特殊情况，例如我们需要判断树B是否为树A的子结构，那么我们需要先在树A中找到与树B的root节点相同的节点，但是相同的节点可能不止一个，这是我们需要去考虑的问题，题目并没有规定一棵树中不能存在相同节点。因此，在我们判断树B是否为树A的子结构之前应该在树A中找到所有与树B的root节点相同的节点，并且让它们依次作为root节点去进行判断。这也就是FindRootNode方法的由来，因此我们还是需要一个变量用来存储这些root节点。</p><p>所以事实上我们还是需要两个变量，一个用来记录子树中剩余待查询的节点数，另一个用来存储root节点集合。</p><p>现在明确了本题的变量和逻辑主体，那么将思路转换为代码就比较快捷了。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>算法题——反转链表（单向链表）</title>
      
      <link href="/posts/2026/01/06/c4ac0c7407a9/"/>
      <url>/posts/2026/01/06/c4ac0c7407a9/</url>
      
        <content type="html"><![CDATA[<blockquote><p>该系列文章仅仅展示个人的解题思路和分析过程，并非一定是优质题解，重要的是通过分析和解决问题能让我们逐渐熟练和成长，从新手到大佬离不开一个磨练的过程，加油！原题链接：<a href="https://leetcode.cn/problems/reverse-linked-list/">反转链表</a></p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>问题转换：</strong> 反转链表 &lt;&#x3D;&gt; 反转节点 &lt;&#x3D;&gt; 节点前驱和后继的指向交换</p><p><strong>问题细化：</strong></p><ul><li><p><strong>变量：</strong> 需要有一个指针cur指向链表头节点，负责遍历链表；需要有一个临时变量pre用于存储cur所指向节点的前驱节点；需要有一个临时变量temp用于存储cur所指向节点的后继节点。</p></li><li><p><strong>逻辑主体：</strong></p><ul><li><p>temp &#x3D; cur.next;</p></li><li><p>cur.next &#x3D; pre;</p></li><li><p>pre &#x3D; cur;</p></li><li><p>cur &#x3D; temp;</p></li></ul></li></ul><p>具体的交换过程示例如图1，图2。</p><img src="/posts/2026/01/06/c4ac0c7407a9/img1.jpeg" class="" width="776" height="425"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><img src="/posts/2026/01/06/c4ac0c7407a9/img2.jpeg" class="" width="779" height="421"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> ListNode <span class="hljs-title">ReverseList</span>(<span class="hljs-params">ListNode head</span>)</span> <br>&#123;<br>    <span class="hljs-keyword">if</span>(head == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    ListNode cur, temp, pre;<br>    cur = head;<br>    pre = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span>(cur != <span class="hljs-literal">null</span>)<br>    &#123;<br>        temp = cur.next;<br>        cur.next = pre;<br>        pre = cur;<br>        cur = temp;<br>    &#125;<br>    <span class="hljs-keyword">return</span> pre;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对于这道题，我们希望能够在原链表的基础上直接去实现链表的反转从而减少不必要的内存开销，对于链表的反转实际上就是对链表上的每一个节点进行反转。这里我们针对双向链表和单向链表的节点反转分别进行讲解。</p><p>对于双向链表而言节点的反转就是改变前驱和后继指针的指向，让前驱指针指向原本后继指针指向的节点以及让后继指针指向原本前驱指针指向的节点。而对于单向链表而言只存在前驱和后继指针中的一个，但是它的节点反转与双向链表本质上是一样的。</p><p>实际上双向链表中单个节点反转的过程与数组中两个不同位置的元素进行交换的过程相似，数组中元素的交换需要临时存储其中一个元素，避免在交换过程中元素被覆盖或丢失，那么对于节点反转也是如此，我们需要临时存储前驱指针指向的节点或者后继指针指向的节点，但是对于单向链表而言二者都需要进行临时存储。</p><p>接下来将思路转换为代码需要明确变量和逻辑主体。本题是针对单向链表的反转，所以我们需要三个变量，一个变量用于临时存储前驱指针指向的节点，一个变量用于指向当前节点，还有一个变量用于临时存储后继指针指向的节点。逻辑主体则是从链表头节点开始依次反转当前节点的前驱和后继指向，同时要注意结束条件。</p>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      
        <title>通过建立符号链接为C盘省内存空间</title>
      
      <link href="/posts/2026/01/06/3d4d343498cb/"/>
      <url>/posts/2026/01/06/3d4d343498cb/</url>
      
        <content type="html"><![CDATA[<blockquote><p>据Windows官网的说明称，创建符号链接的权限可能存在暴露对应应用安全漏洞的风险，应该把该权限授予给受信任的用户，对于重要的文件或文件夹不建议将其存储在不安全的位置且不建议为其建立符号链接，即便存储在安全的位置也不建议随意将其用于访问的符号链接随意暴露。具体请参考：<a href="https://learn.microsoft.com/zh-cn/windows/security/threat-protection/security-policy-settings/create-symbolic-links">Windows创建符号链接</a></p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该方法仅针对Windows系统，最好配备类似SpaceSniffer这类磁盘内存分析工具。如果你的C盘剩余的内存空间不足，可以尝试通过这个方法来省出大量的内存空间，这个方法的本质就是通过Windows的符号链接功能，让C盘中指定文件或文件夹重定向到内存空间充足的磁盘中。换言之就是文件或文件夹的实际存储位置在其它磁盘，但是访问路径还是在C盘，由于多数软件的缓存或存储默认在C盘并且无法修改路径，C盘占用过多主要也是因为这个原因，通过建立符号链接就可以有效解决这个问题。SpaceSniffer工具主要是为了直观展现C盘文件或文件夹的内存占用情况，如果有其它相似的工具也可以，只要能够明确C盘哪个文件或文件夹需要建立符号链接即可。</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ul><li><p>明确C盘中需要建立符号链接的文件或文件夹的绝对路径，例如”C:\Program Files\MySQL\Connector C++ 8.0\README.txt”或”C:\Program Files\MySQL”，这个称为源路径。</p></li><li><p>明确其它盘中用于实际存储文件或文件夹的绝对路径，例如”D:\Program Files\MySQL\Connector C++ 8.0\README.txt”或”D:\Program Files\MySQL”，这个称为目标路径。</p></li><li><p>可以通过SpaceSniffer等磁盘内存分析工具更加直观地明确源路径，将源路径的内容剪切到目标路径，并且要求源路径中不可存在将要为之建立符号链接的同名文件或文件夹，即建立符号链接前应该提前将源路径的内容转移到目标路径。</p></li><li><p>完成上述工作后，Win+R输入cmd，再按Ctrl+Shift+Enter以管理员身份打开命令提示符窗口，如果是对文件建立符号链接则输入”mklink [源路径] [目标路径]”，反之如果是对文件夹建立符号链接则输入”mklink &#x2F;d [源路径] [目标路径]”，输入示例如图1和图2。</p></li></ul><img src="/posts/2026/01/06/3d4d343498cb/img1.jpeg" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><img src="/posts/2026/01/06/3d4d343498cb/img2.jpeg" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><ul><li>当显示反馈结果”为[源路径]&lt;&lt;&#x3D;&#x3D;&#x3D;&gt;&gt;[目标路径]创建的符号链接”时，即表明创建符号链接成功，如图3所示。</li></ul><img src="/posts/2026/01/06/3d4d343498cb/img3.jpeg" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图3</div><ul><li>完成上述任务后，我们最好再打开与创建符号链接的文件或文件夹相关的应用以检验该符号链接是否影响应用的正常使用，通常不会影响使用，如果出现了这种问题，就请将文件或文件夹复原，这可能说明这个应用不适用于通过创建符号链接的方式进行搬迁。</li></ul><h2 id="F-Q"><a href="#F-Q" class="headerlink" title="F&amp;Q"></a>F&amp;Q</h2><p><strong>Q:</strong> 对于隐藏文件或文件夹及其子文件或文件夹，当为之创建符号链接时可能导致“文件资源管理器——查看——隐藏的项目”选项的失效。</p><p><strong>A:</strong> 此时应该按照步骤“文件资源管理器——文件——更改文件夹和搜索选项——查看——还原为默认值——应用”，然后重启电脑就能解决这个问题了。（Windows10系统）</p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 磁盘管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>尝试自主打造一个有限状态机（一）</title>
      
      <link href="/posts/2026/01/06/368b2ccf0bc7/"/>
      <url>/posts/2026/01/06/368b2ccf0bc7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本系列文章要求读者具备一定的C#编程基础，同时对接口和抽象类、继承关系、设计模式以及面向对象等知识有所了解，在文章中我会对这些知识进行简要的阐述，对于描述有误的地方敬请指正。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们都知道Unity有自带的有限状态机Animator，它的功能非常强大，为了探索它背后的原理，我开启了这个系列的文章，尝试通过自主打造一个有限状态机来理解Animator的工作原理，同时我会将这个状态机应用于实际，进而测试它是否能够正常运转以及它的性能如何，最后针对测试结果去探索优化的方案。</p><h2 id="词表"><a href="#词表" class="headerlink" title="词表"></a>词表</h2><table><thead><tr><th>名称</th><th>阐述</th></tr></thead><tbody><tr><td>状态转换路径</td><td>以某个状态作为源状态，另一个状态作为目标状态，从源状态到目标状态的过渡关系称之为状态转换路径。</td></tr></tbody></table><h2 id="理论上的状态机"><a href="#理论上的状态机" class="headerlink" title="理论上的状态机"></a>理论上的状态机</h2><p>我们从理论上的状态机去分析一个通用状态机的组成部分，进而探索状态机的设计原理和技巧。所以我们需要明确以下五个问题的答案：</p><ol><li><p>状态机是什么？</p></li><li><p>状态机有什么作用？</p></li><li><p>状态机的组成部分有哪些？</p></li><li><p>状态机的工作原理是什么？</p></li><li><p>应该怎么去设计一个状态机？</p></li></ol><h3 id="状态机的定义"><a href="#状态机的定义" class="headerlink" title="状态机的定义"></a>状态机的定义</h3><p>有限状态机（英语：finite-state machine，缩写：FSM）又称有限状态自动机（英语：finite-state automaton，缩写：FSA），简称状态机，是表示有限个状态以及在这些状态之间的转移和动作等行为的数学计算模型。状态机的应用非常广泛，在编程中的应用仅作为其中一部分，本文不作详细阐述。具体请参考<a href="https://en.wikipedia.org/wiki/Finite-state_machine">有限状态机</a>和<a href="https://en.wikipedia.org/wiki/Automata-based_programming">自动机编程</a>。</p><p>在本系列文章中，我们可以将状态机理解为一个管理状态和状态过渡的机器，状态机需要结合当前状态和输入来检测是否能够过渡到下一个状态，当前状态可能对应多个目标状态，但是在一次检测周期中有且仅有一个目标状态可能成为下一个状态，当前状态到目标状态之间的过渡条件是事先确定好的，那么在一次周期内会对当前状态所有的过渡进行一次检测，一旦满足过渡条件则进入下一个状态。</p><h3 id="状态机的作用"><a href="#状态机的作用" class="headerlink" title="状态机的作用"></a>状态机的作用</h3><p>从状态机的定义我们就可以明确状态机是用来管理状态和状态过渡的系统，尤其是对于状态数量多或状态过渡关系复杂的情况，状态机的优势就更加突显。在开发过程中我们难免会遇到一种情况——使用大量的if-else系列语句来完成一些业务逻辑的开发，当然这往往只是简单的情况，在游戏开发中如果我们对角色控制的开发不采用状态机，那么就需要大量的变量作为锁并且使用大量的if-else语句以防止角色从某个状态跳转到其它某些状态，随着状态数量的增多，代码的可读性下降，而出错率也会随之提升，同时后续的扩展或者维护将变得艰难。（在我第一次游戏开发中就出现过这个问题）</p><h3 id="状态机的组成"><a href="#状态机的组成" class="headerlink" title="状态机的组成"></a>状态机的组成</h3><p>一个状态机至少应该包括状态、状态过渡关系、状态过渡参数和状态机系统四个部分，除此之外还可以根据具体的应用为状态机添加组成部分，状态和状态过渡关系通常作为非静态实体类分别记录状态信息和状态过渡信息，而状态机往往需要复用以及适应更加广泛的应用所以也需要作为一个非静态实体类，如果状态过渡参数的种类较多并且要求统一也可以单独为一个非静态实体类记录状态过渡参数的信息。静态类与非静态类的区别在于，静态类无法为之创建实例对象，它是密封类且无法被继承，具体请参考Static Class。</p><h3 id="状态机的工作原理"><a href="#状态机的工作原理" class="headerlink" title="状态机的工作原理"></a>状态机的工作原理</h3><p>状态机理应具备一个起始状态，当启动状态机时，对所有以起始状态为源状态的状态转换路径进行检测，若满足过渡条件则从源状态过渡到目标状态，状态机完成相关交接任务后更新当前状态为目标状态，重复上述过程。对于有退出状态的状态机，当状态机的当前状态为退出状态时则根据退出状态中的执行逻辑完成对应的任务，而对于没有明确的退出状态的状态机而言将会不断运转直至人为调用状态机的停止方法才会结束运转。</p><h3 id="状态机的设计"><a href="#状态机的设计" class="headerlink" title="状态机的设计"></a>状态机的设计</h3><p>从状态机的组成我们可以明确状态类、状态转换路径类和状态机类是必不可少的。那么是否还存在其它类呢？这个就需要看我们如何划分这三个类的工作了，实际上在程序设计中类应该尽可能遵循单一职责原则(SRP)，在这个基础上我们先尝试对这三个类的工作进行探索。状态类用于记录状态信息作为状态实体类，状态类应该包括四个基本方法，分别是进入该状态时执行的方法，处于该状态时执行的方法，退出该状态时执行的方法以及对状态进行重置的方法，除此之外状态之间可能还需要进行比较，所以还可以有状态的比较方法。状态转换路径类用于记录两个状态之间的过渡关系，应该包括获取源状态和目标状态的方法，状态转换路径重置的方法，状态转换路径的比较方法，同时对于状态转换路径是存在一个转换条件的，所以还应该包括一个用于检测该状态转换路径能否转换的方法。状态机类则作为整个状态机的系统类，负责管理所有的状态和状态转换路径以及协调状态和状态转换路径之间的对接工作，我们可以对状态和状态转换路径进行添加和删除，可以判断当前状态能否转换到指定的状态，判断该状态机类中是否存在指定的状态或状态转换路径，对当前状态的方法调用，状态机类的重置以及当前状态改变前后执行的方法。状态机应该能够独立运行，所以不应向外暴露不必要的接口避免其它调用者干预其正常运转。例如一个电梯，使用者需要按下对应方向键来告知电梯自己需要使用它以及需要向上还是向下，那么电梯就会根据使用者的要求来运转，但是其中具体的运转逻辑不是使用者所关心的，对于状态机而言也是如此，我们只需要暴露状态机的一些基本功能即可。</p><p>状态类、状态转换路径类、状态机类具体的定义可能还需要结合具体的应用场景和开发环境，例如在Unity3D中我们通常需要将状态的刷新方法放在MonoBehaviour的Update或FixedUpdate中执行，此时我们就需要暴露状态机类中的刷新方法的接口，但是对于其它某些应用场景或开发环境，刷新方法的接口也可以不暴露在外，而是通过一些内在的机制，在状态机类中自行调用，例如在状态机类中创建一个不终止的计时器，然后设置对应的时间间隔，使得刷新方法能够以时间间隔为周期反复执行，那么此时调用者只需要启动状态机，状态机则会自动启动计时器开始执行刷新方法。对于状态类和状态转换路径类，也并非有统一的定义标准，对于有些应用场景，状态中仅需要完成一次指定逻辑的执行则退出，不存在重复执行指定逻辑的需求，那么状态类中就并非一定需要刷新的方法。</p><p>所以对于状态机的设计，我们一方面要贴合实际应用，另一方面还应该遵循一些设计原则，避免让类变得臃肿，违反单一职责原则，可读性变差，扩展性变差和维护成本变高等问题。</p><h2 id="示例（UML）"><a href="#示例（UML）" class="headerlink" title="示例（UML）"></a>示例（UML）</h2><p>如图1所示是一个状态机的组成部分，它包括CSFStateMachine、CSFState、CSFStateTransition、CSFTransitionMediator、CSFStateRule和CSFStateRuleChain。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img1.jpeg" class="" width="843" height="683"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><p>图2是CSFStateMachine的类设计，它实现了IBaseStateMachine接口，作为状态机的实体类。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img2.jpeg" class="" width="923" height="389"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><p>图3是CSFState的类设计，它实现了IState接口，作为状态的实体类。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img3.jpeg" class="" width="552" height="375"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图3</div><p>图4是CSFStateTransition的类设计，它实现了IStateTransition接口，作为状态转换路径的实体类。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img4.jpeg" class="" width="471" height="572"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图4</div><p>图5是CSFTransitionMediator的类设计，这个类的作用是作为一个中介者或调停者，负责对以指定状态为源状态的所有状态转换路径进行检测。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img5.jpeg" class="" width="460" height="219"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图5</div><p>图6是CSFStateRule和CSFStateRuleChain的类设计，CSFStateRule则是作为记录状态执行逻辑的实体类，而CSFStateRuleChain则是负责对CSFStateRule的实例进行统一管理。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img6.jpeg" class="" width="709" height="454"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图6</div><p>图7这两个类并不作为状态机的组成部分之一，两个类的功能则是作为比较器分别负责状态优先级和状态转换路径优先级的比较。</p><img src="/posts/2026/01/06/368b2ccf0bc7/img7.jpeg" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图7</div>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> C# </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>尝试自主打造一个有限状态机（二）</title>
      
      <link href="/posts/2026/01/06/ba4d32539afa/"/>
      <url>/posts/2026/01/06/ba4d32539afa/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本系列文章要求读者具备一定的C#编程基础，同时对接口和抽象类、继承关系、设计模式以及面向对象等知识有所了解，在文章中我会对这些知识进行简要的阐述，对于描述有误的地方敬请指正。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇文章我们从理论角度去探索了状态机的定义、组成、作用以及设计，对状态机有了一个基本的认识，这么做有利于我们更好地去分析基于实际应用的状态机，以及在自主设计状态机时也能更加地有条不紊。本篇文章将从状态机的实际应用出发，分析基于角色控制的状态机是如何进行设计的。</p><h2 id="基于角色控制的状态机"><a href="#基于角色控制的状态机" class="headerlink" title="基于角色控制的状态机"></a>基于角色控制的状态机</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>基于角色控制的状态机是用于管理一个角色的状态的，在动作类游戏中角色的状态往往比较多，并且状态之间的过渡关系也比较繁杂，那么我们就可以为此打造一个状态机来更好地开发和维护这个部分。</p><p>从Unity3D的Animator去分析，首先一个角色通常是通过一个.controller文件来管理角色的状态的，这个. controller文件就像一个系统，从Animator的界面可以看到这个系统中包括了定义的状态、状态之间的连接以及状态过渡的条件参数等，而每个状态和状态之间的连接都有一些属性可以进行设置，由于状态机的应用不仅限于像Animator那样用于动画，所以这些属性应该根据状态机的实际应用场景去定义，如果用于动画，那么状态的属性可以是动画源文件和动画播放速度等。</p><h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><p>通常一个角色只需要使用一个状态机去控制即可，这个状态机属于角色控制的一部分，它至少应该包括角色状态类、角色状态转换路径类和角色状态机类三个部分，除此之外我们还可以把角色状态的执行逻辑与角色状态分离将其单独作为一个类，但是它仍然属于状态机。同时角色控制是与输入相关联的，所以角色状态的转换将由当前状态与输入共同决定，输入不属于角色控制，所以也就不作为状态机的组成部分，除此之外还有一些不属于状态机但是必要的部分，例如角色控制的参数、角色的消息机制和角色实体类等。那么综上所述，我们明确了基于角色控制的状态机应该包括角色状态类、角色状态转换路径类、角色状态机类和角色状态执行逻辑类四个部分。</p><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>接下来较为复杂的就是设计这四个类中具体的方法，这首先需要我们明确角色控制的需求，基于需求去设计才能尽可能避免偏离实际。</p><table><thead><tr><th align="center">组成部分</th><th align="center">必要属性</th><th align="center">可选属性</th><th align="center">必要方法</th><th align="center">可选方法</th></tr></thead><tbody><tr><td align="center">角色状态</td><td align="center">状态名称、状态优先级、角色控制参数、动画组件或系统、输入检测集合</td><td align="center">未知</td><td align="center">初始化方法、动画播放方法、重置方法</td><td align="center">未知</td></tr><tr><td align="center">角色状态转换路径</td><td align="center">源状态、目标状态、状态机、角色控制参数</td><td align="center">未知</td><td align="center">初始化方法、重置方法</td><td align="center">未知</td></tr><tr><td align="center">角色状态机</td><td align="center">未知</td><td align="center">未知</td><td align="center">初始化方法、重置方法</td><td align="center">未知</td></tr><tr><td align="center">角色状态执行逻辑</td><td align="center">角色控制参数</td><td align="center">未知</td><td align="center">刷新方法、初始化方法、重置方法</td><td align="center">未知</td></tr></tbody></table><p>角色状态最基本的功能需求是记录角色各个状态的信息，例如状态名称和状态优先级等，与角色状态对应的动画播放是采用Unity3D的Animator或Animation组件还是自定义的动画系统，这也可以作为角色状态的一部分，在角色状态中可能需要调用一些角色控制的参数，那么角色状态中还需要维护一个相关的变量，同时并非所有输入都需要在当前角色状态进行检测，例如角色跳跃的时候不一定需要检测攻击的输入，所以可以在角色状态中规定需要检测或不可检测的输入。除此之外角色状态还可以配备重置方法、初始化方法、动画播放的方法等。</p><p>角色状态转换路径需要记录源状态到目标状态的转换信息和状态转换的检测逻辑，如果需要调用状态机或角色控制参数就加上对应的变量即可，还可以配置初始化方法、重置方法等。</p><p>角色状态机需要管理各个角色状态和角色状态转换路径，向外提供调用接口，同时也可以配置初始化方法、重置方法等。角色状态机应该继承自基本的状态机，所以角色状态机中仅需要添加或重写一些特有的方法即可，具体的方法根据角色状态机的需求进行添加。</p><p>角色状态执行逻辑用于记录某个角色状态的执行逻辑，例如与某些组件一起完成当前状态的角色控制的实现或者当前状态下某些角色控制参数的改变，可以配备刷新的方法、初始化的方法以及重置方法等。</p><p>对于首次开发，我们无法非常完整地确定需求，所以我们可以边开发边改进，后续通过不断地优化来完善这个基于角色控制的状态机。</p><h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><p>基于上述需求，基于角色控制的状态机分为角色状态、角色状态机、角色状态转换路径以及角色状态执行逻辑，四个部分分别对应PlayerState类、PlayerStateMachine类、PlayerStateTransition类以及PlayerStateRule类，且四个类分别继承自CSFState类、CSFStateMachine类、CSFStateTransition类以及CSFStateRule类。而对于PlayerState、PlayerStateMachine、PlayerStateTransition以及PlayerStateRule四个类具体的设计则需要根据角色控制的具体需求去完成，在接下来的实际示例UML图中可以看到对于这四个部分的具体类设计。</p><p>我们可以先结合每个部分的功能来明确一些对应的属性和方法，然后逐渐修改完善，不断贴合需求进行优化。</p><h2 id="示例（UML）"><a href="#示例（UML）" class="headerlink" title="示例（UML）"></a>示例（UML）</h2><p>如图1所示，AnimationEvents是属于动画事件类，用于管理角色各个状态的动画中的事件。PlayerState是角色状态类，继承自CSFState这个通用状态类。PlayerStateMachine是角色状态机类，继承自CSFStateMachine这个通用状态机类。PlayerStateTransition是角色状态转换路径类，继承自CSFStateTransition这个通用状态转换路径类。PlayerStateRule是角色状态执行逻辑类，继承自CSFStateRule这个通用状态执行逻辑类。PlayerTransitionMediator是角色状态转换路径中介者类，继承自CSFTransitionMediator这个通用状态转换路径中介者类，这个中介者类负责某个状态对应的所有状态转换路径的过渡检测。</p><p>实际运转则是首先调用PlayerStateMachine中的Init方法对所有的PlayerState、PlayerStateTransition以及PlayerStateRule进行初始化，为每个PlayerState设置输入配置以及添加对应的PlayerStateRule，为每个PlayerState对应的PlayerTransitionMediator添加对应的PlayerStateTransition，最后将所有的PlayerState和PlayerStateTransition添加到PlayerStateMachine中，然后设置PlayerStateMachine的初始状态。</p><p>每个PlayerState都具备一个OnEnter、OnUpdate和OnExit方法，在角色控制类中分别调用PlayerStateMachine的接口方法StateUpdate和StateRuleUpdate，StateUpdate方法负责PlayerStateMachine中当前状态对应的OnUpdate方法的执行，当前状态的OnUpdate方法中执行PlayerTransitionMediator中的StateCheck方法用于对当前状态对应的PlayerStateTransition的过渡进行检测，由于这个示例我们借助Animator播放动画，所以对应状态的动画播放则放在了OnEnter方法中执行，PlayerTransitionMediator中的StateCheck方法则是对每个PlayerStateTransition的按照优先级进行排序，优先级高的先进行检测，这个过渡检测的逻辑则对应着PlayerStateTransition中的CanTransitionTo方法，若通过了过渡检测，则PlayerStateMachine的当前状态将过渡到指定的状态，然后继续重复上述过程，在每一次StateUpdate方法执行后都会执行一次StateRuleUpdate方法，StateRuleUpdate负责当前状态的PlayerStateRule中的Update方法的调用，进而完成对应的角色状态执行逻辑的工作。每个状态都配置着一个PlayerState、PlayerStateTransition、PlayerStateRule和PlayerTransitionMediator的派生类，在这些派生类中只需要完成对应功能具体逻辑的编写即可，不需要关注各自之间的合作和调用问题。</p><img src="/posts/2026/01/06/ba4d32539afa/img1.jpeg" class="" width="797" height="1173"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> C# </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity中立体声平移的应用</title>
      
      <link href="/posts/2026/01/06/a4cc34edbc95/"/>
      <url>/posts/2026/01/06/a4cc34edbc95/</url>
      
        <content type="html"><![CDATA[<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AudioInfo</span><br>&#123;<br>    [<span class="hljs-meta">HideInInspector</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span>[] StereoTranslationValues;<span class="hljs-comment">//立体声平移过渡值集合</span><br>    [<span class="hljs-meta">HideInInspector</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> StereoTimeSpan;<span class="hljs-comment">//立体声平移过渡值时间片</span><br>    [<span class="hljs-meta">HideInInspector</span>] <span class="hljs-keyword">public</span> AudioSource mSource;<span class="hljs-comment">//音频源组件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> StereoTranslation;<span class="hljs-comment">//是否开启立体声平移过渡</span><br><br>    <span class="hljs-comment">//立体声平移过渡协程</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator <span class="hljs-title">StereoPanTranslation</span>()</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> currentIndex = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (mSource == <span class="hljs-literal">null</span> || !StereoTranslation || StereoTranslationValues == <span class="hljs-literal">null</span> || StereoTranslationValues?.Length == <span class="hljs-number">0</span> || StereoTimeSpan &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">yield</span> <span class="hljs-keyword">break</span>;<br>            mSource.panStereo = StereoTranslationValues[currentIndex];<br>            <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">WaitForSeconds</span>(<span class="hljs-params">StereoTimeSpan</span>)</span>;<br>            currentIndex = (currentIndex + <span class="hljs-number">1</span>) % StereoTranslationValues.Length;<br>            <span class="hljs-keyword">if</span> (currentIndex == <span class="hljs-number">0</span>) StereoTranslationValues = StereoTranslationValues.Reverse().ToArray&lt;<span class="hljs-built_in">float</span>&gt;();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>上述代码仅为AudioInfo这个类的一部分，主要涉及立体声平移的属性和方法，立体声平移过渡的效果由协程StereoPanTransition实现，首先进行一个非法判断，然后修改立体声平移过渡值，每修改一次等待一个时间片，然后更新当前索引，每当当前索引为0时则反转立体声平移过渡值的集合。调用方法很简单，只需要设置好四个属性，并启动协程即可。</p></blockquote><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><p>若从左声道开始，播放效果逐渐从左声道过渡到右声道，再从右声道过渡到左声道，具体效果请戴上耳机播放下列视频。</p><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115841005914328&bvid=BV1iUisBWEcH&cid=35199912043&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>关于GitHub Desktop中的“Open in Git Bash”无法使用的问题</title>
      
      <link href="/posts/2026/01/06/6a8be3d3f751/"/>
      <url>/posts/2026/01/06/6a8be3d3f751/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在GitHub Desktop中选择Repository–Open in Git Bash（如图1），出现如图2所示结果。</p><img src="/posts/2026/01/06/6a8be3d3f751/img1.png" class="" width="960" height="457"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图1</div><img src="/posts/2026/01/06/6a8be3d3f751/img2.png" class="" width="309" height="130"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图2</div><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>这个问题是由于Git的环境变量没有得到正确配置所导致的，所以需要正确设置环境变量，解决方法参考自How to “Open in Git Bash” in Github Desktop。</p><ul><li><p>关闭GitHub Desktop;</p></li><li><p>找到”我的电脑”，鼠标右键菜单选择”属性”，选择”高级系统设置”，选择”高级–环境变量”，在用户变量中选择新建，变量名输入”GitPath”（这个名称自定），变量值为Git目录下的bin目录（默认通常是”C:\Program Files\Git\bin”），点击确定完成变量添加。然后在系统变量中找到Path并选择编辑，点击新建，输入”%GitPath%”，点击确定。如此便完成了Git的环境变量的设置；</p></li><li><p>重新打开GitHub Desktop，检验”Open in Git Bash”能否正确使用。</p></li></ul><h2 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h2><p>通常默认情况下GitHub Desktop没有设置Open in Git Bash（如图3），需要在”File–Options–Integrations–Shell”这里设置为Git Bash。</p><img src="/posts/2026/01/06/6a8be3d3f751/img3.png" class="" width="273" height="371"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图3</div>]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具使用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>自定义Unity组件——LightTransition（光照过渡）</title>
      
      <link href="/posts/2026/01/06/544f0c6a5ef1/"/>
      <url>/posts/2026/01/06/544f0c6a5ef1/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在游戏中，开发者为了让玩家更直接地看到待拾取的物品从而为其添加一种闪烁效果，或者模拟现实中闪烁的灯光效果，我能够想到的一种方案则是通过控制光照强度来实现，那么本篇文章我们就尝试通过这个方案来实现一下，看看是否能够满足这类需求，这也能够作为我们个人资源库的一部分，以后如果在开发中有这方面需求，就可以直接把这个方案搬过来用，虽然这可能只是一个小小的功能，但这是一个积少成多的过程，只要我们能够完整地实现并使之通过测试，那么就算是一种成功，也能够从中获得收获。</p><h2 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h2><p>如果大家了解过Light和Light2D组件，那么就应该知道其中的intensity属性用于控制光照强度，本质上闪烁就是通过改变光照强度的值来控制的，从暗到明，则对应intensity的值从小到大。</p><p>首先我们需要两个属性——光照强度起始值beginValue和光照强度最终值endValue，还有从beginValue到endValue的光照强度变化的步长值stepValue，同时还要确定等待时间的属性timeSpan。为了使得这个组件应用更广泛，我们不公开beginValue和endValue，而是让使用者明确光照强度的最小值minValue以及光照强度最大值maxValue，所以beginValue既可以是minValue也可以是maxValue，这取决于使用者的需求。</p><p>其次就是需要明确从beginValue到endValue的过渡方式了，我首先能够想到的是是否需要循环闪烁，假定属性Loop用于明确是否循环闪烁，如果不循环闪烁，那么只要从beginValue过渡到endValue就结束，若需要循环闪烁则需要明确循环的方式，如果每次循环都是从beginValue过渡到endValue则可以假定这种方式叫BeginToEnd，除此之外还可以是先从beginValue过渡到endValue然后再过渡到beginValue，类似一个钟摆一样，假定这种方式叫Pendulum。</p><p>最后我们还可以规定beginValue的取值，我们规定它要么是minValue，要么是maxValue，只要确定了beginValue，就可以确定endValue，所以我们假定属性beginValueType用于明确光照强度起始值的类型。</p><table><thead><tr><th align="center">属性</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">Light</td><td align="center">Unity的Light组件</td></tr><tr><td align="center">Light2D</td><td align="center">Universal RP中的Light2D组件</td></tr><tr><td align="center">intensity</td><td align="center">Light&#x2F;Light2D组件的光照强度属性</td></tr><tr><td align="center">beginValue</td><td align="center">光照强度起始值</td></tr><tr><td align="center">endValue</td><td align="center">光照强度最终值</td></tr><tr><td align="center">stepValue</td><td align="center">光照强度变化的步长值</td></tr><tr><td align="center">timeSpan</td><td align="center">光照强度变化的时间间隔</td></tr><tr><td align="center">minValue</td><td align="center">光照强度的最小值</td></tr><tr><td align="center">maxValue</td><td align="center">光照强度的最大值</td></tr><tr><td align="center">Loop</td><td align="center">是否循环闪烁</td></tr><tr><td align="center">BeginToEnd</td><td align="center">每次循环都是从beginValue过渡到endValue</td></tr><tr><td align="center">Pendulum</td><td align="center">先从beginValue过渡到endValue然后再过渡到beginValue，类似一个钟摆</td></tr><tr><td align="center">beginValueType</td><td align="center">光照强度起始值的类型</td></tr></tbody></table><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="CommonLightTransition-cs"><a href="#CommonLightTransition-cs" class="headerlink" title="CommonLightTransition.cs"></a>CommonLightTransition.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Collections;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tools</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CommonLightTransition</span> : <span class="hljs-title">MonoBehaviour</span><br>    &#123;<br>        [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要属性&quot;</span>)</span>]<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;光照强度变化平均值,默认值为0.1(值&gt;0)&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> IntensityStepValue = <span class="hljs-number">0.1f</span>;<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;光照强度最小值,默认值为1(值属于[0,IntensityMaxValue))&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> IntensityMinValue = <span class="hljs-number">1</span>;<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;光照强度最大值,默认值为2(值&gt;IntensityMinValue)&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> IntensityMaxValue = <span class="hljs-number">2</span>;<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;过渡时间间隔,默认值为0.05,单位s(值&gt;0)&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span> TransitionTimeSpan = <span class="hljs-number">0.05f</span>;<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;是否开启光照过渡循环,默认值为true&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> Loop = <span class="hljs-literal">true</span>;<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;光照过渡循环方式,需要勾选Loop该选项才有效,BeginToEnd是每次循环从光照过渡起始值开始,Pendulum是从光照过渡起始值至光照过渡最终值再过渡至光照过渡起始值(钟摆式过渡)&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> LoopMode TheLoopMode;<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;光照过渡起始值类型,Min代表起始值从IntensityMinValue开始,Max同理&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> BeginValueType TransitionBeginValueType;<br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">bool</span> toMax;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">bool</span> lockUnLoopTransition;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">int</span> index;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">bool</span> _isInit &#123; <span class="hljs-keyword">get</span> =&gt; isInit; &#125;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">float</span>[] _changedValues &#123; <span class="hljs-keyword">get</span> =&gt; changedValues; &#125;<br>        <span class="hljs-keyword">protected</span> BeginValueType _transitionBeginValueType &#123; <span class="hljs-keyword">get</span> =&gt; TransitionBeginValueType; &#125;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">bool</span> _loop &#123; <span class="hljs-keyword">get</span> =&gt; Loop; &#125;<br>        <span class="hljs-keyword">protected</span> LoopMode _loopMode &#123; <span class="hljs-keyword">get</span> =&gt; TheLoopMode; &#125;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">float</span> _intensityMinValue &#123; <span class="hljs-keyword">get</span> =&gt; IntensityMinValue; &#125;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">float</span> _intensityMaxValue &#123; <span class="hljs-keyword">get</span> =&gt; IntensityMaxValue; &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isInit, endTransition;<br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">float</span>[] changedValues;<br>        <span class="hljs-keyword">private</span> IEnumerator coroutine;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 启动过渡</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isInit &amp;&amp; endTransition)<br>            &#123;<br>                StartCoroutine(coroutine);<br>                endTransition = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 停止过渡</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StopTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isInit &amp;&amp; !endTransition)<br>            &#123;<br>                StopCoroutine(coroutine);<br>                endTransition = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化游戏对象相关组件</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>返回值:初始化组件成功则返回true,否则返回false<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 光照过渡类型处理</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TransitionTypeDeal</span>()</span> &#123; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 非循环光照过渡</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnLoopLightTransition</span>()</span> &#123; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 循环光照过渡</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoopLightTransition</span>()</span> &#123; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 组件检测控制台提示方法</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>声明:该方法仅在Unity Editor模式下且当Inspector面板中组件属性发生更改时执行<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ComponentLog</span>()</span> &#123; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 光照过渡起始值类型</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">enum</span> BeginValueType<br>        &#123;<br>            Min, Max<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 循环光照过渡方式</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-built_in">enum</span> LoopMode<br>        &#123;<br>            BeginToEnd, Pendulum<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>        &#123;<br>            isInit = InitComponents() &amp;&amp; InitParameters();<br>        &#125;<br><br>        <span class="hljs-comment">//初始化游戏对象相关参数</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitParameters</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (IntensityStepValue &lt;= <span class="hljs-number">0</span> || IntensityMinValue &lt; <span class="hljs-number">0</span> || IntensityMaxValue &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (IntensityMinValue &gt;= IntensityMaxValue) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (TransitionTimeSpan &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            changedValues = NumberRange.FloatRange(IntensityMinValue, IntensityMaxValue, IntensityStepValue, <span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">if</span> (changedValues == <span class="hljs-literal">null</span> &amp;&amp; changedValues.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            TransitionTypeDeal();<br>            coroutine = UnLoopTransition();<br>            <span class="hljs-keyword">if</span> (Loop)<br>            &#123;<br>                lockUnLoopTransition = <span class="hljs-literal">true</span>;<br>                coroutine = LoopTransition();<br>            &#125;<br>            endTransition = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> IEnumerator <span class="hljs-title">LoopTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>            &#123;<br>                LoopLightTransition();<br>                <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">WaitForSeconds</span>(<span class="hljs-params">TransitionTimeSpan</span>)</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> IEnumerator <span class="hljs-title">UnLoopTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">while</span> (!lockUnLoopTransition)<br>            &#123;<br>                UnLoopLightTransition();<br>                <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">WaitForSeconds</span>(<span class="hljs-params">TransitionTimeSpan</span>)</span>;<br>            &#125;<br>            endTransition = <span class="hljs-literal">true</span>;<br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> UNITY_EDITOR</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnValidate</span>()</span><br>        &#123;<br>            ComponentLog();<br>        &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="LightTransition2D-cs"><a href="#LightTransition2D-cs" class="headerlink" title="LightTransition2D.cs"></a>LightTransition2D.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine.Experimental.Rendering.Universal;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tools</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LightTransition2D</span> : <span class="hljs-title">CommonLightTransition</span><br>    &#123;<br>        [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要组件(需要下载扩展包:Universal RP)&quot;</span>)</span>]<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;Light2D组件&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> Light2D Light2D;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isLight2DLog;<br><br>        <span class="hljs-comment">//初始化游戏对象相关组件</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (Light2D == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//光照过渡类型处理</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TransitionTypeDeal</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_transitionBeginValueType == BeginValueType.Min)<br>            &#123;<br>                Light2D.intensity = _intensityMinValue;<br>                index = <span class="hljs-number">0</span>;<br>                toMax = <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                Light2D.intensity = _intensityMaxValue;<br>                index = _changedValues.Length - <span class="hljs-number">1</span>;<br>                toMax = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//非循环光照过渡</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnLoopLightTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isInit &amp;&amp; !lockUnLoopTransition)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (_transitionBeginValueType == BeginValueType.Min)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (index &gt;= _changedValues.Length)<br>                    &#123;<br>                        lockUnLoopTransition = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    Light2D.intensity = _changedValues[index++];<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>)<br>                    &#123;<br>                        lockUnLoopTransition = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    Light2D.intensity = _changedValues[index--];<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//循环光照过渡</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoopLightTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isInit &amp;&amp; _loop)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (_loopMode == LoopMode.Pendulum)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (index &lt;= <span class="hljs-number">0</span>) toMax = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index &gt;= _changedValues.Length - <span class="hljs-number">1</span>) toMax = <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt; _changedValues.Length - <span class="hljs-number">1</span>) TransitionTypeDeal();<br>                <span class="hljs-keyword">if</span> (toMax) Light2D.intensity = _changedValues[index++];<br>                <span class="hljs-keyword">else</span> Light2D.intensity = _changedValues[index--];<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//组件检测控制台提示方法</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ComponentLog</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (Light2D == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!isLight2DLog)<br>                &#123;<br>                    Debug.LogWarning(<span class="hljs-string">&quot;The component \&quot;&lt;color=orange&gt;&lt;b&gt;Light2D&lt;/b&gt;&lt;/color&gt;\&quot; is null.&quot;</span>);<br>                    isLight2DLog = <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> isLight2DLog = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="LightTransition-cs"><a href="#LightTransition-cs" class="headerlink" title="LightTransition.cs"></a>LightTransition.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tools</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LightTransition</span> : <span class="hljs-title">CommonLightTransition</span><br>    &#123;<br>        [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要组件&quot;</span>)</span>]<br>        [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;Light组件&quot;</span>)</span>]<br>        [<span class="hljs-meta">SerializeField</span>] <span class="hljs-keyword">private</span> Light Light;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isLightLog;<br><br>        <span class="hljs-comment">//初始化游戏对象相关组件</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (Light == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//光照过渡类型处理</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TransitionTypeDeal</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_transitionBeginValueType == BeginValueType.Min)<br>            &#123;<br>                Light.intensity = _intensityMinValue;<br>                index = <span class="hljs-number">0</span>;<br>                toMax = <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                Light.intensity = _intensityMaxValue;<br>                index = _changedValues.Length - <span class="hljs-number">1</span>;<br>                toMax = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//非循环光照过渡</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnLoopLightTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isInit &amp;&amp; !lockUnLoopTransition)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (_transitionBeginValueType == BeginValueType.Min)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (index &gt;= _changedValues.Length)<br>                    &#123;<br>                        lockUnLoopTransition = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    Light.intensity = _changedValues[index++];<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>)<br>                    &#123;<br>                        lockUnLoopTransition = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    Light.intensity = _changedValues[index--];<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//循环光照过渡</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoopLightTransition</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isInit &amp;&amp; _loop)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (_loopMode == LoopMode.Pendulum)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (index &lt;= <span class="hljs-number">0</span>) toMax = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index &gt;= _changedValues.Length - <span class="hljs-number">1</span>) toMax = <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt; _changedValues.Length - <span class="hljs-number">1</span>) TransitionTypeDeal();<br>                <span class="hljs-keyword">if</span> (toMax) Light.intensity = _changedValues[index++];<br>                <span class="hljs-keyword">else</span> Light.intensity = _changedValues[index--];<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//组件检测控制台提示方法</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ComponentLog</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (Light == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!isLightLog)<br>                &#123;<br>                    Debug.LogWarning(<span class="hljs-string">&quot;The component \&quot;&lt;color=orange&gt;&lt;b&gt;Light&lt;/b&gt;&lt;/color&gt;\&quot; is null.&quot;</span>);<br>                    isLightLog = <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> isLightLog = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="NumberRange-cs"><a href="#NumberRange-cs" class="headerlink" title="NumberRange.cs"></a>NumberRange.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">Tools</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 数值范围数组工具类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NumberRange</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取指定范围内指定步长的Float数值数组</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>p_start:起始值<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>p_end:终点值<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>p_step:步长值<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>[ContainsEnd]:是否包括终点值,默认为false<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>返回值:Float[]<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">float</span>[] <span class="hljs-title">FloatRange</span>(<span class="hljs-params"><span class="hljs-built_in">float</span> p_start, <span class="hljs-built_in">float</span> p_end, <span class="hljs-built_in">float</span> p_step, <span class="hljs-built_in">bool</span> ContainsEnd = <span class="hljs-literal">false</span></span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (!ContainsEnd) <span class="hljs-keyword">return</span> DoFloatRange(p_start, p_end, p_step).ToArray();<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                List&lt;<span class="hljs-built_in">float</span>&gt; result = DoFloatRange(p_start, p_end, p_step).ToList();<br>                result.Add(p_end);<br>                <span class="hljs-keyword">return</span> result.ToArray();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">static</span> IEnumerable&lt;<span class="hljs-built_in">float</span>&gt; <span class="hljs-title">DoFloatRange</span>(<span class="hljs-params"><span class="hljs-built_in">float</span> p_start, <span class="hljs-built_in">float</span> p_end, <span class="hljs-built_in">float</span> p_step</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">float</span> i = p_start; i &lt;= p_end; i += p_step)<br>            &#123;<br>                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> i;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="界面展示"><a href="#界面展示" class="headerlink" title="界面展示"></a>界面展示</h2><img src="/posts/2026/01/06/544f0c6a5ef1/img1.png" class="" width="333" height="268"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">LightTransition2D</div><img src="/posts/2026/01/06/544f0c6a5ef1/img2.png" class="" width="358" height="269"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">LightTransition</div><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115840989004415&bvid=BV1fCisBdEcp&cid=35199782328&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">自定义Unity组件LightTransition（2D）</div><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115840989005727&bvid=BV1ZCisBdE1b&cid=35199844716&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">自定义Unity组件LightTransition（3D）</div><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools.git">GitHub</a><br><a href="https://pan.baidu.com/s/1zF_P4HLsa6PmdM8zIfJmeA?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>自定义Unity组件——AudioManager（音频管理器）</title>
      
      <link href="/posts/2026/01/06/cb0e3424c3b3/"/>
      <url>/posts/2026/01/06/cb0e3424c3b3/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在游戏开发中，音频资源是不可或缺的，通常情况下音频资源随机分布，各个音频的操作和管理都是各自负责，同时对于音频的很多操作逻辑都是大同小异的，这就造成了许多冗余代码的堆叠，除此之外在获取各类音频资源的时候也会造成不必要的开销。所以解决资源分散的问题最直接的方式就是集中管理和分配，通过统一的渠道和特有标识即可获取或操作对应的音频资源。所以本篇文章将围绕这个方案进行尝试。</p><h2 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h2><p>在Unity中我们导入的音频资源都会转换为AudioClip，音频的设置和管理则由AudioSource负责，AudioListener负责监听音频。我们可以在此基础上去封装，从而打造一个音频管理器。</p><p>音频管理器负责管理音频信息以及操作音频，比如音频信息的增加和删除，音频的播放和暂停等；</p><p>音频信息可以使用一个单独的实体类来记录，用于记录AudioSource组件中的信息，之所以单独用一个实体类来记录音频信息而不直接采用AudioSource，主要是可以通过业务需求去动态调整所要记录的音频信息，我们的实际开发中并非需要AudioSource中所有的信息，有时候仅仅需要其中的一部分，同时音频信息可能涉及存储，直接采用AudioSource可能无法与已经开发好的存储系统相互兼容，而实体类可以为其添加接口或继承来兼容存储系统；</p><p>AudioSource组件的管理可以通过一个组件池进行管理，我们知道AudioSource也是等同于一个音频实体类，但是其同时也是一种组件，组件同样作为一种资源，通常情况下相比简单的实体类而言会带来更大的开销，例如一个场景中有十个游戏对象有播放音频的需求，那么按照传统情况就需要每个游戏对象挂载一个AudioSource组件，但是实际运行中十个游戏对象并不一定需要同时播放音频，它们或许都存在各自触发音频播放的条件，我们只需要在游戏对象需要播放音频时为其分配一个AudioSource组件即可，组件池则负责维护AudioSource组件的生产、获取和归还，进而减少资源开销。</p><p>本质上，AudioSource组件承担的工作就是记录音频信息和操作音频，我们现在将记录工作分担给音频信息实体类，而操作音频的工作则分担给音频管理器，例如音频管理器的播放依旧是调用AudioSource的播放方法，在播放之前由音频管理器去获取AudioSource组件并且为之配置音频信息，其它的音频操作逻辑同理。</p><h2 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115840989070412&bvid=BV1ECisBoEwi&cid=35199781235&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools.git">GitHub</a><br><a href="https://pan.baidu.com/s/1pgQ_79o5SGZMg6O65ea_eA?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>AssetBundle（AB包）</title>
      
      <link href="/posts/2026/01/06/e6b8dd920be3/"/>
      <url>/posts/2026/01/06/e6b8dd920be3/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是AssetBundle？"><a href="#什么是AssetBundle？" class="headerlink" title="什么是AssetBundle？"></a>什么是AssetBundle？</h2><p>AssetBundle 是一个存档文件，包含可在运行时由 Unity 加载的特定于平台的非代码资源（比如模型、纹理、预制件、音频剪辑甚至整个场景）。AssetBundle 可以表示彼此之间的依赖关系；例如，一个 AssetBundle 中的材质可以引用另一个 AssetBundle 中的纹理。为了提高通过网络传输的效率，可以根据用例要求（LZMA 和 LZ4）选用内置算法选择来压缩 AssetBundle。</p><p>参考自<a href="https://docs.unity3d.com/cn/2020.3/Manual/AssetBundlesIntro.html">官方文档</a></p><h2 id="AssetBundle可以用来做什么？"><a href="#AssetBundle可以用来做什么？" class="headerlink" title="AssetBundle可以用来做什么？"></a>AssetBundle可以用来做什么？</h2><p>AssetBundle相当于一个资源容器或资源存档，是Unity3D推荐的且与之兼容的一种资源存储文件格式，Unity3D提供了一系列相关API用于在运行时加载AssetBundle及其中的资源。</p><p>常见的应用场景：</p><ul><li>分批加载游戏非代码资源；  </li><li>游戏DLC；</li><li>游戏资源热更新；</li></ul><p>……</p><h2 id="AssetBundle的使用心得"><a href="#AssetBundle的使用心得" class="headerlink" title="AssetBundle的使用心得"></a>AssetBundle的使用心得</h2><p>在使用AssetBundle的过程中需要注意以下几点：</p><ol><li><p>早期版本Unity3D的AssetBundle可以借助AssetBundle Manager工具在编辑器中完成高效操作，从2018.2新版本开始，官方弃用了该工具，转而改用Addressable Assets。除了通过编辑器构建AssetBundle之外，还可以通过相关代码API来构建；</p></li><li><p>AssetBundle及其中的资源都可以通过同步或异步的方式加载；</p></li><li><p>Unity3D还提供了相关的API用于网络下载和从结果中直接采集AssetBundle；</p></li><li><p>加载AssetBundle中的资源时要注意资源依赖问题，加载某个资源之前应该先加载其所依赖的AssetBundle；</p></li><li><p>构建AssetBundle时可以选择内置的压缩算法来提升其在网络中的传输效率；</p></li><li><p>可以通过AssetBundleManifest获取所有AssetBundle的名称或者某个AssetBundle直接甚至完全依赖的AssetBundle。</p></li></ol><h2 id="AssetBundle分组建议"><a href="#AssetBundle分组建议" class="headerlink" title="AssetBundle分组建议"></a>AssetBundle分组建议</h2><ol><li><p>将频繁更新的对象与很少更改的对象拆分到不同的 AssetBundle 中。</p></li><li><p>将可能同时加载的对象分到一组。例如模型及其纹理和动画。</p></li><li><p>如果发现多个 AssetBundle 中的多个对象依赖于另一个完全不同的 AssetBundle 中的单个资源，请将依赖项移动到单独的 AssetBundle。如果多个 AssetBundle 引用其他 AssetBundle 中的同一组资源，一种有价值的做法可能是将这些依赖项拉入一个共享 AssetBundle 来减少重复。</p></li><li><p>如果不可能同时加载两组对象（例如标清资源和高清资源），请确保它们位于各自的 AssetBundle 中。</p></li><li><p>如果一个 AssetBundle 中只有不到 50% 的资源经常同时加载，请考虑拆分该捆绑包。</p></li><li><p>考虑将多个小型的（少于 5 到 10 个资源）但经常同时加载内容的 AssetBundle 组合在一起。</p></li><li><p>如果一组对象只是同一对象的不同版本，请考虑使用 AssetBundle 变体。</p></li></ol><p>总结自<a href="https://docs.unity3d.com/cn/2020.3/Manual/AssetBundlesIntro.html">官方文档</a></p><h2 id="各压缩方式的区别"><a href="#各压缩方式的区别" class="headerlink" title="各压缩方式的区别"></a>各压缩方式的区别</h2><p>LZMA和LZ4都是Unity3D对AssetBundle的内置压缩算法，通过压缩AssetBundle可以提高其在网络中传输的效率。三种压缩方式的区别如下：</p><table><thead><tr><th>压缩类型</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>LAMA</td><td>- 最高的压缩率，显著减少文件大小 <br>- 节省下载带宽</td><td>- 解压缩时间较长，尤其是在加载时 <br>- AssetBundle需要在加载前进行解压 <br>- 需要对整个捆绑包进行解压，才能使用AssetBundle</td><td>适合网络下载的初始资源包，减少下载时间，但不适合需要频繁加载的资源</td></tr><tr><td>LZ4</td><td>- 较快的解压速度，加载时间短 <br>- 保留一定的压缩率，减少文件大小 <br>- 基于块解压，使用AssetBundle时无须解压整个捆绑包</td><td>- 压缩率较LZMA低 <br>- 文件大小介于LZMA和不压缩之间</td><td>适合频繁加载或实时需要的资源，如游戏中场景的加载</td></tr><tr><td>不压缩</td><td>- 加载速度最快，不需要解压 <br>- 可以直接使用</td><td>- 文件大小最大，占用更多存储空间和下载带宽</td><td>适合本地存储或对加载时间要求极高的场景，如开发调试或本地资源使用</td></tr><tr><td>​</td><td></td><td></td><td></td></tr></tbody></table><blockquote><p>PS：WebGL平台不支持LZMA压缩。</p></blockquote><p>总结自<a href="https://docs.unity3d.com/cn/2020.3/Manual/AssetBundlesIntro.html">官方文档</a></p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h3><p>示例1演示了如何通过代码API来构建项目中的AssetBundle，在实际项目开发中，我们可以编写特定的编辑器工具来使得我们的构建过程可视化或者简化，除此之外还可以使用一些成熟的插件，例如YooAsset。下列展示主要代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;Assets/AssetBundle/Build AssetBundle&quot;</span>)</span>]<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BuildAB</span>()</span><br>&#123;<br>    AssetBundleManifest abm = BuildPipeline.BuildAssetBundles(Path.Combine(Application.streamingAssetsPath, <span class="hljs-string">&quot;SLWindows&quot;</span>),<br>    BuildAssetBundleOptions.ChunkBasedCompression, BuildTarget.StandaloneWindows);<br><br>    <span class="hljs-keyword">if</span> (abm != <span class="hljs-literal">null</span>)<br>    &#123;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> ab <span class="hljs-keyword">in</span> abm.GetAllAssetBundles())<br>        &#123;<br>            Debug.Log(ab);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h3><p>示例2演示了以同步和异步两种方式加载AssetBundle及其资源，在需要加载大量AssetBundle或大体积AssetBundle时两种加载方式会有明显的区别，本示例未对此种情况作演示。下列展示主要代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> Button load;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>&#123;<br>    load.onClick.AddListener(OnLoadClick);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnLoadClick</span>()</span><br>&#123;<br>    <span class="hljs-comment">// LoadSync();</span><br>    StartCoroutine(LoadAsyncCoroutine());<br>&#125;<br><br><span class="hljs-comment">// 同步加载AB包及其资源</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">LoadSync</span>()</span><br>&#123;<br>    AssetBundle mainAb = AssetBundle.LoadFromFile(Path.Combine(Application.streamingAssetsPath, <span class="hljs-string">&quot;SLWindows&quot;</span>));<br>    <span class="hljs-keyword">if</span> (mainAb == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullReferenceException(<span class="hljs-string">&quot;Main assetbundle is null.&quot;</span>);<br><br>    AssetBundleManifest manifest = mainAb.LoadAsset&lt;AssetBundleManifest&gt;(<span class="hljs-string">&quot;AssetBundleManifest&quot;</span>);<br>    <span class="hljs-built_in">string</span>[] deps = manifest.GetAllDependencies(<span class="hljs-string">&quot;prefabs&quot;</span>);<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> dep <span class="hljs-keyword">in</span> deps)<br>    &#123;<br>        AssetBundle.LoadFromFile(Path.Combine(Application.streamingAssetsPath, dep));<br>    &#125;<br><br>    AssetBundle prefabAb = AssetBundle.LoadFromFile(Path.Combine(Application.streamingAssetsPath, <span class="hljs-string">&quot;prefabs&quot;</span>));<br>    GameObject prefaba = prefabAb.LoadAsset&lt;GameObject&gt;(<span class="hljs-string">&quot;prefaba&quot;</span>);<br>    GameObject prefabb = prefabAb.LoadAsset&lt;GameObject&gt;(<span class="hljs-string">&quot;prefabb&quot;</span>);<br>    <span class="hljs-keyword">if</span> (prefaba != <span class="hljs-literal">null</span>) Instantiate(prefaba);<br>    <span class="hljs-keyword">if</span> (prefabb != <span class="hljs-literal">null</span>) Instantiate(prefabb);<br>&#125;<br><br><span class="hljs-comment">// 异步加载AB包及其资源</span><br><span class="hljs-function">IEnumerator <span class="hljs-title">LoadAsyncCoroutine</span>()</span><br>&#123;<br>    AssetBundleCreateRequest mainReq = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, <span class="hljs-string">&quot;SLWindows&quot;</span>));<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> mainReq;<br><br>    AssetBundleRequest abr = mainReq.assetBundle.LoadAssetAsync&lt;AssetBundleManifest&gt;(<span class="hljs-string">&quot;AssetBundleManifest&quot;</span>);<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> abr;<br><br>    <span class="hljs-built_in">string</span>[] deps = (abr.asset <span class="hljs-keyword">as</span> AssetBundleManifest).GetAllDependencies(<span class="hljs-string">&quot;prefabs&quot;</span>);<br>    AssetBundleCreateRequest abcr;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> dep <span class="hljs-keyword">in</span> deps)<br>    &#123;<br>        abcr = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, dep));<br>        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> abcr;<br>    &#125;<br><br>    abcr = AssetBundle.LoadFromFileAsync(Path.Combine(Application.streamingAssetsPath, <span class="hljs-string">&quot;prefabs&quot;</span>));<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> abcr;<br><br>    abr = abcr.assetBundle.LoadAssetAsync&lt;GameObject&gt;(<span class="hljs-string">&quot;prefaba&quot;</span>);<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> abr;<br>    Instantiate(abr.asset);<br><br>    abr = abcr.assetBundle.LoadAssetAsync&lt;GameObject&gt;(<span class="hljs-string">&quot;prefabb&quot;</span>);<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> abr;<br>    Instantiate(abr.asset);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h3><p><a href="https://pan.baidu.com/s/1DvWlwVkpgWbskGT41ejtkQ?pwd=5emb">百度网盘</a><br>（ABDemo.unitypackage）</p><h3 id="F-Q"><a href="#F-Q" class="headerlink" title="F&amp;Q"></a>F&amp;Q</h3><p><strong>Q1:</strong> 依赖分为直接依赖和间接依赖，如果prefabs中存在间接依赖的资源怎么办？</p><p><strong>A1:</strong> 实际上这就是AssetBundleManifest中GetAllDependencies和GetDirectDependencies的区别，前者是获取直接依赖和间接依赖的所有AB包，后者仅获取直接依赖的AB包，所以我们通常使用前者。</p><p><strong>Q2:</strong> AssetBundleManifest是固定名称吗？是否可以更改？</p><p><strong>A2:</strong> 这个名称是固定的，目前据我所知只能通过这个名称来获取AssetBundleManifest对象，但是这个名称不区分大小写，既可以是”AssetBundleManifest”也可以是”assetbundlemanifest”，或者”Assetbundlemanifest”等，结合如图1所示就能够明白了。</p><p>​<img src="/posts/2026/01/06/e6b8dd920be3/img1.png" class="" width="736" height="568"></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（一）</title>
      
      <link href="/posts/2026/01/05/740aaf532156/"/>
      <url>/posts/2026/01/05/740aaf532156/</url>
      
        <content type="html"><![CDATA[<h2 id="测试前准备工作"><a href="#测试前准备工作" class="headerlink" title="测试前准备工作"></a>测试前准备工作</h2><ul><li>创建两个游戏对象，分别取名为”Player”和”Enemy”，并且为名为”Player”的游戏对象设置Tag也为”Player”，二者在场景中如图1所示：</li></ul><img src="/posts/2026/01/05/740aaf532156/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 绿色代表Enemy，红色代表Player</div><ul><li>编写脚本组件”TriggerTest”，并挂载到Enemy上，代码如下所示：</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TriggerTest</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-comment">/*碰撞器为触发器的碰撞检测方法如下三个*/</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnTriggerEnter2D</span>(<span class="hljs-params">Collider2D other</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (other.CompareTag(<span class="hljs-string">&quot;Player&quot;</span>)) Debug.Log(<span class="hljs-string">&quot;Trigger Enter&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnTriggerStay2D</span>(<span class="hljs-params">Collider2D other</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (other.CompareTag(<span class="hljs-string">&quot;Player&quot;</span>)) Debug.Log(<span class="hljs-string">&quot;Trigger&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnTriggerExit2D</span>(<span class="hljs-params">Collider2D other</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (other.CompareTag(<span class="hljs-string">&quot;Player&quot;</span>)) Debug.Log(<span class="hljs-string">&quot;Trigger Exit&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/*碰撞器不为触发器的碰撞检测方法如下三个*/</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCollisionEnter2D</span>(<span class="hljs-params">Collision2D other</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (other.transform.CompareTag(<span class="hljs-string">&quot;Player&quot;</span>)) Debug.Log(<span class="hljs-string">&quot;Collider Enter&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCollisionStay2D</span>(<span class="hljs-params">Collision2D other</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (other.transform.CompareTag(<span class="hljs-string">&quot;Player&quot;</span>)) Debug.Log(<span class="hljs-string">&quot;Collider&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCollisionExit2D</span>(<span class="hljs-params">Collision2D other</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (other.transform.CompareTag(<span class="hljs-string">&quot;Player&quot;</span>)) Debug.Log(<span class="hljs-string">&quot;Collider Exit&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Trigger输出：输出”Trigger Enter”或”Trigger”或”Trigger Exit”；</li><li>Collider输出：输出”Collider Enter”或” Collider”或” Collider Exit”。</li></ul><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><h3 id="测试约定"><a href="#测试约定" class="headerlink" title="测试约定"></a>测试约定</h3><p>碰撞器统一使用BoxCollider2D组件，刚体统一使用Rigidbody2D组件，测试涉及更改的属性有且仅有碰撞器的激活或禁用和IsTrigger两个属性，刚体的挂载或卸载，且二者默认属性分别如图2和图3所示：</p><img src="/posts/2026/01/05/740aaf532156/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 BoxCollider2D默认属性</div><img src="/posts/2026/01/05/740aaf532156/img3.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 3 Rigidbody2D默认属性</div><h3 id="非法测试用例"><a href="#非法测试用例" class="headerlink" title="非法测试用例"></a>非法测试用例</h3><p>A2、A3、A6、A7、A11、A12、A14、A15与（一）中预设冲突，故舍弃。</p><p>B1、B4、B5、B8、B9、B10、B13、B16与（一）中预设冲突，故舍弃。</p><p>A9、A10、A13、A16未挂载碰撞器是一定不可能发生碰撞的测试用例，故舍弃。</p><p>B11、B12、B14、B15未挂载碰撞器是一定不可能发生碰撞的测试用例，故舍弃。</p><h2 id="用例表格"><a href="#用例表格" class="headerlink" title="用例表格"></a>用例表格</h2><table align="center" border="1" cellspacing="0">  <caption>表 1 测试用例</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:56.45pt">        <p style="margin-left:0; text-align:center">          <strong>游戏对象</strong></p>      </td>      <td style="border-color:#000000; width:2cm">        <p style="margin-left:0; text-align:center">          <strong>用例序号</strong></p>      </td>      <td style="border-color:#000000; width:3cm">        <p style="margin-left:0; text-align:center">          <strong>是否激活碰撞器</strong></p>      </td>      <td style="border-color:#000000; width:78pt">        <p style="margin-left:0; text-align:center">          <strong>是否挂载刚体</strong></p>      </td>      <td style="border-color:#000000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <strong>是否挂载TriggerTest</strong></p>      </td>      <td style="border-color:#000000; vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">          <strong>碰撞器是否为触发器</strong></p>      </td>    </tr>    <tr>      <td rowspan="16" style="border-color:#000000; width:56.45pt">        <p style="margin-left:0; text-align:center">          <strong>Player</strong></p>      </td>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:78pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:70.85pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A2</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">x</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A3</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">x</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">A4</p></td>      <td style="width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:78pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:70.85pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">A5</p></td>      <td style="width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:78pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:70.85pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A6</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A7</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">A8</p></td>      <td style="vertical-align:top; width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:78pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:70.85pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A9</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A10</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A11</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A12</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A13</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A14</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A15</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A16</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td rowspan="16" style="border-color:#000000; width:56.45pt">        <p style="margin-left:0; text-align:center">          <strong>Enemy</strong></p>      </td>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B1</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:78pt">        <p style="margin-left:0; text-align:center">x</p></td>      <td style="width:70.85pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">B3</p></td>      <td style="vertical-align:top; width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:78pt">        <p style="margin-left:0; text-align:center">x</p></td>      <td style="vertical-align:top; width:70.85pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B4</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B5</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">B6</p></td>      <td style="width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:78pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:70.85pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:2cm">        <p style="margin-left:0; text-align:center">B7</p></td>      <td style="width:3cm">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:78pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:70.85pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:67.75pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B8</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B9</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B10</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B11</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B12</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B13</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B14</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B15</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>    <tr>      <td style="background-color:#ffc000; width:2cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">B16</span></p>      </td>      <td style="background-color:#ffc000; width:3cm">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:78pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:70.85pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">×</span></p>      </td>      <td style="background-color:#ffc000; width:67.75pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">√</span></p>      </td>    </tr>  </tbody></table><table align="center" border="1" cellspacing="0">  <caption>表 2 测试用例组合</caption>  <tbody>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">          <strong>组合序号</strong></p>      </td>      <td style="border-color:#000000; width:139.9pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例组合</strong></p>      </td>      <td style="border-color:#000000; width:143.65pt">        <p style="margin-left:0; text-align:center">          <strong>控制台输出</strong></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G1</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A1、B2</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G2</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A1、B3</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G3</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A1、B6</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G4</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A1</span>          <span style="color:#000000">、B7</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G5</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A4、B2</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G6</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A4、B3</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G7</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A4</span>          <span style="color:#000000">、B6</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G8</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A4</span>          <span style="color:#000000">、B7</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G9</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A5、B2</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G10</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A5</span>          <span style="color:#000000">、B3</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:131.25pt">        <p style="margin-left:0; text-align:center">G11</p></td>      <td style="width:139.9pt">        <p style="margin-left:0; text-align:center">A5、B6</p></td>      <td style="width:143.65pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G12</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A5</span>          <span style="color:#000000">、B7</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G13</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A8</span>          <span style="color:#000000">、B2</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G14</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A8</span>          <span style="color:#000000">、B3</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G15</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A8</span>          <span style="color:#000000">、B6</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>    <tr>      <td style="background-color:#00b050; border-color:#000000; width:131.25pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">G16</span></p>      </td>      <td style="background-color:#00b050; width:139.9pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">A8</span>          <span style="color:#000000">、B7</span></p>      </td>      <td style="background-color:#00b050; width:143.65pt">        <p style="margin-left:0; text-align:center">          <span style="color:#000000">Trigger</span>          <span style="color:#000000">输出</span></p>      </td>    </tr>  </tbody></table><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>分析1：</strong> 对比G4、G8、G12、G16可知，当Enemy具备触发器+刚体时，无论Player的碰撞器是否为触发器或者是否具备刚体，都执行触发器的检测。</p><p><strong>分析2：</strong> 对比G7和G8可知，当Player仅具备触发器且Enemy具备刚体时，无论Enemy的碰撞器是否为触发器均执行触发器的检测。</p><p><strong>分析3：</strong> 对比G10和G12可知，当Player具备碰撞器+刚体且Enemy具备触发器时，无论Enemy是否具备刚体均执行触发器的检测。</p><p><strong>分析4：</strong> 对比G13-G16可知，当Player具备触发器+刚体时，无论Enemy的碰撞器是否为触发器或者是否具备刚体，都执行触发器的检测。</p><p>由分析1-4可知，有效触发的必要条件如下：</p><p><strong>结论1：</strong> 两个游戏对象必须有至少一个触发器。</p><p><strong>结论2：</strong> 两个游戏对象至少有一个具备刚体。</p><h2 id="碰撞检测相关的API"><a href="#碰撞检测相关的API" class="headerlink" title="碰撞检测相关的API"></a>碰撞检测相关的API</h2><p>（1）OnCollisionEnter()和OnCollisionEnter2D()；</p><p>（2）OnCollisionStay()和OnCollisionStay2D()；</p><p>（3）OnCollisionExit()和OnCollisionExit2D()；</p><p>（4）OnTriggerEnter()和OnTriggerEnter2D()；</p><p>（5）OnTriggerStay()和OnTriggerStay2D()；</p><p>（6）OnTriggerExit()和OnTriggerExit2D()；</p><p>具体看官方关于<a href="https://docs.unity.cn/cn/2020.3/ScriptReference/MonoBehaviour.html">Monobehaviour</a>类的说明。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在上面的测试中我们并没有得到Collider输出，所有的输出都是Trigger输出，这个问题的原因是啥？我们在下一篇“Unity的碰撞检测(二)”继续探讨吧。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（二）</title>
      
      <link href="/posts/2026/01/05/915597460fd4/"/>
      <url>/posts/2026/01/05/915597460fd4/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> ​本文基于前一篇“Unity的碰撞检测(一)”继续探讨Collider输出，阅读本文则默认已阅读前文。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对于Collider输出，我们首先应该保证两个游戏对象具备的是碰撞器而非触发器，所以碰撞器的IsTrigger属性必须为false。但是结合前文可知决定Trigger还是Collider输出的并不只有IsTrigger属性，对于影响两个游戏对象碰撞的因素除了碰撞器还有就是刚体，这是我们基于前文的结论所得知的。那么刚体中影响碰撞的属性有两个，分别是BodyType和CollisionDetection。</p><p>本次测试我们约定如此：Player具备碰撞器，Enemy具备刚体，Enemy具备触发器或碰撞器，默认属性分别如图1和图2所示：</p><img src="/posts/2026/01/05/915597460fd4/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 碰撞器默认属性</div><img src="/posts/2026/01/05/915597460fd4/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 刚体默认属性</div><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><table align="center" border="1" cellspacing="0">  <caption>表 1 Enemy不同BodyType的测试用例</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Enemy的碰撞器是否为触发器</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>用例序号</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Static</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Kinematic</strong></p>      </td>      <td style="border-color:#000000; width:83pt">        <p style="margin-left:0; text-align:center">          <strong>Dynamic</strong></p>      </td>    </tr>    <tr>      <td rowspan="3" style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A2</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A3</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td rowspan="3" style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B1</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B3</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>  </tbody></table><table align="center" border="1" cellspacing="0">  <caption>表 2 测试用例的控制台输出</caption>  <tbody>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">          <strong>测试结果序号</strong></p>      </td>      <td style="border-color:#000000; width:136.95pt">        <p style="margin-left:0; text-align:center">          <strong>用例序号</strong></p>      </td>      <td style="border-color:#000000; width:145.5pt">        <p style="margin-left:0; text-align:center">          <strong>控制台输出</strong></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">R1</p></td>      <td style="width:136.95pt">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:145.5pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">R2</p></td>      <td style="width:136.95pt">        <p style="margin-left:0; text-align:center">A2</p></td>      <td style="width:145.5pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">R3</p></td>      <td style="width:136.95pt">        <p style="margin-left:0; text-align:center">A3</p></td>      <td style="width:145.5pt">        <p style="margin-left:0; text-align:center">Collider输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">R4</p></td>      <td style="width:136.95pt">        <p style="margin-left:0; text-align:center">B1</p></td>      <td style="width:145.5pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">R5</p></td>      <td style="width:136.95pt">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:145.5pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; vertical-align:top; width:132.35pt">        <p style="margin-left:0; text-align:center">R6</p></td>      <td style="width:136.95pt">        <p style="margin-left:0; text-align:center">B3</p></td>      <td style="width:145.5pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>  </tbody></table><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>分析1：</strong> 由R1-R3可知刚体的BodyType属性为Dynamic才会出现Collider输出。</p><p><strong>分析2：</strong> 由R4-R5可知刚体的BodyType属性为Kinematic或Dynamic才会出现Trigger输出。</p><p>结合上述分析和前文的结论可得：</p><p>（1）有效触发或碰撞的共有必要条件如下：</p><p><strong>结论1：</strong> 两个游戏对象至少有一个具备刚体。</p><p>（2）有效触发的特有必要条件如下：</p><p><strong>结论2：</strong> 两个游戏对象必须有至少一个触发器。</p><p><strong>结论3：</strong> 刚体的BodyType属性为Kinematic或Dynamic。</p><p>（3）有效碰撞的特有必要条件如下：</p><p><strong>结论4：</strong> 两个游戏对象必须有至少一个碰撞器。</p><p><strong>结论5：</strong> 刚体的BodyType属性为Dynamic。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文我们的测试是基于Player具备碰撞器，Enemy具备刚体，Enemy具备触发器或碰撞器。这是基于仅一个游戏对象具备刚体的前提，如果两个游戏对象都具备刚体是否会因为各自的BodyType属性不同而产生不同的结果呢？我们在下一篇“Unity的碰撞检测(三)”继续探讨吧。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（三）</title>
      
      <link href="/posts/2026/01/05/720ec788db37/"/>
      <url>/posts/2026/01/05/720ec788db37/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> ​本文基于前一篇“Unity的碰撞检测(二)”继续探讨两个游戏对象具备刚体的碰撞检测，阅读本文则默认已阅读前文。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在基于两个游戏对象都具备碰撞器和刚体且属性一致的条件下，若二者刚体的BodyType有所不同是否会出现不同的测试结果。</p><p>本次测试我们约定如此：Player与Enemy都具备碰撞器和刚体，默认属性如图1和图2所示：</p><img src="/posts/2026/01/05/720ec788db37/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 碰撞器默认属性</div><img src="/posts/2026/01/05/720ec788db37/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 刚体默认属性</div><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><table align="center" border="1" cellspacing="0">  <caption>表 1 Player和Enemy的刚体的BodyType测试用例</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>游戏对象</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例序号</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Static</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Kinematic</strong></p>      </td>      <td style="border-color:#000000; width:83pt">        <p style="margin-left:0; text-align:center">          <strong>Dynamic</strong></p>      </td>    </tr>    <tr>      <td rowspan="3" style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">Player</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A2</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A3</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td rowspan="3" style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">Enemy</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B1</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B3</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>  </tbody></table><table align="center" border="1" cellspacing="0">  <caption>表 2 测试用例的控制台输出</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>组合序号</strong></p>      </td>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例组合</strong></p>      </td>      <td style="border-color:#000000; width:138.3pt">        <p style="margin-left:0; text-align:center">          <strong>控制台输出</strong></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G1</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G2</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G3</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G4</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G5</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G6</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G7</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G8</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G9</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出</p></td>    </tr>  </tbody></table><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>分析1：</strong> 由G1-G3可知，当Player的刚体的BodyType为Static时，仅当Enemy的刚体的BodyType为Dynamic才会产生有效碰撞。</p><p><strong>分析2：</strong> 由G4-G6可知，当Player的刚体的BodyType为Kinematic时，仅当Enemy的刚体的BodyType为Dynamic才会产生有效碰撞。</p><p><strong>分析3：</strong> 由G7-G9可知，当Player的刚体的BodyType为Dynamic时，无论Enemy的刚体的BodyType为什么都会产生有效碰撞。</p><p>由上述分析可得以下结论：</p><p><strong>结论1：</strong> 两个游戏对象发生有效碰撞的必要条件之一是至少有一个游戏对象的刚体的BodyType为Dynamic。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文的测试结果进一步验证了前文的结论5，但是本文仅针对有效碰撞进行了测试，而针对有效触发的测试是否也是同样的结果呢？我们在下一篇“Unity的碰撞检测(四)”继续探讨吧。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（四）</title>
      
      <link href="/posts/2026/01/05/45b77bc65a2b/"/>
      <url>/posts/2026/01/05/45b77bc65a2b/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> ​本文基于前一篇“Unity的碰撞检测(三)”继续探讨两个游戏对象具备刚体的触发检测，阅读本文则默认已阅读前文。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在基于两个游戏对象都具备触发器和刚体且属性一致的条件下，若二者刚体的BodyType有所不同是否会出现不同的测试结果。</p><p>本次测试我们约定如此：Player与Enemy都具备触发器和刚体，默认属性如图1和图2所示：</p><img src="/posts/2026/01/05/45b77bc65a2b/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 碰撞器默认属性</div><img src="/posts/2026/01/05/45b77bc65a2b/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 刚体默认属性</div><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><table align="center" border="1" cellspacing="0">  <caption>表 1 Player和Enemy的刚体的BodyType测试用例</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>游戏对象</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例序号</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Static</strong></p>      </td>      <td style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">          <strong>Kinematic</strong></p>      </td>      <td style="border-color:#000000; width:83pt">        <p style="margin-left:0; text-align:center">          <strong>Dynamic</strong></p>      </td>    </tr>    <tr>      <td rowspan="3" style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">Player</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A2</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">A3</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td rowspan="3" style="border-color:#000000; width:82.95pt">        <p style="margin-left:0; text-align:center">Enemy</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B1</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">B3</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:82.95pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:83pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>  </tbody></table><table align="center" border="1" cellspacing="0">  <caption>表 2 测试用例的控制台输出</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>组合序号</strong></p>      </td>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例组合</strong></p>      </td>      <td style="border-color:#000000; width:138.3pt">        <p style="margin-left:0; text-align:center">          <strong>控制台输出</strong></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G1</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G2</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G3</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G4</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G5</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G6</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G7</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G8</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G9</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Trigger输出</p></td>    </tr>  </tbody></table><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>分析1：</strong> 由G1可知，当Player和Enemy的刚体的BodyType均为Static时，不会产生有效触发。</p><p><strong>分析2：</strong> 由G2和G3可知，当Player的刚体的BodyType为Static时，Enemy的刚体的BodyType为Kinematic或Dynamic都会产生有效触发。</p><p><strong>分析3：</strong> 由G4-G6可知，当Player的刚体的BodyType为Kinematic时，无论Enemy的刚体的BodyType为什么都会产生有效触发。</p><p><strong>分析4：</strong> 由G7-G9可知，当Player的刚体的BodyType为Dynamic时，无论Enemy的刚体的BodyType为什么都会产生有效触发。</p><p>根据上述分析可得以下结论：</p><p><strong>结论1：</strong> 两个游戏对象发生有效触发的必要条件之一是至少有一个游戏对象的刚体的BodyType为Kinematic或Dynamic。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文的测试进一步验证了”Unity的碰撞检测(二)”中的结论3，至此关于有效碰撞和有效触发的必要条件的探索告一段落。但是对于Unity的碰撞检测而言这仅仅是一个开始，对于刚体的BodyType为Dynamic时，它的Collision Detection属性会对碰撞检测产生什么影响呢？我们在下一篇“Unity的碰撞检测(五)”继续探讨吧。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（五）</title>
      
      <link href="/posts/2026/01/05/14c4b6fc8c7f/"/>
      <url>/posts/2026/01/05/14c4b6fc8c7f/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> ​本文基于前一篇“Unity的碰撞检测(四)”继续探讨两个游戏对象具备刚体的BodyType均为Dynamic，但是Collision Detection属性不同的碰撞检测，阅读本文则默认已阅读前文。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在基于两个游戏对象都具备碰撞器和刚体的前提下，如果碰撞器属性一致，二者刚体的属性除了Collision Detection不固定，其它属性保持一致。那么会对碰撞检测产生什么影响？事实上，Collision Detection属性并不是决定两个游戏对象是否发生碰撞的因素，而是决定二者如何发生碰撞的因素，所以测试指标我们还需要添加一个”是否高速碰撞”，高速碰撞通过Rigidbody2D.AddForce方法实现，力的大小数值为100，ForceMode2D保持默认，但是对于非高速碰撞的界定无法确认，根据实际应用中碰撞时的情况灵活选择Discrete或Continous。</p><p>本次测试我们约定如此：Player与Enemy都具备碰撞器和刚体，且二者的刚体的BodyType均为Dynamic，默认属性如图1和图2所示：</p><img src="/posts/2026/01/05/14c4b6fc8c7f/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 碰撞器默认属性</div><img src="/posts/2026/01/05/14c4b6fc8c7f/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 刚体默认属性</div><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><table align="center" border="1" cellspacing="0">  <caption>表 1 Player和Enemy的刚体的Collision Detection测试用例</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:83.95pt">        <p style="margin-left:0; text-align:center">          <strong>游戏对象</strong></p>      </td>      <td style="border-color:#000000; width:78.25pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例序号</strong></p>      </td>      <td style="border-color:#000000; width:86.55pt">        <p style="margin-left:0; text-align:center">          <strong>Discrete</strong></p>      </td>      <td style="border-color:#000000; width:91.6pt">        <p style="margin-left:0; text-align:center">          <strong>Continuous</strong></p>      </td>      <td style="border-color:#000000; vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">          <strong>是否高速碰撞</strong></p>      </td>    </tr>    <tr>      <td rowspan="4" style="border-color:#000000; width:83.95pt">        <p style="margin-left:0; text-align:center">Player</p></td>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">A2</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">A3</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">A4</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td rowspan="4" style="border-color:#000000; width:83.95pt">        <p style="margin-left:0; text-align:center">Enemy</p></td>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">B1</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">B3</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">B4</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>  </tbody></table><table align="center" border="1" cellspacing="0">  <caption>表 2 测试用例的控制台输出</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>组合序号</strong></p>      </td>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例组合</strong></p>      </td>      <td style="border-color:#000000; width:138.3pt">        <p style="margin-left:0; text-align:center">          <strong>测试结果</strong></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G1</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">1.Collider输出无碰撞穿透</p>        <p style="margin-left:0; text-align:center">2.碰撞穿透无Collider输出</p>        <p style="margin-left:0; text-align:center">3.Collider输出且碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G2</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">1.Collider输出无碰撞穿透</p>        <p style="margin-left:0; text-align:center">2.碰撞穿透无Collider输出</p>        <p style="margin-left:0; text-align:center">3.Collider输出且碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G3</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G4</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B4</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G5</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">1.Collider输出无碰撞穿透</p>        <p style="margin-left:0; text-align:center">2.碰撞穿透无Collider输出</p>        <p style="margin-left:0; text-align:center">3.Collider输出且碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G6</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G7</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G8</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B4</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G9</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G10</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G11</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G12</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A3、B4</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G13</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A4、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G14</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A4、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G15</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A4、B3</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G16</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A4、B4</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">无</p></td>    </tr>  </tbody></table><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>分析1：</strong> 由G1、G2和G5可知当Player和Enemy的刚体的Collision Detection均为Discrete时，无论二者谁进行高速碰撞测试结果都不稳定。</p><p><strong>分析2：</strong> 由G3、G4、G7、G9-G13和G15可知Player和Enemy的刚体的Collision Detection至少有一个为Continous时，无论二者谁进行高速碰撞测试结果都是Collider输出无碰撞穿透。</p><p>根据上述分析可得以下结论：</p><p><strong>结论1：</strong> 两个游戏对象在发生有效碰撞的前提下，要能够正确进行碰撞检测和避免碰撞穿透则至少有一个游戏对象的刚体的Collision Detection为Continous。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文针对两个游戏对象在满足有效碰撞的前提下，对于二者的刚体的BodyType均为Dynamic，但是二者的Collision Detection属性不同而产生不同的碰撞检测结果进行探讨。那么对于一个游戏对象的刚体的BodyType为Dynamic，另一个为Kinematic，而二者的Collision Detection属性不同会产生什么样的碰撞检测结果呢？我们在下一篇“Unity的碰撞检测(六)”继续探讨吧。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（六）</title>
      
      <link href="/posts/2026/01/05/c613ee643de1/"/>
      <url>/posts/2026/01/05/c613ee643de1/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> ​本文基于前一篇“Unity的碰撞检测(五)”继续探讨两个游戏对象具备刚体的BodyType均为Dynamic，但是Collision Detection属性不同的碰撞检测，阅读本文则默认已阅读前文。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在基于两个游戏对象都具备碰撞器和刚体的前提下，如果碰撞器属性一致，而一个游戏对象的刚体的BodyType为Dynamic，另一个为Kinematic，除了Collision Detection属性不一致，其它属性保持一致，那么会对碰撞检测产生什么影响？</p><p>本次测试我们约定如此：Player与Enemy都具备碰撞器和刚体，Player的刚体的BodyType为Dynamic，而Enemy的刚体的BodyType为Kinematic，且仅Player进行高速碰撞，默认属性如图1和图2所示：</p><img src="/posts/2026/01/05/c613ee643de1/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 碰撞器默认属性</div><img src="/posts/2026/01/05/c613ee643de1/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 刚体默认属性</div><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><table align="center" border="1" cellspacing="0">  <caption>表 1 Player和Enemy的刚体的Collision Detection测试用例</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:83.95pt">        <p style="margin-left:0; text-align:center">          <strong>游戏对象</strong></p>      </td>      <td style="border-color:#000000; width:78.25pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例序号</strong></p>      </td>      <td style="border-color:#000000; width:86.55pt">        <p style="margin-left:0; text-align:center">          <strong>Discrete</strong></p>      </td>      <td style="border-color:#000000; width:91.6pt">        <p style="margin-left:0; text-align:center">          <strong>Continuous</strong></p>      </td>      <td style="border-color:#000000; vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">          <strong>是否高速碰撞</strong></p>      </td>    </tr>    <tr>      <td rowspan="2" style="border-color:#000000; width:83.95pt">        <p style="margin-left:0; text-align:center">Player</p></td>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">A1</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">A2</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">√</p></td>    </tr>    <tr>      <td rowspan="2" style="border-color:#000000; width:83.95pt">        <p style="margin-left:0; text-align:center">Enemy</p></td>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">B1</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>    <tr>      <td style="width:78.25pt">        <p style="margin-left:0; text-align:center">B2</p></td>      <td style="width:86.55pt">        <p style="margin-left:0; text-align:center">×</p></td>      <td style="width:91.6pt">        <p style="margin-left:0; text-align:center">√</p></td>      <td style="vertical-align:top; width:74.45pt">        <p style="margin-left:0; text-align:center">×</p></td>    </tr>  </tbody></table><table align="center" border="1" cellspacing="0">  <caption>表 2 测试用例的控制台输出</caption>  <tbody>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>组合序号</strong></p>      </td>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">          <strong>测试用例组合</strong></p>      </td>      <td style="border-color:#000000; width:138.3pt">        <p style="margin-left:0; text-align:center">          <strong>测试结果</strong></p>      </td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G1</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">1.碰撞穿透无Collider输出</p>        <p style="margin-left:0; text-align:center">2.Collider输出无碰撞穿透</p>        <p style="margin-left:0; text-align:center">3.Collider输出且碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G2</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A1、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G3</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B1</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>    <tr>      <td style="border-color:#000000; width:138.25pt">        <p style="margin-left:0; text-align:center">G4</p></td>      <td style="width:138.25pt">        <p style="margin-left:0; text-align:center">A2、B2</p></td>      <td style="width:138.3pt">        <p style="margin-left:0; text-align:center">Collider输出无碰撞穿透</p></td>    </tr>  </tbody></table><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>分析1：</strong> 由G1可知，当Player和Enemy的刚体的Collision Detection均为Discrete时，高速碰撞产生的碰撞检测结果不稳定。</p><p><strong>分析2：</strong> 由G2-G4可知，当Player或Enemy的刚体的Collision Detection为Continous时，高速碰撞始终产生Collider输出且无碰撞穿透。</p><p>由以上分析可得以下结论：</p><p><strong>结论1：</strong> 两个游戏对象在发生有效碰撞的前提下，要能够正确进行碰撞检测和避免碰撞穿透则至少有一个游戏对象的刚体的Collision Detection为Continous。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​本文所得到的结论与前文一致，但是二者的测试条件有所不同，前文基于两个游戏对象的刚体的BodyType均为Dynamic，而本文则是一个游戏对象的刚体的BodyType为Dynamic，另一个为Kinematic。下一篇为Unity碰撞检测系列文章的总结篇，将对所有结论进行总结。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的碰撞检测（总结篇）</title>
      
      <link href="/posts/2026/01/05/f035df818883/"/>
      <url>/posts/2026/01/05/f035df818883/</url>
      
        <content type="html"><![CDATA[<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><h3 id="有效碰撞的必要条件"><a href="#有效碰撞的必要条件" class="headerlink" title="有效碰撞的必要条件"></a>有效碰撞的必要条件</h3><ul><li>两个游戏对象至少有一个具备刚体。</li><li>两个游戏对象必须有至少一个碰撞器。</li><li>至少一个刚体的BodyType属性为Dynamic（即IsKinematic为false）。</li></ul><blockquote><p>刚体必须是 Dynamic 才会被物理引擎主动推动，Static 或 Kinematic 的刚体可以参与碰撞检测，但不会因碰撞而移动。</p></blockquote><h3 id="有效触发的必要条件"><a href="#有效触发的必要条件" class="headerlink" title="有效触发的必要条件"></a>有效触发的必要条件</h3><ul><li>两个游戏对象至少有一个具备刚体。</li><li>两个游戏对象至少有一个具备触发器（即IsTrigger为true），另一个具备触发器或碰撞器。</li></ul><h3 id="在有效碰撞的前提下进行正确的碰撞检测的条件"><a href="#在有效碰撞的前提下进行正确的碰撞检测的条件" class="headerlink" title="在有效碰撞的前提下进行正确的碰撞检测的条件"></a>在有效碰撞的前提下进行正确的碰撞检测的条件</h3><p>两个游戏对象在发生有效碰撞的前提下，要能够正确进行碰撞检测则至少有一个游戏对象的刚体的Collision Detection为Continous或Continous Dynamic或Continous Speculative。</p><blockquote><ul><li>Continuous 检测模式主要针对高速移动物体防止“隧穿”（tunneling）。  </li><li>Continuous Dynamic 对动态物体有效，Continuous 对所有刚体有效。  </li><li>Continuous Speculative 在某些版本中也可用，但可能有性能或精度差异。</li></ul></blockquote><h3 id="在有效碰撞的前提下进行正确的碰撞检测和避免碰撞穿透的条件"><a href="#在有效碰撞的前提下进行正确的碰撞检测和避免碰撞穿透的条件" class="headerlink" title="在有效碰撞的前提下进行正确的碰撞检测和避免碰撞穿透的条件"></a>在有效碰撞的前提下进行正确的碰撞检测和避免碰撞穿透的条件</h3><p>两个游戏对象在发生有效碰撞的前提下，要能够正确进行碰撞检测和避免碰撞穿透则至少有一个游戏对象的刚体的Collision Detection为Continous或Continous Dynamic。</p><blockquote><p><strong>注意：</strong> 即使开启 Continuous 检测，极端高速下仍可能穿透，这时可能需要调整时间步长或使用射线检测辅助。</p></blockquote><h3 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h3><p>如果两个物体都是 Static 或 Kinematic，即使有碰撞器也不会产生碰撞物理响应（但可能触发 OnTriggerEnter 等）。</p><p>Kinematic 刚体可通过代码移动，并可与 Dynamic 刚体碰撞。</p><p>碰撞检测的层级（Layer）设置也会影响是否发生碰撞或触发。</p><p>Collision Detection 模式：</p><ul><li>Discrete：默认，性能好，可能隧穿。</li><li>Continuous：对当前物体使用连续检测（防隧穿）。</li><li>Continuous Dynamic：对动态物体使用连续检测。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Windows一键添加命名前缀（文件）</title>
      
      <link href="/posts/2026/01/05/37796c65953a/"/>
      <url>/posts/2026/01/05/37796c65953a/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> 使用前建议先进行测试和原文件备份，避免引起不必要的损失。</p></blockquote><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>在上班摸鱼的我正准备打开手机刷会儿CSDN论坛，老板发给我一个压缩包并要求我给里面所有的文件的名称添加一个前缀”大项目_”。我本以为只有几个文件需要改，便没放在心上，反倒是心里暗暗吐槽老板“这么简单的任务动动手就搞定了，还要单独发给我来帮他弄，简直就是对打工人的压榨”。</p><p>想罢，我便把压缩包解压在了当前目录下，结果这进度条走了得有十几秒，我心里顿时有种不好的预感，然后打开目录一看，密密麻麻的各种类型的文件铺满了文件资源管理器，我敢说我这辈子也没在一个目录下看到过这么多文件，它们仿佛是老板的数千个替身，带着嘲讽的神情看着我。</p><p>我心中暗道“这能忍？”，兄弟们接下来且看我操作。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><ul><li>在当前目录下，我创建了一个.txt文件，用文本编辑器打开并写上了以下代码：</li></ul><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bat">:: 关闭bat脚本命令回显<br>@<span class="hljs-built_in">echo</span> off<br>:: 启用变量延迟扩展<br><span class="hljs-built_in">setlocal</span> enabledelayedexpansion<br>:: 记录用户输入<br><span class="hljs-built_in">set</span> /p prefix=Please input the prefix to add:<br>:: 遍历当前目录下所有文件<br><span class="hljs-keyword">for</span> <span class="hljs-variable">%%i</span> <span class="hljs-keyword">in</span> (*) <span class="hljs-keyword">do</span> (<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> &quot;<span class="hljs-variable">%%i</span>&quot;==&quot;%~nx0&quot; (<br>        <span class="hljs-built_in">ren</span> &quot;<span class="hljs-variable">%%i</span>&quot; &quot;<span class="hljs-variable">%prefix%</span><span class="hljs-variable">%%i</span>&quot;<br>    )<br>)<br><span class="hljs-built_in">endlocal</span><br></code></pre></td></tr></table></figure><ul><li>随后Ctrl+S保存一下，关闭文本编辑器，F2重命名将.txt后缀改为.bat；</li><li>双击该Bat文件运行，根据提示输入待添加的命名前缀；</li><li>关闭DOS命令窗口，等待系统刷新或F5手动刷新。</li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为了避免咱的代码可能出现问题，真正投入使用前当然还是要进行测试的，万一有时候没有备份又不小心把原有的文件名覆盖了，就难搞了。测试情景如图1所示。</p><img src="/posts/2026/01/05/37796c65953a/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 测试情景</div><p>测试结果如图2所示。</p><img src="/posts/2026/01/05/37796c65953a/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 测试结果</div><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>“@echo off”关闭bat脚本的命令显示，将用户的输入存储在变量“prefix”中，然后遍历当前目录下的所有文件，排除与当前bat脚本同名的文件，其它文件统一添加命名前缀。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li><p>当前版本代码所运行的操作系统为Windows10，其它版本的Windows系统未经测试，为避免造成不必要的损失，建议正式使用前先测试一下；</p></li><li><p>当前版本代码只适用于修改其所在层级目录的文件，不迭代子目录，不作用于文件夹；</p></li><li><p>与bat脚本同名的文件将不会被有效作用。</p></li></ul><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Windows一键添加命名后缀（文件）</title>
      
      <link href="/posts/2026/01/05/c60bde629890/"/>
      <url>/posts/2026/01/05/c60bde629890/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> 使用前建议先进行测试和原文件备份，避免引起不必要的损失。</p></blockquote><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>之前老板让我给大量文件添加命名前缀，如今为了防患于未然，我决定把添加命名后缀的功能也实现一下，虽然这与添加前缀大同小异，不过还是有一些需要注意的细节问题，我们是在文件名(不带扩展名)后添加命名后缀，而不是在文件扩展名后添加后缀，所以不能直接进行简单的顺序交换。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><ul><li>在当前目录下，我创建了一个.txt文件，用文本编辑器打开并写上了以下代码：</li></ul><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bat">:: 关闭bat脚本命令回显<br>@<span class="hljs-built_in">echo</span> off<br>:: 启用变量延迟扩展<br><span class="hljs-built_in">setlocal</span> enabledelayedexpansion<br>:: 记录用户输入<br><span class="hljs-built_in">set</span> /p suffix=Please input the suffix to add:<br>:: 遍历当前目录下所有文件<br><span class="hljs-keyword">for</span> <span class="hljs-variable">%%i</span> <span class="hljs-keyword">in</span> (*) <span class="hljs-keyword">do</span> (<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> &quot;<span class="hljs-variable">%%i</span>&quot;==&quot;%~nx0&quot; (<br>        <span class="hljs-built_in">ren</span> &quot;<span class="hljs-variable">%%i</span>&quot; &quot;<span class="hljs-variable">%%~</span>ni<span class="hljs-variable">%suffix%</span><span class="hljs-variable">%%~</span>xi&quot;<br>    )<br>)<br><span class="hljs-built_in">endlocal</span><br></code></pre></td></tr></table></figure><ul><li>随后Ctrl+S保存一下，关闭文本编辑器，F2重命名将.txt后缀改为.bat；</li><li>双击该Bat文件运行，根据提示输入待添加的命名后缀；</li><li>关闭DOS命令窗口，等待系统刷新或F5手动刷新。</li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为了避免咱的代码可能出现问题，真正投入使用前当然还是要进行测试的，万一有时候没有备份又不小心把原有的文件名覆盖了，就难搞了。测试情景如图1所示。</p><img src="/posts/2026/01/05/c60bde629890/img1.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 测试情景</div><p>测试结果如图2所示。</p><img src="/posts/2026/01/05/c60bde629890/img2.png" class=""><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 测试结果</div><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>“@echo off”关闭bat脚本的命令显示，将用户的输入存储在变量“suffix”中，然后遍历当前目录下的所有文件，排除与当前bat脚本同名的文件，其它文件统一添加命名后缀。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li><p>当前版本代码所运行的操作系统为Windows10，其它版本的Windows系统未经测试，为避免造成不必要的损失，建议正式使用前先测试一下；</p></li><li><p>当前版本代码只适用于修改其所在层级目录的文件，不迭代子目录，不作用于文件夹；</p></li><li><p>与bat脚本同名的文件将不会被有效作用。</p></li></ul><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Windows一键替换完整名称字段(文件)</title>
      
      <link href="/posts/2026/01/05/29d9e84fb398/"/>
      <url>/posts/2026/01/05/29d9e84fb398/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>温馨提示：</strong> 使用前建议先进行测试和原文件备份，避免引起不必要的损失。</p></blockquote><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><p>前不久有个粉丝联系我，说我之前出的关于一键添加文件命名前后缀的博文无法满足他多变的需求，他说希望出一篇一键替换文件完整名称字段的博文。没办法，本来我都不想写了，谁叫我宠粉呢。</p><p>解释一下“一键替换完整名称字段(文件)”，这次的功能是替换，而不是添加，完整名称包括文件名称和文件扩展名，所以我们要实现的需求如下：</p><ol><li><p>能够一键替换含有指定公有字段的文件的名称。</p></li><li><p>能够一键替换含有指定公有字段的文件的扩展名。</p></li></ol><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><ul><li>在当前目录下，我创建了一个.txt文件，用文本编辑器打开并写上了以下代码：</li></ul><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bat">@<span class="hljs-built_in">echo</span> off<br>:: 开启延迟变量扩展，使得循环中的变量可以动态更新<br><span class="hljs-built_in">setlocal</span> enabledelayedexpansion<br><br>:: 获取待替换的旧字段和用以替换旧字段的新字段<br><span class="hljs-built_in">set</span> /p old_field=input field: <br><span class="hljs-built_in">set</span> /p new_field=input <span class="hljs-built_in">replace</span>: <br><br>:: 遍历当前目录下的所有文件，然后依次判断和替换字段<br><span class="hljs-keyword">for</span> <span class="hljs-variable">%%i</span> <span class="hljs-keyword">in</span> (*<span class="hljs-variable">%old_field%</span>*) <span class="hljs-keyword">do</span> (<br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> &quot;<span class="hljs-variable">%%i</span>&quot; == &quot;<span class="hljs-variable">%~nx0%</span>&quot; (<br>    <span class="hljs-built_in">set</span> &quot;filename=<span class="hljs-variable">%%i</span>&quot;<br>    <span class="hljs-built_in">set</span> &quot;new_filename=<span class="hljs-variable">!filename:%old_field%=%new_field%!</span>&quot;<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> &quot;<span class="hljs-variable">!filename!</span>&quot;==&quot;<span class="hljs-variable">!new_filename!</span>&quot; (<br>      <span class="hljs-built_in">ren</span> &quot;<span class="hljs-variable">!filename!</span>&quot; &quot;<span class="hljs-variable">!new_filename!</span>&quot;<br>    )<br>  )<br>)<br><br><span class="hljs-built_in">endlocal</span><br><br><span class="hljs-built_in">echo</span> &quot;Field <span class="hljs-variable">%old_field%</span> has been replaced with <span class="hljs-variable">%new_field%</span>!&quot;<br><span class="hljs-built_in">pause</span><br></code></pre></td></tr></table></figure><ul><li>随后Ctrl+S保存一下，关闭文本编辑器，F2重命名将.txt后缀改为.bat；</li><li>双击该Bat文件运行，根据提示输入待替换的旧字段和用以替换旧字段的新字段；</li><li>关闭DOS命令窗口，等待系统刷新或F5手动刷新。</li></ul><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>为了避免咱的代码可能出现问题，真正投入使用前当然还是要进行测试的，万一有时候没有备份又不小心把原有的文件名覆盖了，就难搞了。测试情景如图1所示。</p><img src="/posts/2026/01/05/29d9e84fb398/img1.png" class="" width="270" height="71"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 1 一键替换文件扩展名和文件名称的测试情景</div><p>一键替换文件扩展名和文件名称的测试结果分别如图2和图3所示。</p><img src="/posts/2026/01/05/29d9e84fb398/img2.png" class="" width="271" height="70"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 2 一键替换文件扩展名的测试结果</div><img src="/posts/2026/01/05/29d9e84fb398/img3.png" class="" width="269" height="71"><div style="text-align:center; color:rgba(207, 204, 204, 0.5)">图 3 一键替换文件名称的测试结果</div><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p> “@echo off”关闭bat脚本的命令显示，”setlocal enabledelayedexpansion”用于开启变量延迟扩展，开启后循环中定义的变量才能够动态更新。将用户的输入存储在变量“old_field”和”new_field”中，然后遍历当前目录下的所有文件，若文件新与旧的完整名称不同则进行重命名。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li><p>当前版本代码所运行的操作系统为Windows10，其它版本的Windows系统未经测试，为避免造成不必要的损失，建议正式使用前先测试一下；</p></li><li><p>当前版本代码只适用于修改其所在层级目录的文件，不迭代子目录，不作用于文件夹；</p></li><li><p>与bat脚本同名的文件将不会被有效作用。</p></li></ul><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#实现网络通信共享库NetShare</title>
      
      <link href="/posts/2026/01/05/ed33d8b39048/"/>
      <url>/posts/2026/01/05/ed33d8b39048/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>网络通信共享库NetShare用于保证客户端与服务器通信数据包的规范和统一，客户端与服务器共同使用本库，提升数据包序列化和反序列化的准确性和安全性，并且用于满足不同的通信数据需求。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="NetShare：DataPacket（通用数据包）"><a href="#NetShare：DataPacket（通用数据包）" class="headerlink" title="NetShare：DataPacket（通用数据包）"></a>NetShare：DataPacket（通用数据包）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">NetShare</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 通用数据包</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">KnownType(typeof(PCDataPacket)), KnownType(typeof(PSDataPacket)), KnownType(typeof(ServerDataPacket))</span>]<br>    [<span class="hljs-meta">DataContract</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataPacket</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 当前数据发送端的IPEndPoint字符串内容(ip地址:端口号)</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        [<span class="hljs-meta">DataMember</span>]<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mLocalEndPointStr;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 当前数据发送端发送的其它内容</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        [<span class="hljs-meta">DataMember</span>]<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mContent;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将当前数据包实例转换为字节数组</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字节数组<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">ToBytes</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> Array.Empty&lt;<span class="hljs-built_in">byte</span>&gt;();<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将指定的字节数组转换为DataPacket(数据包)对象</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;bytes&quot;&gt;</span>指定的字节数组<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;type&quot;&gt;</span>DataPacket派生类类型<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>DataPacket(数据包)对象或null<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataPacket <span class="hljs-title">ToObject</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, Type type</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (bytes?.Length &gt; <span class="hljs-number">0</span> &amp;&amp; type != <span class="hljs-literal">null</span> &amp;&amp; type.IsAssignableFrom(<span class="hljs-keyword">typeof</span>(DataPacket)))<br>            &#123;<br>                <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream(bytes))<br>                &#123;<br>                    DataContractSerializer serializer = <span class="hljs-keyword">new</span> DataContractSerializer(type);<br>                    <span class="hljs-built_in">object</span> obj = serializer.ReadObject(ms);<br>                    <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span> &amp;&amp; obj.GetType().Equals(type)) <span class="hljs-keyword">return</span> (DataPacket)obj;<br>                &#125;;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将指定的字节数组转换为DataPacket派生类(数据包)对象</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>DataPacket派生类类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;bytes&quot;&gt;</span>指定的字节数组<span class="hljs-doctag">&lt;/param&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>DataPacket派生类(数据包)对象或null<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">ToObject</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes</span>) <span class="hljs-keyword">where</span> T : DataPacket</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (bytes?.Length &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream(bytes))<br>                &#123;<br>                    DataContractSerializer serializer = <span class="hljs-keyword">new</span> DataContractSerializer(<span class="hljs-keyword">typeof</span>(T));<br>                    <span class="hljs-built_in">object</span> obj = serializer.ReadObject(ms);<br>                    <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span> &amp;&amp; obj <span class="hljs-keyword">is</span> T t) <span class="hljs-keyword">return</span> t;<br>                &#125;;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="NetShare：ClientDataPacket（客户端数据包）"><a href="#NetShare：ClientDataPacket（客户端数据包）" class="headerlink" title="NetShare：ClientDataPacket（客户端数据包）"></a>NetShare：ClientDataPacket（客户端数据包）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><span class="hljs-keyword">using</span> System.IO;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">NetShare</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 客户端数据包</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">DataContract</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClientDataPacket</span> : <span class="hljs-title">DataPacket</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 当前客户端的名称</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        [<span class="hljs-meta">DataMember</span>]<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mClientName;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClientDataPacket</span>()</span><br>        &#123;<br>            mLocalEndPointStr = <span class="hljs-built_in">string</span>.Empty;<br>            mContent = <span class="hljs-built_in">string</span>.Empty;<br>            mClientName = <span class="hljs-built_in">string</span>.Empty;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将客户端数据包实例转换为字节数组</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字节数组<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">ToBytes</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                DataContractSerializer serializer = <span class="hljs-keyword">new</span> DataContractSerializer(<span class="hljs-keyword">typeof</span>(ClientDataPacket));<br>                serializer.WriteObject(ms, <span class="hljs-keyword">this</span>);<br>                <span class="hljs-keyword">return</span> ms.ToArray();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 客户端数据包的字符串内容</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字符串内容<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[LocalEndPointStr:<span class="hljs-subst">&#123;mLocalEndPointStr&#125;</span>,ClientName:<span class="hljs-subst">&#123;mClientName&#125;</span>,Content:<span class="hljs-subst">&#123;mContent&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="NetShare：ServerDataPacket（服务器数据包）"><a href="#NetShare：ServerDataPacket（服务器数据包）" class="headerlink" title="NetShare：ServerDataPacket（服务器数据包）"></a>NetShare：ServerDataPacket（服务器数据包）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">NetShare</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 服务端数据包</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">DataContract</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServerDataPacket</span> : <span class="hljs-title">DataPacket</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ServerDataPacket</span>()</span><br>        &#123;<br>            mLocalEndPointStr = <span class="hljs-built_in">string</span>.Empty;<br>            mContent = <span class="hljs-built_in">string</span>.Empty;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将服务端数据包实例转换为字节数组</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字节数组<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">ToBytes</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                DataContractSerializer serializer = <span class="hljs-keyword">new</span> DataContractSerializer(<span class="hljs-keyword">typeof</span>(ServerDataPacket));<br>                serializer.WriteObject(ms, <span class="hljs-keyword">this</span>);<br>                <span class="hljs-keyword">return</span> ms.ToArray();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 服务端数据包的字符串内容</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字符串内容<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[LocalEndPointStr:<span class="hljs-subst">&#123;mLocalEndPointStr&#125;</span>,Content:<span class="hljs-subst">&#123;mContent&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="NetShare：PCDataPacket（私聊频道客户端数据包）"><a href="#NetShare：PCDataPacket（私聊频道客户端数据包）" class="headerlink" title="NetShare：PCDataPacket（私聊频道客户端数据包）"></a>NetShare：PCDataPacket（私聊频道客户端数据包）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">NetShare</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 私聊频道客户端数据包</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">DataContract</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PCDataPacket</span> : <span class="hljs-title">ClientDataPacket</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 目标客户端的名称</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        [<span class="hljs-meta">DataMember</span>]<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mDestinationClientName;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PCDataPacket</span>()</span><br>        &#123;<br>            mDestinationClientName = <span class="hljs-built_in">string</span>.Empty;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将私聊频道客户端数据包实例转换为字节数组</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字节数组<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">ToBytes</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                DataContractSerializer serializer = <span class="hljs-keyword">new</span> DataContractSerializer(<span class="hljs-keyword">typeof</span>(PCDataPacket));<br>                serializer.WriteObject(ms, <span class="hljs-keyword">this</span>);<br>                <span class="hljs-keyword">return</span> ms.ToArray();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="NetShare：PSDataPacket（私聊频道服务器数据包）"><a href="#NetShare：PSDataPacket（私聊频道服务器数据包）" class="headerlink" title="NetShare：PSDataPacket（私聊频道服务器数据包）"></a>NetShare：PSDataPacket（私聊频道服务器数据包）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">NetShare</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 私聊频道服务端数据包</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    [<span class="hljs-meta">DataContract</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PSDataPacket</span> : <span class="hljs-title">ServerDataPacket</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 已与服务器进行连接的客户端名称合集</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        [<span class="hljs-meta">DataMember</span>]<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>[] mClientNames;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PSDataPacket</span>()</span><br>        &#123;<br>            mClientNames = Array.Empty&lt;<span class="hljs-built_in">string</span>&gt;();<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 将私聊频道服务端数据包实例转换为字节数组</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>字节数组<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">ToBytes</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                DataContractSerializer serializer = <span class="hljs-keyword">new</span> DataContractSerializer(<span class="hljs-keyword">typeof</span>(PSDataPacket));<br>                serializer.WriteObject(ms, <span class="hljs-keyword">this</span>);<br>                <span class="hljs-keyword">return</span> ms.ToArray();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> 网络通信 </tag>
            
            <tag> 网络编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#实现本地服务器客户端私聊通信</title>
      
      <link href="/posts/2026/01/05/010562a4b276/"/>
      <url>/posts/2026/01/05/010562a4b276/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在游戏中我们经常能够看到玩家与玩家之间可以进行私聊，在QQ或微信中最基本的功能就是用户与用户之间的通信。抽象成计算机网络，就是两个客户端通过服务器进行私聊通信，两个客户端可以互相看到对方发送过来的信息。这种两个客户端的私聊通信是如何实现的呢？在本篇文章我们就来探讨一下。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>这个需求的重点部分在于网络通信，需要我们掌握基本的计算机网络通信知识，具体到每种编程语言又有对应的API。如果把这个需求抽象到计算机网络中，我们就可以理解成两个客户端向服务器发送信息，服务器接收信息后又把信息发送给另一个客户端。这样，一个客户端就可以接收到另一个客户端发送的信息了。</p><h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>服务器基于本地服务器开发，通过一个单独的C#控制台项目模拟，编程语言使用C#，客户端通过Unity3D构建GUI并编写客户端脚本。两个客户端则通过打开两个Unity3D项目的可执行文件进行模拟，客户端的GUI需要有调试面板、客户端名称下拉菜单、连接和断开连接按钮、消息显示面板、消息输入框和消息发送按钮等。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>由于代码中引用了自定义的网络通信共享库NetShare，关于NetShare请阅读本栏目下的“C#实现网络通信共享库NetShare”。</p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Net;<br><span class="hljs-keyword">using</span> System.Net.Sockets;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.UI;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">自定义网络通信共享库NetShare，包括通用数据包DataPacket、私聊频道服务器数据包PSDataPacket、</span><br><span class="hljs-comment">服务器数据包ServerDataPacket和私聊频道客户端数据包PCDataPacket等。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">using</span> NetShare;<br><span class="hljs-keyword">using</span> System.Threading;<br><span class="hljs-keyword">using</span> System.Linq;<br><br><span class="hljs-comment">//私聊频道客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PersonalChannelClient</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> Text BaseInfo;<span class="hljs-comment">//显示Socket连接基本信息的文本</span><br>    <span class="hljs-keyword">public</span> Text EchoContents;<span class="hljs-comment">//Socket回显信息的文本</span><br>    <span class="hljs-keyword">public</span> Text ChatContents;<span class="hljs-comment">//聊天信息的文本</span><br>    <span class="hljs-keyword">public</span> Dropdown Friends;<span class="hljs-comment">//目标客户端名称下拉菜单</span><br>    <span class="hljs-keyword">public</span> Dropdown ClientMenu;<span class="hljs-comment">//客户端名称下拉菜单</span><br>    <span class="hljs-keyword">public</span> Button Connect;<span class="hljs-comment">//连接按钮</span><br>    <span class="hljs-keyword">public</span> Button DisConnect;<span class="hljs-comment">//断开连接按钮</span><br>    <span class="hljs-keyword">public</span> InputField SendInput;<span class="hljs-comment">//聊天消息输入框</span><br>    <span class="hljs-keyword">public</span> Button Send;<span class="hljs-comment">//聊天信息发送按钮</span><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> ipAddressStr;<span class="hljs-comment">//IP地址字符串</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> port;<span class="hljs-comment">//端口</span><br>    <span class="hljs-keyword">static</span> IPAddress iPAddress;<span class="hljs-comment">//IP地址对象</span><br>    <span class="hljs-keyword">static</span> IPEndPoint iPEndPoint;<span class="hljs-comment">//IP端点对象</span><br>    <span class="hljs-built_in">string</span> clientName, sendStr;<span class="hljs-comment">//客户端名称和发送信息字符串</span><br>    Socket currentClientSocket;<span class="hljs-comment">//当前客户端Socket</span><br>    <span class="hljs-built_in">bool</span> isLockSend;<span class="hljs-comment">//是否锁定聊天信息发送按钮</span><br>    <span class="hljs-built_in">byte</span>[] buffer;<span class="hljs-comment">//消息接收缓冲区</span><br>    Queue&lt;<span class="hljs-built_in">string</span>&gt; echoContentQueue, chatContentQueue;<span class="hljs-comment">//回显信息队列和聊天信息队列</span><br>    PCDataPacket dataPacket;<span class="hljs-comment">//通用数据包</span><br>    List&lt;<span class="hljs-built_in">string</span>&gt; desClientNames;<span class="hljs-comment">//目标客户端名称合集</span><br><br>    <span class="hljs-comment">//反映Socket是否与服务器有效连接的属性</span><br>    <span class="hljs-built_in">bool</span> isConnected<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (currentClientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">return</span> !currentClientSocket.Poll(<span class="hljs-number">10</span>, SelectMode.SelectRead) &amp;&amp; currentClientSocket.Connected;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        <span class="hljs-comment">//初始化</span><br>        ipAddressStr = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>        clientName = ClientMenu.options.Count &gt; <span class="hljs-number">0</span> ? ClientMenu.options[<span class="hljs-number">0</span>].text : <span class="hljs-string">&quot;&quot;</span>;<br>        port = <span class="hljs-number">5500</span>;<br>        iPAddress = IPAddress.Parse(ipAddressStr);<br>        iPEndPoint = <span class="hljs-keyword">new</span> IPEndPoint(iPAddress, port);<br>        buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>        echoContentQueue = <span class="hljs-keyword">new</span> Queue&lt;<span class="hljs-built_in">string</span>&gt;();<br>        chatContentQueue = <span class="hljs-keyword">new</span> Queue&lt;<span class="hljs-built_in">string</span>&gt;();<br>        desClientNames = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;() &#123; <span class="hljs-string">&quot;None&quot;</span> &#125;;<br><br>        <span class="hljs-comment">//为UI控件添加监听事件</span><br>        ClientMenu.onValueChanged.AddListener((index) =&gt;<br>        &#123;<br>            clientName = ClientMenu.options[index].text;<br>        &#125;);<br>        Connect.onClick.AddListener(() =&gt;<br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(ConnectDeal));<br>            thread.Start();<br>        &#125;);<br>        DisConnect.onClick.AddListener(() =&gt;<br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(DisConnectDeal));<br>            thread.Start();<br>        &#125;);<br>        Send.onClick.AddListener(() =&gt;<br>        &#123;<br>            sendStr = SendInput.text;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(SendDeal));<br>            thread.Start();<br>            SendInput.text = <span class="hljs-built_in">string</span>.Empty;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>    &#123;<br>        <span class="hljs-comment">//不断更新Socket基本信息</span><br>        BaseInfo.text = <span class="hljs-string">$&quot;ClientName:<span class="hljs-subst">&#123;clientName&#125;</span>&quot;</span> +<br>                        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;\nSocketHashCode:&#123;0&#125;&quot;</span>, currentClientSocket == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;None&quot;</span> : currentClientSocket.GetHashCode().ToString()) +<br>                        <span class="hljs-string">$&quot;\nisLock:<span class="hljs-subst">&#123;isLockSend&#125;</span>&quot;</span> +<br>                        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;\nPoll:&#123;0&#125;&quot;</span>, currentClientSocket == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;None&quot;</span> : (!currentClientSocket.Poll(<span class="hljs-number">10</span>, SelectMode.SelectRead)).ToString()) +<br>                        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;\nIsConnected:&#123;0&#125;&quot;</span>, currentClientSocket == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;False&quot;</span> : currentClientSocket.Connected.ToString());<br>        <span class="hljs-comment">//更新回显信息</span><br>        <span class="hljs-keyword">if</span> (echoContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">while</span> (echoContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                SetEchoContents(echoContentQueue.Dequeue());<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//更新聊天信息</span><br>        <span class="hljs-keyword">if</span> (chatContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">while</span> (chatContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                SetChatContents(chatContentQueue.Dequeue());<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//更新目标客户端名称下拉菜单</span><br>        <span class="hljs-keyword">if</span> (desClientNames?.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            Friends.AddOptions(desClientNames);<br>            desClientNames.Clear();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//设置回显信息相关UI的内容</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetEchoContents</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span><br>    &#123;<br>        EchoContents.text += text;<br>    &#125;<br><br>    <span class="hljs-comment">//设置聊天信息相关UI的内容</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetChatContents</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span><br>    &#123;<br>        ChatContents.text += text;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步连接处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ConnectDeal</span>()</span><br>    &#123;<br>        echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>正在请求服务器连接...&quot;</span>);<br>        Socket clientSocket = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<br>        clientSocket.BeginConnect(iPEndPoint, ConnectCallback, clientSocket);<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步断开连接处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisConnectDeal</span>()</span><br>    &#123;<br>        echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>正在断开与服务器的连接...&quot;</span>);<br>        <span class="hljs-keyword">if</span> (isConnected)<br>        &#123;<br>            currentClientSocket.Shutdown(SocketShutdown.Both);<br>            currentClientSocket.BeginDisconnect(<span class="hljs-literal">false</span>, DisConnectCallback, currentClientSocket);<br>        &#125;<br>        <span class="hljs-keyword">else</span> echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>未与服务器建立连接,无法进行断开连接的操作...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步接收信息处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveDeal</span>()</span><br>    &#123;<br>        echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>开始监听服务器响应...&quot;</span>);<br>        currentClientSocket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, currentClientSocket);<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步发送信息处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendDeal</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!isLockSend &amp;&amp; !<span class="hljs-built_in">string</span>.IsNullOrEmpty(sendStr))<br>        &#123;<br>            dataPacket.mContent = sendStr;<br>            <span class="hljs-built_in">string</span> v_desClientName = Friends.options[Friends.<span class="hljs-keyword">value</span>].text;<br>            <span class="hljs-keyword">if</span> (!v_desClientName.Equals(<span class="hljs-string">&quot;None&quot;</span>)) dataPacket.mDestinationClientName = v_desClientName;<br>            <span class="hljs-built_in">byte</span>[] bytes = dataPacket.ToBytes();<br>            currentClientSocket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, currentClientSocket);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步连接处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ConnectCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            socket.EndConnect(ar);<br>            currentClientSocket = socket;<br>            <span class="hljs-keyword">if</span> (isConnected)<br>            &#123;<br>                dataPacket = <span class="hljs-keyword">new</span> PCDataPacket()<br>                &#123;<br>                    mLocalEndPointStr = socket.LocalEndPoint.ToString(),<br>                    mClientName = clientName,<br>                    mDestinationClientName = <span class="hljs-built_in">string</span>.Empty,<br>                    mContent = <span class="hljs-string">$&quot;成功与服务器建立连接!&quot;</span><br>                &#125;;<br>                <span class="hljs-built_in">byte</span>[] bytes = dataPacket.ToBytes();<br>                socket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, currentClientSocket);<br>                isLockSend = <span class="hljs-literal">false</span>;<br>                echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=orange&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器连接成功!&lt;/color&gt;&quot;</span>);<br>                ReceiveDeal();<br>            &#125;<br>            <span class="hljs-keyword">else</span> echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=red&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器连接失败!&lt;/color&gt;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=red&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器连接失败!&lt;/color&gt;\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步断开连接处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisConnectCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            isLockSend = <span class="hljs-literal">true</span>;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            socket.EndDisconnect(ar);<br>            dataPacket = <span class="hljs-literal">null</span>;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=orange&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器断开连接操作成功!&lt;/color&gt;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器断开连接操作失败！\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步发送信息处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            socket.EndSend(ar);<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>向服务器发送了一条消息！&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>向服务器发送信息操作失败！\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步接收信息处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            <span class="hljs-built_in">int</span> count = socket.EndReceive(ar);<br>            DataPacket dataPacket = DataPacket.ToObject&lt;DataPacket&gt;(buffer.Take(count).ToArray());<br>            <span class="hljs-keyword">if</span> (dataPacket <span class="hljs-keyword">is</span> PSDataPacket psdp &amp;&amp; psdp.mClientNames?.Length &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                desClientNames.Clear();<br>                <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> name <span class="hljs-keyword">in</span> psdp.mClientNames)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (Friends.options.FindIndex((od) =&gt; od.text.Equals(name)) == <span class="hljs-number">-1</span>) desClientNames.Add(name);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dataPacket <span class="hljs-keyword">is</span> ServerDataPacket sdp)<br>            &#123;<br>                <span class="hljs-built_in">string</span> v_res = sdp.mContent;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(v_res)) chatContentQueue.Enqueue(<span class="hljs-string">&quot;\n&quot;</span> + v_res);<br>            &#125;<br>            <span class="hljs-comment">//若Socket连接有效则继续接收消息</span><br>            <span class="hljs-keyword">if</span> (isConnected)<br>                socket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, socket);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>接收服务器消息失败！\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Net.Sockets;<br><span class="hljs-keyword">using</span> System.Net;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">自定义网络通信共享库NetShare，其中包括了私聊频道服务器数据包PSDataPacket、通用数据包DataPacket、</span><br><span class="hljs-comment">服务器数据包ServerDataPacket和私聊频道客户端数据包PCDataPacket等。</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">using</span> NetShare;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">UnityServer</span><br>&#123;<br>    <span class="hljs-comment">//私聊频道服务器</span><br>    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PersonalChannelServer</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> ipAddress = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<span class="hljs-comment">//IP地址字符串</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> port = <span class="hljs-number">5500</span>;<span class="hljs-comment">//端口</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> maxConnect = <span class="hljs-number">20</span>;<span class="hljs-comment">//最大连接数</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<span class="hljs-comment">//消息缓冲区</span><br><br>        <span class="hljs-comment">//客户端Socket合集，key为IPEndPoint字符串，value为服务器为客户端分配的Socket</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>, Socket&gt; clients = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, Socket&gt;();<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket? serverSocket;<span class="hljs-comment">//服务器Socket</span><br><br>        <span class="hljs-comment">//客户端键值对，key为客户端名称，value为IPEndPoint字符串</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; clientKVs = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] <span class="hljs-keyword">args</span></span>)</span><br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(ServerDeal));<br>            thread.Start();<br>            Console.ReadLine();<br>        &#125;<br><br>        <span class="hljs-comment">//判断Socket是否进行有效连接</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsConnected</span>(<span class="hljs-params">Socket socket</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (socket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">return</span> !socket.Poll(<span class="hljs-number">10</span>, SelectMode.SelectRead) &amp;&amp; socket.Connected;<br>        &#125;<br><br>        <span class="hljs-comment">//执行逻辑：服务器处理</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ServerDeal</span>()</span><br>        &#123;<br>            serverSocket = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<br>            IPAddress v_ipAddress = IPAddress.Parse(ipAddress);<br>            serverSocket.Bind(<span class="hljs-keyword">new</span> IPEndPoint(v_ipAddress, port));<br>            serverSocket.Listen(maxConnect);<br>            Console.WriteLine(<span class="hljs-string">$&quot;开启服务器[<span class="hljs-subst">&#123;serverSocket.LocalEndPoint&#125;</span>]...&quot;</span>);<br><br>            serverSocket.BeginAccept(AcceptCallback, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//执行逻辑：Socket异步接收消息</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveDeal</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? clientSocket</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;********************&quot;</span>);<br>            <span class="hljs-keyword">if</span> (clientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            Socket? v_clientSocket = clientSocket <span class="hljs-keyword">as</span> Socket;<br>            <span class="hljs-keyword">if</span> (v_clientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            Console.WriteLine(<span class="hljs-string">&quot;接收到客户端的连接请求！&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> (IsConnected(v_clientSocket))<br>                v_clientSocket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, v_clientSocket);<br>        &#125;<br><br>        <span class="hljs-comment">//添加客户端Socket到客户端Socket合集</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddClient</span>(<span class="hljs-params">Socket clientSocket</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (clientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            EndPoint? endPoint = clientSocket.RemoteEndPoint;<br>            <span class="hljs-keyword">if</span> (endPoint != <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-built_in">string</span>? v_endPointStr = endPoint.ToString();<br>                <span class="hljs-keyword">if</span> (v_endPointStr != <span class="hljs-literal">null</span>) clients[v_endPointStr] = clientSocket;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//向所有客户端发送指定信息</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendToAll</span>(<span class="hljs-params">PSDataPacket dataPacket</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (dataPacket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            <span class="hljs-built_in">byte</span>[] bytes = dataPacket.ToBytes();<br>            <span class="hljs-keyword">foreach</span> (Socket clientSocket <span class="hljs-keyword">in</span> clients.Values)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (IsConnected(clientSocket))<br>                &#123;<br>                    Thread thread = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>                    &#123;<br>                        clientSocket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, clientSocket);<br>                    &#125;);<br>                    thread.Start();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//向指定的客户端发送服务器数据包</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendTo</span>(<span class="hljs-params">ServerDataPacket dataPacket, Socket? destinationSocket</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (dataPacket == <span class="hljs-literal">null</span> || destinationSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            <span class="hljs-built_in">byte</span>[] bytes = dataPacket.ToBytes();<br>            <span class="hljs-keyword">if</span> (IsConnected(destinationSocket))<br>            &#123;<br>                Thread thread = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>                &#123;<br>                    destinationSocket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, destinationSocket);<br>                &#125;);<br>                thread.Start();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//Socket监听请求回调</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AcceptCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (serverSocket != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    Socket clientSocket = serverSocket.EndAccept(ar);<br>                    AddClient(clientSocket);<br>                    Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ParameterizedThreadStart(ReceiveDeal));<br>                    thread.Start(clientSocket);<br>                    serverSocket.BeginAccept(AcceptCallback, <span class="hljs-literal">null</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (SocketException se)<br>            &#123;<br>                Console.WriteLine(<span class="hljs-string">&quot;AcceptException:&quot;</span> + se.Message);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//Socket发送信息回调</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                Socket? clientSocket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>                <span class="hljs-keyword">if</span> (clientSocket != <span class="hljs-literal">null</span>) clientSocket.EndSend(ar);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (SocketException se)<br>            &#123;<br>                Console.WriteLine(<span class="hljs-string">&quot;SendException:&quot;</span> + se.Message);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//Socket接收信息回调</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                Socket? clientSocket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>                <span class="hljs-keyword">if</span> (clientSocket != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    <span class="hljs-built_in">int</span> bytesCount = clientSocket.EndReceive(ar);<br>                    PCDataPacket? dataPacket = DataPacket.ToObject&lt;PCDataPacket&gt;(buffer.Take(bytesCount).ToArray());<br>                    <span class="hljs-keyword">if</span> (dataPacket != <span class="hljs-literal">null</span>)<br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (clientSocket.RemoteEndPoint != <span class="hljs-literal">null</span>)<br>                        &#123;<br>                            <span class="hljs-built_in">string</span>? v_endPointStr = clientSocket.RemoteEndPoint.ToString();<br>                            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(v_endPointStr))<br>                            &#123;<br>                                clientKVs[dataPacket.mClientName] = v_endPointStr;<br>                                SendToAll(<span class="hljs-keyword">new</span> PSDataPacket()<br>                                &#123;<br>                                    mClientNames = clientKVs.Keys.ToArray()<br>                                &#125;);<br>                            &#125;<br>                        &#125;<br>                        <span class="hljs-built_in">string</span> v_content = <span class="hljs-string">$&quot;客户端<span class="hljs-subst">&#123;dataPacket.mClientName&#125;</span>：<span class="hljs-subst">&#123;dataPacket.mContent&#125;</span>&quot;</span>;<br>                        Socket? destinationSocket;<br>                        <span class="hljs-built_in">string</span>? endPointStr;<br>                        clientKVs.TryGetValue(dataPacket.mDestinationClientName, <span class="hljs-keyword">out</span> endPointStr);<br>                        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(endPointStr) &amp;&amp; clients.TryGetValue(endPointStr, <span class="hljs-keyword">out</span> destinationSocket))<br>                            SendTo(<span class="hljs-keyword">new</span> ServerDataPacket() &#123; mContent = v_content &#125;, destinationSocket);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (IsConnected(clientSocket))<br>                        clientSocket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, clientSocket);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (SocketException se)<br>            &#123;<br>                Console.WriteLine(<span class="hljs-string">&quot;ReceiveException:&quot;</span> + se.Message);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>测试流程大概是先启动服务器，然后启动三个客户端，三个客户端分别以A、B、C的名称作为客户端名称与服务器建立连接，连接后再由客户端A、B、C分别向服务器发送信息，通过观察三个客户端的消息面板来确定测试结果，这里之所以启动三个客户端是为了进行对比测试，以区分多客户端的同频道通信，具体测试流程请观看下列视频：</p><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115840972229036&bvid=BV1o1isBsEiV&cid=35199716897&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在服务器端，我们通过一个C#控制台项目来模拟服务器后台，服务器与客户端具有类似的功能，同样具有发送、接收消息的功能，不同的是服务器具有监听客户端连接的功能，而客户端具有向服务器发送连接请求的功能，本质上这些都是通过Socket实现的功能，人为划分成服务器端和客户端。在客户端我们通过GUI将用户的操作进行可视化构建，实现了回显、客户端名称选择、连接、断开连接、发送和显示消息等基本交互。</p><p>为了模拟多客户端并发操作，所有功能我们都采用了异步的方式启动，对于真正的网络通信而言，这对我们来说才刚刚开始，不过通过这个案例也让我们了解了基本的网络通信流程。</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> 网络通信 </tag>
            
            <tag> 网络编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#实现本地服务器多客户端同频道通信</title>
      
      <link href="/posts/2026/01/05/2933d34f692f/"/>
      <url>/posts/2026/01/05/2933d34f692f/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在游戏中我们经常能够看到玩家在世界频道聊天，在QQ或微信中也有群聊功能。抽象成计算机网络，就是多个客户端通过服务器进行同频道通信，所有连接的客户端都可以看到其他客户端发送的消息。这种多客户端同频道通信是如何实现的呢？在本篇文章我们就来探讨一下。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>这个需求的重点部分在于网络通信，需要我们掌握基本的计算机网络通信知识，具体到每种编程语言又有对应的API。如果把这个需求抽象到计算机网络中，我们就可以理解成多个客户端向服务器发送信息，服务器接收信息后又把信息发送给所有连接的客户端。这样，在各个客户端就可以接收到其他客户端发送的信息了。</p><h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>服务器基于本地服务器开发，通过一个单独的C#控制台项目模拟，编程语言使用C#，客户端通过Unity3D构建GUI并编写客户端脚本。多客户端则通过打开多个Unity3D项目的可执行文件进行模拟，客户端的GUI需要有调试面板、客户端名称下拉菜单、连接和断开连接按钮、消息显示面板、消息输入框和消息发送按钮等。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>​由于代码中引用了自定义的网络通信共享库NetShare，关于NetShare请阅读本栏目下的“C#实现网络通信共享库NetShare”。</p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Net;<br><span class="hljs-keyword">using</span> System.Net.Sockets;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.UI;<br><span class="hljs-keyword">using</span> NetShare;<span class="hljs-comment">//自定义网络通信共享库，包括通用数据包DataPacket等</span><br><span class="hljs-keyword">using</span> System.Threading;<br><br><span class="hljs-comment">//世界频道客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WorldChannelClient</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> Text BaseInfo;<span class="hljs-comment">//显示Socket连接基本信息的文本</span><br>    <span class="hljs-keyword">public</span> Text EchoContents;<span class="hljs-comment">//Socket回显信息的文本</span><br>    <span class="hljs-keyword">public</span> Text ChatContents;<span class="hljs-comment">//聊天信息的文本</span><br>    <span class="hljs-keyword">public</span> Dropdown ClientMenu;<span class="hljs-comment">//客户端名称下拉菜单</span><br>    <span class="hljs-keyword">public</span> Button Connect;<span class="hljs-comment">//连接按钮</span><br>    <span class="hljs-keyword">public</span> Button DisConnect;<span class="hljs-comment">//断开连接按钮</span><br>    <span class="hljs-keyword">public</span> InputField SendInput;<span class="hljs-comment">//聊天消息输入框</span><br>    <span class="hljs-keyword">public</span> Button Send;<span class="hljs-comment">//聊天信息发送按钮</span><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> ipAddressStr;<span class="hljs-comment">//IP地址字符串</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> port;<span class="hljs-comment">//端口</span><br>    <span class="hljs-keyword">static</span> IPAddress iPAddress;<span class="hljs-comment">//IP地址对象</span><br>    <span class="hljs-keyword">static</span> IPEndPoint iPEndPoint;<span class="hljs-comment">//IP端点对象</span><br>    <span class="hljs-built_in">string</span> clientName;<span class="hljs-comment">//客户端名称</span><br>    Socket currentClientSocket;<span class="hljs-comment">//当前客户端Socket</span><br>    <span class="hljs-built_in">bool</span> isLockSend;<span class="hljs-comment">//是否锁定聊天信息发送按钮</span><br>    <span class="hljs-built_in">byte</span>[] buffer;<span class="hljs-comment">//消息接收缓冲区</span><br>    Queue&lt;<span class="hljs-built_in">string</span>&gt; echoContentQueue, chatContentQueue;<span class="hljs-comment">//回显信息队列和聊天信息队列</span><br>    DataPacket dataPacket;<span class="hljs-comment">//通用数据包</span><br><br>    <span class="hljs-comment">//反映Socket是否与服务器有效连接的属性</span><br>    <span class="hljs-built_in">bool</span> isConnected<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (currentClientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">return</span> !currentClientSocket.Poll(<span class="hljs-number">10</span>, SelectMode.SelectRead) &amp;&amp; currentClientSocket.Connected;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        <span class="hljs-comment">//初始化</span><br>        ipAddressStr = <span class="hljs-string">&quot;8.137.8.206&quot;</span>;<br>        clientName = ClientMenu.options.Count &gt; <span class="hljs-number">0</span> ? ClientMenu.options[<span class="hljs-number">0</span>].text : <span class="hljs-string">&quot;&quot;</span>;<br>        port = <span class="hljs-number">5500</span>;<br>        iPAddress = IPAddress.Parse(ipAddressStr);<br>        iPEndPoint = <span class="hljs-keyword">new</span> IPEndPoint(iPAddress, port);<br>        buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>        echoContentQueue = <span class="hljs-keyword">new</span> Queue&lt;<span class="hljs-built_in">string</span>&gt;();<br>        chatContentQueue = <span class="hljs-keyword">new</span> Queue&lt;<span class="hljs-built_in">string</span>&gt;();<br><br>        <span class="hljs-comment">//为UI控件添加监听事件</span><br>        ClientMenu.onValueChanged.AddListener((index) =&gt;<br>        &#123;<br>            clientName = ClientMenu.options[index].text;<br>        &#125;);<br>        Connect.onClick.AddListener(() =&gt;<br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(ConnectDeal));<br>            thread.Start();<br>        &#125;);<br>        DisConnect.onClick.AddListener(() =&gt;<br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(DisConnectDeal));<br>            thread.Start();<br>        &#125;);<br>        Send.onClick.AddListener(() =&gt;<br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(SendDeal));<br>            thread.Start();<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>    &#123;<br>        <span class="hljs-comment">//不断更新Socket基本信息</span><br>        BaseInfo.text = <span class="hljs-string">$&quot;ClientName:<span class="hljs-subst">&#123;clientName&#125;</span>&quot;</span> +<br>                        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;\nSocketHashCode:&#123;0&#125;&quot;</span>, currentClientSocket == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;None&quot;</span> : currentClientSocket.GetHashCode().ToString()) +<br>                        <span class="hljs-string">$&quot;\nisLock:<span class="hljs-subst">&#123;isLockSend&#125;</span>&quot;</span> +<br>                        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;\nPoll:&#123;0&#125;&quot;</span>, currentClientSocket == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;None&quot;</span> : (!currentClientSocket.Poll(<span class="hljs-number">10</span>, SelectMode.SelectRead)).ToString()) +<br>                        <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;\nIsConnected:&#123;0&#125;&quot;</span>, currentClientSocket == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;False&quot;</span> : currentClientSocket.Connected.ToString());<br>        <span class="hljs-comment">//更新回显信息</span><br>        <span class="hljs-keyword">if</span> (echoContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">while</span> (echoContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                SetEchoContents(echoContentQueue.Dequeue());<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//更新聊天信息</span><br>        <span class="hljs-keyword">if</span> (chatContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">while</span> (chatContentQueue.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                SetChatContents(chatContentQueue.Dequeue());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//设置回显信息相关UI的内容</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetEchoContents</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span><br>    &#123;<br>        EchoContents.text += text;<br>    &#125;<br><br>    <span class="hljs-comment">//设置聊天信息相关UI的内容</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetChatContents</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> text</span>)</span><br>    &#123;<br>        ChatContents.text += text;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步连接处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ConnectDeal</span>()</span><br>    &#123;<br>        echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>正在请求服务器连接...&quot;</span>);<br>        Socket clientSocket = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<br>        clientSocket.BeginConnect(iPEndPoint, ConnectCallback, clientSocket);<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步断开连接处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisConnectDeal</span>()</span><br>    &#123;<br>        echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>正在断开与服务器的连接...&quot;</span>);<br>        <span class="hljs-keyword">if</span> (isConnected)<br>        &#123;<br>            currentClientSocket.Shutdown(SocketShutdown.Both);<span class="hljs-comment">//关闭Socket的发送和接收消息功能</span><br>            currentClientSocket.BeginDisconnect(<span class="hljs-literal">false</span>, DisConnectCallback, currentClientSocket);<br>        &#125;<br>        <span class="hljs-keyword">else</span> echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>未与服务器建立连接,无法进行断开连接的操作...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步接收信息处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveDeal</span>()</span><br>    &#123;<br>        echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>开始监听服务器响应...&quot;</span>);<br>        currentClientSocket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, currentClientSocket);<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步发送信息处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendDeal</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!isLockSend &amp;&amp; !<span class="hljs-built_in">string</span>.IsNullOrEmpty(SendInput.text))<br>        &#123;<br>            dataPacket.mContent = SendInput.text;<br>            SendInput.text = <span class="hljs-built_in">string</span>.Empty;<br>            <span class="hljs-built_in">byte</span>[] bytes = dataPacket.ToBytes();<br>            currentClientSocket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, currentClientSocket);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步连接处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ConnectCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            socket.EndConnect(ar);<br>            currentClientSocket = socket;<br>            <span class="hljs-keyword">if</span> (isConnected)<br>            &#123;<br>                dataPacket = <span class="hljs-keyword">new</span> ClientDataPacket()<br>                &#123;<br>                    mLocalEndPointStr = socket.LocalEndPoint.ToString(),<br>                    mClientName = clientName<br>                &#125;;<br>                isLockSend = <span class="hljs-literal">false</span>;<br>                echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=orange&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器连接成功!&lt;/color&gt;&quot;</span>);<br>                ReceiveDeal();<br>            &#125;<br>            <span class="hljs-keyword">else</span> echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=red&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器连接失败!&lt;/color&gt;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=red&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器连接失败!&lt;/color&gt;\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步断开连接处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisConnectCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            isLockSend = <span class="hljs-literal">true</span>;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            socket.EndDisconnect(ar);<br>            dataPacket = <span class="hljs-literal">null</span>;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n&lt;color=orange&gt;客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器断开连接操作成功!&lt;/color&gt;&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>与服务器断开连接操作失败！\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步发送信息处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            socket.EndSend(ar);<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>向服务器发送了一条消息！&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>向服务器发送信息操作失败！\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//执行逻辑：Socket异步接收信息处理回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Socket socket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>            <span class="hljs-built_in">int</span> count = socket.EndReceive(ar);<br>            <span class="hljs-built_in">string</span> res = Encoding.UTF8.GetString(buffer, <span class="hljs-number">0</span>, count);<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(res)) chatContentQueue.Enqueue(<span class="hljs-string">&quot;\n&quot;</span> + res);<br>            <span class="hljs-comment">//若Socket连接有效则继续接收消息</span><br>            <span class="hljs-keyword">if</span> (isConnected)<br>                socket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, socket);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException se)<br>        &#123;<br>            echoContentQueue.Enqueue(<span class="hljs-string">$&quot;\n客户端<span class="hljs-subst">&#123;clientName&#125;</span>接收服务器消息失败！\n错误信息:<span class="hljs-subst">&#123;se.Message&#125;</span>&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Net.Sockets;<br><span class="hljs-keyword">using</span> System.Net;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> NetShare;<span class="hljs-comment">//自定义网络通信共享库，其中包括了通用数据包DataPacket、客户端数据包ClientDataPacket等</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">UnityServer</span><br>&#123;<br>    <span class="hljs-comment">//世界频道服务器</span><br>    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WorldChannelServer</span><br>    &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> ipAddressStr = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<span class="hljs-comment">//IP地址字符串</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> port = <span class="hljs-number">5500</span>;<span class="hljs-comment">//端口</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> maxConnectCount = <span class="hljs-number">20</span>;<span class="hljs-comment">//最大连接数</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<span class="hljs-comment">//消息缓冲区</span><br><br>        <span class="hljs-comment">//客户端Socket合集，key为IPEndPoint字符串，value为服务器为客户端分配的Socket</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>, Socket&gt; clients = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, Socket&gt;();<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket? serverSocket;<span class="hljs-comment">//服务器Socket</span><br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] <span class="hljs-keyword">args</span></span>)</span><br>        &#123;<br>            Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ThreadStart(ServerDeal));<br>            thread.Start();<br>            Console.ReadLine();<br>        &#125;<br><br>        <span class="hljs-comment">//判断Socket是否进行有效连接</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsConnected</span>(<span class="hljs-params">Socket socket</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (socket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">return</span> !socket.Poll(<span class="hljs-number">10</span>, SelectMode.SelectRead) &amp;&amp; socket.Connected;<br>        &#125;<br><br>        <span class="hljs-comment">//执行逻辑：服务器处理</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ServerDeal</span>()</span><br>        &#123;<br>            serverSocket = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<br>            IPAddress v_ipAddress = IPAddress.Parse(ipAddressStr);<br>            serverSocket.Bind(<span class="hljs-keyword">new</span> IPEndPoint(v_ipAddress, port));<br>            serverSocket.Listen(maxConnectCount);<br>            Console.WriteLine(<span class="hljs-string">$&quot;开启服务器[<span class="hljs-subst">&#123;serverSocket.LocalEndPoint&#125;</span>]...&quot;</span>);<br><br>            serverSocket.BeginAccept(AcceptCallback, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//执行逻辑：Socket异步接收消息</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveDeal</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? clientSocket</span>)</span><br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot;********************&quot;</span>);<br>            <span class="hljs-keyword">if</span> (clientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            Socket? v_clientSocket = clientSocket <span class="hljs-keyword">as</span> Socket;<br>            <span class="hljs-keyword">if</span> (v_clientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            Console.WriteLine(<span class="hljs-string">&quot;接收到客户端的连接请求！&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> (IsConnected(v_clientSocket))<br>                v_clientSocket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, v_clientSocket);<br>        &#125;<br><br>        <span class="hljs-comment">//添加客户端Socket到客户端Socket合集</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddClient</span>(<span class="hljs-params">Socket clientSocket</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (clientSocket == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            EndPoint? endPoint = clientSocket.RemoteEndPoint;<br>            <span class="hljs-keyword">if</span> (endPoint != <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-built_in">string</span>? v_endPointStr = endPoint.ToString();<br>                <span class="hljs-keyword">if</span> (v_endPointStr != <span class="hljs-literal">null</span>) clients[v_endPointStr] = clientSocket;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//向所有客户端发送指定信息</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendToAll</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>? content</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(content)) <span class="hljs-keyword">return</span>;<br>            <span class="hljs-built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(content);<br>            <span class="hljs-keyword">foreach</span> (Socket clientSocket <span class="hljs-keyword">in</span> clients.Values)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (IsConnected(clientSocket))<br>                &#123;<br>                    Thread thread = <span class="hljs-keyword">new</span> Thread(() =&gt;<br>                    &#123;<br>                        clientSocket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, clientSocket);<br>                    &#125;);<br>                    thread.Start();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//Socket监听请求回调</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AcceptCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (serverSocket != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    Socket clientSocket = serverSocket.EndAccept(ar);<br>                    AddClient(clientSocket);<br>                    Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ParameterizedThreadStart(ReceiveDeal));<br>                    thread.Start(clientSocket);<br>                    serverSocket.BeginAccept(AcceptCallback, <span class="hljs-literal">null</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (SocketException se)<br>            &#123;<br>                Console.WriteLine(<span class="hljs-string">&quot;AcceptException:&quot;</span> + se.Message);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//Socket发送信息回调</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                Socket? clientSocket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>                <span class="hljs-keyword">if</span> (clientSocket != <span class="hljs-literal">null</span>) clientSocket.EndSend(ar);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (SocketException se)<br>            &#123;<br>                Console.WriteLine(<span class="hljs-string">&quot;SendException:&quot;</span> + se.Message);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//Socket接收信息回调</span><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveCallback</span>(<span class="hljs-params">IAsyncResult ar</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                Socket? clientSocket = ar.AsyncState <span class="hljs-keyword">as</span> Socket;<br>                <span class="hljs-keyword">if</span> (clientSocket != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    <span class="hljs-built_in">int</span> bytesCount = clientSocket.EndReceive(ar);<br>                    ClientDataPacket? dataPacket = DataPacket.ToObject&lt;ClientDataPacket&gt;(buffer.Take(bytesCount).ToArray());<br>                    <span class="hljs-keyword">if</span> (dataPacket != <span class="hljs-literal">null</span>)<br>                    &#123;<br>                        <span class="hljs-built_in">string</span> v_content = <span class="hljs-string">$&quot;客户端<span class="hljs-subst">&#123;dataPacket.mClientName&#125;</span>：<span class="hljs-subst">&#123;dataPacket.mContent&#125;</span>&quot;</span>;<br>                        SendToAll(v_content);<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (IsConnected(clientSocket))<br>                        clientSocket.BeginReceive(buffer, <span class="hljs-number">0</span>, buffer.Length, SocketFlags.None, ReceiveCallback, clientSocket);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (SocketException se)<br>            &#123;<br>                Console.WriteLine(<span class="hljs-string">&quot;ReceiveException:&quot;</span> + se.Message);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>测试流程大概是先启动服务器，然后启动三个客户端，三个客户端分别以A、B、C的名称作为客户端名称与服务器建立连接，连接后再由客户端A、B、C分别向服务器发送信息，通过观察三个客户端的消息面板来确定测试结果，具体测试流程请观看下列视频：</p><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115840972228954&bvid=BV1o1isBsEiW&cid=35199714198&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在服务器端，我们通过一个C#控制台项目来模拟服务器后台，服务器与客户端具有类似的功能，同样具有发送、接收消息的功能，不同的是服务器具有监听客户端连接的功能，而客户端具有向服务器发送连接请求的功能，本质上这些都是通过Socket实现的功能，人为划分成服务器端和客户端。在客户端我们通过GUI将用户的操作进行可视化构建，实现了回显、客户端名称选择、连接、断开连接、发送和显示消息等基本交互。</p><p>为了模拟多客户端并发操作，所有功能我们都采用了异步的方式启动，对于真正的网络通信而言，这对我们来说才刚刚开始，不过通过这个案例也让我们了解了基本的网络通信流程。</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> 网络通信 </tag>
            
            <tag> 网络编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>自定义C#类库（.dll文件）</title>
      
      <link href="/posts/2026/01/04/7ab6c8858e88/"/>
      <url>/posts/2026/01/04/7ab6c8858e88/</url>
      
        <content type="html"><![CDATA[<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>操作系统：Windows 10</p><p>开发工具：Visual Studio 2022</p><p>.Net桌面开发环境：</p><img src="/posts/2026/01/04/7ab6c8858e88/img1.png" class="" width="405" height="96"><h2 id="开发步骤"><a href="#开发步骤" class="headerlink" title="开发步骤"></a>开发步骤</h2><h3 id="创建C-类库项目"><a href="#创建C-类库项目" class="headerlink" title="创建C#类库项目"></a>创建C#类库项目</h3><img src="/posts/2026/01/04/7ab6c8858e88/img2.png" class="" width="1012" height="672"><h3 id="配置项目名称和项目路径"><a href="#配置项目名称和项目路径" class="headerlink" title="配置项目名称和项目路径"></a>配置项目名称和项目路径</h3><img src="/posts/2026/01/04/7ab6c8858e88/img3.png" class="" width="995" height="649"><h3 id="选择所使用的框架，完成项目创建"><a href="#选择所使用的框架，完成项目创建" class="headerlink" title="选择所使用的框架，完成项目创建"></a>选择所使用的框架，完成项目创建</h3><img src="/posts/2026/01/04/7ab6c8858e88/img4.png" class="" width="988" height="632"><h3 id="创建代码文件，并完成依赖项导入、代码编写以及代码注释"><a href="#创建代码文件，并完成依赖项导入、代码编写以及代码注释" class="headerlink" title="创建代码文件，并完成依赖项导入、代码编写以及代码注释"></a>创建代码文件，并完成依赖项导入、代码编写以及代码注释</h3><img src="/posts/2026/01/04/7ab6c8858e88/img5.png" class="" width="740" height="451"><h3 id="完成类库项目开发后，在顶部菜单栏（生成——配置管理器）打开配置管理器"><a href="#完成类库项目开发后，在顶部菜单栏（生成——配置管理器）打开配置管理器" class="headerlink" title="完成类库项目开发后，在顶部菜单栏（生成——配置管理器）打开配置管理器"></a>完成类库项目开发后，在顶部菜单栏（生成——配置管理器）打开配置管理器</h3><img src="/posts/2026/01/04/7ab6c8858e88/img6.png" class="" width="365" height="295"><h3 id="配置管理器中将项目配置为Release，如果涉及到平台请自行配置"><a href="#配置管理器中将项目配置为Release，如果涉及到平台请自行配置" class="headerlink" title="配置管理器中将项目配置为Release，如果涉及到平台请自行配置"></a>配置管理器中将项目配置为Release，如果涉及到平台请自行配置</h3><img src="/posts/2026/01/04/7ab6c8858e88/img7.png" class="" width="652" height="414"><h3 id="在解决方案资源管理器目录中找到项目并鼠标右键选择并打开项目属性面板"><a href="#在解决方案资源管理器目录中找到项目并鼠标右键选择并打开项目属性面板" class="headerlink" title="在解决方案资源管理器目录中找到项目并鼠标右键选择并打开项目属性面板"></a>在解决方案资源管理器目录中找到项目并鼠标右键选择并打开项目属性面板</h3><img src="/posts/2026/01/04/7ab6c8858e88/img8.png" class="" width="481" height="742"><h3 id="可以对生成中的选项进行设置，例如开启生成API文档的功能"><a href="#可以对生成中的选项进行设置，例如开启生成API文档的功能" class="headerlink" title="可以对生成中的选项进行设置，例如开启生成API文档的功能"></a>可以对生成中的选项进行设置，例如开启生成API文档的功能</h3><img src="/posts/2026/01/04/7ab6c8858e88/img9.png" class="" width="1040" height="448"><h3 id="配置完成后，在顶部菜单栏（生成——生成xxx，xxx表示项目名）生成类库"><a href="#配置完成后，在顶部菜单栏（生成——生成xxx，xxx表示项目名）生成类库" class="headerlink" title="配置完成后，在顶部菜单栏（生成——生成xxx，xxx表示项目名）生成类库"></a>配置完成后，在顶部菜单栏（生成——生成xxx，xxx表示项目名）生成类库</h3><img src="/posts/2026/01/04/7ab6c8858e88/img10.png" class="" width="368" height="300"><h3 id="查看生成结果信息"><a href="#查看生成结果信息" class="headerlink" title="查看生成结果信息"></a>查看生成结果信息</h3><img src="/posts/2026/01/04/7ab6c8858e88/img11.png" class="" width="885" height="176"><h2 id="特殊说明"><a href="#特殊说明" class="headerlink" title="特殊说明"></a>特殊说明</h2><ol><li><p>注意导入项目的依赖项，缺乏依赖可能导致整个类库项目的功能无法正常使用；</p></li><li><p>类库文件不易于调试，所以可以考虑采用日志的方式来记录调试信息；</p></li><li><p>好的类库文件应该编写xml文档注释，以便于类库调用者更好地使用类库；</p></li><li><p>默认导出的类库文件路径：项目目录\bin\Release\框架名\项目名.dll；</p></li><li><p>默认XML文档与导出的类库文件位于同一目录下。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>计算机编程常识（一）</title>
      
      <link href="/posts/2026/01/04/6c953861fe8d/"/>
      <url>/posts/2026/01/04/6c953861fe8d/</url>
      
        <content type="html"><![CDATA[<h2 id="计算机进程"><a href="#计算机进程" class="headerlink" title="计算机进程"></a>计算机进程</h2><p><strong>定义：</strong> 进程是可运行一个或多个线程的计算机程序的实例，进程依附于操作系统，它包含了程序代码、分配的系统资源、物理和逻辑访问权限以及用于启动、控制和协调执行活动的数据结构。</p><p><strong>特点：</strong></p><ol><li>一个进程可以同时执行多个线程；  </li><li>计算机程序是一个存储于磁盘上的被动指令集合，而进程则作为这些指令被加载至内存后的执行，也就是计算机程序的实例。  </li><li>多进程可与同一个计算机程序关联，因为可能存在多个计算机程序实例的情况。有些软件需要进行模块化处理以提升软件的可维护性，或者存在并行处理需求的软件提升处理效率等。例如Google浏览器的多进程架构，区分为浏览器进程、渲染进程、GPU进程和插件进程等，将不同的任务模块分配到独立的进程中，提升Google浏览器整体的稳定性和可维护性。</li></ol><p>—— <em>来自维基百科的英文文档</em></p><h2 id="计算机线程"><a href="#计算机线程" class="headerlink" title="计算机线程"></a>计算机线程</h2><p><strong>定义：</strong> 在计算机科学中，线程是由调度器独立管理的最小的编程指令序列，是操作系统的一部分，作为操作系统调度执行的最小单位。</p><p><strong>特殊说明：</strong></p><ol><li>通常线程作为进程的执行单位，一个进程可以有多个线程。  </li><li>在给定的进程中可以同时执行多个线程。  </li><li>在给定的时间内，线程可以共享进程中的资源，例如可执行代码以及动态分配的变量和非线程局部的全局变量的值等。</li></ol><p>—— <em>来自维基百科的英文文档</em></p><h2 id="计算机协程"><a href="#计算机协程" class="headerlink" title="计算机协程"></a>计算机协程</h2><p>协程（Coroutine）是一种计算机程序组件，它是一种可以暂停和恢复执行的函数或子程序。协程可以在执行过程中暂停，让出控制权给其他协程，然后在需要时恢复执行。这种能力使得协程在编写异步和并发代码时非常有用。</p><p>在许多编程语言中，协程通常与线程或进程相比具有更轻量级的特性，因为它们在同一线程内运行，共享同一片内存，不涉及线程切换或进程创建的开销。因此，协程在编写高效的并发代码时可以提供更好的性能和资源利用率。</p><h2 id="协程与线程的区别"><a href="#协程与线程的区别" class="headerlink" title="协程与线程的区别"></a>协程与线程的区别</h2><ol><li><p>协程是协作式多任务，线程是抢占式多任务。所以协程是主动让出调用权，线程则是抢夺调用权。</p></li><li><p>在协程之间的切换不需要涉及任何系统调用或任何阻塞调用，而线程需要。</p></li><li><p>协程并发而不并行，通常运行于单线程，例如Unity的协程运行于主线程上，线程可并行。</p></li><li><p>协程相比线程更轻便，创建和销毁更快速。</p></li><li><p>协程适合处理I&#x2F;O密集型任务和高并发任务，线程适合处理CPU密集型任务和并行任务。</p></li></ol><h2 id="JIT和AOT编译技术"><a href="#JIT和AOT编译技术" class="headerlink" title="JIT和AOT编译技术"></a>JIT和AOT编译技术</h2><p>两种编译技术均用于将高级代码转换为机器代码。</p><p>JIT是实时编译技术，首先将源代码转换为中间代码，再在运行时将中间代码转换为机器代码同时会根据目标平台的特性优化生成的机器代码，这个技术会减少可执行程序的大小，但是会增加程序启动的时间，因为需要在运行时进行编译。</p><p>AOT是预编译技术，将源代码直接编译为机器代码，这种方式会增大可执行程序的大小，但是会减少程序启动的时间。</p><p>JIT适用于具备跨平台特性的编程语言，例如Java、C#、JS等。</p><p>AOT适用于对性能和启动时间要求较高的应用场景，例如本地桌面程序、嵌入式系统等。</p><h2 id="类型安全"><a href="#类型安全" class="headerlink" title="类型安全"></a>类型安全</h2><p>类型安全是指编程语言能够在编译时或运行时强制保持变量和表达式的类型一致，防止出现不符合语言规定的类型错误。类型安全涉及到编译时和运行时的类型检查、类型转换检查以及空指针和空引用的处理等。一些静态类型语言（如Java、C#）在编译时强制执行类型安全，而动态类型语言（如Python、JavaScript）通常在运行时执行类型检查来确保类型安全。</p><h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>闭包通常用于一个函数中嵌套的内部函数，当该内部函数使用外部函数的变量时，即使外部函数执行完毕，内部函数依旧会保持对外部函数变量的访问，从而保存并记录函数状态。通常来说执行一个普通的函数，当执行完成或返回值后便会从栈中移除当前函数的上下文，然后回到调用点，而闭包则使得外部函数保持初始状态。最直观的例子就是外部函数接收的参数，当多次使用闭包时，这个参数依旧存在并维持传递的初始值。</p><h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><p>内存泄漏是指程序中分配出的内存由于某种原因无法被正常释放和回收，导致系统可用内存减少，最终导致程序或系统变得不稳定甚至崩溃。某些情况下对于手动申请的内存应该适时地进行释放，例如在C++中通过new或malloc申请内存，则需要通过delete或free来释放内存，对于一些由GC自动管理内存的编程语言，我们需要避免循环引用的问题，合理使用内存。</p><h2 id="引用循环"><a href="#引用循环" class="headerlink" title="引用循环"></a>引用循环</h2><p>对象A在引用对象B的同时，对象B也在引用对象A，从而导致引用陷入死循环，二者会不断占用资源，且无法正常释放和回收资源。</p><h2 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h2><p>GPU全名为图形处理单元（Graphic Process Unit），它最初被设计用于加速计算机图像和图形处理，后来发现它的并行结构同样适合用于处理并行相关的非图像问题，例如神经网络的训练和加密货币的挖掘等。</p>]]></content>
      
      
      <categories>
          
          <category> 通用知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 编程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity中的协程</title>
      
      <link href="/posts/2026/01/04/e21a3b607baa/"/>
      <url>/posts/2026/01/04/e21a3b607baa/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>协程使得任务的执行可以分配到多个帧中完成，在Unity中，协程从开始执行到第一个yield return 语句后将调用权归还Unity主线程，并在紧随的下一帧继续从上次结束调用的代码上下文位置恢复执行。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>HTTP请求、资源加载和文件I&#x2F;O等长时间的异步操作等。</p><p>在Unity中常见于动画控制、延迟执行、渐变效果、事件触发、特定间隔的循环执行、等待用户输入、平滑移动、逐帧处理大量数据和动态生成对象等。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li><p>避免阻塞协程，因为这会增加Unity主线程在CPU上所耗费的时间。</p></li><li><p>协程依附的游戏对象被通过SetActive方法禁用时，协程也会停止。当游戏对象通过Destroy被销毁时会立刻触发OnDisable方法，然后Unity会有效地停止协程，在当前帧结束时调用OnDestroy方法。值得注意的是，通过enabled&#x3D;false禁用对象，不会停止协程。</p></li><li><p>启用协程时的内存压力等于固定开销的分配加上局部变量的大小。</p></li><li><p>如果需要每帧运行并且长时间运行不会执行到yield语句的协程，改用Update或者LateUpdate是更好的选择。</p></li><li><p>嵌套协程会带来更高的内存开销，因为需要跟踪对象。</p></li><li><p>应尽量将一系列操作压缩到尽量少的协程中。</p></li></ol><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="使用示例1"><a href="#使用示例1" class="headerlink" title="使用示例1"></a>使用示例1</h3><p>该示例旨在探索协程在网络请求方面的应用，我们将模拟通过协程下载几张网络图片并在UI界面中进行显示，在这个示例中我们会使用到三个协程，一个主协程和两个子协程，子协程分别用于下载和加载图片资源，主协程用于控制两个子协程的启动。负责下载图片的协程会将所有图片资源下载并保存在本地磁盘，负责加载图片的协程会将本地磁盘的图片加载至内存中并赋值给对应的Image组件，先下载后加载。</p><h3 id="使用示例2"><a href="#使用示例2" class="headerlink" title="使用示例2"></a>使用示例2</h3><p>该示例旨在探索协程在逐张图片下载和加载方面的应用，不同于示例1，该示例中将以一张图片为单位，先进行下载然后进行加载，这么做可以使得用户在UI界面上能够实时浏览图片，例如当需要获取大量图片资源时，示例1在下载图片时就需要用户等待较长时间，而本示例则会每下载一张图片就立刻加载一张，这样可以让用户提前浏览图片。同时示例2并不会直接下载和加载所有图片资源，而是由用户通过按钮交互来切换图片，仅当用户切换后才会下载和加载新的图片资源。</p><h3 id="使用示例3"><a href="#使用示例3" class="headerlink" title="使用示例3"></a>使用示例3</h3><p>该示例演示了协程在轮播图中的应用，该示例全程自动下载和加载图片资源，同时会自动对图片进行轮播，除此之外图片资源的下载和加载过程会以进度条的方式进行展现。</p><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p><a href="https://pan.baidu.com/s/1T3VRi3I4JC6QdOrivAGqVg?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity的常见API（一）</title>
      
      <link href="/posts/2026/01/04/3175b9e7175b/"/>
      <url>/posts/2026/01/04/3175b9e7175b/</url>
      
        <content type="html"><![CDATA[<h2 id="组件的Invoke和InvokeRepeating方法"><a href="#组件的Invoke和InvokeRepeating方法" class="headerlink" title="组件的Invoke和InvokeRepeating方法"></a>组件的Invoke和InvokeRepeating方法</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Invoke</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> methodName, <span class="hljs-built_in">float</span> time</span>)</span>;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InvokeRepeating</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> methodName, <span class="hljs-built_in">float</span> time, <span class="hljs-built_in">float</span> repeatRate</span>)</span>;<br></code></pre></td></tr></table></figure><ol><li>methodName表示待执行的方法名称，time表示首次执行所延迟的时间，repeatRate表示周期性执行的时间。（时间单位均为秒）</li><li>Invoke指定的方法仅执行一次，InvokeRepeating指定的方法会执行多次。</li><li>Invoke指定的方法会延迟至参数指定的秒数后执行，InvokeRepeating指定的方法在time秒后首次执行，之后将按照repeatRate所指定的秒数为周期执行。</li><li>通过CancleInvoke取消Invoke和InvokeRepeating的执行。</li><li>Invoke与InvokeRepeating的执行与Time.timeScale有关，当timeScale为0时不执行，为2时执行速度将是原来的两倍。</li><li>Invoke系列方法不接受含参数的方法，若要调用含参数的方法可以考虑使用协程。</li></ol><h2 id="组件的Reset方法"><a href="#组件的Reset方法" class="headerlink" title="组件的Reset方法"></a>组件的Reset方法</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>()</span>;<br></code></pre></td></tr></table></figure><p>重置为默认值。</p><p>当用户点击Inspector面板上下文菜单中的“Reset”按钮或第一次添加组件时，将调用 Reset。 此函数只能在编辑器模式下调用。Reset 最常用于在Inspector面板中提供默认值。</p><h2 id="刚体的AddForce方法"><a href="#刚体的AddForce方法" class="headerlink" title="刚体的AddForce方法"></a>刚体的AddForce方法</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddForce</span>(<span class="hljs-params">Vector3 force, ForceMode mode = ForceMode.Force</span>)</span>;<br></code></pre></td></tr></table></figure><p>force表示施加力的向量，描述力的大小和方向。</p><img src="/posts/2026/01/04/3175b9e7175b/img1.png" class="" width="698" height="129"><blockquote><p>注意：该方法仅适用于附加了已激活的刚体的游戏对象，且刚体的类型不能为Kinematic。当通过该方法施加力时刚体默认会被唤醒，除非force为零向量。</p></blockquote><h2 id="CreateAssetMenuAttribute"><a href="#CreateAssetMenuAttribute" class="headerlink" title="CreateAssetMenuAttribute"></a>CreateAssetMenuAttribute</h2><p>这是一个编辑器时特性，用它来标记”ScriptableObject”的派生类，即可实现通过Unity3D的右键菜单创建对应的.asset文件，如果标记该特性的类仅在编辑器模式下使用，则建议将其所在文件放置在Editor目录下，否则应使用内置宏UNITY_EDITOR进行声明。</p><p>它包括fileName、menuName、order三个参数，分别表示所创建的.asset文件的默认名称、右键菜单的菜单项名称（路径）以及菜单项序号。</p><h2 id="Input中GetAxis和GetAxisRaw的区别"><a href="#Input中GetAxis和GetAxisRaw的区别" class="headerlink" title="Input中GetAxis和GetAxisRaw的区别"></a>Input中GetAxis和GetAxisRaw的区别</h2><ol><li><p>GetAxis是获取-1到0以及0到1之间的插值，适用于需要对按键灵敏进行处理的输入；</p></li><li><p>GetAxisRaw则是从-1，0，1三者之间获取其中一个值；</p></li><li><p>右下（D&#x2F;S）为正值，左上（A&#x2F;W）为负值，在编写角色转向相关逻辑的时候需要注意这一点。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>CharacterController组件的基本使用</title>
      
      <link href="/posts/2026/01/04/30b8475672ed/"/>
      <url>/posts/2026/01/04/30b8475672ed/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CharacterController是一个基础的角色控制组件，通过它我们可以实现包括移动、奔跑、跳跃、爬楼梯和爬斜坡等基本的角色操作。它主要用于不基于刚体物理的第一人称或第三人称的角色控制。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li><p>Move 方法是基于世界坐标系的，并且没有重力支持；</p></li><li><p>SimpleMove方法也是基于世界坐标系的，有重力支持（重力为游戏项目的全局重力值，在Editor-Project Settings-Physics-Gravity设置）；</p></li><li><p>跳跃应该采用Move方法；</p></li><li><p>isGrounded与Skin Width和Min Move Distance参数有关。当你觉得isGrounded的判断不精确时可以尝试调节Skin Width和Min Move Distance参数。官方建议Skin Width保持为Radius参数的10%，而Min Move Distance为0；</p></li><li><p>对于穿透、卡住、碰撞抖动等问题可以通过适当增大Skin Width的方式来解决；</p></li><li><p>使用该组件后无法通过Transform组件直接修改坐标、旋转等变换值，需要先禁用该组件，修改完成后再重新启用。</p></li></ol><p>总结自<a href="https://docs.unity3d.com/Manual/class-CharacterController.html">官方英文文档</a></p><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br>[<span class="hljs-meta">RequireComponent(typeof(CharacterController))</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Player</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    [<span class="hljs-meta">Header(<span class="hljs-string">&quot;必要属性&quot;</span>)</span>]<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;角色转向速度&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> TurnSpeed = <span class="hljs-number">100</span>;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;角色移动速度&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> MoveSpeed = <span class="hljs-number">13</span>;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;角色跳跃高度&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> JumpHeight = <span class="hljs-number">2.5f</span>;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;重力加速度值&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> GravityValue = <span class="hljs-number">-9.81f</span>;<br><br>    <span class="hljs-keyword">private</span> CharacterController cc;<br>    <span class="hljs-keyword">private</span> Vector3 playerVelocity;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        cc = GetComponent&lt;CharacterController&gt;();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>    &#123;<br>        Movement();<br>        Jump();<br>    &#125;<br><br>    <span class="hljs-comment">// 角色转向</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Turn</span>(<span class="hljs-params"><span class="hljs-built_in">float</span> hor</span>)</span><br>    &#123;<br>        Vector3 euler = transform.localRotation.eulerAngles;<br>        <span class="hljs-built_in">float</span> yRotation = euler.y + hor * TurnSpeed * Time.deltaTime;<br>        transform.localRotation = Quaternion.Euler(euler.x, yRotation, euler.z);<br>    &#125;<br><br>    <span class="hljs-comment">// 基于CharacterController的Move方法</span><br>    <span class="hljs-comment">// private void Movement()</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     float hor = Input.GetAxisRaw(&quot;Horizontal&quot;);</span><br>    <span class="hljs-comment">//     float ver = Input.GetAxisRaw(&quot;Vertical&quot;);</span><br>    <span class="hljs-comment">//     if (hor != 0) Turn(hor);</span><br>    <span class="hljs-comment">//     Vector3 direction = transform.TransformDirection(Vector3.forward * ver);</span><br><br>    <span class="hljs-comment">//     cc.Move(direction * Time.deltaTime * MoveSpeed);</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// 基于CharacterController的SimpleMove方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Movement</span>()</span><br>    &#123;<br>        <span class="hljs-built_in">float</span> hor = Input.GetAxisRaw(<span class="hljs-string">&quot;Horizontal&quot;</span>);<br>        <span class="hljs-built_in">float</span> ver = Input.GetAxisRaw(<span class="hljs-string">&quot;Vertical&quot;</span>);<br>        <span class="hljs-keyword">if</span> (hor != <span class="hljs-number">0</span>) Turn(hor);<br>        Vector3 direction = transform.TransformDirection(Vector3.forward * ver);<br><br>        cc.SimpleMove(direction * MoveSpeed);<br>    &#125;<br><br>    <span class="hljs-comment">// 角色跳跃</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Jump</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (cc.isGrounded)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (playerVelocity.y &lt; <span class="hljs-number">0</span>) playerVelocity.y = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (Input.GetButtonDown(<span class="hljs-string">&quot;Jump&quot;</span>))<br>            &#123;<br>                playerVelocity.y += Mathf.Sqrt(JumpHeight * <span class="hljs-number">-3.0f</span> * GravityValue);<br>            &#125;<br>        &#125;<br><br>        playerVelocity.y += GravityValue * Time.deltaTime;<br>        cc.Move(playerVelocity * Time.deltaTime);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【小巧-轻便-实用】图片缩放器工具</title>
      
      <link href="/posts/2026/01/04/776dce25b80a/"/>
      <url>/posts/2026/01/04/776dce25b80a/</url>
      
        <content type="html"><![CDATA[<h2 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h2><h3 id="【v1-0】"><a href="#【v1-0】" class="headerlink" title="【v1.0】"></a>【v1.0】</h3><p><strong>工具名称：</strong> 图片缩放器（Image Resizer）</p><p><strong>工具版本：</strong> 1.0</p><p><strong>功能介绍：</strong></p><ol><li>批量生成指定目录下不同图片文件的指定尺寸的图片文件；</li><li>可以选择预设尺寸，也可以输入自定义尺寸；</li><li>重置按钮可以清空所有输入框；</li><li>顶部菜单可以更换语言版本，分为英文和中文。</li></ol><p><strong>工具截图：</strong></p><img src="/posts/2026/01/04/776dce25b80a/img1.png" class="" width="278" height="262"><p><strong>下载链接：</strong> <a href="https://pan.baidu.com/s/1Ab9asosSZKginvY7Akx_Hg?pwd=1314">百度网盘（提取码：1314）</a></p><h3 id="【v1-1】"><a href="#【v1-1】" class="headerlink" title="【v1.1】"></a>【v1.1】</h3><div style="text-align:center"><b>版本对比</b></div><table><thead><tr><th>功能</th><th>v1.0</th><th>v1.1</th></tr></thead><tbody><tr><td>预设尺寸</td><td>√</td><td>√</td></tr><tr><td>自定义尺寸</td><td>√</td><td>√</td></tr><tr><td>添加图片文件命名前后缀</td><td>×</td><td>√</td></tr><tr><td>仅缩放画布</td><td>×</td><td>√</td></tr><tr><td>重置</td><td>√</td><td>√</td></tr><tr><td>中英文版本切换</td><td>√</td><td>√</td></tr><tr><td>提示</td><td>×</td><td>√</td></tr></tbody></table><p><strong>工具截图：</strong></p><img src="/posts/2026/01/04/776dce25b80a/img2.png" class="" width="352" height="409"><p><strong>下载链接：</strong> <a href="https://pan.baidu.com/s/1TCAREeUeZwAH0jWoT6Y13w?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> 小工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Demo】基于CharacterController组件的角色控制</title>
      
      <link href="/posts/2026/01/04/448e11284543/"/>
      <url>/posts/2026/01/04/448e11284543/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>项目名称：Demo1</p><p>项目版本：1.0</p><p>游戏引擎：Unity2020.3.26f1c1</p><p>IDE：Visual Studio Code</p><p>关键词：Unity3D，CharacterController组件，角色控制，自定义按键，ScriptableObject</p><h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ol><li>这是一个基于CharacterController组件实现角色控制的小项目。</li><li>项目分为两个场景，一个是主菜单场景，另一个是游戏场景。</li><li>主菜单场景中可以点击Play进入游戏场景，点击Quit退出项目。</li><li>在游戏场景中，顶部有角色控制的按键提示，角色可以完成基本的移动、转向、跳跃、下蹲和冲刺操作。</li><li>默认通过Tab键打开游戏菜单，点击Restart可以回到起始点；点击PlayerSettings进入角色属性设置面板，可以设置角色的转向速度、移动速度、跳跃高度、重力加速度（负值）和冲刺速度倍率；点击InputSettings进入输入设置面板，可以设置每种操作对应的按键；点击Quit退出项目。</li><li>对于角色属性设置和输入设置都可以通过点击Reset恢复默认设置。</li></ol><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><img src="/posts/2026/01/04/448e11284543/img1.png" class="" width="866" height="820"><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/1JBAbkHS4nBaqzxQcQ8sDjQ?pwd=1314">百度网盘（项目文件，提取码：1314）</a><br><a href="https://pan.baidu.com/s/1rCsZaASGVm0ViLvnrXHAbg?pwd=1314">百度网盘（可执行文件，提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
            <tag> 游戏开发 </tag>
            
            <tag> Demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【小巧-轻便-实用】汉字机内码转换器</title>
      
      <link href="/posts/2026/01/04/34951cc8e658/"/>
      <url>/posts/2026/01/04/34951cc8e658/</url>
      
        <content type="html"><![CDATA[<h2 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h2><h3 id="【v1-0】"><a href="#【v1-0】" class="headerlink" title="【v1.0】"></a>【v1.0】</h3><p><strong>工具名称：</strong> 机内码转换器（Machine Code Converter）</p><p><strong>工具版本：</strong> 1.0</p><p><strong>功能介绍：</strong></p><ol><li>输入一到多个汉字；</li><li>可选择GB2312或GBK汉字编码标准；</li><li>可一键复制生成的机内码；</li><li>可通过重置按钮一键清空汉字内容输入框和机内码输出框；</li><li>可切换中英文语言版本。</li></ol><p><strong>工具截图：</strong></p><img src="/posts/2026/01/04/34951cc8e658/img1.png" class="" width="295" height="235"><p><strong>下载链接：</strong> <a href="https://pan.baidu.com/s/1ObWUJndH62NosCINFWMS7g?pwd=1314">百度网盘（提取码：1314）</a></p><h3 id="【v1-1】"><a href="#【v1-1】" class="headerlink" title="【v1.1】"></a>【v1.1】</h3><div style="text-align:center"><b>版本对比</b></div><table><thead><tr><th>功能</th><th>v1.0</th><th>v1.1</th></tr></thead><tbody><tr><td>选择文本文件</td><td>×</td><td>√</td></tr><tr><td>输入汉字内容</td><td>√</td><td>√</td></tr><tr><td>选择汉字编码标准</td><td>√</td><td>√</td></tr><tr><td>一键复制机内码</td><td>√</td><td>√</td></tr><tr><td>一键清空输入框和输出框</td><td>√</td><td>√</td></tr><tr><td>提示</td><td>×</td><td>√</td></tr><tr><td>中英文语言版本切换</td><td>√</td><td>√</td></tr><tr><td>生成机内码文本文件</td><td>×</td><td>√</td></tr></tbody></table><p><strong>工具截图：</strong></p><img src="/posts/2026/01/04/34951cc8e658/img2.png" class="" width="306" height="392"><p><strong>下载链接：</strong> <a href="https://pan.baidu.com/s/1ObWUJndH62NosCINFWMS7g?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> 小工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【小巧-轻便-实用】屏幕取色器</title>
      
      <link href="/posts/2026/01/04/d79ea79dfc76/"/>
      <url>/posts/2026/01/04/d79ea79dfc76/</url>
      
        <content type="html"><![CDATA[<h2 id="Release"><a href="#Release" class="headerlink" title="Release"></a>Release</h2><h3 id="【v1-0】"><a href="#【v1-0】" class="headerlink" title="【v1.0】"></a>【v1.0】</h3><p><strong>工具名称：</strong> 屏幕取色器（Color Picker）</p><p><strong>工具版本：</strong> 1.0</p><p><strong>功能介绍：</strong></p><p>1.可以控制取色器的启用和禁用；<br>2.可以快速复制当前颜色信息数值；<br>3.可以切换颜色信息显示模式，包括颜色的十六进制、HSL、HSV和RGB；<br>4.可以切换中英文语言版本。</p><p><strong>工具截图：</strong></p><img src="/posts/2026/01/04/d79ea79dfc76/img1.png" class="" width="252" height="90"><p><strong>下载链接：</strong> <a href="https://pan.baidu.com/s/1YCBofAc_fjKOckcTutcWHw?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> 小工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#常识篇（二）</title>
      
      <link href="/posts/2026/01/04/beeedb417140/"/>
      <url>/posts/2026/01/04/beeedb417140/</url>
      
        <content type="html"><![CDATA[<h2 id="委托和事件的区别"><a href="#委托和事件的区别" class="headerlink" title="委托和事件的区别"></a>委托和事件的区别</h2><p>委托可以认为是对指定函数类型的引用，通过委托可以实现将函数作为参数或者变量进行使用，委托是类型安全的，仅指向与其声明时指定函数类型相匹配的函数。委托可以分为单播委托和多播委托，二者的区别在于是对单个方法还是一组方法的引用，多播委托则可以通过特定的符号”+&#x3D;”和”-&#x3D;”来完成函数的订阅和取消订阅。</p><p>事件则是一种特殊的多播委托，其相比于普通的多播委托更加安全，事件将多播委托的调用权限隔离在其所在类的内部，并对外部关闭了直接通过赋值符号”&#x3D;”修改多播委托实例的入口，使得外部调用者仅能够进行基本的函数订阅和取消订阅的操作。</p><h2 id="多播委托的底层实现"><a href="#多播委托的底层实现" class="headerlink" title="多播委托的底层实现"></a>多播委托的底层实现</h2><p>多播委托实际上是一个类实例，其中定义了一个函数引用列表用于存储订阅的函数。当调用多播委托时，将由实例内部来遍历该函数引用列表，并按照订阅顺序依次调用函数，CLR提供底层支持。</p><h2 id="重载和重写的区别"><a href="#重载和重写的区别" class="headerlink" title="重载和重写的区别"></a>重载和重写的区别</h2><p>重载是一种编译时多态，重载函数的名称相同但参数列表不同，在调用时编译器会自动根据传递的参数列表适配指定形式的重载函数。</p><p>重写是一种运行时多态，子类重写父类的方法，在调用时根据实例对象的类型而适配重写函数。</p><h2 id="for和foreach的区别"><a href="#for和foreach的区别" class="headerlink" title="for和foreach的区别"></a>for和foreach的区别</h2><p>对于数组遍历，for循环通过数组索引直接访问元素，而foreach循环通过获取集合的枚举器(IEnumerator)来顺序遍历元素。foreach循环中的迭代变量是只读的，不能直接赋值，但可以修改引用类型对象的属性。在foreach遍历过程中修改集合（如添加、删除元素）会导致迭代器失效，抛出异常。在选择循环方式时，应根据具体需求决定：需要索引访问或修改集合时使用for循环，只读遍历且代码简洁性更重要时使用foreach循环。</p><h2 id="类和结构体的区别"><a href="#类和结构体的区别" class="headerlink" title="类和结构体的区别"></a>类和结构体的区别</h2><ol><li><p>类的实例对象存储在堆上，其引用存储在栈上；结构体的存储位置取决于上下文：局部变量在栈上，作为类的字段或数组元素时在堆上，装箱时也在堆上。</p></li><li><p>类支持完整的面向对象特性（继承、多态、封装），可以实现接口；结构体不能继承其他类型，只能实现接口。</p></li><li><p>类是引用类型，多个变量可以引用同一对象，修改通过任一引用进行会影响所有引用；结构体是值类型，赋值操作创建副本，各个副本相互独立。</p></li><li><p>类适合大型对象、需要复杂行为或继承多态的场景；结构体适合轻量级的数据结构，通常设计为不可变，主要存储数据而非提供复杂行为。此外，结构体不能显式定义无参构造函数，不能有字段初始化器，且要避免设计过大的结构体以防止复制开销。</p></li></ol><h2 id="foreach的原理"><a href="#foreach的原理" class="headerlink" title="foreach的原理"></a>foreach的原理</h2><p>foreach是一种结合迭代器模式遍历实现了IEnumerable（或IEnumerable<T>）接口的容器类的语句，这两个接口会提供获取IEnumerator（或IEnumerator<T>）类型迭代器的方法，foreach会在运行时自动获取迭代器并启动对容器类的遍历。</p><h2 id="协变和逆变"><a href="#协变和逆变" class="headerlink" title="协变和逆变"></a>协变和逆变</h2><p>协变允许将派生程度更大的类型赋值给派生程度更小的变量，逆变允许将派生程度更小的类型赋值给派生程度更大的变量。协变和逆变为数组、委托和泛型接口提供类型参数的灵活转换。</p><p>在C#中，通过out关键字声明协变泛型参数（只能出现在输出位置，如返回值），通过in关键字声明逆变泛型参数（只能出现在输入位置，如方法参数）。协变性体现在方法的返回类型上，逆变性体现在方法的参数类型上。</p><p>需要注意的是，数组协变是C#的语言特性但存在运行时类型安全问题，而泛型接口的协变和逆变在编译时和运行时都是类型安全的。</p><h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><p>结构体隐式继承自System.ValueType，属于值类型。结构体的存储位置取决于上下文：局部变量在栈上，但作为类的字段、数组元素或装箱时存储在堆上。</p><p>结构体的主要特性：</p><ol><li>支持实现接口，可以重写Equals、ToString、GetHashCode方法，但不支持实现继承和多态；</li><li>不能包含自身类型的实例字段（防止无限递归），但可以包含引用类型的集合；</li><li>可以不使用new关键字创建实例，但使用前必须显式初始化所有字段；</li><li>C# 10之前自定义构造函数会隐藏默认无参构造函数，C# 10及以后支持自定义无参构造函数；</li><li>自定义构造函数必须初始化所有字段；</li></ol><p>结构体适合表示轻量级的数据结构，设计上偏向数据而非复杂行为。结构体赋值会进行值复制，对于大型结构体可能产生性能开销。建议使用readonly struct和init关键字来创建不可变结构体。</p><h2 id="常见修饰符"><a href="#常见修饰符" class="headerlink" title="常见修饰符"></a>常见修饰符</h2><p>（1）public:能够在其声明所在的类或结构体甚至程序集外部访问，程序集外部访问需要引用其所在程序集；</p><p>（2）protected:能够在直接或间接派生类或其声明所在的类中访问；</p><p>（3）private:仅能够在其声明所在的类或结构体中访问；</p><p>（4）internal:能够在其声明所在的类或结构体之外但在所处程序集之内访问；</p><img src="/posts/2026/01/04/beeedb417140/img1.png" class="" width="594" height="387"><p>值得注意的是，未明确指定访问修饰符的类或结构体或接口默认为internal，未明确指定访问修饰符的类成员或结构体成员默认为private，接口成员默认为public。</p><img src="/posts/2026/01/04/beeedb417140/img2.png" class="" width="595" height="357"><h2 id="静态构造函数"><a href="#静态构造函数" class="headerlink" title="静态构造函数"></a>静态构造函数</h2><p>静态构造函数用于初始化任何静态数据，或执行仅需执行一次的特定操作。 将在创建第一个实例或引用任何静态成员之前自动调用静态构造函数。 静态构造函数最多调用一次。如果静态字段的初始化并不复杂或者不涉及一些特殊的处理，那么建议在静态字段声明时即进行初始化，使用静态构造函数会影响运行时优化。常见的应用场景包括日志记录、创建非托管代码的包装类以及运行时的参数类型检查。</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity中的ScriptableObject</title>
      
      <link href="/posts/2026/01/04/539099d215b4/"/>
      <url>/posts/2026/01/04/539099d215b4/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ScriptableObject是一种与Monobehaviour相似并能够进行序列化以及生成.asset文件的对象类型，但是ScriptableObject类型对象无法像组件一样进行挂载，只能通过CreateInstance方法创建实例，还可以通过CreateAsset特性为指定的ScriptableObject类型对象轻松创建.asset持久化存储的资源文件。</p><h2 id="常见应用场景"><a href="#常见应用场景" class="headerlink" title="常见应用场景"></a>常见应用场景</h2><ol><li>存储和管理可共享数据或资源（持久化存储）；</li><li>编辑器工具（访问编辑器API）；</li><li>事件系统（全局性资产）；</li><li>数据序列化（可序列化）；</li><li>可扩展性要求（可插拔）。</li></ol><p>……</p><p>来自官方英文文档</p><h2 id="个人使用总结"><a href="#个人使用总结" class="headerlink" title="个人使用总结"></a>个人使用总结</h2><ol><li><p>当在ScriptableObject派生类中通过自定义的方式实现单例模式时，在类内部访问成员字段或属性时，需要注意，通过单例访问和直接访问的区别。单例由于是静态的，所以全局保留在内存中，所以单例访问会贯穿整个生命周期，不会被GC回收，但是如果是直接访问则是一种类似于通过”this.”的实例方式访问，这种方式会受到GC回收的影响，一旦当前派生类被禁用或不被外部访问时，GC就会回收该实例，在此之后，如果在类的内部通过直接访问的方式二次访问成员字段或属性，则会出现字段或属性为类型默认值（0或Null等）的情况，要避免这种情况要么在该派生类重新激活时进行初始化或者直接使用单例访问的方式。</p></li><li><p>ScriptableObject派生类适用于存储编辑器Play模式或导出的构建程序中的只读数据，还适用于存储编辑器模式下的数据，且支持读写操作，具体请参考示例1和2。</p></li><li><p>可以通过继承ScriptableSingleton<T>直接实现ScriptableObject+单例模式，例如当存在一个全局唯一的数据表时，这个方式将使得数据的访问和管理变得非常便利，具体请参考使用示例3。</p></li></ol><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="使用示例1"><a href="#使用示例1" class="headerlink" title="使用示例1"></a>使用示例1</h3><p>本示例旨在探索两个问题：</p><ol><li>ScriptableObject类型对象在编辑器Play模式下的读写操作；</li><li>ScriptableObject类型对象在构建程序的运行时中的读写操作。</li></ol><p>示例模拟了玩家通过UI界面修改角色属性并保存修改的应用场景，结果显示在编辑器Play模式下的修改不会被应用于对应的asset文件中，反映在编辑器中则是退出编辑器Play模式后对应asset文件的Inspector面板中数据虽然发生修改，但是这个修改是保留在缓存中的，并没有写入到磁盘中，通过打开asset文件即可验证，当我们下次重新打开Unity时会发现修改并没有被持久化保存，这种情况下可能就涉及到调用AssetDatabase相关的API来手动保存asset文件的修改，但是在编辑器Play模式下执行这类API显然是不适用的，所以不建议需要在编辑器Play模式下修改的数据以ScriptableObject类型对象的形式存储，仅推荐只读访问。在导出的构建程序中也是如此，Unity构建过程中会将项目中的asset资源打包为只读资源，所以也只能提供只读访问。</p><p>（对应项目中Example_1）</p><blockquote><p>故通过该示例得出结论：ScriptableObject类型对象实例在编辑器Play模式下或在构建程序的运行时中均支持只读操作。</p></blockquote><h3 id="使用示例2"><a href="#使用示例2" class="headerlink" title="使用示例2"></a>使用示例2</h3><p>该示例旨在探索ScriptableObject类型对象在编辑器模式下的读写操作，模拟了用户通过编辑器UI界面浏览、添加和删除信息的应用场景，结果显示在编辑器模式下的修改最终会被应用于对应的asset文件中，但是对于asset文件的修改，也只是暂存于缓存中，要想持久化存储，就需要结合AssetDatabase相关的API来完成保存。（对应项目中Example_2）</p><blockquote><p>故通过该示例得出结论：ScriptableObject类型对象实例在编辑器模式下支持读写操作。</p></blockquote><h3 id="使用示例3"><a href="#使用示例3" class="headerlink" title="使用示例3"></a>使用示例3</h3><p>本示例旨在探索ScriptableObject类型对象的单例模式应用是否具有普遍意义，模拟了用户通过编辑器UI界面浏览、添加和删除信息的应用场景，ScriptableSingleton<T>类型对象则是ScriptableObject类型对象和单例模式结合的产物，通过继承ScriptableSingleton<T>即可打造一个全局可访的ScriptableObject类型对象，并且无需手动从本地磁盘去加载其实例，使用FilePath特性即可完成ScriptableObject类型对象的持久化存储文件的构建。（对应项目中Example_3）</p><p>ScriptableSingleton<T>也是继承自ScriptableObject，并且通过单例模式进行了封装，对外部隐藏了持久化存储文件的路径，简化了外部的访问以及保证了全局访问的唯一入口。</p><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/18wmR9zCkqAFLE4HTKB0WtA?pwd=1314">百度网盘（提取码：1314）</a></p><blockquote><p>PS：示例项目为.unitypackage形式文件，下载后直接导入项目根据提示进行演示即可。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> API </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#常识篇（三）</title>
      
      <link href="/posts/2026/01/04/737847d1f474/"/>
      <url>/posts/2026/01/04/737847d1f474/</url>
      
        <content type="html"><![CDATA[<h2 id="内置类型字节大小"><a href="#内置类型字节大小" class="headerlink" title="内置类型字节大小"></a>内置类型字节大小</h2><p>以下是 C# 中常见内置数据类型的字节大小：</p><p>bool（布尔）类型：始终为 1 字节。<br>byte（无符号字节）类型：始终为 1 字节。<br>sbyte（有符号字节）类型：始终为 1 字节。<br>char（Unicode 字符）类型：通常为 2 字节。<br>short（短整型）类型：通常为 2 字节。<br>ushort（无符号短整型）类型：通常为 2 字节。<br>int（整型）类型：通常为 4 字节。<br>uint（无符号整型）类型：通常为 4 字节。<br>long（长整型）类型：通常为 8 字节。<br>ulong（无符号长整型）类型：通常为 8 字节。<br>float（单精度浮点型）类型：通常为 4 字节。<br>double（双精度浮点型）类型：通常为 8 字节。<br>decimal（高精度十进制型）类型：通常为 16 字节。  </p><h2 id="using语句"><a href="#using语句" class="headerlink" title="using语句"></a>using语句</h2><p>using语句用于正确使用可释放对象（实现IDisposable接口），using语句块中无论是否发生异常都会释放可释放对象。using语句可声明多个可释放对象，释放将按照声明的相反顺序进行。常见的文件I&#x2F;O操作可以使用using语句。</p><h2 id="装箱和取消装箱"><a href="#装箱和取消装箱" class="headerlink" title="装箱和取消装箱"></a>装箱和取消装箱</h2><p>装箱是将值类型转换为 object 类型或由此值类型实现的任何接口类型的过程。 常见语言运行时 (CLR) 对值类型进行装箱时，会将值包装在 System.Object 实例中并将其存储在托管堆中。 取消装箱将从对象中提取值类型。 装箱是隐式的；取消装箱是显式的。</p><h2 id="静态存储区和托管堆的区别"><a href="#静态存储区和托管堆的区别" class="headerlink" title="静态存储区和托管堆的区别"></a>静态存储区和托管堆的区别</h2><p>静态存储区（Static Storage Area）和托管堆（Managed Heap）是两个与内存管理相关的概念，通常用于描述不同的内存分配和管理方式。</p><p><strong>静态存储区：</strong> 静态存储区是指用于存储静态变量的内存区域。静态变量是在程序编译时就被分配内存，并在整个程序生命周期内都存在的变量。这些变量通常包括全局变量、静态类成员变量以及静态局部变量。静态存储区的生命周期与程序的生命周期相同，在程序启动时被分配内存，在程序结束时释放内存。</p><p><strong>托管堆：</strong> 托管堆是托管语言（例如C#、Java等）中用于存储动态分配的对象的内存区域。在C#中，所有的类实例都是在托管堆上分配的。与静态存储区不同，托管堆上的对象的生命周期不是固定的，它们会在不再被引用时由垃圾回收器进行回收。</p><p><strong>总结：</strong> 虽然它们都是用于存储数据的内存区域，但是它们所存储的数据类型和生命周期是不同的，因此静态存储区和托管堆在内存管理中扮演不同的角色。</p><table><thead><tr><th>特性</th><th>静态存储区</th><th>托管堆</th></tr></thead><tbody><tr><td>存储内容</td><td>静态变量、类型元数据、常量</td><td>对象实例、数组、字符串</td></tr><tr><td>生命周期</td><td>应用程序域生命周期</td><td>对象引用生命周期</td></tr><tr><td>管理方式</td><td>手动管理（需要显式清理）</td><td>自动垃圾回收</td></tr><tr><td>分配时机</td><td>类型加载时</td><td>运行时动态分配</td></tr><tr><td>访问方式</td><td>直接通过类型访问</td><td>通过对象引用访问</td></tr><tr><td>性能特点</td><td>访问快，无GC压力</td><td>访问稍慢，受GC影响</td></tr><tr><td>内存泄漏</td><td>容易发生（需手动管理）</td><td>较少发生（自动管理</td></tr><tr><td>使用场景</td><td>全局配置、缓存、单例</td><td>业务对象、临时数据、集合</td></tr></tbody></table><h2 id="输入流和输出流"><a href="#输入流和输出流" class="headerlink" title="输入流和输出流"></a>输入流和输出流</h2><p>输入流（Input Stream）和输出流（Output Stream）是在计算机编程中常用的概念，用于处理数据流的读取和写入。</p><p><strong>输入流：</strong></p><ol><li>输入流用于从数据源（如文件、网络连接、键盘输入等）读取数据。</li><li>输入流的主要任务是从外部数据源读取数据并提供给程序使用。</li><li>输入流通常提供一系列的读取方法，例如读取一个字节、读取一段字节数组、读取一个字符等。</li></ol><p>示例：从文件中读取数据、从网络连接中接收数据等。</p><p><strong>输出流：</strong></p><ol><li>输出流用于向目标位置（如文件、网络连接、屏幕显示等）写入数据。</li><li>输出流的主要任务是将程序中的数据写入到外部目标位置。</li><li>输出流通常提供一系列的写入方法，例如写入一个字节、写入一段字节数组、写入一个字符等。</li></ol><p>示例：向文件中写入数据、向网络连接发送数据等。</p><p><strong>总结：</strong> 在许多编程语言中，包括Java、C#、Python等，都提供了用于处理输入流和输出流的相关类库或模块。通过使用这些类库或模块，程序可以方便地与外部数据源进行交互，实现数据的读取和写入操作。输入流和输出流的概念在各种应用场景中都有着广泛的应用，如文件处理、网络通信、数据传输等。</p><h2 id="继承中方法的重写"><a href="#继承中方法的重写" class="headerlink" title="继承中方法的重写"></a>继承中方法的重写</h2><ol><li><p>派生类可以重写的基类方法</p><ul><li>基类中使用virtual关键字进行限定的方法（简称“虚方法”）；</li><li>在派生类中使用new关键字对与基类同名的方法进行重写（简称“隐藏方法”）；</li><li>基类是抽象类，抽象类中使用abstract关键字进行限定的方法（简称“抽象方法”）。</li></ul></li><li><p>virtual关键字详解<br>virtual关键字用于定义虚方法，基类中的virtual方法可以被直接或间接派生类选择性重写。</p></li><li><p>new关键字详解<br>new关键字用于隐藏方法，这里的隐藏是派生类对基类隐藏同名方法，其在编译时根据声明类型决定的，这不同于重写的方法。直观的区别就在于声明为基类而实例化为派生类的对象将无法调用派生类的隐藏方法，但是声明与实例化均为派生类的对象则可以调用派生类的隐藏方法。</p></li><li><p>abstract关键字详解<br>abstract关键字用于声明抽象类和抽象方法，且抽象方法仅存在于抽象类中，直接派生类被要求必须完成基类中抽象方法的定义，除非直接派生类也为抽象类。</p></li><li><p>seald关键字详解<br>seald关键字用于声明密封类和密封方法，密封类无法被继承，密封方法无法被重写。</p></li></ol><h2 id="readonly关键字"><a href="#readonly关键字" class="headerlink" title="readonly关键字"></a>readonly关键字</h2><p>readonly关键字通常用于字段和结构体。</p><ol><li>readonly修饰的字段只能在声明时或其所在类的构造函数中进行初始化，readonly修饰的结构体中所有字段都是隐式地被readonly限定；</li><li>readonly修饰的字段可能是值类型也可能是引用类型，若为值类型，那么则为不可变对象，若为引用类型，则只能保证当前字段所指向的实例不变，但无法保证实例内部的状态不变，且官方不建议使用readonly修饰可变引用类型的字段，特别是对于向外公开的可变引用类型，因为这可能存在安全漏洞。</li></ol><h2 id="static关键字"><a href="#static关键字" class="headerlink" title="static关键字"></a>static关键字</h2><p>static关键字可用于修饰类、字段、属性、方法、运算符、事件和构造函数。</p><ol><li>static修饰类：静态类的字段、属性和其它成员必须都是静态的。</li><li>static修饰字段：外部访问范围将不限于某个实例对象而是整个类，通常以”类名.字段名”的方式进行访问，在类的内部将作为所有实例对象的共享字段。</li><li>static修饰属性：与static字段相似，不同的是属性可以控制get和set权限。</li><li>static修饰方法：外部访问范围将不限于某个实例对象而是整个类，通常以”类名.方法名”的方式进行访问，在类的内部将作为所有实例对象的共享方法。</li><li>static构造函数：对于接口、类和静态类都具有静态构造函数。</li></ol><h2 id="索引器"><a href="#索引器" class="headerlink" title="索引器"></a>索引器</h2><p>索引器与属性类似，只不过属性通常针对字段，而索引器针对整个类或结构体。通过索引器可以自定义类似于数组下标访问、字典键值访问的规则，尤其是对于一些自定义的数据结构，创建索引器可以使得访问和修改更加便捷。属性的各种用法均适用于索引器，除了”自动实现属性”的用法，索引器可以指定多个参数。</p><h2 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h2><p>运算符重载与函数重载类似，通过对某个类或结构体的可重载运算符进行重载，使得该类或结构体的实例在运算符表达式中按照重载的逻辑进行操作，运算符重载与函数重载一样具备编译时自动匹配的特性。值得注意的是运算符重载需要明确可重载运算符以及成对重载的运算符，运算符重载的参数至少有一个类型包含当前类。</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Demo】2D关卡房间随机生成</title>
      
      <link href="/posts/2026/01/04/7d7278b18738/"/>
      <url>/posts/2026/01/04/7d7278b18738/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>初步探索2D关卡房间随机生成的实现，通过设立房间模板，根据设置的待生成房间数量随机生成不同布局的2D关卡房间。</p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115836492711297&bvid=BV1m9iEBREHs&cid=35185298073&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/1qGyd0vP67SDhzomA8ne49A?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
            <tag> Demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Demo】游戏小地图</title>
      
      <link href="/posts/2026/01/04/1fe5d49b1d78/"/>
      <url>/posts/2026/01/04/1fe5d49b1d78/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该Demo基于2D关卡随机生成项目进行实现，旨在初步探索游戏小地图的制作。</p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115836459221584&bvid=BV1LziEBKEsU&cid=35185164351&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/1fWdkUiVXfO8fuM14xXKlMQ?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
            <tag> Demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Demo】对话系统</title>
      
      <link href="/posts/2026/01/04/3ecf767e9d9a/"/>
      <url>/posts/2026/01/04/3ecf767e9d9a/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文针对对话系统的实现进行了初步探索，实现了文字打印机和一键完成打印的功能。</p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115836408825632&bvid=BV1dqiEBiEtV&cid=35184839409&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/1JWGtwWuz2uD6Iw-D-8Re6A?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
            <tag> Demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Attribute】Inspector视图可视不可编辑字段特性</title>
      
      <link href="/posts/2026/01/04/7ed673d41718/"/>
      <url>/posts/2026/01/04/7ed673d41718/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Unity开发中，有时候我们存在这种需求，需要在Inspector视图中可以查看字段信息但是无法对字段进行赋值，那么我们也可以像Unity内置的[SerializeField]、[Tooltip]等特性那样自定义一个特性，用于满足这个需求。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="EditDisabledAttribute-cs"><a href="#EditDisabledAttribute-cs" class="headerlink" title="EditDisabledAttribute.cs"></a>EditDisabledAttribute.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment">// 禁用可序列化字段在Inspector面板的编辑</span><br>[<span class="hljs-meta">AttributeUsage(AttributeTargets.Field, AllowMultiple = false, Inherited = false)</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EditDisabledAttribute</span> : <span class="hljs-title">PropertyAttribute</span> &#123; &#125;<br></code></pre></td></tr></table></figure><h3 id="EditDisabledDrawer-cs"><a href="#EditDisabledDrawer-cs" class="headerlink" title="EditDisabledDrawer.cs"></a>EditDisabledDrawer.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> UNITY_EDITOR</span><br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><br><span class="hljs-comment">// EditDisabledAttribute的自定义绘制器</span><br>[<span class="hljs-meta">CustomPropertyDrawer(typeof(EditDisabledAttribute))</span>]<br><span class="hljs-keyword">class</span> <span class="hljs-title">EditDisabledDrawer</span> : <span class="hljs-title">PropertyDrawer</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">float</span> <span class="hljs-title">GetPropertyHeight</span>(<span class="hljs-params">SerializedProperty property, GUIContent label</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> EditorGUI.GetPropertyHeight(property, label, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnGUI</span>(<span class="hljs-params">Rect position, SerializedProperty property, GUIContent label</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (IsArray() || IsList())<br>        &#123;<br>            EditorGUI.BeginDisabledGroup(<span class="hljs-literal">true</span>);<br>            EditorGUI.PropertyField(position, property, label, <span class="hljs-literal">true</span>);<br>            EditorGUI.EndDisabledGroup();<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            GUI.enabled = <span class="hljs-literal">false</span>;<br>            EditorGUI.PropertyField(position, property, label, <span class="hljs-literal">true</span>);<br>            GUI.enabled = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 是否为数组</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsArray</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> fieldInfo.FieldType.IsArray;<br>    &#125;<br><br>    <span class="hljs-comment">// 是否为列表</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">IsList</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> fieldInfo.FieldType.IsGenericType &amp;&amp; fieldInfo.FieldType.GetGenericTypeDefinition() == <span class="hljs-keyword">typeof</span>(List&lt;&gt;);<br>    &#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h2 id="界面展示"><a href="#界面展示" class="headerlink" title="界面展示"></a>界面展示</h2><img src="/posts/2026/01/04/7ed673d41718/img1.png" class="" width="352" height="240">]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Demo】场景加载</title>
      
      <link href="/posts/2026/01/03/eff7987880b4/"/>
      <url>/posts/2026/01/03/eff7987880b4/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>场景加载是游戏开发中必不可少的环节，本文初步探索了场景加载以及加载过程中的资源处理。</p><h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><div class="bilibili">    <iframe        src="//player.bilibili.com/player.html?isOutside=true&aid=115836408826102&bvid=BV1RqiEBiEQ2&cid=35184968052&p=1&autoplay=false"        scrolling="no"        border="0"        frameborder="no"        framespacing="0"        allowfullscreen="true">    </iframe></div><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/10nTZ15qveBg34E4mArqx0g?pwd=1314">百度网盘（提取码：1314）</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
            <tag> Demo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【Attribute】Inspector视图枚举字段范围限定特性</title>
      
      <link href="/posts/2026/01/03/52c958b9502c/"/>
      <url>/posts/2026/01/03/52c958b9502c/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了提升枚举的复用性，有时候我们可以通过限定枚举字段的范围来避免定义新的枚举类型，例如有一个代表方向的枚举（包括None，Left，Up，Right，Down），全局方向（Left，Up，Right，Down），水平方向（Left，Right），竖直方向（Up，Down）。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="EnumRangeAttribute-cs"><a href="#EnumRangeAttribute-cs" class="headerlink" title="EnumRangeAttribute.cs"></a>EnumRangeAttribute.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举范围限定特性</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>[<span class="hljs-meta">AttributeUsage(AttributeTargets.Field, AllowMultiple = false, Inherited = false)</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnumRangeAttribute</span> : <span class="hljs-title">PropertyAttribute</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举最小值</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mMin &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举最大值</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mMax &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举名称合集</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>[] mEnumNames &#123; <span class="hljs-keyword">get</span> =&gt; enumNames?.ToArray(); &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举值合集</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>[] mEnumValues &#123; <span class="hljs-keyword">get</span> =&gt; enumValues?.ToArray(); &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举范围特性模式</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> EnumRangeMode mEnumRangeMode &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span>[] enumNames;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span>[] enumValues;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;min&quot;&gt;</span>枚举最小值<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;max&quot;&gt;</span>枚举最大值<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EnumRangeAttribute</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> min, <span class="hljs-built_in">int</span> max</span>)</span><br>    &#123;<br>        mMin = min;<br>        mMax = max;<br>        mEnumRangeMode = EnumRangeMode.MinAndMax;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;enumNames&quot;&gt;</span>枚举名称合集 (大小写敏感)<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EnumRangeAttribute</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">string</span>[] enumNames</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.enumNames = enumNames;<br>        mEnumRangeMode = EnumRangeMode.EnumNames;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;enumValues&quot;&gt;</span>枚举值合集<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EnumRangeAttribute</span>(<span class="hljs-params"><span class="hljs-built_in">int</span>[] enumValues</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.enumValues = enumValues;<br>        mEnumRangeMode = EnumRangeMode.EnumValues;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举范围特性模式</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> EnumRangeMode<br>    &#123;<br>        MinAndMax, EnumNames, EnumValues<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="EnumRangeAttributeDrawer-cs"><a href="#EnumRangeAttributeDrawer-cs" class="headerlink" title="EnumRangeAttributeDrawer.cs"></a>EnumRangeAttributeDrawer.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> UNITY_EDITOR</span><br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Linq;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 枚举范围限定特性绘制器</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>[<span class="hljs-meta">CustomPropertyDrawer(typeof(EnumRangeAttribute))</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnumRangeAttributeDrawer</span> : <span class="hljs-title">PropertyDrawer</span><br>&#123;<br>    <span class="hljs-keyword">private</span> EnumRangeAttribute enumRangeAttribute; <span class="hljs-comment">// 枚举范围特性</span><br>    <span class="hljs-keyword">private</span> Type enumType; <span class="hljs-comment">// 枚举类型</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span>[] rawEnumNames; <span class="hljs-comment">// 枚举名称原始合集</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span>[] displayNames; <span class="hljs-comment">// 下拉菜单显示名称合集</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> selectedIndex; <span class="hljs-comment">// 当前所选中的选项索引</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> preIndex; <span class="hljs-comment">// 所选中的选项索引的副本</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isLockGUI; <span class="hljs-comment">// 是否锁定GUI的绘制</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isInit; <span class="hljs-comment">// 是否初始化</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> warningText; <span class="hljs-comment">// 警告信息</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> preWarningText; <span class="hljs-comment">// 警告信息副本</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">float</span> <span class="hljs-title">GetPropertyHeight</span>(<span class="hljs-params">SerializedProperty property, GUIContent label</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> EditorGUI.GetPropertyHeight(property, label, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnGUI</span>(<span class="hljs-params">Rect position, SerializedProperty property, GUIContent label</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (fieldInfo.FieldType.IsEnum)<br>        &#123;<br>            Init(property);<br>            <span class="hljs-keyword">if</span> (!isLockGUI)<br>            &#123;<br>                selectedIndex = EditorGUI.Popup(position, label, selectedIndex, displayNames.Select(n =&gt; <span class="hljs-keyword">new</span> GUIContent(n)).ToArray());<br>                <span class="hljs-keyword">if</span> (selectedIndex != preIndex)<br>                &#123;<br>                    preIndex = selectedIndex;<br>                    property.enumValueIndex = IndexOf(displayNames[selectedIndex]);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> warningText = <span class="hljs-string">$&quot;Warning:The type of the field &#x27;<span class="hljs-subst">&#123;fieldInfo.Name&#125;</span>&#x27; marked with &#x27;EnumRange&#x27; attribute is not &#x27;Enum&#x27;.&quot;</span>;<br>        <span class="hljs-keyword">if</span> (!warningText.Equals(preWarningText))<br>        &#123;<br>            Debug.LogWarning(warningText);<br>            preWarningText = warningText;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Init</span>(<span class="hljs-params">SerializedProperty property</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!isInit)<br>        &#123;<br>            isLockGUI = <span class="hljs-literal">true</span>;<br>            isInit = <span class="hljs-literal">true</span>;<br><br>            enumRangeAttribute = (EnumRangeAttribute)attribute;<br>            <span class="hljs-keyword">if</span> (enumRangeAttribute == <span class="hljs-literal">null</span>)<br>            &#123;<br>                warningText = <span class="hljs-string">$&quot;Warning:The field &#x27;<span class="hljs-subst">&#123;fieldInfo.Name&#125;</span>&#x27; is not marked &#x27;EnumRange&#x27; attribute.&quot;</span>;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            enumType = fieldInfo.FieldType;<br><br>            rawEnumNames = property.enumNames;<br>            <span class="hljs-keyword">if</span> (rawEnumNames == <span class="hljs-literal">null</span> || rawEnumNames.Length == <span class="hljs-number">0</span>)<br>            &#123;<br>                warningText = <span class="hljs-string">$&quot;Warning:The enum&#x27;s names of the field &#x27;<span class="hljs-subst">&#123;property.name&#125;</span>&#x27; is null or empty.&quot;</span>;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!InitDisplayNames()) displayNames = rawEnumNames;<br><br>            selectedIndex = Array.FindIndex(displayNames, n =&gt; n.Equals(rawEnumNames[property.enumValueIndex]));<br>            <span class="hljs-keyword">if</span> (selectedIndex == <span class="hljs-number">-1</span>) selectedIndex = <span class="hljs-number">0</span>;<br>            preIndex = selectedIndex;<br><br>            warningText = <span class="hljs-built_in">string</span>.Empty;<br>            preWarningText = <span class="hljs-built_in">string</span>.Empty;<br>            isLockGUI = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 初始化枚举下拉菜单显示名称合集</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitDisplayNames</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">switch</span> (enumRangeAttribute.mEnumRangeMode)<br>        &#123;<br>            <span class="hljs-keyword">case</span> EnumRangeAttribute.EnumRangeMode.MinAndMax:<br>                <span class="hljs-keyword">return</span> MinAndMaxInit();<br>            <span class="hljs-keyword">case</span> EnumRangeAttribute.EnumRangeMode.EnumNames:<br>                <span class="hljs-keyword">return</span> EnumNamesInit();<br>            <span class="hljs-keyword">case</span> EnumRangeAttribute.EnumRangeMode.EnumValues:<br>                <span class="hljs-keyword">return</span> EnumValuesInit();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// MinAndMax模式初始化</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">MinAndMaxInit</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (enumRangeAttribute.mMin &gt; enumRangeAttribute.mMax) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">var</span> v_values = Enum.GetValues(enumType).Cast&lt;<span class="hljs-built_in">int</span>&gt;();<br>        <span class="hljs-keyword">if</span> (v_values.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        v_values = v_values.Where(val =&gt; val &gt;= enumRangeAttribute.mMin &amp;&amp; val &lt;= enumRangeAttribute.mMax);<br>        <span class="hljs-keyword">if</span> (v_values.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">var</span> v_names = v_values.Select(val =&gt; Enum.GetName(enumType, val));<br>        <span class="hljs-keyword">if</span> (v_names.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        displayNames = v_names.ToArray();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// EnumNames模式初始化</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">EnumNamesInit</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (enumRangeAttribute.mEnumNames == <span class="hljs-literal">null</span> || enumRangeAttribute.mEnumNames.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">var</span> v_names = enumRangeAttribute.mEnumNames.Where(n =&gt; Array.FindIndex(rawEnumNames, en =&gt; en.Equals(n)) != <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (v_names.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        displayNames = v_names.ToArray();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// EnumValues模式初始化</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">EnumValuesInit</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (enumRangeAttribute.mEnumValues == <span class="hljs-literal">null</span> || enumRangeAttribute.mEnumValues.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">var</span> v_values = Enum.GetValues(enumType).Cast&lt;<span class="hljs-built_in">int</span>&gt;();<br>        <span class="hljs-keyword">if</span> (v_values.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        v_values = v_values.Where(val =&gt; enumRangeAttribute.mEnumValues.Contains(val));<br>        <span class="hljs-keyword">if</span> (v_values.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">var</span> v_names = v_values.Select(val =&gt; Enum.GetName(enumType, val));<br>        <span class="hljs-keyword">if</span> (v_names.Count() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        displayNames = v_names.ToArray();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 返回指定名称的枚举在原始枚举合集中的索引</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> <span class="hljs-title">IndexOf</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> enumName</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> index = Array.FindIndex(rawEnumNames, n =&gt; n.Equals(enumName));<br>        <span class="hljs-keyword">return</span> index == <span class="hljs-number">-1</span> ? <span class="hljs-number">0</span> : index;<br>    &#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h2 id="界面展示"><a href="#界面展示" class="headerlink" title="界面展示"></a>界面展示</h2><img src="/posts/2026/01/03/52c958b9502c/img1.png" class="" width="353" height="149"><img src="/posts/2026/01/03/52c958b9502c/img2.png" class="" width="354" height="150"><img src="/posts/2026/01/03/52c958b9502c/img3.png" class="" width="353" height="155">]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>【组件初始化链条】简化Unity组件的初始化</title>
      
      <link href="/posts/2026/01/03/194220123af3/"/>
      <url>/posts/2026/01/03/194220123af3/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在游戏脚本中我们通过借助GetComponent或TryGetComponent方法获取组件，所以当需要获取较多组件时，我们不可避免地要书写一些重复代码，为了提升代码简洁程度，简化组件初始化逻辑，本文以”组件初始化链条”为核心探索组件的初始化。</p><p>我们对于组件初始化面临以下几个问题：</p><ol><li>当需要从同一个游戏对象上获取不同组件时，如何简化？</li><li>当获取组件时还需要对组件进行初始化或者获取组件的字段或属性，如何简化？</li><li>当需要从多个游戏对象上获取相同类型组件时，如何简化？</li></ol><p>事实上，组件获取的逻辑大同小异，主要依赖于GetComponent或TryGetComponent方法，所以我们只需要关注从哪个GameObject上获取哪个Component即可，如果涉及到对组件进行一些自定义的处理，我们则可以借助委托类型的参数。除此之外，对于当前脚本而言，所需要的组件往往是必要的，缺一不可，所以我们仅关注所有组件是否被正确初始化，通过”组件初始化链条”则可以获取一个总的初始化结果值，如果需要自定义初始化结果值的收集可以自行改进本文代码。</p><p>相较于手动初始化，我们需要重复书写GetComponent或TryGetComponent方法的调用，并且需要手动对每个组件的初始化结果值进行收集，这并不利于开发者专注于游戏逻辑的开发。</p><p>采用统一的组件初始化方式，有利于团队协作，提升整体开发效率，方便组件初始化相关Bug的检测和处理。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="ComponentInitChain-cs"><a href="#ComponentInitChain-cs" class="headerlink" title="ComponentInitChain.cs"></a>ComponentInitChain.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 组件初始化链条</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ComponentInitChain</span><br>&#123;<br>    <span class="hljs-keyword">private</span> GameObject gameObject;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;gameObject&quot;&gt;</span>组件所挂载的游戏对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ComponentInitChain</span>(<span class="hljs-params">GameObject gameObject</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.gameObject = gameObject;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>组件类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>当前组件初始化链条实例<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ComponentInitChain <span class="hljs-title">InitComponent</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T component</span>) <span class="hljs-keyword">where</span> T : Component</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (gameObject == <span class="hljs-literal">null</span> || !gameObject.TryGetComponent(<span class="hljs-keyword">out</span> component)) component = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>组件类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;componentDeal&quot;&gt;</span>组件获取后的初始化处理<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>当前组件初始化链条实例<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ComponentInitChain <span class="hljs-title">InitComponent</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T component, Action&lt;T&gt; componentDeal</span>) <span class="hljs-keyword">where</span> T : Component</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (gameObject == <span class="hljs-literal">null</span> || !gameObject.TryGetComponent(<span class="hljs-keyword">out</span> component)) component = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (component != <span class="hljs-literal">null</span>) componentDeal(component);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>组件类型0<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>组件类型1<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>T0类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component1&quot;&gt;</span>T1类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>初始化结果值，组件均正确初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponent</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T0 component, <span class="hljs-keyword">out</span> T1 component1</span>) <span class="hljs-keyword">where</span> T0 : Component <span class="hljs-keyword">where</span> T1 : Component</span><br>    &#123;<br>        InitComponent(<span class="hljs-keyword">out</span> component).InitComponent(<span class="hljs-keyword">out</span> component1);<br>        <span class="hljs-keyword">if</span> (component == <span class="hljs-literal">null</span> || component1 == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>组件类型0<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>组件类型1<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T2&quot;&gt;</span>组件类型2<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>T0类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component1&quot;&gt;</span>T1类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component2&quot;&gt;</span>T2类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>初始化结果值，组件均正确初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponent</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T0 component, <span class="hljs-keyword">out</span> T1 component1, <span class="hljs-keyword">out</span> T2 component2</span>)</span><br><span class="hljs-function">    <span class="hljs-keyword">where</span> T0 : Component <span class="hljs-keyword">where</span> T1 : Component <span class="hljs-keyword">where</span> T2 : Component</span><br>    &#123;<br>        InitComponent(<span class="hljs-keyword">out</span> component).InitComponent(<span class="hljs-keyword">out</span> component1).InitComponent(<span class="hljs-keyword">out</span> component2);<br>        <span class="hljs-keyword">if</span> (component == <span class="hljs-literal">null</span> || component1 == <span class="hljs-literal">null</span> || component2 == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>组件类型0<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>组件类型1<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T2&quot;&gt;</span>组件类型2<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T3&quot;&gt;</span>组件类型3<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>T0类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component1&quot;&gt;</span>T1类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component2&quot;&gt;</span>T2类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component3&quot;&gt;</span>T3类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>初始化结果值，组件均正确初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponent</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>, <span class="hljs-title">T3</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T0 component, <span class="hljs-keyword">out</span> T1 component1, <span class="hljs-keyword">out</span> T2 component2, <span class="hljs-keyword">out</span> T3 component3</span>)</span><br><span class="hljs-function">    <span class="hljs-keyword">where</span> T0 : Component <span class="hljs-keyword">where</span> T1 : Component <span class="hljs-keyword">where</span> T2 : Component <span class="hljs-keyword">where</span> T3 : Component</span><br>    &#123;<br>        InitComponent(<span class="hljs-keyword">out</span> component).InitComponent(<span class="hljs-keyword">out</span> component1).InitComponent(<span class="hljs-keyword">out</span> component2).InitComponent(<span class="hljs-keyword">out</span> component3);<br>        <span class="hljs-keyword">if</span> (component == <span class="hljs-literal">null</span> || component1 == <span class="hljs-literal">null</span> || component2 == <span class="hljs-literal">null</span> || component3 == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ComponentsInitChain-cs"><a href="#ComponentsInitChain-cs" class="headerlink" title="ComponentsInitChain.cs"></a>ComponentsInitChain.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 组成集初始化链条</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ComponentsInitChain</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件集</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>组件类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;components&quot;&gt;</span>组件集的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;gameObjects&quot;&gt;</span>组件所挂载的游戏对象集<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>组件集初始化结果值，若所有组件成功初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">in</span> T[] components, <span class="hljs-keyword">params</span> GameObject[] gameObjects</span>) <span class="hljs-keyword">where</span> T : Component</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (components == <span class="hljs-literal">null</span> || components.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (gameObjects == <span class="hljs-literal">null</span> || gameObjects.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (components.Length == gameObjects.Length)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; gameObjects.Length; i++)<br>            &#123;<br>                components[i] = gameObjects[i].GetComponent&lt;T&gt;();<br>            &#125;<br>            <span class="hljs-keyword">return</span> components.All(c =&gt; c != <span class="hljs-literal">null</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件集</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>组件类型0<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>组件类型1<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>T0类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component1&quot;&gt;</span>T1类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;gameObjects&quot;&gt;</span>T0、T1类型组件所挂载的游戏对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>组件初始化结果值，若所有组件成功初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T0 component, <span class="hljs-keyword">out</span> T1 component1, <span class="hljs-keyword">params</span> GameObject[] gameObjects</span>)</span><br><span class="hljs-function">    <span class="hljs-keyword">where</span> T0 : Component <span class="hljs-keyword">where</span> T1 : Component</span><br>    &#123;<br>        component = <span class="hljs-literal">null</span>;<br>        component1 = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (gameObjects?.Length == <span class="hljs-number">2</span>)<br>        &#123;<br>            component = gameObjects[<span class="hljs-number">0</span>].GetComponent&lt;T0&gt;();<br>            component1 = gameObjects[<span class="hljs-number">1</span>].GetComponent&lt;T1&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> component != <span class="hljs-literal">null</span> &amp;&amp; component1 != <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件集</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>组件类型0<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>组件类型1<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T2&quot;&gt;</span>组件类型2<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>T0类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component1&quot;&gt;</span>T1类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component2&quot;&gt;</span>T2类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;gameObjects&quot;&gt;</span>T0、T1、T2类型组件所挂载的游戏对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>组件初始化结果值，若所有组件成功初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T0 component, <span class="hljs-keyword">out</span> T1 component1, <span class="hljs-keyword">out</span> T2 component2, <span class="hljs-keyword">params</span> GameObject[] gameObjects</span>)</span><br><span class="hljs-function">    <span class="hljs-keyword">where</span> T0 : Component <span class="hljs-keyword">where</span> T1 : Component <span class="hljs-keyword">where</span> T2 : Component</span><br>    &#123;<br>        component = <span class="hljs-literal">null</span>;<br>        component1 = <span class="hljs-literal">null</span>;<br>        component2 = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (gameObjects?.Length == <span class="hljs-number">3</span>)<br>        &#123;<br>            component = gameObjects[<span class="hljs-number">0</span>].GetComponent&lt;T0&gt;();<br>            component1 = gameObjects[<span class="hljs-number">1</span>].GetComponent&lt;T1&gt;();<br>            component2 = gameObjects[<span class="hljs-number">2</span>].GetComponent&lt;T2&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> component != <span class="hljs-literal">null</span> &amp;&amp; component1 != <span class="hljs-literal">null</span> &amp;&amp; component2 != <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化组件集</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>组件类型0<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>组件类型1<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T2&quot;&gt;</span>组件类型2<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T3&quot;&gt;</span>组件类型3<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component&quot;&gt;</span>T0类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component1&quot;&gt;</span>T1类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component2&quot;&gt;</span>T2类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;component3&quot;&gt;</span>T3类型组件的引用变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;gameObjects&quot;&gt;</span>T0、T1、T2、T3类型组件所挂载的游戏对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>组件初始化结果值，若所有组件成功初始化则返回true，否则返回false<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitComponents</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>, <span class="hljs-title">T2</span>, <span class="hljs-title">T3</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">out</span> T0 component, <span class="hljs-keyword">out</span> T1 component1, <span class="hljs-keyword">out</span> T2 component2, <span class="hljs-keyword">out</span> T3 component3, <span class="hljs-keyword">params</span> GameObject[] gameObjects</span>)</span><br><span class="hljs-function">    <span class="hljs-keyword">where</span> T0 : Component <span class="hljs-keyword">where</span> T1 : Component <span class="hljs-keyword">where</span> T2 : Component <span class="hljs-keyword">where</span> T3 : Component</span><br>    &#123;<br>        component = <span class="hljs-literal">null</span>;<br>        component1 = <span class="hljs-literal">null</span>;<br>        component2 = <span class="hljs-literal">null</span>;<br>        component3 = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (gameObjects?.Length == <span class="hljs-number">4</span>)<br>        &#123;<br>            component = gameObjects[<span class="hljs-number">0</span>].GetComponent&lt;T0&gt;();<br>            component1 = gameObjects[<span class="hljs-number">1</span>].GetComponent&lt;T1&gt;();<br>            component2 = gameObjects[<span class="hljs-number">2</span>].GetComponent&lt;T2&gt;();<br>            component3 = gameObjects[<span class="hljs-number">3</span>].GetComponent&lt;T3&gt;();<br>        &#125;<br>        <span class="hljs-keyword">return</span> component != <span class="hljs-literal">null</span> &amp;&amp; component1 != <span class="hljs-literal">null</span> &amp;&amp; component2 != <span class="hljs-literal">null</span> &amp;&amp; component3 != <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> GameObject[] GameObjects;<br>    <span class="hljs-keyword">private</span> AudioListener audioListener;<br>    <span class="hljs-keyword">private</span> SpriteRenderer spriteRenderer;<br>    <span class="hljs-keyword">private</span> CircleCollider2D circleCollider2D;<br>    <span class="hljs-keyword">private</span> Room[] rooms;<br>    <span class="hljs-keyword">private</span> Room a;<br>    <span class="hljs-keyword">private</span> Room b;<br>    <span class="hljs-keyword">private</span> Room c;<br>    <span class="hljs-keyword">private</span> Room d;<br>    <span class="hljs-keyword">private</span> Sprite sprite;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-comment">// 组件链式初始化，适用于该情景&quot;需要获取同一个游戏对象上较多的组件且针对不同组件存在不同的初始化逻辑&quot;</span><br>        <span class="hljs-comment">// new ComponentInitChain(gameObject).InitComponent(out audioListener)</span><br>        <span class="hljs-comment">// .InitComponent(out spriteRenderer, c =&gt; sprite = c.sprite)</span><br>        <span class="hljs-comment">// .InitComponent(out circleCollider2D, c =&gt; c.isTrigger = true);</span><br><br>        <span class="hljs-comment">// 组件单步初始化，适用于该情景&quot;需要获取同一个游戏对象上较少的组件，不需要对各组件的初始化进行代理&quot;</span><br>        <span class="hljs-comment">// bool res = new ComponentInitChain(gameObject).InitComponent(out audioListener, out spriteRenderer, out circleCollider2D);</span><br>        <span class="hljs-comment">// Debug.Log(res);</span><br>        <span class="hljs-comment">// Debug.Log(audioListener);</span><br>        <span class="hljs-comment">// Debug.Log(spriteRenderer);</span><br>        <span class="hljs-comment">// Debug.Log(circleCollider2D);</span><br><br>        <span class="hljs-comment">// 获取不同游戏对象上的某种组件类型的组件合集</span><br>        <span class="hljs-comment">// rooms = new Room[GameObjects.Length];</span><br>        <span class="hljs-comment">// bool res = ComponentsInitChain.InitComponents(rooms, GameObjects);</span><br>        <span class="hljs-comment">// Debug.Log(res);</span><br>        <span class="hljs-comment">// for (int i = 0; i &lt; rooms?.Length; i++)</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     Debug.Log(rooms[i]);</span><br>        <span class="hljs-comment">// &#125;</span><br><br>        <span class="hljs-comment">// 获取不同游戏对象上的相同类型组件</span><br>        <span class="hljs-comment">// bool res = ComponentsInitChain.InitComponents(out a, out b, out c, out d, GameObjects);</span><br>        <span class="hljs-comment">// Debug.Log(res);</span><br>        <span class="hljs-comment">// Debug.Log(a);</span><br>        <span class="hljs-comment">// Debug.Log(b);</span><br>        <span class="hljs-comment">// Debug.Log(c);</span><br>        <span class="hljs-comment">// Debug.Log(d);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>ComponentInitChain适用于对单个游戏对象的组件进行初始化的情景，所以在实例化时需要传递对应的游戏对象，后续的组件初始化操作都针对该游戏对象。</p><p>ComponentsInitChain适用于对多个游戏对象的组件进行初始化的情景，相关方法都属于静态方法，所以调用方法时需要传递游戏对象。</p><p>测试代码中则针对四种常见的应用情况进行举例。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>对LitJson开源插件的自定义尝试</title>
      
      <link href="/posts/2026/01/03/24b96067bf3c/"/>
      <url>/posts/2026/01/03/24b96067bf3c/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://litjson.net/">LitJson</a>是一款知名的Json字符串数据转换的插件，基于.Net开发，使用C#作为开发语言。本文旨在基于所学的编程知识以及对LitJson源码的理解来尝试对LitJson插件进行自定义。</p><h2 id="自定义思路"><a href="#自定义思路" class="headerlink" title="自定义思路"></a>自定义思路</h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>结合我在使用LitJson过程中遇到的问题，主要针对四个常见问题进行自定义：</p><blockquote><p><strong>问题1：</strong> 当我们通过RegisterExporter方法自定义指定类型的序列化规则时，对于类型控制更加严格，而当我对Type类型自定义序列化规则时出现了序列化深度溢出的问题，我根据LitJson的源码进行了调试。首先我们通过RegisterExporter方法需要指定泛型，这个指定的序列化类型以编译时类型存储于字典中，因为typeof(T)获取的是编译时类型,而在WriteValue方法中对于非基本类型需要通过obj.GetType()获取一个obj对象的Type实例,而在代码运行过程中此方法将返回一个运行时类型，这个运行时类型被认为与我们存入字典中的对应类型不同。这在外部看来我只是希望自定义Type类型的序列化规则能够成功执行，而在对Type类型变量进行序列化时却未能执行我自定义的序列化规则，导致这个原因的问题就是对于Type而言，字典中存储的是System.Type，而obj.GetType()获取的Type实例是System.RuntimeType，所以二者不相同，未通过字典的ContainsKey检测，于是无法调用针对Type类型的自定义序列化规则，从而导致序列化深度溢出。</p></blockquote><blockquote><p><strong>问题2：</strong> 某些字段或属性我们不希望被序列化。</p></blockquote><blockquote><p><strong>问题3：</strong> 某些私有字段或属性我们希望能够被序列化。</p></blockquote><blockquote><p><strong>问题4：</strong> 同一类型的字段或属性在不同的结构中的序列化规则可能有所不同，所以全局的序列化规则将不适用，我们需要扩展出局部的序列化规则，以便于用户能够在不同结构中对同一类型的字段或属性的序列化规则进行自定义，这将进一步提高该插件的灵活性，反序列化亦是如此。优先级应为局部规则&gt;全局规则。</p></blockquote><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>针对上述四个问题的解决方案如下：</p><blockquote><p><strong>方案1：</strong> 原本字典的ContainsKey检测更加严格，是通过Type.Equals()进行检测的，所以不会包括派生关系的检测,实际上obj is xxx通过is关键字判断也是会有派生关系的检测的，既然对于基本类型的检测是放宽了检测的严格程度，那么对于非基本类型也可以放宽一下检测的严格程度，于是我们引入了可过渡检测的策略，这个策略的实现是通过Type.IsAssignableFrom()来实现的，我们通过obj.GetType()获取的类型如果能够转换为字典中存放的类型，那么就被认为通过字典的ContainsKey检测。我们应该让用户来控制是否开启可过渡检测，因为并非所有类型都像Type类型一样特殊，而默认不开启可过渡检测，可过渡检测仅用于针对某些特殊类型的检测处理，默认情况下我们对序列化类型的控制依旧严格。当用户自定义的某个类型的序列化规则无法正常执行时，可以考虑使用该方法作为替补方案。</p><p>当我们通过RegisterExporter所注册的类型(编译时类型)与运行时通过GetType()获取的类型(运行时类型)不同，导致未通过字典的ContainsKey检测而无法执行自定义的序列化规则，此方法可开启派生关系的可过渡检测，如果当前运行时类型可以转换为所注册的编译时类型(允许具有派生关系的类型的转换)，那么我们就认为通过字典的ContainsKey检测并执行对应编译时类型的自定义序列化规则。当一个对象的编译时类型和运行时类型不同时可以考虑使用这个方法作为辅助方法，例如Type类型、接口类型、抽象类类型的字段或属性。</p></blockquote><blockquote><p><strong>方案2：</strong> 定义一个JsonIgnore的Attribute，用于标记不进行序列化的字段或属性，在JsonMapper的WriteValue和ReadValue方法中添加检测代码。</p></blockquote><blockquote><p><strong>方案3：</strong> 定义一个JsonInclude的Attribute，用于标记进行序列化的私有字段或属性，在JsonMapper的WriteValue和ReadValue方法中添加检测代码。</p></blockquote><blockquote><p><strong>方案4：</strong> 设字段或属性类型为A，定义字段或属性所在结构的类型为B，序列化或反序列化规则为C，Json数据类型D。</p><p>序列化：原有的对应关系是A&#x3D;&gt;C（字段或属性类型对应序列化规则），即&lt;Type,ExportFunc&gt;，现在我们需要建立的新的对应关系是(A+B)&#x3D;&gt;C（字段或属性类型+定义字段或属性所在结构的类型共同对应序列化规则），即&lt;Type, &lt;Type,ExportFunc&gt;&gt;。</p><p>反序列化：原有的对应关系是(A+D)&#x3D;&gt;C（字段或属性类型+Json数据类型对应反序列化规则），即&lt;Type,&lt;Type,ImportFunc&gt;&gt;，现在我们需要建立的新的对应关系是(A+B+D)&#x3D;&gt;C（字段或属性类型+定义字段或属性所在结构的类型+Json数据类型对应反序列化规则），即&lt;&lt;Type,Type&gt;,&lt;Type,ImportFunc&gt;&gt;。</p><p>建议：对于这种嵌套过多的关系，建议定义一个单独的类或结构体来存储它们的关系。</p></blockquote><p>方案1-4分别对应问题1-4，其中方案1涉及自定义特性[JsonAssignable]，方案2涉及自定义特性[JsonIgnore]，方案3涉及自定义特性[JsonInclude]，方案4涉及自定义特性[ExporterTarget]。</p><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><blockquote><p>全称：JsonAssignableAttribute<br>缩写：[JsonAssignable]<br>使用范围：field、property<br>限制：不允许继承、不允许重复标记<br>说明：该Attribute用于标记需要进行可过渡性检测的字段或属性。</p></blockquote><blockquote><p>全称：JsonIgnoreAttribute<br>简写：[JsonIgnore]<br>使用范围：field、property<br>限制：不允许继承、不允许重复标记<br>说明：定义用于标记不进行序列化的字段或属性的Attribute</p></blockquote><blockquote><p>全称：JsonIncludeAttribute<br>简写：[JsonInclude]<br>使用范围：field、property<br>限制：不允许继承、不允许重复标记<br>说明：定义用于标记待序列化的私有字段或属性的Attribute</p></blockquote><blockquote><p>全称：ExporterTargetAttribute(Type classType)<br>缩写：[ExporterTarget]<br>使用范围：class、struct、interface<br>限制：不允许继承、不允许重复标记<br>说明：当使用RegisterExporter&lt;T,TClass&gt;(ExporterFunc<T> exporter)方法时，必须使用该Attribute标记对应序列化字段或属性所在的类。</p></blockquote><h3 id="其它自定义"><a href="#其它自定义" class="headerlink" title="其它自定义"></a>其它自定义</h3><ul><li><p>LitJson基于.NET开发，使用的是C#语言，所以可以应用于Unity3D游戏开发中，在本次自定义中我对Unity中常用的数据结构的序列化和反序列化进行了扩展，包括Vector2, Vector3, Vector4, Rect, Quaternion, Color, Bounds，以及C#的Type类型。</p></li><li><p>修改方法：</p></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">//原方法：</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterExporter</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">ExporterFunc&lt;T&gt; exporter</span>)</span><br><span class="hljs-function"><span class="hljs-comment">//修改后的方法：</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterExporter</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">ExporterFunc&lt;T&gt; exporter, <span class="hljs-built_in">bool</span> assignable = <span class="hljs-literal">false</span></span>)</span><br></code></pre></td></tr></table></figure><ul><li>添加方法：</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterExporter</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">TClass</span>&gt;(<span class="hljs-params">ExporterFunc&lt;T&gt; exporter, <span class="hljs-built_in">bool</span> assignable = <span class="hljs-literal">false</span></span>)</span><br></code></pre></td></tr></table></figure><ul><li>添加方法：</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterImporter</span>&lt;<span class="hljs-title">TJson</span>, <span class="hljs-title">TValue</span>, <span class="hljs-title">TClass</span>&gt;(<span class="hljs-params">ImporterFunc&lt;TJson, TValue&gt; importer</span>)</span><br></code></pre></td></tr></table></figure><ul><li>添加方法：</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterImporterWithReader</span>&lt;<span class="hljs-title">TValue</span>&gt;(<span class="hljs-params">ImporterFunc&lt;CustomReader, TValue&gt; importer</span>)</span><br></code></pre></td></tr></table></figure><ul><li>添加方法：</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RegisterImporterWithReader</span>&lt;<span class="hljs-title">TValue</span>, <span class="hljs-title">TClass</span>&gt;(<span class="hljs-params">ImporterFunc&lt;CustomReader, TValue&gt; importer</span>)</span><br></code></pre></td></tr></table></figure><ul><li>添加类CustomReader和ReaderData</li></ul><h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><h3 id="公共测试脚本"><a href="#公共测试脚本" class="headerlink" title="公共测试脚本"></a>公共测试脚本</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">interface</span> <span class="hljs-title">IPerson</span><br>&#123;<br>    <span class="hljs-built_in">string</span> mName &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>    <span class="hljs-built_in">int</span> mAge &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title">PersonD</span> : <span class="hljs-title">IPerson</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mName &#123; <span class="hljs-keyword">get</span> =&gt; name; <span class="hljs-keyword">set</span> =&gt; name = <span class="hljs-keyword">value</span>; &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mAge &#123; <span class="hljs-keyword">get</span> =&gt; age; <span class="hljs-keyword">set</span> =&gt; age = <span class="hljs-keyword">value</span>; &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mSex &#123; <span class="hljs-keyword">get</span> =&gt; sex; <span class="hljs-keyword">set</span> =&gt; sex = <span class="hljs-keyword">value</span>; &#125;<br><br>    <span class="hljs-built_in">string</span> name;<br>    <span class="hljs-built_in">int</span> age;<br>    <span class="hljs-built_in">string</span> sex;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mAge:<span class="hljs-subst">&#123;mAge&#125;</span>, mSex:<span class="hljs-subst">&#123;mSex&#125;</span>]&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">House</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mName;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">float</span> mSize;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试JsonAssignable特性：公共接口类型字段"><a href="#测试JsonAssignable特性：公共接口类型字段" class="headerlink" title="测试JsonAssignable特性：公共接口类型字段"></a>测试JsonAssignable特性：公共接口类型字段</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> LitJson.Extensions;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JATest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ja_test1</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/JsonAssignable Test/Run the Test1&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【测试JsonAssignable特性：公共接口类型字段】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            PersonD person = <span class="hljs-keyword">new</span> PersonD<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span>,<br>                mSex = <span class="hljs-string">&quot;Male&quot;</span><br>            &#125;;<br>            JAHouseA houseA = <span class="hljs-keyword">new</span> JAHouseA()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span>,<br>                person = person<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseA);<br>            Debug.Log(jsonStr);<br>            JAHouseA houseA1 = JsonMapper.ToObject&lt;JAHouseA&gt;(jsonStr);<br>            Debug.Log(houseA1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">JAHouseA</span> : <span class="hljs-title">House</span><br>    &#123;<br>        [<span class="hljs-meta">JsonAssignable</span>] <span class="hljs-keyword">public</span> IPerson person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试JsonAssignable特性：公共抽象类类型字段"><a href="#测试JsonAssignable特性：公共抽象类类型字段" class="headerlink" title="测试JsonAssignable特性：公共抽象类类型字段"></a>测试JsonAssignable特性：公共抽象类类型字段</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> LitJson.Extensions;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JATest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ja_test2</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/JsonAssignable Test/Run the Test2&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【测试JsonAssignable特性：公共抽象类类型字段】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            JAHouseB houseB = <span class="hljs-keyword">new</span> JAHouseB()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span><br>            &#125;;<br>            JAPersonA person = <span class="hljs-keyword">new</span> JAPersonA<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span>,<br>                house = houseB<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(person);<br>            Debug.Log(jsonStr);<br>            JAPersonA personA = JsonMapper.ToObject&lt;JAPersonA&gt;(jsonStr);<br>            Debug.Log(personA);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">JAHouseB</span> : <span class="hljs-title">House</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">JAPersonA</span> : <span class="hljs-title">IPerson</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mName &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mAge &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        [<span class="hljs-meta">JsonAssignable</span>] <span class="hljs-keyword">public</span> House house;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mAge:<span class="hljs-subst">&#123;mAge&#125;</span>, house:<span class="hljs-subst">&#123;house&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试JsonIgnore特性：忽略公共字段"><a href="#测试JsonIgnore特性：忽略公共字段" class="headerlink" title="测试JsonIgnore特性：忽略公共字段"></a>测试JsonIgnore特性：忽略公共字段</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><span class="hljs-keyword">using</span> LitJson.Extensions;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JIATest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">jig_test1</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/JsonIgnore Test/Run the Test1&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【测试JsonIgnore特性：忽略公共字段】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            JIAPerson person = <span class="hljs-keyword">new</span> JIAPerson<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span><br>            &#125;;<br>            JIAHouseA houseA = <span class="hljs-keyword">new</span> JIAHouseA()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span>,<br>                person = person<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseA);<br>            Debug.Log(jsonStr);<br>            JIAHouseA houseA1 = JsonMapper.ToObject&lt;JIAHouseA&gt;(jsonStr);<br>            Debug.Log(houseA1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">JIAPerson</span> : <span class="hljs-title">IPerson</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mName &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mAge &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">JIAHouseA</span> : <span class="hljs-title">House</span><br>    &#123;<br>        [<span class="hljs-meta">JsonIgnore</span>] <span class="hljs-keyword">public</span> JIAPerson person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JIAHouseA</span>()</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JIAHouseA</span>(<span class="hljs-params">JIAPerson person</span>)</span> &#123; <span class="hljs-keyword">this</span>.person = person; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试JsonInclude特性：私有自定义类型字段"><a href="#测试JsonInclude特性：私有自定义类型字段" class="headerlink" title="测试JsonInclude特性：私有自定义类型字段"></a>测试JsonInclude特性：私有自定义类型字段</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> LitJson.Extensions;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JITest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ji_test1</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/JsonInclude Test/Run the Test1&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【测试JsonInclude特性：私有自定义类型字段】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            PersonD person = <span class="hljs-keyword">new</span> PersonD<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span>,<br>                mSex = <span class="hljs-string">&quot;Male&quot;</span><br>            &#125;;<br>            JIHouseA houseA = <span class="hljs-keyword">new</span> JIHouseA(person)<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span><br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseA);<br>            Debug.Log(jsonStr);<br>            JIHouseA houseA1 = JsonMapper.ToObject&lt;JIHouseA&gt;(jsonStr);<br>            Debug.Log(houseA1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">JIHouseA</span> : <span class="hljs-title">House</span><br>    &#123;<br>        [<span class="hljs-meta">JsonInclude</span>] <span class="hljs-keyword">private</span> PersonD person;<br><br>        <span class="hljs-comment">// 必要条件：当有多个构造函数时应主动声明公共无参构造函数</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JIHouseA</span>()</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JIHouseA</span>(<span class="hljs-params">PersonD person</span>)</span> &#123; <span class="hljs-keyword">this</span>.person = person; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试JsonInclude特性：私有自定义类型数组、列表和字典字段序列化和反序列化测试"><a href="#测试JsonInclude特性：私有自定义类型数组、列表和字典字段序列化和反序列化测试" class="headerlink" title="测试JsonInclude特性：私有自定义类型数组、列表和字典字段序列化和反序列化测试"></a>测试JsonInclude特性：私有自定义类型数组、列表和字典字段序列化和反序列化测试</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> LitJson.Extensions;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JITest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ji_test2</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/JsonInclude Test/Run the Test2&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【测试JsonInclude特性：私有自定义类型数组、列表和字典字段序列化和反序列化测试】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            PersonD personD = <span class="hljs-keyword">new</span> PersonD()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">20</span>,<br>                mSex = <span class="hljs-string">&quot;Male&quot;</span><br>            &#125;;<br>            PersonD personD2 = <span class="hljs-keyword">new</span> PersonD()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Lucy&quot;</span>,<br>                mAge = <span class="hljs-number">26</span>,<br>                mSex = <span class="hljs-string">&quot;Female&quot;</span><br>            &#125;;<br>            PersonD personD3 = <span class="hljs-keyword">new</span> PersonD()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Jack&quot;</span>,<br>                mAge = <span class="hljs-number">8</span>,<br>                mSex = <span class="hljs-string">&quot;Male&quot;</span><br>            &#125;;<br>            HouseF houseF = <span class="hljs-keyword">new</span> HouseF()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseF&quot;</span>,<br>                mSize = <span class="hljs-number">100</span><br>            &#125;;<br>            houseF[<span class="hljs-number">0</span>] = personD;<br>            houseF[<span class="hljs-number">1</span>] = personD2;<br>            houseF[<span class="hljs-number">2</span>] = personD3;<br>            houseF.AddToList(personD);<br>            houseF.AddToList(personD2);<br>            houseF.AddToList(personD3);<br>            houseF.AddToDict(personD.mName, personD);<br>            houseF.AddToDict(personD2.mName, personD2);<br>            houseF.AddToDict(personD3.mName, personD3);<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseF);<br>            Debug.Log(jsonStr);<br>            HouseF houseF1 = JsonMapper.ToObject&lt;HouseF&gt;(jsonStr);<br>            Debug.Log(houseF1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">HouseF</span> : <span class="hljs-title">House</span><br>    &#123;<br>        [<span class="hljs-meta">JsonInclude</span>] <span class="hljs-keyword">private</span> PersonD[] persons; <span class="hljs-comment">// 用于测试私有自定义类型数组</span><br>        [<span class="hljs-meta">JsonInclude</span>] <span class="hljs-keyword">private</span> List&lt;PersonD&gt; personList; <span class="hljs-comment">// 用于测试私有自定义类型列表</span><br>        [<span class="hljs-meta">JsonInclude</span>] <span class="hljs-keyword">private</span> Dictionary&lt;<span class="hljs-built_in">string</span>, PersonD&gt; personDict; <span class="hljs-comment">// 用于测试私有自定义类型字典</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> index;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HouseF</span>()</span><br>        &#123;<br>            persons = <span class="hljs-keyword">new</span> PersonD[<span class="hljs-number">3</span>];<br>            personList = <span class="hljs-keyword">new</span> List&lt;PersonD&gt;();<br>            personDict = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, PersonD&gt;();<br>            index = <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddToList</span>(<span class="hljs-params">PersonD person</span>)</span><br>        &#123;<br>            personList.Add(person);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddToDict</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, PersonD person</span>)</span><br>        &#123;<br>            personDict[name] = person;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> PersonD <span class="hljs-keyword">this</span>[<span class="hljs-built_in">int</span> index]<br>        &#123;<br>            <span class="hljs-keyword">get</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt;= <span class="hljs-keyword">this</span>.index) <span class="hljs-keyword">return</span> persons[index];<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-keyword">set</span> &#123; <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt; <span class="hljs-number">3</span>) persons[index] = <span class="hljs-keyword">value</span>; &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, &quot;</span>);<br>            stringBuilder.Append(<span class="hljs-string">&quot;Array:&#123;&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; persons.Length; i++)<br>            &#123;<br>                stringBuilder.Append(persons[i] + <span class="hljs-string">&quot;,&quot;</span>);<br>            &#125;<br>            stringBuilder.Append(<span class="hljs-string">&quot;&#125;, List:&#123;&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; personList.Count; i++)<br>            &#123;<br>                stringBuilder.Append(personList[i] + <span class="hljs-string">&quot;,&quot;</span>);<br>            &#125;<br>            stringBuilder.Append(<span class="hljs-string">&quot;&#125;, Dict:&#123;&quot;</span>);<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> key <span class="hljs-keyword">in</span> personDict.Keys)<br>            &#123;<br>                stringBuilder.Append(personDict[key] + <span class="hljs-string">&quot;,&quot;</span>);<br>            &#125;<br>            stringBuilder.Append(<span class="hljs-string">&quot;&#125;]&quot;</span>);<br>            <span class="hljs-keyword">return</span> stringBuilder.ToString();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="测试ExporterTarget特性：相同的自定义类型公共字段在不同的类中序列化规则不同"><a href="#测试ExporterTarget特性：相同的自定义类型公共字段在不同的类中序列化规则不同" class="headerlink" title="测试ExporterTarget特性：相同的自定义类型公共字段在不同的类中序列化规则不同"></a>测试ExporterTarget特性：相同的自定义类型公共字段在不同的类中序列化规则不同</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><span class="hljs-keyword">using</span> LitJson.Extensions;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">ETTest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">et_test1</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/ExporterTarget Test/Run the Test1&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【测试ExporterTarget特性：相同的自定义类型公共字段在不同的类中序列化规则不同】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            ETPersonA person = <span class="hljs-keyword">new</span> ETPersonA<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span><br>            &#125;;<br>            ETHouseA houseA = <span class="hljs-keyword">new</span> ETHouseA()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span>,<br>                person = person<br>            &#125;;<br>            ETHouseB houseB = <span class="hljs-keyword">new</span> ETHouseB()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseB&quot;</span>,<br>                mSize = <span class="hljs-number">50</span>,<br>                person = person<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseA);<br>            Debug.Log(jsonStr);<br>            ETHouseA houseA1 = JsonMapper.ToObject&lt;ETHouseA&gt;(jsonStr);<br>            Debug.Log(houseA1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-number">80</span>));<br>            jsonStr = JsonMapper.ToJson(houseB);<br>            Debug.Log(jsonStr);<br>            ETHouseB houseB1 = JsonMapper.ToObject&lt;ETHouseB&gt;(jsonStr);<br>            Debug.Log(houseB1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ETPersonA</span> : <span class="hljs-title">IPerson</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mName &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mAge &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mAge:<span class="hljs-subst">&#123;mAge&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    [<span class="hljs-meta">ExporterTarget(typeof(ETHouseA))</span>]<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ETHouseA</span> : <span class="hljs-title">House</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> ETPersonA person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">ETHouseA</span>()</span><br>        &#123;<br>            JsonMapper.RegisterExporter&lt;ETPersonA, ETHouseA&gt;((d, writer) =&gt;<br>            &#123;<br>                writer.WriteObjectStart();<br>                writer.WriteProperty(<span class="hljs-string">&quot;ETPersonA&quot;</span>, <span class="hljs-string">&quot;ETHouseA_ETPersonA&quot;</span>);<br>                writer.WriteObjectEnd();<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    [<span class="hljs-meta">ExporterTarget(typeof(ETHouseB))</span>]<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ETHouseB</span> : <span class="hljs-title">House</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> ETPersonA person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">ETHouseB</span>()</span><br>        &#123;<br>            JsonMapper.RegisterExporter&lt;ETPersonA, ETHouseB&gt;((d, writer) =&gt;<br>            &#123;<br>                writer.WriteObjectStart();<br>                writer.WriteProperty(<span class="hljs-string">&quot;ETPersonA&quot;</span>, <span class="hljs-string">&quot;ETHouseB_ETPersonA&quot;</span>);<br>                writer.WriteObjectEnd();<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Json4Unity：Type类型变量的序列化和反序列化"><a href="#Json4Unity：Type类型变量的序列化和反序列化" class="headerlink" title="Json4Unity：Type类型变量的序列化和反序列化"></a>Json4Unity：Type类型变量的序列化和反序列化</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><span class="hljs-keyword">using</span> System;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JUTest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ju_test1</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/Json4Unity Test/Run the Test1&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【Json4Unity：Type类型变量的序列化和反序列化】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            JUHouseA houseA = <span class="hljs-keyword">new</span> JUHouseA<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span>,<br>                type = <span class="hljs-keyword">typeof</span>(PersonD)<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseA);<br>            Debug.Log(jsonStr);<br>            houseA = JsonMapper.ToObject&lt;JUHouseA&gt;(jsonStr);<br>            Debug.Log(houseA);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title">JUHouseA</span> : <span class="hljs-title">House</span><br>        &#123;<br>            <span class="hljs-keyword">public</span> Type type;<br><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, type:<span class="hljs-subst">&#123;type&#125;</span>]&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Json4Unity：Unity常见数据结构Vector2-Vector3-Vector4-Rect-Quaternion-Color-Bounds的序列化和反序列化"><a href="#Json4Unity：Unity常见数据结构Vector2-Vector3-Vector4-Rect-Quaternion-Color-Bounds的序列化和反序列化" class="headerlink" title="Json4Unity：Unity常见数据结构Vector2,Vector3,Vector4,Rect,Quaternion,Color,Bounds的序列化和反序列化"></a>Json4Unity：Unity常见数据结构Vector2,Vector3,Vector4,Rect,Quaternion,Color,Bounds的序列化和反序列化</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">JUTest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ju_test2</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/Json4Unity Test/Run the Test2&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【Json4Unity：Unity常见数据结构Vector2,Vector3,Vector4,Rect,Quaternion,Color,Bounds的序列化和反序列化】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            JUData data = <span class="hljs-keyword">new</span> JUData<br>            &#123;<br>                mVec2 = <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>),<br>                mVec3 = <span class="hljs-keyword">new</span> Vector3(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>),<br>                mVec4 = <span class="hljs-keyword">new</span> Vector4(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>),<br>                mRect = <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>),<br>                mQuat = <span class="hljs-keyword">new</span> Quaternion(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>),<br>                mColor = <span class="hljs-keyword">new</span> Color(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)<br>            &#125;;<br>            data.mBounds = <span class="hljs-keyword">new</span> Bounds(data.mVec3, data.mVec3);<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(data);<br>            Debug.Log(jsonStr);<br>            data = JsonMapper.ToObject&lt;JUData&gt;(jsonStr);<br>            Debug.Log(data);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br><br>        <span class="hljs-keyword">class</span> <span class="hljs-title">JUData</span><br>        &#123;<br>            <span class="hljs-keyword">public</span> Vector2 mVec2;<br>            <span class="hljs-keyword">public</span> Vector3 mVec3;<br>            <span class="hljs-keyword">public</span> Vector4 mVec4;<br>            <span class="hljs-keyword">public</span> Rect mRect;<br>            <span class="hljs-keyword">public</span> Quaternion mQuat;<br>            <span class="hljs-keyword">public</span> Color mColor;<br>            <span class="hljs-keyword">public</span> Bounds mBounds;<br><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[Vector2:<span class="hljs-subst">&#123;mVec2&#125;</span>,Vector3:<span class="hljs-subst">&#123;mVec3&#125;</span>,Vector4:<span class="hljs-subst">&#123;mVec4&#125;</span>,Rect:<span class="hljs-subst">&#123;mRect&#125;</span>,Quaternion:<span class="hljs-subst">&#123;mQuat&#125;</span>,Color:<span class="hljs-subst">&#123;mColor&#125;</span>,Bounds:<span class="hljs-subst">&#123;mBounds&#125;</span>]&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="相同的自定义类型公共字段在不同的类中反序列化规则不同"><a href="#相同的自定义类型公共字段在不同的类中反序列化规则不同" class="headerlink" title="相同的自定义类型公共字段在不同的类中反序列化规则不同"></a>相同的自定义类型公共字段在不同的类中反序列化规则不同</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">OtherTest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ot_test1</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/Other Test/Run the Test1&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【相同的自定义类型公共字段在不同的类中反序列化规则不同】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            OTPersonA person = <span class="hljs-keyword">new</span> OTPersonA<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span><br>            &#125;;<br>            OTHouseA houseA = <span class="hljs-keyword">new</span> OTHouseA()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseA&quot;</span>,<br>                mSize = <span class="hljs-number">100</span>,<br>                person = person<br>            &#125;;<br>            OTHouseB houseB = <span class="hljs-keyword">new</span> OTHouseB()<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseB&quot;</span>,<br>                mSize = <span class="hljs-number">50</span>,<br>                person = person<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseA);<br>            Debug.Log(jsonStr);<br>            OTHouseA houseA1 = JsonMapper.ToObject&lt;OTHouseA&gt;(jsonStr);<br>            Debug.Log(houseA1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-number">80</span>));<br>            jsonStr = JsonMapper.ToJson(houseB);<br>            Debug.Log(jsonStr);<br>            OTHouseB houseB1 = JsonMapper.ToObject&lt;OTHouseB&gt;(jsonStr);<br>            Debug.Log(houseB1);<br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">OTPersonA</span> : <span class="hljs-title">IPerson</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> mName &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mAge &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mAge:<span class="hljs-subst">&#123;mAge&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">OTHouseA</span> : <span class="hljs-title">House</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> OTPersonA person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">OTHouseA</span>()</span><br>        &#123;<br>            JsonMapper.RegisterImporterWithReader&lt;OTPersonA, OTHouseA&gt;(reader =&gt;<br>            &#123;<br>                ReaderData[] readerDatas = <span class="hljs-keyword">new</span> ReaderData[<span class="hljs-number">2</span>];<br>                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; reader.count; i++)<br>                &#123;<br>                    readerDatas[i] = reader.GetData();<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> OTPersonA<br>                &#123;<br>                    mName = (<span class="hljs-built_in">string</span>)readerDatas[<span class="hljs-number">0</span>].propertyValue,<br>                    mAge = (<span class="hljs-built_in">int</span>)readerDatas[<span class="hljs-number">1</span>].propertyValue<br>                &#125;;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">OTHouseB</span> : <span class="hljs-title">House</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> OTPersonA person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">OTHouseB</span>()</span><br>        &#123;<br>            JsonMapper.RegisterImporterWithReader&lt;OTPersonA, OTHouseB&gt;(reader =&gt;<br>            &#123;<br>                ReaderData[] readerDatas = <span class="hljs-keyword">new</span> ReaderData[<span class="hljs-number">2</span>];<br>                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; reader.count; i++)<br>                &#123;<br>                    readerDatas[i] = reader.GetData();<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> OTPersonA<br>                &#123;<br>                    mName = (<span class="hljs-built_in">string</span>)readerDatas[<span class="hljs-number">0</span>].propertyValue,<br>                    mAge = (<span class="hljs-built_in">int</span>)readerDatas[<span class="hljs-number">1</span>].propertyValue<br>                &#125;;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="对自定义类型公共字段自定义反序列化规则"><a href="#对自定义类型公共字段自定义反序列化规则" class="headerlink" title="对自定义类型公共字段自定义反序列化规则"></a>对自定义类型公共字段自定义反序列化规则</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> LitJson;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">OtherTest</span><br>&#123;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title">ot_test2</span><br>    &#123;<br>        [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;LitJsonTest/Other Test/Run the Test2&quot;</span>)</span>]<br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span><br>        &#123;<br><br>            Debug.Log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">80</span>));<br>            Debug.Log(<span class="hljs-string">&quot;&lt;b&gt;&lt;color=green&gt;【对自定义类型公共字段自定义反序列化规则】&lt;/color&gt;&lt;/b&gt;&quot;</span>);<br>            OTPersonA person = <span class="hljs-keyword">new</span> OTPersonA<br>            &#123;<br>                mName = <span class="hljs-string">&quot;Mike&quot;</span>,<br>                mAge = <span class="hljs-number">18</span><br>            &#125;;<br>            OTHouseC houseC = <span class="hljs-keyword">new</span> OTHouseC<br>            &#123;<br>                mName = <span class="hljs-string">&quot;HouseC&quot;</span>,<br>                mSize = <span class="hljs-number">100</span>,<br>                person = person<br>            &#125;;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonMapper.ToJson(houseC);<br>            Debug.Log(jsonStr);<br>            OTHouseC houseC1 = JsonMapper.ToObject&lt;OTHouseC&gt;(jsonStr);<br>            Debug.Log(houseC1);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title">OTHouseC</span> : <span class="hljs-title">House</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> OTPersonA person;<br><br>        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">OTHouseC</span>()</span><br>        &#123;<br>            JsonMapper.RegisterImporterWithReader(reader =&gt;<br>            &#123;<br>                ReaderData[] readerDatas = <span class="hljs-keyword">new</span> ReaderData[<span class="hljs-number">2</span>];<br>                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; reader.count; i++)<br>                &#123;<br>                    readerDatas[i] = reader.GetData();<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> OTPersonA<br>                &#123;<br>                    mName = (<span class="hljs-built_in">string</span>)readerDatas[<span class="hljs-number">0</span>].propertyValue,<br>                    mAge = (<span class="hljs-built_in">int</span>)readerDatas[<span class="hljs-number">1</span>].propertyValue<br>                &#125;;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[mName:<span class="hljs-subst">&#123;mName&#125;</span>, mSize:<span class="hljs-subst">&#123;mSize&#125;</span>, person:<span class="hljs-subst">&#123;person&#125;</span>]&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对自定义内容进行了十项单元测试，且测试均通过，但未对自定义内容之间的组合使用进行联调测试（确实没啥时间），有热心网友请帮忙测试一下吧。</p><p>本文基于LitJson进行自定义，扩展了以下功能：</p><ul><li><p>对C#的Type类型，以及接口类型或抽象类类型的字段或属性进行序列化和反序列化；</p></li><li><p>标记指定公有字段或属性不进行序列化和反序列化；</p></li><li><p>标记指定非公有字段或属性进行序列化和反序列化；</p></li><li><p>根据所在类不同，自定义同类型字段或属性的序列化或反序列化的局部规则；</p></li><li><p>对Unity3D中常见数据结构的序列化和反序列化进行扩展。</p></li></ul><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://pan.baidu.com/s/1Le07U6dMtbPr75vF_9IMFg?pwd=1314">百度网盘（提取码：1314）</a><br><a href="https://litjson.net/">官方网址</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">使用声明：LitJson为开源插件，但请保护原作者基本权益以及尊重原作者的创作成果，合理合法进行使用，从本文直接或间接下载则默认同意并悉知该声明。</div><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> JSON </tag>
            
            <tag> 数据序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>UGUI父对象自适应子元素布局解决方案</title>
      
      <link href="/posts/2026/01/03/ee4fa5059a2c/"/>
      <url>/posts/2026/01/03/ee4fa5059a2c/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在UI开发中，难免会遇到需要父对象自适应子元素尺寸的问题，这通常是为了解决不同屏幕分辨率的UI自适应问题。实际上我们去仔细了解UGUI的布局组件的原理就能够合理配置组件来解决这个问题。</p><blockquote><p>案例问题：例如我现在有一个背景面板，背景面板中包含一张图片和一段文字，要求图片和文字进行向左水平居中布局，图片对象根据Sprite自适应大小，文本框根据文字内容自适应大小，且背景面板始终根据二者的总尺寸进行自适应。</p></blockquote><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>根据上述案例问题，首先肯定能想到需要一个Horizontal Layout Group组件，那么这就解决了图片和文字向左水平居中的问题，其次背景面板需要自适应总尺寸，那么就需要一个Content Size Fitter组件。</p><p>接下来是图片和文本框，二者都属于布局元素，所以就各自加上Layout Element组件。图片则勾选Image组件的Preserve Aspect选项，LayoutElement组件保持默认；文本框的LayoutElement组件需要勾选Flexible Width和Flexible Height，二者的值可以都设置为1。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果对UGUI布局感兴趣，还可以去看看预设的布局组件的源代码，在Packages&#x2F;Unity UI下，对于其它布局情况建议先看看能否通过UGUI的预设布局组件进行组合来解决，若解决不了再去考虑开发自定义的布局组件。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>自定义Unity组件——ABManager（AB包管理器）</title>
      
      <link href="/posts/2026/01/03/2e4acc92ffe6/"/>
      <url>/posts/2026/01/03/2e4acc92ffe6/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Unity3D引擎中，AB包作为常用的游戏资源存储格式之一。而对于资源管理我们就不得不谈到集中管理的优势了，通过统一的接口加载和卸载AB包及其中的资源将进一步提升我们的编程效率。本文将围绕这个需求进行尝试。</p><h2 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h2><ul><li>AB包的加载包括同步和异步加载方式，AB包中的资源也包括同步和异步加载方式。</li><li>ABManager的初始化方式分为三种。第一种是通过ABManagerComponent组件在Inspector面板设置好初始化必要属性；第二种是在运行时设置ABManagerComponent组件的初始化属性，并调用其Init方法；第三种是通过ABManagerPool获取ABManager实例，通过调用其Init方法并传递AB包目录路径和主AB包名称的方式初始化。</li><li>可以通过ABManagerTool获取指定绝对目录路径下的AB包名称合集、AB包绝对路径合集，也可以通过AB包绝对路径获取AB包名称，也可以通过AB包目录路径和AB包名称获取AB包的绝对路径。</li><li>ABManagerComponent组件将提供快速选择AB包目录路径、选择主AB包名称及自动初始化等功能。</li></ul><h2 id="界面展示"><a href="#界面展示" class="headerlink" title="界面展示"></a>界面展示</h2><img src="/posts/2026/01/03/2e4acc92ffe6/img1.png" class="" width="360" height="305"><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>使用示例在资源里，先把.dll和.xml文件放在Plugins目录下，再导入示例的.unitypackage包。</p><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools/tree/main/ABManager">GitHub</a></p><p><a href="https://pan.baidu.com/s/1dZbLygablmms4U05pU9bnw?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>数组、列表和字典等可枚举类型的控制台输出扩展方法</title>
      
      <link href="/posts/2026/01/02/5846436f9852/"/>
      <url>/posts/2026/01/02/5846436f9852/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在程序开发中我们经常需要对数组、列表和字典等可枚举类型进行调试输出，每次都去手动敲一个for或foreach循环比较麻烦，所以我们可以考虑用一个静态类为可枚举类型添加扩展方法，从而实现快速输出可枚举类型的数据。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="LogUtility-cs"><a href="#LogUtility-cs" class="headerlink" title="LogUtility.cs"></a>LogUtility.cs</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> UNITY_EDITOR</span><br><br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">LogToolAPI</span><br>&#123;<br>    [<span class="hljs-meta">System.Diagnostics.DebuggerStepThrough</span>]<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LogUtility</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> IEnumerable&lt;T&gt; source, <span class="hljs-built_in">string</span> prefix = <span class="hljs-string">&quot;&quot;</span></span>)</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> str = source == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;Null&quot;</span> : <span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;, &quot;</span>, source);<br>            Debug.Log(prefix + str);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Log</span>&lt;<span class="hljs-title">TSource</span>, <span class="hljs-title">TResult</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> IEnumerable&lt;TSource&gt; source, Func&lt;TSource, TResult&gt; selecter, <span class="hljs-built_in">string</span> prefix = <span class="hljs-string">&quot;&quot;</span></span>)</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> str = source == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;Null&quot;</span> : <span class="hljs-built_in">string</span>.Join(<span class="hljs-string">&quot;, &quot;</span>, source.Select(selecter));<br>            Debug.Log(prefix + str);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp">List&lt;<span class="hljs-built_in">int</span>&gt; v_list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; &#123; <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> &#125;;<br><span class="hljs-built_in">int</span>[] v_array = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] &#123; <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> &#125;;<br>Dictionary&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">string</span>&gt; v_dict = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">string</span>&gt;();<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)<br>&#123;<br>    v_dict.Add(i, <span class="hljs-string">&quot;Value:&quot;</span> + i.ToString());<br>&#125;<br><br>v_array.Log(<span class="hljs-string">&quot;Array:&quot;</span>);<br>v_list.Log(<span class="hljs-string">&quot;List:&quot;</span>);<br>v_dict.Log(kv =&gt; kv.Value, <span class="hljs-string">&quot;Dict:&quot;</span>);<br><br>v_list = <span class="hljs-literal">null</span>;<br>v_array = <span class="hljs-literal">null</span>;<br>v_dict = <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>代码中我们使用了C#扩展方法的机制为所有可枚举类型添加了两种Log方法，本篇文章是基于Unity3D的部分API，但是这不是必须的，而是取决于Debug.Log的API来源。主要是提供了一种思路，读者可根据具体需求自行修改，值得注意的是，这些控制台输出的方法不应构建到发行版中，所以需要注意代码过滤。</p>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Windows传统DOS路径有效性检测（资源篇）</title>
      
      <link href="/posts/2026/01/02/caf47d1ddda7/"/>
      <url>/posts/2026/01/02/caf47d1ddda7/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇旨在探索Windows传统DOS路径有效性检测的一种可行方案，实际上许多Windows文件IO相关的API也同样可以作为一种方案，为了锻炼一下我们的思考和解决问题的能力，所以我们需要另辟蹊径。本篇将通过有限自动机来验证路径有效性，仅记录资源，具体的实现原理将在后续篇幅中进行详细探讨。具体的文档说明、使用方式和API等都在资源中。</p><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools/tree/main/PathTool">GitHub</a></p><p><a href="https://pan.baidu.com/s/1Ig1i3umrds9CdYTgVUDBmA?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>进度记录工具</title>
      
      <link href="/posts/2026/01/02/b778eb3ebf7e/"/>
      <url>/posts/2026/01/02/b778eb3ebf7e/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对过程进度进行记录，采用“进度管理器+进度处理器+进度记录器”结构、对象池技术和单例等设计，计时器间隔动态更新，时间间隔预测算法采用单指数平滑预测（有数据清洗）。一个进度管理器管理多个进度处理器，一个进度处理器可分配多个进度记录器，可配置过程权值，可进行进度递增和递减操作。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><table><thead><tr><th>测试项目</th><th>是否通过</th></tr></thead><tbody><tr><td>多协程处理过程模拟测试</td><td>√</td></tr><tr><td>…</td><td>…</td></tr></tbody></table><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools/tree/main/ProgressTool">GitHub</a></p><p><a href="https://pan.baidu.com/s/1UTaNsCGVaUrlfuDt6-hkWA?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity3D瓦片地图辅助定位工具</title>
      
      <link href="/posts/2026/01/02/253b27144c5e/"/>
      <url>/posts/2026/01/02/253b27144c5e/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该工具用于TileMap的瓦片辅助定位，通过键盘或鼠标按瓦片尺寸0到1的比例作为单次移动值移动定位点游戏对象。当采用定位点游戏对象映射瓦片时，可使用该工具来移动定位点游戏对象，在新版本Unity3D的TileMap编辑器中可使用GameObject Brush快速给瓦片添加定位点游戏对象，而旧版本中该工具更适用，这仅限于瓦片地图固定设计的情景，而对于代码动态生成的随机瓦片地图使用Unity3D中TileMap相关API来完成定位更合适。</p><h2 id="适用情景"><a href="#适用情景" class="headerlink" title="适用情景"></a>适用情景</h2><ul><li>瓦片地图设计固定，且采用定位点游戏对象映射瓦片，包括但不限于映射瓦片坐标或瓦片相对位置的特殊处理。</li><li>需要在瓦片地图特定位置进行特殊处理，例如在指定位置生成某种建筑等。</li></ul><h2 id="优点和缺点"><a href="#优点和缺点" class="headerlink" title="优点和缺点"></a>优点和缺点</h2><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>1. 避免使用代码计算瓦片位置；<br>2.对于瓦片的特殊处理相较于代码处理的成本和难度更低。</td><td>1. 设计固定，无法应对高随机性的瓦片地图，仅可在编辑器构建瓦片地图时使用；<br>2.需要手动维护定位点游戏对象，对于瓦片数量过多或复杂程度过高的瓦片地图不适用。</td></tr></tbody></table><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><blockquote><p>我们用该工具辅助定位瓦片地图的四个顶点瓦片，如图所示：</p></blockquote><img src="/posts/2026/01/02/253b27144c5e/img1.png" class="" width="166" height="169"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">未定位前</div><img src="/posts/2026/01/02/253b27144c5e/img2.png" class="" width="167" height="164"><div style="text-align:center; color:rgba(207, 204, 204, 0.7)">定位后</div><blockquote><p>创建定位点游戏对象（上图中的红点）：</p></blockquote><img src="/posts/2026/01/02/253b27144c5e/img3.png" class="" width="199" height="113"><blockquote><p>打开顶部菜单中的Tool —- CellMover窗口：</p></blockquote><img src="/posts/2026/01/02/253b27144c5e/img4.png" class="" width="321" height="170"><blockquote><p>选择或拖拽相关Tilemap组件给 Selected TileMap ，选择和拖拽定位点游戏对象给 Selected Cell ，自行调节或输入单次移动的步长 Step ，步长以一个瓦片单元的尺寸为基准：</p></blockquote><img src="/posts/2026/01/02/253b27144c5e/img5.png" class="" width="321" height="170"><blockquote><p>移动方式看上图中的提示</p></blockquote><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>如果需要修改预制体中的对象名称，请先移动到场景中，完成后应用修改到预制体。</p><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools/tree/main/GameTool">GitHub</a><br><a href="https://pan.baidu.com/s/13qRhrQ2XQge33N9y7pSufQ?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity3D批量修改名称工具</title>
      
      <link href="/posts/2026/01/02/5b55e1938680/"/>
      <url>/posts/2026/01/02/5b55e1938680/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该工具用于批量修改某游戏对象的一级子对象名称，功能包括批量添加前后缀、批量修改公共名称字段和批量修改为同一名称，包括撤销和恢复功能。批量添加前后缀可使用预设从指定数字递增或递减至指定数字。</p><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><blockquote><p>初始名称如图：</p></blockquote><img src="/posts/2026/01/02/5b55e1938680/img1.png" class="" width="195" height="319"><blockquote><p>打开顶部菜单栏中的Tool —- NameModifier工具：</p></blockquote><img src="/posts/2026/01/02/5b55e1938680/img2.png" class="" width="321" height="281"><blockquote><p>选择修改模式为 “ 批量修改为同一名称 ” ：</p></blockquote><img src="/posts/2026/01/02/5b55e1938680/img3.png" class="" width="321" height="281"><blockquote><p>选取或拖拽待修改名称的游戏对象的直接父对象，我们这里则是 “ Cells “。新的名称输入 “ Cell “，点击修改：</p></blockquote><img src="/posts/2026/01/02/5b55e1938680/img4.png" class="" width="217" height="319"><blockquote><p>修改模式切换为 “ 批量添加名称前缀或后缀 ” ，待添加的前缀或后缀输入  “ _ ”，预设选择从指定数字递增，指定数字输入 “ 0 ”，点击修改：</p></blockquote><img src="/posts/2026/01/02/5b55e1938680/img5.png" class="" width="209" height="319"><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul><li>注意保存场景文件修改；</li><li>如果需要修改预制体中的对象名称，请先移动到场景中，完成后应用修改到预制体；</li><li>关闭窗口前将保留修改记录，但是关闭窗口后，记录将被清除，无法再进行撤销和恢复，后续版本中可能会改进。</li></ul><h2 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h2><p><a href="https://github.com/JokeVallen/UnityTools/tree/main/GameTool">GitHub</a></p><p><a href="https://pan.baidu.com/s/13qRhrQ2XQge33N9y7pSufQ?pwd=1314">百度网盘（提取码：1314）</a></p><div style="text-align:center; color:rgba(207, 204, 204, 0.5); font-style:italic">免责声明：由于本文内容未经过正规和严格的测试，可能存在错误，因此造成的损失均由使用者自行承担，对本文内容复制、下载、参考等引用行为即默认悉知并同意该声明。</div>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Android游戏开发常见知识合集（Unity3D）</title>
      
      <link href="/posts/2026/01/02/a4c70e86a885/"/>
      <url>/posts/2026/01/02/a4c70e86a885/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Unity3D的特色之一就是具有良好的跨平台特性，随着移动设备的普及，移动端游戏的开发成为了多数游戏开发者所必备的技能之一。而Android作为最为普及的移动端系统，学习如何开发Android游戏是很有必要的。</p><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><ul><li>Unity3D</li><li>Unity3D构建Android项目必备的模块（Android SDK&#x2F;Android NDK&#x2F;Java JDK&#x2F;Gradle等）</li><li>Visual Studio 或 Visual Studio Code</li></ul><h3 id="发布环境（任选其一）"><a href="#发布环境（任选其一）" class="headerlink" title="发布环境（任选其一）"></a>发布环境（任选其一）</h3><ul><li>Android Studio发布</li><li>Unity发布</li></ul><h3 id="调试环境（任选其一）"><a href="#调试环境（任选其一）" class="headerlink" title="调试环境（任选其一）"></a>调试环境（任选其一）</h3><ul><li>真机 + Android Studio</li><li>AVD（安卓虚拟设备） + Android Studio</li><li>Unity Remote</li><li>模拟器 + Android Studio</li></ul><h3 id="Android-Studio-必备模块"><a href="#Android-Studio-必备模块" class="headerlink" title="Android Studio 必备模块"></a>Android Studio 必备模块</h3><ul><li>Android API</li><li>Android SDK Build-Tools</li><li>Android SDK Command-line Tools</li><li>Android SDK Platform-Tools</li></ul><h3 id="Android-Studio-可选模块"><a href="#Android-Studio-可选模块" class="headerlink" title="Android Studio 可选模块"></a>Android Studio 可选模块</h3><ul><li>Android Emulator</li><li>Andorid Emulator hypevisor dirver</li><li>Intel x86 Emulator Accelerator（HAXM installer）</li></ul><h3 id="其他工具（可选）"><a href="#其他工具（可选）" class="headerlink" title="其他工具（可选）"></a>其他工具（可选）</h3><ul><li>adb：连接模拟器以及在模拟器中安装apks等</li><li>bundletool：从aab生成apks等</li><li>keytool：签名密钥创建、查询等</li><li>jarsigner：签名检测等</li><li>pepk：Google开发者后台应用签名密钥加密等</li><li>openssl：密钥文件公钥、证书链导出等</li></ul><h2 id="开发流程"><a href="#开发流程" class="headerlink" title="开发流程"></a>开发流程</h2><ul><li>先在Unity中编写好基础的交互逻辑，配置好Android项目的构建环境（SDK、NDK、JDK、Gradle），建议构建环境使用官方推荐配置，自定义可能会存在一些坑；</li><li>勾选项目的arm v7、arm v8，设置Android最小API及目标API；</li><li>构建时可以导出为Android项目，也可以导出为apk文件；<ul><li>若是导出为Andorid项目，则可以在Android Studio中进行项目配置和签名，接入第三方SDK的话，建议选择该方式；</li><li>若是导出为apk，则可以在Unity中进行项目配置和签名；</li></ul></li><li>若是导出为Android项目，则在Android Studio中配置好SDK、NDK、JDK、Gradle版本，这些版本不一定需要跟Unity构建时的版本一致，因为Unity这边的版本仅用于构建，且往往比较旧，只要能兼容即可，第三方库有时候会要求更高的版本。在Android Studio中还需要配置好签名密钥，若要接入第三方SDK，则以UnityPlayerActivity为调用入口，因为Unity的Activity生命周期函数都在这个类中，当然也可以继承该类进行自定义；</li><li>导出为apk则用于测试，导出为aab则用于上传Google Play控制台，在控制台进行发布审核。</li></ul><h2 id="Mumu模拟器代理"><a href="#Mumu模拟器代理" class="headerlink" title="Mumu模拟器代理"></a>Mumu模拟器代理</h2><p>在模拟器——设置——网络中找到当前所连接的网络，打开其高级选项，选择手动代理，代理主机名为运行模拟器主机的网络IPV4地址（CMD中输入ipconfig查询），端口为代理端口，代理需要打开允许局域网的设置。</p><h2 id="Android与Unity代码交互"><a href="#Android与Unity代码交互" class="headerlink" title="Android与Unity代码交互"></a>Android与Unity代码交互</h2><h3 id="Android中的Java代码调用Unity的C-代码"><a href="#Android中的Java代码调用Unity的C-代码" class="headerlink" title="Android中的Java代码调用Unity的C#代码"></a>Android中的Java代码调用Unity的C#代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// s：挂载了Monobehaviour组件的游戏对象名称</span><br><span class="hljs-comment">// s1：Monobehaviour组件中的公共方法名</span><br><span class="hljs-comment">// s2：方法参数</span><br>UnityPlayer.UnitySendMessage(string s,string s1,string s2);<br></code></pre></td></tr></table></figure><h3 id="Unity中的C-代码调用Android中的Java代码"><a href="#Unity中的C-代码调用Android中的Java代码" class="headerlink" title="Unity中的C#代码调用Android中的Java代码"></a>Unity中的C#代码调用Android中的Java代码</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 使用AndroidJavaClass或AndroidJavaObject</span><br>AndroidJavaObject jo = <span class="hljs-keyword">new</span> AndroidJavaClass(<span class="hljs-string">&quot;com.unity3d.player.UnityPlayer&quot;</span>).GetStatic&lt;AndroidJavaObject&gt;(<span class="hljs-string">&quot;currentActivity&quot;</span>);<br></code></pre></td></tr></table></figure><blockquote><p>PS：不使用AndroidJavaClass或AndroidJavaObject后，应注意及时释放内存。</p></blockquote><h2 id="Google相关"><a href="#Google相关" class="headerlink" title="Google相关"></a>Google相关</h2><ul><li>Play Asset Delivery（PAD）：<a href="https://developer.android.com/guide/playcore/asset-delivery?hl=zh-cn">官方文档</a></li><li>Play Feature Delivery（PFD）：<a href="https://developer.android.com/guide/playcore/feature-delivery?hl=zh-cn">官方文档</a></li><li>Android App Bundle（AAB）：<a href="https://developer.android.com/guide/app-bundle?hl=zh-cn">官方文档</a></li></ul><h2 id="常用控制台命令"><a href="#常用控制台命令" class="headerlink" title="常用控制台命令"></a>常用控制台命令</h2><p>打印jks密钥文件信息</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">keytool -list -v -keystore my-release-key.keystore<br></code></pre></td></tr></table></figure><p>java执行jar包</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">java -jar example.jar<br></code></pre></td></tr></table></figure><p>jks导出为pkcs12文件</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">keytool -importkeystore -srckeystore my-release-key.keystore -destkeystore my-release-key.p12 -srcstoretype JKS -deststoretype PKCS12 -srcalias my-key-alias<br></code></pre></td></tr></table></figure><p>pkcs12导出私钥pem</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">openssl pkcs12 -<span class="hljs-keyword">in</span> my-release-key.p12 -nodes -nocerts -out private_key.pem<br></code></pre></td></tr></table></figure><p>pkcs12导出证书链</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">openssl pkcs12 -<span class="hljs-keyword">in</span> my-release-key.p12 -nokeys -out cert_chain.pem<br></code></pre></td></tr></table></figure><p>合并pem</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">cat private_key.pem cert_chain.pem &gt; combined.pem<br></code></pre></td></tr></table></figure><p>通过pepk加密本地密钥（jks或keystore）和Google开发者公钥（pem），获取上传控制台的应用签名密钥（zip）</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">java -jar pepk.jar --keystore=my-release-key.keystore --alias=my-key-alias --output=encrypted-output.zip --encryptionkey=your-encryption-key --pem=combined.pem<br></code></pre></td></tr></table></figure><p>aab转换为apks</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">java -jar bundletool.jar build-apks --bundle=/<span class="hljs-built_in">path</span>/to/your_app.aab --output=/<span class="hljs-built_in">path</span>/to/output.apks --ks=/<span class="hljs-built_in">path</span>/to/your_keystore.jks --ks-pass=pass:your_keystore_password --ks-key-alias=your_key_alias --key-pass=pass:your_key_password<br></code></pre></td></tr></table></figure><p>Android Studio连接Mumu模拟器调试</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">adb connect <span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">7555</span><br></code></pre></td></tr></table></figure><p>将apks安装到Mumu模拟器上（执行该操作前先连接Mumu模拟器）</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">java -jar bundletool.jar install-apks --apks=/<span class="hljs-built_in">path</span>/to/your_file.apks --adb=/<span class="hljs-built_in">path</span>/to/adb.exe<br></code></pre></td></tr></table></figure><p>keytool生成jks密钥</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bat">keytool -genkeypair -alias your_alias -keyalg RSA -keysize <span class="hljs-number">2048</span> -validity <span class="hljs-number">36500</span> -keystore your_keystore.jks -storepass your_password -keypass your_password<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity3D安卓游戏第三方SDK接入</title>
      
      <link href="/posts/2026/01/02/2cfdfed6650c/"/>
      <url>/posts/2026/01/02/2cfdfed6650c/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是SDK？"><a href="#什么是SDK？" class="headerlink" title="什么是SDK？"></a>什么是SDK？</h2><p>SDK（Software Development Kit，软件开发工具包）是一个用于构建应用程序的工具集，包含开发特定软件的必要工具、库、文档和示例代码。SDK通常由软件或硬件厂商提供，帮助开发者更容易地为特定平台、操作系统、设备或服务创建应用程序。</p><h2 id="SDK的应用场景"><a href="#SDK的应用场景" class="headerlink" title="SDK的应用场景"></a>SDK的应用场景</h2><ol><li>平台开发：如Android、iOS等移动操作系统的SDK，提供了开发移动应用的所有必要资源。</li><li>服务集成：如云服务的SDK，帮助开发者快速集成和使用特定的云服务（如AWS、Google Cloud等）。</li><li>硬件开发：一些硬件厂商提供SDK，以便开发者创建与其硬件设备兼容的软件。</li></ol><h2 id="Google新版登录SDK–Credential"><a href="#Google新版登录SDK–Credential" class="headerlink" title="Google新版登录SDK–Credential"></a>Google新版登录SDK–Credential</h2><h3 id="依赖项"><a href="#依赖项" class="headerlink" title="依赖项"></a>依赖项</h3><ol><li>implementation ‘androidx.appcompat:appcompat:1.3.1’</li><li>implementation “com.google.android.gms:play-services-auth:21.2.0”</li><li>implementation “androidx.credentials:credentials:1.3.0-rc01”</li><li>implementation “androidx.credentials:credentials-play-services-auth:1.3.0-rc01”</li><li>implementation “com.google.android.libraries.identity.googleid:googleid:1.1.0”</li></ol><h3 id="接入流程"><a href="#接入流程" class="headerlink" title="接入流程"></a>接入流程</h3><p><a href="https://developer.android.com/identity/sign-in/credential-manager">官方文档</a></p><h3 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h3><blockquote><p><strong>Q:</strong> Failed to transform annotation-experimental-1.4.0.aar</p><img src="/posts/2026/01/02/2cfdfed6650c/img1.png" class="" width="729" height="160"></blockquote><blockquote><p><strong>Q:</strong> androidx.credentials.exceptions.GetCredentialProviderConfigurationException: getCredentialAsync no provider dependencies found - please ensure the desired provider dependencies are added</p><p><strong>A:</strong> 可能是设备的Google Play Service版本太低导致的，可以尝试更新设备的Google Play Service。</p></blockquote><blockquote><p><strong>Q:</strong> During begin sign in, failure response from one tap: Missing Feature{name&#x3D;auth_api_credentials_begin_sign_in, version&#x3D;8}</p><p><strong>A:</strong> 提高依赖项”androidx.credentials:credentials”和”androidx.credentials:credentials-play-services-auth”的版本。</p></blockquote><blockquote><p><strong>Q:</strong> During begin sign in, failure response from one tap: 10: [28444] Developer console is not set up correctly.</p><p><strong>A:</strong> 这个可能是因为Google后台配置问题，也可能是本地客户端ID设置错误所致。</p></blockquote><blockquote><p><strong>Q:</strong> androidx.credentials.exceptions.GetCredentialCancellationException: activity is cancelled by the user.</p><p><strong>A:</strong> 这个可能是本地客户端ID设置错误所致。</p></blockquote><h3 id="特殊要求"><a href="#特殊要求" class="headerlink" title="特殊要求"></a>特殊要求</h3><ol><li>设备Android系统版本最低为8.0，需要设备具备Google三件套（Google服务框架、Google Play服务、Google商店）；</li><li>需要设备具备VPN功能，能够访问Google服务（例如能够正常打开Google商店）。</li></ol><h2 id="常见第三方SDK（海外）"><a href="#常见第三方SDK（海外）" class="headerlink" title="常见第三方SDK（海外）"></a>常见第三方SDK（海外）</h2><ol><li>Google身份验证SDK；</li><li>Google支付SDK；</li><li>AppsFlyer移动归因和营销分析SDK；</li></ol><p>……</p><h2 id="后台配置"><a href="#后台配置" class="headerlink" title="后台配置"></a>后台配置</h2><h3 id="Google登录SDK"><a href="#Google登录SDK" class="headerlink" title="Google登录SDK"></a>Google登录SDK</h3><ol><li>登录Google Cloud后台，创建一个项目；</li><li>开启API和服务（Identity Toolkit API）；</li><li>设置OAuth权限请求页面，添加测试用户；</li><li>添加OAuth2.0客户端ID，包括Web应用和Android，输入包名以及本地导包的jks的SHA-1指纹（Web应用的客户端ID将用于Google登录SDK）；</li><li>值得注意的是，如果本地导包的jks发生改变，也应在后台更新SHA-1指纹，否则无法成功调用SDK。</li></ol><h3 id="Google支付SDK"><a href="#Google支付SDK" class="headerlink" title="Google支付SDK"></a>Google支付SDK</h3><ol><li>这个需要Google开发者账号，需要在Google Play控制台配置商品信息；</li><li>还需要上传一个应用程序签名密钥，这个需要上传一个.zip文件，生成方法则是通过pepk将开发者账号的配套密钥的pem与本地开发所用的jks联合加密，然后导出为.zip文件；</li><li>注意开发者账号的配套密钥不能作为本地开发密钥，Google Play控制台为了安全考虑这种方式不被允许。</li></ol><h2 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h2><p>示例1将演示如何为Unity3D开发的Android项目接入Google登录SDK。</p><h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><ul><li>Android Studio 2024.1.0.0</li><li>Windows 10</li><li>Unity3D 2020.3.48f1c1</li><li>Android SDK 34 （Android Studio导出环境） Android SDK 10&#x2F;11（Unity构建环境）</li><li>Android NDK 19.0.5232133（Unity构建环境、Android Studio导出环境）</li><li>JDK 11.0.24（Android Studio导出环境） JDK 1.8.0（Unity构建环境）</li><li>Gradle 6.1.1（Unity构建环境、Android Studio导出环境）</li><li>Gradle Plugin 4.0.1（Android Studio导出环境）</li></ul><h3 id="Unity配置"><a href="#Unity配置" class="headerlink" title="Unity配置"></a>Unity配置</h3><ul><li>Minimum api level 22</li><li>Target api level 34</li></ul><h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><p>Mumu模拟器，设备（OPPO K10 PGJM10），Android系统（12）</p><h3 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h3><ul><li>Unity3D 搭建UI界面，可供玩家交互，包括登录、注销登录、查看用户信息、退出游戏四个功能；</li><li>Android Studio接入Google身份验证SDK，需要登录、注销登录、发送提示信息三个功能；</li></ul><h3 id="流程描述"><a href="#流程描述" class="headerlink" title="流程描述"></a>流程描述</h3><ul><li>玩家进入游戏；</li><li>玩家点击登录按钮，触发Google登录功能，需要对登录结果和异常进行反馈；</li><li>玩家点击注销登录按钮，触发Google注销登录功能，需要对注销登录结果和异常进行反馈；</li><li>玩家点击查看用户信息按钮，显示账户的Google id、名称、邮箱、邮箱是否验证信息，需要对异常进行反馈；</li><li>玩家点击退出游戏按钮，关闭游戏程序；</li><li>对于结果和异常反馈应采用定时关闭的提示框进行显示；</li></ul><h3 id="方法对应表"><a href="#方法对应表" class="headerlink" title="方法对应表"></a>方法对应表</h3><table><thead><tr><th>方法&#x2F;端口</th><th>Android（Java）</th><th>Unity3D（C#）</th><th>Unity3D（C#）回调</th></tr></thead><tbody><tr><td>登录</td><td>askLogin</td><td>OnLoginClick</td><td>OnLoginSuccess</td></tr><tr><td>注销登录</td><td>askLogout</td><td>OnLogoutClick</td><td>OnLogoutSuccess</td></tr><tr><td>发送提示信息</td><td>Null</td><td>SendTip</td><td>Null</td></tr></tbody></table><h3 id="用户信息表"><a href="#用户信息表" class="headerlink" title="用户信息表"></a>用户信息表</h3><table><thead><tr><th>信息&#x2F;端口</th><th>Android（Java）</th></tr></thead><tbody><tr><td>与用户的 Google 帐号相关联的电子邮件地址</td><td>id</td></tr><tr><td>在条目上显示的显示名</td><td>name</td></tr><tr><td>用户的个人资料照片 URI</td><td>photo</td></tr><tr><td>用户的 Google ID Toekn</td><td>token</td></tr></tbody></table><h3 id="Unity3D游戏代码"><a href="#Unity3D游戏代码" class="headerlink" title="Unity3D游戏代码"></a>Unity3D游戏代码</h3><h4 id="Tip-cs"><a href="#Tip-cs" class="headerlink" title="Tip.cs"></a>Tip.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.UI;<br><br><span class="hljs-comment">// 提示框组件：用以显示提示框信息以及交互</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Tip</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    [<span class="hljs-meta">SerializeField</span>] Text content;<br>    [<span class="hljs-meta">SerializeField</span>] Button close;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isUsed &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Send</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> tip</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (isUsed || <span class="hljs-built_in">string</span>.IsNullOrEmpty(tip)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        isUsed = <span class="hljs-literal">true</span>;<br>        content.text = tip;<br>        gameObject.SetActive(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        close.onClick.AddListener(OnClose);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnClose</span>()</span><br>    &#123;<br>        gameObject.SetActive(<span class="hljs-literal">false</span>);<br>        isUsed = <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TipController-cs"><a href="#TipController-cs" class="headerlink" title="TipController.cs"></a>TipController.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment">// 提示框控制器组件：显示提示框的统一调用接口以及控制提示框</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TipController</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> Tip tip;<br><br>    <span class="hljs-keyword">static</span> Queue&lt;<span class="hljs-built_in">string</span>&gt; contents = <span class="hljs-keyword">new</span> Queue&lt;<span class="hljs-built_in">string</span>&gt;();<br>    <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> MAX_COUNT = <span class="hljs-number">10</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> content</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(content) || contents.Count &gt;= MAX_COUNT) <span class="hljs-keyword">return</span>;<br>        contents.Enqueue(content);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (contents.Count &gt; <span class="hljs-number">0</span> &amp;&amp; tip.Send(contents.Peek()))<br>            contents.Dequeue();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="UILogic-cs"><a href="#UILogic-cs" class="headerlink" title="UILogic.cs"></a>UILogic.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.Networking;<br><span class="hljs-keyword">using</span> UnityEngine.UI;<br><br><span class="hljs-comment">// UI逻辑：UI交互相关的逻辑以及 Android 和 Unity 相互调用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UILogic</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> Button login;<br>    <span class="hljs-keyword">public</span> Button show;<br>    <span class="hljs-keyword">public</span> Button logout;<br>    <span class="hljs-keyword">public</span> Button quit;<br>    <span class="hljs-keyword">public</span> ScrollRect showView;<br>    <span class="hljs-keyword">public</span> RawImage portrait;<br>    <span class="hljs-keyword">public</span> Text showText;<br>    <span class="hljs-keyword">public</span> Button showViewCloseButton;<br><br>    AndroidJavaObject jo;<br>    UserData userData;<br>    <span class="hljs-built_in">bool</span> isLoginSuccess;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        jo = <span class="hljs-keyword">new</span> AndroidJavaClass(<span class="hljs-string">&quot;com.unity3d.player.UnityPlayer&quot;</span>).GetStatic&lt;AndroidJavaObject&gt;(<span class="hljs-string">&quot;currentActivity&quot;</span>);<br>        login.onClick.AddListener(OnLoginClick);<br>        show.onClick.AddListener(OnShowClick);<br>        logout.onClick.AddListener(OnLogoutClick);<br>        quit.onClick.AddListener(OnQuitClick);<br>        showViewCloseButton.onClick.AddListener(OnShowViewCloseClick);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span><br>    &#123;<br>        jo.Dispose();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnLoginClick</span>()</span><br>    &#123;<br>        jo.Call(<span class="hljs-string">&quot;askLogin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnShowClick</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!isLoginSuccess)<br>        &#123;<br>            TipController.Send(<span class="hljs-string">&quot;请先进行登录。&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (portrait.texture == <span class="hljs-literal">null</span>) StartCoroutine(LoadPortrait(userData.photo));<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(showText.text))<br>        &#123;<br>            StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder()<br>            .Append(<span class="hljs-string">&quot;Gmail:&quot;</span> + userData.id)<br>            .Append(<span class="hljs-string">&quot;\nUserName:&quot;</span> + userData.name)<br>            .Append(<span class="hljs-string">&quot;\nToken:&quot;</span> + userData.token);<br>            showText.text = builder.ToString();<br>        &#125;<br><br>        showView.gameObject.SetActive(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnLogoutClick</span>()</span><br>    &#123;<br>        jo.Call(<span class="hljs-string">&quot;askLogout&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnQuitClick</span>()</span><br>    &#123;<br>        Application.Quit();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnShowViewCloseClick</span>()</span><br>    &#123;<br>        showView.gameObject.SetActive(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-function">IEnumerator <span class="hljs-title">LoadPortrait</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> uri</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">using</span> (UnityWebRequest www = UnityWebRequestTexture.GetTexture(uri))<br>        &#123;<br>            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> www.SendWebRequest();<br><br>            <span class="hljs-keyword">if</span> (www.result != UnityWebRequest.Result.Success)<br>                TipController.Send(<span class="hljs-string">&quot;头像加载失败!&quot;</span>);<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                Texture2D texture = DownloadHandlerTexture.GetContent(www);<br>                portrait.texture = texture;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// ************************** Java Call CSharp ******************************</span><br><br>    <span class="hljs-comment">// 登录成功回调：带有用户信息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnLoginSuccess</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> jsonStr</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Debug.Log(jsonStr);<br>            userData = JsonUtility.FromJson&lt;UserData&gt;(jsonStr);<br>            Debug.Log(userData);<br>            isLoginSuccess = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            TipController.Send(<span class="hljs-string">&quot;用户信息获取失败，请尝试重新登录。&quot;</span>);<br>            Debug.LogError(ex.Message);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 注销登录成功回调</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnLogoutSuccess</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        isLoginSuccess = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 信息提示</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendTip</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> content</span>)</span><br>    &#123;<br>        TipController.Send(content);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="UserData-cs"><a href="#UserData-cs" class="headerlink" title="UserData.cs"></a>UserData.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 用户信息：记录Google登录用户的信息结构体</span><br><br>[<span class="hljs-meta">System.Serializable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> UserData<br>&#123;<br>    <span class="hljs-comment">// 与用户的 Google 帐号相关联的电子邮件地址</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> id;<br><br>    <span class="hljs-comment">// 在条目上显示的显示名</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name;<br><br>    <span class="hljs-comment">// 用户的个人资料照片 URI</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> photo;<br><br>    <span class="hljs-comment">// 用户的 Google ID Toekn</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> token;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">$&quot;[id:<span class="hljs-subst">&#123;id&#125;</span>,name:<span class="hljs-subst">&#123;name&#125;</span>,photo:<span class="hljs-subst">&#123;photo&#125;</span>,token:<span class="hljs-subst">&#123;token&#125;</span>]&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Android端Java代码（部分）"><a href="#Android端Java代码（部分）" class="headerlink" title="Android端Java代码（部分）"></a>Android端Java代码（部分）</h3><h4 id="UnityPlayerActivity-java"><a href="#UnityPlayerActivity-java" class="headerlink" title="UnityPlayerActivity.java"></a>UnityPlayerActivity.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ****************************** Unity Call *******************************</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">askLogin</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">GetGoogleIdOption</span> <span class="hljs-variable">googleIdOption</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetGoogleIdOption</span>.Builder()<br>            .setFilterByAuthorizedAccounts(<span class="hljs-literal">false</span>)<br>            .setAutoSelectEnabled(<span class="hljs-literal">true</span>)<br>            .setServerClientId(getString(R.string.WEB_CLIENT_ID))<br>            .build();<br><br>    <span class="hljs-type">GetCredentialRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetCredentialRequest</span>.Builder()<br>            .addCredentialOption(googleIdOption)<br>            .build();<br>    <br>    <span class="hljs-type">CancellationSignal</span> <span class="hljs-variable">signal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CancellationSignal</span>();<br>    signal.setOnCancelListener(() -&gt; &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;askLogin: Preparing credentials with Google was cancelled.&quot;</span>);<br>        sendTip(<span class="hljs-string">&quot;你已取消登录!&quot;</span>);<br>    &#125;);<br><br>    getCredentialManager().getCredentialAsync(<br>            <span class="hljs-built_in">this</span>,<br>            request,<br>            signal,<br>            Executors.newSingleThreadExecutor(),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CredentialManagerCallback</span>&lt;GetCredentialResponse, GetCredentialException&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResult</span><span class="hljs-params">(GetCredentialResponse result)</span> &#123;<br>                    handleSignIn(result);<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(GetCredentialException e)</span> &#123;<br>                    Log.e(TAG, <span class="hljs-string">&quot;askLogin: &quot;</span>, e);<br>                    sendTip(<span class="hljs-string">&quot;登录失败!&quot;</span>);<br>                &#125;<br>            &#125;);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">askLogout</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">ClearCredentialStateRequest</span> <span class="hljs-variable">clearCredentialStateRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClearCredentialStateRequest</span>();<br><br>    android.os.<span class="hljs-type">CancellationSignal</span> <span class="hljs-variable">cancellationSignal</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">android</span>.os.CancellationSignal();<br>    cancellationSignal.setOnCancelListener(() -&gt; &#123;<br>        Log.d(TAG, <span class="hljs-string">&quot;askLoginOut:Preparing credentials with Google was cancelled.&quot;</span>);<br>        sendTip(<span class="hljs-string">&quot;你已取消注销登录操作!&quot;</span>);<br>    &#125;);<br><br>    <span class="hljs-keyword">if</span> (credentialManager != <span class="hljs-literal">null</span>) &#123;<br>        getCredentialManager().clearCredentialStateAsync(<br>                clearCredentialStateRequest,<br>                cancellationSignal,<br>                Executors.newSingleThreadExecutor(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">CredentialManagerCallback</span>&lt;Void, ClearCredentialException&gt;() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResult</span><span class="hljs-params">(Void unused)</span> &#123;<br>                        Log.d(TAG, <span class="hljs-string">&quot;askLoginOut:google注销登录成功&quot;</span>);<br>                        sendTip(<span class="hljs-string">&quot;注销登录成功!&quot;</span>);<br>                        UnityPlayer.UnitySendMessage(<span class="hljs-string">&quot;Canvas&quot;</span>,<span class="hljs-string">&quot;OnLogoutSuccess&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(ClearCredentialException e)</span> &#123;<br>                        Log.e(TAG, <span class="hljs-string">&quot;askLoginOut:&quot;</span> , e);<br>                        sendTip(<span class="hljs-string">&quot;注销登录失败!&quot;</span>);<br>                    &#125;<br>                &#125;<br>        );<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ****************************** Java Call *******************************</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTip</span><span class="hljs-params">(String content)</span>&#123;<br>    UnityPlayer.UnitySendMessage(<span class="hljs-string">&quot;Canvas&quot;</span>,<span class="hljs-string">&quot;SendTip&quot;</span>,content);<br>&#125;<br><br><span class="hljs-comment">// ****************************** Google Login SDK *******************************</span><br><br><span class="hljs-keyword">private</span> CredentialManager <span class="hljs-title function_">getCredentialManager</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">if</span>(credentialManager == <span class="hljs-literal">null</span>)<br>        credentialManager = CredentialManager.create(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-keyword">return</span> credentialManager;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSignIn</span><span class="hljs-params">(GetCredentialResponse result)</span> &#123;<br>    <span class="hljs-comment">// Handle the successfully returned credential.</span><br>    <span class="hljs-type">Credential</span> <span class="hljs-variable">credential</span> <span class="hljs-operator">=</span> result.getCredential();<br><br>    <span class="hljs-keyword">if</span> (credential <span class="hljs-keyword">instanceof</span> PublicKeyCredential) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">responseJson</span> <span class="hljs-operator">=</span> ((PublicKeyCredential) credential).getAuthenticationResponseJson();<br>        <span class="hljs-comment">// Share responseJson i.e. a GetCredentialResponse on your server to validate and authenticate</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (credential <span class="hljs-keyword">instanceof</span> PasswordCredential) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> ((PasswordCredential) credential).getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> ((PasswordCredential) credential).getPassword();<br>        <span class="hljs-comment">// Use id and password to send to your server to validate and authenticate</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (credential <span class="hljs-keyword">instanceof</span> CustomCredential) &#123;<br>        <span class="hljs-keyword">if</span> (GoogleIdTokenCredential.TYPE_GOOGLE_ID_TOKEN_CREDENTIAL.equals(credential.getType())) &#123;<br>            <span class="hljs-comment">// Use googleIdTokenCredential and extract id to validate and</span><br>            <span class="hljs-comment">// authenticate on your server</span><br>            <span class="hljs-type">GoogleIdTokenCredential</span> <span class="hljs-variable">googleIdTokenCredential</span> <span class="hljs-operator">=</span> GoogleIdTokenCredential.createFrom(credential.getData());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">idToken</span> <span class="hljs-operator">=</span> googleIdTokenCredential.getIdToken();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">JSONObject</span> <span class="hljs-variable">googleLoginInfoReturn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>                googleLoginInfoReturn.put(<span class="hljs-string">&quot;id&quot;</span>, googleIdTokenCredential.getId());<br>                googleLoginInfoReturn.put(<span class="hljs-string">&quot;name&quot;</span>,googleIdTokenCredential.getDisplayName());<br>                googleLoginInfoReturn.put(<span class="hljs-string">&quot;photo&quot;</span>,googleIdTokenCredential.getProfilePictureUri());<br>                googleLoginInfoReturn.put(<span class="hljs-string">&quot;token&quot;</span>,idToken);<br>                Log.d(TAG, <span class="hljs-string">&quot;handleSignIn: &quot;</span>+ googleLoginInfoReturn);<br>                sendTip(<span class="hljs-string">&quot;登录成功!&quot;</span>);<br>                UnityPlayer.UnitySendMessage(<span class="hljs-string">&quot;Canvas&quot;</span>,<span class="hljs-string">&quot;OnLoginSuccess&quot;</span>,googleLoginInfoReturn.toString());<br>            &#125; <span class="hljs-keyword">catch</span> (JSONException e) &#123;<br>                Log.e(TAG, <span class="hljs-string">&quot;handleSignIn: &quot;</span>, e);<br>                sendTip(<span class="hljs-string">&quot;用户信息解析异常!&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Catch any unrecognized custom credential type here.</span><br>            Log.d(TAG, <span class="hljs-string">&quot;handleSignIn: Unexpected type of credential&quot;</span>);<br>            sendTip(<span class="hljs-string">&quot;未知的登录方式!&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Catch any unrecognized credential type here.</span><br>        Log.d(TAG, <span class="hljs-string">&quot;handleSignIn: Unexpected type of credential&quot;</span>);<br>        sendTip(<span class="hljs-string">&quot;未知的登录方式!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>继承实现单例模式的探索（一）</title>
      
      <link href="/posts/2026/01/02/43ee105b7dff/"/>
      <url>/posts/2026/01/02/43ee105b7dff/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前看到朋友采用继承的方式来实现单例模式，觉得很厉害，随后自己去探索了一番，以前实现单例模式都是把代码内联到具体的类中，这使得工程中每次需要使用单例模式时，都采用拷贝的方式，增加了很多冗余代码，并且难以规范单例的统一标准，使得代码不方便扩展和管理。这次探索找到了一种实现方式，先记录下来，后续如果有其它方式再发表系列文章，示例代码为C#。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="v1-0"><a href="#v1-0" class="headerlink" title="v1.0"></a>v1.0</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 单例模式基类</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>单例类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">T</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span>, <span class="hljs-title">new</span>()<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance =&gt; _instance.Value;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _unlock;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Lazy&lt;T&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;T&gt;(() =&gt;<br>    &#123;<br>        _unlock = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> T();<br>    &#125;);<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">Singleton</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!_unlock)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Singleton:The ctor is proxied by singleton and cannot be called from outside.&quot;</span>);<br>        _unlock = <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-1"><a href="#v1-1" class="headerlink" title="v1.1"></a>v1.1</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 单例模式基类</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>单例类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">T</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span>, <span class="hljs-title">new</span>()<br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance =&gt; _instance.Value;<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _unlock;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Lazy&lt;T&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;T&gt;(Create);<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Create</span>()</span><br>    &#123;<br>        _unlock = <span class="hljs-literal">true</span>;<br>        T item = <span class="hljs-keyword">new</span> T();<br>        _unlock = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> item;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">Singleton</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!_unlock)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Singleton:The ctor is proxied by singleton and cannot be called from outside.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="优缺点分析"><a href="#优缺点分析" class="headerlink" title="优缺点分析"></a>优缺点分析</h2><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>优点</td><td>1.通过继承实现单例；<br>2.可以通过单例基类规范统一标准；<br>3.线程安全；<br>4.无法通过除单例基类提供的静态属性instance以外的其它方式获取其派生类实例，外部通过new关键字显示调用构造函数或反射等其它获取实例的方式创建派生类实例将触发异常；<br>5.派生类的无参构造函数用于初始化；<br>6.按需加载，延迟初始化。</td></tr><tr><td>缺点</td><td>1.要求派生类的无参构造函数公开；<br>2.派生类对外部始终开放无参构造函数，无法避免new关键字的显式调用所触发的异常；</td></tr></tbody></table><h2 id="版本改进"><a href="#版本改进" class="headerlink" title="版本改进"></a>版本改进</h2><table><thead><tr><th>版本号</th><th>改进内容</th></tr></thead><tbody><tr><td>v1.1</td><td>1.将延迟初始化的工厂方法从Lambda表达式替换为本地静态方法，因为_unlock相对于Lazy<T>是外部引用，所以不可避免存在创建闭包的开销，所以改为本地静态方法进行改进；<br>2._unlock在构造函数中进行重置会存在线程安全的问题，放在作为延迟初始化的工厂方法的本地静态方法中可以保证线程安全。</td></tr><tr><td>…</td><td>…</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>继承实现单例模式的探索（二）</title>
      
      <link href="/posts/2026/01/02/c8ad5abb1cf8/"/>
      <url>/posts/2026/01/02/c8ad5abb1cf8/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章继续探索通过继承实现单例模式的可行方案，这次的方案将采用反射机制隐式创建派生类实例，示例代码为C#。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="v1-0"><a href="#v1-0" class="headerlink" title="v1.0"></a>v1.0</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System.Reflection;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 单例模式基类</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>单例类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">T</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance =&gt; _instance.Value;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Lazy&lt;T&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;T&gt;(Create);<br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> disable CS8603</span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Create</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Activator.CreateInstance(<span class="hljs-keyword">typeof</span>(T),<br>        BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance,<br>        <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>) <span class="hljs-keyword">as</span> T;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> restore CS8603</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-1"><a href="#v1-1" class="headerlink" title="v1.1"></a>v1.1</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 单例模式基类</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>单例类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">T</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance =&gt; _instance?.Value;<br>    <span class="hljs-keyword">static</span> Lazy&lt;T&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;T&gt;(Create);<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _isReleased = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Create</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Activator.CreateInstance(<span class="hljs-keyword">typeof</span>(T),<br>        BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance,<br>        <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>) <span class="hljs-keyword">as</span> T;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isReleased) <span class="hljs-keyword">return</span>;<br>        _isReleased = <span class="hljs-literal">true</span>;<br>        OnRelease();<br>        _instance = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnRelease</span>()</span>;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 单例模式基类</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>单例类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;I&quot;&gt;</span>单例类型的接口类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">I</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span>, <span class="hljs-title">I</span><br><span class="hljs-keyword">where</span> <span class="hljs-title">I</span> : <span class="hljs-title">ISingleton</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> I instance =&gt; _instance?.Value;<br>    <span class="hljs-keyword">static</span> Lazy&lt;T&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;T&gt;(Create);<br>    <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _isReleased = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Create</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Activator.CreateInstance(<span class="hljs-keyword">typeof</span>(T),<br>        BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance,<br>        <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>) <span class="hljs-keyword">as</span> T;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isReleased) <span class="hljs-keyword">return</span>;<br>        _isReleased = <span class="hljs-literal">true</span>;<br>        OnRelease();<br>        _instance = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnRelease</span>()</span>;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 单例接口</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ISingleton</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="优缺点分析"><a href="#优缺点分析" class="headerlink" title="优缺点分析"></a>优缺点分析</h2><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>优点</td><td>1.继承实现单例模式；<br>2.按需加载，延迟初始化；<br>3.线程安全；<br>4.可以通过单例基类规范统一标准；<br>5.派生类的无参构造函数用于初始化；<br>6.将派生类实例创建权限交由派生类本身决定，通常，为遵循单例模式的原则应向外部关闭通过new关键字显式调用构造函数的权限，但这对派生类而言并非硬性要求；</td></tr><tr><td>缺点</td><td>1.反射开销；<br>2.派生类必须具备无参构造函数，且无参构造函数需要向单例基类提供可进行反射访问的权限；</td></tr></tbody></table><h2 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h2><ol><li>在使用单例时应统一通过”类名.instance”的方式访问，而不应为单例所代理的实例创建引用副本，例如单例类型为T，”static T instance &#x3D; 类名.instance”的用法是不推荐的，因为单例通过Release方法显式释放后，其代理的实例也应向GC标记为回收，而外部继续保持其引用则会阻止回收并可能因此导致其它问题，例如所代理的实例包含非托管资源时，若外部引用未进行显式释放则会导致内存泄漏。Release方法的本质在于向外部提供提前释放单例的途径，但并不能完全保证其所代理的实例一定会立刻释放，这取决于是否存在上述情况。</li><li>在显式调用Release方法释放单例后，不应也不能再继续使用该单例，否则会触发空引用的异常。</li><li>对于包含非托管资源的单例派生类应该在OnRelease回调方法和析构函数（终结器）中管理托管和非托管资源的释放，可以参考C#官网对于IDisposable对象的标准写法。</li></ol><h2 id="版本改进"><a href="#版本改进" class="headerlink" title="版本改进"></a>版本改进</h2><table><thead><tr><th>版本号</th><th>改进内容</th></tr></thead><tbody><tr><td>v1.1</td><td>1.添加了以接口类型公开单例对象的基类；<br>2.添加了显式释放单例的方法及其回调。</td></tr><tr><td>…</td><td>…</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Monobehaviour单例实现的探索（一）</title>
      
      <link href="/posts/2026/01/02/1df25a0b0834/"/>
      <url>/posts/2026/01/02/1df25a0b0834/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Unity3D游戏开发中，Monobehaviour单例模式是常见的设计模式之一，具有广泛的应用需求。本篇文章参考自一位外国友人的代码，让我们学习一下他的设计思路吧。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="v1-0"><a href="#v1-0" class="headerlink" title="v1.0"></a>v1.0</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 非持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 会在场景卸载或程序退出等销毁机制中进行销毁</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoBehaviour</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span> &#123; instance = <span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span> T; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnApplicationQuit</span>()</span><br>    &#123;<br>        instance = <span class="hljs-literal">null</span>;<br>        Destroy(gameObject);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 会在场景卸载的销毁机制中保留</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingletonPersistant</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (instance != <span class="hljs-literal">null</span>) Destroy(gameObject);<br>        DontDestroyOnLoad(gameObject);<br>        <span class="hljs-keyword">base</span>.Awake();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-1"><a href="#v1-1" class="headerlink" title="v1.1"></a>v1.1</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 非持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>在Awake中争取静态属性的指向，未争取到的实例将被标记为待销毁对象<span class="hljs-doctag">&lt;/para&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>只要对象处于过激活状态，被销毁时就会触发OnDestroy回调，检查静态属性的指向并可能进行重置<span class="hljs-doctag">&lt;/para&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoBehaviour</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) instance = <span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span> T;<br>        <span class="hljs-keyword">else</span> Destroy(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span> &#123; <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == instance) instance = <span class="hljs-literal">null</span>; &#125;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 在场景卸载过程中保留</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingletonPersistant</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.Awake();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == instance) DontDestroyOnLoad(gameObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-2"><a href="#v1-2" class="headerlink" title="v1.2"></a>v1.2</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 非持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoBehaviour</span><br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T instance =&gt; _instance;<br>    <span class="hljs-keyword">static</span> T _instance;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ReferenceEquals(_instance, <span class="hljs-literal">null</span>)) _instance = <span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span> T;<br>        <span class="hljs-keyword">else</span> Destroy(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ReferenceEquals(<span class="hljs-keyword">this</span>, _instance))<br>            _instance = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 非持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;I&quot;&gt;</span>待封装为单例的类型的接口类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">I</span>&gt; : <span class="hljs-title">MonoBehaviour</span><br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span>, <span class="hljs-title">I</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> I instance =&gt; _instance;<br>    <span class="hljs-keyword">static</span> T _instance;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ReferenceEquals(_instance, <span class="hljs-literal">null</span>)) _instance = <span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span> T;<br>        <span class="hljs-keyword">else</span> Destroy(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (ReferenceEquals(<span class="hljs-keyword">this</span>, _instance))<br>            _instance = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingletonPersistant</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.Awake();<br>        <span class="hljs-keyword">if</span> (ReferenceEquals(<span class="hljs-keyword">this</span>, instance)) DontDestroyOnLoad(gameObject);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 持久化单例</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待封装为单例的类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;I&quot;&gt;</span>待封装为单例的类型的接口类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoSingletonPersistant</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">I</span>&gt; : <span class="hljs-title">MonoSingleton</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">I</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span>, <span class="hljs-title">I</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">base</span>.Awake();<br>        <span class="hljs-keyword">if</span> (ReferenceEquals(<span class="hljs-keyword">this</span>, instance)) DontDestroyOnLoad(gameObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="MonoSingleton"><a href="#MonoSingleton" class="headerlink" title="MonoSingleton"></a>MonoSingleton</h3><ul><li>遵循Unity Monobehaviour脚本的生命周期，该单例有效调用的生命周期起始于Awake，终止于该单例被显式销毁或场景卸载前；</li><li>该单例与多数游戏对象相似，与场景共存，场景卸载时则单例销毁，场景加载时则单例创建，不同的地方在于该单例提供了一个静态属性使得在有效调用的生命周期内可以正确访问该单例；</li><li>该单例应尽量避免跨场景调用，例如存在多个激活的场景，当单例被销毁时，其它场景调用则会导致空引用的异常，除非开发者能很好地管理该单例的调用，但多数时候依旧不建议这么做；</li><li>当在所激活场景中存在多个该单例所代理的同类型Monobehaviour脚本时，单例的静态属性的指向可能是不明确的，并且这往往只能由开发者人为去避免或者进行统一管理，尽管存在这种情况，往往也不会触发显式异常，因为这仅仅是在逻辑上不符合单例模式的唯一原则，并非不符合编译时规范。</li><li>在OnApplicationQuit中显式销毁单例，是因为静态属性的生命周期大于该单例有效调用的生命周期，当存在其它调用者在有效调用生命周期外调用单例时会阻止单例的销毁使其滞留内存，从而导致内存泄漏的问题；</li><li>使用该单例应明确有效调用的生命周期，且保持在该生命周期内进行调用，从而避免引发不必要的异常；</li></ul><h3 id="MonoSingletonPersistant"><a href="#MonoSingletonPersistant" class="headerlink" title="MonoSingletonPersistant"></a>MonoSingletonPersistant</h3><ul><li>该单例在所代理的不同Monobehaviour脚本挂载同一游戏对象的情景中表现不太灵活，除非各Monobehaviour脚本具有共同的生命周期，例如某个单例在之前的场景保持持久化，在该场景特定时机需要销毁不再使用，此时会直接销毁其所挂载的游戏对象，致使其它单例一同销毁；</li><li>在初次实例化单例时，若同一活动场景中存在多个该单例所代理的Monobehaviour脚本，虽然会显式通过Destroy方法标记待销毁的重复实例，但是却继续执行”DontDestroyOnLoad(gameObject);”和”base.Awake();”，通常标记为待销毁的对象我们不应该继续使用，虽然它在本帧最后进行销毁，且不说DontDestroyOnLoad(gameObject)是矛盾的调用，base.Awake()中会导致单例的静态属性指向待销毁对象的Monobehaviour脚本实例，使得原本不会被销毁的Monobehaviour脚本实例的引用丢失；</li><li>若初次实例化单例时，活动场景仅存在一个其所代理的实例，当进入新的活动场景时如果存在重复实例，也会导致第二点所述问题；</li><li>因持久化的特性，该单例可以进行跨场景调用；</li><li>该单例有效调用的生命周期起始于Awake，终止于其显式销毁；</li></ul><h2 id="版本改进"><a href="#版本改进" class="headerlink" title="版本改进"></a>版本改进</h2><table><thead><tr><th>版本号</th><th>改进内容</th></tr></thead><tbody><tr><td>v1.1</td><td>1.单例的静态属性指向采用”先到先得”的原则，取决于同类型实例Awake方法执行的顺序，优先获取静态属性指向的实例在销毁前始终不允许被替换，其它未获取指向的实例均会被销毁，以遵循单例唯一原则；<br>2.重复实例销毁机制改用销毁组件而非其所挂载的游戏对象，降低销毁所影响的范围；<br>3.静态属性指向重置仅在OnDestroy回调函数中进行，且仅针对拥有该静态属性指向的实例进行销毁才会进行重置，对于非持久单例通常发生于场景卸载或显式销毁，对于持久化单例通常发生于程序退出或显式销毁；<br>4.对持久化单例在1.0版本中存在的问题进行了修复。</td></tr><tr><td>v1.2</td><td>1.分别添加了以接口类型开放单例对象的单例基类；<br>2.实例比较方式更改为ReferenceEquals方法；</td></tr><tr><td>…</td><td>…</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> C# </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>字段临时缓存包装器</title>
      
      <link href="/posts/2026/01/01/53c1f0831838/"/>
      <url>/posts/2026/01/01/53c1f0831838/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在实际开发中，我们有时候存在一种需求，例如对于某个字段，我们希望在某个明确的保存节点前对字段的修改都仅作为缓存保留，最终是否应用这些修改取决于某些条件，比如玩家对游戏设置的修改可能需要玩家明确确认应用修改后才会保存下来，在此之前玩家在游戏界面上的所有修改都是临时的。</p><p>本文基于这个需求探索出了一种解决方案——“临时缓存包装器”，通过创建字段或用于存储字段临时数据的数据结构的副本来实现临时缓存，虽然我们同样可以采用直接声明一个同类型的新字段的方式来达到同样的目的，但是这可能会增加冗余代码，且不利于代码的维护，通过包装器来封装临时缓存的通用逻辑，从而与具体业务逻辑进行隔离。</p><p>简介：该类的开发目的是用于给指定类型的源字段创建副本并将其作为源字段的临时缓存，通过该包装器对副本进行一系列的修改，调用者可以在任何需要的时候从该包装器中读取到新的修改，也可以通过解包的方法将副本数据同步到源字段。</p><p>具体功能：</p><ol><li>创建包装器的方式包括二进制包装、JSON包装和自定义创建，分别对应三个静态方法。</li><li>解包方式分为二进制解包和JSON解包，分别对应两个实例方法。</li><li>1.2版本开始仅提供一个基本属性——缓存字段，确认是否为值类型、缓存字段的引用等属性被弃用。</li><li>提供了手动释放包装器的方法，可以在不需要时通知 GC 来释放资源。</li></ol><p>其它说明：</p><ol><li>二进制包装和解包实际上是采用的二进制序列化和反序列化，JSON包装和解包则采用的JSON序列化和反序列化。</li><li>临时包装器适用于引用类型，1.2版本开始将不再支持包装值类型。</li><li>释放包装器后，所有实例成员的访问将会触发无效操作的异常。</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="v1-0"><a href="#v1-0" class="headerlink" title="v1.0"></a>v1.0</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization.Formatters.Binary;<br><span class="hljs-keyword">using</span> Newtonsoft.Json;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 临时包装器</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>字段类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 该类主要用于创造某个字段的副本作为该字段的临时缓存，避免直接修改源字段。</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TempWrapper</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 是否为值类型</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：若为true则表示包装字段为值类型，否则为引用类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isValueType =&gt; _isValueType;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 缓存字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：对于值类型而言，该属性涉及拷贝<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">value</span><br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            <span class="hljs-keyword">return</span> _value;<br>        &#125;<br>        <span class="hljs-keyword">set</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            _value = <span class="hljs-keyword">value</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取引用</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：对于值类型而言，该属性直接返回引用从而避免拷贝<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> T refrence<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">ref</span> _value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 是否已经释放</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isDisposed =&gt; _isDisposed;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _isValueType = <span class="hljs-keyword">typeof</span>(T).IsValueType;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _isDisposable = <span class="hljs-keyword">typeof</span>(IDisposable).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T));<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _key = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>    T _value;<br>    <span class="hljs-built_in">bool</span> _isDisposed;<br><br>    TempWrapper() &#123; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-keyword">if</span> (_isValueType) wrapper._value = <span class="hljs-keyword">value</span>;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>                    &#123;<br>                        IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                        formatter.Serialize(ms, <span class="hljs-keyword">value</span>);<br>                        ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                        wrapper._value = (T)formatter.Deserialize(ms);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-keyword">if</span> (_isValueType) wrapper._value = <span class="hljs-keyword">value</span>;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-built_in">string</span> jsonStr = JsonConvert.SerializeObject(<span class="hljs-keyword">value</span>);<br>                    wrapper._value = JsonConvert.DeserializeObject&lt;T&gt;(jsonStr);<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装生成器所生成的字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;creator&quot;&gt;</span>生成器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByCustom</span>(<span class="hljs-params">Func&lt;T&gt; creator</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;() &#123; _value = creator() &#125;;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnWrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isValueType) <span class="hljs-keyword">value</span> = _value;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">lock</span> (_key)<br>            &#123;<br>                <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>                &#123;<br>                    IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                    formatter.Serialize(ms, _value);<br>                    ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                    <span class="hljs-keyword">value</span> = (T)formatter.Deserialize(ms);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isValueType) <span class="hljs-keyword">value</span> = _value;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">lock</span> (_key)<br>            &#123;<br>                <span class="hljs-built_in">string</span> jsonStr = JsonConvert.SerializeObject(_value);<br>                <span class="hljs-keyword">value</span> = JsonConvert.DeserializeObject&lt;T&gt;(jsonStr);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放包装器所包装的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：当所包装字段实现了IDisposable接口时该方法才有效<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br><br>        DoDispose(<span class="hljs-literal">true</span>);<br>        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DoDispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br><br>        _isDisposed = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (disposing &amp;&amp; _isDisposable &amp;&amp; _value <span class="hljs-keyword">is</span> IDisposable ds)<br>            ds.Dispose();<br>    &#125;<br><br>    ~TempWrapper()<br>    &#123;<br>        DoDispose(<span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-1"><a href="#v1-1" class="headerlink" title="v1.1"></a>v1.1</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization.Formatters.Binary;<br><span class="hljs-keyword">using</span> Newtonsoft.Json;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 临时包装器</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>字段类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 该类主要用于创造某个字段的副本作为该字段的临时缓存，避免直接修改源字段。</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TempWrapper</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 是否为值类型</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：若为true则表示包装字段为值类型，否则为引用类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isValueType =&gt; _isValueType;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 缓存字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：对于值类型而言，该属性涉及拷贝<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">value</span><br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            <span class="hljs-keyword">return</span> _value;<br>        &#125;<br>        <span class="hljs-keyword">set</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            _value = <span class="hljs-keyword">value</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取引用</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：对于值类型而言，该属性直接返回引用从而避免拷贝<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> T refrence<br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">ref</span> _value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _isValueType = <span class="hljs-keyword">typeof</span>(T).IsValueType;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _isDisposable = <span class="hljs-keyword">typeof</span>(IDisposable).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T));<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _key = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>    T _value;<br>    <span class="hljs-built_in">bool</span> _isDisposed;<br><br>    TempWrapper() &#123; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-keyword">if</span> (_isValueType) wrapper._value = <span class="hljs-keyword">value</span>;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>                    &#123;<br>                        IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                        formatter.Serialize(ms, <span class="hljs-keyword">value</span>);<br>                        ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                        wrapper._value = (T)formatter.Deserialize(ms);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-keyword">if</span> (_isValueType) wrapper._value = <span class="hljs-keyword">value</span>;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-built_in">string</span> jsonStr = JsonConvert.SerializeObject(<span class="hljs-keyword">value</span>);<br>                    wrapper._value = JsonConvert.DeserializeObject&lt;T&gt;(jsonStr);<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装生成器所生成的字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;creator&quot;&gt;</span>生成器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByCustom</span>(<span class="hljs-params">Func&lt;T&gt; creator</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;() &#123; _value = creator() &#125;;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnWrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (_isValueType) <span class="hljs-keyword">value</span> = _value;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                formatter.Serialize(ms, _value);<br>                ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                <span class="hljs-keyword">value</span> = (T)formatter.Deserialize(ms);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (_isValueType) <span class="hljs-keyword">value</span> = _value;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonConvert.SerializeObject(_value);<br>            <span class="hljs-keyword">value</span> = JsonConvert.DeserializeObject&lt;T&gt;(jsonStr);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放包装器所包装的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：当所包装字段实现了IDisposable接口时该方法才有效<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        DoDispose(<span class="hljs-literal">true</span>);<br>        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DoDispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br><br>        _isDisposed = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (disposing &amp;&amp; _isDisposable &amp;&amp; _value <span class="hljs-keyword">is</span> IDisposable ds)<br>            ds.Dispose();<br>    &#125;<br><br>    ~TempWrapper()<br>    &#123;<br>        DoDispose(<span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-2"><a href="#v1-2" class="headerlink" title="v1.2"></a>v1.2</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization.Formatters.Binary;<br><span class="hljs-keyword">using</span> Newtonsoft.Json;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 临时包装器</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>字段类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 提示：该类主要用于创造某个字段的副本作为该字段的临时缓存</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TempWrapper</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 缓存字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">value</span><br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            <span class="hljs-keyword">return</span> _value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _isDisposable = <span class="hljs-keyword">typeof</span>(IDisposable).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T));<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _key = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>    T _value;<br>    <span class="hljs-built_in">bool</span> _isDisposed;<br><br>    TempWrapper() &#123; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>                &#123;<br>                    IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                    formatter.Serialize(ms, <span class="hljs-keyword">value</span>);<br>                    ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                    wrapper._value = (T)formatter.Deserialize(ms);<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-built_in">string</span> jsonStr = JsonConvert.SerializeObject(<span class="hljs-keyword">value</span>);<br>                wrapper._value = JsonConvert.DeserializeObject&lt;T&gt;(jsonStr);<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装生成器所生成的字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;creator&quot;&gt;</span>字段生成器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByCustom</span>(<span class="hljs-params">Func&lt;T&gt; creator</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;() &#123; _value = creator() &#125;;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                formatter.Serialize(ms, _value);<br>                ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                <span class="hljs-keyword">value</span> = (T)formatter.Deserialize(ms);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to unwrap.&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> jsonStr = JsonConvert.SerializeObject(_value);<br>            <span class="hljs-keyword">value</span> = JsonConvert.DeserializeObject&lt;T&gt;(jsonStr);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to unwrap.&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放包装器所包装的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：当所包装字段实现了IDisposable接口时该方法才有效<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        DoDispose(<span class="hljs-literal">true</span>);<br>        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DoDispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br><br>        _isDisposed = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (disposing &amp;&amp; _isDisposable &amp;&amp; _value <span class="hljs-keyword">is</span> IDisposable ds)<br>            ds.Dispose();<br>    &#125;<br><br>    ~TempWrapper()<br>    &#123;<br>        DoDispose(<span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-3"><a href="#v1-3" class="headerlink" title="v1.3"></a>v1.3</h3><p>ITempWrapperJsonHandler.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 临时缓存包装器的 JSON 序列化和反序列化接口</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该接口主要用来接引 JSON 序列化和反序列化的第三方库<span class="hljs-doctag">&lt;/para&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITempWrapperJsonHandler</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 将指定对象序列化为 JSON 字符串</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">SerializeObject</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span></span>)</span>;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 根据 JSON 字符串反序列化为指定类型的对象</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>JSON 字符串<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function">T <span class="hljs-title">DeserializeObject</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span></span>) <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>TempWrapper.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization.Formatters.Binary;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 临时包装器</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>字段类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 提示：该类主要用于创造某个字段的副本作为该字段的临时缓存</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TempWrapper</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IDisposable</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 缓存字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">value</span><br>    &#123;<br>        <span class="hljs-keyword">get</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br>            <span class="hljs-keyword">return</span> _value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _isDisposable = <span class="hljs-keyword">typeof</span>(IDisposable).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T));<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _key = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>    T _value;<br>    <span class="hljs-built_in">bool</span> _isDisposed;<br>    ITempWrapperJsonHandler _jsonHandler;<br><br>    TempWrapper() &#123; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>                &#123;<br>                    IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                    formatter.Serialize(ms, <span class="hljs-keyword">value</span>);<br>                    ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                    wrapper._value = (T)formatter.Deserialize(ms);<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化生成字段副本<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装字段的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span>, ITempWrapperJsonHandler handler</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br><br>                <span class="hljs-built_in">string</span> jsonStr = handler.SerializeObject(<span class="hljs-keyword">value</span>);<br>                wrapper._value = handler.DeserializeObject&lt;T&gt;(jsonStr);<br>                wrapper._jsonHandler = handler;<br><br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装生成器所生成的字段并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;creator&quot;&gt;</span>字段生成器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByCustom</span>(<span class="hljs-params">Func&lt;T&gt; creator</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;() &#123; _value = creator() &#125;;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用二进制序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：该方法仅可用于被 <span class="hljs-doctag">&lt;c&gt;</span>Serializable<span class="hljs-doctag">&lt;/c&gt;</span> 标记的字段类型<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream())<br>            &#123;<br>                IFormatter formatter = <span class="hljs-keyword">new</span> BinaryFormatter();<br>                formatter.Serialize(ms, _value);<br>                ms.Seek(<span class="hljs-number">0</span>, SeekOrigin.Begin);<br>                <span class="hljs-keyword">value</span> = (T)formatter.Deserialize(ms);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to unwrap.&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：采用JSON序列化和反序列化解包<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> jsonStr = _jsonHandler.SerializeObject(_value);<br>            <span class="hljs-keyword">value</span> = _jsonHandler.DeserializeObject&lt;T&gt;(jsonStr);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to unwrap.&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放包装器所包装的字段</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：当所包装字段实现了IDisposable接口时该方法才有效<span class="hljs-doctag">&lt;/para&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;The wrapper is disposed.&quot;</span>);<br><br>        DoDispose(<span class="hljs-literal">true</span>);<br>        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DoDispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br><br>        _isDisposed = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (disposing &amp;&amp; _isDisposable &amp;&amp; _value <span class="hljs-keyword">is</span> IDisposable ds)<br>            ds.Dispose();<br>    &#125;<br><br>    ~TempWrapper()<br>    &#123;<br>        DoDispose(<span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="v1-4"><a href="#v1-4" class="headerlink" title="v1.4"></a>v1.4</h3><p>ISerializer.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 通用序列化处理器接口</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;D&quot;&gt;</span>序列化处理的数据类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ISerializer</span>&lt;<span class="hljs-title">D</span>&gt;<br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 序列化</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>实体对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;obj&quot;&gt;</span>实体对象<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>序列化生成的数据<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function">D <span class="hljs-title">Serialize</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T obj</span>)</span>;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 反序列化</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>实体对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;data&quot;&gt;</span>序列化生成的数据<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>实体对象<span class="hljs-doctag">&lt;/returns&gt;</span></span><br>    <span class="hljs-function">T <span class="hljs-title">Deserialize</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">D data</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>TempWrapper.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 临时包装器</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;remarks&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 提示：该类主要用于创造某个对象的副本作为该对象的临时缓存</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/remarks&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TempWrapper</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">ITempWrapper</span>&lt;<span class="hljs-title">T</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 缓存对象</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">value</span> =&gt; _value;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _key = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();<br>    ISerializer&lt;<span class="hljs-built_in">string</span>&gt; _jsonHandler;<br>    ISerializer&lt;Stream&gt; _binaryHandler;<br>    T _value;<br>    <span class="hljs-built_in">bool</span> _released = <span class="hljs-literal">false</span>;<br><br>    TempWrapper() &#123; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定对象并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装对象的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;handler&quot;&gt;</span>二进制序列化处理器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span>, ISerializer&lt;Stream&gt; handler</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br>                Stream stream = handler.Serialize(<span class="hljs-keyword">value</span>);<br>                wrapper._value = handler.Deserialize&lt;T&gt;(stream);<br>                wrapper._binaryHandler = handler;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装指定对象并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;value&quot;&gt;</span>待包装对象的引用<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;handler&quot;&gt;</span>JSON 序列化处理器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span>, ISerializer&lt;<span class="hljs-built_in">string</span>&gt; handler</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;();<br>                <span class="hljs-built_in">string</span> jsonStr = handler.Serialize(<span class="hljs-keyword">value</span>);<br>                wrapper._value = handler.Deserialize&lt;T&gt;(jsonStr);<br>                wrapper._jsonHandler = handler;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 包装生成器所生成的对象并返回包装类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;creator&quot;&gt;</span>对象生成器<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TempWrapper&lt;T&gt; <span class="hljs-title">WrapByCustom</span>(<span class="hljs-params">Func&lt;T&gt; creator</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">lock</span> (_key)<br>        &#123;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                TempWrapper&lt;T&gt; wrapper = <span class="hljs-keyword">new</span> TempWrapper&lt;T&gt;() &#123; _value = creator() &#125;;<br>                <span class="hljs-keyword">return</span> wrapper;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e)<br>            &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to wrap.&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的引用</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByBinary</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Stream stream = _binaryHandler.Serialize(_value);<br>            <span class="hljs-keyword">value</span> = _binaryHandler.Deserialize&lt;T&gt;(stream);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to unwrap.&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 解包包装器并赋值给指定的引用</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnwrapByJson</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> T <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> jsonStr = _jsonHandler.Serialize(_value);<br>            <span class="hljs-keyword">value</span> = _jsonHandler.Deserialize&lt;T&gt;(jsonStr);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Failed to unwrap.&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放包装器</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (_released) <span class="hljs-keyword">return</span>;<br>        _released = <span class="hljs-literal">true</span>;<br>        _jsonHandler = <span class="hljs-literal">null</span>;<br>        _binaryHandler = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (_value <span class="hljs-keyword">is</span> IDisposable ds) ds.Dispose();<br>        _value = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>字段临时缓存包装器有三种包装字段的方式，分别是WrapByBinary、WrapByJson和WrapByCustom，三种方式各有优缺点，择优而用。WrapByBinary采用二进制序列化和反序列化生成字段副本，该方法仅可用于被 Serializable 标记的字段类型。WrapByJson采用JSON序列化和反序列化生成字段副本，它虽然比前者包装范围更广，但是不可避免可能会依赖第三方用于JSON序列化和反序列化的库。WrapByCustom则是对前两种方式的补充，当前两种方式都不适用时，则可以自定义包装方式，例如对于Unity对象来说，需要通过Instantiate方法创建对象副本，这个时候就只能用自定义的方法进行包装。</p><p>返回的包装器提供了一些属性和方法，提供了针对WrapByBinary和WrapByJson包装方法的解包方法，还提供了显式释放包装器的方法。解包方法用于将临时缓存的数据重新写入被包装字段中。通过显式释放包装器可以保证那些使用了非托管资源的类型（实现了IDisposable接口）进行资源的释放工作，从而避免内存泄漏等问题。</p><p>但是该包装器存在一些不可避免的限制，若所包装字段越复杂，其性能消耗越高，这是不可避免的。</p><p>注意：不要使用包装器去包装其声明所在的类，特别是对于自定义包装逻辑要避免无限递归，否则会导致栈溢出或内存泄漏问题。示例代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 该方法将导致栈溢出</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">A</span><br>&#123;<br>    TempWrapper&lt;A&gt; wrapper;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">A</span>()</span><br>    &#123;<br>        wrapper = TempWrapper&lt;A&gt;.WrapByCustom(() =&gt; <span class="hljs-keyword">new</span> A());<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 该方法将导致内存泄漏</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">B</span>:<span class="hljs-title">Monobehaviour</span><br>&#123;<br>    TempWrapper&lt;Transform&gt; wrapper;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        <span class="hljs-comment">// Instantiate方法去克隆当前组件对象的Transform组件就会导致无限递归</span><br>        wrapper = TempWrapper&lt;Transform&gt;.WrapByCustom(() =&gt; Instantiate(transform));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="版本改进"><a href="#版本改进" class="headerlink" title="版本改进"></a>版本改进</h2><table><thead><tr><th>版本号</th><th>改进内容</th></tr></thead><tbody><tr><td>v1.1</td><td>1.实例方法不使用线程锁，仅对静态方法使用线程锁；<br>2.手动执行Dispose方法释放包装器后，所有对公开实例成员的访问都将触发异常；<br>3.删除IsDisposed属性；</td></tr><tr><td>v1.2</td><td>1.添加了引用类型泛型限制，弃用对值类型包装的支持；<br>2.关闭了value属性的set访问器，避免外部更改包装器所代理的字段，保持包装器状态的不变性，可变引用类型的内部状态不受约束，若开启set访问器可能导致内存泄漏的问题；<br>3.为解包方法添加了异常捕捉；</td></tr><tr><td>v1.3</td><td>移除了对第三方Json库的直接依赖，而是改用接口来接引第三方Json库，这样可以避免对特定库的依赖，还可以灵活更换库。</td></tr><tr><td>v1.4</td><td>1.移除了对具体的二进制序列化和反序列化规则的依赖，而是改用接口来接引，使得可以进行灵活的扩展；<br>2.移除了对IDisposable接口的实现和析构函数，改用Release方法；<br>3.无论是Json还是二进制，均使用统一的规则接口ISerializer。</td></tr><tr><td>…</td><td>…</td></tr></tbody></table><div style="text-align: center">× 表示在指定版本已不受支持</div><table><thead><tr><th>字段、属性、方法</th><th>v1.0</th><th>v1.1</th><th>v1.2</th><th>v1.3</th><th>v1.4</th></tr></thead><tbody><tr><td>isValueType</td><td>√</td><td>√</td><td>√</td><td>×</td><td>×</td></tr><tr><td>value</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td>reference</td><td>√</td><td>√</td><td>×</td><td>×</td><td>×</td></tr><tr><td>isDisposed</td><td>√</td><td>×</td><td>×</td><td>×</td><td>×</td></tr><tr><td>WrapByBinary</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td>WrapByJson</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td>WrapByCustom</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td>UnwrapByBinary</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td>UnwrapByJson</td><td>√</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Dispose</td><td>√</td><td>√</td><td>√</td><td>√</td><td>×</td></tr><tr><td>Release</td><td>×</td><td>×</td><td>×</td><td>×</td><td>√</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>基于ScriptableObject设计游戏数据表</title>
      
      <link href="/posts/2026/01/01/fa9905321cd4/"/>
      <url>/posts/2026/01/01/fa9905321cd4/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章是针对之前对于ScriptableObject概念讲解的实际应用之一，在游戏开发中，我们可以使用该类来设计编辑器时的可读写数据表或者运行时的只读数据表。本文将针对运行时的只读数据表的应用进行探索，并且结合自定义的本地持久化存储方式使得基于ScriptableObject开发的数据表能够在运行时进行读写。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="代码目录结构"><a href="#代码目录结构" class="headerlink" title="代码目录结构"></a>代码目录结构</h3><ul><li>Table<ul><li>Base</li><li>Editor</li><li>Interface</li><li>Unit</li></ul></li></ul><blockquote><p>Table则为本模块的根目录，存储各个游戏数据表的脚本，Base目录存储数据表和游戏表基类，Editor目录存储数据表的编辑器脚本，Interface目录存储数据表和数据单元接口，Unit目录存储数据单元。</p></blockquote><h3 id="Base目录"><a href="#Base目录" class="headerlink" title="Base目录"></a>Base目录</h3><p>BaseTable.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 基础表</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseTable</span> : <span class="hljs-title">ScriptableObject</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 表类型</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Type mType &#123; <span class="hljs-keyword">get</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>GameTable.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.ObjectModel;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> 游戏表</span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T0&quot;&gt;</span>表类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T1&quot;&gt;</span>表单元类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameTable</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>&gt; : <span class="hljs-title">BaseTable</span>, <span class="hljs-title">ITableHandler</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T0</span> : <span class="hljs-title">GameTable</span>&lt;<span class="hljs-title">T0</span>, <span class="hljs-title">T1</span>&gt;<br><span class="hljs-keyword">where</span> <span class="hljs-title">T1</span> : <span class="hljs-title">ITableUnit</span><br>&#123;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;是否自动控制加载和保存&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isAutoControl = <span class="hljs-literal">true</span>;<br>    [<span class="hljs-meta">HideInInspector, SerializeField</span>] <span class="hljs-keyword">protected</span> T1[] units;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> UNITY_EDITOR</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> disable CS0414</span><br>    [<span class="hljs-meta">HideInInspector, SerializeField</span>] <span class="hljs-built_in">bool</span> isAutoSave = <span class="hljs-literal">true</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">warning</span> restore CS0414</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> Type mType =&gt; <span class="hljs-keyword">typeof</span>(T0);<br><br>    <span class="hljs-keyword">public</span> ReadOnlyCollection&lt;T1&gt; mUnits =&gt; Array.AsReadOnly(wrapper.<span class="hljs-keyword">value</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mCount =&gt; wrapper.<span class="hljs-keyword">value</span> == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : wrapper.<span class="hljs-keyword">value</span>.Length;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> Action&lt;T1&gt; mModifiedCallback;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">string</span> jsonPath;<br><br>    <span class="hljs-keyword">protected</span> TempWrapper&lt;T1[]&gt; wrapper;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 保存到本地</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SaveLocally</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (Application.isEditor) <span class="hljs-keyword">return</span>;<br><br>        wrapper.UnWrapByBinary(<span class="hljs-keyword">ref</span> units);<br>        <span class="hljs-built_in">string</span> jsonStr = JsonUtility.ToJson(<span class="hljs-keyword">this</span>);<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(jsonStr))<br>        &#123;<br>            <span class="hljs-built_in">string</span> dirPath = Path.GetDirectoryName(jsonPath);<br>            <span class="hljs-keyword">if</span> (!Directory.Exists(dirPath)) Directory.CreateDirectory(dirPath);<br>            <span class="hljs-keyword">if</span> (!File.Exists(jsonPath)) File.Create(jsonPath).Dispose();<br><br>            <span class="hljs-keyword">using</span> (FileStream fs = <span class="hljs-keyword">new</span> FileStream(jsonPath, FileMode.OpenOrCreate, FileAccess.Write))<br>            &#123;<br>                <span class="hljs-built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(jsonStr);<br>                fs.Write(bytes, <span class="hljs-number">0</span>, bytes.Length);<br>                fs.Flush();<br>                fs.Close();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 从本地加载</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadFromLoacl</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (Application.isEditor) <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-keyword">if</span> (File.Exists(jsonPath))<br>        &#123;<br>            <span class="hljs-keyword">using</span> (TextReader tr = <span class="hljs-keyword">new</span> StreamReader(jsonPath, Encoding.UTF8))<br>            &#123;<br>                <span class="hljs-built_in">string</span> jsonStr = tr.ReadToEnd();<br><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(jsonStr))<br>                &#123;<br>                    <span class="hljs-keyword">try</span><br>                    &#123;<br>                        JsonUtility.FromJsonOverwrite(jsonStr, <span class="hljs-keyword">this</span>);<br>                        <span class="hljs-built_in">int</span> len = units.Length;<br>                        wrapper.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">new</span> T1[len];<br>                        units.CopyTo(wrapper.<span class="hljs-keyword">value</span>, <span class="hljs-number">0</span>);<br>                        InvokeModifiedEvents();<br>                    &#125;<br>                    <span class="hljs-keyword">catch</span> (Exception e)<br>                    &#123;<br>                        LogUtility.Log(e.Message, LogType.Error);<br>                    &#125;<br>                &#125;<br>                tr.Close();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> dirPath = Path.GetDirectoryName(jsonPath);<br>            <span class="hljs-keyword">if</span> (!Directory.Exists(dirPath)) Directory.CreateDirectory(dirPath);<br>            <span class="hljs-keyword">if</span> (!File.Exists(jsonPath)) File.Create(jsonPath).Dispose();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ShareUnitsWith</span>(<span class="hljs-params">T1[] array</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> len = wrapper.<span class="hljs-keyword">value</span>.Length;<br><br>        <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span> || array.Length != len)<br>            array = <span class="hljs-keyword">new</span> T1[len];<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            array[i] = wrapper.<span class="hljs-keyword">value</span>[i];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetDefault</span>()</span><br>    &#123;<br>        T0 table = Resources.Load&lt;T0&gt;(GamePathUtility.GetTableResourcesPath&lt;T0&gt;());<br><br>        <span class="hljs-keyword">if</span> (table != <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-built_in">int</span> len = table.units.Length;<br>            wrapper.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">new</span> T1[len];<br>            table.units.CopyTo(wrapper.<span class="hljs-keyword">value</span>, <span class="hljs-number">0</span>);<br>            InvokeModifiedEvents();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> T1 <span class="hljs-title">Get</span>(<span class="hljs-params">Func&lt;T1, <span class="hljs-built_in">bool</span>&gt; logic</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (logic == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">default</span>;<br><br>        <span class="hljs-built_in">int</span> len = wrapper.<span class="hljs-keyword">value</span>.Length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            <span class="hljs-keyword">ref</span> T1 unit = <span class="hljs-keyword">ref</span> wrapper.<span class="hljs-keyword">value</span>[i];<br>            <span class="hljs-keyword">if</span> (logic(unit)) <span class="hljs-keyword">return</span> unit;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">default</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> T1 <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> len = wrapper.<span class="hljs-keyword">value</span>.Length;<br>        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= len) <span class="hljs-keyword">return</span> <span class="hljs-literal">default</span>;<br>        <span class="hljs-keyword">return</span> wrapper.<span class="hljs-keyword">value</span>[index];<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Set</span>(<span class="hljs-params">Func&lt;T1, T1&gt; logic</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (logic == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-built_in">int</span> len = wrapper.<span class="hljs-keyword">value</span>.Length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            wrapper.<span class="hljs-keyword">value</span>[i] = logic(wrapper.<span class="hljs-keyword">value</span>[i]);<br>        &#125;<br>        InvokeModifiedEvents();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">InvokeModifiedEvents</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (mModifiedCallback != <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-built_in">int</span> len = wrapper.<span class="hljs-keyword">value</span>.Length;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>            &#123;<br>                mModifiedCallback.Invoke(wrapper.<span class="hljs-keyword">value</span>[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>    &#123;<br>        jsonPath = Path.Combine(Application.dataPath, <span class="hljs-string">$&quot;Json/<span class="hljs-subst">&#123;mType.Name&#125;</span>.json&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnEnable</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (units == <span class="hljs-literal">null</span>) units = Array.Empty&lt;T1&gt;();<br>        <span class="hljs-keyword">if</span> (wrapper == <span class="hljs-literal">null</span>) wrapper = TempWrapper&lt;T1[]&gt;.WrapByBinary(<span class="hljs-keyword">ref</span> units);<br>        <span class="hljs-keyword">if</span> (isAutoControl) LoadFromLoacl();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDisable</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (isAutoControl) SaveLocally();<br><br>        <span class="hljs-keyword">if</span> (wrapper != <span class="hljs-literal">null</span>)<br>        &#123;<br>            wrapper.Dispose();<br>            wrapper = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Interface目录"><a href="#Interface目录" class="headerlink" title="Interface目录"></a>Interface目录</h3><p>ITableHandler.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.ObjectModel;<br><br><span class="hljs-comment">// 表处理接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITableHandler</span>&lt;<span class="hljs-title">TTable</span>, <span class="hljs-title">TUnit</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">TTable</span> : <span class="hljs-title">BaseTable</span> <span class="hljs-keyword">where</span> <span class="hljs-title">TUnit</span> : <span class="hljs-title">ITableUnit</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 表单元合集的只读视图</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    ReadOnlyCollection&lt;TUnit&gt; mUnits &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 表单元合集中元素个数</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-built_in">int</span> mCount &#123; <span class="hljs-keyword">get</span>; &#125;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 表单元合集更改回调</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">event</span> Action&lt;TUnit&gt; mModifiedCallback;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 分享表单元合集给指定的数组变量</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;array&quot;&gt;</span>指定的数组变量<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ShareUnitsWith</span>(<span class="hljs-params">TUnit[] array</span>)</span>;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 设置为默认值</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SetDefault</span>()</span>;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取表单元</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;logic&quot;&gt;</span>获取逻辑<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function">TUnit <span class="hljs-title">Get</span>(<span class="hljs-params">Func&lt;TUnit, <span class="hljs-built_in">bool</span>&gt; logic</span>)</span>;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取表单元</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;index&quot;&gt;</span>索引<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function">TUnit <span class="hljs-title">Get</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index</span>)</span>;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 修改表单元</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name=&quot;logic&quot;&gt;</span>修改逻辑<span class="hljs-doctag">&lt;/param&gt;</span></span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Set</span>(<span class="hljs-params">Func&lt;TUnit, TUnit&gt; logic</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ITableUnit.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 表单元接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ITableUnit</span> &#123; &#125;<br></code></pre></td></tr></table></figure><h3 id="Editor目录"><a href="#Editor目录" class="headerlink" title="Editor目录"></a>Editor目录</h3><p>GameTableEditor.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment">// 游戏表编辑器</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameTableEditor</span> : <span class="hljs-title">Editor</span><br>&#123;<br>    <span class="hljs-keyword">protected</span> SerializedProperty units, isAutoSave;<br>    <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> tip = <span class="hljs-string">&quot;Should be saved after modification. Everything will be saved when we leave the inspector unless you don&#x27;t check &#x27;Is Auto Save&#x27;. In runtime, everything will be loaded from local in &#x27;OnEnable&#x27; and saved to local in &#x27;OnDisable&#x27; unless you don&#x27;t check &#x27;Is Auto Control&#x27;.&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Init</span>()</span><br>    &#123;<br>        units = serializedObject.FindProperty(<span class="hljs-string">&quot;units&quot;</span>);<br>        isAutoSave = serializedObject.FindProperty(<span class="hljs-string">&quot;isAutoSave&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SaveGUI</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (GUILayout.Button(<span class="hljs-string">&quot;Save&quot;</span>)) Save();<br>        isAutoSave.boolValue = EditorGUILayout.Toggle(isAutoSave.displayName, isAutoSave.boolValue);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TipGUI</span>()</span><br>    &#123;<br>        EditorGUILayout.HelpBox(tip, MessageType.Info);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>()</span> &#123; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDisable</span>()</span> &#123; <span class="hljs-keyword">if</span> (isAutoSave.boolValue) Save(); &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="示例（鼠标样式表）"><a href="#示例（鼠标样式表）" class="headerlink" title="示例（鼠标样式表）"></a>示例（鼠标样式表）</h3><p>CursorStyleUIUnit.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.UI;<br><br><span class="hljs-comment">// 鼠标样式UI单元</span><br>[<span class="hljs-meta">Serializable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CursorStyleUIUnit</span><br>&#123;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;鼠标样式类型&quot;</span>)</span>] <span class="hljs-keyword">public</span> CursorStyleType styleType;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;Dropdown组件&quot;</span>)</span>] <span class="hljs-keyword">public</span> Dropdown dropdown;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;当前选项的Image组件&quot;</span>)</span>] <span class="hljs-keyword">public</span> Image showImage;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;Dropdown组件选项模板下自定义的Image组件&quot;</span>)</span>] <span class="hljs-keyword">public</span> Image itemShowImage;<br>&#125;<br></code></pre></td></tr></table></figure><p>CursorStyleUnit.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment">// 鼠标样式单元</span><br>[<span class="hljs-meta">Serializable</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> CursorStyleUnit : ITableUnit<br>&#123;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;鼠标样式的属性名称&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> key;<br>    [<span class="hljs-meta">Tooltip(<span class="hljs-string">&quot;鼠标样式的属性值&quot;</span>)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CursorStyleUnit</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> key, <span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span></span>)</span><br>    &#123;<br>        <span class="hljs-keyword">this</span>.key = key;<br>        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">value</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>CursorStyleTable.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-comment">// 鼠标样式单元存储表</span><br>[<span class="hljs-meta">CreateAssetMenu(fileName = <span class="hljs-string">&quot;Assets/Resources/Tables/CursorStyleTable&quot;</span>, menuName = <span class="hljs-string">&quot;Custom/Create CursorStyle Table&quot;</span>, order = 1)</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CursorStyleTable</span> : <span class="hljs-title">GameTable</span>&lt;<span class="hljs-title">CursorStyleTable</span>, <span class="hljs-title">CursorStyleUnit</span>&gt;<br>&#123;<br>    [<span class="hljs-meta">HideInInspector, SerializeField</span>] CursorShape defaultShape;<br>    [<span class="hljs-meta">HideInInspector, SerializeField</span>] CursorColor defaultColor;<br>    [<span class="hljs-meta">HideInInspector, SerializeField</span>] <span class="hljs-built_in">int</span> defaultSize;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 默认鼠标形状</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> CursorShape mDefaultShape =&gt; defaultShape;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 默认鼠标颜色</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> CursorColor mDefaultColor =&gt; defaultColor;<br><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 默认鼠标尺寸</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> mDefaultSize =&gt; defaultSize;<br>&#125;<br></code></pre></td></tr></table></figure><p>CursorStyleTableEditor.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> UnityEditor;<br><span class="hljs-keyword">using</span> UnityEditorInternal;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br>[<span class="hljs-meta">CustomEditor(typeof(CursorStyleTable))</span>]<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CursorStyleTableEditor</span> : <span class="hljs-title">GameTableEditor</span><br>&#123;<br>    SerializedProperty defaultShape, defaultColor, defaultSize;<br>    ReorderableList list;<br>    <span class="hljs-built_in">string</span>[] styleTypes; <span class="hljs-comment">// 样式类型合集</span><br>    Dictionary&lt;<span class="hljs-built_in">int</span>, Style&gt; styles; <span class="hljs-comment">// key表示该项在整个集合中的索引，value表示样式</span><br>    Style defaultShapeStyle, defaultColorStyle, defaultSizeStyle; <span class="hljs-comment">// 样式默认值</span><br>    GUIContent defaultShapeContent, defaultColorContent, defaultSizeContent;<br>    <span class="hljs-built_in">string</span>[] shapeDisplayNames, colorDisplayNames, sizeDisplayNames; <span class="hljs-comment">// 样式默认值下拉菜单选项</span><br>    <span class="hljs-built_in">int</span> _shapeIndex, _colorIndex, _sizeIndex; <span class="hljs-comment">// 样式默认值所选菜单项索引</span><br>    <span class="hljs-built_in">bool</span> isStylesDirty;<br><br>    <span class="hljs-built_in">int</span> shapeIndex<br>    &#123;<br>        <span class="hljs-keyword">get</span> =&gt; _shapeIndex;<br>        <span class="hljs-keyword">set</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_shapeIndex != <span class="hljs-keyword">value</span>)<br>            &#123;<br>                _shapeIndex = <span class="hljs-keyword">value</span>;<br>                UpdateDefaultStyles(Array.FindIndex(styleTypes, t =&gt; t == CursorStyleConstant.SHAPE));<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">int</span> colorIndex<br>    &#123;<br>        <span class="hljs-keyword">get</span> =&gt; _colorIndex;<br>        <span class="hljs-keyword">set</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_colorIndex != <span class="hljs-keyword">value</span>)<br>            &#123;<br>                _colorIndex = <span class="hljs-keyword">value</span>;<br>                UpdateDefaultStyles(Array.FindIndex(styleTypes, t =&gt; t == CursorStyleConstant.COLOR));<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">int</span> sizeIndex<br>    &#123;<br>        <span class="hljs-keyword">get</span> =&gt; _sizeIndex;<br>        <span class="hljs-keyword">set</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_sizeIndex != <span class="hljs-keyword">value</span>)<br>            &#123;<br>                _sizeIndex = <span class="hljs-keyword">value</span>;<br>                UpdateDefaultStyles(Array.FindIndex(styleTypes, t =&gt; t == CursorStyleConstant.SIZE));<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 记录每种样式类型和值</span><br>    <span class="hljs-keyword">struct</span> Style<br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> styleTypeIndex; <span class="hljs-comment">// 样式类型索引</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span>; <span class="hljs-comment">// 样式值</span><br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Style</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> styleTypeIndex, <span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span></span>)</span><br>        &#123;<br>            <span class="hljs-keyword">this</span>.styleTypeIndex = styleTypeIndex;<br>            <span class="hljs-keyword">this</span>.<span class="hljs-keyword">value</span> = <span class="hljs-keyword">value</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">CompareTo</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> Style other</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> styleTypeIndex == other.styleTypeIndex &amp;&amp; <span class="hljs-keyword">value</span> == other.<span class="hljs-keyword">value</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnEnable</span>()</span><br>    &#123;<br>        Init();<br>        defaultShape = serializedObject.FindProperty(<span class="hljs-string">&quot;defaultShape&quot;</span>);<br>        defaultColor = serializedObject.FindProperty(<span class="hljs-string">&quot;defaultColor&quot;</span>);<br>        defaultSize = serializedObject.FindProperty(<span class="hljs-string">&quot;defaultSize&quot;</span>);<br><br>        list = <span class="hljs-keyword">new</span> ReorderableList(serializedObject, units, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)<br>        &#123;<br>            drawElementCallback = DrawUnitCallback,<br>            onAddCallback = OnAddElement,<br>            onRemoveCallback = OnDelElement<br>        &#125;;<br><br>        styleTypes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>[] &#123; CursorStyleConstant.SHAPE, CursorStyleConstant.COLOR, CursorStyleConstant.SIZE &#125;;<br>        styles = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, Style&gt;();<br><br>        defaultShapeStyle.styleTypeIndex = Array.FindIndex(styleTypes, t =&gt; t == CursorStyleConstant.SHAPE);<br>        defaultShapeStyle.<span class="hljs-keyword">value</span> = ((CursorShape)defaultShape.intValue).ToString();<br>        defaultColorStyle.styleTypeIndex = Array.FindIndex(styleTypes, t =&gt; t == CursorStyleConstant.COLOR);<br>        defaultColorStyle.<span class="hljs-keyword">value</span> = ((CursorColor)defaultColor.intValue).ToString();<br>        defaultSizeStyle.styleTypeIndex = Array.FindIndex(styleTypes, t =&gt; t == CursorStyleConstant.SIZE);<br>        defaultSizeStyle.<span class="hljs-keyword">value</span> = defaultSize.intValue.ToString();<br><br>        <span class="hljs-built_in">int</span> len = units.arraySize;<br>        SerializedProperty element;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            element = units.GetArrayElementAtIndex(i);<br>            <span class="hljs-built_in">int</span> styleTypeIndex = Array.IndexOf(styleTypes, element.FindPropertyRelative(<span class="hljs-string">&quot;key&quot;</span>).stringValue);<br>            AddOrSetElement(i, <span class="hljs-keyword">new</span> Style(styleTypeIndex, element.FindPropertyRelative(<span class="hljs-string">&quot;value&quot;</span>).stringValue));<br>        &#125;<br><br>        defaultShapeContent = <span class="hljs-keyword">new</span> GUIContent(defaultShape.displayName, defaultShape.tooltip);<br>        defaultColorContent = <span class="hljs-keyword">new</span> GUIContent(defaultColor.displayName, defaultColor.tooltip);<br>        defaultSizeContent = <span class="hljs-keyword">new</span> GUIContent(defaultSize.displayName, defaultSize.tooltip);<br><br>        len = styleTypes.Length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            UpdateDefaultDisplayNames(i);<br>        &#125;<br><br>        <span class="hljs-built_in">string</span> str = defaultShapeStyle.<span class="hljs-keyword">value</span>;<br>        _shapeIndex = Array.FindIndex(shapeDisplayNames, s =&gt; s == str);<br>        str = defaultColorStyle.<span class="hljs-keyword">value</span>;<br>        _colorIndex = Array.FindIndex(colorDisplayNames, s =&gt; s == str);<br>        str = defaultSizeStyle.<span class="hljs-keyword">value</span>;<br>        _sizeIndex = Array.FindIndex(sizeDisplayNames, s =&gt; s == str);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DrawUnitCallback</span>(<span class="hljs-params">Rect rect, <span class="hljs-built_in">int</span> index, <span class="hljs-built_in">bool</span> isActive, <span class="hljs-built_in">bool</span> isFocused</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (index &gt;= styles.Count) styles[index] = <span class="hljs-keyword">new</span> Style();<br><br>        Style style = styles[index];<br>        rect.y += <span class="hljs-number">2</span>;<br>        style.styleTypeIndex = EditorGUI.Popup(<span class="hljs-keyword">new</span> Rect(rect.x, rect.y, <span class="hljs-number">80</span>, EditorGUIUtility.singleLineHeight), style.styleTypeIndex, styleTypes);<br>        style.<span class="hljs-keyword">value</span> = EditorGUI.TextField(<span class="hljs-keyword">new</span> Rect(rect.x + <span class="hljs-number">100</span>, rect.y, rect.width - <span class="hljs-number">100</span>, EditorGUIUtility.singleLineHeight), style.<span class="hljs-keyword">value</span>);<br>        UpdateStyle(<span class="hljs-keyword">ref</span> style, index);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnAddElement</span>(<span class="hljs-params">ReorderableList list</span>)</span><br>    &#123;<br>        ReorderableList.defaultBehaviours.DoAddButton(list);<br>        AddOrSetElement(list.count - <span class="hljs-number">1</span>, <span class="hljs-keyword">new</span> Style(<span class="hljs-number">0</span>, <span class="hljs-built_in">string</span>.Empty));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDelElement</span>(<span class="hljs-params">ReorderableList list</span>)</span><br>    &#123;<br>        DelElement(list.index);<br>        ReorderableList.defaultBehaviours.DoRemoveButton(list);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">AddOrSetElement</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index, Style style</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (style.styleTypeIndex &lt; <span class="hljs-number">0</span> || style.styleTypeIndex &gt;= styleTypes.Length<br>        || <span class="hljs-built_in">string</span>.IsNullOrEmpty(style.<span class="hljs-keyword">value</span>) || index &lt; <span class="hljs-number">0</span> || index &gt;= list.count) <span class="hljs-keyword">return</span>;<br><br>        styles[index] = style;<br>        UpdateDefaultDisplayNames(style.styleTypeIndex);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DelElement</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        Style style = styles[index];<br>        styles.Remove(index);<br>        UpdateDefaultDisplayNames(style.styleTypeIndex);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateDefaultDisplayNames</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] styleTypeIndexes</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (styleTypeIndexes == <span class="hljs-literal">null</span> || styleTypeIndexes.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-built_in">int</span> len = styleTypeIndexes.Length;<br>        <span class="hljs-keyword">var</span> <span class="hljs-keyword">group</span> = styles.GroupBy(kv =&gt; kv.Value.styleTypeIndex);<br>        <span class="hljs-built_in">string</span> CONST_STR;<br>        IGrouping&lt;<span class="hljs-built_in">int</span>, KeyValuePair&lt;<span class="hljs-built_in">int</span>, Style&gt;&gt; temp;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            <span class="hljs-built_in">int</span> index = styleTypeIndexes[i];<br>            <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= styleTypes.Length) <span class="hljs-keyword">continue</span>;<br>            CONST_STR = styleTypes[index];<br><br>            <span class="hljs-keyword">switch</span> (CONST_STR)<br>            &#123;<br>                <span class="hljs-keyword">case</span> CursorStyleConstant.SHAPE:<br>                    temp = <span class="hljs-keyword">group</span>.Where(g =&gt; g.Key == index).FirstOrDefault();<br>                    <span class="hljs-keyword">if</span> (temp != <span class="hljs-literal">null</span>) shapeDisplayNames = temp.Select(kv =&gt; kv.Value.<span class="hljs-keyword">value</span>).ToArray();<br>                    <span class="hljs-keyword">else</span> shapeDisplayNames = Array.Empty&lt;<span class="hljs-built_in">string</span>&gt;();<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> CursorStyleConstant.COLOR:<br>                    temp = <span class="hljs-keyword">group</span>.Where(g =&gt; g.Key == index).FirstOrDefault();<br>                    <span class="hljs-keyword">if</span> (temp != <span class="hljs-literal">null</span>) colorDisplayNames = temp.Select(kv =&gt; kv.Value.<span class="hljs-keyword">value</span>).ToArray();<br>                    <span class="hljs-keyword">else</span> colorDisplayNames = Array.Empty&lt;<span class="hljs-built_in">string</span>&gt;();<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> CursorStyleConstant.SIZE:<br>                    temp = <span class="hljs-keyword">group</span>.Where(g =&gt; g.Key == index).FirstOrDefault();<br>                    <span class="hljs-keyword">if</span> (temp != <span class="hljs-literal">null</span>) sizeDisplayNames = temp.Select(kv =&gt; kv.Value.<span class="hljs-keyword">value</span>).ToArray();<br>                    <span class="hljs-keyword">else</span> sizeDisplayNames = Array.Empty&lt;<span class="hljs-built_in">string</span>&gt;();<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateDefaultStyles</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] styleTypeIndexes</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (styleTypeIndexes == <span class="hljs-literal">null</span> || styleTypeIndexes.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br><br>        <span class="hljs-built_in">int</span> len = styleTypeIndexes.Length;<br>        <span class="hljs-built_in">string</span> CONST_STR;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            <span class="hljs-built_in">int</span> index = styleTypeIndexes[i];<br>            <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= styleTypes.Length) <span class="hljs-keyword">continue</span>;<br>            CONST_STR = styleTypes[index];<br><br>            <span class="hljs-keyword">switch</span> (CONST_STR)<br>            &#123;<br>                <span class="hljs-keyword">case</span> CursorStyleConstant.SHAPE:<br>                    <span class="hljs-keyword">if</span> (_shapeIndex &lt; <span class="hljs-number">0</span> || _shapeIndex &gt;= shapeDisplayNames.Length)<br>                        defaultShapeStyle.<span class="hljs-keyword">value</span> = CursorShape.None.ToString();<br>                    <span class="hljs-keyword">else</span> defaultShapeStyle.<span class="hljs-keyword">value</span> = shapeDisplayNames[_shapeIndex];<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> CursorStyleConstant.COLOR:<br>                    <span class="hljs-keyword">if</span> (_colorIndex &lt; <span class="hljs-number">0</span> || _colorIndex &gt;= colorDisplayNames.Length)<br>                        defaultColorStyle.<span class="hljs-keyword">value</span> = CursorColor.None.ToString();<br>                    <span class="hljs-keyword">else</span> defaultColorStyle.<span class="hljs-keyword">value</span> = colorDisplayNames[_colorIndex];<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> CursorStyleConstant.SIZE:<br>                    <span class="hljs-keyword">if</span> (_sizeIndex &lt; <span class="hljs-number">0</span> || _sizeIndex &gt;= sizeDisplayNames.Length)<br>                        defaultSizeStyle.<span class="hljs-keyword">value</span> = <span class="hljs-string">&quot;0&quot;</span>;<br>                    <span class="hljs-keyword">else</span> defaultSizeStyle.<span class="hljs-keyword">value</span> = sizeDisplayNames[_sizeIndex];<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateStyle</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> Style style, <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (!styles[index].CompareTo(<span class="hljs-keyword">ref</span> style))<br>        &#123;<br>            styles[index] = style;<br>            isStylesDirty = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInspectorGUI</span>()</span><br>    &#123;<br>        serializedObject.Update();<br>        <span class="hljs-keyword">base</span>.OnInspectorGUI();<br><br>        EditorGUILayout.LabelField(<span class="hljs-string">&quot;鼠标样式单元合集&quot;</span>, EditorStyles.boldLabel);<br>        list.DoLayoutList();<br><br>        EditorGUILayout.LabelField(<span class="hljs-string">&quot;鼠标样式默认值&quot;</span>, EditorStyles.boldLabel);<br><br>        <span class="hljs-keyword">if</span> (isStylesDirty)<br>        &#123;<br>            isStylesDirty = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; styleTypes.Length; i++)<br>            &#123;<br>                UpdateDefaultDisplayNames(i);<br>                UpdateDefaultStyles(i);<br>            &#125;<br>        &#125;<br><br>        EditorGUI.BeginDisabledGroup(shapeDisplayNames.Length == <span class="hljs-number">0</span>);<br>        shapeIndex = EditorGUILayout.Popup(defaultShapeContent, shapeIndex, shapeDisplayNames);<br>        EditorGUI.EndDisabledGroup();<br><br>        EditorGUI.BeginDisabledGroup(colorDisplayNames.Length == <span class="hljs-number">0</span>);<br>        colorIndex = EditorGUILayout.Popup(defaultColorContent, colorIndex, colorDisplayNames);<br>        EditorGUI.EndDisabledGroup();<br><br>        EditorGUI.BeginDisabledGroup(sizeDisplayNames.Length == <span class="hljs-number">0</span>);<br>        sizeIndex = EditorGUILayout.Popup(defaultSizeContent, sizeIndex, sizeDisplayNames);<br>        EditorGUI.EndDisabledGroup();<br><br>        SaveGUI();<br>        TipGUI();<br>        serializedObject.ApplyModifiedProperties();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>()</span><br>    &#123;<br>        List&lt;CursorStyleUnit&gt; reserve = <span class="hljs-keyword">new</span> List&lt;CursorStyleUnit&gt;();<br>        <span class="hljs-built_in">int</span> len = styles.Count;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            Style style = styles[i];<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(style.<span class="hljs-keyword">value</span>))<br>            &#123;<br>                CursorStyleUnit v_unit = <span class="hljs-keyword">new</span> CursorStyleUnit(styleTypes[style.styleTypeIndex], style.<span class="hljs-keyword">value</span>);<br>                <span class="hljs-keyword">if</span> (!reserve.Contains(v_unit)) reserve.Add(v_unit);<br>            &#125;<br>        &#125;<br><br>        units.ClearArray();<br>        styles.Clear();<br>        len = reserve.Count;<br>        CursorStyleUnit unit;<br>        SerializedProperty element;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>        &#123;<br>            units.InsertArrayElementAtIndex(i);<br>            element = units.GetArrayElementAtIndex(i);<br>            unit = reserve[i];<br>            element.FindPropertyRelative(<span class="hljs-string">&quot;key&quot;</span>).stringValue = unit.key;<br>            element.FindPropertyRelative(<span class="hljs-string">&quot;value&quot;</span>).stringValue = unit.<span class="hljs-keyword">value</span>;<br>            styles[i] = <span class="hljs-keyword">new</span> Style(Array.FindIndex(styleTypes, t =&gt; t == unit.key), unit.<span class="hljs-keyword">value</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; styleTypes.Length; i++)<br>        &#123;<br>            UpdateDefaultDisplayNames(i);<br>            UpdateDefaultStyles(i);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (Enum.TryParse(defaultShapeStyle.<span class="hljs-keyword">value</span>, <span class="hljs-keyword">out</span> CursorShape shape))<br>            defaultShape.intValue = (<span class="hljs-built_in">int</span>)shape;<br>        <span class="hljs-keyword">if</span> (Enum.TryParse(defaultColorStyle.<span class="hljs-keyword">value</span>, <span class="hljs-keyword">out</span> CursorColor color))<br>            defaultColor.intValue = (<span class="hljs-built_in">int</span>)color;<br>        defaultSize.intValue = Convert.ToInt32(defaultSizeStyle.<span class="hljs-keyword">value</span>);<br><br>        serializedObject.ApplyModifiedProperties();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="界面展示"><a href="#界面展示" class="headerlink" title="界面展示"></a>界面展示</h2><img src="/posts/2026/01/01/fa9905321cd4/img1.png" class="" width="364" height="678"><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>BaseTable作为所有表格的抽象基类并继承自ScriptableObject，用于后续扩展。ITableHandler声明表格的公开属性和行为。ITableUnit声明数据单元的公开属性和行为，作为暂留接口用于后续扩展，所有数据单元需要实现该接口。GameTable继承自BaseTable，并实现了ITableHandler接口，作为游戏数据表的基类，实现通用属性和方法，向具体游戏表类开放重写方法。GameTableEditor作为游戏数据表编辑器脚本的基类，实现通用逻辑。</p><p>示例中CursorStyleUIUnit作为鼠标样式的UI单元，负责定义UI界面上与表格数据相对应的UI组件。CursorStyleUnit作为鼠标样式的数据单元，负责定义每一项表格数据。CursorStyleTable则是定义鼠标样式表的具体逻辑。CursorStyleTableEditor用于定义鼠标样式表在编辑器Inspector面板中的GUI界面。</p><p>GameTable中isAutoControl字段用于启用运行时自动进行本地持久化管理的服务，在OnEnable方法中从本地持久化文件中加载内容，在OnDisable方法中将缓存内容保存至本地持久化文件中。isAutoSave字段用于启用编辑器时表格自动保存修改到资产文件的服务，若不勾选，每次在Inspector面板中进行修改后需要手动点击Save按钮进行保存，勾选后会自动保存。提供了指示表类型、表单元只读视图、表单元个数和修改回调等属性，以及本地持久化管理、表单元共享、表单元获取和设置以及重置为默认值等方法。</p><p>对表格进行设计后，我们可以使用表格管理器来统一管理所有表格，基于ScriptableObject的特性，我们可以为每个表格创建资产文件，通过加载资产文件即可获取表格实例。</p><p>TempWrapper称为字段临时缓存包装器，具体请看系列文章中与此相关的内容。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> 游戏开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>游戏中的对象池技术探索（一）</title>
      
      <link href="/posts/2026/01/01/7bac37c2e8d2/"/>
      <url>/posts/2026/01/01/7bac37c2e8d2/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对象池技术在游戏开发中的应用非常普遍，它是一种高效管理对象实例的技术，能够避免频繁和重复创建对象所带来的性能开销。本篇文章我们就来探索一下如何在游戏开发中设计通用对象池，使之易于使用和扩展。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="代码目录结构"><a href="#代码目录结构" class="headerlink" title="代码目录结构"></a>代码目录结构</h3><ul><li>ObjectPool<ul><li>Base</li><li>Interface</li><li>Settings</li></ul></li></ul><p>ObjectPool作为本模块的根目录，用于存储模块子目录和具体的对象池脚本。Base目录用于存储对象池抽象基类，用于规范对象池的设计。Interface目录用于存储对象池相关的接口，用于未来扩展。Settings目录用于存储创建对象池的参数脚本以及对象池的设置。</p><h3 id="Base目录"><a href="#Base目录" class="headerlink" title="Base目录"></a>Base目录</h3><p>BasePool.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池基类</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BasePool</span>&lt;<span class="hljs-title">T</span>&gt;<br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池所生产对象的总数量</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> totalCount &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">protected</span> <span class="hljs-keyword">set</span>; &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池当前空闲对象的数量</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> freeCount =&gt; _poolGetter.Count;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 是否为固定容量的对象池</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>默认值:False<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isFixed =&gt; _isFixed;<br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> _isFixed;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池容量</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>默认值:PoolConstant.DEFAULT_CAPACITY<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> capacity =&gt; _capacity;<br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _capacity;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象创建逻辑</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：用来自定义对象的创建逻辑<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> Func&lt;T&gt; overrideCreate;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象重置逻辑</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：用来自定义对象的重置逻辑<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> Action&lt;T&gt; overrideReset;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象销毁逻辑</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：用来自定义对象的销毁逻辑<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> Action&lt;T&gt; overrideDestroy;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 池对象访问器</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">protected</span> Stack&lt;T&gt; _poolGetter =&gt; _pool;<br>        <span class="hljs-keyword">private</span> Stack&lt;T&gt; _pool;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象类型是否为可释放对象类型</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _isDisposable =&gt; _staticIsDisposable;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _staticIsDisposable = <span class="hljs-keyword">typeof</span>(IDisposable).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T));<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象类型名称</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> _typeName =&gt; _staticTypeName;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> _staticTypeName = <span class="hljs-keyword">typeof</span>(T).Name;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">BasePool</span>()</span><br>        &#123;<br>            _pool = <span class="hljs-keyword">new</span> Stack&lt;T&gt;(PoolConstant.DEFAULT_CAPACITY);<br>            _capacity = PoolConstant.DEFAULT_CAPACITY;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">BasePool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (capacity &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">&quot;Pool:The capacity is not allowed to be less than or equal to zero for the pool.&quot;</span>);<br><br>            _pool = <span class="hljs-keyword">new</span> Stack&lt;T&gt;(capacity);<br>            _capacity = capacity;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">BasePool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity, <span class="hljs-built_in">bool</span> isFixed</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (capacity &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">&quot;Pool:The capacity is not allowed to be less than or equal to zero for the pool.&quot;</span>);<br><br>            _pool = <span class="hljs-keyword">new</span> Stack&lt;T&gt;(capacity);<br>            _capacity = capacity;<br>            _isFixed = isFixed;<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 重置对象并返回</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>(<span class="hljs-params">T item</span>)</span>;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 创建对象</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title">Create</span>()</span>;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取对象</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title">Get</span>()</span>;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放对象</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>(<span class="hljs-params">T item</span>)</span>;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 清空对象池</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clear</span>()</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Interface目录"><a href="#Interface目录" class="headerlink" title="Interface目录"></a>Interface目录</h3><p>……</p><h3 id="Settings目录"><a href="#Settings目录" class="headerlink" title="Settings目录"></a>Settings目录</h3><p>PoolConstant.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PoolConstant</span><br>    &#123;<br>        <span class="hljs-comment">// 对象池默认容量</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> DEFAULT_CAPACITY = <span class="hljs-number">10</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>UnityObjectPoolSettings.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> Unity对象池设置</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UnityObjectPoolSettings</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">UnityEngine.Object</span><br>    &#123;<br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池初始容量</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> capacity = PoolConstant.DEFAULT_CAPACITY;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池是否持久化</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isPersistant = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池是否固定容量</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isFixed;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象池容器</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> UnityEngine.GameObject container;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象原型</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> T original;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 对象默认名称</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> defaultName;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 获取时激活对象</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> activeWhenGet = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="具体的对象池"><a href="#具体的对象池" class="headerlink" title="具体的对象池"></a>具体的对象池</h3><p>ClassPool.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> Class 类型对象池</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>具体的 Class 类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClassPool</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">BasePool</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-keyword">class</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPool</span>()</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity</span>)</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity, <span class="hljs-built_in">bool</span> isFixed</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity, isFixed</span>)</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clear</span>()</span><br>        &#123;<br>            totalCount -= _poolGetter.Count;<br>            <span class="hljs-keyword">while</span> (_poolGetter.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-keyword">var</span> pop = _poolGetter.Pop();<br>                <span class="hljs-keyword">if</span> (overrideDestroy != <span class="hljs-literal">null</span>) overrideDestroy(pop);<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">if</span> (_isDisposable)<br>                    &#123;<br>                        ((IDisposable)pop).Dispose();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> T <span class="hljs-title">Get</span>()</span><br>        &#123;<br>            T item;<br><br>            <span class="hljs-keyword">if</span> (freeCount &gt; <span class="hljs-number">0</span>) item = _poolGetter.Pop();<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                item = Create();<br>                totalCount++;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> item;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>(<span class="hljs-params">T item</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>            Reset(item);<br>            _poolGetter.Push(item);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>(<span class="hljs-params">T item</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (overrideReset != <span class="hljs-literal">null</span>) overrideReset(item);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> T <span class="hljs-title">Create</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isFixed &amp;&amp; totalCount == capacity)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The number of objects in the object pool has reached the upper limit.&quot;</span>);<br><br>            T item;<br>            <span class="hljs-keyword">if</span> (overrideCreate != <span class="hljs-literal">null</span>) item = overrideCreate();<br>            <span class="hljs-keyword">else</span> item = Activator.CreateInstance&lt;T&gt;();<br><br>            <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The item created is null.&quot;</span>);<br>            <span class="hljs-keyword">return</span> item;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>UnityObjectPool.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> Unity对象池</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>Unity对象类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UnityObjectPool</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">ClassPool</span>&lt;<span class="hljs-title">T</span>&gt;, <span class="hljs-title">IDisposable</span> <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">UnityEngine.Object</span><br>    &#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">readonly</span> GameObject _container;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">readonly</span> T _original;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> _defaultName;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">bool</span> _activeWhenGet;<br>        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> _isDisposed;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UnityObjectPool</span>()</span><br>        &#123;<br>            _container = CreateContainer();<br>            _activeWhenGet = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UnityObjectPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity</span>)</span><br>        &#123;<br>            _container = CreateContainer();<br>            _activeWhenGet = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UnityObjectPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity, <span class="hljs-built_in">bool</span> isFixed</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity, isFixed</span>)</span><br>        &#123;<br>            _container = CreateContainer();<br>            _activeWhenGet = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UnityObjectPool</span>(<span class="hljs-params">UnityObjectPoolSettings&lt;T&gt; settings</span>) :</span><br><span class="hljs-function">        <span class="hljs-title">base</span>(<span class="hljs-params">settings == <span class="hljs-literal">null</span> ? PoolConstant.DEFAULT_CAPACITY : settings.capacity,</span></span><br><span class="hljs-params"><span class="hljs-function">        settings != <span class="hljs-literal">null</span> &amp;&amp; settings.isFixed</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (settings == <span class="hljs-literal">null</span>)<br>            &#123;<br>                _container = CreateContainer();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            _container = settings.container;<br>            _original = settings.original;<br>            _defaultName = settings.defaultName;<br>            _activeWhenGet = settings.activeWhenGet;<br><br>            <span class="hljs-keyword">if</span> (settings.isPersistant) MonoBehaviour.DontDestroyOnLoad(_container);<br>        &#125;<br><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> 释放对象池</span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;para&gt;</span>提示：释放后对象池将无法继续使用<span class="hljs-doctag">&lt;/para&gt;</span></span><br>        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br><br>            Dispose(<span class="hljs-literal">true</span>);<br>            GC.SuppressFinalize(<span class="hljs-keyword">this</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clear</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br>            DoClear();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Release</span>(<span class="hljs-params">T item</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br>            DoRelease(item);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">override</span> T <span class="hljs-title">Get</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">return</span> DoGet();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoClear</span>()</span><br>        &#123;<br>            totalCount -= _poolGetter.Count;<br>            <span class="hljs-keyword">while</span> (_poolGetter.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-keyword">var</span> item = _poolGetter.Pop();<br>                <span class="hljs-keyword">if</span> (overrideDestroy != <span class="hljs-literal">null</span>) overrideDestroy(item);<br>                <span class="hljs-keyword">else</span> MonoBehaviour.Destroy(item);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoRelease</span>(<span class="hljs-params">T item</span>)</span> &#123; <span class="hljs-keyword">base</span>.Release(item); &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> T <span class="hljs-title">DoGet</span>()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.Get(); &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> GameObject <span class="hljs-title">CreateContainer</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">var</span> container = <span class="hljs-keyword">new</span> GameObject(<span class="hljs-string">$&quot;<span class="hljs-subst">&#123;_typeName&#125;</span>Pool&quot;</span>);<br>            MonoBehaviour.DontDestroyOnLoad(container);<br>            <span class="hljs-keyword">return</span> container;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;<br>            _isDisposed = <span class="hljs-literal">true</span>;<br><br>            <span class="hljs-keyword">if</span> (disposing)<br>            &#123;<br>                Clear();<br>                MonoBehaviour.Destroy(_container);<br>            &#125;<br>        &#125;<br><br>        ~UnityObjectPool()<br>        &#123;<br>            Dispose(<span class="hljs-literal">false</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>GameObjectPool.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> GameObject 对象池</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameObjectPool</span> : <span class="hljs-title">UnityObjectPool</span>&lt;<span class="hljs-title">GameObject</span>&gt;<br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameObjectPool</span>()</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameObjectPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity</span>)</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameObjectPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity, <span class="hljs-built_in">bool</span> isFixed</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity, isFixed</span>)</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameObjectPool</span>(<span class="hljs-params">UnityObjectPoolSettings&lt;GameObject&gt; settings</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">settings</span>)</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> GameObject <span class="hljs-title">DoGet</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (!_activeWhenGet) <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.DoGet();<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                GameObject item = <span class="hljs-keyword">base</span>.DoGet();<br>                item.SetActive(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span> item;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>(<span class="hljs-params">GameObject item</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The item being reset is null.&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> (overrideReset != <span class="hljs-literal">null</span>) overrideReset(item);<br>            <span class="hljs-keyword">else</span> item.SetActive(<span class="hljs-literal">false</span>);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> GameObject <span class="hljs-title">Create</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isFixed &amp;&amp; totalCount == capacity)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The number of objects in the object pool has reached the upper limit.&quot;</span>);<br><br>            GameObject item;<br>            <span class="hljs-keyword">if</span> (overrideCreate != <span class="hljs-literal">null</span>) item = overrideCreate();<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (_original == <span class="hljs-literal">null</span>) item = <span class="hljs-keyword">new</span> GameObject();<br>                <span class="hljs-keyword">else</span> item = MonoBehaviour.Instantiate(_original);<br><br>                <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(_defaultName)) item.name = _defaultName;<br>                    item.transform.SetParent(_container.transform);<br>                    item.SetActive(<span class="hljs-literal">false</span>);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The item being created is null.&quot;</span>);<br>            <span class="hljs-keyword">return</span> item;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>MonoPool.cs</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title">GameAssistant.Pool</span><br>&#123;<br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> Monobehaviour 类型对象池</span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span><br>    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>具体的 Monobehaviour 类型<span class="hljs-doctag">&lt;/typeparam&gt;</span></span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MonoPool</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">UnityObjectPool</span>&lt;<span class="hljs-title">T</span>&gt;<br>    <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">MonoBehaviour</span><br>    &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MonoPool</span>()</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MonoPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity</span>)</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MonoPool</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> capacity, <span class="hljs-built_in">bool</span> isFixed</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">capacity, isFixed</span>)</span> &#123; &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MonoPool</span>(<span class="hljs-params">UnityObjectPoolSettings&lt;T&gt; settings</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">settings</span>)</span> &#123; &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> T <span class="hljs-title">DoGet</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (!_activeWhenGet) <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.DoGet();<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                T item = <span class="hljs-keyword">base</span>.DoGet();<br>                item.enabled = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">return</span> item;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>(<span class="hljs-params">T item</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The item being reset is null.&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> (overrideReset != <span class="hljs-literal">null</span>) overrideReset(item);<br>            <span class="hljs-keyword">else</span> item.enabled = <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> T <span class="hljs-title">Create</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (isFixed &amp;&amp; totalCount == capacity)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The number of objects in the object pool has reached the upper limit.&quot;</span>);<br><br>            T item;<br>            <span class="hljs-keyword">if</span> (overrideCreate != <span class="hljs-literal">null</span>) item = overrideCreate();<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (_original == <span class="hljs-literal">null</span>) item = _container.AddComponent&lt;T&gt;();<br>                <span class="hljs-keyword">else</span> item = MonoBehaviour.Instantiate(_original);<br><br>                <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(_defaultName)) item.name = _defaultName;<br>                    item.enabled = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (item == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">&quot;Pool:The item being created is null.&quot;</span>);<br>            <span class="hljs-keyword">return</span> item;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> GameAssistant.Pool;<br><span class="hljs-keyword">using</span> NUnit.Framework;<br><span class="hljs-keyword">using</span> UnityEngine;<br><span class="hljs-keyword">using</span> UnityEngine.TestTools;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ObjectPoolTest</span><br>&#123;<br>    <span class="hljs-comment">// 子弹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Bullet</span> : <span class="hljs-title">MonoBehaviour</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> Action&lt;Bullet&gt; onDestroy;<br>        <span class="hljs-keyword">public</span> DamageModel damageModel;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCustomTriggerEnter</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> tag</span>)</span><br>        &#123;<br>            <span class="hljs-keyword">if</span> (tag == <span class="hljs-string">&quot;Head&quot;</span>)<br>            &#123;<br>                Debug.Log(<span class="hljs-string">&quot;Attack Head:&quot;</span> + damageModel.AttackHead());<br>                onDestroy?.Invoke(<span class="hljs-keyword">this</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag == <span class="hljs-string">&quot;Body&quot;</span>)<br>            &#123;<br>                Debug.Log(<span class="hljs-string">&quot;Attack Body:&quot;</span> + damageModel.AttackBody());<br>                onDestroy?.Invoke(<span class="hljs-keyword">this</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 伤害计算模型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DamageModel</span><br>    &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> damage;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">AttackHead</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> damage * <span class="hljs-number">2</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">AttackBody</span>()</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> damage;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> GameObjectPool bulletPool = <span class="hljs-keyword">new</span> GameObjectPool();<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ClassPool&lt;DamageModel&gt; damagePool = <span class="hljs-keyword">new</span> ClassPool&lt;DamageModel&gt;();<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span>[] tags = &#123; <span class="hljs-string">&quot;Head&quot;</span>, <span class="hljs-string">&quot;Body&quot;</span> &#125;;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">ObjectPoolTest</span>()</span><br>    &#123;<br>        bulletPool.overrideReset = ResetBullet;<br>        damagePool.overrideReset = ResetDamageModel;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ResetBullet</span>(<span class="hljs-params">GameObject go</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (go.TryGetComponent(<span class="hljs-keyword">out</span> Bullet bullet))<br>        &#123;<br>            damagePool.Release(bullet.damageModel);<br>            bullet.damageModel = <span class="hljs-literal">null</span>;<br>            bullet.onDestroy = <span class="hljs-literal">null</span>;<br>        &#125;<br>        go.SetActive(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ResetDamageModel</span>(<span class="hljs-params">DamageModel dm</span>)</span><br>    &#123;<br>        dm.damage = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-function">Bullet <span class="hljs-title">GetBullet</span>()</span><br>    &#123;<br>        GameObject go = bulletPool.Get();<br>        <span class="hljs-keyword">if</span> (!go.TryGetComponent(<span class="hljs-keyword">out</span> Bullet bullet)) bullet = go.AddComponent&lt;Bullet&gt;();<br>        DamageModel damageModel = damagePool.Get();<br>        damageModel.damage = UnityEngine.Random.Range(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>);<br>        bullet.damageModel = damageModel;<br>        bullet.onDestroy = OnBulletDestroy;<br>        <span class="hljs-keyword">return</span> bullet;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnBulletDestroy</span>(<span class="hljs-params">Bullet bullet</span>)</span><br>    &#123;<br>        Debug.Log(<span class="hljs-string">&quot;Bullet is being destroied.&quot;</span>);<br>        bulletPool.Release(bullet.gameObject);<br>    &#125;<br><br>    [<span class="hljs-meta">UnityTest</span>]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator <span class="hljs-title">ObjectPool_Test</span>()</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;<br>        WaitForSeconds waitForSeconds = <span class="hljs-keyword">new</span> WaitForSeconds(<span class="hljs-number">0.5f</span>);<br>        Stack&lt;Bullet&gt; temp = <span class="hljs-keyword">new</span> Stack&lt;Bullet&gt;();<br>        <span class="hljs-keyword">while</span> (index &lt; <span class="hljs-number">9</span>)<br>        &#123;<br>            Debug.Log(<span class="hljs-string">$&quot;正在进行第<span class="hljs-subst">&#123;index + <span class="hljs-number">1</span>&#125;</span>次射击...&quot;</span>);<br><br>            <span class="hljs-built_in">int</span> sendBulletCount = UnityEngine.Random.Range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; sendBulletCount; i++)<br>            &#123;<br>                Debug.Log(<span class="hljs-string">$&quot;正在生成第<span class="hljs-subst">&#123;i + <span class="hljs-number">1</span>&#125;</span>颗子弹...&quot;</span>);<br>                temp.Push(GetBullet());<br>            &#125;<br><br>            Debug.Log(<span class="hljs-string">$&quot;生产子弹总量:<span class="hljs-subst">&#123;bulletPool.totalCount&#125;</span>，子弹库存:<span class="hljs-subst">&#123;bulletPool.freeCount&#125;</span>&quot;</span>);<br><br>            <span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">while</span> (temp.Count &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                Debug.Log(<span class="hljs-string">$&quot;正在发射第<span class="hljs-subst">&#123;j + <span class="hljs-number">1</span>&#125;</span>颗子弹...&quot;</span>);<br>                temp.Pop().OnCustomTriggerEnter(tags[UnityEngine.Random.Range(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)]);<br>                j++;<br>            &#125;<br><br>            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> waitForSeconds;<br>            index++;<br>        &#125;<br>        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        Assert.IsTrue(<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>上述代码基于Unity Test Framework进行测试，模拟了9次射击，每次随机发射1-5颗子弹，随机设置每个子弹的基本伤害为10-100，用对象池技术管理子弹游戏对象实例和伤害计算模型实例。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>BasePool作为所有对象池的抽象基类，规范对象池的必要属性和方法。PoolConstant记录对象池所用的常量值。UnityObjectPoolSettings作为Unity对象池特有的对象池设置参数，在创建Unity对象池时传递。ClassPool作为C#类对象池。UnityObjectPool作为Unity对象池，继承自ClassPool。GameObjectPool作为Unity游戏对象池。MonoPool作为Monobehaviour对象池。</p><h2 id="版本改进"><a href="#版本改进" class="headerlink" title="版本改进"></a>版本改进</h2><table><thead><tr><th>版本</th><th>改进说明</th></tr></thead><tbody><tr><td>v1.1</td><td>1.添加overrideDestroy回调；<br>2.Reset方法更改为”protected abstract void Reset(T item)”；<br>3.优化代码</td></tr><tr><td>…</td><td>…</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>Unity常见问题合集（一）</title>
      
      <link href="/posts/2026/01/01/ac8b55f34c12/"/>
      <url>/posts/2026/01/01/ac8b55f34c12/</url>
      
        <content type="html"><![CDATA[<p><strong>PS：不定期更新……</strong></p><hr><h2 id="UnityHub打开一直在转圈"><a href="#UnityHub打开一直在转圈" class="headerlink" title="UnityHub打开一直在转圈"></a>UnityHub打开一直在转圈</h2><p>解决： 通常在找到UnityHub的数据文件目录，Windows系统通常在”系统盘&#x2F;用户目录&#x2F;AppData&#x2F;Roaming&#x2F;UnityHub(或Unity Hub)”，可以先看看log的json文件，搜索error级别日志信息看看是网络问题还是什么问题，如果解决不了，就打开任务管理器关闭UnityHub的进程，删除UnityHub的数据文件目录，重新打开。</p>]]></content>
      
      
      <categories>
          
          <category> Unity开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>基于有限自动机原理实现路径有效性检测</title>
      
      <link href="/posts/2026/01/01/bd139309db68/"/>
      <url>/posts/2026/01/01/bd139309db68/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在项目开发过程中遇到一个问题，是关于Windows传统DOS路径有效性检测的，在面对不同的指示为路径的字符串时，将它们作为输入，引申出来的几个问题。</p><ol><li>如何判断其是否符合目前各种操作系统的文件管理的路径规范？</li><li>在文件本身是否存在作为可选项时，如何判断一个路径是否为有效的路径？</li><li>如何实现跨平台的路径有效性检测？</li></ol><p>标识为路径的字符串由一个个字符或字符串组成，所以我想到了以字符或字符串为单位，从头到尾遍历字符串，并对这些单位进行判断和识别，例如是否存在磁盘名？磁盘名是否符合规范？其中的路径分隔符对于运行时平台是否有效？基于种种判断规则来组合判断指示为路径的字符串是否为有效的路径。而这个判断过程我设计为了一个有限自动机<a href="https://zh.wikipedia.org/wiki/%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA" title="维基百科（有限状态机）">^1</a>，它非常适合干这种工作。</p><h2 id="工程目录"><a href="#工程目录" class="headerlink" title="工程目录"></a>工程目录</h2><ul><li>PathTool<ul><li>Rule<ul><li>IFilePathRule.cs</li><li>IFolderPathRule.cs</li><li>WindowsFilePathRule.cs</li><li>WindowsFolderPathRule.cs</li></ul></li><li>FilePathTool.cs</li><li>FolderPathTool.cs</li><li>PathTool.cs</li><li>WindowsPathSharedData.cs</li></ul></li></ul><p>这个工具包括了文件和文件夹的路径有效性检测，统一通过PathTool进行调用，Rule目录下用于存储实现具体的路径检测逻辑的脚本，例如WindowsFilePathRule和WindowsFolderPathRule。目前仅实现了Windows系统的路径检测，可以通过IFilePathRule和IFolderPathRule接口进行其它平台的扩展。WindowsPathSharedData用来存储工具类的共享数据，例如文件或文件夹名称的特殊字符集、驱动器名称的特殊字符集等等。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>关于有限自动机（也称“有限状态机”），做游戏开发的朋友不会陌生，当一个实体存在多个不同的状态，而状态之间需要满足指定的条件进行切换时，就往往会想到状态机，而我们这里的实体是一个指示为路径的字符串，不同于游戏状态机，我们这里采用的是基于字典实现的状态表，状态表中的每个元素称为状态单元，每个状态单元中包括一到多个状态键值对，状态键值对的Key记录状态（这里是待识别的字符串），而Value则记录下一个状态单元索引。输入的字符串默认从第一个状态单元开始，然后根据匹配的Key获取到对应的Value，再根据Value跳转到其它状态单元，不断重复这个过程，直到最终得到结果。</p><table><thead><tr><th>状态单元 &#x2F; <br>键值对序号</th><th align="left">状态单元1<br>索引0</th><th align="left">状态单元2<br>索引1</th><th align="left">状态单元3<br>索引2</th><th align="left">状态单元4<br>索引3</th></tr></thead><tbody><tr><td>0</td><td align="left">Key:”driveName:\“<br>Value:2</td><td align="left">Key:”driveName:\“<br>Value:2</td><td align="left">Key:”folderName\“<br>Value:2</td><td align="left">Key:””<br>Value:3</td></tr><tr><td>1</td><td align="left">Key:”.\“<br>Value:2</td><td align="left">无</td><td align="left">无</td><td align="left">无</td></tr><tr><td>2</td><td align="left">Key:”..\“<br>Value:2</td><td align="left">无</td><td align="left">无</td><td align="left">无</td></tr><tr><td>3</td><td align="left">Key:”\?\“<br>Value:1</td><td align="left">无</td><td align="left">无</td><td align="left">无</td></tr></tbody></table><p>上述这个表就是Windows路径检测所用的文件路径检测表。例如输入路径”C:\AAA\B.txt”，根据路径分隔符”\“分割字符串为”C:\“、”AAA\“、”B.txt”，从状态单元1开始，”C:\“触发识别键值对序号0的”driveName:\“，其Value为2，跳转到状态单元3，”AAA\“触发识别键值对序号0的”folderName\“，其Value为2，但由于此时索引已检测到倒数第二个字符串单位，所以跳出循环，而”B.txt”将在跳出循环后单独进行检测，检测其为”文件名.文件扩展名”的组成，所以”C:\AAA\B.txt”识别为有效的Windows文件路径。</p><p>该工具类支持Windows系统的绝对路径、相对路径、超长路径的有效性检测，正向和反向路径分隔符也都能检测。</p><h2 id="代码资源"><a href="#代码资源" class="headerlink" title="代码资源"></a>代码资源</h2><p><a href="https://github.com/JokeVallen/CSDN_Resources/tree/f008129e022523b9af18058e3711381a45605ff7">GitHub</a></p>]]></content>
      
      
      <categories>
          
          <category> 个人研究 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      
        <title>C#常识篇（一）</title>
      
      <link href="/posts/2025/12/31/fdf14fba7e13/"/>
      <url>/posts/2025/12/31/fdf14fba7e13/</url>
      
        <content type="html"><![CDATA[<h2 id="面向对象的三大特性"><a href="#面向对象的三大特性" class="headerlink" title="面向对象的三大特性"></a>面向对象的三大特性</h2><blockquote><p>继承：子类通过继承父类来获取基础特性，并且能够基于父类进行特异化开发，包括重用、修改和扩展父类行为。子类和父类又分别称为派生类和基类。基类的构造函数和终结器不会被派生类继承。继承具有传递性，例如B继承自A，C继承自B，那么C就间接继承自A，这能够塑造继承关系的层次结构。在C#中，每个类仅允许继承一个父类。继承不仅能够提升代码的复用性也可以让程序的结构更加明晰。值得注意的是，派生类对基类成员的访问受限于基类中该成员的访问权限。</p><p>参考文档：<a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/tutorials/inheritance">继承</a></p><p>例如我们有时候会发现两个及以上的功能会存在相同的或类似的逻辑和组成，可以尝试将它们共有的部分进行抽离，然后将这些共有部分设计在一个父类中，这样就可以通过继承来避免重复的设计和代码，父类可以衍生出很多子类，所谓”龙生龙，凤生凤，老鼠的儿子会打洞”，作为子类会具备父类的基础特性，当然父类也有自己的隐私，所以并非会对子类开放所有成员的访问权限。父类也会对衍生的子类有一定约束，可能会强行要求子类实现某些成员，例如被继承而来的抽象成员，因为有时候父类可能不包括具体实现，仅仅作为一个模板或者协议存在，而在这种情况下，具体的实现则是交给各个子类，有时候开发者为了给模块提供可扩展性，会特意进行这种设计，就是为了满足后续替换或衍生的需求，这种时候我们通常可以继承父类并开发一个新的子类，避免对原有代码进行修改，也符合了“开闭原则”。</p></blockquote><blockquote><p>封装：将数据和行为封装为一个独立的单元，对外部隐藏具体的实现细节，仅提供必要的调用接口，从而简化外部调用和提升代码的复用性和可维护性。</p><p>参考文档：<a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/tutorials/oop">面向对象编程</a> <a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/object-oriented/">C#面向对象技术概述</a></p><p>例如一个系统可以看作由多个功能模块组成，每个模块都可以被视为一个被封装的独立单元，各司其职，又作为系统不可或缺的部分，结合注释或文档可以使得每个模块便于开发者维护，同时独立的模块又可以独自完成某些工作，所以是可以被复用的，除此之外，不同模块之间几乎无须关注其它模块的内部逻辑和组成，只需要关注其功能，直接通过其开放的接口进行调用即可。所以对于维护者和调用者可以采用两份文档，针对每个模块，内部逻辑和组成相关注释和描述可以记录在维护者文档中，对于开放的接口则记录在调用文档中，这个调用文档往往就是我们所说的API文档。</p></blockquote><blockquote><p>多态：同一对象针对不同的的对象或应用情景而存在不同的行为，例如运行时的多态——重写，编译时的多态——重载，重写则是根据不同的实例对象而表现不同的行为，重载则是根据传递的参数而自动选择对应的行为。</p><p>参考文档：<a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/object-oriented/polymorphism">多态</a></p><p>例如一个银行柜台职员，会根据客户的需求办理不同的业务，这是类似重载的体现，而重写则依托于继承关系，子类可以重写父类的方法，这样即便是同签名的方法也会因为实例对象的不同而表现不同行为，就好比不同的人在街上看到一条流浪猫，有的人会投喂一些食物，有的人则冷漠视之，同样为人却也会因为三观不同而表现出不同的反应。</p></blockquote><h2 id="值类型和引用类型"><a href="#值类型和引用类型" class="headerlink" title="值类型和引用类型"></a>值类型和引用类型</h2><blockquote><p>在C#中值类型继承自System.ValueType类，包括整型、浮点型、布尔类型、字符型四种内置的简单值类型，以及结构体和枚举两种复合值类型，这些简单值类型本质上就是结构体。引用类型继承自System.Object类，包括class、delegate、array、object等。</p><p>通常对于两个指向同一实例的值类型变量，它们之间是克隆副本的关系，所以各自的操作不会相互影响（除非变量由ref、out、in参数修饰）。对于指向同一实例的两个引用类型变量，它们都是存储对实例的引用，所以各自的操作会产生相互影响。</p><p>参考文档：<a href="https://learn.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/value-types">值类型</a> <a href="https://learn.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/reference-types">引用类型</a></p></blockquote><h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><blockquote><p>GC是一种垃圾回收机制，为了高效、便捷和安全地管理内存，C#中采用了自动垃圾回收机制，由系统代理内存管理，从而提高开发效率和避免内存泄漏等问题。C#的GC采用的是”标记-清理”算法和分代管理方式。</p><p>（1）”标记-清理”算法是从根对象开始，根据对象的引用关系递归标记可达对象，形成一个图结构，在清理阶段则对不可达对象进行内存清理，GC还会在清理阶段对未被清理的对象进行内存压缩从而减少内存碎片化。</p><p>（2）分代管理是在托管堆上根据所创建对象的生命周期进行分类，刚创建的对象被称为”第0代”，”第0代”在一次”标记-清理”阶段存活下来的对象会被分类为”第1代”，最终代为”第2代”（生命周期长的对象），分代管理的目的是为了通过控制对象进行”标记-清理”的频率从而提高GC的效率，避免每次扫描整个托管堆，不同代根据不同的频率进行”标记-清理”。对不同代对象的垃圾回收是会涵盖其所有低代对象的垃圾回收，例如对”第1代”的垃圾回收会触发对”第0代”的垃圾回收，对”第2代”的垃圾回收会触发”第1代”和”第0代”的垃圾回收，所以代数越高调用垃圾回收的频率越少，且进行垃圾回收的耗时也更久。对”第2代”的垃圾回收也被称为”完全垃圾回收”，因为其会对整个托管堆进行扫描。</p><p>（3）GC将对象分为小对象和大对象，当对象申请的内存超过指定阈值（如85000字节）时会被视为大对象，其会被单独分配到大对象堆（LOH），小对象堆（SOH）在完成垃圾回收时会进行内存压缩，而对大对象的内存压缩会带来较大的性能开销，所以采用这种单独分配的机制，从物理上而言大对象被视为”第3代”，但是逻辑上对大对象的垃圾回收是在”第2代”进行的。</p><p>参考文档：<a href="https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/">垃圾回收</a></p></blockquote><h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><blockquote><p>反射是一种在运行时动态访问程序集的方式。在C#中通过System.Reflection命名空间中的API在运行时获取程序集的元数据，通常我们可以通过获取指定类型的Type对象再通过反射获取其字段、属性和方法等成员，实现在运行时间接操作对象，不过反射通常会带来一定的性能开销，所以不建议大量使用。</p></blockquote><h2 id="StringBuilder和String"><a href="#StringBuilder和String" class="headerlink" title="StringBuilder和String"></a>StringBuilder和String</h2><blockquote><p>StringBuilder顾名思义就是字符串构建器，对StringBuilder对象的操作是基于可变内存缓冲区的，这个特性减少了创建新对象的需求，相较于String类型，它更适合频繁操作字符串的应用场景，但是它不是线程安全的。String类型是不可变的，对其进行的字符串操作通常涉及到需要创建新的String类型对象。总而言之，对于需要频繁操作字符串的情况建议使用StringBuilder类型，反之使用String类型。</p></blockquote><h2 id="常见容器类"><a href="#常见容器类" class="headerlink" title="常见容器类"></a>常见容器类</h2><blockquote><p>（1）数组(Array)：在定义或初始化时需要明确指定数组长度的容器类，严格意义上来说数组可以进行数据修改，但是无法进行增加和删除，因为数组的长度是固定的，要对数组进行增加和删除操作，通常需要创建一个新的数组对象。数组的内存是连续的，所以其查询和修改的效率是可观的，其通常适合存储一些数量固定的数据。</p><p>（2）列表(List<T>)：列表可以看作是一个动态的泛型数组，能够根据需要动态调整容量大小，避免了ArrayList中的装箱和拆箱操作，由于其底层实现依旧是数组，所以增加和删除操作是耗时操作。</p><p>（3）栈(Stack<T>)：栈是一种后进先出的数据结构，涉及到元素的入栈和出栈操作，后入栈的元素则先出栈，栈的操作仅支持栈顶操作，通常其不适合具有广泛的查询元素需求的应用场景。</p><p>（4）队列(Queue<T>)：队列是一种先进先出的数据结构，涉及到元素的入队和出队操作，先入队的元素则先出队，队列的操作支持队首和队尾操作，通常其不适合具有广泛的查询元素需求的应用场景。</p><p>（5）字典(Dictionary&lt;K,V&gt;)：字典是一种基于哈希表的数据结构，以键值对的方式保存元素，键唯一而值不唯一，同一个字典中不允许重复的键，但允许重复的值，因其基于哈希表的特性，所以对于元素的查询、插入和删除操作效率是可观的。</p><p>（6）集合(HashSet<T>)：集合是一种基于哈希表的数据结构，它不允许存储重复的元素，所以非常适合需要去重的应用场景，因其基于哈希表的特性，所以对于元素的查询、插入和删除操作效率是可观的。</p><p>（7）哈希表(Hashtable)：哈希表的底层实现是数组，数组元素由一种名为”桶”的数据结构组成，哈希表通过哈希函数将键映射到数组索引，严格来说一个键应该对应一个数组索引，当存在不同的键映射到同一个数组索引时则为哈希冲突，哈希表的设计关键则在于如何制定哈希函数和处理哈希冲突，处理哈希冲突常见的方法有链地址法和开放地址法，链地址法则是在数组索引处维护一个链表用于存储映射到该索引的不同键，而开放地址法则是通过一定的规则在哈希表中寻找到下一个可用的索引位置，然后插入元素。官方建议在新项目的开发中使用字典替代哈希表。</p></blockquote><h2 id="隐式继承和显式继承"><a href="#隐式继承和显式继承" class="headerlink" title="隐式继承和显式继承"></a>隐式继承和显式继承</h2><blockquote><p>在C#中通过英文符号”:”来实现显式继承，显式继承则需要显式指定基类，而隐式继承通常由编译器隐藏基类，例如声明自定义类时并不需要显式继承System.Object，而由编译器自动完成这个继承行为，所以声明的自定义类即使没有显式继承自System.Object，但实际上却是System.Object的派生类，在编译时就会有所体现，可以通过自定义类的实例查阅到可调用的方法中包括System.Object的基本方法。</p></blockquote><h2 id="栈内存和堆内存"><a href="#栈内存和堆内存" class="headerlink" title="栈内存和堆内存"></a>栈内存和堆内存</h2><blockquote><p>栈内存是基于栈这种数据结构构建的内存空间，通常用于存储代码上下文，例如某个被调用的函数的局部变量、参数和返回地址等信息，栈内存由编译器或解释器自动管理内存的分配和释放。</p><p>堆内存是基于堆这种数据结构构建的内存空间，通常用于存储动态分配的数据，例如实例对象和数组等，堆内存通常由程序员手动管理或者GC自动管理。</p><p>栈内存相比堆内存更轻量和便捷，访问更加快速，内存管理的性能开销更小；堆内存相比栈内存拥有更大的存储空间，其中的数据没有固定的生命周期，可以跨函数或代码块使用。值得注意的是堆内存可能涉及到内存碎片化的问题，并且涉及为对象分配合适的内存块而需要更大的性能开销。</p></blockquote><h2 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h2><blockquote><p>析构函数使用语法“~类名()”定义，无需访问修饰符、返回类型和参数。它实际上被编译器转换为重写Finalize()方法。</p><p>析构函数在垃圾回收器销毁对象时自动调用，但调用时机是不确定的，可能在对象不再被引用后的任意时间点执行。</p><p>官方强烈不建议在析构函数中释放托管资源，因为：</p><ol><li>托管资源由垃圾回收器自动管理</li><li>析构函数执行顺序不确定，可能依赖的对象已被销毁</li><li>有析构函数的对象需要多代GC处理，影响性能</li></ol><p>现代C#推荐使用IDisposable模式来管理资源，析构函数仅作为释放非托管资源的最后保障。</p></blockquote><h2 id="抽象类和接口的区别"><a href="#抽象类和接口的区别" class="headerlink" title="抽象类和接口的区别"></a>抽象类和接口的区别</h2><blockquote><p>抽象类本质上是一种特殊的类，具备构造函数，能够声明和定义实例化的字段、属性以及函数，同时也能够声明抽象的函数，抽象类能够继承其它类和实现接口。与普通的类不同的是抽象类无法直接通过new创建实例，而需要通过其派生类间接创建实例，并且抽象类的抽象函数必须被派生类实现。</p><p>接口仅允许声明而不需要实现字段和函数，且均是公开的，接口可以嵌套实现其它接口，其相比抽象类是更高层次的抽象，所以同样无法创建实例。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> C# </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>